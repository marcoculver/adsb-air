<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flight Ops</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #002540 0%, #003d66 50%, #006496 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Active Timers Strip */
        .active-timers-strip {
            background: rgba(0, 20, 40, 0.9);
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .strip-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid rgba(255, 130, 0, 0.3);
        }

        .strip-clock-time {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .strip-clock-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .strip-timers {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
        }

        .strip-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .strip-timer:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .strip-timer-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--strip-color, #333) var(--strip-progress, 0%), #222 var(--strip-progress, 0%));
        }

        .strip-timer-icon-inner {
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: #001a2e;
            border-radius: 50%;
        }

        .strip-timer-info {
            display: flex;
            flex-direction: column;
        }

        .strip-timer-name {
            font-size: 0.7rem;
            color: #888;
        }

        .strip-timer-value {
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 8px currentColor;
        }

        .strip-timer.color-green .strip-timer-value { color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-value { color: #ffd700; }
        .strip-timer.color-orange .strip-timer-value { color: #FF8200; }
        .strip-timer.color-red .strip-timer-value { color: #ff5252; }
        .strip-timer.color-expired .strip-timer-value { color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-value { color: #00d4ff; }

        .strip-timer.color-green .strip-timer-icon { --strip-color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-icon { --strip-color: #ffd700; }
        .strip-timer.color-orange .strip-timer-icon { --strip-color: #FF8200; }
        .strip-timer.color-red .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-expired .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-icon { --strip-color: #00d4ff; }

        .strip-no-active {
            color: #666;
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Top sections grid */
        .top-sections {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .top-sections {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 700px) {
            .top-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Section styling */
        .section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .section-title {
            font-size: 1rem;
            color: #FF8200;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        /* Input grids */
        .input-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-label {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Clickable input buttons */
        .input-btn {
            width: 100%;
            max-width: 90px;
            padding: 10px 6px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .input-btn.placeholder {
            color: rgba(0, 255, 136, 0.3);
        }

        .input-btn-with-unit {
            position: relative;
        }

        .input-btn-unit {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #888;
            pointer-events: none;
        }

        .results-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 130, 0, 0.2);
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 2px;
        }

        .result-value {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .block-time { color: #ffd700; }
        .flight-time { color: #00ff88; }
        .tow-value { color: #FF8200; }
        .eta-value { color: #00d4ff; }
        .acc-value { color: #a29bfe; }
        .mlf-value { color: #00ff88; }

        .clear-btn {
            display: block;
            margin: 10px auto 0;
            padding: 5px 14px;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 6px;
            color: #ff6b6b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .preset-btn {
            display: block;
            margin: 8px auto 0;
            padding: 6px 12px;
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 6px;
            color: #FF8200;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        /* ETA Section */
        .eta-countdown {
            font-size: 1.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            margin: 10px 0;
        }

        .eta-countdown.warning {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .eta-countdown.critical {
            color: #ff5252;
            text-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
        }

        .utc-display {
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        /* Aircraft selector */
        .aircraft-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
        }

        .aircraft-btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            color: #888;
            transition: all 0.2s;
        }

        .aircraft-btn.active {
            background: rgba(255, 130, 0, 0.3);
            border-color: #FF8200;
            color: #FF8200;
        }

        .mlw-info {
            text-align: center;
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 8px;
        }

        /* Timers Grid */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .timer-card {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            transition: background-color 0.15s, box-shadow 0.15s;
        }

        .timer-card.flashing {
            animation: flashRed 0.3s ease-in-out;
        }

        @keyframes flashRed {
            0%, 100% { background: rgba(0, 37, 64, 0.7); box-shadow: none; }
            50% { background: rgba(255, 0, 0, 0.4); box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); }
        }

        /* Clock Face */
        .clock-container {
            flex-shrink: 0;
        }

        .clock-face {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--clock-color, #333) var(--progress, 0%), #222 var(--progress, 0%));
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .clock-inner {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: linear-gradient(135deg, #002540 0%, #001a2e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clock-time {
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px currentColor;
        }

        /* Timer Controls */
        .timer-content {
            flex: 1;
            min-width: 0;
        }

        .timer-name-input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.2);
            border-radius: 6px;
            color: #fff;
            margin-bottom: 8px;
        }

        .timer-name-input:focus {
            outline: none;
            border-color: #FF8200;
        }

        .timer-type-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .timer-time-setup {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .time-input-btn {
            width: 55px;
            height: 40px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .time-separator {
            display: flex;
            align-items: center;
            color: #666;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 0 20px currentColor;
            color: var(--timer-color, #00ff88);
        }

        .timer-buttons {
            display: flex;
            gap: 6px;
        }

        .timer-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-start {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
        }

        /* Number Picker Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .number-picker {
            background: linear-gradient(135deg, #002540 0%, #003d66 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 130, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .picker-title {
            text-align: center;
            font-size: 1.1rem;
            color: #FF8200;
            margin-bottom: 20px;
        }

        .picker-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .picker-value {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            min-width: 120px;
            text-align: center;
        }

        .picker-unit {
            font-size: 1.2rem;
            color: #888;
        }

        .picker-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .picker-btn {
            padding: 15px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: bold;
            transition: all 0.2s;
        }

        .picker-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        .picker-btn:active {
            transform: scale(0.95);
        }

        .picker-btn.clear {
            background: rgba(255, 100, 100, 0.3);
        }

        .picker-actions {
            display: flex;
            gap: 10px;
        }

        .picker-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .picker-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .picker-confirm {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        /* Color states for countdown */
        .color-green { --clock-color: #00c853; --timer-color: #00ff88; }
        .color-yellow { --clock-color: #ffc107; --timer-color: #ffd54f; }
        .color-orange { --clock-color: #FF8200; --timer-color: #FF8200; }
        .color-red { --clock-color: #f44336; --timer-color: #ff5252; }
        .color-expired { --clock-color: #b71c1c; --timer-color: #ff1744; }
        .color-neutral { --clock-color: #006496; --timer-color: #00d4ff; }

        /* FDP Calculator Styles */
        .fdp-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .fdp-section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .fdp-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .fdp-field {
            display: flex;
            flex-direction: column;
        }

        .fdp-label {
            font-size: 0.8rem;
            color: #7ec8e3;
            margin-bottom: 5px;
        }

        .fdp-select, .fdp-input {
            padding: 10px;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .fdp-select {
            cursor: pointer;
        }

        .fdp-select option {
            background: #002540;
            color: #fff;
        }

        .fdp-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .fdp-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .fdp-result-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .fdp-result-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .fdp-result-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .fdp-result-local {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            margin-top: 3px;
        }

        .fdp-result-utc {
            font-size: 0.8rem;
            color: #888;
            margin-top: 3px;
        }

        .fdp-result-value.green { color: #00ff88; }
        .fdp-result-value.yellow { color: #ffd700; }
        .fdp-result-value.orange { color: #FF8200; }
        .fdp-result-value.red { color: #ff5252; }

        .fdp-warning {
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #FF8200;
            font-size: 0.9rem;
        }

        .fdp-danger {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #ff5252;
            font-size: 0.9rem;
        }

        .sector-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 800px) {
            .sector-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sector-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .sector-title {
            font-size: 0.85rem;
            color: #FF8200;
            margin-bottom: 10px;
            text-align: center;
        }

        .sector-field {
            margin-bottom: 8px;
        }

        .sector-field label {
            font-size: 0.7rem;
            color: #888;
            display: block;
            margin-bottom: 3px;
        }

        .turnaround-display {
            text-align: center;
            padding: 5px;
            background: rgba(255, 130, 0, 0.1);
            border-radius: 5px;
            margin-top: 5px;
        }

        .turnaround-label {
            font-size: 0.65rem;
            color: #888;
        }

        .turnaround-value {
            font-size: 0.9rem;
            color: #FF8200;
            font-family: 'Courier New', monospace;
        }

        /* Local time offset selector */
        .local-offset-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .local-offset-selector label {
            font-size: 0.85rem;
            color: #7ec8e3;
        }

        .local-offset-selector select {
            padding: 8px 12px;
            background: #002540;
            border: 2px solid #FF8200;
            border-radius: 5px;
            color: #FF8200;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .local-offset-selector select option {
            background: #002540;
            color: #FF8200;
        }

        /* Actual tracking section */
        .actual-tracking {
            background: rgba(0, 100, 150, 0.1);
            border: 1px solid rgba(0, 100, 150, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .actual-tracking-title {
            font-size: 0.9rem;
            color: #006496;
            margin-bottom: 10px;
            text-align: center;
        }

        .actual-sector-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (max-width: 800px) {
            .actual-sector-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .duty-estimate {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .duty-estimate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .duty-estimate-label {
            font-size: 0.85rem;
            color: #888;
        }

        .duty-estimate-value {
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* iPad specific */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .timer-card {
                flex-direction: column;
                text-align: center;
            }

            .timer-display {
                font-size: 1.6rem;
            }

            .tab-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        button {
            -webkit-user-select: none;
            user-select: none;
        }

        .timer-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Active Timers Strip -->
        <div class="active-timers-strip" id="active-timers-strip">
            <div class="strip-clock">
                <div class="strip-clock-time" id="strip-utc-clock">--:--:--</div>
                <div class="strip-clock-label">UTC</div>
            </div>
            <div class="strip-timers" id="strip-timers">
                <span class="strip-no-active">No active timers</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn" onclick="switchTab('timers')">Timers</button>
            <button class="tab-btn active" onclick="switchTab('tools')">Tools</button>
            <button class="tab-btn" onclick="switchTab('fuel')">Fuel</button>
            <button class="tab-btn" onclick="switchTab('layover')">Layover</button>
            <button class="tab-btn" onclick="switchTab('fdp')">FDP</button>
        </div>

        <!-- Tools Tab -->
        <div class="tab-content active" id="tab-tools">
            <div class="top-sections">
                <!-- OOOI Section -->
                <div class="section">
                    <div class="section-title">OOOI</div>
                    <div class="input-grid-4">
                        <div class="input-group">
                            <label class="input-label">OUT</label>
                            <button class="input-btn placeholder" id="oooi-out-btn" onclick="openTimePicker('oooi-out')">0000</button>
                            <input type="hidden" id="oooi-out" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">OFF</label>
                            <button class="input-btn placeholder" id="oooi-off-btn" onclick="openTimePicker('oooi-off')">0000</button>
                            <input type="hidden" id="oooi-off" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ON</label>
                            <button class="input-btn placeholder" id="oooi-on-btn" onclick="openTimePicker('oooi-on')">0000</button>
                            <input type="hidden" id="oooi-on" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">IN</label>
                            <button class="input-btn placeholder" id="oooi-in-btn" onclick="openTimePicker('oooi-in')">0000</button>
                            <input type="hidden" id="oooi-in" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">BLOCK</div>
                            <div class="result-value block-time" id="block-time">--:--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">FLIGHT</div>
                            <div class="result-value flight-time" id="flight-time">--:--</div>
                        </div>
                    </div>
                    <button class="clear-btn" id="oooi-clear">Clear</button>
                </div>

                <!-- ETA Section -->
                <div class="section">
                    <div class="section-title">ETA Countdown</div>
                    <div class="utc-display">UTC: <span id="utc-clock">--:--:--</span></div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">ETA (UTC)</label>
                            <button class="input-btn placeholder" id="eta-time-btn" onclick="openTimePicker('eta-time')">0000</button>
                            <input type="hidden" id="eta-time" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">UTC NOW</label>
                            <button class="input-btn placeholder" id="utc-manual-btn" onclick="openTimePicker('utc-manual')">AUTO</button>
                            <input type="hidden" id="utc-manual" value="">
                        </div>
                    </div>
                    <div class="eta-countdown" id="eta-countdown">--:--:--</div>
                    <button class="clear-btn" id="eta-clear">Clear</button>
                </div>

                <!-- TOW Calculator -->
                <div class="section">
                    <div class="section-title">TOW Calculator</div>
                    <div class="aircraft-selector" style="margin-bottom:10px">
                        <button class="aircraft-btn active" id="tow-ac-b738" onclick="selectAircraft('B738')">B738</button>
                        <button class="aircraft-btn" id="tow-ac-b38m" onclick="selectAircraft('B38M')">B38M</button>
                        <button class="aircraft-btn" id="tow-ac-b39m" onclick="selectAircraft('B39M')">B39M</button>
                    </div>
                    <div class="input-grid-3">
                        <div class="input-group">
                            <label class="input-label">ZFW</label>
                            <button class="input-btn placeholder" id="calc-zfw-btn" onclick="openWeightPicker('calc-zfw', 'ZFW')">0</button>
                            <input type="hidden" id="calc-zfw" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">FOB</label>
                            <button class="input-btn placeholder" id="calc-fob-btn" onclick="openWeightPicker('calc-fob', 'FOB')">0</button>
                            <input type="hidden" id="calc-fob" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">TAXI</label>
                            <button class="input-btn placeholder" id="calc-taxi-btn" onclick="openWeightPicker('calc-taxi', 'Taxi Fuel')">0</button>
                            <input type="hidden" id="calc-taxi" value="">
                        </div>
                    </div>
                    <div class="results-row" style="flex-wrap:wrap; gap:10px;">
                        <div class="result-item">
                            <div class="result-label">TAXI WT</div>
                            <div class="result-value" id="taxi-wt-result" style="font-size:1rem">---</div>
                            <div class="result-label" id="mtw-limit" style="color:#666; font-size:0.65rem">MTW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">TAKE OFF WT</div>
                            <div class="result-value tow-value" id="tow-result">---</div>
                            <div class="result-label" id="mtow-limit" style="color:#666; font-size:0.65rem">MTOW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ZFW</div>
                            <div class="result-value" id="zfw-display" style="font-size:1rem; color:#7ec8e3">---</div>
                            <div class="result-label" id="mzfw-limit" style="color:#666; font-size:0.65rem">MZFW: ---</div>
                        </div>
                    </div>
                    <div id="tow-warnings" style="margin-top:10px"></div>
                    <button class="clear-btn" id="calc-clear">Clear</button>
                </div>

                <!-- OPT ACC Calculator -->
                <div class="section" style="min-width:200px">
                    <div class="section-title">Acceleration Height</div>
                    <div class="input-grid-2" style="gap:12px">
                        <div class="input-group">
                            <label class="input-label">OPT ACC</label>
                            <div class="input-btn-with-unit" style="width:100%">
                                <button class="input-btn placeholder" id="opt-acc-btn" onclick="openWeightPicker('opt-acc', 'OPT ACC', 'ft')" style="max-width:110px; padding-right:25px">0</button>
                                <span class="input-btn-unit" style="right:10px">ft</span>
                            </div>
                            <input type="hidden" id="opt-acc" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ELEV</label>
                            <div class="input-btn-with-unit" style="width:100%">
                                <button class="input-btn placeholder" id="airfield-elev-btn" onclick="openWeightPicker('airfield-elev', 'Elevation', 'ft')" style="max-width:110px; padding-right:25px">0</button>
                                <span class="input-btn-unit" style="right:10px">ft</span>
                            </div>
                            <input type="hidden" id="airfield-elev" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">ACC HEIGHT AGL</div>
                            <div class="result-value acc-value" id="acc-result">--- ft</div>
                        </div>
                    </div>
                    <button class="preset-btn" id="rw12r-btn">RW12R (62 ft)</button>
                    <button class="clear-btn" id="acc-clear">Clear</button>
                </div>
            </div>

            <!-- Max Landing Fuel Calculator -->
            <div class="section" style="max-width: 400px; margin: 0 auto 25px;">
                <div class="section-title">Max Landing Fuel</div>
                <div class="aircraft-selector">
                    <button class="aircraft-btn active" id="ac-b738" onclick="selectAircraft('B738')">B738</button>
                    <button class="aircraft-btn" id="ac-b38m" onclick="selectAircraft('B38M')">B38M</button>
                    <button class="aircraft-btn" id="ac-b39m" onclick="selectAircraft('B39M')">B39M</button>
                </div>
                <div class="mlw-info">MLW: <span id="mlw-display">66,360</span> kg</div>
                <div class="results-row" style="border:none; padding-top:5px;">
                    <div class="result-item">
                        <div class="result-label">MAX FUEL ON LANDING</div>
                        <div class="result-value mlf-value" id="mlf-result">---</div>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.7rem; color:#888; margin-top:5px;">
                    Uses ZFW from TOW Calculator
                </div>
            </div>

        </div>

        <!-- Timers Tab -->
        <div class="tab-content" id="tab-timers">
            <div class="timers-grid" id="timers-container"></div>
        </div>

        <!-- Fuel Tab -->
        <div class="tab-content" id="tab-fuel">
            <div class="fdp-container">
                <!-- Input Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Inputs</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Fuel Required (kg)</label>
                            <button class="input-btn" id="fuel-req-btn" onclick="openFuelPicker('fuel-req', 'Fuel Required', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-req" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pre Uplift (kg)</label>
                            <button class="input-btn" id="fuel-pre-btn" onclick="openFuelPicker('fuel-pre', 'Pre Uplift', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-pre" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">SG (Density)</label>
                            <button class="input-btn" id="fuel-sg-btn" onclick="openSGPicker()" style="max-width:100%">0.800</button>
                            <input type="hidden" id="fuel-sg" value="800">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Uplift (L)</label>
                            <button class="input-btn" id="fuel-actual-btn" onclick="openFuelPicker('fuel-actual', 'Actual Uplift', 'L')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-actual" value="">
                        </div>
                    </div>
                </div>

                <!-- Tank Split Block -->
                <div class="fdp-section">
                    <div class="section-title">Tank Split</div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Left Wing (kg)</label>
                            <button class="input-btn" id="tank-left-btn" onclick="openFuelPicker('tank-left', 'Left Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-left" value="3700">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Center (kg)</label>
                            <div class="fdp-result-value green" id="tank-center" style="padding-top:8px; text-align:center">---</div>
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Right Wing (kg)</label>
                            <button class="input-btn" id="tank-right-btn" onclick="openFuelPicker('tank-right', 'Right Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-right" value="3700">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:5px;">
                        Center tank is auto-calculated: Total Required - Left - Right
                    </div>
                </div>

                <!-- Fuel Summary Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Summary</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Fuel Required</div>
                                <div class="fdp-result-value" id="summary-req">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Pre Uplift</div>
                                <div class="fdp-result-value" id="summary-pre">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Uplift Required</div>
                                <div class="fdp-result-value yellow" id="summary-uplift-req">--- kg</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Departure Fuel</div>
                                <div class="fdp-result-value" id="summary-dep">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Adjustment (+/-)</div>
                                <div style="display:flex; gap:5px; justify-content:center">
                                    <button class="input-btn" id="fuel-adj-btn" onclick="openAdjustmentPicker()" style="max-width:80px; flex:1">0</button>
                                    <button class="input-btn" id="fuel-adj-sign-btn" onclick="toggleAdjustmentSign()" style="max-width:40px; padding:5px; font-size:1.2rem">+/-</button>
                                </div>
                                <input type="hidden" id="fuel-adj" value="">
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Final Departure Fuel</div>
                                <div class="fdp-result-value green" id="summary-final-dep">--- kg</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uplift Verification Block -->
                <div class="fdp-section">
                    <div class="section-title">Uplift Verification</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated Uplift</div>
                                <div class="fdp-result-value" id="calc-uplift">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Actual Uplift</div>
                                <div class="fdp-result-value" id="verify-actual">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Difference</div>
                                <div class="fdp-result-value" id="uplift-diff">--- %</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">-3% Limit</div>
                                <div class="fdp-result-value" id="limit-low">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated</div>
                                <div class="fdp-result-value yellow" id="limit-calc">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">+3% Limit</div>
                                <div class="fdp-result-value" id="limit-high">--- L</div>
                            </div>
                        </div>
                        <div id="uplift-status" style="margin-top:15px; text-align:center;"></div>
                    </div>
                </div>

                <!-- Fuel Unit Converter -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Unit Converter</div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-bottom:10px;">
                        Enter one value and press OK - others will auto-calculate (SG: 0.800)
                    </div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Litres (L)</label>
                            <button class="input-btn" id="conv-litres-btn" onclick="openConverterPicker('litres')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-litres" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">US Gallons</label>
                            <button class="input-btn" id="conv-gallons-btn" onclick="openConverterPicker('gallons')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-gallons" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Pounds (lbs)</label>
                            <button class="input-btn" id="conv-lbs-btn" onclick="openConverterPicker('lbs')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-lbs" value="">
                        </div>
                    </div>
                    <button class="clear-btn" id="conv-clear" style="margin-top:10px">Clear Converter</button>
                </div>

                <button class="clear-btn" id="fuel-clear" style="margin-top:15px">Clear All Fuel Data</button>
            </div>
        </div>

        <!-- Layover Tab -->
        <div class="tab-content" id="tab-layover">
            <div class="fdp-container">
                <!-- UTC Offset Selector -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="layover-offset" onchange="calculateLayover()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0" selected>UTC+0</option>
                        <option value="1">UTC+1</option>
                        <option value="2">UTC+2</option>
                        <option value="3">UTC+3</option>
                        <option value="4">UTC+4 (DXB)</option>
                        <option value="5">UTC+5</option>
                        <option value="5.5">UTC+5:30</option>
                        <option value="6">UTC+6</option>
                        <option value="7">UTC+7</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Wake Up Calculator</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">STD (UTC)</label>
                            <button class="input-btn" id="layover-std-btn" onclick="openTimePicker('layover-std')" style="max-width:100%">----</button>
                            <input type="hidden" id="layover-std" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pickup Before STD</label>
                            <button class="input-btn" id="layover-pickup-btn" onclick="openTimePicker('layover-pickup')" style="max-width:100%">0130</button>
                            <input type="hidden" id="layover-pickup" value="0130">
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Calculated Times</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">STD (Local)</div>
                                <div class="fdp-result-local" id="layover-std-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-std-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Hotel Departure</div>
                                <div class="fdp-result-local" id="layover-hotel-local" style="color:#ffd700">--:--</div>
                                <div class="fdp-result-utc" id="layover-hotel-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Wake Up Time</div>
                                <div class="fdp-result-local" id="layover-wake-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-wake-utc">UTC: --:--</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:10px;">
                        Hotel Departure = STD - Pickup Time | Wake Up = Hotel Departure - 1 hour
                    </div>
                </div>

                <button class="clear-btn" id="layover-clear" style="margin-top:15px">Clear</button>
            </div>
        </div>

        <!-- FDP Calculator Tab -->
        <div class="tab-content" id="tab-fdp">
            <div class="fdp-container">
                <!-- Local Time Offset -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="local-offset" onchange="calculateFDP()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0">UTC+0</option>
                        <option value="1">UTC+1</option>
                        <option value="2">UTC+2</option>
                        <option value="3">UTC+3</option>
                        <option value="4" selected>UTC+4 (DXB)</option>
                        <option value="5">UTC+5</option>
                        <option value="5.5">UTC+5:30</option>
                        <option value="6">UTC+6</option>
                        <option value="7">UTC+7</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Duty Setup</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Crew Type</label>
                            <select class="fdp-select" id="fdp-crew-type" onchange="calculateFDP()">
                                <option value="flight">Flight Crew</option>
                                <option value="cabin">Cabin Crew</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Acclimatization</label>
                            <select class="fdp-select" id="fdp-acclimatized" onchange="calculateFDP()">
                                <option value="yes">Acclimatized</option>
                                <option value="no">Not Acclimatized</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Preceding Rest</label>
                            <select class="fdp-select" id="fdp-rest" onchange="calculateFDP()">
                                <option value="normal">Up to 18h or over 30h</option>
                                <option value="reduced">Between 18-30h</option>
                            </select>
                        </div>
                    </div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Report Time (Local)</label>
                            <button class="input-btn" id="fdp-report-btn" onclick="openTimePicker('fdp-report')" style="max-width:100%">0600</button>
                            <input type="hidden" id="fdp-report" value="0600">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Number of Sectors</label>
                            <select class="fdp-select" id="fdp-sectors" onchange="updateSectorInputs(); calculateFDP()">
                                <option value="1">1 Sector</option>
                                <option value="2">2 Sectors</option>
                                <option value="3">3 Sectors</option>
                                <option value="4">4 Sectors</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Scheduled Sector Times</div>
                    <div class="sector-inputs" id="sector-inputs">
                        <!-- Dynamically filled -->
                    </div>

                    <div class="actual-tracking">
                        <div class="actual-tracking-title">Actual Times Tracking</div>
                        <div class="actual-sector-grid" id="actual-sector-inputs">
                            <!-- Dynamically filled -->
                        </div>
                        <div class="duty-estimate" id="duty-estimate">
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label">Estimated Duty End (Local):</span>
                                <span class="duty-estimate-value" id="est-duty-end-local" style="color:#00ff88; font-size:1.3rem">--:--</span>
                            </div>
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label" style="color:#666">UTC:</span>
                                <span class="duty-estimate-value" id="est-duty-end" style="color:#888; font-size:0.95rem">--:--</span>
                            </div>
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label">Status:</span>
                                <span class="duty-estimate-value green" id="duty-status">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">FDP Results</div>
                    <div class="fdp-results">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max FDP</div>
                                <div class="fdp-result-value green" id="fdp-max">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest On-Chocks</div>
                                <div class="fdp-result-local" id="fdp-chocks-local">--:--</div>
                                <div class="fdp-result-utc" id="fdp-chocks">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest Off-Duty</div>
                                <div class="fdp-result-local" id="fdp-offduty-local">--:--</div>
                                <div class="fdp-result-utc" id="fdp-offduty">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max Discretion</div>
                                <div class="fdp-result-value yellow" id="fdp-discretion">+3:00</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Absolute Limit</div>
                                <div class="fdp-result-local" id="fdp-absolute-local" style="color:#FF8200">--:--</div>
                                <div class="fdp-result-utc" id="fdp-absolute">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Min Rest After</div>
                                <div class="fdp-result-value" id="fdp-rest-after">12:00</div>
                            </div>
                        </div>
                        <div id="fdp-warnings"></div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Live Duty Tracker</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Report (Local)</label>
                            <button class="input-btn" id="fdp-actual-report-btn" onclick="openTimePicker('fdp-actual-report')" style="max-width:100%">----</button>
                            <input type="hidden" id="fdp-actual-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current UTC</label>
                            <div class="fdp-result-value" id="fdp-utc-time" style="padding-top:10px">--:--:--</div>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current Local</label>
                            <div class="fdp-result-value" id="fdp-local-time" style="padding-top:10px">--:--:--</div>
                        </div>
                    </div>
                    <div class="fdp-result-grid" style="margin-top:15px">
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Elapsed</div>
                            <div class="fdp-result-value" id="fdp-elapsed">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Remaining</div>
                            <div class="fdp-result-value green" id="fdp-remaining">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">Into Discretion</div>
                            <div class="fdp-result-value" id="fdp-into-discretion">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Number Picker Modal -->
    <div class="modal-overlay" id="number-picker-modal">
        <div class="number-picker">
            <div class="picker-title" id="picker-title">Set Value</div>
            <div class="picker-display">
                <span class="picker-value" id="picker-value">0</span>
                <span class="picker-unit" id="picker-unit"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="pickerAppend('1')">1</button>
                <button class="picker-btn" onclick="pickerAppend('2')">2</button>
                <button class="picker-btn" onclick="pickerAppend('3')">3</button>
                <button class="picker-btn" onclick="pickerAppend('4')">4</button>
                <button class="picker-btn" onclick="pickerAppend('5')">5</button>
                <button class="picker-btn" onclick="pickerAppend('6')">6</button>
                <button class="picker-btn" onclick="pickerAppend('7')">7</button>
                <button class="picker-btn" onclick="pickerAppend('8')">8</button>
                <button class="picker-btn" onclick="pickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="pickerClear()">C</button>
                <button class="picker-btn" onclick="pickerAppend('0')">0</button>
                <button class="picker-btn" onclick="pickerBackspace()">&larr;</button>
                <button class="picker-btn" onclick="pickerAppend('00')" style="font-size:1rem">00</button>
                <button class="picker-btn" onclick="pickerAppend('000')" style="font-size:0.9rem">000</button>
                <button class="picker-btn" onclick="pickerAppend('0000')" style="font-size:0.8rem">0000</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closePicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmPicker()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============ TAB SWITCHING ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // ============ NUMBER PICKER ============
        let pickerCallback = null;
        let pickerValue = '';
        let pickerMaxLength = 6;
        let pickerFormatCommas = false;
        let pickerFirstInput = true; // Track if this is first input since opening

        function openPicker(title, unit, currentValue, maxLength, formatCommas, callback) {
            pickerCallback = callback;
            pickerValue = currentValue.toString().replace(/,/g, '');
            pickerMaxLength = maxLength;
            pickerFormatCommas = formatCommas;
            pickerFirstInput = true; // Reset on open
            document.getElementById('picker-title').textContent = title;
            document.getElementById('picker-unit').textContent = unit || '';
            updatePickerDisplay();
            document.getElementById('number-picker-modal').classList.add('active');
        }

        function updatePickerDisplay() {
            let display = pickerValue || '0';
            if (pickerFormatCommas && display !== '0') {
                display = parseInt(display, 10).toLocaleString();
            }
            document.getElementById('picker-value').textContent = display;
        }

        function closePicker() {
            document.getElementById('number-picker-modal').classList.remove('active');
            pickerCallback = null;
        }

        function pickerAppend(digit) {
            // If this is first input and there's existing value, clear it first
            if (pickerFirstInput && pickerValue.length > 0) {
                pickerValue = '';
            }
            pickerFirstInput = false;

            // Handle multi-digit append (00, 000, 0000)
            const newLength = pickerValue.length + digit.length;
            if (newLength <= pickerMaxLength) {
                pickerValue += digit;
                updatePickerDisplay();
            } else if (pickerValue.length < pickerMaxLength) {
                // Append as many digits as possible
                const remaining = pickerMaxLength - pickerValue.length;
                pickerValue += digit.substring(0, remaining);
                updatePickerDisplay();
            }
        }

        function pickerClear() {
            pickerValue = '';
            pickerFirstInput = false;
            updatePickerDisplay();
        }

        function pickerBackspace() {
            pickerFirstInput = false;
            pickerValue = pickerValue.slice(0, -1);
            updatePickerDisplay();
        }

        function confirmPicker() {
            if (pickerCallback) {
                pickerCallback(pickerValue);
            }
            closePicker();
        }

        // Time picker (HHMM format)
        function openTimePicker(fieldId) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker('Enter Time (HHMM)', '', currentVal, 4, false, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? val.padStart(4, '0') : (fieldId === 'utc-manual' ? 'AUTO' : (fieldId.startsWith('layover-') ? '----' : '0000'));
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('oooi-')) calculateOOOI();
                else if (fieldId === 'eta-time') { etaManualStartTime = null; calculateETA(); }
                else if (fieldId === 'utc-manual') { etaManualStartTime = val ? Date.now() : null; saveETA(); calculateETA(); }
                else if (fieldId === 'fdp-report' || fieldId === 'fdp-actual-report') calculateFDP();
                else if (fieldId.startsWith('sector-') || fieldId.startsWith('actual-')) {
                    calculateSectorTurnarounds();
                    estimateDutyEnd();
                }
                else if (fieldId.startsWith('layover-')) calculateLayover();
            });
        }

        // Weight picker (with commas)
        function openWeightPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('calc-')) {
                    calculateTOW();
                    calculateMLF();
                }
                else if (fieldId === 'opt-acc' || fieldId === 'airfield-elev') calculateACC();
            });
        }

        // ============ AIRCRAFT & WEIGHT LIMITS ============
        const aircraftLimits = {
            'B738': {
                name: 'B737-800',
                mtw: 79242,
                mtow: 79015,
                mlw: 66360,
                mzfw: 62731,
                sfp: 'SFP1'
            },
            'B38M': {
                name: 'B737-8',
                mtw: 82417,
                mtow: 82190,
                mlw: 69308,
                mzfw: 65952,
                sfp: 'SFP1'
            },
            'B39M': {
                name: 'B737-9',
                mtw: 88541,
                mtow: 88314,
                mlw: 74343,
                mzfw: 70987,
                sfp: 'SFP2'
            }
        };
        let selectedAircraft = 'B738';

        function selectAircraft(type) {
            selectedAircraft = type;
            // Update all aircraft selector buttons (TOW and MLF sections)
            document.querySelectorAll('.aircraft-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('ac-' + type.toLowerCase()).classList.add('active');
            document.getElementById('tow-ac-' + type.toLowerCase()).classList.add('active');

            // Update MLW display
            document.getElementById('mlw-display').textContent = aircraftLimits[type].mlw.toLocaleString();

            // Update limit displays
            updateLimitDisplays();

            // Recalculate
            calculateTOW();
            calculateMLF();
        }

        function updateLimitDisplays() {
            const limits = aircraftLimits[selectedAircraft];
            document.getElementById('mtw-limit').textContent = 'MTW: ' + limits.mtw.toLocaleString();
            document.getElementById('mtow-limit').textContent = 'MTOW: ' + limits.mtow.toLocaleString();
            document.getElementById('mzfw-limit').textContent = 'MZFW: ' + limits.mzfw.toLocaleString();
        }

        function calculateMLF() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const mlw = aircraftLimits[selectedAircraft].mlw;

            if (zfw === 0) {
                document.getElementById('mlf-result').textContent = '---';
            } else {
                const maxFuel = mlw - zfw;
                document.getElementById('mlf-result').textContent = maxFuel.toLocaleString() + ' kg';
            }
        }

        // ============ FUEL CALCULATOR ============
        function openFuelPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                calculateFuel();
            });
        }

        function openSGPicker() {
            const currentVal = document.getElementById('fuel-sg').value || '800';
            openPicker('SG (e.g. 800 = 0.800)', '', currentVal, 3, false, (val) => {
                document.getElementById('fuel-sg').value = val;
                const btn = document.getElementById('fuel-sg-btn');
                if (btn) {
                    const sg = parseInt(val, 10) || 800;
                    btn.textContent = '0.' + sg.toString().padStart(3, '0');
                }
                calculateFuel();
            });
        }

        function openAdjustmentPicker() {
            const currentVal = document.getElementById('fuel-adj').value || '';
            const absVal = currentVal.replace('-', '');
            openPicker('Adjustment (+/-)', 'kg', absVal, 5, true, (val) => {
                const adj = parseInt(val, 10) || 0;
                if (adj !== 0) {
                    // Default to positive, can toggle with +/- button
                    document.getElementById('fuel-adj').value = val;
                    const btn = document.getElementById('fuel-adj-btn');
                    if (btn) {
                        btn.textContent = '+' + adj.toLocaleString();
                    }
                } else {
                    document.getElementById('fuel-adj').value = '';
                    document.getElementById('fuel-adj-btn').textContent = '0';
                }
                calculateFuel();
            });
        }

        function toggleAdjustmentSign() {
            const val = document.getElementById('fuel-adj').value;
            if (!val) return;
            if (val.startsWith('-')) {
                document.getElementById('fuel-adj').value = val.substring(1);
                document.getElementById('fuel-adj-btn').textContent = '+' + parseInt(val.substring(1), 10).toLocaleString();
            } else {
                document.getElementById('fuel-adj').value = '-' + val;
                document.getElementById('fuel-adj-btn').textContent = '-' + parseInt(val, 10).toLocaleString();
            }
            calculateFuel();
        }

        function loadFuel() {
            const saved = localStorage.getItem('flightFuel');
            if (saved) {
                try {
                    const fuel = JSON.parse(saved);
                    // Restore values
                    if (fuel.req) {
                        document.getElementById('fuel-req').value = fuel.req;
                        document.getElementById('fuel-req-btn').textContent = parseInt(fuel.req, 10).toLocaleString();
                        document.getElementById('fuel-req-btn').classList.remove('placeholder');
                    }
                    if (fuel.pre) {
                        document.getElementById('fuel-pre').value = fuel.pre;
                        document.getElementById('fuel-pre-btn').textContent = parseInt(fuel.pre, 10).toLocaleString();
                        document.getElementById('fuel-pre-btn').classList.remove('placeholder');
                    }
                    if (fuel.sg) {
                        document.getElementById('fuel-sg').value = fuel.sg;
                        document.getElementById('fuel-sg-btn').textContent = '0.' + fuel.sg.toString().padStart(3, '0');
                    }
                    if (fuel.actual) {
                        document.getElementById('fuel-actual').value = fuel.actual;
                        document.getElementById('fuel-actual-btn').textContent = parseInt(fuel.actual, 10).toLocaleString();
                        document.getElementById('fuel-actual-btn').classList.remove('placeholder');
                    }
                    if (fuel.left) {
                        document.getElementById('tank-left').value = fuel.left;
                        document.getElementById('tank-left-btn').textContent = parseInt(fuel.left, 10).toLocaleString();
                    }
                    if (fuel.right) {
                        document.getElementById('tank-right').value = fuel.right;
                        document.getElementById('tank-right-btn').textContent = parseInt(fuel.right, 10).toLocaleString();
                    }
                    if (fuel.adj) {
                        document.getElementById('fuel-adj').value = fuel.adj;
                        const adj = parseInt(fuel.adj, 10);
                        document.getElementById('fuel-adj-btn').textContent = (adj >= 0 ? '+' : '') + adj.toLocaleString();
                        document.getElementById('fuel-adj-btn').onclick = function() { toggleAdjustmentSign(); };
                    }
                    calculateFuel();
                } catch (e) {}
            }
        }

        function saveFuel() {
            const fuel = {
                req: document.getElementById('fuel-req').value,
                pre: document.getElementById('fuel-pre').value,
                sg: document.getElementById('fuel-sg').value,
                actual: document.getElementById('fuel-actual').value,
                left: document.getElementById('tank-left').value,
                right: document.getElementById('tank-right').value,
                adj: document.getElementById('fuel-adj').value
            };
            localStorage.setItem('flightFuel', JSON.stringify(fuel));
        }

        function calculateFuel() {
            const fuelReq = parseInt(document.getElementById('fuel-req').value, 10) || 0;
            const preUplift = parseInt(document.getElementById('fuel-pre').value, 10) || 0;
            const sgVal = parseInt(document.getElementById('fuel-sg').value, 10) || 800;
            const sg = sgVal / 1000; // Convert 800 to 0.800
            const actualUplift = parseInt(document.getElementById('fuel-actual').value, 10) || 0;
            const tankLeft = parseInt(document.getElementById('tank-left').value, 10) || 3700;
            const tankRight = parseInt(document.getElementById('tank-right').value, 10) || 3700;
            const adjustment = parseInt(document.getElementById('fuel-adj').value, 10) || 0;

            // Tank split - center tank calculation
            const centerTank = fuelReq - tankLeft - tankRight;
            document.getElementById('tank-center').textContent = fuelReq > 0 ?
                (centerTank >= 0 ? centerTank.toLocaleString() + ' kg' : 'Wings exceed total!') : '---';
            if (centerTank < 0 && fuelReq > 0) {
                document.getElementById('tank-center').className = 'fdp-result-value red';
            } else {
                document.getElementById('tank-center').className = 'fdp-result-value green';
            }

            // Fuel Summary
            document.getElementById('summary-req').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';
            document.getElementById('summary-pre').textContent = preUplift > 0 ? preUplift.toLocaleString() + ' kg' : '--- kg';

            const upliftReq = fuelReq - preUplift;
            document.getElementById('summary-uplift-req').textContent = fuelReq > 0 ? upliftReq.toLocaleString() + ' kg' : '--- kg';

            // Departure fuel
            document.getElementById('summary-dep').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';

            const finalDep = fuelReq + adjustment;
            if (fuelReq > 0) {
                document.getElementById('summary-final-dep').textContent = finalDep.toLocaleString() + ' kg';
            } else {
                document.getElementById('summary-final-dep').textContent = '--- kg';
            }

            // Uplift verification
            // Calculate uplift in litres: uplift kg / SG = litres
            const calcUpliftLitres = upliftReq > 0 && sg > 0 ? Math.round(upliftReq / sg) : 0;

            document.getElementById('calc-uplift').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';
            document.getElementById('verify-actual').textContent = actualUplift > 0 ? actualUplift.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-calc').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';

            // 3% limits
            const lowLimit = Math.round(calcUpliftLitres * 0.97);
            const highLimit = Math.round(calcUpliftLitres * 1.03);
            document.getElementById('limit-low').textContent = calcUpliftLitres > 0 ? lowLimit.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-high').textContent = calcUpliftLitres > 0 ? highLimit.toLocaleString() + ' L' : '--- L';

            // Percentage difference
            if (calcUpliftLitres > 0 && actualUplift > 0) {
                const diff = ((actualUplift - calcUpliftLitres) / calcUpliftLitres) * 100;
                const diffEl = document.getElementById('uplift-diff');
                diffEl.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';

                // Color based on range
                if (Math.abs(diff) <= 3) {
                    diffEl.className = 'fdp-result-value green';
                } else if (Math.abs(diff) <= 5) {
                    diffEl.className = 'fdp-result-value yellow';
                } else {
                    diffEl.className = 'fdp-result-value red';
                }

                // Status message
                const statusEl = document.getElementById('uplift-status');
                if (actualUplift >= lowLimit && actualUplift <= highLimit) {
                    statusEl.innerHTML = '<div class="fdp-warning" style="background:rgba(0,200,80,0.2);border-color:rgba(0,200,80,0.5);color:#00ff88">Actual uplift within 3% tolerance</div>';
                } else {
                    statusEl.innerHTML = '<div class="fdp-danger">Actual uplift outside 3% tolerance - verify figures</div>';
                }
            } else {
                document.getElementById('uplift-diff').textContent = '--- %';
                document.getElementById('uplift-diff').className = 'fdp-result-value';
                document.getElementById('uplift-status').innerHTML = '';
            }

            saveFuel();
        }

        // ============ FUEL UNIT CONVERTER ============
        // Constants: 1 US gallon = 3.78541 litres, Jet-A density ~0.800 kg/L = 1.764 lbs/L
        const LITRES_PER_GALLON = 3.78541;
        const LBS_PER_LITRE = 1.764; // at SG 0.800

        function openConverterPicker(unit) {
            const fieldId = 'conv-' + unit;
            const currentVal = document.getElementById(fieldId).value || '';
            const titles = {
                'litres': 'Enter Litres',
                'gallons': 'Enter US Gallons',
                'lbs': 'Enter Pounds'
            };
            const units = {
                'litres': 'L',
                'gallons': 'gal',
                'lbs': 'lbs'
            };
            openPicker(titles[unit], units[unit], currentVal, 7, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                }
                calculateConverter(unit, parseInt(val, 10) || 0);
            });
        }

        function calculateConverter(sourceUnit, value) {
            let litres, gallons, lbs;

            if (sourceUnit === 'litres') {
                litres = value;
                gallons = Math.round(litres / LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'gallons') {
                gallons = value;
                litres = Math.round(gallons * LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'lbs') {
                lbs = value;
                litres = Math.round(lbs / LBS_PER_LITRE);
                gallons = Math.round(litres / LITRES_PER_GALLON);
            }

            // Update all fields
            document.getElementById('conv-litres').value = litres || '';
            document.getElementById('conv-gallons').value = gallons || '';
            document.getElementById('conv-lbs').value = lbs || '';

            document.getElementById('conv-litres-btn').textContent = litres ? litres.toLocaleString() : '0';
            document.getElementById('conv-gallons-btn').textContent = gallons ? gallons.toLocaleString() : '0';
            document.getElementById('conv-lbs-btn').textContent = lbs ? lbs.toLocaleString() : '0';
        }

        // ============ LAYOVER CALCULATOR ============
        function getLayoverOffset() {
            return parseFloat(document.getElementById('layover-offset').value) || 0;
        }

        function layoverUtcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLayoverOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function subtractTime(timeStr, hoursToSubtract, minsToSubtract) {
            const time = parseTime(timeStr);
            if (!time) return null;
            let totalMins = time.hours * 60 + time.minutes - (hoursToSubtract * 60) - minsToSubtract;
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function calculateLayover() {
            const stdStr = document.getElementById('layover-std').value;
            const pickupStr = document.getElementById('layover-pickup').value || '0130';

            // Update button displays
            const stdBtn = document.getElementById('layover-std-btn');
            stdBtn.textContent = stdStr ? stdStr.padStart(4, '0') : '----';

            const pickupBtn = document.getElementById('layover-pickup-btn');
            pickupBtn.textContent = pickupStr.padStart(4, '0');

            const std = parseTime(stdStr);
            const pickup = parseTime(pickupStr);

            if (!std) {
                document.getElementById('layover-std-local').textContent = '--:--';
                document.getElementById('layover-std-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-hotel-local').textContent = '--:--';
                document.getElementById('layover-hotel-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-wake-local').textContent = '--:--';
                document.getElementById('layover-wake-utc').textContent = 'UTC: --:--';
                return;
            }

            // STD display (Local prominent, UTC secondary)
            const stdFormatted = stdStr.padStart(4, '0');
            const stdUtcDisplay = stdFormatted.substring(0, 2) + ':' + stdFormatted.substring(2);
            document.getElementById('layover-std-local').textContent = layoverUtcToLocal(stdStr);
            document.getElementById('layover-std-utc').textContent = 'UTC: ' + stdUtcDisplay;

            // Hotel departure = STD - pickup time
            const pickupHours = pickup ? pickup.hours : 1;
            const pickupMins = pickup ? pickup.minutes : 30;
            const hotelUTC = subtractTime(stdStr, pickupHours, pickupMins);
            if (hotelUTC) {
                const hotelUtcDisplay = hotelUTC.substring(0, 2) + ':' + hotelUTC.substring(2);
                document.getElementById('layover-hotel-local').textContent = layoverUtcToLocal(hotelUTC);
                document.getElementById('layover-hotel-utc').textContent = 'UTC: ' + hotelUtcDisplay;

                // Wake up = Hotel departure - 1 hour
                const wakeUTC = subtractTime(hotelUTC, 1, 0);
                if (wakeUTC) {
                    const wakeUtcDisplay = wakeUTC.substring(0, 2) + ':' + wakeUTC.substring(2);
                    document.getElementById('layover-wake-local').textContent = layoverUtcToLocal(wakeUTC);
                    document.getElementById('layover-wake-utc').textContent = 'UTC: ' + wakeUtcDisplay;
                }
            }

            saveLayover();
        }

        function loadLayover() {
            const saved = localStorage.getItem('flightLayover');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.std) {
                        document.getElementById('layover-std').value = data.std;
                        document.getElementById('layover-std-btn').textContent = data.std.padStart(4, '0');
                    }
                    if (data.pickup) {
                        document.getElementById('layover-pickup').value = data.pickup;
                        document.getElementById('layover-pickup-btn').textContent = data.pickup.padStart(4, '0');
                    }
                    if (data.offset !== undefined) {
                        document.getElementById('layover-offset').value = data.offset;
                    }
                    calculateLayover();
                } catch (e) {}
            }
        }

        function saveLayover() {
            const data = {
                std: document.getElementById('layover-std').value,
                pickup: document.getElementById('layover-pickup').value,
                offset: document.getElementById('layover-offset').value
            };
            localStorage.setItem('flightLayover', JSON.stringify(data));
        }

        // ============ DEFAULT TIMERS ============
        const defaultTimers = [
            { name: 'APU', type: 'countdown', hours: 0, minutes: 11 },
            { name: 'APU Start', type: 'countdown', hours: 3, minutes: 0 },
            { name: 'Timer 3', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 4', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 5', type: 'stopwatch', hours: 0, minutes: 0 }
        ];

        let timers = [];
        let animationFrameId = null;
        let etaManualStartTime = null;

        // ============ TIMER STATE ============
        function loadState() {
            const saved = localStorage.getItem('flightTimers');
            if (saved) {
                try {
                    timers = JSON.parse(saved);
                    const now = Date.now();
                    timers.forEach((timer) => {
                        if (timer.running && timer.lastUpdate) {
                            const elapsed = now - timer.lastUpdate;
                            if (timer.type === 'countdown') {
                                timer.remaining = Math.max(0, timer.remaining - elapsed);
                            } else {
                                timer.elapsed = (timer.elapsed || 0) + elapsed;
                            }
                        }
                        if (timer.running) {
                            timer.lastUpdate = now;
                        }
                    });
                } catch (e) {
                    timers = JSON.parse(JSON.stringify(defaultTimers));
                }
            } else {
                timers = JSON.parse(JSON.stringify(defaultTimers));
            }

            timers.forEach((timer) => {
                if (timer.remaining === undefined) {
                    timer.remaining = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
                if (timer.elapsed === undefined) {
                    timer.elapsed = 0;
                }
                if (timer.initialTime === undefined) {
                    timer.initialTime = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
            });
        }

        function saveState() {
            const now = Date.now();
            timers.forEach(timer => {
                if (timer.running) {
                    timer.lastUpdate = now;
                }
            });
            localStorage.setItem('flightTimers', JSON.stringify(timers));
        }

        // ============ OOOI ============
        function loadOOOI() {
            const saved = localStorage.getItem('flightOOOI');
            if (saved) {
                try {
                    const oooi = JSON.parse(saved);
                    ['out', 'off', 'on', 'in'].forEach(field => {
                        const val = oooi[field] || '';
                        document.getElementById('oooi-' + field).value = val;
                        const btn = document.getElementById('oooi-' + field + '-btn');
                        btn.textContent = val ? val.padStart(4, '0') : '0000';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateOOOI();
                } catch (e) {}
            }
        }

        function saveOOOI() {
            const oooi = {
                out: document.getElementById('oooi-out').value,
                off: document.getElementById('oooi-off').value,
                on: document.getElementById('oooi-on').value,
                in: document.getElementById('oooi-in').value
            };
            localStorage.setItem('flightOOOI', JSON.stringify(oooi));
        }

        function parseTime(str) {
            if (!str || str.length < 3) return null;
            str = str.padStart(4, '0');
            const hours = parseInt(str.substring(0, 2), 10);
            const minutes = parseInt(str.substring(2, 4), 10);
            if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return null;
            return { hours, minutes };
        }

        function timeDiff(start, end) {
            if (!start || !end) return null;
            let startMins = start.hours * 60 + start.minutes;
            let endMins = end.hours * 60 + end.minutes;
            if (endMins < startMins) {
                endMins += 24 * 60;
            }
            return endMins - startMins;
        }

        function formatMinutes(mins) {
            if (mins === null) return '--:--';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function calculateOOOI() {
            const out = parseTime(document.getElementById('oooi-out').value);
            const off = parseTime(document.getElementById('oooi-off').value);
            const on = parseTime(document.getElementById('oooi-on').value);
            const inn = parseTime(document.getElementById('oooi-in').value);

            document.getElementById('block-time').textContent = formatMinutes(timeDiff(out, inn));
            document.getElementById('flight-time').textContent = formatMinutes(timeDiff(off, on));
            saveOOOI();
        }

        // ============ ETA ============
        function loadETA() {
            const saved = localStorage.getItem('flightETA');
            if (saved) {
                try {
                    const eta = JSON.parse(saved);
                    document.getElementById('eta-time').value = eta.time || '';
                    document.getElementById('utc-manual').value = eta.manual || '';

                    const etaBtn = document.getElementById('eta-time-btn');
                    etaBtn.textContent = eta.time ? eta.time.padStart(4, '0') : '0000';
                    etaBtn.classList.toggle('placeholder', !eta.time);

                    const manualBtn = document.getElementById('utc-manual-btn');
                    manualBtn.textContent = eta.manual ? eta.manual.padStart(4, '0') : 'AUTO';
                    manualBtn.classList.toggle('placeholder', !eta.manual);

                    if (eta.manual && eta.manualStartTime) {
                        etaManualStartTime = eta.manualStartTime;
                    }
                } catch (e) {}
            }
        }

        function saveETA() {
            const eta = {
                time: document.getElementById('eta-time').value,
                manual: document.getElementById('utc-manual').value,
                manualStartTime: etaManualStartTime
            };
            localStorage.setItem('flightETA', JSON.stringify(eta));
        }

        function updateUTCClock() {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            document.getElementById('utc-clock').textContent = utcTime;
            document.getElementById('strip-utc-clock').textContent = utcTime;
        }

        function updateActiveTimersStrip() {
            const stripContainer = document.getElementById('strip-timers');
            const activeTimers = timers.filter(t => t.running || (t.type === 'countdown' && t.remaining > 0 && t.remaining < t.initialTime));

            if (activeTimers.length === 0) {
                stripContainer.innerHTML = '<span class="strip-no-active">No active timers</span>';
                return;
            }

            stripContainer.innerHTML = timers.map((timer, index) => {
                if (!timer.running && !(timer.type === 'countdown' && timer.remaining > 0 && timer.remaining < timer.initialTime)) {
                    return '';
                }
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                return `
                    <div class="strip-timer ${colorClass}" onclick="switchTab('timers')" data-timer-index="${index}">
                        <div class="strip-timer-icon" style="--strip-progress: ${progress}%">
                            <div class="strip-timer-icon-inner"></div>
                        </div>
                        <div class="strip-timer-info">
                            <span class="strip-timer-name">${timer.name}</span>
                            <span class="strip-timer-value">${formatTime(displayTime)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStripTimerDisplay(index) {
            const timer = timers[index];
            const stripTimer = document.querySelector(`.strip-timer[data-timer-index="${index}"]`);
            if (!stripTimer) return;

            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

            stripTimer.className = `strip-timer ${colorClass}`;
            stripTimer.querySelector('.strip-timer-icon').style.setProperty('--strip-progress', `${progress}%`);
            stripTimer.querySelector('.strip-timer-value').textContent = formatTime(displayTime);
        }

        function calculateETA() {
            const etaStr = document.getElementById('eta-time').value;
            const manualStr = document.getElementById('utc-manual').value;
            const etaDisplay = document.getElementById('eta-countdown');

            const eta = parseTime(etaStr);
            if (!eta) {
                etaDisplay.textContent = '--:--:--';
                etaDisplay.className = 'eta-countdown';
                return;
            }

            let nowMins, nowSecs = 0;

            if (manualStr && manualStr.length >= 3 && etaManualStartTime) {
                // Manual mode: countdown from when manual time was entered
                const manual = parseTime(manualStr);
                if (manual) {
                    const elapsedSinceEntry = (Date.now() - etaManualStartTime) / 1000;
                    const manualTotalSecs = manual.hours * 3600 + manual.minutes * 60;
                    const currentSimSecs = manualTotalSecs + elapsedSinceEntry;
                    nowMins = currentSimSecs / 60;
                    nowSecs = currentSimSecs % 60;
                } else {
                    const now = new Date();
                    nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
                }
            } else {
                const now = new Date();
                nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            }

            let etaMins = eta.hours * 60 + eta.minutes;
            if (etaMins < nowMins - 60) {
                etaMins += 24 * 60;
            }

            const diffMins = etaMins - nowMins;
            const diffSecs = Math.max(0, Math.floor(diffMins * 60));

            if (diffSecs <= 0) {
                etaDisplay.textContent = '00:00:00';
                etaDisplay.className = 'eta-countdown critical';
            } else {
                const h = Math.floor(diffSecs / 3600);
                const m = Math.floor((diffSecs % 3600) / 60);
                const s = diffSecs % 60;
                etaDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

                if (diffMins <= 10) {
                    etaDisplay.className = 'eta-countdown critical';
                } else if (diffMins <= 30) {
                    etaDisplay.className = 'eta-countdown warning';
                } else {
                    etaDisplay.className = 'eta-countdown';
                }
            }
        }

        // ============ TOW ============
        function loadTOW() {
            const saved = localStorage.getItem('flightTOW');
            if (saved) {
                try {
                    const tow = JSON.parse(saved);
                    ['zfw', 'fob', 'taxi'].forEach(field => {
                        const val = tow[field] || '';
                        document.getElementById('calc-' + field).value = val;
                        const btn = document.getElementById('calc-' + field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateTOW();
                    calculateMLF();
                } catch (e) {}
            }
        }

        function saveTOW() {
            const tow = {
                zfw: document.getElementById('calc-zfw').value,
                fob: document.getElementById('calc-fob').value,
                taxi: document.getElementById('calc-taxi').value
            };
            localStorage.setItem('flightTOW', JSON.stringify(tow));
        }

        function calculateTOW() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const fob = parseInt(document.getElementById('calc-fob').value, 10) || 0;
            const taxi = parseInt(document.getElementById('calc-taxi').value, 10) || 0;

            const limits = aircraftLimits[selectedAircraft];
            let warnings = [];

            // Calculate weights
            const taxiWt = zfw + fob;  // Taxi weight = ZFW + total fuel
            const tow = zfw + fob - taxi;  // TOW = ZFW + FOB - Taxi fuel

            // Update ZFW display
            const zfwEl = document.getElementById('zfw-display');
            if (zfw > 0) {
                zfwEl.textContent = zfw.toLocaleString();
                if (zfw > limits.mzfw) {
                    zfwEl.style.color = '#ff5252';
                    warnings.push(`ZFW exceeds MZFW by ${(zfw - limits.mzfw).toLocaleString()} kg`);
                } else {
                    zfwEl.style.color = '#7ec8e3';
                }
            } else {
                zfwEl.textContent = '---';
                zfwEl.style.color = '#7ec8e3';
            }

            // Update Taxi Weight display
            const taxiWtEl = document.getElementById('taxi-wt-result');
            if (zfw > 0 && fob > 0) {
                taxiWtEl.textContent = taxiWt.toLocaleString();
                if (taxiWt > limits.mtw) {
                    taxiWtEl.style.color = '#ff5252';
                    warnings.push(`Taxi Weight exceeds MTW by ${(taxiWt - limits.mtw).toLocaleString()} kg`);
                } else {
                    taxiWtEl.style.color = '#00ff88';
                }
            } else {
                taxiWtEl.textContent = '---';
                taxiWtEl.style.color = '#00ff88';
            }

            // Update TOW display
            const towEl = document.getElementById('tow-result');
            if (zfw === 0 && fob === 0) {
                towEl.textContent = '---';
                towEl.style.color = '#FF8200';
            } else {
                towEl.textContent = tow.toLocaleString();
                if (tow > limits.mtow) {
                    towEl.style.color = '#ff5252';
                    warnings.push(`TOW exceeds MTOW by ${(tow - limits.mtow).toLocaleString()} kg`);
                } else {
                    towEl.style.color = '#FF8200';
                }
            }

            // Display warnings
            const warningsEl = document.getElementById('tow-warnings');
            if (warnings.length > 0) {
                warningsEl.innerHTML = warnings.map(w =>
                    `<div class="fdp-danger" style="margin-bottom:5px; padding:8px; font-size:0.8rem">${w}</div>`
                ).join('');
            } else {
                warningsEl.innerHTML = '';
            }

            saveTOW();
        }

        // ============ ACC HEIGHT ============
        function loadACC() {
            const saved = localStorage.getItem('flightACC');
            if (saved) {
                try {
                    const acc = JSON.parse(saved);
                    ['opt-acc', 'airfield-elev'].forEach(field => {
                        const key = field === 'opt-acc' ? 'optAcc' : 'elev';
                        const val = acc[key] || '';
                        document.getElementById(field).value = val;
                        const btn = document.getElementById(field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateACC();
                } catch (e) {}
            }
        }

        function saveACC() {
            const acc = {
                optAcc: document.getElementById('opt-acc').value,
                elev: document.getElementById('airfield-elev').value
            };
            localStorage.setItem('flightACC', JSON.stringify(acc));
        }

        function calculateACC() {
            const optAcc = parseInt(document.getElementById('opt-acc').value, 10) || 0;
            const elev = parseInt(document.getElementById('airfield-elev').value, 10) || 0;

            if (optAcc === 0) {
                document.getElementById('acc-result').textContent = '--- ft';
            } else {
                const result = optAcc - elev;
                document.getElementById('acc-result').textContent = result.toLocaleString() + ' ft';
            }
            saveACC();
        }

        // ============ FDP CALCULATOR ============
        const fdpTableFlightAcclimatized = {
            '0600': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '0800': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 9.5],
            '1300': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '1800': [12, 11.25, 10.5, 9.75, 9, 9, 9, 9],
            '2200': [11, 10.25, 9.5, 9, 9, 9, 9, 9]
        };

        const fdpTableCabinAcclimatized = {
            '0600': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '0800': [15, 14.25, 13.5, 12.75, 12, 11.5, 11, 10.5],
            '1300': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '1800': [13, 12.25, 11.5, 10.75, 10, 10, 10, 10],
            '2200': [12, 11.25, 10.5, 10, 10, 10, 10, 10]
        };

        const fdpTableFlightUnacclimatized = {
            'normal': [13, 12.25, 11.5, 10.75, 10, 9.25, 9],
            'reduced': [11.5, 11, 10.5, 9.75, 9, 9, 9]
        };

        const fdpTableCabinUnacclimatized = {
            'normal': [14, 13.25, 12.5, 11.75, 11, 10.25, 10],
            'reduced': [12.5, 12, 11.5, 10.75, 10, 10, 10]
        };

        function getTimeBand(reportTime) {
            const time = parseTime(reportTime);
            if (!time) return '0800';
            const mins = time.hours * 60 + time.minutes;

            if (mins >= 360 && mins < 480) return '0600';      // 0600-0759
            if (mins >= 480 && mins < 780) return '0800';      // 0800-1259
            if (mins >= 780 && mins < 1080) return '1300';     // 1300-1759
            if (mins >= 1080 && mins < 1320) return '1800';    // 1800-2159
            return '2200';                                      // 2200-0559
        }

        function getMaxFDP(crewType, acclimatized, restType, reportTime, sectors) {
            const sectorIdx = Math.min(sectors - 1, 7);

            if (acclimatized === 'yes') {
                const timeBand = getTimeBand(reportTime);
                const table = crewType === 'flight' ? fdpTableFlightAcclimatized : fdpTableCabinAcclimatized;
                return table[timeBand][sectorIdx];
            } else {
                const table = crewType === 'flight' ? fdpTableFlightUnacclimatized : fdpTableCabinUnacclimatized;
                return table[restType][Math.min(sectorIdx, 6)];
            }
        }

        function formatHoursToHHMM(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function addTime(timeStr, hoursToAdd) {
            const time = parseTime(timeStr);
            if (!time) return '--:--';
            let totalMins = time.hours * 60 + time.minutes + Math.round(hoursToAdd * 60);
            totalMins = totalMins % (24 * 60);
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function formatTimeDisplay(timeStr) {
            if (!timeStr || timeStr === '--:--') return '--:--';
            return timeStr.substring(0, 2) + ':' + timeStr.substring(2);
        }

        function getLocalOffset() {
            return parseFloat(document.getElementById('local-offset').value) || 4;
        }

        function localToUTC(localTimeStr) {
            const time = parseTime(localTimeStr);
            if (!time) return null;
            const offset = getLocalOffset();
            let utcMins = time.hours * 60 + time.minutes - (offset * 60);
            if (utcMins < 0) utcMins += 24 * 60;
            if (utcMins >= 24 * 60) utcMins -= 24 * 60;
            const h = Math.floor(utcMins / 60);
            const m = utcMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function utcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLocalOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function updateSectorInputs() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);
            const container = document.getElementById('sector-inputs');
            const actualContainer = document.getElementById('actual-sector-inputs');
            let html = '';
            let actualHtml = '';

            for (let i = 1; i <= sectors; i++) {
                html += `
                    <div class="sector-card">
                        <div class="sector-title">Sector ${i}</div>
                        <div class="sector-field">
                            <label>STD (Local)</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="sector-${i}-std-btn"
                                    onclick="openTimePicker('sector-${i}-std')">----</button>
                            <input type="hidden" id="sector-${i}-std" value="">
                        </div>
                        <div class="sector-field">
                            <label>STA (Local)</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="sector-${i}-sta-btn"
                                    onclick="openTimePicker('sector-${i}-sta')">----</button>
                            <input type="hidden" id="sector-${i}-sta" value="">
                        </div>
                        ${i < sectors ? `
                        <div class="turnaround-display">
                            <div class="turnaround-label">Turnaround</div>
                            <div class="turnaround-value" id="turnaround-${i}">--:--</div>
                        </div>
                        ` : ''}
                    </div>
                `;

                actualHtml += `
                    <div class="sector-card">
                        <div class="sector-title">Sector ${i}</div>
                        <div class="sector-field">
                            <label>Actual OFF</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="actual-${i}-off-btn"
                                    onclick="openTimePicker('actual-${i}-off')">----</button>
                            <input type="hidden" id="actual-${i}-off" value="">
                        </div>
                        <div class="sector-field">
                            <label>Actual ON</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="actual-${i}-on-btn"
                                    onclick="openTimePicker('actual-${i}-on')">----</button>
                            <input type="hidden" id="actual-${i}-on" value="">
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            actualContainer.innerHTML = actualHtml;
        }

        function calculateSectorTurnarounds() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            for (let i = 1; i < sectors; i++) {
                const staEl = document.getElementById(`sector-${i}-sta`);
                const stdEl = document.getElementById(`sector-${i + 1}-std`);
                const turnaroundEl = document.getElementById(`turnaround-${i}`);

                if (staEl && stdEl && turnaroundEl) {
                    const sta = parseTime(staEl.value);
                    const std = parseTime(stdEl.value);

                    if (sta && std) {
                        const diff = timeDiff(sta, std);
                        turnaroundEl.textContent = formatMinutes(diff);
                    } else {
                        turnaroundEl.textContent = '--:--';
                    }
                }
            }
        }

        function estimateDutyEnd() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;

            // Check if we have actual times to estimate from
            let lastActualOn = null;
            for (let i = sectors; i >= 1; i--) {
                const onEl = document.getElementById(`actual-${i}-on`);
                if (onEl && onEl.value) {
                    lastActualOn = onEl.value;
                    break;
                }
            }

            // If we have actual ON time, estimate duty end as ON + 30 min post-flight
            let estDutyEndUTC = null;
            if (lastActualOn) {
                estDutyEndUTC = addTime(lastActualOn, 0.5); // Add 30 min post-flight
            } else {
                // Use last scheduled STA
                const lastStaEl = document.getElementById(`sector-${sectors}-sta`);
                if (lastStaEl && lastStaEl.value) {
                    const staUTC = localToUTC(lastStaEl.value);
                    estDutyEndUTC = addTime(staUTC, 0.5);
                }
            }

            const estEndEl = document.getElementById('est-duty-end');
            const estEndLocalEl = document.getElementById('est-duty-end-local');
            const statusEl = document.getElementById('duty-status');

            if (estDutyEndUTC) {
                estEndEl.textContent = formatTimeDisplay(estDutyEndUTC);
                estEndLocalEl.textContent = utcToLocal(estDutyEndUTC);

                // Calculate if within limits
                const reportUTC = localToUTC(reportTime);
                const reportParsed = parseTime(reportUTC);
                const estEndParsed = parseTime(estDutyEndUTC);

                if (reportParsed && estEndParsed) {
                    let dutyMins = (estEndParsed.hours * 60 + estEndParsed.minutes) - (reportParsed.hours * 60 + reportParsed.minutes);
                    if (dutyMins < 0) dutyMins += 24 * 60;

                    const maxFDPMins = maxFDP * 60;
                    const absoluteLimitMins = (maxFDP + maxDiscretion) * 60;

                    if (dutyMins <= maxFDPMins) {
                        statusEl.textContent = 'Within FDP';
                        statusEl.className = 'duty-estimate-value green';
                    } else if (dutyMins <= absoluteLimitMins) {
                        const intoDiscretion = Math.floor(dutyMins - maxFDPMins);
                        statusEl.textContent = `In Discretion (+${formatMinutes(intoDiscretion)})`;
                        statusEl.className = 'duty-estimate-value orange';
                    } else {
                        statusEl.textContent = 'EXCEEDS LIMIT';
                        statusEl.className = 'duty-estimate-value red';
                    }
                }
            } else {
                estEndEl.textContent = '--:--';
                estEndLocalEl.textContent = '--:--';
                statusEl.textContent = '---';
                statusEl.className = 'duty-estimate-value';
            }
        }

        function calculateFDP() {
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            // Update report button display
            const reportBtn = document.getElementById('fdp-report-btn');
            reportBtn.textContent = reportTime.padStart(4, '0');

            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;
            const absoluteLimit = maxFDP + maxDiscretion;
            const minRest = crewType === 'flight' ? 12 : 11;

            // Convert report time to UTC for calculations
            const reportUTC = localToUTC(reportTime);
            const latestChocksUTC = addTime(reportUTC, maxFDP);
            const latestOffDutyUTC = addTime(reportUTC, maxFDP + 0.5);
            const absoluteChocksUTC = addTime(reportUTC, absoluteLimit);

            document.getElementById('fdp-max').textContent = formatHoursToHHMM(maxFDP);
            // Local time prominent, UTC secondary
            document.getElementById('fdp-chocks-local').textContent = utcToLocal(latestChocksUTC);
            document.getElementById('fdp-chocks').textContent = 'UTC: ' + formatTimeDisplay(latestChocksUTC);
            document.getElementById('fdp-offduty-local').textContent = utcToLocal(latestOffDutyUTC);
            document.getElementById('fdp-offduty').textContent = 'UTC: ' + formatTimeDisplay(latestOffDutyUTC);
            document.getElementById('fdp-discretion').textContent = '+' + maxDiscretion + ':00';
            document.getElementById('fdp-absolute-local').textContent = utcToLocal(absoluteChocksUTC);
            document.getElementById('fdp-absolute').textContent = 'UTC: ' + formatTimeDisplay(absoluteChocksUTC);
            document.getElementById('fdp-rest-after').textContent = minRest + ':00';

            // Warnings
            let warnings = '';
            if (acclimatized === 'no' && restType === 'reduced') {
                warnings += '<div class="fdp-warning">Reduced rest (18-30h) - Lower FDP limits apply</div>';
            }

            const timeBand = getTimeBand(reportTime);
            if (timeBand === '2200' || timeBand === '0600') {
                warnings += '<div class="fdp-warning">Early/Night duty - Check consecutive duty limits (max 3)</div>';
            }

            document.getElementById('fdp-warnings').innerHTML = warnings;

            // Live tracker
            updateLiveTracker(maxFDP);
            calculateSectorTurnarounds();
            estimateDutyEnd();
        }

        function updateLiveTracker(maxFDP) {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            document.getElementById('fdp-utc-time').textContent = utcTime;

            const offset = getLocalOffset();
            const localDate = new Date(now.getTime() + offset * 60 * 60 * 1000);
            const localTime = localDate.toISOString().substring(11, 19);
            document.getElementById('fdp-local-time').textContent = localTime;

            const actualReport = document.getElementById('fdp-actual-report').value;
            const actualBtn = document.getElementById('fdp-actual-report-btn');
            actualBtn.textContent = actualReport ? actualReport.padStart(4, '0') : '----';

            if (!actualReport) {
                document.getElementById('fdp-elapsed').textContent = '--:--';
                document.getElementById('fdp-remaining').textContent = '--:--';
                document.getElementById('fdp-into-discretion').textContent = '--:--';
                return;
            }

            // Convert actual report from local to UTC for calculations
            const reportUTC = localToUTC(actualReport);
            const report = parseTime(reportUTC);
            if (!report) return;

            const reportMins = report.hours * 60 + report.minutes;
            const nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            let elapsedMins = nowMins - reportMins;
            if (elapsedMins < -60) elapsedMins += 24 * 60;

            const maxFDPMins = maxFDP * 60;
            const remainingMins = maxFDPMins - elapsedMins;
            const intoDiscretionMins = elapsedMins - maxFDPMins;

            document.getElementById('fdp-elapsed').textContent = formatMinutes(Math.max(0, Math.floor(elapsedMins)));

            const remainingEl = document.getElementById('fdp-remaining');
            if (remainingMins > 0) {
                remainingEl.textContent = formatMinutes(Math.floor(remainingMins));
                remainingEl.className = 'fdp-result-value ' + (remainingMins > 60 ? 'green' : remainingMins > 30 ? 'yellow' : 'red');
            } else {
                remainingEl.textContent = '00:00';
                remainingEl.className = 'fdp-result-value red';
            }

            const discretionEl = document.getElementById('fdp-into-discretion');
            if (intoDiscretionMins > 0) {
                discretionEl.textContent = '+' + formatMinutes(Math.floor(intoDiscretionMins));
                discretionEl.className = 'fdp-result-value ' + (intoDiscretionMins > 120 ? 'red' : 'orange');
            } else {
                discretionEl.textContent = '--:--';
                discretionEl.className = 'fdp-result-value';
            }
        }

        // ============ TIMER FUNCTIONS ============
        function formatTime(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const prefix = ms < 0 ? '-' : '';
            return `${prefix}${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getColorClass(timer) {
            if (timer.type === 'stopwatch') return 'color-neutral';
            if (timer.remaining <= 0) return 'color-expired';
            const percent = (timer.remaining / timer.initialTime) * 100;
            if (percent > 50) return 'color-green';
            if (percent > 25) return 'color-yellow';
            if (percent > 10) return 'color-orange';
            return 'color-red';
        }

        function getProgress(timer) {
            if (timer.type === 'stopwatch') return ((timer.elapsed % 60000) / 60000) * 100;
            if (timer.initialTime === 0) return 0;
            return Math.max(0, (timer.remaining / timer.initialTime) * 100);
        }

        function flashTimer(index, count = 5) {
            const card = document.getElementById(`timer-${index}`);
            if (!card || count <= 0) return;
            card.classList.add('flashing');
            setTimeout(() => {
                card.classList.remove('flashing');
                setTimeout(() => flashTimer(index, count - 1), 150);
            }, 300);
        }

        function createTimerHTML(timer, index) {
            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;
            const isRunning = timer.running;
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            return `
                <div class="timer-card ${colorClass}" id="timer-${index}">
                    <div class="clock-container">
                        <div class="clock-face" style="--progress: ${progress}%">
                            <div class="clock-inner">
                                <span class="clock-time">${formatTime(displayTime)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timer-content">
                        <input type="text" class="timer-name-input" value="${timer.name}"
                               onchange="updateTimerName(${index}, this.value)">
                        <div class="timer-type-toggle">
                            <button class="type-btn ${timer.type === 'countdown' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'countdown')">Countdown</button>
                            <button class="type-btn ${timer.type === 'stopwatch' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'stopwatch')">Stopwatch</button>
                        </div>
                        ${timer.type === 'countdown' ? `
                        <div class="timer-time-setup">
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'hours')" ${isRunning ? 'disabled' : ''}>${hours}</button>
                            <span class="time-separator">h</span>
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'minutes')" ${isRunning ? 'disabled' : ''}>${minutes}</button>
                            <span class="time-separator">m</span>
                        </div>
                        ` : ''}
                        <div class="timer-display">${formatTime(displayTime)}</div>
                        <div class="timer-buttons">
                            <button class="timer-btn ${isRunning ? 'btn-pause' : 'btn-start'}"
                                    onclick="toggleTimer(${index})">
                                ${isRunning ? 'Pause' : 'Start'}
                            </button>
                            <button class="timer-btn btn-reset" onclick="resetTimer(${index})">Reset</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimers() {
            document.getElementById('timers-container').innerHTML = timers.map((timer, index) => createTimerHTML(timer, index)).join('');
            updateActiveTimersStrip();
        }

        function updateTimerDisplay(index) {
            const timer = timers[index];
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                const isFlashing = card.classList.contains('flashing');
                card.className = `timer-card ${colorClass}${isFlashing ? ' flashing' : ''}`;
                card.querySelector('.clock-face').style.setProperty('--progress', `${progress}%`);
                card.querySelector('.clock-time').textContent = formatTime(displayTime);
                card.querySelector('.timer-display').textContent = formatTime(displayTime);
            }

            // Also update strip display
            updateStripTimerDisplay(index);
        }

        let lastFrameTime = 0;
        function tick(currentTime) {
            if (lastFrameTime === 0) lastFrameTime = currentTime;
            const delta = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            let anyRunning = false;
            timers.forEach((timer, index) => {
                if (timer.running) {
                    anyRunning = true;
                    const now = Date.now();
                    const elapsed = now - timer.lastUpdate;
                    timer.lastUpdate = now;

                    if (timer.type === 'countdown') {
                        const wasPositive = timer.remaining > 0;
                        timer.remaining = Math.max(0, timer.remaining - elapsed);
                        if (wasPositive && timer.remaining === 0) {
                            timer.running = false;
                            flashTimer(index, 5);
                            renderTimers();
                            return;
                        }
                    } else {
                        timer.elapsed += elapsed;
                    }
                    updateTimerDisplay(index);
                }
            });

            if (Math.floor(currentTime / 5000) !== Math.floor((currentTime - delta) / 5000)) {
                saveState();
            }

            if (anyRunning) {
                animationFrameId = requestAnimationFrame(tick);
            } else {
                animationFrameId = null;
                lastFrameTime = 0;
            }
        }

        function startAnimationLoop() {
            if (animationFrameId === null && timers.some(t => t.running)) {
                lastFrameTime = 0;
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        function openTimerPicker(index, unit) {
            const timer = timers[index];
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') {
                openPicker('Set Hours', 'h', hours, 2, false, (val) => updateTimerTime(index, 'hours', parseInt(val, 10) || 0));
            } else {
                openPicker('Set Minutes', 'm', minutes, 2, false, (val) => updateTimerTime(index, 'minutes', Math.min(59, parseInt(val, 10) || 0)));
            }
        }

        function toggleTimer(index) {
            const timer = timers[index];
            if (timer.running) {
                timer.running = false;
            } else {
                if (timer.type === 'countdown' && timer.remaining === 0) {
                    timer.remaining = timer.initialTime;
                }
                timer.running = true;
                timer.lastUpdate = Date.now();
                startAnimationLoop();
            }
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function resetTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.remaining = timer.type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function setTimerType(index, type) {
            const timer = timers[index];
            timer.type = type;
            timer.running = false;
            timer.remaining = type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function updateTimerName(index, name) {
            timers[index].name = name;
            saveState();
        }

        function updateTimerTime(index, unit, value) {
            const timer = timers[index];
            let hours = Math.floor(timer.initialTime / 3600000);
            let minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') hours = value;
            if (unit === 'minutes') minutes = Math.min(59, value);

            timer.initialTime = (hours * 3600 + minutes * 60) * 1000;
            timer.remaining = timer.initialTime;
            timer.hours = hours;
            timer.minutes = minutes;

            saveState();
            renderTimers();
        }

        // ============ CLEAR HANDLERS ============
        document.getElementById('oooi-clear').addEventListener('click', () => {
            ['out', 'off', 'on', 'in'].forEach(field => {
                document.getElementById('oooi-' + field).value = '';
                const btn = document.getElementById('oooi-' + field + '-btn');
                btn.textContent = '0000';
                btn.classList.add('placeholder');
            });
            document.getElementById('block-time').textContent = '--:--';
            document.getElementById('flight-time').textContent = '--:--';
            localStorage.removeItem('flightOOOI');
        });

        document.getElementById('eta-clear').addEventListener('click', () => {
            document.getElementById('eta-time').value = '';
            document.getElementById('utc-manual').value = '';
            document.getElementById('eta-time-btn').textContent = '0000';
            document.getElementById('eta-time-btn').classList.add('placeholder');
            document.getElementById('utc-manual-btn').textContent = 'AUTO';
            document.getElementById('utc-manual-btn').classList.add('placeholder');
            document.getElementById('eta-countdown').textContent = '--:--:--';
            document.getElementById('eta-countdown').className = 'eta-countdown';
            etaManualStartTime = null;
            localStorage.removeItem('flightETA');
        });

        document.getElementById('calc-clear').addEventListener('click', () => {
            ['zfw', 'fob', 'taxi'].forEach(field => {
                document.getElementById('calc-' + field).value = '';
                const btn = document.getElementById('calc-' + field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('tow-result').textContent = '---';
            document.getElementById('tow-result').style.color = '#FF8200';
            document.getElementById('taxi-wt-result').textContent = '---';
            document.getElementById('taxi-wt-result').style.color = '#00ff88';
            document.getElementById('zfw-display').textContent = '---';
            document.getElementById('zfw-display').style.color = '#7ec8e3';
            document.getElementById('tow-warnings').innerHTML = '';
            document.getElementById('mlf-result').textContent = '---';
            localStorage.removeItem('flightTOW');
        });

        document.getElementById('acc-clear').addEventListener('click', () => {
            ['opt-acc', 'airfield-elev'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('acc-result').textContent = '--- ft';
            localStorage.removeItem('flightACC');
        });

        document.getElementById('rw12r-btn').addEventListener('click', () => {
            document.getElementById('airfield-elev').value = '62';
            document.getElementById('airfield-elev-btn').textContent = '62';
            document.getElementById('airfield-elev-btn').classList.remove('placeholder');
            calculateACC();
        });

        // ============ FUEL CLEAR HANDLER ============
        document.getElementById('fuel-clear').addEventListener('click', () => {
            ['fuel-req', 'fuel-pre', 'fuel-actual'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('fuel-sg').value = '800';
            document.getElementById('fuel-sg-btn').textContent = '0.800';
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            document.getElementById('fuel-adj').value = '';
            document.getElementById('fuel-adj-btn').textContent = '0';
            calculateFuel();
            localStorage.removeItem('flightFuel');
        });

        // ============ CONVERTER CLEAR HANDLER ============
        document.getElementById('conv-clear').addEventListener('click', () => {
            ['conv-litres', 'conv-gallons', 'conv-lbs'].forEach(field => {
                document.getElementById(field).value = '';
                document.getElementById(field + '-btn').textContent = '0';
            });
        });

        // ============ LAYOVER CLEAR HANDLER ============
        document.getElementById('layover-clear').addEventListener('click', () => {
            document.getElementById('layover-std').value = '';
            document.getElementById('layover-std-btn').textContent = '----';
            document.getElementById('layover-pickup').value = '0130';
            document.getElementById('layover-pickup-btn').textContent = '0130';
            document.getElementById('layover-offset').value = '0';
            calculateLayover();
            localStorage.removeItem('flightLayover');
        });

        // ============ INITIALIZE ============
        loadState();
        loadOOOI();
        loadETA();
        loadTOW();
        loadACC();
        loadFuel();
        loadLayover();
        renderTimers();
        updateSectorInputs();
        updateLimitDisplays();
        calculateFDP();
        calculateTOW();
        calculateMLF();
        calculateFuel();
        calculateLayover();
        startAnimationLoop();

        setInterval(() => {
            updateUTCClock();
            calculateETA();
            if (document.getElementById('tab-fdp').classList.contains('active')) {
                const maxFDP = getMaxFDP(
                    document.getElementById('fdp-crew-type').value,
                    document.getElementById('fdp-acclimatized').value,
                    document.getElementById('fdp-rest').value,
                    document.getElementById('fdp-report').value || '0600',
                    parseInt(document.getElementById('fdp-sectors').value, 10)
                );
                updateLiveTracker(maxFDP);
            }
        }, 1000);

        updateUTCClock();
        updateActiveTimersStrip();

        window.addEventListener('beforeunload', saveState);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const now = Date.now();
                timers.forEach((timer, index) => {
                    if (timer.running && timer.lastUpdate) {
                        const elapsed = now - timer.lastUpdate;
                        if (timer.type === 'countdown') {
                            const wasPositive = timer.remaining > 0;
                            timer.remaining = Math.max(0, timer.remaining - elapsed);
                            if (wasPositive && timer.remaining === 0) {
                                timer.running = false;
                                flashTimer(index, 5);
                            }
                        } else {
                            timer.elapsed += elapsed;
                        }
                        timer.lastUpdate = now;
                        updateTimerDisplay(index);
                    }
                });
                renderTimers();
                startAnimationLoop();
            }
        });
    </script>
</body>
</html>
