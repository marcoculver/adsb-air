<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flight Ops</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Top sections grid */
        .top-sections {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .top-sections {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 700px) {
            .top-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Section styling */
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1rem;
            color: #00d4ff;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        /* Input grids */
        .input-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-label {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Clickable input buttons */
        .input-btn {
            width: 100%;
            max-width: 90px;
            padding: 10px 6px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .input-btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .input-btn.placeholder {
            color: rgba(0, 255, 136, 0.3);
        }

        .input-btn-with-unit {
            position: relative;
        }

        .input-btn-unit {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #888;
            pointer-events: none;
        }

        .results-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 2px;
        }

        .result-value {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .block-time { color: #ffd700; }
        .flight-time { color: #00ff88; }
        .tow-value { color: #ff9f43; }
        .eta-value { color: #00d4ff; }
        .acc-value { color: #a29bfe; }

        .clear-btn {
            display: block;
            margin: 10px auto 0;
            padding: 5px 14px;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 6px;
            color: #ff6b6b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .preset-btn {
            display: block;
            margin: 8px auto 0;
            padding: 6px 12px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 6px;
            color: #00d4ff;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        /* ETA Section */
        .eta-countdown {
            font-size: 1.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            margin: 10px 0;
        }

        .eta-countdown.warning {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .eta-countdown.critical {
            color: #ff5252;
            text-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
        }

        .utc-display {
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        /* Timers Grid */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .timer-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            transition: background-color 0.15s, box-shadow 0.15s;
        }

        .timer-card.flashing {
            animation: flashRed 0.3s ease-in-out;
        }

        @keyframes flashRed {
            0%, 100% { background: rgba(255, 255, 255, 0.05); box-shadow: none; }
            50% { background: rgba(255, 0, 0, 0.4); box-shadow: 0 0 30px rgba(255, 0, 0, 0.6); }
        }

        /* Clock Face */
        .clock-container {
            flex-shrink: 0;
        }

        .clock-face {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--clock-color, #333) var(--progress, 0%), #222 var(--progress, 0%));
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .clock-inner {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clock-time {
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px currentColor;
        }

        /* Timer Controls */
        .timer-content {
            flex: 1;
            min-width: 0;
        }

        .timer-name-input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            margin-bottom: 8px;
        }

        .timer-name-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .timer-type-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
        }

        .timer-time-setup {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .time-input-btn {
            width: 55px;
            height: 40px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-input-btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .time-separator {
            display: flex;
            align-items: center;
            color: #666;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 0 20px currentColor;
            color: var(--timer-color, #00ff88);
        }

        .timer-buttons {
            display: flex;
            gap: 6px;
        }

        .timer-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-start {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
        }

        /* Number Picker Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .number-picker {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .picker-title {
            text-align: center;
            font-size: 1.1rem;
            color: #00d4ff;
            margin-bottom: 20px;
        }

        .picker-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .picker-value {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            min-width: 120px;
            text-align: center;
        }

        .picker-unit {
            font-size: 1.2rem;
            color: #888;
        }

        .picker-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .picker-btn {
            padding: 15px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: bold;
            transition: all 0.2s;
        }

        .picker-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .picker-btn:active {
            transform: scale(0.95);
        }

        .picker-btn.clear {
            background: rgba(255, 100, 100, 0.3);
        }

        .picker-actions {
            display: flex;
            gap: 10px;
        }

        .picker-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .picker-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .picker-confirm {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        /* Color states for countdown */
        .color-green { --clock-color: #00c853; --timer-color: #00ff88; }
        .color-yellow { --clock-color: #ffc107; --timer-color: #ffd54f; }
        .color-orange { --clock-color: #ff9800; --timer-color: #ffab40; }
        .color-red { --clock-color: #f44336; --timer-color: #ff5252; }
        .color-expired { --clock-color: #b71c1c; --timer-color: #ff1744; }
        .color-neutral { --clock-color: #00d4ff; --timer-color: #00d4ff; }

        /* FDP Calculator Styles */
        .fdp-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .fdp-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fdp-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .fdp-field {
            display: flex;
            flex-direction: column;
        }

        .fdp-label {
            font-size: 0.8rem;
            color: #7ec8e3;
            margin-bottom: 5px;
        }

        .fdp-select, .fdp-input {
            padding: 10px;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .fdp-select {
            cursor: pointer;
        }

        .fdp-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .fdp-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .fdp-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .fdp-result-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .fdp-result-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .fdp-result-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .fdp-result-value.green { color: #00ff88; }
        .fdp-result-value.yellow { color: #ffd700; }
        .fdp-result-value.orange { color: #ff9f43; }
        .fdp-result-value.red { color: #ff5252; }

        .fdp-warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #ffab40;
            font-size: 0.9rem;
        }

        .fdp-danger {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #ff5252;
            font-size: 0.9rem;
        }

        .sector-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 800px) {
            .sector-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sector-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .sector-title {
            font-size: 0.85rem;
            color: #00d4ff;
            margin-bottom: 10px;
            text-align: center;
        }

        .sector-field {
            margin-bottom: 8px;
        }

        .sector-field label {
            font-size: 0.7rem;
            color: #888;
            display: block;
            margin-bottom: 3px;
        }

        /* iPad specific */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .timer-card {
                flex-direction: column;
                text-align: center;
            }

            .timer-display {
                font-size: 1.6rem;
            }

            .tab-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        button {
            -webkit-user-select: none;
            user-select: none;
        }

        .timer-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tools')">Tools</button>
            <button class="tab-btn" onclick="switchTab('fdp')">FDP Calculator</button>
        </div>

        <!-- Tools Tab -->
        <div class="tab-content active" id="tab-tools">
            <div class="top-sections">
                <!-- OOOI Section -->
                <div class="section">
                    <div class="section-title">OOOI</div>
                    <div class="input-grid-4">
                        <div class="input-group">
                            <label class="input-label">OUT</label>
                            <button class="input-btn placeholder" id="oooi-out-btn" onclick="openTimePicker('oooi-out')">0000</button>
                            <input type="hidden" id="oooi-out" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">OFF</label>
                            <button class="input-btn placeholder" id="oooi-off-btn" onclick="openTimePicker('oooi-off')">0000</button>
                            <input type="hidden" id="oooi-off" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ON</label>
                            <button class="input-btn placeholder" id="oooi-on-btn" onclick="openTimePicker('oooi-on')">0000</button>
                            <input type="hidden" id="oooi-on" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">IN</label>
                            <button class="input-btn placeholder" id="oooi-in-btn" onclick="openTimePicker('oooi-in')">0000</button>
                            <input type="hidden" id="oooi-in" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">BLOCK</div>
                            <div class="result-value block-time" id="block-time">--:--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">FLIGHT</div>
                            <div class="result-value flight-time" id="flight-time">--:--</div>
                        </div>
                    </div>
                    <button class="clear-btn" id="oooi-clear">Clear</button>
                </div>

                <!-- ETA Section -->
                <div class="section">
                    <div class="section-title">ETA Countdown</div>
                    <div class="utc-display">UTC: <span id="utc-clock">--:--:--</span></div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">ETA (UTC)</label>
                            <button class="input-btn placeholder" id="eta-time-btn" onclick="openTimePicker('eta-time')">0000</button>
                            <input type="hidden" id="eta-time" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">UTC NOW</label>
                            <button class="input-btn placeholder" id="utc-manual-btn" onclick="openTimePicker('utc-manual')">AUTO</button>
                            <input type="hidden" id="utc-manual" value="">
                        </div>
                    </div>
                    <div class="eta-countdown" id="eta-countdown">--:--:--</div>
                    <button class="clear-btn" id="eta-clear">Clear</button>
                </div>

                <!-- TOW Calculator -->
                <div class="section">
                    <div class="section-title">TOW Calculator</div>
                    <div class="input-grid-3">
                        <div class="input-group">
                            <label class="input-label">ZFW</label>
                            <button class="input-btn placeholder" id="calc-zfw-btn" onclick="openWeightPicker('calc-zfw', 'ZFW')">0</button>
                            <input type="hidden" id="calc-zfw" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">FOB</label>
                            <button class="input-btn placeholder" id="calc-fob-btn" onclick="openWeightPicker('calc-fob', 'FOB')">0</button>
                            <input type="hidden" id="calc-fob" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">TAXI</label>
                            <button class="input-btn placeholder" id="calc-taxi-btn" onclick="openWeightPicker('calc-taxi', 'Taxi Fuel')">0</button>
                            <input type="hidden" id="calc-taxi" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">TAKE OFF WEIGHT</div>
                            <div class="result-value tow-value" id="tow-result">---</div>
                        </div>
                    </div>
                    <button class="clear-btn" id="calc-clear">Clear</button>
                </div>

                <!-- OPT ACC Calculator -->
                <div class="section">
                    <div class="section-title">Acceleration Height</div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">OPT ACC</label>
                            <div class="input-btn-with-unit">
                                <button class="input-btn placeholder" id="opt-acc-btn" onclick="openWeightPicker('opt-acc', 'OPT ACC', 'ft')">0</button>
                                <span class="input-btn-unit">ft</span>
                            </div>
                            <input type="hidden" id="opt-acc" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ELEV</label>
                            <div class="input-btn-with-unit">
                                <button class="input-btn placeholder" id="airfield-elev-btn" onclick="openWeightPicker('airfield-elev', 'Elevation', 'ft')">0</button>
                                <span class="input-btn-unit">ft</span>
                            </div>
                            <input type="hidden" id="airfield-elev" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">ACC HEIGHT AGL</div>
                            <div class="result-value acc-value" id="acc-result">--- ft</div>
                        </div>
                    </div>
                    <button class="preset-btn" id="rw12r-btn">RW12R (62 ft)</button>
                    <button class="clear-btn" id="acc-clear">Clear</button>
                </div>
            </div>

            <!-- Timers -->
            <div class="timers-grid" id="timers-container"></div>
        </div>

        <!-- FDP Calculator Tab -->
        <div class="tab-content" id="tab-fdp">
            <div class="fdp-container">
                <div class="fdp-section">
                    <div class="section-title">Duty Setup</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Crew Type</label>
                            <select class="fdp-select" id="fdp-crew-type" onchange="calculateFDP()">
                                <option value="flight">Flight Crew</option>
                                <option value="cabin">Cabin Crew</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Acclimatization</label>
                            <select class="fdp-select" id="fdp-acclimatized" onchange="calculateFDP()">
                                <option value="yes">Acclimatized</option>
                                <option value="no">Not Acclimatized</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Preceding Rest</label>
                            <select class="fdp-select" id="fdp-rest" onchange="calculateFDP()">
                                <option value="normal">Up to 18h or over 30h</option>
                                <option value="reduced">Between 18-30h</option>
                            </select>
                        </div>
                    </div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Report Time (Local)</label>
                            <button class="input-btn" id="fdp-report-btn" onclick="openTimePicker('fdp-report')" style="max-width:100%">0600</button>
                            <input type="hidden" id="fdp-report" value="0600">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Number of Sectors</label>
                            <select class="fdp-select" id="fdp-sectors" onchange="updateSectorInputs(); calculateFDP()">
                                <option value="1">1 Sector</option>
                                <option value="2">2 Sectors</option>
                                <option value="3">3 Sectors</option>
                                <option value="4">4 Sectors</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Sector Details (Optional)</div>
                    <div class="sector-inputs" id="sector-inputs">
                        <!-- Dynamically filled -->
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">FDP Results</div>
                    <div class="fdp-results">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max FDP</div>
                                <div class="fdp-result-value green" id="fdp-max">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest On-Chocks</div>
                                <div class="fdp-result-value green" id="fdp-chocks">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest Off-Duty</div>
                                <div class="fdp-result-value green" id="fdp-offduty">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max Discretion</div>
                                <div class="fdp-result-value yellow" id="fdp-discretion">+3:00</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Absolute Limit</div>
                                <div class="fdp-result-value orange" id="fdp-absolute">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Min Rest After</div>
                                <div class="fdp-result-value" id="fdp-rest-after">12:00</div>
                            </div>
                        </div>
                        <div id="fdp-warnings"></div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Live Duty Tracker</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Report (Local)</label>
                            <button class="input-btn" id="fdp-actual-report-btn" onclick="openTimePicker('fdp-actual-report')" style="max-width:100%">----</button>
                            <input type="hidden" id="fdp-actual-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current Local Time</label>
                            <div class="fdp-result-value" id="fdp-local-time" style="padding-top:10px">--:--:--</div>
                        </div>
                    </div>
                    <div class="fdp-result-grid" style="margin-top:15px">
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Elapsed</div>
                            <div class="fdp-result-value" id="fdp-elapsed">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Remaining</div>
                            <div class="fdp-result-value green" id="fdp-remaining">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">Into Discretion</div>
                            <div class="fdp-result-value" id="fdp-into-discretion">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Number Picker Modal -->
    <div class="modal-overlay" id="number-picker-modal">
        <div class="number-picker">
            <div class="picker-title" id="picker-title">Set Value</div>
            <div class="picker-display">
                <span class="picker-value" id="picker-value">0</span>
                <span class="picker-unit" id="picker-unit"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="pickerAppend('1')">1</button>
                <button class="picker-btn" onclick="pickerAppend('2')">2</button>
                <button class="picker-btn" onclick="pickerAppend('3')">3</button>
                <button class="picker-btn" onclick="pickerAppend('4')">4</button>
                <button class="picker-btn" onclick="pickerAppend('5')">5</button>
                <button class="picker-btn" onclick="pickerAppend('6')">6</button>
                <button class="picker-btn" onclick="pickerAppend('7')">7</button>
                <button class="picker-btn" onclick="pickerAppend('8')">8</button>
                <button class="picker-btn" onclick="pickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="pickerClear()">C</button>
                <button class="picker-btn" onclick="pickerAppend('0')">0</button>
                <button class="picker-btn" onclick="pickerBackspace()">&larr;</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closePicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmPicker()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============ TAB SWITCHING ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // ============ NUMBER PICKER ============
        let pickerCallback = null;
        let pickerValue = '';
        let pickerMaxLength = 6;
        let pickerFormatCommas = false;

        function openPicker(title, unit, currentValue, maxLength, formatCommas, callback) {
            pickerCallback = callback;
            pickerValue = currentValue.toString().replace(/,/g, '');
            pickerMaxLength = maxLength;
            pickerFormatCommas = formatCommas;
            document.getElementById('picker-title').textContent = title;
            document.getElementById('picker-unit').textContent = unit || '';
            updatePickerDisplay();
            document.getElementById('number-picker-modal').classList.add('active');
        }

        function updatePickerDisplay() {
            let display = pickerValue || '0';
            if (pickerFormatCommas && display !== '0') {
                display = parseInt(display, 10).toLocaleString();
            }
            document.getElementById('picker-value').textContent = display;
        }

        function closePicker() {
            document.getElementById('number-picker-modal').classList.remove('active');
            pickerCallback = null;
        }

        function pickerAppend(digit) {
            if (pickerValue.length < pickerMaxLength) {
                pickerValue += digit;
                updatePickerDisplay();
            }
        }

        function pickerClear() {
            pickerValue = '';
            updatePickerDisplay();
        }

        function pickerBackspace() {
            pickerValue = pickerValue.slice(0, -1);
            updatePickerDisplay();
        }

        function confirmPicker() {
            if (pickerCallback) {
                pickerCallback(pickerValue);
            }
            closePicker();
        }

        // Time picker (HHMM format)
        function openTimePicker(fieldId) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker('Enter Time (HHMM)', '', currentVal, 4, false, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? val.padStart(4, '0') : (fieldId === 'utc-manual' ? 'AUTO' : '0000');
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('oooi-')) calculateOOOI();
                else if (fieldId === 'eta-time') { etaManualStartTime = null; calculateETA(); }
                else if (fieldId === 'utc-manual') { etaManualStartTime = val ? Date.now() : null; saveETA(); calculateETA(); }
                else if (fieldId === 'fdp-report' || fieldId === 'fdp-actual-report') calculateFDP();
            });
        }

        // Weight picker (with commas)
        function openWeightPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('calc-')) calculateTOW();
                else if (fieldId === 'opt-acc' || fieldId === 'airfield-elev') calculateACC();
            });
        }

        // ============ DEFAULT TIMERS ============
        const defaultTimers = [
            { name: 'APU', type: 'countdown', hours: 0, minutes: 11 },
            { name: 'APU Start', type: 'countdown', hours: 3, minutes: 0 },
            { name: 'Timer 3', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 4', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 5', type: 'stopwatch', hours: 0, minutes: 0 }
        ];

        let timers = [];
        let animationFrameId = null;
        let etaManualStartTime = null;

        // ============ TIMER STATE ============
        function loadState() {
            const saved = localStorage.getItem('flightTimers');
            if (saved) {
                try {
                    timers = JSON.parse(saved);
                    const now = Date.now();
                    timers.forEach((timer) => {
                        if (timer.running && timer.lastUpdate) {
                            const elapsed = now - timer.lastUpdate;
                            if (timer.type === 'countdown') {
                                timer.remaining = Math.max(0, timer.remaining - elapsed);
                            } else {
                                timer.elapsed = (timer.elapsed || 0) + elapsed;
                            }
                        }
                        if (timer.running) {
                            timer.lastUpdate = now;
                        }
                    });
                } catch (e) {
                    timers = JSON.parse(JSON.stringify(defaultTimers));
                }
            } else {
                timers = JSON.parse(JSON.stringify(defaultTimers));
            }

            timers.forEach((timer) => {
                if (timer.remaining === undefined) {
                    timer.remaining = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
                if (timer.elapsed === undefined) {
                    timer.elapsed = 0;
                }
                if (timer.initialTime === undefined) {
                    timer.initialTime = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
            });
        }

        function saveState() {
            const now = Date.now();
            timers.forEach(timer => {
                if (timer.running) {
                    timer.lastUpdate = now;
                }
            });
            localStorage.setItem('flightTimers', JSON.stringify(timers));
        }

        // ============ OOOI ============
        function loadOOOI() {
            const saved = localStorage.getItem('flightOOOI');
            if (saved) {
                try {
                    const oooi = JSON.parse(saved);
                    ['out', 'off', 'on', 'in'].forEach(field => {
                        const val = oooi[field] || '';
                        document.getElementById('oooi-' + field).value = val;
                        const btn = document.getElementById('oooi-' + field + '-btn');
                        btn.textContent = val ? val.padStart(4, '0') : '0000';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateOOOI();
                } catch (e) {}
            }
        }

        function saveOOOI() {
            const oooi = {
                out: document.getElementById('oooi-out').value,
                off: document.getElementById('oooi-off').value,
                on: document.getElementById('oooi-on').value,
                in: document.getElementById('oooi-in').value
            };
            localStorage.setItem('flightOOOI', JSON.stringify(oooi));
        }

        function parseTime(str) {
            if (!str || str.length < 3) return null;
            str = str.padStart(4, '0');
            const hours = parseInt(str.substring(0, 2), 10);
            const minutes = parseInt(str.substring(2, 4), 10);
            if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return null;
            return { hours, minutes };
        }

        function timeDiff(start, end) {
            if (!start || !end) return null;
            let startMins = start.hours * 60 + start.minutes;
            let endMins = end.hours * 60 + end.minutes;
            if (endMins < startMins) {
                endMins += 24 * 60;
            }
            return endMins - startMins;
        }

        function formatMinutes(mins) {
            if (mins === null) return '--:--';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function calculateOOOI() {
            const out = parseTime(document.getElementById('oooi-out').value);
            const off = parseTime(document.getElementById('oooi-off').value);
            const on = parseTime(document.getElementById('oooi-on').value);
            const inn = parseTime(document.getElementById('oooi-in').value);

            document.getElementById('block-time').textContent = formatMinutes(timeDiff(out, inn));
            document.getElementById('flight-time').textContent = formatMinutes(timeDiff(off, on));
            saveOOOI();
        }

        // ============ ETA ============
        function loadETA() {
            const saved = localStorage.getItem('flightETA');
            if (saved) {
                try {
                    const eta = JSON.parse(saved);
                    document.getElementById('eta-time').value = eta.time || '';
                    document.getElementById('utc-manual').value = eta.manual || '';

                    const etaBtn = document.getElementById('eta-time-btn');
                    etaBtn.textContent = eta.time ? eta.time.padStart(4, '0') : '0000';
                    etaBtn.classList.toggle('placeholder', !eta.time);

                    const manualBtn = document.getElementById('utc-manual-btn');
                    manualBtn.textContent = eta.manual ? eta.manual.padStart(4, '0') : 'AUTO';
                    manualBtn.classList.toggle('placeholder', !eta.manual);

                    if (eta.manual && eta.manualStartTime) {
                        etaManualStartTime = eta.manualStartTime;
                    }
                } catch (e) {}
            }
        }

        function saveETA() {
            const eta = {
                time: document.getElementById('eta-time').value,
                manual: document.getElementById('utc-manual').value,
                manualStartTime: etaManualStartTime
            };
            localStorage.setItem('flightETA', JSON.stringify(eta));
        }

        function updateUTCClock() {
            const now = new Date();
            document.getElementById('utc-clock').textContent = now.toISOString().substring(11, 19);
        }

        function calculateETA() {
            const etaStr = document.getElementById('eta-time').value;
            const manualStr = document.getElementById('utc-manual').value;
            const etaDisplay = document.getElementById('eta-countdown');

            const eta = parseTime(etaStr);
            if (!eta) {
                etaDisplay.textContent = '--:--:--';
                etaDisplay.className = 'eta-countdown';
                return;
            }

            let nowMins, nowSecs = 0;

            if (manualStr && manualStr.length >= 3 && etaManualStartTime) {
                // Manual mode: countdown from when manual time was entered
                const manual = parseTime(manualStr);
                if (manual) {
                    const elapsedSinceEntry = (Date.now() - etaManualStartTime) / 1000;
                    const manualTotalSecs = manual.hours * 3600 + manual.minutes * 60;
                    const currentSimSecs = manualTotalSecs + elapsedSinceEntry;
                    nowMins = currentSimSecs / 60;
                    nowSecs = currentSimSecs % 60;
                } else {
                    const now = new Date();
                    nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
                }
            } else {
                const now = new Date();
                nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            }

            let etaMins = eta.hours * 60 + eta.minutes;
            if (etaMins < nowMins - 60) {
                etaMins += 24 * 60;
            }

            const diffMins = etaMins - nowMins;
            const diffSecs = Math.max(0, Math.floor(diffMins * 60));

            if (diffSecs <= 0) {
                etaDisplay.textContent = '00:00:00';
                etaDisplay.className = 'eta-countdown critical';
            } else {
                const h = Math.floor(diffSecs / 3600);
                const m = Math.floor((diffSecs % 3600) / 60);
                const s = diffSecs % 60;
                etaDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

                if (diffMins <= 10) {
                    etaDisplay.className = 'eta-countdown critical';
                } else if (diffMins <= 30) {
                    etaDisplay.className = 'eta-countdown warning';
                } else {
                    etaDisplay.className = 'eta-countdown';
                }
            }
        }

        // ============ TOW ============
        function loadTOW() {
            const saved = localStorage.getItem('flightTOW');
            if (saved) {
                try {
                    const tow = JSON.parse(saved);
                    ['zfw', 'fob', 'taxi'].forEach(field => {
                        const val = tow[field] || '';
                        document.getElementById('calc-' + field).value = val;
                        const btn = document.getElementById('calc-' + field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateTOW();
                } catch (e) {}
            }
        }

        function saveTOW() {
            const tow = {
                zfw: document.getElementById('calc-zfw').value,
                fob: document.getElementById('calc-fob').value,
                taxi: document.getElementById('calc-taxi').value
            };
            localStorage.setItem('flightTOW', JSON.stringify(tow));
        }

        function calculateTOW() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const fob = parseInt(document.getElementById('calc-fob').value, 10) || 0;
            const taxi = parseInt(document.getElementById('calc-taxi').value, 10) || 0;

            if (zfw === 0 && fob === 0) {
                document.getElementById('tow-result').textContent = '---';
            } else {
                const tow = zfw + fob - taxi;
                document.getElementById('tow-result').textContent = tow.toLocaleString();
            }
            saveTOW();
        }

        // ============ ACC HEIGHT ============
        function loadACC() {
            const saved = localStorage.getItem('flightACC');
            if (saved) {
                try {
                    const acc = JSON.parse(saved);
                    ['opt-acc', 'airfield-elev'].forEach(field => {
                        const key = field === 'opt-acc' ? 'optAcc' : 'elev';
                        const val = acc[key] || '';
                        document.getElementById(field).value = val;
                        const btn = document.getElementById(field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateACC();
                } catch (e) {}
            }
        }

        function saveACC() {
            const acc = {
                optAcc: document.getElementById('opt-acc').value,
                elev: document.getElementById('airfield-elev').value
            };
            localStorage.setItem('flightACC', JSON.stringify(acc));
        }

        function calculateACC() {
            const optAcc = parseInt(document.getElementById('opt-acc').value, 10) || 0;
            const elev = parseInt(document.getElementById('airfield-elev').value, 10) || 0;

            if (optAcc === 0) {
                document.getElementById('acc-result').textContent = '--- ft';
            } else {
                const result = optAcc - elev;
                document.getElementById('acc-result').textContent = result.toLocaleString() + ' ft';
            }
            saveACC();
        }

        // ============ FDP CALCULATOR ============
        const fdpTableFlightAcclimatized = {
            '0600': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '0800': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 9.5],
            '1300': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '1800': [12, 11.25, 10.5, 9.75, 9, 9, 9, 9],
            '2200': [11, 10.25, 9.5, 9, 9, 9, 9, 9]
        };

        const fdpTableCabinAcclimatized = {
            '0600': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '0800': [15, 14.25, 13.5, 12.75, 12, 11.5, 11, 10.5],
            '1300': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '1800': [13, 12.25, 11.5, 10.75, 10, 10, 10, 10],
            '2200': [12, 11.25, 10.5, 10, 10, 10, 10, 10]
        };

        const fdpTableFlightUnacclimatized = {
            'normal': [13, 12.25, 11.5, 10.75, 10, 9.25, 9],
            'reduced': [11.5, 11, 10.5, 9.75, 9, 9, 9]
        };

        const fdpTableCabinUnacclimatized = {
            'normal': [14, 13.25, 12.5, 11.75, 11, 10.25, 10],
            'reduced': [12.5, 12, 11.5, 10.75, 10, 10, 10]
        };

        function getTimeBand(reportTime) {
            const time = parseTime(reportTime);
            if (!time) return '0800';
            const mins = time.hours * 60 + time.minutes;

            if (mins >= 360 && mins < 480) return '0600';      // 0600-0759
            if (mins >= 480 && mins < 780) return '0800';      // 0800-1259
            if (mins >= 780 && mins < 1080) return '1300';     // 1300-1759
            if (mins >= 1080 && mins < 1320) return '1800';    // 1800-2159
            return '2200';                                      // 2200-0559
        }

        function getMaxFDP(crewType, acclimatized, restType, reportTime, sectors) {
            const sectorIdx = Math.min(sectors - 1, 7);

            if (acclimatized === 'yes') {
                const timeBand = getTimeBand(reportTime);
                const table = crewType === 'flight' ? fdpTableFlightAcclimatized : fdpTableCabinAcclimatized;
                return table[timeBand][sectorIdx];
            } else {
                const table = crewType === 'flight' ? fdpTableFlightUnacclimatized : fdpTableCabinUnacclimatized;
                return table[restType][Math.min(sectorIdx, 6)];
            }
        }

        function formatHoursToHHMM(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function addTime(timeStr, hoursToAdd) {
            const time = parseTime(timeStr);
            if (!time) return '--:--';
            let totalMins = time.hours * 60 + time.minutes + Math.round(hoursToAdd * 60);
            totalMins = totalMins % (24 * 60);
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function updateSectorInputs() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);
            const container = document.getElementById('sector-inputs');
            let html = '';

            for (let i = 1; i <= sectors; i++) {
                html += `
                    <div class="sector-card">
                        <div class="sector-title">Sector ${i}</div>
                        <div class="sector-field">
                            <label>Block Time</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="sector-${i}-block-btn"
                                    onclick="openTimePicker('sector-${i}-block')">--:--</button>
                            <input type="hidden" id="sector-${i}-block" value="">
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function calculateFDP() {
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            // Update report button display
            const reportBtn = document.getElementById('fdp-report-btn');
            reportBtn.textContent = reportTime.padStart(4, '0');

            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;
            const absoluteLimit = maxFDP + maxDiscretion;
            const minRest = crewType === 'flight' ? 12 : 11;

            const latestChocks = addTime(reportTime, maxFDP);
            const latestOffDuty = addTime(reportTime, maxFDP + 0.5);
            const absoluteChocks = addTime(reportTime, absoluteLimit);

            document.getElementById('fdp-max').textContent = formatHoursToHHMM(maxFDP);
            document.getElementById('fdp-chocks').textContent = latestChocks.substring(0, 2) + ':' + latestChocks.substring(2);
            document.getElementById('fdp-offduty').textContent = latestOffDuty.substring(0, 2) + ':' + latestOffDuty.substring(2);
            document.getElementById('fdp-discretion').textContent = '+' + maxDiscretion + ':00';
            document.getElementById('fdp-absolute').textContent = absoluteChocks.substring(0, 2) + ':' + absoluteChocks.substring(2);
            document.getElementById('fdp-rest-after').textContent = minRest + ':00';

            // Warnings
            let warnings = '';
            if (acclimatized === 'no' && restType === 'reduced') {
                warnings += '<div class="fdp-warning">Reduced rest (18-30h) - Lower FDP limits apply</div>';
            }

            const timeBand = getTimeBand(reportTime);
            if (timeBand === '2200' || timeBand === '0600') {
                warnings += '<div class="fdp-warning">Early/Night duty - Check consecutive duty limits (max 3)</div>';
            }

            document.getElementById('fdp-warnings').innerHTML = warnings;

            // Live tracker
            updateLiveTracker(maxFDP);
        }

        function updateLiveTracker(maxFDP) {
            const now = new Date();
            const localTime = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('fdp-local-time').textContent = localTime;

            const actualReport = document.getElementById('fdp-actual-report').value;
            const actualBtn = document.getElementById('fdp-actual-report-btn');
            actualBtn.textContent = actualReport ? actualReport.padStart(4, '0') : '----';

            if (!actualReport) {
                document.getElementById('fdp-elapsed').textContent = '--:--';
                document.getElementById('fdp-remaining').textContent = '--:--';
                document.getElementById('fdp-into-discretion').textContent = '--:--';
                return;
            }

            const report = parseTime(actualReport);
            if (!report) return;

            const reportMins = report.hours * 60 + report.minutes;
            const nowMins = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
            let elapsedMins = nowMins - reportMins;
            if (elapsedMins < -60) elapsedMins += 24 * 60;

            const maxFDPMins = maxFDP * 60;
            const remainingMins = maxFDPMins - elapsedMins;
            const intoDiscretionMins = elapsedMins - maxFDPMins;

            document.getElementById('fdp-elapsed').textContent = formatMinutes(Math.max(0, Math.floor(elapsedMins)));

            const remainingEl = document.getElementById('fdp-remaining');
            if (remainingMins > 0) {
                remainingEl.textContent = formatMinutes(Math.floor(remainingMins));
                remainingEl.className = 'fdp-result-value ' + (remainingMins > 60 ? 'green' : remainingMins > 30 ? 'yellow' : 'red');
            } else {
                remainingEl.textContent = '00:00';
                remainingEl.className = 'fdp-result-value red';
            }

            const discretionEl = document.getElementById('fdp-into-discretion');
            if (intoDiscretionMins > 0) {
                discretionEl.textContent = '+' + formatMinutes(Math.floor(intoDiscretionMins));
                discretionEl.className = 'fdp-result-value ' + (intoDiscretionMins > 120 ? 'red' : 'orange');
            } else {
                discretionEl.textContent = '--:--';
                discretionEl.className = 'fdp-result-value';
            }
        }

        // ============ TIMER FUNCTIONS ============
        function formatTime(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const prefix = ms < 0 ? '-' : '';
            return `${prefix}${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getColorClass(timer) {
            if (timer.type === 'stopwatch') return 'color-neutral';
            if (timer.remaining <= 0) return 'color-expired';
            const percent = (timer.remaining / timer.initialTime) * 100;
            if (percent > 50) return 'color-green';
            if (percent > 25) return 'color-yellow';
            if (percent > 10) return 'color-orange';
            return 'color-red';
        }

        function getProgress(timer) {
            if (timer.type === 'stopwatch') return ((timer.elapsed % 60000) / 60000) * 100;
            if (timer.initialTime === 0) return 0;
            return Math.max(0, (timer.remaining / timer.initialTime) * 100);
        }

        function flashTimer(index, count = 5) {
            const card = document.getElementById(`timer-${index}`);
            if (!card || count <= 0) return;
            card.classList.add('flashing');
            setTimeout(() => {
                card.classList.remove('flashing');
                setTimeout(() => flashTimer(index, count - 1), 150);
            }, 300);
        }

        function createTimerHTML(timer, index) {
            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;
            const isRunning = timer.running;
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            return `
                <div class="timer-card ${colorClass}" id="timer-${index}">
                    <div class="clock-container">
                        <div class="clock-face" style="--progress: ${progress}%">
                            <div class="clock-inner">
                                <span class="clock-time">${formatTime(displayTime)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timer-content">
                        <input type="text" class="timer-name-input" value="${timer.name}"
                               onchange="updateTimerName(${index}, this.value)">
                        <div class="timer-type-toggle">
                            <button class="type-btn ${timer.type === 'countdown' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'countdown')">Countdown</button>
                            <button class="type-btn ${timer.type === 'stopwatch' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'stopwatch')">Stopwatch</button>
                        </div>
                        ${timer.type === 'countdown' ? `
                        <div class="timer-time-setup">
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'hours')" ${isRunning ? 'disabled' : ''}>${hours}</button>
                            <span class="time-separator">h</span>
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'minutes')" ${isRunning ? 'disabled' : ''}>${minutes}</button>
                            <span class="time-separator">m</span>
                        </div>
                        ` : ''}
                        <div class="timer-display">${formatTime(displayTime)}</div>
                        <div class="timer-buttons">
                            <button class="timer-btn ${isRunning ? 'btn-pause' : 'btn-start'}"
                                    onclick="toggleTimer(${index})">
                                ${isRunning ? 'Pause' : 'Start'}
                            </button>
                            <button class="timer-btn btn-reset" onclick="resetTimer(${index})">Reset</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimers() {
            document.getElementById('timers-container').innerHTML = timers.map((timer, index) => createTimerHTML(timer, index)).join('');
        }

        function updateTimerDisplay(index) {
            const timer = timers[index];
            const card = document.getElementById(`timer-${index}`);
            if (!card) return;

            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

            const isFlashing = card.classList.contains('flashing');
            card.className = `timer-card ${colorClass}${isFlashing ? ' flashing' : ''}`;
            card.querySelector('.clock-face').style.setProperty('--progress', `${progress}%`);
            card.querySelector('.clock-time').textContent = formatTime(displayTime);
            card.querySelector('.timer-display').textContent = formatTime(displayTime);
        }

        let lastFrameTime = 0;
        function tick(currentTime) {
            if (lastFrameTime === 0) lastFrameTime = currentTime;
            const delta = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            let anyRunning = false;
            timers.forEach((timer, index) => {
                if (timer.running) {
                    anyRunning = true;
                    const now = Date.now();
                    const elapsed = now - timer.lastUpdate;
                    timer.lastUpdate = now;

                    if (timer.type === 'countdown') {
                        const wasPositive = timer.remaining > 0;
                        timer.remaining = Math.max(0, timer.remaining - elapsed);
                        if (wasPositive && timer.remaining === 0) {
                            timer.running = false;
                            flashTimer(index, 5);
                            renderTimers();
                            return;
                        }
                    } else {
                        timer.elapsed += elapsed;
                    }
                    updateTimerDisplay(index);
                }
            });

            if (Math.floor(currentTime / 5000) !== Math.floor((currentTime - delta) / 5000)) {
                saveState();
            }

            if (anyRunning) {
                animationFrameId = requestAnimationFrame(tick);
            } else {
                animationFrameId = null;
                lastFrameTime = 0;
            }
        }

        function startAnimationLoop() {
            if (animationFrameId === null && timers.some(t => t.running)) {
                lastFrameTime = 0;
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        function openTimerPicker(index, unit) {
            const timer = timers[index];
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') {
                openPicker('Set Hours', 'h', hours, 2, false, (val) => updateTimerTime(index, 'hours', parseInt(val, 10) || 0));
            } else {
                openPicker('Set Minutes', 'm', minutes, 2, false, (val) => updateTimerTime(index, 'minutes', Math.min(59, parseInt(val, 10) || 0)));
            }
        }

        function toggleTimer(index) {
            const timer = timers[index];
            if (timer.running) {
                timer.running = false;
            } else {
                if (timer.type === 'countdown' && timer.remaining === 0) {
                    timer.remaining = timer.initialTime;
                }
                timer.running = true;
                timer.lastUpdate = Date.now();
                startAnimationLoop();
            }
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function resetTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.remaining = timer.type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function setTimerType(index, type) {
            const timer = timers[index];
            timer.type = type;
            timer.running = false;
            timer.remaining = type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function updateTimerName(index, name) {
            timers[index].name = name;
            saveState();
        }

        function updateTimerTime(index, unit, value) {
            const timer = timers[index];
            let hours = Math.floor(timer.initialTime / 3600000);
            let minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') hours = value;
            if (unit === 'minutes') minutes = Math.min(59, value);

            timer.initialTime = (hours * 3600 + minutes * 60) * 1000;
            timer.remaining = timer.initialTime;
            timer.hours = hours;
            timer.minutes = minutes;

            saveState();
            renderTimers();
        }

        // ============ CLEAR HANDLERS ============
        document.getElementById('oooi-clear').addEventListener('click', () => {
            ['out', 'off', 'on', 'in'].forEach(field => {
                document.getElementById('oooi-' + field).value = '';
                const btn = document.getElementById('oooi-' + field + '-btn');
                btn.textContent = '0000';
                btn.classList.add('placeholder');
            });
            document.getElementById('block-time').textContent = '--:--';
            document.getElementById('flight-time').textContent = '--:--';
            localStorage.removeItem('flightOOOI');
        });

        document.getElementById('eta-clear').addEventListener('click', () => {
            document.getElementById('eta-time').value = '';
            document.getElementById('utc-manual').value = '';
            document.getElementById('eta-time-btn').textContent = '0000';
            document.getElementById('eta-time-btn').classList.add('placeholder');
            document.getElementById('utc-manual-btn').textContent = 'AUTO';
            document.getElementById('utc-manual-btn').classList.add('placeholder');
            document.getElementById('eta-countdown').textContent = '--:--:--';
            document.getElementById('eta-countdown').className = 'eta-countdown';
            etaManualStartTime = null;
            localStorage.removeItem('flightETA');
        });

        document.getElementById('calc-clear').addEventListener('click', () => {
            ['zfw', 'fob', 'taxi'].forEach(field => {
                document.getElementById('calc-' + field).value = '';
                const btn = document.getElementById('calc-' + field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('tow-result').textContent = '---';
            localStorage.removeItem('flightTOW');
        });

        document.getElementById('acc-clear').addEventListener('click', () => {
            ['opt-acc', 'airfield-elev'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('acc-result').textContent = '--- ft';
            localStorage.removeItem('flightACC');
        });

        document.getElementById('rw12r-btn').addEventListener('click', () => {
            document.getElementById('airfield-elev').value = '62';
            document.getElementById('airfield-elev-btn').textContent = '62';
            document.getElementById('airfield-elev-btn').classList.remove('placeholder');
            calculateACC();
        });

        // ============ INITIALIZE ============
        loadState();
        loadOOOI();
        loadETA();
        loadTOW();
        loadACC();
        renderTimers();
        updateSectorInputs();
        calculateFDP();
        startAnimationLoop();

        setInterval(() => {
            updateUTCClock();
            calculateETA();
            if (document.getElementById('tab-fdp').classList.contains('active')) {
                const maxFDP = getMaxFDP(
                    document.getElementById('fdp-crew-type').value,
                    document.getElementById('fdp-acclimatized').value,
                    document.getElementById('fdp-rest').value,
                    document.getElementById('fdp-report').value || '0600',
                    parseInt(document.getElementById('fdp-sectors').value, 10)
                );
                updateLiveTracker(maxFDP);
            }
        }, 1000);

        updateUTCClock();

        window.addEventListener('beforeunload', saveState);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const now = Date.now();
                timers.forEach((timer, index) => {
                    if (timer.running && timer.lastUpdate) {
                        const elapsed = now - timer.lastUpdate;
                        if (timer.type === 'countdown') {
                            const wasPositive = timer.remaining > 0;
                            timer.remaining = Math.max(0, timer.remaining - elapsed);
                            if (wasPositive && timer.remaining === 0) {
                                timer.running = false;
                                flashTimer(index, 5);
                            }
                        } else {
                            timer.elapsed += elapsed;
                        }
                        timer.lastUpdate = now;
                        updateTimerDisplay(index);
                    }
                });
                renderTimers();
                startAnimationLoop();
            }
        });
    </script>
</body>
</html>
