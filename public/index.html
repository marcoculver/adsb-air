<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flight Ops</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #002540 0%, #003d66 50%, #006496 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Active Timers Strip */
        .active-timers-strip {
            background: rgba(0, 20, 40, 0.95);
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            position: sticky;
            top: 10px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .strip-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid rgba(255, 130, 0, 0.3);
        }

        .strip-eta {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid rgba(255, 130, 0, 0.3);
            cursor: pointer;
        }

        .strip-eta:hover {
            opacity: 0.8;
        }

        .strip-eta-time {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .strip-eta-time.warning {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .strip-eta-time.critical {
            color: #ff5252;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.5);
        }

        .strip-eta-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .strip-clock-time {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .strip-clock-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .strip-timers {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
        }

        .strip-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .strip-timer:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .strip-timer-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--strip-color, #333) var(--strip-progress, 0%), #222 var(--strip-progress, 0%));
        }

        .strip-timer-icon-inner {
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: #001a2e;
            border-radius: 50%;
        }

        .strip-timer-info {
            display: flex;
            flex-direction: column;
        }

        .strip-timer-name {
            font-size: 0.7rem;
            color: #888;
        }

        .strip-timer-value {
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 8px currentColor;
        }

        .strip-timer.color-green .strip-timer-value { color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-value { color: #ffd700; }
        .strip-timer.color-orange .strip-timer-value { color: #FF8200; }
        .strip-timer.color-red .strip-timer-value { color: #ff5252; }
        .strip-timer.color-expired .strip-timer-value { color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-value { color: #00d4ff; }

        .strip-timer.color-green .strip-timer-icon { --strip-color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-icon { --strip-color: #ffd700; }
        .strip-timer.color-orange .strip-timer-icon { --strip-color: #FF8200; }
        .strip-timer.color-red .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-expired .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-icon { --strip-color: #00d4ff; }

        .strip-no-active {
            color: #666;
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            position: sticky;
            top: 75px;
            z-index: 99;
            background: rgba(0, 15, 30, 0.98);
            padding: 10px 0;
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            padding: 10px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Top sections grid */
        .top-sections {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .top-sections {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 700px) {
            .top-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Section styling */
        .section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .section-title {
            font-size: 1rem;
            color: #FF8200;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        /* Turnaround Badge */
        .turnaround-badge {
            background: rgba(255, 130, 0, 0.2);
            color: #FF8200;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .turnaround-badge.ahead {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .turnaround-badge.behind {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        /* Sector Block */
        .sector-block {
            transition: all 0.3s ease;
        }

        /* Input grids */
        .input-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-label {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Clickable input buttons */
        .input-btn {
            width: 100%;
            max-width: 90px;
            padding: 10px 6px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .input-btn.placeholder {
            color: rgba(0, 255, 136, 0.3);
        }

        .input-btn-with-unit {
            position: relative;
        }

        .input-btn-unit {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #888;
            pointer-events: none;
        }

        .results-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 130, 0, 0.2);
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 2px;
        }

        .result-value {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .block-time { color: #ffd700; }
        .flight-time { color: #00ff88; }
        .tow-value { color: #FF8200; }
        .eta-value { color: #00d4ff; }
        .acc-value { color: #a29bfe; }
        .mlf-value { color: #00ff88; }

        .clear-btn {
            display: block;
            margin: 10px auto 0;
            padding: 5px 14px;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 6px;
            color: #ff6b6b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .preset-btn {
            display: block;
            margin: 8px auto 0;
            padding: 6px 12px;
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 6px;
            color: #FF8200;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        /* ETA Section */
        .eta-countdown {
            font-size: 1.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            margin: 10px 0;
        }

        .eta-countdown.warning {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .eta-countdown.critical {
            color: #ff5252;
            text-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
        }

        .utc-display {
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        /* Aircraft selector */
        .aircraft-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
        }

        .aircraft-btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            color: #888;
            transition: all 0.2s;
        }

        .aircraft-btn.active {
            background: rgba(255, 130, 0, 0.3);
            border-color: #FF8200;
            color: #FF8200;
        }

        .mlw-info {
            text-align: center;
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 8px;
        }

        /* Timers Grid */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .timer-card {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            transition: background-color 0.15s, box-shadow 0.15s;
        }

        .timer-card.flashing {
            animation: flashRed 0.6s ease-in-out infinite;
        }

        @keyframes flashRed {
            0%, 100% { background: rgba(0, 37, 64, 0.7); box-shadow: none; }
            50% { background: rgba(255, 50, 0, 0.5); box-shadow: 0 0 40px rgba(255, 50, 0, 0.7); }
        }

        /* Clock Face */
        .clock-container {
            flex-shrink: 0;
        }

        .clock-face {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--clock-color, #333) var(--progress, 0%), #222 var(--progress, 0%));
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .clock-inner {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: linear-gradient(135deg, #002540 0%, #001a2e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clock-time {
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px currentColor;
        }

        /* Timer Controls */
        .timer-content {
            flex: 1;
            min-width: 0;
        }

        .timer-name-input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.2);
            border-radius: 6px;
            color: #fff;
            margin-bottom: 8px;
        }

        .timer-name-input:focus {
            outline: none;
            border-color: #FF8200;
        }

        .timer-type-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .timer-time-setup {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .time-input-btn {
            width: 55px;
            height: 40px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .time-separator {
            display: flex;
            align-items: center;
            color: #666;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 0 20px currentColor;
            color: var(--timer-color, #00ff88);
        }

        .timer-buttons {
            display: flex;
            gap: 6px;
        }

        .timer-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-start {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
        }

        .btn-repeat {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            color: #fff;
            flex: 0 0 40px;
            font-size: 1.1rem;
        }

        /* Crosswind Calculator */
        .wind-display {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 15px auto;
        }

        .wind-svg {
            width: 100%;
            height: 100%;
        }

        .component-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .component-item {
            text-align: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-width: 100px;
        }

        .component-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }

        .component-value {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .component-value.headwind { color: #00ff88; }
        .component-value.tailwind { color: #ff5252; }
        .component-value.crosswind { color: #ffd700; }

        /* Hold Entry Calculator */
        .hold-display {
            position: relative;
            width: 280px;
            height: 200px;
            margin: 15px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .hold-pattern {
            position: absolute;
            width: 120px;
            height: 160px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .hold-fix {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #FF8200;
            border-radius: 50%;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 10;
        }

        .hold-inbound {
            position: absolute;
            width: 2px;
            height: 70px;
            background: #00ff88;
            left: 50%;
            bottom: 12px;
            transform: translateX(-50%);
        }

        .hold-outbound {
            position: absolute;
            width: 2px;
            height: 70px;
            background: #888;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
        }

        .hold-turn {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid #888;
            border-radius: 50%;
            top: -10px;
        }

        .hold-turn.right { left: 50%; border-left-color: transparent; }
        .hold-turn.left { right: 50%; border-right-color: transparent; }

        .aircraft-track {
            position: absolute;
            width: 3px;
            height: 60px;
            background: #00d4ff;
            left: 20px;
            bottom: 20px;
            transform-origin: bottom center;
        }

        .aircraft-track::after {
            content: '✈';
            position: absolute;
            top: -15px;
            left: -8px;
            font-size: 18px;
            color: #00d4ff;
        }

        .entry-type-display {
            text-align: center;
            padding: 15px;
            background: rgba(255, 130, 0, 0.2);
            border-radius: 8px;
            margin-top: 15px;
        }

        .entry-type-label {
            font-size: 0.8rem;
            color: #888;
        }

        .entry-type-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF8200;
            margin-top: 5px;
        }

        .entry-type-desc {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-top: 5px;
        }

        /* ISA Calculator */
        .isa-result {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-top: 15px;
        }

        .isa-temp {
            font-size: 2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
        }

        .isa-deviation {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-top: 10px;
        }

        .isa-deviation.positive { color: #ff5252; }
        .isa-deviation.negative { color: #00d4ff; }
        .isa-deviation.neutral { color: #00ff88; }

        /* Scratchpad */
        .scratchpad-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .scratchpad-textarea {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 10px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            padding: 15px;
            resize: vertical;
        }

        .scratchpad-textarea:focus {
            outline: none;
            border-color: #FF8200;
        }

        .scratchpad-history {
            margin-top: 20px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-left: 3px solid #FF8200;
        }

        .history-timestamp {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
        }

        .history-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #e8e8e8;
            white-space: pre-wrap;
        }

        /* SNOWTAM Decoder */
        .snowtam-input {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 10px;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 15px;
            resize: vertical;
        }

        .snowtam-input:focus {
            outline: none;
            border-color: #FF8200;
        }

        .snowtam-decoded {
            margin-top: 15px;
        }

        .snowtam-runway {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .snowtam-runway-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FF8200;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 130, 0, 0.2);
        }

        .snowtam-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .snowtam-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .snowtam-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }

        .snowtam-value {
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .grf-good { color: #00ff88; }
        .grf-medium { color: #ffd700; }
        .grf-poor { color: #FF8200; }
        .grf-bad { color: #ff5252; }

        .friction-table {
            margin-top: 15px;
            font-size: 0.75rem;
            color: #888;
        }

        .friction-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .friction-table th, .friction-table td {
            padding: 6px 8px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            text-align: center;
        }

        .friction-table th {
            background: rgba(255, 130, 0, 0.2);
            color: #FF8200;
        }

        /* Timezone Converter */
        .tz-converter {
            max-width: 500px;
            margin: 0 auto;
        }

        .tz-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .tz-offset {
            width: 50px;
            font-size: 0.85rem;
            color: #FF8200;
            font-weight: 600;
        }

        .tz-time {
            flex: 1;
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
        }

        .tz-label {
            width: 140px;
            font-size: 0.8rem;
            color: #7ec8e3;
            text-align: right;
        }

        /* Toggle Buttons */
        .toggle-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .toggle-btn {
            width: 50px;
            height: 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            color: #888;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            border-color: #FF8200;
        }

        .toggle-btn.active {
            background: rgba(255, 130, 0, 0.3);
            border-color: #FF8200;
            color: #FF8200;
        }

        /* Wind SVG */
        .wind-svg {
            width: 100%;
            height: 100%;
        }

        /* Number Picker Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .number-picker {
            background: linear-gradient(135deg, #002540 0%, #003d66 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 130, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .picker-title {
            text-align: center;
            font-size: 1.1rem;
            color: #FF8200;
            margin-bottom: 20px;
        }

        .picker-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .picker-value {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            min-width: 120px;
            text-align: center;
        }

        .picker-unit {
            font-size: 1.2rem;
            color: #888;
        }

        .picker-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .picker-btn {
            padding: 15px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: bold;
            transition: all 0.2s;
        }

        .picker-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        .picker-btn:active {
            transform: scale(0.95);
        }

        .picker-btn.clear {
            background: rgba(255, 100, 100, 0.3);
        }

        .picker-actions {
            display: flex;
            gap: 10px;
        }

        .picker-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .picker-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .picker-confirm {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        /* Color states for countdown */
        .color-green { --clock-color: #00c853; --timer-color: #00ff88; }
        .color-yellow { --clock-color: #ffc107; --timer-color: #ffd54f; }
        .color-orange { --clock-color: #FF8200; --timer-color: #FF8200; }
        .color-red { --clock-color: #f44336; --timer-color: #ff5252; }
        .color-expired { --clock-color: #b71c1c; --timer-color: #ff1744; }
        .color-neutral { --clock-color: #006496; --timer-color: #00d4ff; }

        /* FDP Calculator Styles */
        .fdp-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .fdp-section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .fdp-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .fdp-field {
            display: flex;
            flex-direction: column;
        }

        .fdp-label {
            font-size: 0.8rem;
            color: #7ec8e3;
            margin-bottom: 5px;
        }

        .fdp-select, .fdp-input {
            padding: 10px;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .fdp-select {
            cursor: pointer;
        }

        .fdp-select option {
            background: #002540;
            color: #fff;
        }

        .fdp-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .fdp-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .fdp-result-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .fdp-result-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .fdp-result-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .fdp-result-local {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            margin-top: 3px;
        }

        .fdp-result-utc {
            font-size: 0.8rem;
            color: #888;
            margin-top: 3px;
        }

        .fdp-result-value.green { color: #00ff88; }
        .fdp-result-value.yellow { color: #ffd700; }
        .fdp-result-value.orange { color: #FF8200; }
        .fdp-result-value.red { color: #ff5252; }

        .fdp-warning {
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #FF8200;
            font-size: 0.9rem;
        }

        .fdp-danger {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #ff5252;
            font-size: 0.9rem;
        }

        .sector-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 800px) {
            .sector-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sector-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .sector-title {
            font-size: 0.85rem;
            color: #FF8200;
            margin-bottom: 10px;
            text-align: center;
        }

        .sector-field {
            margin-bottom: 8px;
        }

        .sector-field label {
            font-size: 0.7rem;
            color: #888;
            display: block;
            margin-bottom: 3px;
        }

        .turnaround-display {
            text-align: center;
            padding: 5px;
            background: rgba(255, 130, 0, 0.1);
            border-radius: 5px;
            margin-top: 5px;
        }

        .turnaround-label {
            font-size: 0.65rem;
            color: #888;
        }

        .turnaround-value {
            font-size: 0.9rem;
            color: #FF8200;
            font-family: 'Courier New', monospace;
        }

        /* Local time offset selector */
        .local-offset-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .local-offset-selector label {
            font-size: 0.85rem;
            color: #7ec8e3;
        }

        .local-offset-selector select {
            padding: 8px 12px;
            background: #002540;
            border: 2px solid #FF8200;
            border-radius: 5px;
            color: #FF8200;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .local-offset-selector select option {
            background: #002540;
            color: #FF8200;
        }

        /* Actual tracking section */
        .actual-tracking {
            background: rgba(0, 100, 150, 0.1);
            border: 1px solid rgba(0, 100, 150, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .actual-tracking-title {
            font-size: 0.9rem;
            color: #006496;
            margin-bottom: 10px;
            text-align: center;
        }

        .actual-sector-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (max-width: 800px) {
            .actual-sector-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .duty-estimate {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .duty-estimate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .duty-estimate-label {
            font-size: 0.85rem;
            color: #888;
        }

        .duty-estimate-value {
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* iPad specific */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .timer-card {
                flex-direction: column;
                text-align: center;
            }

            .timer-display {
                font-size: 1.6rem;
            }

            .tab-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        button {
            -webkit-user-select: none;
            user-select: none;
        }

        .timer-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Active Timers Strip -->
        <div class="active-timers-strip" id="active-timers-strip">
            <div class="strip-clock">
                <div class="strip-clock-time" id="strip-utc-clock">--:--:--</div>
                <div class="strip-clock-label">UTC</div>
            </div>
            <div class="strip-clock" style="border-right: 1px solid rgba(255, 130, 0, 0.3); padding-right: 15px;">
                <div class="strip-clock-time" id="strip-dxb-clock" style="color: #FF8200;">--:--:--</div>
                <div class="strip-clock-label">DXB</div>
            </div>
            <div class="strip-eta" id="strip-eta" style="display:none" onclick="switchTab('sched')">
                <div class="strip-eta-time" id="strip-eta-time">--:--</div>
                <div class="strip-eta-label">ETA</div>
            </div>
            <div class="strip-timers" id="strip-timers">
                <span class="strip-no-active">No active timers</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('sched')">SCHED</button>
            <button class="tab-btn" onclick="switchTab('fdp')">FDP</button>
            <button class="tab-btn" onclick="switchTab('fuel')">FUEL</button>
            <button class="tab-btn" onclick="switchTab('perf')">PERF</button>
            <button class="tab-btn" onclick="switchTab('time')">TIME</button>
            <button class="tab-btn" onclick="switchTab('nav')">NAV</button>
            <button class="tab-btn" onclick="switchTab('tmr')">TMR</button>
            <button class="tab-btn" onclick="switchTab('lay')">LAY</button>
            <button class="tab-btn" onclick="switchTab('ref')">REF</button>
            <button class="tab-btn" onclick="switchTab('notes')">NOTES</button>
            <button class="tab-btn" onclick="switchTab('set')">SET</button>
        </div>

        <!-- SCHED Tab (Schedule Entry - Primary Tab) -->
        <div class="tab-content active" id="tab-sched">
            <div class="fdp-container">
                <!-- Schedule Header -->
                <div class="fdp-section" style="text-align: center; padding: 15px;">
                    <h2 style="color: #FF8200; margin-bottom: 10px;">Flight Schedule</h2>
                    <p style="color: #888; font-size: 0.85rem;">Enter your flight roster below. Data will auto-populate to FDP, OOOI, and other tabs.</p>
                </div>

                <!-- Report Time -->
                <div class="fdp-section">
                    <div class="section-title">Duty Information</div>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Report Time (Local)</label>
                            <button class="input-btn" id="sched-report-btn" onclick="openTimePicker('sched-report')" style="max-width: 100%">----</button>
                            <input type="hidden" id="sched-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Aircraft</label>
                            <button class="input-btn" id="sched-aircraft-btn" onclick="openAircraftPicker()" style="max-width: 100%;">B738</button>
                            <input type="hidden" id="sched-aircraft" value="B738">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Tail Number</label>
                            <button class="input-btn" id="sched-tail-btn" onclick="openTailPicker()" style="max-width: 100%;">A6-___</button>
                            <input type="hidden" id="sched-tail" value="">
                        </div>
                    </div>
                </div>

                <!-- Sector 1 -->
                <div class="fdp-section sector-block" id="sector-1-block">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 1</span>
                        <span id="sector-1-turnaround" class="turnaround-badge" style="display: none;">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s1-flt-btn" onclick="openFlightPicker('s1-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s1-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s1-dep-btn" onclick="openTextPicker('s1-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">→</span>
                                <button class="input-btn" id="s1-arr-btn" onclick="openTextPicker('s1-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s1-dep" value="">
                            <input type="hidden" id="s1-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s1-pax-btn" onclick="openWeightPicker('s1-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s1-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s1-stand-btn" onclick="openTextPicker('s1-stand', 'Stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s1-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid: STD/OUT | OFF | ON | STA/IN | RESULTS -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1.5fr; gap: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <!-- Departure Times -->
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STD</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">OUT</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s1-std-btn" onclick="openTimePicker('s1-std')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s1-out-btn" onclick="openTimePicker('s1-out')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s1-std" value="">
                            <input type="hidden" id="s1-out" value="">
                        </div>
                        <!-- OFF Time -->
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                            <button class="input-btn" id="s1-off-btn" onclick="openTimePicker('s1-off')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s1-off" value="">
                        </div>
                        <!-- ON Time -->
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">ON</label>
                            <button class="input-btn" id="s1-on-btn" onclick="openTimePicker('s1-on')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s1-on" value="">
                        </div>
                        <!-- Arrival Times -->
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STA</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">IN</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s1-sta-btn" onclick="openTimePicker('s1-sta')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s1-in-btn" onclick="openTimePicker('s1-in')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s1-sta" value="">
                            <input type="hidden" id="s1-in" value="">
                        </div>
                        <!-- Results -->
                        <div class="fdp-field" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s1-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s1-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 2 -->
                <div class="fdp-section sector-block" id="sector-2-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 2</span>
                        <span id="sector-2-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s2-flt-btn" onclick="openFlightPicker('s2-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s2-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s2-dep-btn" onclick="openTextPicker('s2-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">→</span>
                                <button class="input-btn" id="s2-arr-btn" onclick="openTextPicker('s2-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s2-dep" value="">
                            <input type="hidden" id="s2-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s2-pax-btn" onclick="openWeightPicker('s2-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s2-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s2-stand-btn" onclick="openTextPicker('s2-stand', 'Stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s2-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1.5fr; gap: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STD</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">OUT</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s2-std-btn" onclick="openTimePicker('s2-std')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s2-out-btn" onclick="openTimePicker('s2-out')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s2-std" value="">
                            <input type="hidden" id="s2-out" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                            <button class="input-btn" id="s2-off-btn" onclick="openTimePicker('s2-off')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s2-off" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">ON</label>
                            <button class="input-btn" id="s2-on-btn" onclick="openTimePicker('s2-on')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s2-on" value="">
                        </div>
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STA</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">IN</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s2-sta-btn" onclick="openTimePicker('s2-sta')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s2-in-btn" onclick="openTimePicker('s2-in')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s2-sta" value="">
                            <input type="hidden" id="s2-in" value="">
                        </div>
                        <div class="fdp-field" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s2-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s2-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 3 -->
                <div class="fdp-section sector-block" id="sector-3-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 3</span>
                        <span id="sector-3-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s3-flt-btn" onclick="openFlightPicker('s3-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s3-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s3-dep-btn" onclick="openTextPicker('s3-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">→</span>
                                <button class="input-btn" id="s3-arr-btn" onclick="openTextPicker('s3-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s3-dep" value="">
                            <input type="hidden" id="s3-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s3-pax-btn" onclick="openWeightPicker('s3-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s3-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s3-stand-btn" onclick="openTextPicker('s3-stand', 'Stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s3-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1.5fr; gap: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STD</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">OUT</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s3-std-btn" onclick="openTimePicker('s3-std')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s3-out-btn" onclick="openTimePicker('s3-out')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s3-std" value="">
                            <input type="hidden" id="s3-out" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                            <button class="input-btn" id="s3-off-btn" onclick="openTimePicker('s3-off')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s3-off" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">ON</label>
                            <button class="input-btn" id="s3-on-btn" onclick="openTimePicker('s3-on')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s3-on" value="">
                        </div>
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STA</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">IN</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s3-sta-btn" onclick="openTimePicker('s3-sta')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s3-in-btn" onclick="openTimePicker('s3-in')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s3-sta" value="">
                            <input type="hidden" id="s3-in" value="">
                        </div>
                        <div class="fdp-field" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s3-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s3-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 4 -->
                <div class="fdp-section sector-block" id="sector-4-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 4</span>
                        <span id="sector-4-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s4-flt-btn" onclick="openFlightPicker('s4-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s4-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s4-dep-btn" onclick="openTextPicker('s4-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">→</span>
                                <button class="input-btn" id="s4-arr-btn" onclick="openTextPicker('s4-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s4-dep" value="">
                            <input type="hidden" id="s4-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s4-pax-btn" onclick="openWeightPicker('s4-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s4-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s4-stand-btn" onclick="openTextPicker('s4-stand', 'Stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s4-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1.5fr; gap: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STD</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">OUT</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s4-std-btn" onclick="openTimePicker('s4-std')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s4-out-btn" onclick="openTimePicker('s4-out')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s4-std" value="">
                            <input type="hidden" id="s4-out" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                            <button class="input-btn" id="s4-off-btn" onclick="openTimePicker('s4-off')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s4-off" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label" style="color: #00d4ff;">ON</label>
                            <button class="input-btn" id="s4-on-btn" onclick="openTimePicker('s4-on')" style="max-width: 100%">----</button>
                            <input type="hidden" id="s4-on" value="">
                        </div>
                        <div class="fdp-field">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <label class="fdp-label" style="flex:1; color: #888; font-size: 0.65rem;">STA</label>
                                <label class="fdp-label" style="flex:1; color: #00d4ff; font-size: 0.65rem;">IN</label>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="input-btn" id="s4-sta-btn" onclick="openTimePicker('s4-sta')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                                <button class="input-btn" id="s4-in-btn" onclick="openTimePicker('s4-in')" style="flex:1; font-size: 0.9rem; padding: 8px 4px;">----</button>
                            </div>
                            <input type="hidden" id="s4-sta" value="">
                            <input type="hidden" id="s4-in" value="">
                        </div>
                        <div class="fdp-field" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s4-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s4-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Remove Sector Buttons -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button class="preset-btn" id="add-sector-btn" onclick="addSector()">+ Add Sector</button>
                    <button class="clear-btn" id="remove-sector-btn" onclick="removeSector()" style="margin: 0;">- Remove Sector</button>
                    <button class="clear-btn" onclick="clearSchedule()" style="margin: 0; margin-left: 20px;">Clear All</button>
                </div>

                <!-- Duty Summary -->
                <div class="fdp-section" style="margin-top: 20px;">
                    <div class="section-title">Duty Summary</div>
                    <div class="fdp-results" style="margin-top: 0;">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Sectors</div>
                                <div class="fdp-result-value" id="sched-total-sectors" style="color: #FF8200;">1</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Block</div>
                                <div class="fdp-result-value" id="sched-total-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Flight</div>
                                <div class="fdp-result-value" id="sched-total-flight" style="color: #00ff88;">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Duty Time</div>
                                <div class="fdp-result-value" id="sched-duty-time" style="color: #00d4ff;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PERF Tab (Performance: TOW, ACC Height, Max Landing Fuel) -->
        <div class="tab-content" id="tab-perf">
            <div class="top-sections" style="grid-template-columns: repeat(3, 1fr);">
                <!-- TOW Calculator -->
                <div class="section">
                    <div class="section-title">TOW Calculator</div>
                    <div class="aircraft-selector" style="margin-bottom:10px">
                        <button class="aircraft-btn active" id="tow-ac-b738" onclick="selectAircraft('B738')">B738</button>
                        <button class="aircraft-btn" id="tow-ac-b38m" onclick="selectAircraft('B38M')">B38M</button>
                        <button class="aircraft-btn" id="tow-ac-b39m" onclick="selectAircraft('B39M')">B39M</button>
                    </div>
                    <div class="input-grid-3">
                        <div class="input-group">
                            <label class="input-label">ZFW</label>
                            <button class="input-btn placeholder" id="calc-zfw-btn" onclick="openWeightPicker('calc-zfw', 'ZFW')">0</button>
                            <input type="hidden" id="calc-zfw" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">FOB</label>
                            <button class="input-btn placeholder" id="calc-fob-btn" onclick="openWeightPicker('calc-fob', 'FOB')">0</button>
                            <input type="hidden" id="calc-fob" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">TAXI</label>
                            <button class="input-btn placeholder" id="calc-taxi-btn" onclick="openWeightPicker('calc-taxi', 'Taxi Fuel')">0</button>
                            <input type="hidden" id="calc-taxi" value="">
                        </div>
                    </div>
                    <div class="input-grid-2" style="margin-top:8px;">
                        <div class="input-group">
                            <label class="input-label">TRIP FUEL</label>
                            <button class="input-btn placeholder" id="calc-trip-btn" onclick="openWeightPicker('calc-trip', 'Trip Fuel')">0</button>
                            <input type="hidden" id="calc-trip" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">EST LDG FUEL</label>
                            <div class="result-value" id="est-ldg-fuel" style="font-size:0.9rem; padding:8px 0; color:#7ec8e3;">---</div>
                        </div>
                    </div>
                    <div class="results-row" style="flex-wrap:wrap; gap:10px;">
                        <div class="result-item">
                            <div class="result-label">TAXI WT</div>
                            <div class="result-value" id="taxi-wt-result" style="font-size:1rem">---</div>
                            <div class="result-label" id="mtw-limit" style="color:#666; font-size:0.65rem">MTW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">TAKE OFF WT</div>
                            <div class="result-value tow-value" id="tow-result">---</div>
                            <div class="result-label" id="mtow-limit" style="color:#666; font-size:0.65rem">MTOW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">EST LDG WT</div>
                            <div class="result-value" id="ldw-result" style="font-size:1rem; color:#00ff88">---</div>
                            <div class="result-label" id="mlw-limit" style="color:#666; font-size:0.65rem">MLW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ZFW</div>
                            <div class="result-value" id="zfw-display" style="font-size:1rem; color:#7ec8e3">---</div>
                            <div class="result-label" id="mzfw-limit" style="color:#666; font-size:0.65rem">MZFW: ---</div>
                        </div>
                    </div>
                    <div id="tow-warnings" style="margin-top:10px"></div>
                    <button class="clear-btn" id="calc-clear">Clear</button>
                </div>

                <!-- OPT ACC Calculator -->
                <div class="section" style="min-width:200px">
                    <div class="section-title">Acceleration Height</div>
                    <div class="input-grid-2" style="gap:12px">
                        <div class="input-group">
                            <label class="input-label">OPT ACC</label>
                            <div class="input-btn-with-unit" style="width:100%">
                                <button class="input-btn placeholder" id="opt-acc-btn" onclick="openWeightPicker('opt-acc', 'OPT ACC', 'ft')" style="max-width:110px; padding-right:25px">0</button>
                                <span class="input-btn-unit" style="right:10px">ft</span>
                            </div>
                            <input type="hidden" id="opt-acc" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ELEV</label>
                            <div class="input-btn-with-unit" style="width:100%">
                                <button class="input-btn placeholder" id="airfield-elev-btn" onclick="openWeightPicker('airfield-elev', 'Elevation', 'ft')" style="max-width:110px; padding-right:25px">0</button>
                                <span class="input-btn-unit" style="right:10px">ft</span>
                            </div>
                            <input type="hidden" id="airfield-elev" value="">
                        </div>
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">ACC HEIGHT AGL</div>
                            <div class="result-value acc-value" id="acc-result">--- ft</div>
                        </div>
                    </div>
                    <button class="preset-btn" id="dxb-elev-btn">DXB (62 ft)</button>
                    <button class="clear-btn" id="acc-clear">Clear</button>
                </div>
            </div>

            <!-- Max Landing Fuel Calculator -->
            <div class="section" style="max-width: 400px; margin: 0 auto 25px;">
                <div class="section-title">Max Landing Fuel</div>
                <div class="aircraft-selector">
                    <button class="aircraft-btn active" id="ac-b738" onclick="selectAircraft('B738')">B738</button>
                    <button class="aircraft-btn" id="ac-b38m" onclick="selectAircraft('B38M')">B38M</button>
                    <button class="aircraft-btn" id="ac-b39m" onclick="selectAircraft('B39M')">B39M</button>
                </div>
                <div class="mlw-info">MLW: <span id="mlw-display">66,360</span> kg</div>
                <div class="results-row" style="border:none; padding-top:5px;">
                    <div class="result-item">
                        <div class="result-label">MAX FUEL ON LANDING</div>
                        <div class="result-value mlf-value" id="mlf-result">---</div>
                    </div>
                </div>
                <div style="text-align:center; font-size:0.7rem; color:#888; margin-top:5px;">
                    Uses ZFW from TOW Calculator
                </div>
            </div>

        </div>

        <!-- Timers Tab -->
        <div class="tab-content" id="tab-tmr">
            <div class="timers-grid" id="timers-container"></div>
        </div>

        <!-- Fuel Tab -->
        <div class="tab-content" id="tab-fuel">
            <div class="fdp-container">
                <!-- Input Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Inputs</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Fuel Required (kg)</label>
                            <button class="input-btn" id="fuel-req-btn" onclick="openFuelPicker('fuel-req', 'Fuel Required', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-req" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pre Uplift (kg)</label>
                            <button class="input-btn" id="fuel-pre-btn" onclick="openFuelPicker('fuel-pre', 'Pre Uplift', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-pre" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">SG (Density)</label>
                            <button class="input-btn" id="fuel-sg-btn" onclick="openSGPicker()" style="max-width:100%">0.800</button>
                            <input type="hidden" id="fuel-sg" value="800">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Uplift (L)</label>
                            <button class="input-btn" id="fuel-actual-btn" onclick="openFuelPicker('fuel-actual', 'Actual Uplift', 'L')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-actual" value="">
                        </div>
                    </div>
                </div>

                <!-- Tank Split Block -->
                <div class="fdp-section">
                    <div class="section-title">Tank Split</div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Left Wing (kg)</label>
                            <button class="input-btn" id="tank-left-btn" onclick="openFuelPicker('tank-left', 'Left Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-left" value="3700">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Center (kg)</label>
                            <div class="fdp-result-value green" id="tank-center" style="padding-top:8px; text-align:center">---</div>
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Right Wing (kg)</label>
                            <button class="input-btn" id="tank-right-btn" onclick="openFuelPicker('tank-right', 'Right Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-right" value="3700">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:5px;">
                        Center tank is auto-calculated: Total Required - Left - Right
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="preset-btn" onclick="setFullTanks()" style="flex:1;">Full Tanks (20,200 kg)</button>
                        <button class="preset-btn" onclick="resetTankSplit()" style="flex:1;">Reset Wings</button>
                    </div>
                </div>

                <!-- Fuel Summary Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Summary</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Fuel Required</div>
                                <div class="fdp-result-value" id="summary-req">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Pre Uplift</div>
                                <div class="fdp-result-value" id="summary-pre">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Uplift Required</div>
                                <div class="fdp-result-value yellow" id="summary-uplift-req">--- kg</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Departure Fuel</div>
                                <div class="fdp-result-value" id="summary-dep">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Adjustment (+/-)</div>
                                <div style="display:flex; gap:5px; justify-content:center">
                                    <button class="input-btn" id="fuel-adj-btn" onclick="openAdjustmentPicker()" style="max-width:80px; flex:1">0</button>
                                    <button class="input-btn" id="fuel-adj-sign-btn" onclick="toggleAdjustmentSign()" style="max-width:40px; padding:5px; font-size:1.2rem">+/-</button>
                                </div>
                                <input type="hidden" id="fuel-adj" value="">
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Final Departure Fuel</div>
                                <div class="fdp-result-value green" id="summary-final-dep">--- kg</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uplift Verification Block -->
                <div class="fdp-section">
                    <div class="section-title">Uplift Verification</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated Uplift</div>
                                <div class="fdp-result-value" id="calc-uplift">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Actual Uplift</div>
                                <div class="fdp-result-value" id="verify-actual">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Difference</div>
                                <div class="fdp-result-value" id="uplift-diff">--- %</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">-3% Limit</div>
                                <div class="fdp-result-value" id="limit-low">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated</div>
                                <div class="fdp-result-value yellow" id="limit-calc">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">+3% Limit</div>
                                <div class="fdp-result-value" id="limit-high">--- L</div>
                            </div>
                        </div>
                        <div id="uplift-status" style="margin-top:15px; text-align:center;"></div>
                    </div>
                </div>

                <!-- Fuel Unit Converter -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Unit Converter</div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-bottom:10px;">
                        Enter one value and press OK - others will auto-calculate (SG: 0.800)
                    </div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Litres (L)</label>
                            <button class="input-btn" id="conv-litres-btn" onclick="openConverterPicker('litres')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-litres" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">US Gallons</label>
                            <button class="input-btn" id="conv-gallons-btn" onclick="openConverterPicker('gallons')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-gallons" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Pounds (lbs)</label>
                            <button class="input-btn" id="conv-lbs-btn" onclick="openConverterPicker('lbs')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-lbs" value="">
                        </div>
                    </div>
                    <button class="clear-btn" id="conv-clear" style="margin-top:10px">Clear Converter</button>
                </div>

                <button class="clear-btn" id="fuel-clear" style="margin-top:15px">Clear All Fuel Data</button>
            </div>
        </div>

        <!-- Layover Tab -->
        <div class="tab-content" id="tab-lay">
            <div class="fdp-container">
                <!-- UTC Offset Selector -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="layover-offset" onchange="calculateLayover()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3 (MSK)</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0">UTC+0 (LGW)</option>
                        <option value="1">UTC+1 (BEG/PRG/ZAG)</option>
                        <option value="2">UTC+2 (CAI/AMM/TLV/ATH)</option>
                        <option value="3">UTC+3 (RUH/JED/KWI/BAH/DOH)</option>
                        <option value="3.5">UTC+3:30 (IKA/THR)</option>
                        <option value="4" selected>UTC+4 (DXB/MCT/TBS)</option>
                        <option value="4.5">UTC+4:30 (KBL)</option>
                        <option value="5">UTC+5 (KHI/LHE/ISB/TAS)</option>
                        <option value="5.5">UTC+5:30 (DEL/BOM/COK/CMB)</option>
                        <option value="6">UTC+6 (DAC/ALA)</option>
                        <option value="7">UTC+7 (BKK)</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Wake Up Calculator</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">STD (UTC)</label>
                            <button class="input-btn" id="layover-std-btn" onclick="openTimePicker('layover-std')" style="max-width:100%">----</button>
                            <input type="hidden" id="layover-std" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pickup Before STD</label>
                            <button class="input-btn" id="layover-pickup-btn" onclick="openTimePicker('layover-pickup')" style="max-width:100%">0130</button>
                            <input type="hidden" id="layover-pickup" value="0130">
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Calculated Times</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">STD (Local)</div>
                                <div class="fdp-result-local" id="layover-std-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-std-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Hotel Departure</div>
                                <div class="fdp-result-local" id="layover-hotel-local" style="color:#ffd700">--:--</div>
                                <div class="fdp-result-utc" id="layover-hotel-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Wake Up Time</div>
                                <div class="fdp-result-local" id="layover-wake-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-wake-utc">UTC: --:--</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:10px;">
                        Hotel Departure = STD - Pickup Time | Wake Up = Hotel Departure - 1 hour
                    </div>
                </div>

                <button class="clear-btn" id="layover-clear" style="margin-top:15px">Clear</button>
            </div>
        </div>

        <!-- FDP Calculator Tab -->
        <div class="tab-content" id="tab-fdp">
            <div class="fdp-container">
                <!-- Local Time Offset -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="local-offset" onchange="calculateFDP()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3 (MSK)</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0">UTC+0 (LGW)</option>
                        <option value="1">UTC+1 (BEG/PRG/ZAG)</option>
                        <option value="2">UTC+2 (CAI/AMM/TLV/ATH)</option>
                        <option value="3">UTC+3 (RUH/JED/KWI/BAH/DOH)</option>
                        <option value="3.5">UTC+3:30 (IKA/THR)</option>
                        <option value="4" selected>UTC+4 (DXB/MCT/TBS)</option>
                        <option value="4.5">UTC+4:30 (KBL)</option>
                        <option value="5">UTC+5 (KHI/LHE/ISB/TAS)</option>
                        <option value="5.5">UTC+5:30 (DEL/BOM/COK/CMB)</option>
                        <option value="6">UTC+6 (DAC/ALA)</option>
                        <option value="7">UTC+7 (BKK)</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section collapsible" id="fdp-duty-setup">
                    <div class="section-title" onclick="toggleFDPSetup()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>Duty Setup</span>
                        <span id="fdp-setup-toggle" style="font-size: 0.8rem; color: #888;">▼</span>
                    </div>
                    <div class="fdp-setup-content" id="fdp-setup-content">
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Crew Type</label>
                            <select class="fdp-select" id="fdp-crew-type" onchange="calculateFDP()">
                                <option value="flight">Flight Crew</option>
                                <option value="cabin">Cabin Crew</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Acclimatization</label>
                            <select class="fdp-select" id="fdp-acclimatized" onchange="calculateFDP()">
                                <option value="yes">Acclimatized</option>
                                <option value="no">Not Acclimatized</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Preceding Rest</label>
                            <select class="fdp-select" id="fdp-rest" onchange="calculateFDP()">
                                <option value="normal">Up to 18h or over 30h</option>
                                <option value="reduced">Between 18-30h</option>
                            </select>
                        </div>
                    </div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Report Time (Local)</label>
                            <button class="input-btn" id="fdp-report-btn" onclick="openTimePicker('fdp-report')" style="max-width:100%">0600</button>
                            <input type="hidden" id="fdp-report" value="0600">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Number of Sectors</label>
                            <select class="fdp-select" id="fdp-sectors" onchange="updateSectorInputs(); calculateFDP()">
                                <option value="1">1 Sector</option>
                                <option value="2">2 Sectors</option>
                                <option value="3">3 Sectors</option>
                                <option value="4">4 Sectors</option>
                            </select>
                        </div>
                    </div>
                    </div><!-- End fdp-setup-content -->
                    <button class="preset-btn" onclick="syncFromSchedule()" style="margin-top: 10px; width: 100%;">
                        Sync from Schedule
                    </button>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Scheduled Sector Times</div>
                    <div class="sector-inputs" id="sector-inputs">
                        <!-- Dynamically filled -->
                    </div>

                    <div class="actual-tracking">
                        <div class="actual-tracking-title">Actual Times Tracking</div>
                        <div class="actual-sector-grid" id="actual-sector-inputs">
                            <!-- Dynamically filled -->
                        </div>
                        <div class="duty-estimate" id="duty-estimate">
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label">Estimated Duty End (Local):</span>
                                <span class="duty-estimate-value" id="est-duty-end-local" style="color:#00ff88; font-size:1.3rem">--:--</span>
                            </div>
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label" style="color:#666">UTC:</span>
                                <span class="duty-estimate-value" id="est-duty-end" style="color:#888; font-size:0.95rem">--:--</span>
                            </div>
                            <div class="duty-estimate-row">
                                <span class="duty-estimate-label">Status:</span>
                                <span class="duty-estimate-value green" id="duty-status">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">FDP Results</div>
                    <div class="fdp-results">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max FDP</div>
                                <div class="fdp-result-value green" id="fdp-max">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest On-Chocks</div>
                                <div class="fdp-result-local" id="fdp-chocks-local">--:--</div>
                                <div class="fdp-result-utc" id="fdp-chocks">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Latest Off-Duty</div>
                                <div class="fdp-result-local" id="fdp-offduty-local">--:--</div>
                                <div class="fdp-result-utc" id="fdp-offduty">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Max Discretion</div>
                                <div class="fdp-result-value yellow" id="fdp-discretion">+3:00</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Absolute Limit</div>
                                <div class="fdp-result-local" id="fdp-absolute-local" style="color:#FF8200">--:--</div>
                                <div class="fdp-result-utc" id="fdp-absolute">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Min Rest After</div>
                                <div class="fdp-result-value" id="fdp-rest-after">12:00</div>
                            </div>
                        </div>
                        <div id="fdp-warnings"></div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Live Duty Tracker</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Report (Local)</label>
                            <button class="input-btn" id="fdp-actual-report-btn" onclick="openTimePicker('fdp-actual-report')" style="max-width:100%">----</button>
                            <input type="hidden" id="fdp-actual-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current UTC</label>
                            <div class="fdp-result-value" id="fdp-utc-time" style="padding-top:10px">--:--:--</div>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current Local</label>
                            <div class="fdp-result-value" id="fdp-local-time" style="padding-top:10px">--:--:--</div>
                        </div>
                    </div>
                    <div class="fdp-result-grid" style="margin-top:15px">
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Elapsed</div>
                            <div class="fdp-result-value" id="fdp-elapsed">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Remaining</div>
                            <div class="fdp-result-value green" id="fdp-remaining">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">Into Discretion</div>
                            <div class="fdp-result-value" id="fdp-into-discretion">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nav Tab (Crosswind, Hold Entry, ISA) -->
        <div class="tab-content" id="tab-nav">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(3, 1fr);">
                    <!-- Crosswind Calculator -->
                    <div class="section">
                        <div class="section-title">Crosswind Calculator</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">Runway HDG (°)</label>
                                <button class="input-btn" id="xwind-rwy-btn" onclick="openRunwayHdgPicker()" style="max-width:100%">---°</button>
                                <input type="hidden" id="xwind-rwy" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Wind (OPT: 220/13 or 220/3m)</label>
                                <button class="input-btn" id="xwind-opt-btn" onclick="openOPTWindPicker()" style="max-width:100%; font-size: 0.85rem;">---/--</button>
                                <input type="hidden" id="xwind-dir" value="">
                                <input type="hidden" id="xwind-spd" value="">
                            </div>
                        </div>
                        <div class="input-grid-2" style="margin-top:8px">
                            <div class="input-group">
                                <label class="input-label" style="font-size: 0.65rem; color: #666;">Or enter separately:</label>
                                <div style="display: flex; gap: 5px;">
                                    <button class="input-btn" id="xwind-dir-btn" onclick="openWindDirPicker()" style="flex: 1; font-size: 0.8rem;">---°</button>
                                    <button class="input-btn" id="xwind-spd-btn" onclick="openWindSpdPicker('xwind-spd', 'Wind Speed')" style="flex: 1; font-size: 0.8rem;">-- kt</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Gust (kt)</label>
                                <button class="input-btn placeholder" id="xwind-gust-btn" onclick="openWindSpdPicker('xwind-gust', 'Gust')" style="max-width:100%">-- kt</button>
                                <input type="hidden" id="xwind-gust" value="">
                            </div>
                        </div>
                        <div class="wind-display" id="wind-display">
                            <svg viewBox="0 0 200 200" class="wind-svg">
                                <!-- Compass circle -->
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#444" stroke-width="2"/>
                                <!-- Cardinal directions -->
                                <text x="100" y="18" text-anchor="middle" fill="#666" font-size="12">N</text>
                                <text x="185" y="104" text-anchor="middle" fill="#666" font-size="12">E</text>
                                <text x="100" y="196" text-anchor="middle" fill="#666" font-size="12">S</text>
                                <text x="15" y="104" text-anchor="middle" fill="#666" font-size="12">W</text>
                                <!-- Runway rectangle (rotates) -->
                                <g id="runway-svg" transform="rotate(0, 100, 100)">
                                    <rect x="95" y="30" width="10" height="140" fill="#555" stroke="#888" stroke-width="1" rx="2"/>
                                    <line x1="100" y1="35" x2="100" y2="165" stroke="#fff" stroke-width="1" stroke-dasharray="8,8"/>
                                </g>
                                <!-- Runway numbers (positioned separately, don't rotate with runway) -->
                                <text id="rwy-num-approach" x="100" y="100" text-anchor="middle" fill="#FF8200" font-size="12" font-weight="bold"></text>
                                <text id="rwy-num-depart" x="100" y="100" text-anchor="middle" fill="#888" font-size="10"></text>
                                <!-- Wind arrow (shows where wind is coming FROM - arrow points toward runway) -->
                                <g id="wind-arrow-svg" transform="rotate(0, 100, 100)">
                                    <line x1="100" y1="15" x2="100" y2="60" stroke="#00d4ff" stroke-width="3"/>
                                    <polygon points="100,65 94,50 106,50" fill="#00d4ff"/>
                                </g>
                                <!-- Wind direction label (doesn't rotate) -->
                                <text id="wind-dir-label" x="100" y="100" text-anchor="middle" fill="#00d4ff" font-size="10" font-weight="bold"></text>
                                <!-- Center dot -->
                                <circle cx="100" cy="100" r="4" fill="#FF8200"/>
                            </svg>
                        </div>
                        <div class="component-display">
                            <div class="component-item">
                                <div class="component-label">HEAD/TAIL</div>
                                <div class="component-value headwind" id="headwind-val">--</div>
                            </div>
                            <div class="component-item">
                                <div class="component-label">CROSSWIND</div>
                                <div class="component-value crosswind" id="crosswind-val">--</div>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearCrosswind()">Clear</button>
                    </div>

                    <!-- Hold Entry Calculator -->
                    <div class="section">
                        <div class="section-title">Hold Entry</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">Inbound CRS</label>
                                <button class="input-btn" id="hold-inbound-btn" onclick="openHeadingPicker('hold-inbound', 'Inbound Course')" style="max-width:100%">---</button>
                                <input type="hidden" id="hold-inbound" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Your HDG</label>
                                <button class="input-btn" id="hold-hdg-btn" onclick="openHeadingPicker('hold-hdg', 'Your Heading')" style="max-width:100%">---</button>
                                <input type="hidden" id="hold-hdg" value="">
                            </div>
                        </div>
                        <div class="hold-turn-btns" style="margin-top:8px">
                            <label class="input-label" style="text-align:center;display:block;margin-bottom:5px">Turn Direction</label>
                            <div class="toggle-btn-group">
                                <button class="toggle-btn" id="hold-turn-l" onclick="setHoldTurn('left')">L</button>
                                <button class="toggle-btn active" id="hold-turn-r" onclick="setHoldTurn('right')">R</button>
                            </div>
                            <input type="hidden" id="hold-turn-dir" value="right">
                        </div>
                        <div class="hold-display" id="hold-display">
                            <svg viewBox="0 0 300 300" style="width:100%;height:100%">
                                <!-- Entry sectors (relative to inbound course) - centered on fix -->
                                <g id="hold-sectors" transform="rotate(0, 150, 150)">
                                    <!-- Direct sector - green (approaching from behind the hold) -->
                                    <path d="M150,150 L150,10 A140,140 0 0,1 290,150 L150,150" fill="rgba(0,255,136,0.15)" stroke="none" id="sector-direct"/>
                                    <!-- Teardrop sector - yellow (70° from direct boundary) -->
                                    <path d="M150,150 L290,150 A140,140 0 0,1 197,280 L150,150" fill="rgba(255,215,0,0.15)" stroke="none" id="sector-teardrop"/>
                                    <!-- Parallel sector - blue (opposite to inbound) -->
                                    <path d="M150,150 L197,280 A140,140 0 0,1 150,10 L150,150" fill="rgba(0,212,255,0.15)" stroke="none" id="sector-parallel"/>
                                    <!-- Sector boundary lines -->
                                    <line x1="150" y1="150" x2="150" y2="10" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
                                    <line x1="150" y1="150" x2="290" y2="150" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
                                    <line x1="150" y1="150" x2="197" y2="280" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
                                </g>
                                <!-- Hold pattern racetrack - FIX AT CENTER (150,150) -->
                                <g id="hold-pattern" transform="rotate(0, 150, 150)">
                                    <!-- Inbound leg - approaching fix from below -->
                                    <line x1="150" y1="220" x2="150" y2="155" stroke="#00ff88" stroke-width="3"/>
                                    <!-- Inbound arrow pointing to fix -->
                                    <polygon points="150,160 145,175 155,175" fill="#00ff88"/>
                                    <!-- Turn at fix - arc to the right to outbound side -->
                                    <path d="M150,150 A35,35 0 0,1 185,115" fill="none" stroke="#666" stroke-width="2"/>
                                    <!-- Outbound leg - parallel to inbound, offset right -->
                                    <line x1="185" y1="115" x2="185" y2="50" stroke="#666" stroke-width="2"/>
                                    <!-- Turn at outbound end - arc back toward inbound -->
                                    <path d="M185,50 A35,35 0 0,1 150,15" fill="none" stroke="#666" stroke-width="2"/>
                                    <!-- Continuation leg back to inbound intercept -->
                                    <line x1="150" y1="15" x2="115" y2="50" stroke="#666" stroke-width="2" stroke-dasharray="4,4"/>
                                    <line x1="115" y1="50" x2="115" y2="120" stroke="#666" stroke-width="2" stroke-dasharray="4,4"/>
                                    <!-- Intercept back to inbound leg -->
                                    <path d="M115,120 Q115,160 150,180" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="4,4"/>
                                </g>
                                <!-- FIX at center - prominent marker -->
                                <circle cx="150" cy="150" r="10" fill="none" stroke="#FF8200" stroke-width="3" id="hold-fix"/>
                                <circle cx="150" cy="150" r="4" fill="#FF8200"/>
                                <text x="165" y="145" fill="#FF8200" font-size="12" font-weight="bold">FIX</text>
                                <!-- Aircraft symbol (points toward fix) -->
                                <g id="aircraft-symbol" transform="translate(150, 150)">
                                    <line x1="0" y1="0" x2="0" y2="-40" stroke="#00d4ff" stroke-width="3"/>
                                    <polygon points="0,-45 -7,-35 7,-35" fill="#00d4ff"/>
                                    <!-- Fuselage -->
                                    <ellipse cx="0" cy="-20" rx="4" ry="15" fill="#00d4ff"/>
                                </g>
                                <!-- Sector labels -->
                                <text id="label-direct" x="200" y="55" fill="#00ff88" font-size="11" font-weight="bold">DIRECT</text>
                                <text id="label-teardrop" x="230" y="180" fill="#ffd700" font-size="11" font-weight="bold">TEARDROP</text>
                                <text id="label-parallel" x="30" y="180" fill="#00d4ff" font-size="11" font-weight="bold">PARALLEL</text>
                            </svg>
                        </div>
                        <div class="entry-type-display">
                            <div class="entry-type-label">ENTRY TYPE</div>
                            <div class="entry-type-value" id="hold-entry-type">---</div>
                            <div class="entry-type-desc" id="hold-entry-desc"></div>
                        </div>
                        <button class="clear-btn" onclick="clearHoldEntry()">Clear</button>
                    </div>

                    <!-- ISA Calculator -->
                    <div class="section">
                        <div class="section-title">ISA Deviation</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">Altitude (ft)</label>
                                <button class="input-btn" id="isa-alt-btn" onclick="openWeightPicker('isa-alt', 'Altitude', 'ft')" style="max-width:100%">0</button>
                                <input type="hidden" id="isa-alt" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">OAT (°C)</label>
                                <button class="input-btn" id="isa-oat-btn" onclick="openISAPicker()" style="max-width:100%">+15</button>
                                <input type="hidden" id="isa-oat" value="15">
                            </div>
                        </div>
                        <div class="isa-result">
                            <div style="font-size:0.8rem;color:#888;margin-bottom:5px">ISA Temperature at Altitude</div>
                            <div class="isa-temp" id="isa-temp">+15°C</div>
                            <div style="margin-top:15px;font-size:0.8rem;color:#888">ISA Deviation</div>
                            <div class="isa-deviation neutral" id="isa-dev">ISA ±0°C</div>
                        </div>
                        <div style="text-align:center;font-size:0.7rem;color:#666;margin-top:10px">
                            ISA = 15°C - (altitude × 1.98°C per 1000ft)
                        </div>
                        <button class="clear-btn" onclick="clearISA()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ref Tab (Timezone, Scratchpad, SNOWTAM) -->
        <div class="tab-content" id="tab-ref">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: 1fr 1fr;">
                    <!-- Timezone Converter -->
                    <div class="section">
                        <div class="section-title">Timezone Converter</div>
                        <div class="input-grid-2" style="margin-bottom:15px">
                            <div class="input-group">
                                <label class="input-label">Input Time</label>
                                <button class="input-btn" id="tz-input-btn" onclick="openTimePicker('tz-input')" style="max-width:100%">----</button>
                                <input type="hidden" id="tz-input" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Input Zone</label>
                                <select class="fdp-select" id="tz-input-zone" onchange="calculateTimezones()" style="max-width:100%">
                                    <option value="0">UTC</option>
                                    <option value="4" selected>DXB (+4)</option>
                                </select>
                            </div>
                        </div>
                        <div class="tz-converter" id="tz-results">
                            <div class="tz-row">
                                <span class="tz-offset">+0</span>
                                <span class="tz-time" id="tz-utc">--:--</span>
                                <span class="tz-label">UTC</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+3</span>
                                <span class="tz-time" id="tz-ruh">--:--</span>
                                <span class="tz-label">RUH/JED/KWI/BAH</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+3:30</span>
                                <span class="tz-time" id="tz-ika">--:--</span>
                                <span class="tz-label">IKA/MHD/SYZ</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+4</span>
                                <span class="tz-time" id="tz-dxb">--:--</span>
                                <span class="tz-label">DXB/MCT/TBS</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+4:30</span>
                                <span class="tz-time" id="tz-kbl">--:--</span>
                                <span class="tz-label">KBL</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+5</span>
                                <span class="tz-time" id="tz-khi">--:--</span>
                                <span class="tz-label">KHI/LHE/ISB/TAS</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+5:30</span>
                                <span class="tz-time" id="tz-del">--:--</span>
                                <span class="tz-label">DEL/BOM/COK/CMB</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+6</span>
                                <span class="tz-time" id="tz-dac">--:--</span>
                                <span class="tz-label">DAC/ALA</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+7</span>
                                <span class="tz-time" id="tz-bkk">--:--</span>
                                <span class="tz-label">BKK</span>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearTimezones()">Clear</button>
                    </div>

                    <!-- Scratchpad -->
                    <div class="section">
                        <div class="section-title">Scratchpad</div>
                        <div class="scratchpad-container">
                            <textarea class="scratchpad-textarea" id="scratchpad" placeholder="ATIS, Clearances, Notes..."></textarea>
                            <div style="display:flex;gap:10px;margin-top:10px">
                                <button class="preset-btn" style="flex:1" onclick="saveScratchpad()">Save to History</button>
                                <button class="clear-btn" style="flex:1;margin:0" onclick="clearScratchpad()">Clear</button>
                            </div>
                            <div class="scratchpad-history" id="scratchpad-history"></div>
                        </div>
                    </div>
                </div>

                <!-- SNOWTAM Decoder -->
                <div class="section" style="max-width:800px;margin:20px auto 0">
                    <div class="section-title">SNOWTAM / GRF Decoder</div>
                    <textarea class="snowtam-input" id="snowtam-input" placeholder="Paste SNOWTAM or GRF data here...
Example: A) UUEE B) 06L C) 5/5/5 D) 100/100/100 F) 5/5/5 G) XX/XX/XX"></textarea>
                    <button class="preset-btn" style="margin-top:10px" onclick="decodeSnowtam()">Decode</button>
                    <div class="snowtam-decoded" id="snowtam-decoded"></div>
                    <div class="friction-table">
                        <div style="margin-bottom:8px;color:#FF8200">GRF / RCAM Reference (Russian Normative μ)</div>
                        <table>
                            <tr>
                                <th>Code</th>
                                <th>Condition</th>
                                <th>Braking</th>
                                <th>μ (Normative)</th>
                            </tr>
                            <tr><td>6</td><td>Dry</td><td class="grf-good">Good</td><td>0.40+</td></tr>
                            <tr><td>5</td><td>Wet/Frost</td><td class="grf-good">Good-Medium</td><td>0.36-0.39</td></tr>
                            <tr><td>4</td><td>Slush/Dry Snow</td><td class="grf-medium">Medium</td><td>0.30-0.35</td></tr>
                            <tr><td>3</td><td>Wet Snow/Compact</td><td class="grf-medium">Medium-Poor</td><td>0.26-0.29</td></tr>
                            <tr><td>2</td><td>Standing Water</td><td class="grf-poor">Poor</td><td>0.20-0.25</td></tr>
                            <tr><td>1</td><td>Ice</td><td class="grf-bad">Poor-Nil</td><td>&lt;0.20</td></tr>
                            <tr><td>0</td><td>Ice/Water on Ice</td><td class="grf-bad">Nil</td><td>Unreliable</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TIME Tab (ETA, Timezone, Time Calculations) -->
        <div class="tab-content" id="tab-time">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- ETA Countdown -->
                    <div class="section">
                        <div class="section-title">ETA Countdown</div>
                        <div class="utc-display">UTC: <span id="utc-clock">--:--:--</span></div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">ETA (UTC)</label>
                                <button class="input-btn placeholder" id="eta-time-btn" onclick="openTimePicker('eta-time')">0000</button>
                                <input type="hidden" id="eta-time" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">UTC NOW</label>
                                <button class="input-btn placeholder" id="utc-manual-btn" onclick="openTimePicker('utc-manual')">AUTO</button>
                                <input type="hidden" id="utc-manual" value="">
                            </div>
                        </div>
                        <div class="eta-countdown" id="eta-countdown">--:--:--</div>
                        <div class="results-row" style="border: none; padding-top: 10px;">
                            <div class="result-item">
                                <div class="result-label">ELAPSED</div>
                                <div class="result-value" id="time-elapsed" style="color: #00d4ff;">--:--</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">REMAINING</div>
                                <div class="result-value" id="time-remaining" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                        <button class="clear-btn" id="eta-clear">Clear</button>
                    </div>

                    <!-- Timezone Converter (duplicate from REF for quick access) -->
                    <div class="section">
                        <div class="section-title">Timezone Converter</div>
                        <div class="input-grid-2" style="margin-bottom:15px">
                            <div class="input-group">
                                <label class="input-label">Input Time</label>
                                <button class="input-btn" id="time-tz-input-btn" onclick="openTimePicker('time-tz-input')" style="max-width:100%">----</button>
                                <input type="hidden" id="time-tz-input" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Input Zone</label>
                                <select class="fdp-select" id="time-tz-zone" onchange="calculateTimeTabTimezones()" style="max-width:100%">
                                    <option value="0" selected>UTC</option>
                                    <option value="4">DXB (+4)</option>
                                </select>
                            </div>
                        </div>
                        <button class="preset-btn" onclick="setCurrentUTC()" style="margin-bottom: 10px;">Current Time</button>
                        <div class="tz-converter" id="time-tz-results">
                            <div class="tz-row">
                                <span class="tz-offset">+0</span>
                                <span class="tz-time" id="time-tz-utc">--:--</span>
                                <span class="tz-label">UTC</span>
                            </div>
                            <div class="tz-row">
                                <span class="tz-offset">+4</span>
                                <span class="tz-time" id="time-tz-dxb">--:--</span>
                                <span class="tz-label">DXB</span>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearTimeTabTimezones()">Clear</button>
                    </div>
                </div>

                <!-- Speed-Distance-Time Calculator -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Speed-Distance-Time Calculator</div>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Speed (kts)</label>
                            <button class="input-btn" id="sdt-speed-btn" onclick="openWeightPicker('sdt-speed', 'Speed', 'kts')" style="max-width: 100%">---</button>
                            <input type="hidden" id="sdt-speed" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Distance (nm)</label>
                            <button class="input-btn" id="sdt-dist-btn" onclick="openWeightPicker('sdt-dist', 'Distance', 'nm')" style="max-width: 100%">---</button>
                            <input type="hidden" id="sdt-dist" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Time (min)</label>
                            <button class="input-btn" id="sdt-time-btn" onclick="openWeightPicker('sdt-time', 'Time', 'min')" style="max-width: 100%">---</button>
                            <input type="hidden" id="sdt-time" value="">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="preset-btn" onclick="calculateSDT('speed')">Calculate Speed</button>
                        <button class="preset-btn" onclick="calculateSDT('distance')">Calculate Distance</button>
                        <button class="preset-btn" onclick="calculateSDT('time')">Calculate Time</button>
                    </div>
                    <div class="fdp-result-value" id="sdt-result" style="text-align: center; margin-top: 15px; font-size: 1.5rem; color: #00ff88;">---</div>
                    <button class="clear-btn" onclick="clearSDT()">Clear</button>
                </div>

                <!-- Catch-Up Calculator -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Catch-Up Calculator</div>
                    <p style="color: #888; font-size: 0.75rem; text-align: center; margin-bottom: 10px;">
                        Calculate time to catch up or speed required
                    </p>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Distance Ahead (nm)</label>
                            <button class="input-btn" id="catchup-dist-btn" onclick="openWeightPicker('catchup-dist', 'Distance', 'nm')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-dist" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Their GS (kts)</label>
                            <button class="input-btn" id="catchup-their-gs-btn" onclick="openWeightPicker('catchup-their-gs', 'Their GS', 'kts')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-their-gs" value="">
                        </div>
                    </div>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Your GS (kts)</label>
                            <button class="input-btn" id="catchup-your-gs-btn" onclick="openWeightPicker('catchup-your-gs', 'Your GS', 'kts')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-your-gs" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Time Limit (min)</label>
                            <button class="input-btn" id="catchup-time-btn" onclick="openWeightPicker('catchup-time', 'Time', 'min')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-time" value="">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="preset-btn" onclick="calculateCatchUp('time')">Time to Catch Up</button>
                        <button class="preset-btn" onclick="calculateCatchUp('speed')">Speed Required</button>
                    </div>
                    <div class="fdp-result-value" id="catchup-result" style="text-align: center; margin-top: 15px; font-size: 1.3rem; color: #00ff88;">---</div>
                    <button class="clear-btn" onclick="clearCatchUp()">Clear</button>
                </div>
            </div>
        </div>

        <!-- NOTES Tab (Scratchpad) -->
        <div class="tab-content" id="tab-notes">
            <div class="fdp-container">
                <div class="section" style="max-width: 800px; margin: 0 auto;">
                    <div class="section-title">Scratchpad</div>
                    <div class="scratchpad-container">
                        <textarea class="scratchpad-textarea" id="notes-scratchpad" placeholder="ATIS, Clearances, Notes..." style="min-height: 300px;"></textarea>
                        <div style="display:flex;gap:10px;margin-top:10px">
                            <button class="preset-btn" style="flex:1" onclick="saveNotesScratchpad()">Save to History</button>
                            <button class="clear-btn" style="flex:1;margin:0" onclick="clearNotesScratchpad()">Clear</button>
                        </div>
                        <div class="scratchpad-history" id="notes-scratchpad-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SET Tab (Settings) -->
        <div class="tab-content" id="tab-set">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- Quick Reset -->
                    <div class="section">
                        <div class="section-title">Quick Reset</div>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                            Reset all entries and timers. Notes will be preserved.
                        </p>
                        <button class="clear-btn" style="width: 100%; padding: 15px; font-size: 1.1rem;" onclick="quickResetAll()">
                            Reset All Data
                        </button>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                            <button class="preset-btn" style="width: 100%;" onclick="exportAllData()">
                                Export to Markdown
                            </button>
                        </div>
                    </div>

                    <!-- Preferences -->
                    <div class="section">
                        <div class="section-title">Preferences</div>
                        <div class="fdp-row" style="flex-direction: column; gap: 15px;">
                            <div class="fdp-field">
                                <label class="fdp-label">Default Aircraft</label>
                                <select class="fdp-select" id="pref-aircraft" onchange="savePreferences()" style="max-width: 100%;">
                                    <option value="B738">B738</option>
                                    <option value="B38M">B38M</option>
                                    <option value="B39M">B39M</option>
                                </select>
                            </div>
                            <div class="fdp-field">
                                <label class="fdp-label">Default Timezone</label>
                                <select class="fdp-select" id="pref-timezone" onchange="savePreferences()" style="max-width: 100%;">
                                    <option value="0">UTC</option>
                                    <option value="4" selected>DXB (+4)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Status -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Data Status</div>
                    <div class="fdp-results" style="margin-top: 0;">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Schedule Sectors</div>
                                <div class="fdp-result-value" id="status-sectors" style="color: #FF8200;">0</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Active Timers</div>
                                <div class="fdp-result-value" id="status-timers" style="color: #00ff88;">0</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Notes Saved</div>
                                <div class="fdp-result-value" id="status-notes" style="color: #00d4ff;">0</div>
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 0.75rem; margin-top: 15px;">
                        All data is stored locally in your browser and persists across sessions.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Number Picker Modal -->
    <div class="modal-overlay" id="number-picker-modal">
        <div class="number-picker">
            <div class="picker-title" id="picker-title">Set Value</div>
            <div class="picker-display">
                <span class="picker-value" id="picker-value">0</span>
                <span class="picker-unit" id="picker-unit"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="pickerAppend('1')">1</button>
                <button class="picker-btn" onclick="pickerAppend('2')">2</button>
                <button class="picker-btn" onclick="pickerAppend('3')">3</button>
                <button class="picker-btn" onclick="pickerAppend('4')">4</button>
                <button class="picker-btn" onclick="pickerAppend('5')">5</button>
                <button class="picker-btn" onclick="pickerAppend('6')">6</button>
                <button class="picker-btn" onclick="pickerAppend('7')">7</button>
                <button class="picker-btn" onclick="pickerAppend('8')">8</button>
                <button class="picker-btn" onclick="pickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="pickerClear()">C</button>
                <button class="picker-btn" onclick="pickerAppend('0')">0</button>
                <button class="picker-btn" onclick="pickerBackspace()">&larr;</button>
                <button class="picker-btn" onclick="pickerAppend('00')" style="font-size:1rem">00</button>
                <button class="picker-btn" onclick="pickerAppend('000')" style="font-size:0.9rem">000</button>
                <button class="picker-btn" onclick="pickerAppend('0000')" style="font-size:0.8rem">0000</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closePicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Aircraft Picker Modal -->
    <div class="modal-overlay" id="aircraft-picker-modal">
        <div class="number-picker" style="max-width: 280px;">
            <div class="picker-title">Select Aircraft</div>
            <div style="display: flex; flex-direction: column; gap: 10px; padding: 15px;">
                <button class="picker-btn" id="ac-pick-b738" onclick="selectAircraftPick('B738')" style="padding: 15px; font-size: 1.2rem;">B738</button>
                <button class="picker-btn" id="ac-pick-b38m" onclick="selectAircraftPick('B38M')" style="padding: 15px; font-size: 1.2rem;">B38M</button>
                <button class="picker-btn" id="ac-pick-b39m" onclick="selectAircraftPick('B39M')" style="padding: 15px; font-size: 1.2rem;">B39M</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeAircraftPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Flight Number Picker Modal -->
    <div class="modal-overlay" id="flight-picker-modal">
        <div class="number-picker" style="max-width: 320px;">
            <div class="picker-title">Flight Number</div>
            <div class="picker-display">
                <span style="color: #888; font-size: 1.4rem;">FZ</span>
                <span class="picker-value" id="flight-picker-value" style="font-size: 1.8rem;">___</span>
                <span id="flight-picker-suffix" style="font-size: 1.4rem; color: #FF8200; margin-left: 2px;"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="flightPickerAppend('1')">1</button>
                <button class="picker-btn" onclick="flightPickerAppend('2')">2</button>
                <button class="picker-btn" onclick="flightPickerAppend('3')">3</button>
                <button class="picker-btn" onclick="flightPickerAppend('4')">4</button>
                <button class="picker-btn" onclick="flightPickerAppend('5')">5</button>
                <button class="picker-btn" onclick="flightPickerAppend('6')">6</button>
                <button class="picker-btn" onclick="flightPickerAppend('7')">7</button>
                <button class="picker-btn" onclick="flightPickerAppend('8')">8</button>
                <button class="picker-btn" onclick="flightPickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="flightPickerClear()">C</button>
                <button class="picker-btn" onclick="flightPickerAppend('0')">0</button>
                <button class="picker-btn" onclick="flightPickerBackspace()">&larr;</button>
            </div>
            <div style="display: flex; gap: 10px; padding: 10px 15px;">
                <button class="picker-btn" id="flight-suffix-none" onclick="setFlightSuffix('')" style="flex: 1; padding: 12px; background: rgba(255,130,0,0.3);">None</button>
                <button class="picker-btn" id="flight-suffix-a" onclick="setFlightSuffix('A')" style="flex: 1; padding: 12px;">A</button>
                <button class="picker-btn" id="flight-suffix-b" onclick="setFlightSuffix('B')" style="flex: 1; padding: 12px;">B</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeFlightPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmFlightPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Tail Number Picker Modal -->
    <div class="modal-overlay" id="tail-picker-modal">
        <div class="number-picker" style="max-width: 320px;">
            <div class="picker-title">Tail Number</div>
            <div class="picker-display">
                <span style="color: #888; font-size: 1.4rem;">A6-</span>
                <span class="picker-value" id="tail-picker-value" style="font-size: 1.8rem;">___</span>
            </div>
            <div class="picker-buttons" style="grid-template-columns: repeat(5, 1fr);">
                <button class="picker-btn" onclick="tailPickerAppend('F')">F</button>
                <button class="picker-btn" onclick="tailPickerAppend('E')">E</button>
                <button class="picker-btn" onclick="tailPickerAppend('M')">M</button>
                <button class="picker-btn" onclick="tailPickerAppend('N')">N</button>
                <button class="picker-btn" onclick="tailPickerAppend('1')">1</button>
                <button class="picker-btn" onclick="tailPickerAppend('A')">A</button>
                <button class="picker-btn" onclick="tailPickerAppend('B')">B</button>
                <button class="picker-btn" onclick="tailPickerAppend('C')">C</button>
                <button class="picker-btn" onclick="tailPickerAppend('D')">D</button>
                <button class="picker-btn" onclick="tailPickerAppend('2')">2</button>
                <button class="picker-btn" onclick="tailPickerAppend('G')">G</button>
                <button class="picker-btn" onclick="tailPickerAppend('H')">H</button>
                <button class="picker-btn" onclick="tailPickerAppend('I')">I</button>
                <button class="picker-btn" onclick="tailPickerAppend('J')">J</button>
                <button class="picker-btn" onclick="tailPickerAppend('3')">3</button>
                <button class="picker-btn" onclick="tailPickerAppend('K')">K</button>
                <button class="picker-btn" onclick="tailPickerAppend('L')">L</button>
                <button class="picker-btn" onclick="tailPickerAppend('O')">O</button>
                <button class="picker-btn" onclick="tailPickerAppend('P')">P</button>
                <button class="picker-btn" onclick="tailPickerAppend('4')">4</button>
                <button class="picker-btn" onclick="tailPickerAppend('Q')">Q</button>
                <button class="picker-btn" onclick="tailPickerAppend('R')">R</button>
                <button class="picker-btn" onclick="tailPickerAppend('S')">S</button>
                <button class="picker-btn" onclick="tailPickerAppend('T')">T</button>
                <button class="picker-btn" onclick="tailPickerAppend('5')">5</button>
                <button class="picker-btn" onclick="tailPickerAppend('U')">U</button>
                <button class="picker-btn" onclick="tailPickerAppend('V')">V</button>
                <button class="picker-btn" onclick="tailPickerAppend('W')">W</button>
                <button class="picker-btn" onclick="tailPickerAppend('X')">X</button>
                <button class="picker-btn" onclick="tailPickerAppend('6')">6</button>
                <button class="picker-btn" onclick="tailPickerAppend('Y')">Y</button>
                <button class="picker-btn" onclick="tailPickerAppend('Z')">Z</button>
                <button class="picker-btn clear" onclick="tailPickerClear()">C</button>
                <button class="picker-btn" onclick="tailPickerBackspace()">&larr;</button>
                <button class="picker-btn" onclick="tailPickerAppend('7')">7</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeTailPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmTailPicker()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ============ TAB SWITCHING ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // ============ NUMBER PICKER ============
        let pickerCallback = null;
        let pickerValue = '';
        let pickerMaxLength = 6;
        let pickerFormatCommas = false;
        let pickerFirstInput = true; // Track if this is first input since opening

        function openPicker(title, unit, currentValue, maxLength, formatCommas, callback) {
            pickerCallback = callback;
            pickerValue = currentValue.toString().replace(/,/g, '');
            pickerMaxLength = maxLength;
            pickerFormatCommas = formatCommas;
            pickerFirstInput = true; // Reset on open
            document.getElementById('picker-title').textContent = title;
            document.getElementById('picker-unit').textContent = unit || '';
            updatePickerDisplay();
            document.getElementById('number-picker-modal').classList.add('active');
        }

        function updatePickerDisplay() {
            let display = pickerValue || '0';
            if (pickerFormatCommas && display !== '0') {
                display = parseInt(display, 10).toLocaleString();
            }
            document.getElementById('picker-value').textContent = display;
        }

        function closePicker() {
            document.getElementById('number-picker-modal').classList.remove('active');
            pickerCallback = null;
        }

        function pickerAppend(digit) {
            // If this is first input and there's existing value, clear it first
            if (pickerFirstInput && pickerValue.length > 0) {
                pickerValue = '';
            }
            pickerFirstInput = false;

            // Handle multi-digit append (00, 000, 0000)
            const newLength = pickerValue.length + digit.length;
            if (newLength <= pickerMaxLength) {
                pickerValue += digit;
                updatePickerDisplay();
            } else if (pickerValue.length < pickerMaxLength) {
                // Append as many digits as possible
                const remaining = pickerMaxLength - pickerValue.length;
                pickerValue += digit.substring(0, remaining);
                updatePickerDisplay();
            }
        }

        function pickerClear() {
            pickerValue = '';
            pickerFirstInput = false;
            updatePickerDisplay();
        }

        function pickerBackspace() {
            pickerFirstInput = false;
            pickerValue = pickerValue.slice(0, -1);
            updatePickerDisplay();
        }

        function confirmPicker() {
            if (pickerCallback) {
                pickerCallback(pickerValue);
            }
            closePicker();
        }

        // Time picker (HHMM format)
        function openTimePicker(fieldId) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker('Enter Time (HHMM)', '', currentVal, 4, false, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? val.padStart(4, '0') : (fieldId === 'utc-manual' ? 'AUTO' : (fieldId.startsWith('layover-') ? '----' : '----'));
                    btn.classList.toggle('placeholder', !val);
                }
                // Handle sector OOOI (s1-out, s1-off, s2-on, etc.)
                const sectorMatch = fieldId.match(/^s(\d)-(out|off|on|in)$/);
                if (sectorMatch) {
                    calculateSectorTimes(parseInt(sectorMatch[1]));
                    // Also recalculate next sector's turnaround if exists
                    const nextSector = parseInt(sectorMatch[1]) + 1;
                    if (nextSector <= currentSectorCount) {
                        calculateSectorTimes(nextSector);
                    }
                    saveSchedule();
                }
                else if (fieldId.startsWith('oooi-')) calculateOOOI();
                else if (fieldId === 'eta-time') { etaManualStartTime = null; calculateETA(); }
                else if (fieldId === 'utc-manual') { etaManualStartTime = val ? Date.now() : null; saveETA(); calculateETA(); }
                else if (fieldId === 'fdp-report' || fieldId === 'fdp-actual-report') calculateFDP();
                else if (fieldId.startsWith('sector-') || fieldId.startsWith('actual-')) {
                    calculateSectorTurnarounds();
                    estimateDutyEnd();
                }
                else if (fieldId.startsWith('layover-')) calculateLayover();
                else if (fieldId.startsWith('s') && fieldId.includes('-std')) {
                    // STD changed - update schedule
                    saveSchedule();
                }
                else if (fieldId.startsWith('time-tz-')) calculateTimeTabTimezones();
            });
        }

        // Weight picker (with commas)
        function openWeightPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('calc-')) {
                    calculateTOW();
                    calculateMLF();
                }
                else if (fieldId === 'opt-acc' || fieldId === 'airfield-elev') calculateACC();
                else if (fieldId.startsWith('xwind-')) calculateCrosswind();
                else if (fieldId.startsWith('hold-')) calculateHoldEntry();
                else if (fieldId === 'isa-alt') calculateISA();
                else if (fieldId.startsWith('sdt-')) autoCalculateSDT();
                else if (fieldId.startsWith('catchup-')) {
                    // Auto-update catch-up display when values change
                }
            });
        }

        // ============ AIRCRAFT & WEIGHT LIMITS ============
        const aircraftLimits = {
            'B738': {
                name: 'B737-800',
                mtw: 79242,
                mtow: 79015,
                mlw: 66360,
                mzfw: 62731,
                sfp: 'SFP1'
            },
            'B38M': {
                name: 'B737-8',
                mtw: 82417,
                mtow: 82190,
                mlw: 69308,
                mzfw: 65952,
                sfp: 'SFP1'
            },
            'B39M': {
                name: 'B737-9',
                mtw: 88541,
                mtow: 88314,
                mlw: 74343,
                mzfw: 70987,
                sfp: 'SFP2'
            }
        };
        let selectedAircraft = 'B738';

        function selectAircraft(type) {
            selectedAircraft = type;
            // Update all aircraft selector buttons (TOW and MLF sections)
            document.querySelectorAll('.aircraft-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('ac-' + type.toLowerCase()).classList.add('active');
            document.getElementById('tow-ac-' + type.toLowerCase()).classList.add('active');

            // Update MLW display
            document.getElementById('mlw-display').textContent = aircraftLimits[type].mlw.toLocaleString();

            // Update limit displays
            updateLimitDisplays();

            // Recalculate
            calculateTOW();
            calculateMLF();
        }

        function updateLimitDisplays() {
            const limits = aircraftLimits[selectedAircraft];
            document.getElementById('mtw-limit').textContent = 'MTW: ' + limits.mtw.toLocaleString();
            document.getElementById('mtow-limit').textContent = 'MTOW: ' + limits.mtow.toLocaleString();
            document.getElementById('mlw-limit').textContent = 'MLW: ' + limits.mlw.toLocaleString();
            document.getElementById('mzfw-limit').textContent = 'MZFW: ' + limits.mzfw.toLocaleString();
        }

        function calculateMLF() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const mlw = aircraftLimits[selectedAircraft].mlw;

            if (zfw === 0) {
                document.getElementById('mlf-result').textContent = '---';
            } else {
                const maxFuel = mlw - zfw;
                document.getElementById('mlf-result').textContent = maxFuel.toLocaleString() + ' kg';
            }
        }

        // ============ FUEL CALCULATOR ============
        function openFuelPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                calculateFuel();
            });
        }

        function openSGPicker() {
            const currentVal = document.getElementById('fuel-sg').value || '800';
            openPicker('SG (e.g. 800 = 0.800)', '', currentVal, 3, false, (val) => {
                document.getElementById('fuel-sg').value = val;
                const btn = document.getElementById('fuel-sg-btn');
                if (btn) {
                    const sg = parseInt(val, 10) || 800;
                    btn.textContent = '0.' + sg.toString().padStart(3, '0');
                }
                calculateFuel();
            });
        }

        function openAdjustmentPicker() {
            const currentVal = document.getElementById('fuel-adj').value || '';
            const absVal = currentVal.replace('-', '');
            openPicker('Adjustment (+/-)', 'kg', absVal, 5, true, (val) => {
                const adj = parseInt(val, 10) || 0;
                if (adj !== 0) {
                    // Default to positive, can toggle with +/- button
                    document.getElementById('fuel-adj').value = val;
                    const btn = document.getElementById('fuel-adj-btn');
                    if (btn) {
                        btn.textContent = '+' + adj.toLocaleString();
                    }
                } else {
                    document.getElementById('fuel-adj').value = '';
                    document.getElementById('fuel-adj-btn').textContent = '0';
                }
                calculateFuel();
            });
        }

        function toggleAdjustmentSign() {
            const val = document.getElementById('fuel-adj').value;
            if (!val) return;
            if (val.startsWith('-')) {
                document.getElementById('fuel-adj').value = val.substring(1);
                document.getElementById('fuel-adj-btn').textContent = '+' + parseInt(val.substring(1), 10).toLocaleString();
            } else {
                document.getElementById('fuel-adj').value = '-' + val;
                document.getElementById('fuel-adj-btn').textContent = '-' + parseInt(val, 10).toLocaleString();
            }
            calculateFuel();
        }

        function loadFuel() {
            const saved = localStorage.getItem('flightFuel');
            if (saved) {
                try {
                    const fuel = JSON.parse(saved);
                    // Restore values
                    if (fuel.req) {
                        document.getElementById('fuel-req').value = fuel.req;
                        document.getElementById('fuel-req-btn').textContent = parseInt(fuel.req, 10).toLocaleString();
                        document.getElementById('fuel-req-btn').classList.remove('placeholder');
                    }
                    if (fuel.pre) {
                        document.getElementById('fuel-pre').value = fuel.pre;
                        document.getElementById('fuel-pre-btn').textContent = parseInt(fuel.pre, 10).toLocaleString();
                        document.getElementById('fuel-pre-btn').classList.remove('placeholder');
                    }
                    if (fuel.sg) {
                        document.getElementById('fuel-sg').value = fuel.sg;
                        document.getElementById('fuel-sg-btn').textContent = '0.' + fuel.sg.toString().padStart(3, '0');
                    }
                    if (fuel.actual) {
                        document.getElementById('fuel-actual').value = fuel.actual;
                        document.getElementById('fuel-actual-btn').textContent = parseInt(fuel.actual, 10).toLocaleString();
                        document.getElementById('fuel-actual-btn').classList.remove('placeholder');
                    }
                    if (fuel.left) {
                        document.getElementById('tank-left').value = fuel.left;
                        document.getElementById('tank-left-btn').textContent = parseInt(fuel.left, 10).toLocaleString();
                    }
                    if (fuel.right) {
                        document.getElementById('tank-right').value = fuel.right;
                        document.getElementById('tank-right-btn').textContent = parseInt(fuel.right, 10).toLocaleString();
                    }
                    if (fuel.adj) {
                        document.getElementById('fuel-adj').value = fuel.adj;
                        const adj = parseInt(fuel.adj, 10);
                        document.getElementById('fuel-adj-btn').textContent = (adj >= 0 ? '+' : '') + adj.toLocaleString();
                        document.getElementById('fuel-adj-btn').onclick = function() { toggleAdjustmentSign(); };
                    }
                    calculateFuel();
                } catch (e) {}
            }
        }

        function saveFuel() {
            const fuel = {
                req: document.getElementById('fuel-req').value,
                pre: document.getElementById('fuel-pre').value,
                sg: document.getElementById('fuel-sg').value,
                actual: document.getElementById('fuel-actual').value,
                left: document.getElementById('tank-left').value,
                right: document.getElementById('tank-right').value,
                adj: document.getElementById('fuel-adj').value
            };
            localStorage.setItem('flightFuel', JSON.stringify(fuel));
        }

        function setFullTanks() {
            // B737 max fuel: 20,200 kg (wing tanks 3,700 per side = 7,400 + center tank 12,800)
            document.getElementById('fuel-req').value = '20200';
            document.getElementById('fuel-req-btn').textContent = '20,200';
            document.getElementById('fuel-req-btn').classList.remove('placeholder');
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            calculateFuel();
            saveFuel();
        }

        function resetTankSplit() {
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            calculateFuel();
            saveFuel();
        }

        function calculateFuel() {
            const fuelReq = parseInt(document.getElementById('fuel-req').value, 10) || 0;
            const preUplift = parseInt(document.getElementById('fuel-pre').value, 10) || 0;
            const sgVal = parseInt(document.getElementById('fuel-sg').value, 10) || 800;
            const sg = sgVal / 1000; // Convert 800 to 0.800
            const actualUplift = parseInt(document.getElementById('fuel-actual').value, 10) || 0;
            const tankLeft = parseInt(document.getElementById('tank-left').value, 10) || 3700;
            const tankRight = parseInt(document.getElementById('tank-right').value, 10) || 3700;
            const adjustment = parseInt(document.getElementById('fuel-adj').value, 10) || 0;

            // Tank split - center tank calculation
            const centerTank = fuelReq - tankLeft - tankRight;
            document.getElementById('tank-center').textContent = fuelReq > 0 ?
                (centerTank >= 0 ? centerTank.toLocaleString() + ' kg' : 'Wings exceed total!') : '---';
            if (centerTank < 0 && fuelReq > 0) {
                document.getElementById('tank-center').className = 'fdp-result-value red';
            } else {
                document.getElementById('tank-center').className = 'fdp-result-value green';
            }

            // Fuel Summary
            document.getElementById('summary-req').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';
            document.getElementById('summary-pre').textContent = preUplift > 0 ? preUplift.toLocaleString() + ' kg' : '--- kg';

            const upliftReq = fuelReq - preUplift;
            document.getElementById('summary-uplift-req').textContent = fuelReq > 0 ? upliftReq.toLocaleString() + ' kg' : '--- kg';

            // Departure fuel
            document.getElementById('summary-dep').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';

            const finalDep = fuelReq + adjustment;
            if (fuelReq > 0) {
                document.getElementById('summary-final-dep').textContent = finalDep.toLocaleString() + ' kg';
            } else {
                document.getElementById('summary-final-dep').textContent = '--- kg';
            }

            // Uplift verification
            // Calculate uplift in litres: uplift kg / SG = litres
            const calcUpliftLitres = upliftReq > 0 && sg > 0 ? Math.round(upliftReq / sg) : 0;

            document.getElementById('calc-uplift').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';
            document.getElementById('verify-actual').textContent = actualUplift > 0 ? actualUplift.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-calc').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';

            // 3% limits
            const lowLimit = Math.round(calcUpliftLitres * 0.97);
            const highLimit = Math.round(calcUpliftLitres * 1.03);
            document.getElementById('limit-low').textContent = calcUpliftLitres > 0 ? lowLimit.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-high').textContent = calcUpliftLitres > 0 ? highLimit.toLocaleString() + ' L' : '--- L';

            // Percentage difference
            if (calcUpliftLitres > 0 && actualUplift > 0) {
                const diff = ((actualUplift - calcUpliftLitres) / calcUpliftLitres) * 100;
                const diffEl = document.getElementById('uplift-diff');
                diffEl.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';

                // Color based on range
                if (Math.abs(diff) <= 3) {
                    diffEl.className = 'fdp-result-value green';
                } else if (Math.abs(diff) <= 5) {
                    diffEl.className = 'fdp-result-value yellow';
                } else {
                    diffEl.className = 'fdp-result-value red';
                }

                // Status message
                const statusEl = document.getElementById('uplift-status');
                if (actualUplift >= lowLimit && actualUplift <= highLimit) {
                    statusEl.innerHTML = '<div class="fdp-warning" style="background:rgba(0,200,80,0.2);border-color:rgba(0,200,80,0.5);color:#00ff88">Actual uplift within 3% tolerance</div>';
                } else {
                    statusEl.innerHTML = '<div class="fdp-danger">Actual uplift outside 3% tolerance - verify figures</div>';
                }
            } else {
                document.getElementById('uplift-diff').textContent = '--- %';
                document.getElementById('uplift-diff').className = 'fdp-result-value';
                document.getElementById('uplift-status').innerHTML = '';
            }

            saveFuel();
        }

        // ============ FUEL UNIT CONVERTER ============
        // Constants: 1 US gallon = 3.78541 litres, Jet-A density ~0.800 kg/L = 1.764 lbs/L
        const LITRES_PER_GALLON = 3.78541;
        const LBS_PER_LITRE = 1.764; // at SG 0.800

        function openConverterPicker(unit) {
            const fieldId = 'conv-' + unit;
            const currentVal = document.getElementById(fieldId).value || '';
            const titles = {
                'litres': 'Enter Litres',
                'gallons': 'Enter US Gallons',
                'lbs': 'Enter Pounds'
            };
            const units = {
                'litres': 'L',
                'gallons': 'gal',
                'lbs': 'lbs'
            };
            openPicker(titles[unit], units[unit], currentVal, 7, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                }
                calculateConverter(unit, parseInt(val, 10) || 0);
            });
        }

        function calculateConverter(sourceUnit, value) {
            let litres, gallons, lbs;

            if (sourceUnit === 'litres') {
                litres = value;
                gallons = Math.round(litres / LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'gallons') {
                gallons = value;
                litres = Math.round(gallons * LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'lbs') {
                lbs = value;
                litres = Math.round(lbs / LBS_PER_LITRE);
                gallons = Math.round(litres / LITRES_PER_GALLON);
            }

            // Update all fields
            document.getElementById('conv-litres').value = litres || '';
            document.getElementById('conv-gallons').value = gallons || '';
            document.getElementById('conv-lbs').value = lbs || '';

            document.getElementById('conv-litres-btn').textContent = litres ? litres.toLocaleString() : '0';
            document.getElementById('conv-gallons-btn').textContent = gallons ? gallons.toLocaleString() : '0';
            document.getElementById('conv-lbs-btn').textContent = lbs ? lbs.toLocaleString() : '0';
        }

        // ============ LAYOVER CALCULATOR ============
        function getLayoverOffset() {
            return parseFloat(document.getElementById('layover-offset').value) || 0;
        }

        function layoverUtcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLayoverOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function subtractTime(timeStr, hoursToSubtract, minsToSubtract) {
            const time = parseTime(timeStr);
            if (!time) return null;
            let totalMins = time.hours * 60 + time.minutes - (hoursToSubtract * 60) - minsToSubtract;
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function calculateLayover() {
            const stdStr = document.getElementById('layover-std').value;
            const pickupStr = document.getElementById('layover-pickup').value || '0130';

            // Update button displays
            const stdBtn = document.getElementById('layover-std-btn');
            stdBtn.textContent = stdStr ? stdStr.padStart(4, '0') : '----';

            const pickupBtn = document.getElementById('layover-pickup-btn');
            pickupBtn.textContent = pickupStr.padStart(4, '0');

            const std = parseTime(stdStr);
            const pickup = parseTime(pickupStr);

            if (!std) {
                document.getElementById('layover-std-local').textContent = '--:--';
                document.getElementById('layover-std-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-hotel-local').textContent = '--:--';
                document.getElementById('layover-hotel-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-wake-local').textContent = '--:--';
                document.getElementById('layover-wake-utc').textContent = 'UTC: --:--';
                return;
            }

            // STD display (Local prominent, UTC secondary)
            const stdFormatted = stdStr.padStart(4, '0');
            const stdUtcDisplay = stdFormatted.substring(0, 2) + ':' + stdFormatted.substring(2);
            document.getElementById('layover-std-local').textContent = layoverUtcToLocal(stdStr);
            document.getElementById('layover-std-utc').textContent = 'UTC: ' + stdUtcDisplay;

            // Hotel departure = STD - pickup time
            const pickupHours = pickup ? pickup.hours : 1;
            const pickupMins = pickup ? pickup.minutes : 30;
            const hotelUTC = subtractTime(stdStr, pickupHours, pickupMins);
            if (hotelUTC) {
                const hotelUtcDisplay = hotelUTC.substring(0, 2) + ':' + hotelUTC.substring(2);
                document.getElementById('layover-hotel-local').textContent = layoverUtcToLocal(hotelUTC);
                document.getElementById('layover-hotel-utc').textContent = 'UTC: ' + hotelUtcDisplay;

                // Wake up = Hotel departure - 1 hour
                const wakeUTC = subtractTime(hotelUTC, 1, 0);
                if (wakeUTC) {
                    const wakeUtcDisplay = wakeUTC.substring(0, 2) + ':' + wakeUTC.substring(2);
                    document.getElementById('layover-wake-local').textContent = layoverUtcToLocal(wakeUTC);
                    document.getElementById('layover-wake-utc').textContent = 'UTC: ' + wakeUtcDisplay;
                }
            }

            saveLayover();
        }

        function loadLayover() {
            const saved = localStorage.getItem('flightLayover');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.std) {
                        document.getElementById('layover-std').value = data.std;
                        document.getElementById('layover-std-btn').textContent = data.std.padStart(4, '0');
                    }
                    if (data.pickup) {
                        document.getElementById('layover-pickup').value = data.pickup;
                        document.getElementById('layover-pickup-btn').textContent = data.pickup.padStart(4, '0');
                    }
                    if (data.offset !== undefined) {
                        document.getElementById('layover-offset').value = data.offset;
                    }
                    calculateLayover();
                } catch (e) {}
            }
        }

        function saveLayover() {
            const data = {
                std: document.getElementById('layover-std').value,
                pickup: document.getElementById('layover-pickup').value,
                offset: document.getElementById('layover-offset').value
            };
            localStorage.setItem('flightLayover', JSON.stringify(data));
        }

        // ============ DEFAULT TIMERS ============
        const defaultTimers = [
            { name: 'APU', type: 'countdown', hours: 0, minutes: 11 },
            { name: 'APU Start', type: 'countdown', hours: 3, minutes: 0 },
            { name: 'Ctrl Rest', type: 'countdown', hours: 0, minutes: 30 },
            { name: 'Timer 4', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 5', type: 'stopwatch', hours: 0, minutes: 0 }
        ];

        let timers = [];
        let animationFrameId = null;
        let etaManualStartTime = null;

        // ============ TIMER STATE ============
        function loadState() {
            const saved = localStorage.getItem('flightTimers');
            if (saved) {
                try {
                    timers = JSON.parse(saved);
                    const now = Date.now();
                    timers.forEach((timer) => {
                        if (timer.running && timer.lastUpdate) {
                            const elapsed = now - timer.lastUpdate;
                            if (timer.type === 'countdown') {
                                timer.remaining = Math.max(0, timer.remaining - elapsed);
                            } else {
                                timer.elapsed = (timer.elapsed || 0) + elapsed;
                            }
                        }
                        if (timer.running) {
                            timer.lastUpdate = now;
                        }
                    });
                } catch (e) {
                    timers = JSON.parse(JSON.stringify(defaultTimers));
                }
            } else {
                timers = JSON.parse(JSON.stringify(defaultTimers));
            }

            timers.forEach((timer) => {
                if (timer.remaining === undefined) {
                    timer.remaining = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
                if (timer.elapsed === undefined) {
                    timer.elapsed = 0;
                }
                if (timer.initialTime === undefined) {
                    timer.initialTime = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
            });
        }

        function saveState() {
            const now = Date.now();
            timers.forEach(timer => {
                if (timer.running) {
                    timer.lastUpdate = now;
                }
            });
            localStorage.setItem('flightTimers', JSON.stringify(timers));
        }

        // ============ OOOI ============
        function loadOOOI() {
            // Load OOOI data for all 4 sectors
            const saved = localStorage.getItem('flightOOOI');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    for (let s = 1; s <= 4; s++) {
                        const sectorData = data['s' + s] || {};
                        ['out', 'off', 'on', 'in'].forEach(field => {
                            const val = sectorData[field] || '';
                            const el = document.getElementById(`s${s}-${field}`);
                            if (el) {
                                el.value = val;
                                const btn = document.getElementById(`s${s}-${field}-btn`);
                                if (btn) {
                                    btn.textContent = val ? val.padStart(4, '0') : '----';
                                }
                            }
                        });
                        calculateSectorTimes(s);
                    }
                } catch (e) {
                    console.log('Error loading OOOI:', e);
                }
            }
        }

        function saveOOOI() {
            const data = {};
            for (let s = 1; s <= 4; s++) {
                data['s' + s] = {
                    out: document.getElementById(`s${s}-out`)?.value || '',
                    off: document.getElementById(`s${s}-off`)?.value || '',
                    on: document.getElementById(`s${s}-on`)?.value || '',
                    in: document.getElementById(`s${s}-in`)?.value || ''
                };
            }
            localStorage.setItem('flightOOOI', JSON.stringify(data));
        }

        function parseTime(str) {
            if (!str || str.length < 3) return null;
            str = str.padStart(4, '0');
            const hours = parseInt(str.substring(0, 2), 10);
            const minutes = parseInt(str.substring(2, 4), 10);
            if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return null;
            return { hours, minutes };
        }

        function timeDiff(start, end) {
            if (!start || !end) return null;
            let startMins = start.hours * 60 + start.minutes;
            let endMins = end.hours * 60 + end.minutes;
            if (endMins < startMins) {
                endMins += 24 * 60;
            }
            return endMins - startMins;
        }

        function formatMinutes(mins) {
            if (mins === null) return '--:--';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function calculateSectorTimes(sectorNum) {
            const out = parseTime(document.getElementById(`s${sectorNum}-out`)?.value);
            const off = parseTime(document.getElementById(`s${sectorNum}-off`)?.value);
            const on = parseTime(document.getElementById(`s${sectorNum}-on`)?.value);
            const inn = parseTime(document.getElementById(`s${sectorNum}-in`)?.value);

            const blockEl = document.getElementById(`s${sectorNum}-block`);
            const flightEl = document.getElementById(`s${sectorNum}-flight`);

            if (blockEl) blockEl.textContent = formatMinutes(timeDiff(out, inn));
            if (flightEl) flightEl.textContent = formatMinutes(timeDiff(off, on));

            // Calculate turnaround from previous sector
            if (sectorNum > 1) {
                const prevIn = parseTime(document.getElementById(`s${sectorNum - 1}-in`)?.value);
                const currOut = out;
                const taEl = document.getElementById(`sector-${sectorNum}-turnaround`);
                if (taEl && prevIn && currOut) {
                    taEl.textContent = 'T/A: ' + formatMinutes(timeDiff(prevIn, currOut));
                    taEl.style.display = 'inline';
                }
            }

            saveOOOI();
        }

        function calculateOOOI() {
            // Calculate times for all visible sectors
            for (let s = 1; s <= currentSectorCount; s++) {
                calculateSectorTimes(s);
            }
        }

        // ============ ETA ============
        function loadETA() {
            const saved = localStorage.getItem('flightETA');
            if (saved) {
                try {
                    const eta = JSON.parse(saved);
                    document.getElementById('eta-time').value = eta.time || '';
                    document.getElementById('utc-manual').value = eta.manual || '';

                    const etaBtn = document.getElementById('eta-time-btn');
                    etaBtn.textContent = eta.time ? eta.time.padStart(4, '0') : '0000';
                    etaBtn.classList.toggle('placeholder', !eta.time);

                    const manualBtn = document.getElementById('utc-manual-btn');
                    manualBtn.textContent = eta.manual ? eta.manual.padStart(4, '0') : 'AUTO';
                    manualBtn.classList.toggle('placeholder', !eta.manual);

                    if (eta.manual && eta.manualStartTime) {
                        etaManualStartTime = eta.manualStartTime;
                    }
                } catch (e) {}
            }
        }

        function saveETA() {
            const eta = {
                time: document.getElementById('eta-time').value,
                manual: document.getElementById('utc-manual').value,
                manualStartTime: etaManualStartTime
            };
            localStorage.setItem('flightETA', JSON.stringify(eta));
        }

        function updateUTCClock() {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            document.getElementById('utc-clock').textContent = utcTime;
            document.getElementById('strip-utc-clock').textContent = utcTime;

            // DXB time (UTC+4)
            const dxbTime = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            const dxbTimeStr = dxbTime.toISOString().substring(11, 19);
            document.getElementById('strip-dxb-clock').textContent = dxbTimeStr;
        }

        function updateActiveTimersStrip() {
            const stripContainer = document.getElementById('strip-timers');
            const activeTimers = timers.filter(t => t.running || (t.type === 'countdown' && t.remaining > 0 && t.remaining < t.initialTime));

            if (activeTimers.length === 0) {
                stripContainer.innerHTML = '<span class="strip-no-active">No active timers</span>';
                return;
            }

            stripContainer.innerHTML = timers.map((timer, index) => {
                if (!timer.running && !(timer.type === 'countdown' && timer.remaining > 0 && timer.remaining < timer.initialTime)) {
                    return '';
                }
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                return `
                    <div class="strip-timer ${colorClass}" onclick="switchTab('timers')" data-timer-index="${index}">
                        <div class="strip-timer-icon" style="--strip-progress: ${progress}%">
                            <div class="strip-timer-icon-inner"></div>
                        </div>
                        <div class="strip-timer-info">
                            <span class="strip-timer-name">${timer.name}</span>
                            <span class="strip-timer-value">${formatTime(displayTime)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStripTimerDisplay(index) {
            const timer = timers[index];
            const stripTimer = document.querySelector(`.strip-timer[data-timer-index="${index}"]`);
            if (!stripTimer) return;

            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

            stripTimer.className = `strip-timer ${colorClass}`;
            stripTimer.querySelector('.strip-timer-icon').style.setProperty('--strip-progress', `${progress}%`);
            stripTimer.querySelector('.strip-timer-value').textContent = formatTime(displayTime);
        }

        function calculateETA() {
            const etaStr = document.getElementById('eta-time').value;
            const manualStr = document.getElementById('utc-manual').value;
            const etaDisplay = document.getElementById('eta-countdown');
            const stripEta = document.getElementById('strip-eta');
            const stripEtaTime = document.getElementById('strip-eta-time');

            const eta = parseTime(etaStr);
            if (!eta) {
                etaDisplay.textContent = '--:--:--';
                etaDisplay.className = 'eta-countdown';
                stripEta.style.display = 'none';
                return;
            }

            let nowMins, nowSecs = 0;

            if (manualStr && manualStr.length >= 3 && etaManualStartTime) {
                // Manual mode: countdown from when manual time was entered
                const manual = parseTime(manualStr);
                if (manual) {
                    const elapsedSinceEntry = (Date.now() - etaManualStartTime) / 1000;
                    const manualTotalSecs = manual.hours * 3600 + manual.minutes * 60;
                    const currentSimSecs = manualTotalSecs + elapsedSinceEntry;
                    nowMins = currentSimSecs / 60;
                    nowSecs = currentSimSecs % 60;
                } else {
                    const now = new Date();
                    nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
                }
            } else {
                const now = new Date();
                nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            }

            let etaMins = eta.hours * 60 + eta.minutes;
            if (etaMins < nowMins - 60) {
                etaMins += 24 * 60;
            }

            const diffMins = etaMins - nowMins;
            const diffSecs = Math.max(0, Math.floor(diffMins * 60));

            // Update strip ETA
            stripEta.style.display = 'flex';
            const h = Math.floor(diffSecs / 3600);
            const m = Math.floor((diffSecs % 3600) / 60);
            const s = diffSecs % 60;
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            if (diffSecs <= 0) {
                etaDisplay.textContent = '00:00:00';
                etaDisplay.className = 'eta-countdown critical';
                stripEtaTime.textContent = '00:00';
                stripEtaTime.className = 'strip-eta-time critical';
            } else {
                etaDisplay.textContent = timeStr;
                stripEtaTime.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

                if (diffMins <= 10) {
                    etaDisplay.className = 'eta-countdown critical';
                    stripEtaTime.className = 'strip-eta-time critical';
                } else if (diffMins <= 30) {
                    etaDisplay.className = 'eta-countdown warning';
                    stripEtaTime.className = 'strip-eta-time warning';
                } else {
                    etaDisplay.className = 'eta-countdown';
                    stripEtaTime.className = 'strip-eta-time';
                }
            }
        }

        // ============ TOW ============
        function loadTOW() {
            const saved = localStorage.getItem('flightTOW');
            if (saved) {
                try {
                    const tow = JSON.parse(saved);
                    ['zfw', 'fob', 'taxi'].forEach(field => {
                        const val = tow[field] || '';
                        document.getElementById('calc-' + field).value = val;
                        const btn = document.getElementById('calc-' + field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateTOW();
                    calculateMLF();
                } catch (e) {}
            }
        }

        function saveTOW() {
            const tow = {
                zfw: document.getElementById('calc-zfw').value,
                fob: document.getElementById('calc-fob').value,
                taxi: document.getElementById('calc-taxi').value
            };
            localStorage.setItem('flightTOW', JSON.stringify(tow));
        }

        function calculateTOW() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const fob = parseInt(document.getElementById('calc-fob').value, 10) || 0;
            const taxi = parseInt(document.getElementById('calc-taxi').value, 10) || 0;
            const trip = parseInt(document.getElementById('calc-trip').value, 10) || 0;

            const limits = aircraftLimits[selectedAircraft];
            let warnings = [];

            // Calculate weights
            const taxiWt = zfw + fob;  // Taxi weight = ZFW + total fuel
            const tow = zfw + fob - taxi;  // TOW = ZFW + FOB - Taxi fuel
            const estLdgFuel = fob - taxi - trip;  // Estimated landing fuel
            const ldw = zfw + estLdgFuel;  // Landing weight = ZFW + landing fuel

            // Update ZFW display
            const zfwEl = document.getElementById('zfw-display');
            if (zfw > 0) {
                zfwEl.textContent = zfw.toLocaleString();
                if (zfw > limits.mzfw) {
                    zfwEl.style.color = '#ff5252';
                    warnings.push(`ZFW exceeds MZFW by ${(zfw - limits.mzfw).toLocaleString()} kg`);
                } else {
                    zfwEl.style.color = '#7ec8e3';
                }
            } else {
                zfwEl.textContent = '---';
                zfwEl.style.color = '#7ec8e3';
            }

            // Update Taxi Weight display
            const taxiWtEl = document.getElementById('taxi-wt-result');
            if (zfw > 0 && fob > 0) {
                taxiWtEl.textContent = taxiWt.toLocaleString();
                if (taxiWt > limits.mtw) {
                    taxiWtEl.style.color = '#ff5252';
                    warnings.push(`Taxi Weight exceeds MTW by ${(taxiWt - limits.mtw).toLocaleString()} kg`);
                } else {
                    taxiWtEl.style.color = '#00ff88';
                }
            } else {
                taxiWtEl.textContent = '---';
                taxiWtEl.style.color = '#00ff88';
            }

            // Update TOW display
            const towEl = document.getElementById('tow-result');
            if (zfw === 0 && fob === 0) {
                towEl.textContent = '---';
                towEl.style.color = '#FF8200';
            } else {
                towEl.textContent = tow.toLocaleString();
                if (tow > limits.mtow) {
                    towEl.style.color = '#ff5252';
                    warnings.push(`TOW exceeds MTOW by ${(tow - limits.mtow).toLocaleString()} kg`);
                } else {
                    towEl.style.color = '#FF8200';
                }
            }

            // Update estimated landing fuel display
            const estLdgFuelEl = document.getElementById('est-ldg-fuel');
            if (fob > 0 && trip > 0) {
                estLdgFuelEl.textContent = estLdgFuel.toLocaleString() + ' kg';
                estLdgFuelEl.style.color = estLdgFuel < 0 ? '#ff5252' : '#7ec8e3';
            } else {
                estLdgFuelEl.textContent = '---';
            }

            // Update Landing Weight display
            const ldwEl = document.getElementById('ldw-result');
            if (zfw > 0 && fob > 0 && trip > 0) {
                ldwEl.textContent = ldw.toLocaleString();
                if (ldw > limits.mlw) {
                    ldwEl.style.color = '#ff5252';
                    warnings.push(`Est. LDW exceeds MLW by ${(ldw - limits.mlw).toLocaleString()} kg`);
                } else {
                    ldwEl.style.color = '#00ff88';
                }
            } else {
                ldwEl.textContent = '---';
                ldwEl.style.color = '#00ff88';
            }

            // Display warnings
            const warningsEl = document.getElementById('tow-warnings');
            if (warnings.length > 0) {
                warningsEl.innerHTML = warnings.map(w =>
                    `<div class="fdp-danger" style="margin-bottom:5px; padding:8px; font-size:0.8rem">${w}</div>`
                ).join('');
            } else {
                warningsEl.innerHTML = '';
            }

            saveTOW();
        }

        // ============ ACC HEIGHT ============
        function loadACC() {
            const saved = localStorage.getItem('flightACC');
            if (saved) {
                try {
                    const acc = JSON.parse(saved);
                    ['opt-acc', 'airfield-elev'].forEach(field => {
                        const key = field === 'opt-acc' ? 'optAcc' : 'elev';
                        const val = acc[key] || '';
                        document.getElementById(field).value = val;
                        const btn = document.getElementById(field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateACC();
                } catch (e) {}
            }
        }

        function saveACC() {
            const acc = {
                optAcc: document.getElementById('opt-acc').value,
                elev: document.getElementById('airfield-elev').value
            };
            localStorage.setItem('flightACC', JSON.stringify(acc));
        }

        function calculateACC() {
            const optAcc = parseInt(document.getElementById('opt-acc').value, 10) || 0;
            const elev = parseInt(document.getElementById('airfield-elev').value, 10) || 0;

            if (optAcc === 0) {
                document.getElementById('acc-result').textContent = '--- ft';
            } else {
                const result = optAcc - elev;
                document.getElementById('acc-result').textContent = result.toLocaleString() + ' ft';
            }
            saveACC();
        }

        // ============ FDP CALCULATOR ============
        const fdpTableFlightAcclimatized = {
            '0600': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '0800': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 9.5],
            '1300': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '1800': [12, 11.25, 10.5, 9.75, 9, 9, 9, 9],
            '2200': [11, 10.25, 9.5, 9, 9, 9, 9, 9]
        };

        const fdpTableCabinAcclimatized = {
            '0600': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '0800': [15, 14.25, 13.5, 12.75, 12, 11.5, 11, 10.5],
            '1300': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '1800': [13, 12.25, 11.5, 10.75, 10, 10, 10, 10],
            '2200': [12, 11.25, 10.5, 10, 10, 10, 10, 10]
        };

        const fdpTableFlightUnacclimatized = {
            'normal': [13, 12.25, 11.5, 10.75, 10, 9.25, 9],
            'reduced': [11.5, 11, 10.5, 9.75, 9, 9, 9]
        };

        const fdpTableCabinUnacclimatized = {
            'normal': [14, 13.25, 12.5, 11.75, 11, 10.25, 10],
            'reduced': [12.5, 12, 11.5, 10.75, 10, 10, 10]
        };

        function getTimeBand(reportTime) {
            const time = parseTime(reportTime);
            if (!time) return '0800';
            const mins = time.hours * 60 + time.minutes;

            if (mins >= 360 && mins < 480) return '0600';      // 0600-0759
            if (mins >= 480 && mins < 780) return '0800';      // 0800-1259
            if (mins >= 780 && mins < 1080) return '1300';     // 1300-1759
            if (mins >= 1080 && mins < 1320) return '1800';    // 1800-2159
            return '2200';                                      // 2200-0559
        }

        function getMaxFDP(crewType, acclimatized, restType, reportTime, sectors) {
            const sectorIdx = Math.min(sectors - 1, 7);

            if (acclimatized === 'yes') {
                const timeBand = getTimeBand(reportTime);
                const table = crewType === 'flight' ? fdpTableFlightAcclimatized : fdpTableCabinAcclimatized;
                return table[timeBand][sectorIdx];
            } else {
                const table = crewType === 'flight' ? fdpTableFlightUnacclimatized : fdpTableCabinUnacclimatized;
                return table[restType][Math.min(sectorIdx, 6)];
            }
        }

        function formatHoursToHHMM(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function addTime(timeStr, hoursToAdd) {
            const time = parseTime(timeStr);
            if (!time) return '--:--';
            let totalMins = time.hours * 60 + time.minutes + Math.round(hoursToAdd * 60);
            totalMins = totalMins % (24 * 60);
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function formatTimeDisplay(timeStr) {
            if (!timeStr || timeStr === '--:--') return '--:--';
            return timeStr.substring(0, 2) + ':' + timeStr.substring(2);
        }

        function getLocalOffset() {
            return parseFloat(document.getElementById('local-offset').value) || 4;
        }

        function localToUTC(localTimeStr) {
            const time = parseTime(localTimeStr);
            if (!time) return null;
            const offset = getLocalOffset();
            let utcMins = time.hours * 60 + time.minutes - (offset * 60);
            if (utcMins < 0) utcMins += 24 * 60;
            if (utcMins >= 24 * 60) utcMins -= 24 * 60;
            const h = Math.floor(utcMins / 60);
            const m = utcMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function utcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLocalOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function updateSectorInputs() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);
            const container = document.getElementById('sector-inputs');
            const actualContainer = document.getElementById('actual-sector-inputs');
            let html = '';
            let actualHtml = '';

            for (let i = 1; i <= sectors; i++) {
                html += `
                    <div class="sector-card">
                        <div class="sector-title">Sector ${i}</div>
                        <div class="sector-field">
                            <label>STD (Local)</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="sector-${i}-std-btn"
                                    onclick="openTimePicker('sector-${i}-std')">----</button>
                            <input type="hidden" id="sector-${i}-std" value="">
                        </div>
                        <div class="sector-field">
                            <label>STA (Local)</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="sector-${i}-sta-btn"
                                    onclick="openTimePicker('sector-${i}-sta')">----</button>
                            <input type="hidden" id="sector-${i}-sta" value="">
                        </div>
                        ${i < sectors ? `
                        <div class="turnaround-display">
                            <div class="turnaround-label">Turnaround</div>
                            <div class="turnaround-value" id="turnaround-${i}">--:--</div>
                        </div>
                        ` : ''}
                    </div>
                `;

                actualHtml += `
                    <div class="sector-card">
                        <div class="sector-title">Sector ${i}</div>
                        <div class="sector-field">
                            <label>Actual OFF</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="actual-${i}-off-btn"
                                    onclick="openTimePicker('actual-${i}-off')">----</button>
                            <input type="hidden" id="actual-${i}-off" value="">
                        </div>
                        <div class="sector-field">
                            <label>Actual ON</label>
                            <button class="input-btn" style="width:100%;max-width:100%"
                                    id="actual-${i}-on-btn"
                                    onclick="openTimePicker('actual-${i}-on')">----</button>
                            <input type="hidden" id="actual-${i}-on" value="">
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            actualContainer.innerHTML = actualHtml;
        }

        function calculateSectorTurnarounds() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            for (let i = 1; i < sectors; i++) {
                const staEl = document.getElementById(`sector-${i}-sta`);
                const stdEl = document.getElementById(`sector-${i + 1}-std`);
                const turnaroundEl = document.getElementById(`turnaround-${i}`);

                if (staEl && stdEl && turnaroundEl) {
                    const sta = parseTime(staEl.value);
                    const std = parseTime(stdEl.value);

                    if (sta && std) {
                        const diff = timeDiff(sta, std);
                        turnaroundEl.textContent = formatMinutes(diff);
                    } else {
                        turnaroundEl.textContent = '--:--';
                    }
                }
            }
        }

        function estimateDutyEnd() {
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;

            // Check if we have actual times to estimate from
            let lastActualOn = null;
            for (let i = sectors; i >= 1; i--) {
                const onEl = document.getElementById(`actual-${i}-on`);
                if (onEl && onEl.value) {
                    lastActualOn = onEl.value;
                    break;
                }
            }

            // If we have actual ON time, estimate duty end as ON + 30 min post-flight
            let estDutyEndUTC = null;
            if (lastActualOn) {
                estDutyEndUTC = addTime(lastActualOn, 0.5); // Add 30 min post-flight
            } else {
                // Use last scheduled STA
                const lastStaEl = document.getElementById(`sector-${sectors}-sta`);
                if (lastStaEl && lastStaEl.value) {
                    const staUTC = localToUTC(lastStaEl.value);
                    estDutyEndUTC = addTime(staUTC, 0.5);
                }
            }

            const estEndEl = document.getElementById('est-duty-end');
            const estEndLocalEl = document.getElementById('est-duty-end-local');
            const statusEl = document.getElementById('duty-status');

            if (estDutyEndUTC) {
                estEndEl.textContent = formatTimeDisplay(estDutyEndUTC);
                estEndLocalEl.textContent = utcToLocal(estDutyEndUTC);

                // Calculate if within limits
                const reportUTC = localToUTC(reportTime);
                const reportParsed = parseTime(reportUTC);
                const estEndParsed = parseTime(estDutyEndUTC);

                if (reportParsed && estEndParsed) {
                    let dutyMins = (estEndParsed.hours * 60 + estEndParsed.minutes) - (reportParsed.hours * 60 + reportParsed.minutes);
                    if (dutyMins < 0) dutyMins += 24 * 60;

                    const maxFDPMins = maxFDP * 60;
                    const absoluteLimitMins = (maxFDP + maxDiscretion) * 60;

                    if (dutyMins <= maxFDPMins) {
                        statusEl.textContent = 'Within FDP';
                        statusEl.className = 'duty-estimate-value green';
                    } else if (dutyMins <= absoluteLimitMins) {
                        const intoDiscretion = Math.floor(dutyMins - maxFDPMins);
                        statusEl.textContent = `In Discretion (+${formatMinutes(intoDiscretion)})`;
                        statusEl.className = 'duty-estimate-value orange';
                    } else {
                        statusEl.textContent = 'EXCEEDS LIMIT';
                        statusEl.className = 'duty-estimate-value red';
                    }
                }
            } else {
                estEndEl.textContent = '--:--';
                estEndLocalEl.textContent = '--:--';
                statusEl.textContent = '---';
                statusEl.className = 'duty-estimate-value';
            }
        }

        function calculateFDP() {
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            // Update report button display
            const reportBtn = document.getElementById('fdp-report-btn');
            reportBtn.textContent = reportTime.padStart(4, '0');

            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;
            const absoluteLimit = maxFDP + maxDiscretion;
            const minRest = crewType === 'flight' ? 12 : 11;

            // Convert report time to UTC for calculations
            const reportUTC = localToUTC(reportTime);
            const latestChocksUTC = addTime(reportUTC, maxFDP);
            const latestOffDutyUTC = addTime(reportUTC, maxFDP + 0.5);
            const absoluteChocksUTC = addTime(reportUTC, absoluteLimit);

            document.getElementById('fdp-max').textContent = formatHoursToHHMM(maxFDP);
            // Local time prominent, UTC secondary
            document.getElementById('fdp-chocks-local').textContent = utcToLocal(latestChocksUTC);
            document.getElementById('fdp-chocks').textContent = 'UTC: ' + formatTimeDisplay(latestChocksUTC);
            document.getElementById('fdp-offduty-local').textContent = utcToLocal(latestOffDutyUTC);
            document.getElementById('fdp-offduty').textContent = 'UTC: ' + formatTimeDisplay(latestOffDutyUTC);
            document.getElementById('fdp-discretion').textContent = '+' + maxDiscretion + ':00';
            document.getElementById('fdp-absolute-local').textContent = utcToLocal(absoluteChocksUTC);
            document.getElementById('fdp-absolute').textContent = 'UTC: ' + formatTimeDisplay(absoluteChocksUTC);
            document.getElementById('fdp-rest-after').textContent = minRest + ':00';

            // Warnings
            let warnings = '';
            if (acclimatized === 'no' && restType === 'reduced') {
                warnings += '<div class="fdp-warning">Reduced rest (18-30h) - Lower FDP limits apply</div>';
            }

            const timeBand = getTimeBand(reportTime);
            if (timeBand === '2200' || timeBand === '0600') {
                warnings += '<div class="fdp-warning">Early/Night duty - Check consecutive duty limits (max 3)</div>';
            }

            document.getElementById('fdp-warnings').innerHTML = warnings;

            // Live tracker
            updateLiveTracker(maxFDP);
            calculateSectorTurnarounds();
            estimateDutyEnd();
        }

        function updateLiveTracker(maxFDP) {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            document.getElementById('fdp-utc-time').textContent = utcTime;

            const offset = getLocalOffset();
            const localDate = new Date(now.getTime() + offset * 60 * 60 * 1000);
            const localTime = localDate.toISOString().substring(11, 19);
            document.getElementById('fdp-local-time').textContent = localTime;

            const actualReport = document.getElementById('fdp-actual-report').value;
            const actualBtn = document.getElementById('fdp-actual-report-btn');
            actualBtn.textContent = actualReport ? actualReport.padStart(4, '0') : '----';

            if (!actualReport) {
                document.getElementById('fdp-elapsed').textContent = '--:--';
                document.getElementById('fdp-remaining').textContent = '--:--';
                document.getElementById('fdp-into-discretion').textContent = '--:--';
                return;
            }

            // Convert actual report from local to UTC for calculations
            const reportUTC = localToUTC(actualReport);
            const report = parseTime(reportUTC);
            if (!report) return;

            const reportMins = report.hours * 60 + report.minutes;
            const nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            let elapsedMins = nowMins - reportMins;
            if (elapsedMins < -60) elapsedMins += 24 * 60;

            const maxFDPMins = maxFDP * 60;
            const remainingMins = maxFDPMins - elapsedMins;
            const intoDiscretionMins = elapsedMins - maxFDPMins;

            document.getElementById('fdp-elapsed').textContent = formatMinutes(Math.max(0, Math.floor(elapsedMins)));

            const remainingEl = document.getElementById('fdp-remaining');
            if (remainingMins > 0) {
                remainingEl.textContent = formatMinutes(Math.floor(remainingMins));
                remainingEl.className = 'fdp-result-value ' + (remainingMins > 60 ? 'green' : remainingMins > 30 ? 'yellow' : 'red');
            } else {
                remainingEl.textContent = '00:00';
                remainingEl.className = 'fdp-result-value red';
            }

            const discretionEl = document.getElementById('fdp-into-discretion');
            if (intoDiscretionMins > 0) {
                discretionEl.textContent = '+' + formatMinutes(Math.floor(intoDiscretionMins));
                discretionEl.className = 'fdp-result-value ' + (intoDiscretionMins > 120 ? 'red' : 'orange');
            } else {
                discretionEl.textContent = '--:--';
                discretionEl.className = 'fdp-result-value';
            }
        }

        // ============ TIMER FUNCTIONS ============
        function formatTime(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const prefix = ms < 0 ? '-' : '';
            return `${prefix}${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getColorClass(timer) {
            if (timer.type === 'stopwatch') return 'color-neutral';
            if (timer.remaining <= 0) return 'color-expired';
            const percent = (timer.remaining / timer.initialTime) * 100;
            if (percent > 50) return 'color-green';
            if (percent > 25) return 'color-yellow';
            if (percent > 10) return 'color-orange';
            return 'color-red';
        }

        function getProgress(timer) {
            if (timer.type === 'stopwatch') return ((timer.elapsed % 60000) / 60000) * 100;
            if (timer.initialTime === 0) return 0;
            return Math.max(0, (timer.remaining / timer.initialTime) * 100);
        }

        // Start continuous flashing on timer (CSS animation handles the visual)
        function flashTimer(index) {
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                card.classList.add('flashing');
            }
        }

        // Stop flashing when timer is reset
        function stopFlashing(index) {
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                card.classList.remove('flashing');
            }
        }

        function createTimerHTML(timer, index) {
            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;
            const isRunning = timer.running;
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            return `
                <div class="timer-card ${colorClass}" id="timer-${index}">
                    <div class="clock-container">
                        <div class="clock-face" style="--progress: ${progress}%">
                            <div class="clock-inner">
                                <span class="clock-time">${formatTime(displayTime)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timer-content">
                        <input type="text" class="timer-name-input" value="${timer.name}"
                               onchange="updateTimerName(${index}, this.value)">
                        <div class="timer-type-toggle">
                            <button class="type-btn ${timer.type === 'countdown' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'countdown')">Countdown</button>
                            <button class="type-btn ${timer.type === 'stopwatch' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'stopwatch')">Stopwatch</button>
                        </div>
                        ${timer.type === 'countdown' ? `
                        <div class="timer-time-setup">
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'hours')" ${isRunning ? 'disabled' : ''}>${hours}</button>
                            <span class="time-separator">h</span>
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'minutes')" ${isRunning ? 'disabled' : ''}>${minutes}</button>
                            <span class="time-separator">m</span>
                        </div>
                        ` : ''}
                        <div class="timer-display">${formatTime(displayTime)}</div>
                        <div class="timer-buttons">
                            <button class="timer-btn ${isRunning ? 'btn-pause' : 'btn-start'}"
                                    onclick="toggleTimer(${index})">
                                ${isRunning ? 'Pause' : 'Start'}
                            </button>
                            <button class="timer-btn btn-reset" onclick="resetTimer(${index})">Reset</button>
                            ${timer.type === 'countdown' ? `
                            <button class="timer-btn btn-repeat" onclick="repeatTimer(${index})" title="Reset & Start">↻</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimers() {
            document.getElementById('timers-container').innerHTML = timers.map((timer, index) => createTimerHTML(timer, index)).join('');
            updateActiveTimersStrip();
        }

        function updateTimerDisplay(index) {
            const timer = timers[index];
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                const isFlashing = card.classList.contains('flashing');
                card.className = `timer-card ${colorClass}${isFlashing ? ' flashing' : ''}`;
                card.querySelector('.clock-face').style.setProperty('--progress', `${progress}%`);
                card.querySelector('.clock-time').textContent = formatTime(displayTime);
                card.querySelector('.timer-display').textContent = formatTime(displayTime);
            }

            // Also update strip display
            updateStripTimerDisplay(index);
        }

        let lastFrameTime = 0;
        function tick(currentTime) {
            if (lastFrameTime === 0) lastFrameTime = currentTime;
            const delta = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            let anyRunning = false;
            timers.forEach((timer, index) => {
                if (timer.running) {
                    anyRunning = true;
                    const now = Date.now();
                    const elapsed = now - timer.lastUpdate;
                    timer.lastUpdate = now;

                    if (timer.type === 'countdown') {
                        const wasPositive = timer.remaining > 0;
                        timer.remaining = Math.max(0, timer.remaining - elapsed);
                        if (wasPositive && timer.remaining === 0) {
                            timer.running = false;
                            timer.expired = true; // Mark as expired for continuous flashing
                            flashTimer(index); // Flash continuously until reset
                            renderTimers();
                            return;
                        }
                    } else {
                        timer.elapsed += elapsed;
                    }
                    updateTimerDisplay(index);
                }
            });

            if (Math.floor(currentTime / 5000) !== Math.floor((currentTime - delta) / 5000)) {
                saveState();
            }

            if (anyRunning) {
                animationFrameId = requestAnimationFrame(tick);
            } else {
                animationFrameId = null;
                lastFrameTime = 0;
            }
        }

        function startAnimationLoop() {
            if (animationFrameId === null && timers.some(t => t.running)) {
                lastFrameTime = 0;
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        function openTimerPicker(index, unit) {
            const timer = timers[index];
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') {
                openPicker('Set Hours', 'h', hours, 2, false, (val) => updateTimerTime(index, 'hours', parseInt(val, 10) || 0));
            } else {
                openPicker('Set Minutes', 'm', minutes, 2, false, (val) => updateTimerTime(index, 'minutes', Math.min(59, parseInt(val, 10) || 0)));
            }
        }

        function toggleTimer(index) {
            const timer = timers[index];
            if (timer.running) {
                timer.running = false;
            } else {
                if (timer.type === 'countdown' && timer.remaining === 0) {
                    timer.remaining = timer.initialTime;
                }
                timer.running = true;
                timer.lastUpdate = Date.now();
                startAnimationLoop();
            }
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function resetTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.expired = false; // Clear expired flag
            timer.remaining = timer.type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            stopFlashing(index); // Stop continuous flashing
            saveState();
            renderTimers();
        }

        function repeatTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.expired = false;
            timer.remaining = timer.initialTime;
            timer.elapsed = 0;
            stopFlashing(index);
            // Immediately start the timer
            timer.running = true;
            timer.lastUpdate = Date.now();
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function setTimerType(index, type) {
            const timer = timers[index];
            timer.type = type;
            timer.running = false;
            timer.remaining = type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function updateTimerName(index, name) {
            timers[index].name = name;
            saveState();
        }

        function updateTimerTime(index, unit, value) {
            const timer = timers[index];
            let hours = Math.floor(timer.initialTime / 3600000);
            let minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') hours = value;
            if (unit === 'minutes') minutes = Math.min(59, value);

            timer.initialTime = (hours * 3600 + minutes * 60) * 1000;
            timer.remaining = timer.initialTime;
            timer.hours = hours;
            timer.minutes = minutes;

            saveState();
            renderTimers();
        }

        // ============ CLEAR HANDLERS ============
        document.getElementById('oooi-clear').addEventListener('click', () => {
            ['out', 'off', 'on', 'in'].forEach(field => {
                document.getElementById('oooi-' + field).value = '';
                const btn = document.getElementById('oooi-' + field + '-btn');
                btn.textContent = '0000';
                btn.classList.add('placeholder');
            });
            document.getElementById('block-time').textContent = '--:--';
            document.getElementById('flight-time').textContent = '--:--';
            localStorage.removeItem('flightOOOI');
        });

        document.getElementById('eta-clear').addEventListener('click', () => {
            document.getElementById('eta-time').value = '';
            document.getElementById('utc-manual').value = '';
            document.getElementById('eta-time-btn').textContent = '0000';
            document.getElementById('eta-time-btn').classList.add('placeholder');
            document.getElementById('utc-manual-btn').textContent = 'AUTO';
            document.getElementById('utc-manual-btn').classList.add('placeholder');
            document.getElementById('eta-countdown').textContent = '--:--:--';
            document.getElementById('eta-countdown').className = 'eta-countdown';
            etaManualStartTime = null;
            localStorage.removeItem('flightETA');
        });

        document.getElementById('calc-clear').addEventListener('click', () => {
            ['zfw', 'fob', 'taxi', 'trip'].forEach(field => {
                document.getElementById('calc-' + field).value = '';
                const btn = document.getElementById('calc-' + field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('tow-result').textContent = '---';
            document.getElementById('tow-result').style.color = '#FF8200';
            document.getElementById('taxi-wt-result').textContent = '---';
            document.getElementById('taxi-wt-result').style.color = '#00ff88';
            document.getElementById('ldw-result').textContent = '---';
            document.getElementById('ldw-result').style.color = '#00ff88';
            document.getElementById('est-ldg-fuel').textContent = '---';
            document.getElementById('zfw-display').textContent = '---';
            document.getElementById('zfw-display').style.color = '#7ec8e3';
            document.getElementById('tow-warnings').innerHTML = '';
            document.getElementById('mlf-result').textContent = '---';
            localStorage.removeItem('flightTOW');
        });

        document.getElementById('acc-clear').addEventListener('click', () => {
            ['opt-acc', 'airfield-elev'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('acc-result').textContent = '--- ft';
            localStorage.removeItem('flightACC');
        });

        document.getElementById('dxb-elev-btn').addEventListener('click', () => {
            document.getElementById('airfield-elev').value = '62';
            document.getElementById('airfield-elev-btn').textContent = '62';
            document.getElementById('airfield-elev-btn').classList.remove('placeholder');
            calculateACC();
        });

        // ============ FUEL CLEAR HANDLER ============
        document.getElementById('fuel-clear').addEventListener('click', () => {
            ['fuel-req', 'fuel-pre', 'fuel-actual'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                btn.textContent = '0';
                btn.classList.add('placeholder');
            });
            document.getElementById('fuel-sg').value = '800';
            document.getElementById('fuel-sg-btn').textContent = '0.800';
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            document.getElementById('fuel-adj').value = '';
            document.getElementById('fuel-adj-btn').textContent = '0';
            calculateFuel();
            localStorage.removeItem('flightFuel');
        });

        // ============ CONVERTER CLEAR HANDLER ============
        document.getElementById('conv-clear').addEventListener('click', () => {
            ['conv-litres', 'conv-gallons', 'conv-lbs'].forEach(field => {
                document.getElementById(field).value = '';
                document.getElementById(field + '-btn').textContent = '0';
            });
        });

        // ============ LAYOVER CLEAR HANDLER ============
        document.getElementById('layover-clear').addEventListener('click', () => {
            document.getElementById('layover-std').value = '';
            document.getElementById('layover-std-btn').textContent = '----';
            document.getElementById('layover-pickup').value = '0130';
            document.getElementById('layover-pickup-btn').textContent = '0130';
            document.getElementById('layover-offset').value = '0';
            calculateLayover();
            localStorage.removeItem('flightLayover');
        });

        // ============ FDP SYNC FUNCTIONS ============
        let fdpSetupCollapsed = false;

        function toggleFDPSetup() {
            const content = document.getElementById('fdp-setup-content');
            const toggle = document.getElementById('fdp-setup-toggle');
            fdpSetupCollapsed = !fdpSetupCollapsed;
            if (fdpSetupCollapsed) {
                content.style.display = 'none';
                toggle.textContent = '▶';
            } else {
                content.style.display = 'block';
                toggle.textContent = '▼';
            }
        }

        function syncFromSchedule() {
            // Get schedule data
            const reportTime = document.getElementById('sched-report').value;

            // Sync report time
            if (reportTime) {
                document.getElementById('fdp-report').value = reportTime;
                document.getElementById('fdp-report-btn').textContent = reportTime;
            }

            // Sync sector count
            document.getElementById('fdp-sectors').value = currentSectorCount.toString();
            updateSectorInputs();

            // Sync sector times from schedule
            for (let s = 1; s <= currentSectorCount; s++) {
                const std = document.getElementById(`s${s}-std`).value;
                const sta = document.getElementById(`s${s}-sta`).value;
                const actualOff = document.getElementById(`s${s}-off`).value;
                const actualIn = document.getElementById(`s${s}-in`).value;

                // Set scheduled times
                if (std) {
                    const offInput = document.getElementById(`sector-${s}-off`);
                    const offBtn = document.getElementById(`sector-${s}-off-btn`);
                    if (offInput) {
                        offInput.value = std;
                        if (offBtn) offBtn.textContent = std;
                    }
                }
                if (sta) {
                    const inInput = document.getElementById(`sector-${s}-in`);
                    const inBtn = document.getElementById(`sector-${s}-in-btn`);
                    if (inInput) {
                        inInput.value = sta;
                        if (inBtn) inBtn.textContent = sta;
                    }
                }

                // Set actual times if available
                if (actualOff) {
                    const actualOffInput = document.getElementById(`actual-${s}-off`);
                    const actualOffBtn = document.getElementById(`actual-${s}-off-btn`);
                    if (actualOffInput) {
                        actualOffInput.value = actualOff;
                        if (actualOffBtn) actualOffBtn.textContent = actualOff;
                    }
                }
                if (actualIn) {
                    const actualInInput = document.getElementById(`actual-${s}-in`);
                    const actualInBtn = document.getElementById(`actual-${s}-in-btn`);
                    if (actualInInput) {
                        actualInInput.value = actualIn;
                        if (actualInBtn) actualInBtn.textContent = actualIn;
                    }
                }
            }

            calculateFDP();
            alert('Synced ' + currentSectorCount + ' sector(s) from Schedule');
        }

        // ============ SCHEDULE TAB FUNCTIONS ============
        let currentSectorCount = 1;

        function addSector() {
            if (currentSectorCount < 4) {
                currentSectorCount++;
                document.getElementById(`sector-${currentSectorCount}-block`).style.display = 'block';
                document.getElementById('sched-total-sectors').textContent = currentSectorCount;
                saveSchedule();
            }
        }

        function removeSector() {
            if (currentSectorCount > 1) {
                document.getElementById(`sector-${currentSectorCount}-block`).style.display = 'none';
                currentSectorCount--;
                document.getElementById('sched-total-sectors').textContent = currentSectorCount;
                saveSchedule();
            }
        }

        function clearSchedule() {
            if (confirm('Clear all schedule data?')) {
                for (let s = 1; s <= 4; s++) {
                    ['flt', 'dep', 'arr', 'std', 'sta', 'pax', 'stand', 'out', 'off', 'on', 'in'].forEach(field => {
                        const input = document.getElementById(`s${s}-${field}`);
                        const btn = document.getElementById(`s${s}-${field}-btn`);
                        if (input) input.value = '';
                        if (btn) btn.textContent = field === 'pax' ? '---' : (field === 'flt' ? 'FZ___' : (field === 'dep' || field === 'arr' ? field.toUpperCase() : (field === 'stand' ? '---' : '----')));
                    });
                    document.getElementById(`s${s}-block`).textContent = '--:--';
                    document.getElementById(`s${s}-flight`).textContent = '--:--';
                }
                document.getElementById('sched-report').value = '';
                document.getElementById('sched-report-btn').textContent = '----';
                document.getElementById('sched-tail').value = '';
                document.getElementById('sched-tail-btn').textContent = 'A6-___';
                currentSectorCount = 1;
                for (let s = 2; s <= 4; s++) {
                    document.getElementById(`sector-${s}-block`).style.display = 'none';
                }
                document.getElementById('sched-total-sectors').textContent = '1';
                document.getElementById('sched-total-block').textContent = '--:--';
                document.getElementById('sched-total-flight').textContent = '--:--';
                document.getElementById('sched-duty-time').textContent = '--:--';
                localStorage.removeItem('flightSchedule');
            }
        }

        function onScheduleChange() {
            saveSchedule();
            // Sync aircraft selection to PERF tab
            const aircraft = document.getElementById('sched-aircraft').value;
            selectAircraft(aircraft);
        }

        function saveSchedule() {
            const schedule = {
                sectorCount: currentSectorCount,
                report: document.getElementById('sched-report').value,
                aircraft: document.getElementById('sched-aircraft').value,
                tail: document.getElementById('sched-tail').value,
                sectors: []
            };
            for (let s = 1; s <= 4; s++) {
                schedule.sectors.push({
                    flt: document.getElementById(`s${s}-flt`)?.value || '',
                    dep: document.getElementById(`s${s}-dep`)?.value || '',
                    arr: document.getElementById(`s${s}-arr`)?.value || '',
                    std: document.getElementById(`s${s}-std`)?.value || '',
                    sta: document.getElementById(`s${s}-sta`)?.value || '',
                    pax: document.getElementById(`s${s}-pax`)?.value || '',
                    stand: document.getElementById(`s${s}-stand`)?.value || '',
                    out: document.getElementById(`s${s}-out`)?.value || '',
                    off: document.getElementById(`s${s}-off`)?.value || '',
                    on: document.getElementById(`s${s}-on`)?.value || '',
                    in: document.getElementById(`s${s}-in`)?.value || ''
                });
            }
            localStorage.setItem('flightSchedule', JSON.stringify(schedule));
        }

        function loadSchedule() {
            try {
                const saved = localStorage.getItem('flightSchedule');
                if (saved) {
                    const schedule = JSON.parse(saved);
                    currentSectorCount = schedule.sectorCount || 1;
                    if (schedule.report) {
                        document.getElementById('sched-report').value = schedule.report;
                        document.getElementById('sched-report-btn').textContent = schedule.report;
                    }
                    if (schedule.aircraft) {
                        document.getElementById('sched-aircraft').value = schedule.aircraft;
                        document.getElementById('sched-aircraft-btn').textContent = schedule.aircraft;
                    }
                    if (schedule.tail) {
                        document.getElementById('sched-tail').value = schedule.tail;
                        document.getElementById('sched-tail-btn').textContent = schedule.tail || 'A6-___';
                    }
                    for (let s = 1; s <= 4; s++) {
                        if (s <= currentSectorCount) {
                            document.getElementById(`sector-${s}-block`).style.display = 'block';
                        }
                        if (schedule.sectors && schedule.sectors[s-1]) {
                            const sector = schedule.sectors[s-1];
                            Object.keys(sector).forEach(field => {
                                const input = document.getElementById(`s${s}-${field}`);
                                const btn = document.getElementById(`s${s}-${field}-btn`);
                                if (input && sector[field]) {
                                    input.value = sector[field];
                                    if (btn) btn.textContent = sector[field];
                                }
                            });
                        }
                    }
                    document.getElementById('sched-total-sectors').textContent = currentSectorCount;
                }
            } catch (e) {
                console.error('Error loading schedule:', e);
            }
        }

        // Text picker for non-numeric inputs
        function openTextPicker(fieldId, title) {
            const currentValue = document.getElementById(fieldId).value || '';
            const newValue = prompt(title + ':', currentValue);
            if (newValue !== null) {
                document.getElementById(fieldId).value = newValue;
                document.getElementById(fieldId + '-btn').textContent = newValue || (fieldId.includes('flt') ? 'FZ___' : (fieldId.includes('tail') ? 'A6-___' : '---'));
                saveSchedule();
            }
        }

        // ============ AIRCRAFT PICKER ============
        function openAircraftPicker() {
            const current = document.getElementById('sched-aircraft').value || 'B738';
            // Highlight current selection
            document.querySelectorAll('#aircraft-picker-modal .picker-btn').forEach(btn => {
                btn.style.background = 'rgba(0, 0, 0, 0.3)';
            });
            const currentBtn = document.getElementById('ac-pick-' + current.toLowerCase());
            if (currentBtn) {
                currentBtn.style.background = 'rgba(255, 130, 0, 0.4)';
            }
            document.getElementById('aircraft-picker-modal').classList.add('active');
        }

        function closeAircraftPicker() {
            document.getElementById('aircraft-picker-modal').classList.remove('active');
        }

        function selectAircraftPick(type) {
            document.getElementById('sched-aircraft').value = type;
            document.getElementById('sched-aircraft-btn').textContent = type;
            closeAircraftPicker();
            onScheduleChange();
            saveSchedule();
        }

        // ============ FLIGHT NUMBER PICKER ============
        let flightPickerFieldId = '';
        let flightPickerValue = '';
        let flightPickerSuffix = '';

        function openFlightPicker(fieldId) {
            flightPickerFieldId = fieldId;
            const currentValue = document.getElementById(fieldId).value || '';
            // Parse existing value (format: FZ123 or FZ123A or FZ123B)
            const match = currentValue.match(/^FZ(\d+)([AB])?$/i);
            if (match) {
                flightPickerValue = match[1];
                flightPickerSuffix = (match[2] || '').toUpperCase();
            } else {
                flightPickerValue = '';
                flightPickerSuffix = '';
            }
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
            document.getElementById('flight-picker-modal').classList.add('active');
        }

        function updateFlightPickerDisplay() {
            document.getElementById('flight-picker-value').textContent = flightPickerValue || '___';
            document.getElementById('flight-picker-suffix').textContent = flightPickerSuffix;
        }

        function updateFlightSuffixButtons() {
            document.getElementById('flight-suffix-none').style.background = flightPickerSuffix === '' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
            document.getElementById('flight-suffix-a').style.background = flightPickerSuffix === 'A' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
            document.getElementById('flight-suffix-b').style.background = flightPickerSuffix === 'B' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
        }

        function flightPickerAppend(digit) {
            if (flightPickerValue.length < 4) {
                flightPickerValue += digit;
                updateFlightPickerDisplay();
            }
        }

        function flightPickerBackspace() {
            flightPickerValue = flightPickerValue.slice(0, -1);
            updateFlightPickerDisplay();
        }

        function flightPickerClear() {
            flightPickerValue = '';
            flightPickerSuffix = '';
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
        }

        function setFlightSuffix(suffix) {
            flightPickerSuffix = suffix;
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
        }

        function closeFlightPicker() {
            document.getElementById('flight-picker-modal').classList.remove('active');
            flightPickerFieldId = '';
        }

        function confirmFlightPicker() {
            if (flightPickerFieldId && flightPickerValue) {
                const fullValue = 'FZ' + flightPickerValue + flightPickerSuffix;
                document.getElementById(flightPickerFieldId).value = fullValue;
                document.getElementById(flightPickerFieldId + '-btn').textContent = fullValue;
                saveSchedule();
            }
            closeFlightPicker();
        }

        // ============ TAIL NUMBER PICKER ============
        let tailPickerValue = '';

        function openTailPicker() {
            const currentValue = document.getElementById('sched-tail').value || '';
            // Remove A6- prefix if present
            tailPickerValue = currentValue.replace(/^A6-/i, '');
            updateTailPickerDisplay();
            document.getElementById('tail-picker-modal').classList.add('active');
        }

        function updateTailPickerDisplay() {
            document.getElementById('tail-picker-value').textContent = tailPickerValue || '___';
        }

        function tailPickerAppend(char) {
            if (tailPickerValue.length < 3) {
                tailPickerValue += char;
                updateTailPickerDisplay();
            }
        }

        function tailPickerBackspace() {
            tailPickerValue = tailPickerValue.slice(0, -1);
            updateTailPickerDisplay();
        }

        function tailPickerClear() {
            tailPickerValue = '';
            updateTailPickerDisplay();
        }

        function closeTailPicker() {
            document.getElementById('tail-picker-modal').classList.remove('active');
        }

        function confirmTailPicker() {
            const fullValue = tailPickerValue ? 'A6-' + tailPickerValue : '';
            document.getElementById('sched-tail').value = fullValue;
            document.getElementById('sched-tail-btn').textContent = fullValue || 'A6-___';
            closeTailPicker();
            saveSchedule();
        }

        // ============ TIME TAB FUNCTIONS ============
        function setCurrentUTC() {
            const now = new Date();
            const utcHours = String(now.getUTCHours()).padStart(2, '0');
            const utcMins = String(now.getUTCMinutes()).padStart(2, '0');
            const timeStr = utcHours + utcMins;
            document.getElementById('time-tz-input').value = timeStr;
            document.getElementById('time-tz-input-btn').textContent = timeStr;
            calculateTimeTabTimezones();
        }

        function calculateTimeTabTimezones() {
            const inputStr = document.getElementById('time-tz-input').value;
            const inputZone = parseFloat(document.getElementById('time-tz-zone').value);
            if (!inputStr || inputStr.length < 3) return;

            const input = parseTime(inputStr);
            if (!input) return;

            const utcMins = input.hours * 60 + input.minutes - (inputZone * 60);
            const formatTimeOffset = (mins) => {
                let m = ((mins % 1440) + 1440) % 1440;
                const h = Math.floor(m / 60);
                const min = m % 60;
                return String(h).padStart(2, '0') + ':' + String(min).padStart(2, '0');
            };

            document.getElementById('time-tz-utc').textContent = formatTimeOffset(utcMins);
            document.getElementById('time-tz-dxb').textContent = formatTimeOffset(utcMins + 240);
        }

        function clearTimeTabTimezones() {
            document.getElementById('time-tz-input').value = '';
            document.getElementById('time-tz-input-btn').textContent = '----';
            document.getElementById('time-tz-utc').textContent = '--:--';
            document.getElementById('time-tz-dxb').textContent = '--:--';
        }

        function autoCalculateSDT() {
            // Auto-calculate the missing field based on which 2 are filled
            const speed = parseFloat(document.getElementById('sdt-speed').value) || 0;
            const dist = parseFloat(document.getElementById('sdt-dist').value) || 0;
            const time = parseFloat(document.getElementById('sdt-time').value) || 0;

            let result = '---';

            if (speed > 0 && dist > 0 && time === 0) {
                // Calculate time
                const t = (dist / speed) * 60;
                result = Math.round(t) + ' min';
                document.getElementById('sdt-time').value = Math.round(t);
                document.getElementById('sdt-time-btn').textContent = Math.round(t);
                document.getElementById('sdt-time-btn').classList.remove('placeholder');
            } else if (speed > 0 && time > 0 && dist === 0) {
                // Calculate distance
                const d = (speed * time) / 60;
                result = Math.round(d) + ' nm';
                document.getElementById('sdt-dist').value = Math.round(d);
                document.getElementById('sdt-dist-btn').textContent = Math.round(d);
                document.getElementById('sdt-dist-btn').classList.remove('placeholder');
            } else if (dist > 0 && time > 0 && speed === 0) {
                // Calculate speed
                const s = (dist / time) * 60;
                result = Math.round(s) + ' kts';
                document.getElementById('sdt-speed').value = Math.round(s);
                document.getElementById('sdt-speed-btn').textContent = Math.round(s);
                document.getElementById('sdt-speed-btn').classList.remove('placeholder');
            }

            document.getElementById('sdt-result').textContent = result;
        }

        function calculateSDT(solve) {
            const speed = parseFloat(document.getElementById('sdt-speed').value) || 0;
            const dist = parseFloat(document.getElementById('sdt-dist').value) || 0;
            const time = parseFloat(document.getElementById('sdt-time').value) || 0;
            let result = '---';

            if (solve === 'speed' && dist > 0 && time > 0) {
                const s = (dist / time) * 60;
                result = Math.round(s) + ' kts';
            } else if (solve === 'distance' && speed > 0 && time > 0) {
                const d = (speed * time) / 60;
                result = Math.round(d) + ' nm';
            } else if (solve === 'time' && speed > 0 && dist > 0) {
                const t = (dist / speed) * 60;
                result = Math.round(t) + ' min';
            } else {
                // Auto-calculate if no solve specified
                autoCalculateSDT();
                return;
            }

            document.getElementById('sdt-result').textContent = result;
        }

        function clearSDT() {
            ['sdt-speed', 'sdt-dist', 'sdt-time'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
            });
            document.getElementById('sdt-result').textContent = '---';
        }

        // ============ CATCH-UP CALCULATOR ============
        function calculateCatchUp(solve) {
            const dist = parseFloat(document.getElementById('catchup-dist').value) || 0;
            const theirGS = parseFloat(document.getElementById('catchup-their-gs').value) || 0;
            const yourGS = parseFloat(document.getElementById('catchup-your-gs').value) || 0;
            const timeLimit = parseFloat(document.getElementById('catchup-time').value) || 0;
            let result = '---';
            let color = '#00ff88';

            if (solve === 'time') {
                // Calculate time to catch up: Distance / (YourGS - TheirGS)
                if (dist > 0 && yourGS > theirGS) {
                    const gsDiff = yourGS - theirGS;
                    const timeHours = dist / gsDiff;
                    const timeMins = Math.round(timeHours * 60);
                    const hours = Math.floor(timeMins / 60);
                    const mins = timeMins % 60;
                    if (hours > 0) {
                        result = hours + 'h ' + mins + 'm to catch up';
                    } else {
                        result = timeMins + ' min to catch up';
                    }
                } else if (yourGS <= theirGS && dist > 0) {
                    result = 'Cannot catch up (too slow)';
                    color = '#ff5252';
                }
            } else if (solve === 'speed') {
                // Calculate speed required: (Distance / Time) + TheirGS
                if (dist > 0 && timeLimit > 0 && theirGS > 0) {
                    const timeHours = timeLimit / 60;
                    const requiredGS = Math.round((dist / timeHours) + theirGS);
                    result = requiredGS + ' kts required';
                    if (requiredGS > 500) {
                        color = '#ffd700'; // Yellow warning for high speed
                    }
                }
            }

            const resultEl = document.getElementById('catchup-result');
            resultEl.textContent = result;
            resultEl.style.color = color;
        }

        function clearCatchUp() {
            ['catchup-dist', 'catchup-their-gs', 'catchup-your-gs', 'catchup-time'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
            });
            document.getElementById('catchup-result').textContent = '---';
            document.getElementById('catchup-result').style.color = '#00ff88';
        }

        // ============ NOTES TAB FUNCTIONS ============
        function saveNotesScratchpad() {
            const content = document.getElementById('notes-scratchpad').value.trim();
            if (!content) return;

            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                content: content
            });
            if (history.length > 20) history.pop();
            localStorage.setItem('notesScratchpadHistory', JSON.stringify(history));
            renderNotesScratchpadHistory();
        }

        function clearNotesScratchpad() {
            document.getElementById('notes-scratchpad').value = '';
        }

        function renderNotesScratchpadHistory() {
            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            const container = document.getElementById('notes-scratchpad-history');
            if (!container) return;

            container.innerHTML = history.map((item, index) => `
                <div class="scratchpad-history-item">
                    <div class="history-timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                    <div class="history-content">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</div>
                    <button class="history-delete" onclick="deleteNotesHistoryItem(${index})">×</button>
                </div>
            `).join('');
        }

        function deleteNotesHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('notesScratchpadHistory', JSON.stringify(history));
            renderNotesScratchpadHistory();
        }

        // ============ SETTINGS TAB FUNCTIONS ============
        function quickResetAll() {
            if (confirm('Reset all data except notes? This cannot be undone.')) {
                // Clear schedule
                localStorage.removeItem('flightSchedule');
                // Clear timers
                localStorage.removeItem('flightTimers');
                // Clear OOOI
                localStorage.removeItem('flightOOOI');
                // Clear ETA
                localStorage.removeItem('flightETA');
                // Clear TOW
                localStorage.removeItem('flightTOW');
                // Clear ACC
                localStorage.removeItem('flightACC');
                // Clear Fuel
                localStorage.removeItem('flightFuel');
                // Clear Layover
                localStorage.removeItem('flightLayover');
                // Clear FDP
                localStorage.removeItem('flightFDP');

                // Reload page to reset all values
                location.reload();
            }
        }

        function exportAllData() {
            const now = new Date();
            let md = `# Flight Ops Export\n\n`;
            md += `**Generated:** ${now.toISOString()}\n\n`;

            // Schedule
            const schedule = JSON.parse(localStorage.getItem('flightSchedule') || '{}');
            md += `## Schedule\n\n`;
            md += `- Sectors: ${schedule.sectorCount || 0}\n`;
            md += `- Aircraft: ${schedule.aircraft || 'N/A'}\n`;
            md += `- Tail: ${schedule.tail || 'N/A'}\n\n`;

            // Notes
            const notes = document.getElementById('notes-scratchpad')?.value || '';
            md += `## Notes\n\n\`\`\`\n${notes || 'No notes'}\n\`\`\`\n\n`;

            // Download
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flight-ops-${now.toISOString().split('T')[0]}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function savePreferences() {
            const prefs = {
                aircraft: document.getElementById('pref-aircraft').value,
                timezone: document.getElementById('pref-timezone').value
            };
            localStorage.setItem('flightPreferences', JSON.stringify(prefs));
        }

        function loadPreferences() {
            try {
                const saved = localStorage.getItem('flightPreferences');
                if (saved) {
                    const prefs = JSON.parse(saved);
                    if (prefs.aircraft) document.getElementById('pref-aircraft').value = prefs.aircraft;
                    if (prefs.timezone) document.getElementById('pref-timezone').value = prefs.timezone;
                }
            } catch (e) {}
        }

        // ============ INITIALIZE ============
        loadState();
        loadSchedule();
        loadPreferences();
        loadOOOI();
        loadETA();
        loadTOW();
        loadACC();
        loadFuel();
        loadLayover();
        renderTimers();
        updateSectorInputs();
        updateLimitDisplays();
        calculateFDP();
        calculateTOW();
        calculateMLF();
        calculateFuel();
        calculateLayover();
        startAnimationLoop();

        setInterval(() => {
            updateUTCClock();
            calculateETA();
            if (document.getElementById('tab-fdp').classList.contains('active')) {
                const maxFDP = getMaxFDP(
                    document.getElementById('fdp-crew-type').value,
                    document.getElementById('fdp-acclimatized').value,
                    document.getElementById('fdp-rest').value,
                    document.getElementById('fdp-report').value || '0600',
                    parseInt(document.getElementById('fdp-sectors').value, 10)
                );
                updateLiveTracker(maxFDP);
            }
        }, 1000);

        updateUTCClock();
        updateActiveTimersStrip();

        window.addEventListener('beforeunload', saveState);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const now = Date.now();
                timers.forEach((timer, index) => {
                    if (timer.running && timer.lastUpdate) {
                        const elapsed = now - timer.lastUpdate;
                        if (timer.type === 'countdown') {
                            const wasPositive = timer.remaining > 0;
                            timer.remaining = Math.max(0, timer.remaining - elapsed);
                            if (wasPositive && timer.remaining === 0) {
                                timer.running = false;
                                flashTimer(index, 5);
                            }
                        } else {
                            timer.elapsed += elapsed;
                        }
                        timer.lastUpdate = now;
                        updateTimerDisplay(index);
                    }
                });
                renderTimers();
                startAnimationLoop();
            }
        });

        // ============ CROSSWIND CALCULATOR ============
        function openRunwayHdgPicker() {
            const currentVal = document.getElementById('xwind-rwy').value || '';
            openPicker('Runway Heading', '°', currentVal, 3, false, (val) => {
                let hdg = parseInt(val) || 0;
                if (hdg > 360) hdg = 360;
                const hdgStr = hdg ? hdg.toString().padStart(3, '0') : '';
                document.getElementById('xwind-rwy').value = hdgStr;
                document.getElementById('xwind-rwy-btn').textContent = hdgStr ? hdgStr + '°' : '---°';
                document.getElementById('xwind-rwy-btn').classList.toggle('placeholder', !hdgStr);
                calculateCrosswind();
            });
        }

        function openWindDirPicker() {
            const currentVal = document.getElementById('xwind-dir').value || '';
            openPicker('Wind Direction', '°', currentVal, 3, false, (val) => {
                let dir = parseInt(val) || 0;
                if (dir > 360) dir = 360;
                const dirStr = dir ? dir.toString().padStart(3, '0') : '';
                document.getElementById('xwind-dir').value = dirStr;
                document.getElementById('xwind-dir-btn').textContent = dirStr ? dirStr + '°' : '---°';
                document.getElementById('xwind-dir-btn').classList.toggle('placeholder', !dirStr);
                calculateCrosswind();
            });
        }

        function openWindSpdPicker(fieldId, title) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title, 'kt', currentVal, 3, false, (val) => {
                const spd = parseInt(val) || 0;
                document.getElementById(fieldId).value = spd || '';
                document.getElementById(fieldId + '-btn').textContent = spd ? spd + ' kt' : '-- kt';
                document.getElementById(fieldId + '-btn').classList.toggle('placeholder', !spd);
                calculateCrosswind();
            });
        }

        function calculateCrosswind() {
            const rwyInput = document.getElementById('xwind-rwy').value;
            const dirInput = document.getElementById('xwind-dir').value;
            const spdInput = document.getElementById('xwind-spd').value;
            const gustInput = document.getElementById('xwind-gust').value;

            // Update SVG runway rotation
            const runwaySvg = document.getElementById('runway-svg');
            const windArrowSvg = document.getElementById('wind-arrow-svg');

            if (rwyInput) {
                const rwyHdg = parseInt(rwyInput);
                runwaySvg.setAttribute('transform', `rotate(${rwyHdg}, 100, 100)`);

                // Update runway numbers (heading / 10, rounded)
                const rwyNum = Math.round(rwyHdg / 10) || 36;
                const reciprocal = rwyNum > 18 ? rwyNum - 18 : rwyNum + 18;

                // Position runway numbers at the ends of the runway (accounting for rotation)
                const rwyRad = rwyHdg * Math.PI / 180;
                // Approach end (where the runway number faces - at threshold end)
                const approachX = 100 + Math.sin(rwyRad) * 80;
                const approachY = 100 - Math.cos(rwyRad) * 80;
                // Departure end (reciprocal)
                const departX = 100 - Math.sin(rwyRad) * 80;
                const departY = 100 + Math.cos(rwyRad) * 80;

                const rwyNumApproach = document.getElementById('rwy-num-approach');
                const rwyNumDepart = document.getElementById('rwy-num-depart');
                rwyNumApproach.setAttribute('x', approachX);
                rwyNumApproach.setAttribute('y', approachY + 4);
                rwyNumApproach.textContent = rwyNum.toString().padStart(2, '0');
                rwyNumDepart.setAttribute('x', departX);
                rwyNumDepart.setAttribute('y', departY + 4);
                rwyNumDepart.textContent = reciprocal.toString().padStart(2, '0');
            }

            if (dirInput) {
                const windDir = parseInt(dirInput);
                // Wind arrow shows where wind is coming FROM (arrow points toward center)
                windArrowSvg.setAttribute('transform', `rotate(${windDir}, 100, 100)`);

                // Position wind direction label near the arrow source
                const windRad = windDir * Math.PI / 180;
                const labelX = 100 + Math.sin(windRad) * 75;
                const labelY = 100 - Math.cos(windRad) * 75;
                const windLabel = document.getElementById('wind-dir-label');
                windLabel.setAttribute('x', labelX);
                windLabel.setAttribute('y', labelY + 4);
                windLabel.textContent = dirInput.padStart(3, '0') + '°';
            }

            if (!rwyInput || !dirInput || !spdInput) {
                document.getElementById('headwind-val').textContent = '--';
                document.getElementById('crosswind-val').textContent = '--';
                return;
            }

            const rwyHdg = parseInt(rwyInput); // Now using heading directly
            const windDir = parseInt(dirInput);
            const windSpd = parseInt(spdInput);
            const gust = gustInput ? parseInt(gustInput) : windSpd;

            // Calculate angle difference
            let angleDiff = windDir - rwyHdg;
            while (angleDiff > 180) angleDiff -= 360;
            while (angleDiff < -180) angleDiff += 360;

            const angleRad = angleDiff * Math.PI / 180;

            // Calculate components using max of steady wind and gust
            const maxWind = Math.max(windSpd, gust);
            const headwind = Math.round(Math.cos(angleRad) * maxWind);
            const crosswind = Math.round(Math.abs(Math.sin(angleRad) * maxWind));

            // Update display
            const headwindEl = document.getElementById('headwind-val');
            if (headwind >= 0) {
                headwindEl.textContent = `H${headwind}`;
                headwindEl.className = 'component-value headwind';
            } else {
                headwindEl.textContent = `T${Math.abs(headwind)}`;
                headwindEl.className = 'component-value tailwind';
            }

            const crosswindEl = document.getElementById('crosswind-val');
            const side = angleDiff > 0 ? 'R' : 'L';
            crosswindEl.textContent = `${crosswind}${side}`;
        }

        function openOPTWindPicker() {
            const currentDir = document.getElementById('xwind-dir').value || '';
            const currentSpd = document.getElementById('xwind-spd').value || '';
            const currentVal = currentDir && currentSpd ? `${currentDir}/${currentSpd}` : '';

            const input = prompt('Enter wind in OPT format:\n• 220/13 (direction/speed in kt)\n• 220/3m (direction/speed in m/s)\n\nExamples: 270/15, 180/5m', currentVal);

            if (input !== null && input.trim()) {
                // Parse OPT format: DIR/SPD or DIR/SPDm
                const match = input.trim().match(/^(\d{1,3})\/(\d{1,3})(m)?$/i);
                if (match) {
                    let dir = parseInt(match[1]);
                    let spd = parseInt(match[2]);
                    const isMetersPerSec = match[3] && match[3].toLowerCase() === 'm';

                    // Convert m/s to knots if needed (1 m/s ≈ 1.944 kt)
                    if (isMetersPerSec) {
                        spd = Math.round(spd * 1.944);
                    }

                    // Validate direction
                    if (dir > 360) dir = 360;
                    if (dir === 0) dir = 360;

                    // Set values
                    document.getElementById('xwind-dir').value = dir.toString();
                    document.getElementById('xwind-dir-btn').textContent = dir.toString().padStart(3, '0') + '°';
                    document.getElementById('xwind-spd').value = spd.toString();
                    document.getElementById('xwind-spd-btn').textContent = spd + ' kt';
                    document.getElementById('xwind-opt-btn').textContent = `${dir.toString().padStart(3, '0')}/${spd}`;

                    calculateCrosswind();
                } else {
                    alert('Invalid format. Use: 220/13 or 220/3m');
                }
            }
        }

        function clearCrosswind() {
            ['xwind-rwy', 'xwind-dir', 'xwind-spd', 'xwind-gust'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('xwind-rwy-btn').textContent = '---°';
            document.getElementById('xwind-dir-btn').textContent = '---°';
            document.getElementById('xwind-spd-btn').textContent = '-- kt';
            document.getElementById('xwind-gust-btn').textContent = '-- kt';
            document.getElementById('headwind-val').textContent = '--';
            document.getElementById('crosswind-val').textContent = '--';
            document.getElementById('runway-svg').setAttribute('transform', 'rotate(0, 100, 100)');
            document.getElementById('wind-arrow-svg').setAttribute('transform', 'rotate(0, 100, 100)');
            document.getElementById('rwy-num-approach').textContent = '';
            document.getElementById('rwy-num-depart').textContent = '';
            document.getElementById('wind-dir-label').textContent = '';
        }

        // ============ HOLD ENTRY CALCULATOR ============
        function openHeadingPicker(fieldId, title) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title, '°', currentVal, 3, false, (val) => {
                let hdg = parseInt(val) || 0;
                if (hdg > 360) hdg = 360;
                const hdgStr = hdg ? hdg.toString().padStart(3, '0') : '';
                document.getElementById(fieldId).value = hdgStr;
                document.getElementById(fieldId + '-btn').textContent = hdgStr || '---';
                document.getElementById(fieldId + '-btn').classList.toggle('placeholder', !hdgStr);
                calculateHoldEntry();
            });
        }

        function setHoldTurn(dir) {
            document.getElementById('hold-turn-dir').value = dir;
            document.getElementById('hold-turn-l').classList.toggle('active', dir === 'left');
            document.getElementById('hold-turn-r').classList.toggle('active', dir === 'right');
            calculateHoldEntry();
        }

        function calculateHoldEntry() {
            const inboundInput = document.getElementById('hold-inbound').value;
            const hdgInput = document.getElementById('hold-hdg').value;
            const turnDir = document.getElementById('hold-turn-dir').value;

            if (!inboundInput || !hdgInput) {
                document.getElementById('hold-entry-type').textContent = '---';
                document.getElementById('hold-entry-desc').textContent = '';
                return;
            }

            const inboundCourse = parseInt(inboundInput);
            const yourHdg = parseInt(hdgInput);

            // Calculate relative bearing to the fix
            let relativeBearing = inboundCourse - yourHdg;
            while (relativeBearing < 0) relativeBearing += 360;
            while (relativeBearing >= 360) relativeBearing -= 360;

            // For right turns, the sectors are:
            // Direct: 0-110° relative to inbound
            // Teardrop: 110-180° relative to inbound (plus 70° offset)
            // Parallel: 180-360° relative to inbound

            let entryType, entryDesc;

            if (turnDir === 'right') {
                if (relativeBearing >= 0 && relativeBearing <= 70) {
                    entryType = 'DIRECT';
                    entryDesc = 'Turn right to join hold';
                } else if (relativeBearing > 70 && relativeBearing <= 180) {
                    entryType = 'TEARDROP';
                    entryDesc = 'Fly 30° offset, then turn to intercept inbound';
                } else {
                    entryType = 'PARALLEL';
                    entryDesc = 'Fly parallel to outbound, then turn back';
                }
            } else {
                // Left turns - mirror the sectors
                if (relativeBearing >= 290 || relativeBearing <= 0) {
                    entryType = 'DIRECT';
                    entryDesc = 'Turn left to join hold';
                } else if (relativeBearing >= 180 && relativeBearing < 290) {
                    entryType = 'TEARDROP';
                    entryDesc = 'Fly 30° offset, then turn to intercept inbound';
                } else {
                    entryType = 'PARALLEL';
                    entryDesc = 'Fly parallel to outbound, then turn back';
                }
            }

            document.getElementById('hold-entry-type').textContent = entryType;
            document.getElementById('hold-entry-desc').textContent = entryDesc;

            // Update SVG visualization
            updateHoldGraphic(inboundCourse, yourHdg, turnDir, entryType);
        }

        function updateHoldGraphic(inbound, yourHdg, turnDir, entryType) {
            const sectors = document.getElementById('hold-sectors');
            const holdPattern = document.getElementById('hold-pattern');
            const aircraft = document.getElementById('aircraft-symbol');

            // Rotate sectors and hold pattern based on inbound course
            // Inbound is from the south (180°) by default, so rotation = inbound - 180
            // This makes the inbound leg point in the direction of the inbound course
            const rotation = inbound - 180;
            sectors.setAttribute('transform', `rotate(${rotation}, 150, 150)`);

            // For left-hand holds, mirror the pattern horizontally around the fix
            if (turnDir === 'left') {
                holdPattern.setAttribute('transform', `rotate(${rotation}, 150, 150) scale(-1,1) translate(-300,0)`);
            } else {
                holdPattern.setAttribute('transform', `rotate(${rotation}, 150, 150)`);
            }

            // Position aircraft based on your heading approaching the fix
            // Aircraft is positioned at the edge of the sector circle, pointing toward fix
            const radius = 110;
            const angleRad = (yourHdg - 90) * Math.PI / 180; // -90 to align with SVG coords (0° = up)
            const acX = 150 + radius * Math.cos(angleRad);
            const acY = 150 + radius * Math.sin(angleRad);

            // Aircraft points toward center (fix) at 150,150
            const pointAngle = Math.atan2(150 - acY, 150 - acX) * 180 / Math.PI + 90;
            aircraft.setAttribute('transform', `translate(${acX}, ${acY}) rotate(${pointAngle})`);

            // Highlight active sector based on entry type
            const sectorDirect = document.getElementById('sector-direct');
            const sectorTeardrop = document.getElementById('sector-teardrop');
            const sectorParallel = document.getElementById('sector-parallel');

            // Reset all sectors to dim
            sectorDirect.setAttribute('fill', 'rgba(0,255,136,0.15)');
            sectorTeardrop.setAttribute('fill', 'rgba(255,215,0,0.15)');
            sectorParallel.setAttribute('fill', 'rgba(0,212,255,0.15)');

            // Highlight the active entry sector
            if (entryType === 'DIRECT') {
                sectorDirect.setAttribute('fill', 'rgba(0,255,136,0.4)');
            } else if (entryType === 'TEARDROP') {
                sectorTeardrop.setAttribute('fill', 'rgba(255,215,0,0.4)');
            } else if (entryType === 'PARALLEL') {
                sectorParallel.setAttribute('fill', 'rgba(0,212,255,0.4)');
            }
        }

        function clearHoldEntry() {
            ['hold-inbound', 'hold-hdg'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
                document.getElementById(id + '-btn').classList.add('placeholder');
            });
            document.getElementById('hold-entry-type').textContent = '---';
            document.getElementById('hold-entry-desc').textContent = '';
        }

        // ============ ISA CALCULATOR ============
        function calculateISA() {
            const altInput = document.getElementById('isa-alt').value;
            const oatInput = document.getElementById('isa-oat').value;

            const altitude = altInput ? parseInt(altInput) : 0;
            const oat = oatInput ? parseInt(oatInput) : 15;

            // ISA temperature at altitude: 15°C - (1.98°C per 1000ft)
            const isaTemp = 15 - (altitude / 1000 * 1.98);
            const isaDev = oat - isaTemp;

            document.getElementById('isa-temp').textContent = `${isaTemp >= 0 ? '+' : ''}${isaTemp.toFixed(1)}°C`;

            const devEl = document.getElementById('isa-dev');
            if (Math.abs(isaDev) < 0.5) {
                devEl.textContent = 'ISA ±0°C';
                devEl.className = 'isa-deviation neutral';
            } else if (isaDev > 0) {
                devEl.textContent = `ISA +${isaDev.toFixed(0)}°C`;
                devEl.className = 'isa-deviation positive';
            } else {
                devEl.textContent = `ISA ${isaDev.toFixed(0)}°C`;
                devEl.className = 'isa-deviation negative';
            }
        }

        let isaTempNegative = false;

        function openISAPicker() {
            const currentVal = document.getElementById('isa-oat').value || '15';
            const absVal = Math.abs(parseInt(currentVal));
            isaTempNegative = parseInt(currentVal) < 0;
            openTempPicker('OAT Temperature', absVal.toString(), (val, isNeg) => {
                const finalVal = isNeg ? -parseInt(val || 0) : parseInt(val || 0);
                document.getElementById('isa-oat').value = finalVal;
                document.getElementById('isa-oat-btn').textContent = `${finalVal >= 0 ? '+' : ''}${finalVal}`;
                document.getElementById('isa-oat-btn').classList.remove('placeholder');
                calculateISA();
            });
        }

        function openTempPicker(title, currentValue, callback) {
            // Create temp picker modal if it doesn't exist
            let tempModal = document.getElementById('temp-picker-modal');
            if (!tempModal) {
                tempModal = document.createElement('div');
                tempModal.id = 'temp-picker-modal';
                tempModal.className = 'modal-overlay';
                tempModal.innerHTML = `
                    <div class="picker-container">
                        <div class="picker-display">
                            <span id="temp-picker-sign" style="font-size:1.8rem;color:#FF8200;cursor:pointer" onclick="toggleTempSign()">+</span>
                            <span id="temp-picker-value">0</span>
                            <span class="picker-unit">°C</span>
                        </div>
                        <div class="picker-title" id="temp-picker-title">${title}</div>
                        <div class="picker-grid">
                            <button class="picker-btn" onclick="tempPickerAppend('1')">1</button>
                            <button class="picker-btn" onclick="tempPickerAppend('2')">2</button>
                            <button class="picker-btn" onclick="tempPickerAppend('3')">3</button>
                            <button class="picker-btn" onclick="tempPickerAppend('4')">4</button>
                            <button class="picker-btn" onclick="tempPickerAppend('5')">5</button>
                            <button class="picker-btn" onclick="tempPickerAppend('6')">6</button>
                            <button class="picker-btn" onclick="tempPickerAppend('7')">7</button>
                            <button class="picker-btn" onclick="tempPickerAppend('8')">8</button>
                            <button class="picker-btn" onclick="tempPickerAppend('9')">9</button>
                            <button class="picker-btn sign-btn" onclick="toggleTempSign()">+/-</button>
                            <button class="picker-btn" onclick="tempPickerAppend('0')">0</button>
                            <button class="picker-btn" onclick="tempPickerBackspace()">&#9003;</button>
                        </div>
                        <div class="picker-actions">
                            <button class="picker-cancel" onclick="closeTempPicker()">Cancel</button>
                            <button class="picker-confirm" onclick="confirmTempPicker()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(tempModal);
            }

            window.tempPickerCallback = callback;
            window.tempPickerValue = currentValue || '';
            window.tempPickerFirstInput = true;
            document.getElementById('temp-picker-title').textContent = title;
            document.getElementById('temp-picker-sign').textContent = isaTempNegative ? '-' : '+';
            updateTempPickerDisplay();
            tempModal.classList.add('active');
        }

        function updateTempPickerDisplay() {
            document.getElementById('temp-picker-value').textContent = window.tempPickerValue || '0';
        }

        function toggleTempSign() {
            isaTempNegative = !isaTempNegative;
            document.getElementById('temp-picker-sign').textContent = isaTempNegative ? '-' : '+';
        }

        function tempPickerAppend(digit) {
            if (window.tempPickerFirstInput && window.tempPickerValue.length > 0) {
                window.tempPickerValue = '';
            }
            window.tempPickerFirstInput = false;
            if (window.tempPickerValue.length < 3) {
                window.tempPickerValue += digit;
                updateTempPickerDisplay();
            }
        }

        function tempPickerBackspace() {
            window.tempPickerFirstInput = false;
            window.tempPickerValue = window.tempPickerValue.slice(0, -1);
            updateTempPickerDisplay();
        }

        function closeTempPicker() {
            document.getElementById('temp-picker-modal').classList.remove('active');
            window.tempPickerCallback = null;
        }

        function confirmTempPicker() {
            if (window.tempPickerCallback) {
                window.tempPickerCallback(window.tempPickerValue, isaTempNegative);
            }
            closeTempPicker();
        }

        function clearISA() {
            document.getElementById('isa-alt').value = '';
            document.getElementById('isa-alt-btn').textContent = '0';
            document.getElementById('isa-oat').value = '15';
            document.getElementById('isa-oat-btn').textContent = '+15';
            document.getElementById('isa-temp').textContent = '+15°C';
            document.getElementById('isa-dev').textContent = 'ISA ±0°C';
            document.getElementById('isa-dev').className = 'isa-deviation neutral';
        }

        // ============ TIMEZONE CONVERTER ============
        function calculateTimezones() {
            const inputTime = document.getElementById('tz-input').value;
            const inputZone = parseFloat(document.getElementById('tz-input-zone').value);

            if (!inputTime || inputTime.length < 3) {
                ['tz-utc', 'tz-ruh', 'tz-ika', 'tz-dxb', 'tz-kbl', 'tz-khi', 'tz-del', 'tz-dac', 'tz-bkk'].forEach(id => {
                    document.getElementById(id).textContent = '--:--';
                });
                return;
            }

            const parsed = parseTime(inputTime);
            if (!parsed) return;

            // Convert to UTC minutes
            let utcMins = parsed.hours * 60 + parsed.minutes - (inputZone * 60);

            // Normalize to 0-1440
            while (utcMins < 0) utcMins += 1440;
            while (utcMins >= 1440) utcMins -= 1440;

            const zones = [
                { id: 'tz-utc', offset: 0 },
                { id: 'tz-ruh', offset: 3 },
                { id: 'tz-ika', offset: 3.5 },
                { id: 'tz-dxb', offset: 4 },
                { id: 'tz-kbl', offset: 4.5 },
                { id: 'tz-khi', offset: 5 },
                { id: 'tz-del', offset: 5.5 },
                { id: 'tz-dac', offset: 6 },
                { id: 'tz-bkk', offset: 7 }
            ];

            zones.forEach(zone => {
                let localMins = utcMins + (zone.offset * 60);
                while (localMins < 0) localMins += 1440;
                while (localMins >= 1440) localMins -= 1440;

                const hours = Math.floor(localMins / 60);
                const mins = Math.floor(localMins % 60);
                document.getElementById(zone.id).textContent =
                    `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            });
        }

        function clearTimezones() {
            document.getElementById('tz-input').value = '';
            document.getElementById('tz-input-btn').textContent = '----';
            document.getElementById('tz-input-btn').classList.add('placeholder');
            ['tz-utc', 'tz-ruh', 'tz-ika', 'tz-dxb', 'tz-kbl', 'tz-khi', 'tz-del', 'tz-dac', 'tz-bkk'].forEach(id => {
                document.getElementById(id).textContent = '--:--';
            });
        }

        // ============ SCRATCHPAD ============
        let scratchpadHistory = [];

        function loadScratchpadHistory() {
            const saved = localStorage.getItem('scratchpadHistory');
            if (saved) {
                try {
                    scratchpadHistory = JSON.parse(saved);
                    renderScratchpadHistory();
                } catch(e) {}
            }
            // Load current scratchpad
            const current = localStorage.getItem('scratchpadCurrent');
            if (current) {
                document.getElementById('scratchpad').value = current;
            }
        }

        function saveScratchpadHistory() {
            localStorage.setItem('scratchpadHistory', JSON.stringify(scratchpadHistory));
        }

        function saveScratchpad() {
            const content = document.getElementById('scratchpad').value.trim();
            if (!content) return;

            scratchpadHistory.unshift({
                timestamp: Date.now(),
                content: content
            });

            // Keep only last 10 entries
            if (scratchpadHistory.length > 10) {
                scratchpadHistory = scratchpadHistory.slice(0, 10);
            }

            saveScratchpadHistory();
            renderScratchpadHistory();
            document.getElementById('scratchpad').value = '';
            localStorage.setItem('scratchpadCurrent', '');
        }

        function renderScratchpadHistory() {
            const container = document.getElementById('scratchpad-history');
            if (scratchpadHistory.length === 0) {
                container.innerHTML = '<div style="color:#666;font-size:0.8rem;text-align:center;padding:10px">No saved notes</div>';
                return;
            }

            container.innerHTML = scratchpadHistory.map((item, index) => {
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString();
                return `
                    <div class="history-item">
                        <div class="history-timestamp">${timeStr}</div>
                        <div class="history-content">${item.content}</div>
                        <button class="clear-btn" style="margin-top:8px;padding:3px 8px;font-size:0.7rem" onclick="deleteScratchpadItem(${index})">Delete</button>
                    </div>
                `;
            }).join('');
        }

        function deleteScratchpadItem(index) {
            scratchpadHistory.splice(index, 1);
            saveScratchpadHistory();
            renderScratchpadHistory();
        }

        function clearScratchpad() {
            document.getElementById('scratchpad').value = '';
            localStorage.setItem('scratchpadCurrent', '');
        }

        // Auto-save scratchpad as user types
        document.getElementById('scratchpad').addEventListener('input', (e) => {
            localStorage.setItem('scratchpadCurrent', e.target.value);
        });

        // ============ SNOWTAM DECODER ============
        const grfDescriptions = {
            '6': { text: 'DRY', braking: 'GOOD', class: 'grf-good' },
            '5': { text: 'FROST/WET', braking: 'GOOD-MEDIUM', class: 'grf-good' },
            '4': { text: 'SLUSH/DRY SNOW', braking: 'MEDIUM', class: 'grf-medium' },
            '3': { text: 'WET SNOW/COMPACT', braking: 'MEDIUM-POOR', class: 'grf-medium' },
            '2': { text: 'STANDING WATER', braking: 'POOR', class: 'grf-poor' },
            '1': { text: 'ICE', braking: 'POOR-NIL', class: 'grf-bad' },
            '0': { text: 'WET ICE', braking: 'NIL', class: 'grf-bad' },
            '9': { text: 'UNRELIABLE', braking: 'UNRELIABLE', class: 'grf-bad' },
            '/': { text: 'NOT REPORTED', braking: 'N/R', class: '' }
        };

        function decodeSnowtam() {
            const input = document.getElementById('snowtam-input').value.toUpperCase();
            const container = document.getElementById('snowtam-decoded');

            if (!input.trim()) {
                container.innerHTML = '';
                return;
            }

            // Try to parse runway conditions
            // Format: A) ICAO B) RWY C) COND/COND/COND
            const runways = [];

            // Match patterns like "B) 06L C) 5/5/5" or "RWY 06L 5/5/5"
            const rwyPattern = /(?:B\)\s*)?(\d{2}[LRC]?)\s*(?:C\)\s*)?(\d|\/)\/?(\d|\/)\/?(\d|\/)?/g;
            let match;

            while ((match = rwyPattern.exec(input)) !== null) {
                const rwy = match[1];
                const thirds = [match[2] || '/', match[3] || '/', match[4] || '/'];
                runways.push({ rwy, thirds });
            }

            // Also try to match GRF format with friction values
            // Format: RWY 06L GRF 5/5/5 or F) 5/5/5
            const frictionPattern = /(?:F\)\s*)?(\d|\/)\/?(\d|\/)\/?(\d|\/)?/g;
            const depthPattern = /(?:D\)\s*)?(\d+)\/?(\d+)?\/?(\d+)?/g;

            if (runways.length === 0) {
                // Try simpler format
                const simpleMatch = input.match(/(\d{2}[LRC]?)[:\s]+(\d)\/(\d)\/(\d)/);
                if (simpleMatch) {
                    runways.push({
                        rwy: simpleMatch[1],
                        thirds: [simpleMatch[2], simpleMatch[3], simpleMatch[4]]
                    });
                }
            }

            if (runways.length === 0) {
                container.innerHTML = '<div style="color:#ff5252;padding:10px">Could not parse SNOWTAM data. Check format.</div>';
                return;
            }

            container.innerHTML = runways.map(rwy => {
                return `
                    <div class="snowtam-runway">
                        <div class="snowtam-runway-header">RWY ${rwy.rwy}</div>
                        <div class="snowtam-grid">
                            ${rwy.thirds.map((code, i) => {
                                const desc = grfDescriptions[code] || grfDescriptions['/'];
                                const section = ['A (TDZ)', 'B (MID)', 'C (END)'][i];
                                return `
                                    <div class="snowtam-item">
                                        <div class="snowtam-label">${section}</div>
                                        <div class="snowtam-value ${desc.class}">${code}</div>
                                        <div style="font-size:0.65rem;color:#888;margin-top:2px">${desc.text}</div>
                                        <div style="font-size:0.6rem;color:#666">${desc.braking}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ EVENT LISTENERS FOR NEW CALCULATORS ============
        ['xwind-rwy', 'xwind-dir', 'xwind-spd', 'xwind-gust'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateCrosswind);
        });

        ['hold-inbound', 'hold-hdg'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateHoldEntry);
        });

        ['isa-alt'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateISA);
        });

        document.getElementById('tz-input').addEventListener('change', calculateTimezones);

        // Load scratchpad history on startup
        loadScratchpadHistory();
    </script>
</body>
</html>
