<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Flight Ops</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #002540 0%, #003d66 50%, #006496 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Active Timers Strip */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
        }

        .active-timers-strip {
            background: rgba(0, 20, 40, 0.98);
            border-radius: 12px 12px 0 0;
            padding: 10px 15px;
            margin-bottom: 0;
            border: 1px solid rgba(255, 130, 0, 0.2);
            border-bottom: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .strip-top-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
        }

        .strip-left-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .strip-right-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .strip-timers-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 130, 0, 0.15);
        }

        .strip-timers-row:empty,
        .strip-timers-row.hidden {
            display: none;
            padding: 0;
            border: none;
        }

        .strip-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid rgba(255, 130, 0, 0.3);
        }

        .strip-remt-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 6px 0;
            border-top: 1px solid rgba(255, 130, 0, 0.2);
            cursor: pointer;
        }

        .strip-remt-row:hover {
            opacity: 0.8;
        }

        .strip-eta-time {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .strip-eta-time.warning {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .strip-eta-time.critical {
            color: #ff5252;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.5);
        }

        .strip-eta-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .strip-clock-time {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .strip-clock-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }


        .strip-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .strip-timer:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .strip-timer-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--strip-color, #333) var(--strip-progress, 0%), #222 var(--strip-progress, 0%));
        }

        .strip-timer-icon-inner {
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: #001a2e;
            border-radius: 50%;
        }

        .strip-timer-info {
            display: flex;
            flex-direction: column;
        }

        .strip-timer-name {
            font-size: 0.7rem;
            color: #888;
        }

        .strip-timer-value {
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 8px currentColor;
        }

        .strip-timer.color-green .strip-timer-value { color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-value { color: #ffd700; }
        .strip-timer.color-orange .strip-timer-value { color: #FF8200; }
        .strip-timer.color-red .strip-timer-value { color: #ff5252; }
        .strip-timer.color-expired .strip-timer-value { color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-value { color: #00d4ff; }

        .strip-timer.color-green .strip-timer-icon { --strip-color: #00ff88; }
        .strip-timer.color-yellow .strip-timer-icon { --strip-color: #ffd700; }
        .strip-timer.color-orange .strip-timer-icon { --strip-color: #FF8200; }
        .strip-timer.color-red .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-expired .strip-timer-icon { --strip-color: #ff5252; }
        .strip-timer.color-neutral .strip-timer-icon { --strip-color: #00d4ff; }

        .strip-timer.flashing {
            animation: stripFlashRed 0.6s ease-in-out infinite;
        }

        @keyframes stripFlashRed {
            0%, 100% { background: rgba(0, 37, 64, 0.6); }
            50% { background: rgba(255, 50, 0, 0.6); box-shadow: 0 0 15px rgba(255, 50, 0, 0.8); }
        }

        .strip-no-active {
            color: #666;
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            justify-content: flex-start;
            background: rgba(0, 20, 40, 0.98);
            padding: 8px 15px;
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            border: 1px solid rgba(255, 130, 0, 0.2);
            border-top: 1px solid rgba(255, 130, 0, 0.15);
            border-radius: 0 0 12px 12px;
        }

        .tab-nav::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .tab-btn {
            padding: 10px 18px;
            flex-shrink: 0;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Top sections grid */
        .top-sections {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .top-sections {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 700px) {
            .top-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Section styling */
        .section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .section-title {
            font-size: 1rem;
            color: #FF8200;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        /* Turnaround Badge */
        .turnaround-badge {
            background: rgba(255, 130, 0, 0.2);
            color: #FF8200;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .turnaround-badge.ahead {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .turnaround-badge.behind {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        /* Sector Block */
        .sector-block {
            transition: all 0.3s ease;
        }

        /* Input grids */
        .input-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-label {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Clickable input buttons */
        .input-btn {
            width: 100%;
            max-width: 90px;
            padding: 10px 6px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .input-btn.placeholder {
            color: rgba(0, 255, 136, 0.3);
        }

        .input-btn-with-unit {
            position: relative;
        }

        .input-btn-unit {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #888;
            pointer-events: none;
        }

        .results-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 130, 0, 0.2);
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 2px;
        }

        .result-value {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .block-time { color: #ffd700; }
        .flight-time { color: #00ff88; }
        .tow-value { color: #FF8200; }
        .eta-value { color: #00d4ff; }
        .acc-value { color: #a29bfe; }
        .mlf-value { color: #00ff88; }

        .clear-btn {
            display: block;
            margin: 10px auto 0;
            padding: 5px 14px;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 6px;
            color: #ff6b6b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .preset-btn {
            display: block;
            margin: 8px auto 0;
            padding: 6px 12px;
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 6px;
            color: #FF8200;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        /* ETA Section */
        .eta-countdown {
            font-size: 1.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            margin: 10px 0;
        }

        .eta-countdown.warning {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .eta-countdown.critical {
            color: #ff5252;
            text-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
        }

        .utc-display {
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        /* Aircraft selector */
        .aircraft-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
        }

        .aircraft-btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            color: #888;
            transition: all 0.2s;
        }

        .aircraft-btn.active {
            background: rgba(255, 130, 0, 0.3);
            border-color: #FF8200;
            color: #FF8200;
        }

        .mlw-info {
            text-align: center;
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-bottom: 8px;
        }

        /* Timers Grid */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .timer-card {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            transition: background-color 0.15s, box-shadow 0.15s;
        }

        .timer-card.flashing {
            animation: flashRed 0.6s ease-in-out infinite;
        }

        @keyframes flashRed {
            0%, 100% { background: rgba(0, 37, 64, 0.7); box-shadow: none; }
            50% { background: rgba(255, 50, 0, 0.5); box-shadow: 0 0 40px rgba(255, 50, 0, 0.7); }
        }

        /* Clock Face */
        .clock-container {
            flex-shrink: 0;
        }

        .clock-face {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg, var(--clock-color, #333) var(--progress, 0%), #222 var(--progress, 0%));
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .clock-inner {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: linear-gradient(135deg, #002540 0%, #001a2e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clock-time {
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px currentColor;
        }

        /* Timer Controls */
        .timer-content {
            flex: 1;
            min-width: 0;
        }

        .timer-name-input {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.2);
            border-radius: 6px;
            color: #fff;
            margin-bottom: 8px;
        }

        .timer-name-input:focus {
            outline: none;
            border-color: #FF8200;
        }

        .timer-type-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .timer-time-setup {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .time-input-btn {
            width: 55px;
            height: 40px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 130, 0, 0.3);
            border-radius: 6px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-input-btn:hover {
            border-color: #FF8200;
            background: rgba(255, 130, 0, 0.1);
        }

        .time-separator {
            display: flex;
            align-items: center;
            color: #666;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 0 20px currentColor;
            color: var(--timer-color, #00ff88);
        }

        .timer-buttons {
            display: flex;
            gap: 6px;
        }

        .timer-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-start {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #FF8200, #e67300);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: #fff;
        }

        .btn-repeat {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            color: #fff;
            flex: 0 0 40px;
            font-size: 1.1rem;
        }

        /* Crosswind Calculator */
        .wind-display {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 15px auto;
        }

        .wind-svg {
            width: 100%;
            height: 100%;
        }

        .component-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .component-item {
            text-align: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-width: 100px;
        }

        .component-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }

        .component-value {
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .component-value.headwind { color: #00ff88; }
        .component-value.tailwind { color: #ff5252; }
        .component-value.crosswind { color: #ffd700; }

        /* Hold Entry Calculator */
        .hold-display {
            position: relative;
            width: 280px;
            height: 200px;
            margin: 15px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .hold-pattern {
            position: absolute;
            width: 120px;
            height: 160px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .hold-fix {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #FF8200;
            border-radius: 50%;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 10;
        }

        .hold-inbound {
            position: absolute;
            width: 2px;
            height: 70px;
            background: #00ff88;
            left: 50%;
            bottom: 12px;
            transform: translateX(-50%);
        }

        .hold-outbound {
            position: absolute;
            width: 2px;
            height: 70px;
            background: #888;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
        }

        .hold-turn {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid #888;
            border-radius: 50%;
            top: -10px;
        }

        .hold-turn.right { left: 50%; border-left-color: transparent; }
        .hold-turn.left { right: 50%; border-right-color: transparent; }

        .aircraft-track {
            position: absolute;
            width: 3px;
            height: 60px;
            background: #00d4ff;
            left: 20px;
            bottom: 20px;
            transform-origin: bottom center;
        }

        .aircraft-track::after {
            content: 'âœˆ';
            position: absolute;
            top: -15px;
            left: -8px;
            font-size: 18px;
            color: #00d4ff;
        }

        .entry-type-display {
            text-align: center;
            padding: 15px;
            background: rgba(255, 130, 0, 0.2);
            border-radius: 8px;
            margin-top: 15px;
        }

        .entry-type-label {
            font-size: 0.8rem;
            color: #888;
        }

        .entry-type-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF8200;
            margin-top: 5px;
        }

        .entry-type-desc {
            font-size: 0.75rem;
            color: #7ec8e3;
            margin-top: 5px;
        }

        /* ISA Calculator */
        .isa-result {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-top: 15px;
        }

        .isa-temp {
            font-size: 2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
        }

        .isa-deviation {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-top: 10px;
        }

        .isa-deviation.positive { color: #ff5252; }
        .isa-deviation.negative { color: #00d4ff; }
        .isa-deviation.neutral { color: #00ff88; }

        /* Scratchpad */
        .scratchpad-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .scratchpad-textarea {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 10px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            padding: 15px;
            resize: vertical;
        }

        .scratchpad-textarea:focus {
            outline: none;
            border-color: #FF8200;
        }

        .scratchpad-history {
            margin-top: 20px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-left: 3px solid #FF8200;
        }

        .history-timestamp {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
        }

        .history-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #e8e8e8;
            white-space: pre-wrap;
        }

        /* Coordinates Converter */
        .coord-result-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .coord-label {
            font-size: 0.65rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .coord-value {
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            color: #00ff88;
            word-break: break-all;
        }

        /* SNOWTAM Decoder */
        .snowtam-input {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 10px;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 15px;
            resize: vertical;
        }

        .snowtam-input:focus {
            outline: none;
            border-color: #FF8200;
        }

        .snowtam-decoded {
            margin-top: 15px;
        }

        .snowtam-runway {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .snowtam-runway-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FF8200;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 130, 0, 0.2);
        }

        .snowtam-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .snowtam-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .snowtam-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
        }

        .snowtam-value {
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .grf-good { color: #00ff88; }
        .grf-medium { color: #ffd700; }
        .grf-poor { color: #FF8200; }
        .grf-bad { color: #ff5252; }

        .friction-table {
            margin-top: 15px;
            font-size: 0.75rem;
            color: #888;
        }

        .friction-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .friction-table th, .friction-table td {
            padding: 6px 8px;
            border: 1px solid rgba(255, 130, 0, 0.2);
            text-align: center;
        }

        .friction-table th {
            background: rgba(255, 130, 0, 0.2);
            color: #FF8200;
        }

        /* Timezone Converter */
        .tz-converter {
            max-width: 500px;
            margin: 0 auto;
        }

        .tz-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .tz-offset {
            width: 50px;
            font-size: 0.85rem;
            color: #FF8200;
            font-weight: 600;
        }

        .tz-time {
            flex: 1;
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
        }

        .tz-label {
            width: 140px;
            font-size: 0.8rem;
            color: #7ec8e3;
            text-align: right;
        }

        /* Timezone converter mobile responsive */
        @media (max-width: 480px) {
            .tz-row {
                gap: 8px;
                padding: 8px;
            }
            .tz-offset {
                width: 35px;
                font-size: 0.75rem;
            }
            .tz-time {
                font-size: 1.1rem;
            }
            .tz-label {
                width: 70px;
                font-size: 0.65rem;
            }
            .tz-row select {
                width: 60px !important;
                font-size: 0.65rem !important;
                padding: 2px !important;
            }
        }

        /* LMC mobile responsive */
        @media (max-width: 600px) {
            #tab-lmc .top-sections {
                grid-template-columns: 1fr !important;
            }
            .lmc-change-fields {
                grid-template-columns: 1fr 1fr !important;
            }
            .lmc-field-group[style*="span 2"] {
                grid-column: span 2 !important;
            }
            /* NAV tab mobile */
            #tab-nav .top-sections {
                grid-template-columns: 1fr !important;
            }
            #tab-nav .section {
                max-width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            #tab-nav .section * {
                max-width: 100%;
                box-sizing: border-box;
            }
            #tab-nav .input-grid-2 {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }
            #tab-nav .fdp-input {
                min-width: 0;
                width: 100%;
            }
            #tab-nav .wind-display,
            #tab-nav .hold-display {
                max-width: 280px;
                margin: 10px auto;
            }
            #tab-nav .component-display {
                gap: 10px;
            }
            #tab-nav .component-value {
                font-size: 1.1rem;
            }
            /* WX tab mobile - stack vertically */
            #tab-wx .top-sections {
                grid-template-columns: 1fr !important;
            }
            #tab-wx .wind-display {
                max-width: 280px;
                margin: 10px auto;
            }
            #tab-wx .component-display {
                gap: 10px;
            }
            #tab-wx .component-value {
                font-size: 1.1rem;
            }
            #tab-wx .section {
                margin-bottom: 15px;
            }
            #tab-wx .snowtam-input {
                font-size: 14px;
            }
            #tab-wx .friction-table table {
                font-size: 0.75rem;
            }
            /* PERF tab mobile - stack 3 columns vertically */
            #tab-perf .top-sections {
                grid-template-columns: 1fr !important;
            }
            #tab-perf .input-grid-3 {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }
            #tab-perf .input-grid-2 {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-perf .maneuver-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 5px !important;
            }
            #tab-perf .maneuver-grid > div {
                padding: 8px 4px !important;
            }
            #tab-perf .section {
                max-width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            #tab-perf .section * {
                max-width: 100%;
                box-sizing: border-box;
            }
            #tab-perf .fdp-input {
                min-width: 0;
                width: 100%;
            }
            /* TIME tab mobile */
            #tab-time .top-sections {
                grid-template-columns: 1fr !important;
            }
            /* SET tab mobile */
            #tab-set .top-sections {
                grid-template-columns: 1fr !important;
            }
            /* FDP tab mobile */
            #tab-fdp .fdp-row {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            #tab-fdp .sector-inputs {
                grid-template-columns: 1fr !important;
            }
            #tab-fdp .local-offset-selector {
                flex-direction: column;
                gap: 8px;
            }
            #tab-fdp .fdp-results-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            /* FUEL tab mobile */
            #tab-fuel .top-sections {
                grid-template-columns: 1fr !important;
            }
            #tab-fuel .fdp-row[style*="grid-template-columns:1fr 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
            }
            /* SCHED tab mobile */
            #tab-sched .duty-info-row {
                grid-template-columns: 1fr 1fr 1fr !important;
                gap: 8px !important;
            }
            #tab-sched .duty-info-row .fdp-label {
                display: none !important;
            }
            #tab-sched .duty-info-row .fdp-field {
                margin: 0 !important;
            }
            #tab-sched .fdp-row[style*="grid-template-columns: 1fr 1fr 1fr"]:not(.duty-info-row) {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-sched .fdp-row[style*="grid-template-columns: 1fr 2fr 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-sched .fdp-row[style*="grid-template-columns: 1fr 1fr 1fr 0.8fr"] {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-sched .fdp-result-grid[style*="repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            /* TMR tab mobile */
            #tab-tmr .top-sections {
                grid-template-columns: 1fr !important;
            }
            /* LAY tab mobile */
            #tab-lay .top-sections {
                grid-template-columns: 1fr !important;
            }
            /* NOTES tab mobile */
            #tab-notes .top-sections {
                grid-template-columns: 1fr !important;
            }
            /* SUN tab mobile */
            #tab-sun .section {
                margin: 10px auto 0 !important;
                padding: 12px !important;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr 1fr auto"] {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr 1fr auto"] > button {
                grid-column: span 2;
                margin-top: 5px;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr auto"] {
                grid-template-columns: 1fr !important;
            }
            #tab-sun .section > div[style*="grid-template-columns: 1fr auto"] > button {
                margin-top: 5px;
            }
            #tab-sun #sun-sunrise-utc,
            #tab-sun #sun-sunset-utc {
                font-size: 1.4rem !important;
            }
            #tab-sun #sun-elevation,
            #tab-sun #sun-azimuth {
                font-size: 1.1rem !important;
            }
            #tab-sun #sun-daylight-trend {
                height: 70px !important;
            }
            /* General mobile adjustments */
            .section {
                min-width: auto !important;
            }
            .input-btn {
                min-width: 50px;
            }
            .tab-nav {
                flex-wrap: wrap;
                gap: 2px;
            }
            .tab-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            /* Top strip mobile */
            .active-timers-strip {
                padding: 8px 10px;
                gap: 6px;
                border-radius: 8px 8px 0 0;
            }
            .strip-top-row {
                gap: 10px;
                justify-content: space-between;
            }
            .strip-left-group {
                gap: 10px;
            }
            .strip-right-group {
                gap: 8px;
            }
            .strip-remt-row {
                padding: 4px 0;
            }
            .strip-clock-time {
                font-size: 1rem;
            }
            .strip-gps {
                display: none;
            }
            .strip-qibla {
                padding: 6px;
            }
            .strip-qibla-arrow {
                font-size: 1rem;
            }
            .strip-timers-row {
                gap: 6px;
            }
            .strip-timer {
                flex: 1 1 30%;
                min-width: 0;
                padding: 4px 8px;
            }
            .strip-timer-icon {
                width: 22px;
                height: 22px;
            }
            .strip-timer-name {
                font-size: 0.6rem;
            }
            .strip-timer-value {
                font-size: 0.85rem;
            }
            .tab-nav {
                padding: 6px 10px;
                border-radius: 0 0 8px 8px;
            }
            .sticky-header {
                margin-bottom: 10px;
            }
            /* MAP tab mobile */
            #tab-map .map-info-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            #tab-map .map-info-row > div {
                flex: 1 1 45%;
            }
            #map-container {
                height: 350px !important;
            }
            .map-route-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            /* MISC tab mobile */
            #tab-misc .top-sections {
                grid-template-columns: 1fr !important;
            }
            .pantry-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }
            .pantry-grid .input-group {
                min-width: 0 !important;
                overflow: hidden !important;
            }
            .pantry-grid select,
            .pantry-grid input {
                width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
            }
            #tab-misc .fdp-result-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* MAP mobile */
            #tab-map .fdp-section {
                max-width: 100% !important;
                overflow: hidden !important;
            }
            #tab-map .fdp-section * {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            #tab-map #geojson-input {
                width: 100% !important;
                min-width: 0 !important;
            }
            #tab-map .map-route-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }
            #tab-map .map-route-grid .input-group {
                min-width: 0 !important;
                overflow: hidden !important;
            }
            #tab-map .map-route-grid .fdp-input {
                width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
            }
            #tab-map .fdp-section > div[style*="display: flex; gap: 15px"] {
                flex-wrap: wrap !important;
                justify-content: space-around !important;
            }
            #tab-map .fdp-section > div[style*="display: flex; gap: 15px"] > div {
                flex: 1 1 30% !important;
                min-width: 70px !important;
            }
        }

        /* Toggle Buttons */
        .toggle-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .toggle-btn {
            width: 50px;
            height: 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            color: #888;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            border-color: #FF8200;
        }

        .toggle-btn.active {
            background: rgba(255, 130, 0, 0.3);
            border-color: #FF8200;
            color: #FF8200;
        }

        /* Wind SVG */
        .wind-svg {
            width: 100%;
            height: 100%;
        }

        /* Number Picker Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .number-picker {
            background: linear-gradient(135deg, #002540 0%, #003d66 100%);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 130, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .picker-title {
            text-align: center;
            font-size: 1.1rem;
            color: #FF8200;
            margin-bottom: 20px;
        }

        .picker-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .picker-value {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            min-width: 120px;
            text-align: center;
        }

        .picker-unit {
            font-size: 1.2rem;
            color: #888;
        }

        .picker-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .picker-btn {
            padding: 15px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: bold;
            transition: all 0.2s;
        }

        .picker-btn:hover {
            background: rgba(255, 130, 0, 0.3);
        }

        .picker-btn:active {
            transform: scale(0.95);
        }

        .picker-btn.clear {
            background: rgba(255, 100, 100, 0.3);
        }

        .picker-actions {
            display: flex;
            gap: 10px;
        }

        .picker-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .picker-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .picker-confirm {
            background: linear-gradient(135deg, #00c853, #009624);
            color: #fff;
        }

        /* Color states for countdown */
        .color-green { --clock-color: #00c853; --timer-color: #00ff88; }
        .color-yellow { --clock-color: #ffc107; --timer-color: #ffd54f; }
        .color-orange { --clock-color: #FF8200; --timer-color: #FF8200; }
        .color-red { --clock-color: #f44336; --timer-color: #ff5252; }
        .color-expired { --clock-color: #b71c1c; --timer-color: #ff1744; }
        .color-neutral { --clock-color: #006496; --timer-color: #00d4ff; }

        /* FDP Calculator Styles */
        .fdp-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .fdp-section {
            background: rgba(0, 37, 64, 0.7);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 130, 0, 0.2);
        }

        .fdp-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .fdp-field {
            display: flex;
            flex-direction: column;
        }

        .fdp-label {
            font-size: 0.8rem;
            color: #7ec8e3;
            margin-bottom: 5px;
        }

        .fdp-select, .fdp-input {
            padding: 10px;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .fdp-select {
            cursor: pointer;
        }

        .fdp-select option {
            background: #002540;
            color: #fff;
        }

        .fdp-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .fdp-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .fdp-result-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .fdp-result-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .fdp-result-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .fdp-result-local {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
            margin-top: 3px;
        }

        .fdp-result-utc {
            font-size: 0.8rem;
            color: #888;
            margin-top: 3px;
        }

        .fdp-result-value.green { color: #00ff88; }
        .fdp-result-value.yellow { color: #ffd700; }
        .fdp-result-value.orange { color: #FF8200; }
        .fdp-result-value.red { color: #ff5252; }

        .fdp-warning {
            background: rgba(255, 130, 0, 0.2);
            border: 1px solid rgba(255, 130, 0, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #FF8200;
            font-size: 0.9rem;
        }

        .fdp-danger {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            color: #ff5252;
            font-size: 0.9rem;
        }

        .sector-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 800px) {
            .sector-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sector-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .sector-title {
            font-size: 0.85rem;
            color: #FF8200;
            margin-bottom: 10px;
            text-align: center;
        }

        .sector-field {
            margin-bottom: 8px;
        }

        .sector-field label {
            font-size: 0.7rem;
            color: #888;
            display: block;
            margin-bottom: 3px;
        }

        .turnaround-display {
            text-align: center;
            padding: 5px;
            background: rgba(255, 130, 0, 0.1);
            border-radius: 5px;
            margin-top: 5px;
        }

        .turnaround-label {
            font-size: 0.65rem;
            color: #888;
        }

        .turnaround-value {
            font-size: 0.9rem;
            color: #FF8200;
            font-family: 'Courier New', monospace;
        }

        /* Local time offset selector */
        .local-offset-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .local-offset-selector label {
            font-size: 0.85rem;
            color: #7ec8e3;
        }

        .local-offset-selector select {
            padding: 8px 12px;
            background: #002540;
            border: 2px solid #FF8200;
            border-radius: 5px;
            color: #FF8200;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .local-offset-selector select option {
            background: #002540;
            color: #FF8200;
        }

        /* Actual tracking section */
        .actual-tracking {
            background: rgba(0, 100, 150, 0.1);
            border: 1px solid rgba(0, 100, 150, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .actual-tracking-title {
            font-size: 0.9rem;
            color: #006496;
            margin-bottom: 10px;
            text-align: center;
        }

        .actual-sector-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (max-width: 800px) {
            .actual-sector-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .duty-estimate {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .duty-estimate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .duty-estimate-label {
            font-size: 0.85rem;
            color: #888;
        }

        .duty-estimate-value {
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* iPad specific */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            /* Compact horizontal timer cards on mobile */
            .timer-card {
                flex-direction: row;
                padding: 10px;
                gap: 10px;
            }
            .clock-face {
                width: 65px;
                height: 65px;
            }
            .clock-inner {
                top: 5px;
                left: 5px;
                right: 5px;
                bottom: 5px;
            }
            .clock-time {
                font-size: 0.75rem;
            }
            .timer-display {
                display: none;
            }
            .timer-name-input {
                padding: 4px 8px;
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            .timer-type-toggle {
                margin-bottom: 5px;
            }
            .type-btn {
                padding: 4px;
                font-size: 0.7rem;
            }
            .timer-time-setup {
                margin-bottom: 5px;
            }
            .time-input-btn {
                width: 40px;
                height: 30px;
                font-size: 0.9rem;
            }
            .timer-btn {
                padding: 6px;
                font-size: 0.75rem;
            }
            .btn-repeat {
                flex: 0 0 32px;
                font-size: 0.9rem;
            }

            .tab-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                flex-shrink: 0;
            }

            .tab-nav {
                top: 70px;
                padding: 8px 10px;
                gap: 6px;
            }

            /* Coordinates Converter Mobile */
            #coord-gps-box {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            #coord-gps-box > div:first-child {
                justify-content: center;
            }

            .coord-results-grid {
                grid-template-columns: 1fr !important;
            }

            .coord-result-item {
                padding: 8px;
            }

            .coord-value {
                font-size: 0.85rem;
            }

            /* Coordinate Converter Manual Entry Mobile */
            .coord-manual-entry-grid {
                grid-template-columns: 1fr !important;
            }

            /* Sun & Moon Direction Mobile */
            .sun-moon-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            .sun-moon-direction-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            /* Airport Distance Calc Mobile */
            #tab-nav .input-grid-2 {
                grid-template-columns: 1fr 1fr;
            }

            .dist-track-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .dist-names-grid {
                grid-template-columns: 1fr 1fr !important;
            }

            /* SUN tab mobile grids */
            .sun-location-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }

            .sun-location-grid .fdp-field {
                min-width: 0 !important;
            }

            .sun-location-grid .fdp-input {
                width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
            }

            .sun-location-grid .sun-gps-btn {
                flex-shrink: 0 !important;
                padding: 8px !important;
            }

            .twilight-grid {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }

            .arrival-conditions-grid {
                grid-template-columns: 1fr 1fr !important;
            }

            .night-time-grid {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            .night-time-grid .fdp-field {
                flex: 1 1 45% !important;
                min-width: 70px !important;
            }

            .night-time-grid .fdp-field:nth-child(3) {
                flex: 1 1 100% !important;
            }

            #sun-sector-switcher {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
        }

        button {
            -webkit-user-select: none;
            user-select: none;
        }

        .timer-btn:active {
            transform: scale(0.98);
        }

        /* LMC Calculator Styles */
        .lmc-summary {
            background: rgba(0, 40, 80, 0.3);
            border-radius: 8px;
            padding: 12px;
        }

        .lmc-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .lmc-label {
            color: #888;
            font-size: 0.85rem;
        }

        .lmc-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00d4ff;
            font-size: 1rem;
        }

        .lmc-validation {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lmc-check {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0, 40, 80, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .lmc-check-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .lmc-check.pass .lmc-check-icon { color: #00ff88; }
        .lmc-check.fail .lmc-check-icon { color: #ff5252; }
        .lmc-check.warn .lmc-check-icon { color: #ffd700; }
        .lmc-check.pass { border-left: 3px solid #00ff88; }
        .lmc-check.fail { border-left: 3px solid #ff5252; }
        .lmc-check.warn { border-left: 3px solid #ffd700; }

        .lmc-decision {
            border-radius: 10px;
            padding: 15px 20px;
            text-align: center;
            margin-top: 15px;
        }

        .lmc-decision.pending {
            background: rgba(100, 100, 100, 0.3);
            border: 2px solid #666;
        }

        .lmc-decision.pass {
            background: rgba(0, 200, 80, 0.2);
            border: 2px solid #00ff88;
        }

        .lmc-decision.fail {
            background: rgba(255, 50, 50, 0.2);
            border: 2px solid #ff5252;
        }

        .lmc-decision-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .lmc-decision-icon {
            font-size: 1.8rem;
        }

        .lmc-decision.pass .lmc-decision-icon { color: #00ff88; }
        .lmc-decision.fail .lmc-decision-icon { color: #ff5252; }
        .lmc-decision.pending .lmc-decision-icon { color: #888; }

        .lmc-decision-text {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .lmc-decision.pass .lmc-decision-text { color: #00ff88; }
        .lmc-decision.fail .lmc-decision-text { color: #ff5252; }
        .lmc-decision.pending .lmc-decision-text { color: #888; }

        .lmc-decision-details {
            background: rgba(0, 40, 80, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .lmc-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85rem;
        }

        .lmc-detail-label { color: #888; }
        .lmc-detail-value { color: #e8e8e8; font-weight: bold; }

        .lmc-audit {
            background: rgba(0, 20, 40, 0.5);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.8rem;
        }

        .lmc-audit-title {
            color: #888;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .lmc-audit-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .lmc-audit-item:last-child { border-bottom: none; }

        .lmc-change-entry {
            background: rgba(0, 40, 80, 0.4);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #00d4ff;
        }

        .lmc-change-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .lmc-change-type {
            font-weight: bold;
            color: #00d4ff;
            font-size: 0.9rem;
        }

        .lmc-change-remove {
            background: rgba(255, 82, 82, 0.3);
            border: none;
            color: #ff5252;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .lmc-change-remove:hover {
            background: rgba(255, 82, 82, 0.5);
        }

        .lmc-change-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .lmc-field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lmc-field-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .lmc-field-select, .lmc-field-input {
            background: rgba(0, 40, 80, 0.5);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 6px;
            color: #e8e8e8;
            padding: 8px;
            font-size: 0.9rem;
        }

        .lmc-result-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 8px;
            background: rgba(0, 60, 100, 0.3);
            border-radius: 4px;
            margin-top: 8px;
        }

        .lmc-result-label { color: #888; font-size: 0.8rem; }
        .lmc-result-value { color: #00ff88; font-family: 'Courier New', monospace; font-weight: bold; }

        .lmc-toggle-btn {
            background: rgba(0, 40, 80, 0.5);
            border: 1px solid rgba(0, 180, 255, 0.3);
            border-radius: 4px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lmc-toggle-btn:hover {
            background: rgba(0, 100, 180, 0.4);
            border-color: rgba(0, 212, 255, 0.5);
        }
        .lmc-toggle-btn.active {
            background: rgba(0, 180, 255, 0.3);
            border-color: #00d4ff;
            color: #00d4ff;
            font-weight: bold;
        }

        /* Qibla Display Styles */
        .strip-qibla {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-left: 15px;
            border-left: 1px solid rgba(255, 130, 0, 0.3);
        }

        .strip-qibla:hover {
            opacity: 0.8;
        }

        .strip-qibla-arrow {
            font-size: 1.6rem;
            color: #00ff88;
            transition: transform 0.3s ease;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .strip-qibla-value {
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00ff88;
        }

        .strip-qibla-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .strip-qibla.no-gps .strip-qibla-arrow,
        .strip-qibla.no-gps .strip-qibla-value {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .strip-gps {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 12px;
            border-right: 1px solid rgba(255, 130, 0, 0.3);
        }

        .strip-gps-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .strip-gps-label {
            font-size: 0.6rem;
            color: #666;
            min-width: 22px;
        }

        .strip-gps-value {
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            color: #00d4ff;
        }

        .strip-gps.no-fix .strip-gps-value {
            color: #888;
        }

        .qibla-modal-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .qibla-source-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .qibla-source-btn {
            padding: 10px 20px;
            border: 2px solid rgba(0, 180, 255, 0.3);
            background: rgba(0, 40, 80, 0.5);
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .qibla-source-btn.active {
            background: rgba(0, 180, 255, 0.3);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .qibla-gps-status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 40, 80, 0.3);
        }

        .qibla-gps-status.connected {
            border-left: 3px solid #00ff88;
        }

        .qibla-gps-status.disconnected {
            border-left: 3px solid #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sticky Header (Info Strip + Tab Bar) -->
        <div class="sticky-header">
        <!-- Active Timers Strip -->
        <div class="active-timers-strip" id="active-timers-strip">
            <!-- Top Row: Clocks, GPS, Qibla -->
            <div class="strip-top-row">
                <div class="strip-left-group">
                    <div class="strip-clock">
                        <div class="strip-clock-time" id="strip-utc-clock">--:--:--</div>
                        <div class="strip-clock-label">UTC</div>
                    </div>
                    <div class="strip-clock" style="border-right: 1px solid rgba(255, 130, 0, 0.3); padding-right: 15px;">
                        <div class="strip-clock-time" id="strip-dxb-clock" style="color: #FF8200;">--:--</div>
                        <div class="strip-clock-label">DXB</div>
                    </div>
                </div>
                <div class="strip-right-group">
                    <div class="strip-gps" id="strip-gps">
                        <div class="strip-gps-row">
                            <span class="strip-gps-label">POS</span>
                            <span class="strip-gps-value" id="strip-gps-pos">---</span>
                        </div>
                        <div class="strip-gps-row">
                            <span class="strip-gps-label">TRK</span>
                            <span class="strip-gps-value" id="strip-gps-trk">---Â°</span>
                            <span class="strip-gps-label" style="margin-left: 8px;">GS</span>
                            <span class="strip-gps-value" id="strip-gps-gs">---kt</span>
                        </div>
                    </div>
                    <div class="strip-qibla" id="strip-qibla" onclick="openQiblaModal()" style="cursor: pointer;">
                        <div class="strip-qibla-arrow" id="strip-qibla-arrow">&#10148;</div>
                        <div class="strip-qibla-value" id="strip-qibla-value">---Â°</div>
                        <div class="strip-qibla-label">QIBLA</div>
                    </div>
                </div>
            </div>
            <!-- REMT Row (Remaining Time) -->
            <div class="strip-remt-row" id="strip-eta" style="display:none" onclick="switchTab('time')">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="strip-eta-label">ETA</span>
                    <span id="strip-eta-target" style="font-family: 'Courier New', monospace; color: #00d4ff; font-size: 1rem;">----</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="strip-eta-label">REMT</span>
                    <span class="strip-eta-time" id="strip-eta-time">--:--</span>
                </div>
            </div>
            <!-- Bottom Row: Active Timers -->
            <div class="strip-timers-row" id="strip-timers"></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('sched')">SCHED</button>
            <button class="tab-btn" onclick="switchTab('fdp')">FDP</button>
            <button class="tab-btn" onclick="switchTab('fuel')">FUEL</button>
            <button class="tab-btn" onclick="switchTab('perf')">PERF</button>
            <button class="tab-btn" onclick="switchTab('time')">TIME</button>
            <button class="tab-btn" onclick="switchTab('nav')">NAV</button>
            <button class="tab-btn" onclick="switchTab('wx')">WX</button>
            <button class="tab-btn" onclick="switchTab('map')">MAP</button>
            <button class="tab-btn" onclick="switchTab('tmr')">TMR</button>
            <button class="tab-btn" onclick="switchTab('lay')">LAY</button>
            <button class="tab-btn" onclick="switchTab('lmc')">LMC</button>
            <button class="tab-btn" onclick="switchTab('notes')">NOTES</button>
            <button class="tab-btn" onclick="switchTab('misc')">MISC</button>
            <button class="tab-btn" onclick="switchTab('sun')">SUN</button>
            <button class="tab-btn" onclick="switchTab('set')">SET</button>
            <button class="tab-btn" onclick="switchTab('ref')">REF</button>
        </div>
        </div><!-- End sticky-header -->

        <!-- SCHED Tab (Schedule Entry - Primary Tab) -->
        <div class="tab-content active" id="tab-sched">
            <div class="fdp-container">
                <!-- Duty Information -->
                <div class="fdp-section">
                    <div class="section-title">Duty Information</div>
                    <div class="fdp-row duty-info-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Tail Number</label>
                            <button class="input-btn" id="sched-tail-btn" onclick="openTailPicker()" style="max-width: 100%;">A6</button>
                            <input type="hidden" id="sched-tail" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Aircraft Type</label>
                            <div class="fdp-result-value" id="sched-aircraft-display" style="font-size: 1rem; color: #00d4ff; min-height: 38px; display: flex; align-items: center; justify-content: center;">---</div>
                            <input type="hidden" id="sched-aircraft" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Config</label>
                            <select class="fdp-select" id="sched-config" onchange="onConfigChange()" style="max-width: 100%;">
                                <option value="">Select tail first</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sector 1 -->
                <div class="fdp-section sector-block" id="sector-1-block">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 1</span>
                        <span id="sector-1-turnaround" class="turnaround-badge" style="display: none;">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s1-flt-btn" onclick="openFlightPicker('s1-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s1-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s1-dep-btn" onclick="openTextPicker('s1-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">â†’</span>
                                <button class="input-btn" id="s1-arr-btn" onclick="openTextPicker('s1-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s1-dep" value="">
                            <input type="hidden" id="s1-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s1-pax-btn" onclick="openWeightPicker('s1-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s1-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s1-stand-btn" onclick="openStandPicker('s1-stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s1-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid: 3-column layout (STD/STA | OUT/ON | OFF/IN) -->
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <!-- Column 1: STD/STA -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #888;">STD</label>
                                    <button class="input-btn" id="s1-std-btn" onclick="openTimePicker('s1-std')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-std" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #888;">STA</label>
                                    <button class="input-btn" id="s1-sta-btn" onclick="openTimePicker('s1-sta')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-sta" value="">
                                </div>
                            </div>
                            <!-- Column 2: OUT/ON -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OUT</label>
                                    <button class="input-btn" id="s1-out-btn" onclick="openTimePicker('s1-out')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-out" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">ON</label>
                                    <button class="input-btn" id="s1-on-btn" onclick="openTimePicker('s1-on')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-on" value="">
                                </div>
                            </div>
                            <!-- Column 3: OFF/IN -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                                    <button class="input-btn" id="s1-off-btn" onclick="openTimePicker('s1-off')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-off" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">IN</label>
                                    <button class="input-btn" id="s1-in-btn" onclick="openTimePicker('s1-in')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s1-in" value="">
                                </div>
                            </div>
                        </div>
                        <!-- Results Row: Delays + Block/Flight -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255, 130, 0, 0.1);">
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">DEP Î”</div>
                                <div class="fdp-result-value" id="s1-dep-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">ARR Î”</div>
                                <div class="fdp-result-value" id="s1-arr-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s1-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s1-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 2 -->
                <div class="fdp-section sector-block" id="sector-2-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 2</span>
                        <span id="sector-2-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s2-flt-btn" onclick="openFlightPicker('s2-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s2-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s2-dep-btn" onclick="openTextPicker('s2-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">â†’</span>
                                <button class="input-btn" id="s2-arr-btn" onclick="openTextPicker('s2-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s2-dep" value="">
                            <input type="hidden" id="s2-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s2-pax-btn" onclick="openWeightPicker('s2-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s2-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s2-stand-btn" onclick="openStandPicker('s2-stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s2-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid: 3-column layout (STD/STA | OUT/ON | OFF/IN) -->
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #888;">STD</label>
                                    <button class="input-btn" id="s2-std-btn" onclick="openTimePicker('s2-std')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-std" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #888;">STA</label>
                                    <button class="input-btn" id="s2-sta-btn" onclick="openTimePicker('s2-sta')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-sta" value="">
                                </div>
                            </div>
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OUT</label>
                                    <button class="input-btn" id="s2-out-btn" onclick="openTimePicker('s2-out')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-out" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">ON</label>
                                    <button class="input-btn" id="s2-on-btn" onclick="openTimePicker('s2-on')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-on" value="">
                                </div>
                            </div>
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                                    <button class="input-btn" id="s2-off-btn" onclick="openTimePicker('s2-off')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-off" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">IN</label>
                                    <button class="input-btn" id="s2-in-btn" onclick="openTimePicker('s2-in')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s2-in" value="">
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255, 130, 0, 0.1);">
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">DEP Î”</div>
                                <div class="fdp-result-value" id="s2-dep-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">ARR Î”</div>
                                <div class="fdp-result-value" id="s2-arr-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s2-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s2-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 3 -->
                <div class="fdp-section sector-block" id="sector-3-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 3</span>
                        <span id="sector-3-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s3-flt-btn" onclick="openFlightPicker('s3-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s3-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s3-dep-btn" onclick="openTextPicker('s3-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">â†’</span>
                                <button class="input-btn" id="s3-arr-btn" onclick="openTextPicker('s3-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s3-dep" value="">
                            <input type="hidden" id="s3-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s3-pax-btn" onclick="openWeightPicker('s3-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s3-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s3-stand-btn" onclick="openStandPicker('s3-stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s3-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid: 3-column layout (STD/STA | OUT/ON | OFF/IN) -->
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #888;">STD</label>
                                    <button class="input-btn" id="s3-std-btn" onclick="openTimePicker('s3-std')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-std" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #888;">STA</label>
                                    <button class="input-btn" id="s3-sta-btn" onclick="openTimePicker('s3-sta')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-sta" value="">
                                </div>
                            </div>
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OUT</label>
                                    <button class="input-btn" id="s3-out-btn" onclick="openTimePicker('s3-out')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-out" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">ON</label>
                                    <button class="input-btn" id="s3-on-btn" onclick="openTimePicker('s3-on')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-on" value="">
                                </div>
                            </div>
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                                    <button class="input-btn" id="s3-off-btn" onclick="openTimePicker('s3-off')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-off" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">IN</label>
                                    <button class="input-btn" id="s3-in-btn" onclick="openTimePicker('s3-in')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s3-in" value="">
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255, 130, 0, 0.1);">
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">DEP Î”</div>
                                <div class="fdp-result-value" id="s3-dep-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">ARR Î”</div>
                                <div class="fdp-result-value" id="s3-arr-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s3-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s3-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector 4 -->
                <div class="fdp-section sector-block" id="sector-4-block" style="display: none;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sector 4</span>
                        <span id="sector-4-turnaround" class="turnaround-badge">T/A: --:--</span>
                    </div>
                    <!-- Flight Info Row -->
                    <div class="fdp-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Flight #</label>
                            <button class="input-btn" id="s4-flt-btn" onclick="openFlightPicker('s4-flt')" style="max-width: 100%;">FZ___</button>
                            <input type="hidden" id="s4-flt" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Route</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="s4-dep-btn" onclick="openTextPicker('s4-dep', 'Departure')" style="flex: 1; font-size: 0.85rem;">DEP</button>
                                <span style="color: #888; align-self: center;">â†’</span>
                                <button class="input-btn" id="s4-arr-btn" onclick="openTextPicker('s4-arr', 'Arrival')" style="flex: 1; font-size: 0.85rem;">ARR</button>
                            </div>
                            <input type="hidden" id="s4-dep" value="">
                            <input type="hidden" id="s4-arr" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">PAX</label>
                            <button class="input-btn" id="s4-pax-btn" onclick="openWeightPicker('s4-pax', 'PAX')" style="max-width: 100%">---</button>
                            <input type="hidden" id="s4-pax" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Stand</label>
                            <button class="input-btn" id="s4-stand-btn" onclick="openStandPicker('s4-stand')" style="max-width: 100%; font-size: 0.85rem;">---</button>
                            <input type="hidden" id="s4-stand" value="">
                        </div>
                    </div>
                    <!-- Times Grid: 3-column layout (STD/STA | OUT/ON | OFF/IN) -->
                    <div style="padding-top: 10px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <!-- Column 1: STD/STA -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #888;">STD</label>
                                    <button class="input-btn" id="s4-std-btn" onclick="openTimePicker('s4-std')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-std" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #888;">STA</label>
                                    <button class="input-btn" id="s4-sta-btn" onclick="openTimePicker('s4-sta')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-sta" value="">
                                </div>
                            </div>
                            <!-- Column 2: OUT/ON -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OUT</label>
                                    <button class="input-btn" id="s4-out-btn" onclick="openTimePicker('s4-out')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-out" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">ON</label>
                                    <button class="input-btn" id="s4-on-btn" onclick="openTimePicker('s4-on')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-on" value="">
                                </div>
                            </div>
                            <!-- Column 3: OFF/IN -->
                            <div>
                                <div class="fdp-field" style="margin-bottom: 8px;">
                                    <label class="fdp-label" style="color: #00d4ff;">OFF</label>
                                    <button class="input-btn" id="s4-off-btn" onclick="openTimePicker('s4-off')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-off" value="">
                                </div>
                                <div class="fdp-field">
                                    <label class="fdp-label" style="color: #00d4ff;">IN</label>
                                    <button class="input-btn" id="s4-in-btn" onclick="openTimePicker('s4-in')" style="max-width: 100%; font-size: 0.9rem;">----</button>
                                    <input type="hidden" id="s4-in" value="">
                                </div>
                            </div>
                        </div>
                        <!-- Results Row: Delays + Block/Flight -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255, 130, 0, 0.1);">
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">DEP Î”</div>
                                <div class="fdp-result-value" id="s4-dep-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label" style="font-size: 0.6rem;">ARR Î”</div>
                                <div class="fdp-result-value" id="s4-arr-delay" style="font-size: 0.85rem;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">BLOCK</div>
                                <div class="fdp-result-value" id="s4-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="fdp-label">FLIGHT</div>
                                <div class="fdp-result-value" id="s4-flight" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Remove Sector Buttons -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button class="preset-btn" id="add-sector-btn" onclick="addSector()">+ Add Sector</button>
                    <button class="clear-btn" id="remove-sector-btn" onclick="removeSector()" style="margin: 0;">- Remove Sector</button>
                    <button class="clear-btn" onclick="clearSchedule()" style="margin: 0; margin-left: 20px;">Clear All</button>
                </div>

                <!-- Duty Summary -->
                <div class="fdp-section" style="margin-top: 20px;">
                    <div class="section-title">Duty Summary</div>
                    <div class="fdp-results" style="margin-top: 0;">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Sectors</div>
                                <div class="fdp-result-value" id="sched-total-sectors" style="color: #FF8200;">1</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Block</div>
                                <div class="fdp-result-value" id="sched-total-block" style="color: #ffd700;">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Total Flight</div>
                                <div class="fdp-result-value" id="sched-total-flight" style="color: #00ff88;">--:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Duty Time</div>
                                <div class="fdp-result-value" id="sched-duty-time" style="color: #00d4ff;">--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PERF Tab (Performance: TOW, ACC Height, Max Landing Fuel) -->
        <div class="tab-content" id="tab-perf">
            <div class="top-sections" style="grid-template-columns: repeat(3, 1fr);">
                <!-- TOW Calculator -->
                <div class="section">
                    <div class="section-title">TOW Calculator</div>
                    <div class="aircraft-selector" style="margin-bottom:10px">
                        <button class="aircraft-btn active" id="tow-ac-b738" onclick="selectAircraft('B738')">B738</button>
                        <button class="aircraft-btn" id="tow-ac-b38m" onclick="selectAircraft('B38M')">B38M</button>
                        <button class="aircraft-btn" id="tow-ac-b39m" onclick="selectAircraft('B39M')">B39M</button>
                    </div>
                    <div class="input-grid-3">
                        <div class="input-group">
                            <label class="input-label">ZFW</label>
                            <button class="input-btn placeholder" id="calc-zfw-btn" onclick="openWeightPicker('calc-zfw', 'ZFW')">0</button>
                            <input type="hidden" id="calc-zfw" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">FOB</label>
                            <button class="input-btn placeholder" id="calc-fob-btn" onclick="openWeightPicker('calc-fob', 'FOB')">0</button>
                            <input type="hidden" id="calc-fob" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">TAXI</label>
                            <button class="input-btn placeholder" id="calc-taxi-btn" onclick="openWeightPicker('calc-taxi', 'Taxi Fuel')">0</button>
                            <input type="hidden" id="calc-taxi" value="">
                        </div>
                    </div>
                    <div class="input-grid-2" style="margin-top:8px;">
                        <div class="input-group">
                            <label class="input-label">TRIP FUEL</label>
                            <button class="input-btn placeholder" id="calc-trip-btn" onclick="openWeightPicker('calc-trip', 'Trip Fuel')">0</button>
                            <input type="hidden" id="calc-trip" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">EST LDG FUEL</label>
                            <div class="result-value" id="est-ldg-fuel" style="font-size:0.9rem; padding:8px 0; color:#7ec8e3;">---</div>
                        </div>
                    </div>
                    <div class="results-row" style="flex-wrap:wrap; gap:10px;">
                        <div class="result-item">
                            <div class="result-label">TAXI WT</div>
                            <div class="result-value" id="taxi-wt-result" style="font-size:1rem">---</div>
                            <div class="result-label" id="mtw-limit" style="color:#666; font-size:0.65rem">MTW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">TAKE OFF WT</div>
                            <div class="result-value tow-value" id="tow-result">---</div>
                            <div class="result-label" id="mtow-limit" style="color:#666; font-size:0.65rem">MTOW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">EST LDG WT</div>
                            <div class="result-value" id="ldw-result" style="font-size:1rem; color:#00ff88">---</div>
                            <div class="result-label" id="mlw-limit" style="color:#666; font-size:0.65rem">MLW: ---</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ZFW</div>
                            <div class="result-value" id="zfw-display" style="font-size:1rem; color:#7ec8e3">---</div>
                            <div class="result-label" id="mzfw-limit" style="color:#666; font-size:0.65rem">MZFW: ---</div>
                        </div>
                    </div>
                    <div id="tow-warnings" style="margin-top:10px"></div>
                    <button class="clear-btn" id="calc-clear">Clear</button>
                </div>

                <!-- OPT ACC Calculator -->
                <div class="section" style="min-width:200px">
                    <div class="section-title">Acceleration Height</div>
                    <div class="input-grid-2" style="gap:12px">
                        <div class="input-group">
                            <label class="input-label">Airport</label>
                            <input type="text" class="fdp-input" id="acc-airport" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value = this.value.toUpperCase(); autofillAccElevation()">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ELEV (ft)</label>
                            <div class="input-btn-with-unit" style="width:100%">
                                <button class="input-btn placeholder" id="airfield-elev-btn" onclick="openWeightPicker('airfield-elev', 'Elevation', 'ft')" style="max-width:110px; padding-right:25px">---</button>
                                <span class="input-btn-unit" style="right:10px">ft</span>
                            </div>
                            <input type="hidden" id="airfield-elev" value="">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 12px;">
                        <label class="input-label">OPT ACC (ft)</label>
                        <div class="input-btn-with-unit" style="width:100%">
                            <button class="input-btn placeholder" id="opt-acc-btn" onclick="openWeightPicker('opt-acc', 'OPT ACC', 'ft')" style="max-width:100%; padding-right:25px">---</button>
                            <span class="input-btn-unit" style="right:10px">ft</span>
                        </div>
                        <input type="hidden" id="opt-acc" value="">
                    </div>
                    <div class="results-row">
                        <div class="result-item">
                            <div class="result-label">ACC HEIGHT AGL</div>
                            <div class="result-value acc-value" id="acc-result">--- ft</div>
                        </div>
                    </div>
                    <button class="clear-btn" id="acc-clear">Clear</button>
                </div>
            </div>

            <!-- VREF / Maneuver Speed Calculator -->
            <div class="top-sections" style="margin-top: 20px;">
                <div class="section">
                    <div class="section-title">VREF / Maneuver Speeds</div>
                    <div class="aircraft-selector" style="margin-bottom:12px">
                        <button class="aircraft-btn active" id="vref-ac-b738" onclick="selectVrefAircraft('B738')">B738</button>
                        <button class="aircraft-btn" id="vref-ac-b38m" onclick="selectVrefAircraft('B38M')">B38M</button>
                        <button class="aircraft-btn" id="vref-ac-b39m" onclick="selectVrefAircraft('B39M')">B39M</button>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Landing Weight</label>
                        <div class="input-btn-with-unit" style="width: 100%;">
                            <button class="input-btn placeholder" id="vref-weight-btn" onclick="openTonnesPicker('vref-weight', 'Landing Weight')" style="max-width: 100%; padding-right: 30px;">---</button>
                            <span class="input-btn-unit" style="right: 10px;">T</span>
                        </div>
                        <input type="hidden" id="vref-weight" value="">
                    </div>

                    <!-- VREF Results -->
                    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                        <div style="color: #888; font-size: 0.75rem; text-align: center; margin-bottom: 10px;">REFERENCE SPEEDS</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #888;">VREF 40</div>
                                <div id="vref-40" style="font-size: 1.5rem; color: #FF8200; font-family: monospace; font-weight: bold;">---</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #888;">VREF 30</div>
                                <div id="vref-30" style="font-size: 1.5rem; color: #FF8200; font-family: monospace; font-weight: bold;">---</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #888;">VREF 15</div>
                                <div id="vref-15" style="font-size: 1.5rem; color: #FF8200; font-family: monospace; font-weight: bold;">---</div>
                            </div>
                        </div>
                    </div>

                    <!-- Maneuver Speeds -->
                    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                        <div style="color: #888; font-size: 0.75rem; text-align: center; margin-bottom: 10px;">MANEUVER SPEEDS</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center;" class="maneuver-grid">
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">UP</div>
                                <div id="man-up" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 1</div>
                                <div id="man-1" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 5</div>
                                <div id="man-5" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 10</div>
                                <div id="man-10" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 15</div>
                                <div id="man-15" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 25</div>
                                <div id="man-25" style="font-size: 1.1rem; color: #00d4ff; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 30</div>
                                <div id="man-30" style="font-size: 1.1rem; color: #00ff88; font-family: monospace;">---</div>
                            </div>
                            <div style="background: rgba(0,100,150,0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 0.65rem; color: #7ec8e3;">FLAP 40</div>
                                <div id="man-40" style="font-size: 1.1rem; color: #00ff88; font-family: monospace;">---</div>
                            </div>
                        </div>
                    </div>

                    <!-- Aircraft Info -->
                    <div id="vref-info" style="margin-top: 12px; text-align: center; font-size: 0.7rem; color: #666;">
                        Select aircraft and enter landing weight
                    </div>
                    <button class="clear-btn" onclick="clearVref()">Clear</button>
                </div>
            </div>

            <!-- Flight Path Calculators -->
            <div class="top-sections" style="margin-top: 20px; grid-template-columns: repeat(3, 1fr);">
                <!-- Glide Path / Rate of Descent Calculator -->
                <div class="section">
                    <div class="section-title">Glide Path / ROD</div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">Airport</label>
                            <input type="text" class="fdp-input" id="gp-airport" placeholder="ICAO" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value = this.value.toUpperCase(); autofillGpElevation()">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Elevation (ft)</label>
                            <button class="input-btn" id="gp-elev-btn" onclick="openWeightPicker('gp-elev', 'Elevation', 'ft')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="gp-elev" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">OAT (Â°C)</label>
                            <button class="input-btn" id="gp-oat-btn" onclick="openWxTempPicker('gp-oat', 'OAT')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="gp-oat" value="">
                        </div>
                    </div>
                    <div class="input-grid-2" style="margin-top: 10px;">
                        <div class="input-group">
                            <label class="input-label">GP Angle (Â°)</label>
                            <button class="input-btn" id="gp-angle-btn" onclick="openGlidePicker('gp-angle', 'Glide Path')" style="max-width: 100%;">3.0</button>
                            <input type="hidden" id="gp-angle" value="3.0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ground Speed (kt)</label>
                            <button class="input-btn" id="gp-gs-btn" onclick="openWeightPicker('gp-gs', 'Ground Speed', 'kt')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="gp-gs" value="">
                        </div>
                    </div>
                    <div style="margin-top: 12px; border-top: 1px solid #333; padding-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: center;">
                            <div>
                                <div style="font-size: 0.65rem; color: #888;">ISA / Deviation</div>
                                <div style="display: flex; justify-content: center; gap: 8px;">
                                    <span class="fdp-result-value" id="gp-isa" style="font-size: 0.85rem;">---Â°C</span>
                                    <span class="fdp-result-value" id="gp-dev" style="font-size: 0.85rem;">---</span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: #888;">Effective GP</div>
                                <div class="fdp-result-value" id="gp-effective" style="font-size: 1.1rem; color: #00ff88;">---Â°</div>
                                <div id="gp-hot-cold" style="font-size: 0.6rem;"></div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <div style="font-size: 0.65rem; color: #888;">Rate of Descent</div>
                            <div class="fdp-result-value" id="gp-rod" style="font-size: 1.4rem; color: #ff8200;">--- fpm</div>
                        </div>
                    </div>
                    <button class="clear-btn" onclick="clearGlidePath()">Clear</button>
                </div>

                <!-- Climb Gradient Calculator -->
                <div class="section">
                    <div class="section-title">Climb Gradient</div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">Rate of Climb (fpm)</label>
                            <button class="input-btn" id="climb-roc-btn" onclick="openWeightPicker('climb-roc', 'Rate of Climb', 'fpm')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="climb-roc" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ground Speed (kt)</label>
                            <button class="input-btn" id="climb-gs-btn" onclick="openWeightPicker('climb-gs', 'Ground Speed', 'kt')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="climb-gs" value="">
                        </div>
                    </div>
                    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; text-align: center;">
                        <div style="font-size: 0.7rem; color: #888;">Climb Gradient</div>
                        <div class="fdp-result-value" id="climb-gradient" style="font-size: 1.8rem; color: #00ff88;">--- %</div>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 8px;">Climb Angle</div>
                        <div class="fdp-result-value" id="climb-angle" style="font-size: 1.2rem; color: #00d4ff;">---Â°</div>
                    </div>
                    <div style="text-align: center; font-size: 0.6rem; color: #666; margin-top: 8px;">
                        Gradient = (ROC Ã· GS) Ã— 60 Ã· 6076 Ã— 100
                    </div>
                    <button class="clear-btn" onclick="clearClimbGradient()">Clear</button>
                </div>

                <!-- Quick ROD Calculator -->
                <div class="section">
                    <div class="section-title">Quick ROD</div>
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">GP Angle (Â°)</label>
                            <button class="input-btn" id="qrod-angle-btn" onclick="openGlidePicker('qrod-angle', 'GP Angle')" style="max-width: 100%;">3.0</button>
                            <input type="hidden" id="qrod-angle" value="3.0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ground Speed (kt)</label>
                            <button class="input-btn" id="qrod-gs-btn" onclick="openWeightPicker('qrod-gs', 'Ground Speed', 'kt')" style="max-width: 100%;">---</button>
                            <input type="hidden" id="qrod-gs" value="">
                        </div>
                    </div>
                    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; text-align: center;">
                        <div style="font-size: 0.7rem; color: #888;">Required Rate of Descent</div>
                        <div class="fdp-result-value" id="qrod-result" style="font-size: 1.8rem; color: #ff8200;">--- fpm</div>
                    </div>
                    <div style="text-align: center; font-size: 0.6rem; color: #666; margin-top: 8px;">
                        ROD = GS Ã— tan(angle) Ã— 101.27
                    </div>
                    <button class="clear-btn" onclick="clearQuickRod()">Clear</button>
                </div>
            </div>

        </div>

        <!-- MAP Tab -->
        <!-- Wx Tab (Weather Calculators) -->
        <div class="tab-content" id="tab-wx">
            <div class="fdp-container">
                <!-- METAR Input at Top -->
                <div class="section" style="margin-bottom: 15px;">
                    <div class="section-title">METAR Input</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="fdp-input" id="metar-input" placeholder="OMDB 041200Z 31008KT 9999 FEW040 22/08 Q1018" style="flex: 1; text-transform: uppercase; font-family: monospace; font-size: 0.8rem;">
                        <button class="preset-btn" onclick="syncFromMETAR()" style="white-space: nowrap; padding: 8px 15px;">â†» Sync All</button>
                    </div>
                    <div id="metar-parsed" style="margin-top: 8px; font-size: 0.7rem; color: #888;"></div>
                </div>

                <!-- Row 1: ISA Dev + Real Feel (compact) -->
                <div class="top-sections" style="grid-template-columns: 1fr 1fr; margin-bottom: 15px;">
                    <!-- ISA Deviation (compact) -->
                    <div class="section" style="padding: 12px;">
                        <div class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">ISA Deviation</div>
                        <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 6px;">
                            <input type="text" class="fdp-input" id="isa-airfield" placeholder="ICAO" maxlength="4" style="width: 60px; text-transform: uppercase; font-size: 0.75rem; padding: 5px; text-align: center;">
                            <button class="preset-btn" onclick="syncAirfieldElev()" style="font-size: 0.65rem; padding: 5px 8px;">â†» Elev</button>
                            <span id="isa-airfield-name" style="flex: 1; font-size: 0.6rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.6rem; color: #888;">ALT</div>
                                <button class="input-btn" id="isa-alt-btn" onclick="openWeightPicker('isa-alt', 'Altitude', 'ft')" style="width: 100%; font-size: 0.8rem; padding: 6px;">0 ft</button>
                                <input type="hidden" id="isa-alt" value="">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.6rem; color: #888;">OAT</div>
                                <button class="input-btn" id="isa-oat-btn" onclick="openISAPicker()" style="width: 100%; font-size: 0.8rem; padding: 6px;">+15Â°C</button>
                                <input type="hidden" id="isa-oat" value="15">
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.6rem; color: #888;">ISA DEV</div>
                                <div class="isa-deviation neutral" id="isa-dev" style="font-size: 1rem; padding: 4px;">Â±0Â°C</div>
                            </div>
                        </div>
                    </div>

                    <!-- Real Feel (compact) -->
                    <div class="section" style="padding: 12px;">
                        <div class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">Real Feel</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.6rem; color: #888;">TEMP</div>
                                <button class="input-btn" id="wx-temp-btn" onclick="openWxTempPicker('wx-temp', 'Temperature')" style="width: 100%; font-size: 0.75rem; padding: 6px;">---</button>
                                <input type="hidden" id="wx-temp" value="">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.6rem; color: #888;">DEW</div>
                                <button class="input-btn" id="wx-dewpoint-btn" onclick="openWxTempPicker('wx-dewpoint', 'Dew Point')" style="width: 100%; font-size: 0.75rem; padding: 6px;">---</button>
                                <input type="hidden" id="wx-dewpoint" value="">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.6rem; color: #888;">WIND</div>
                                <button class="input-btn" id="wx-wind-btn" onclick="openWeightPicker('wx-wind', 'Wind Speed', 'kt')" style="width: 100%; font-size: 0.75rem; padding: 6px;">---</button>
                                <input type="hidden" id="wx-wind" value="">
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.6rem; color: #888;">FEELS</div>
                                <div id="wx-feels" style="font-size: 1rem; color: #FF8200; font-weight: bold;">---</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 6px; justify-content: center; font-size: 0.65rem;">
                            <span style="color: #888;">RH: <span id="wx-rh" style="color: #00d4ff;">---%</span></span>
                            <span style="color: #888;">Heat: <span id="wx-heat-index" style="color: #ff8200;">---</span></span>
                            <span style="color: #888;">Chill: <span id="wx-wind-chill" style="color: #00d4ff;">---</span></span>
                        </div>
                    </div>
                </div>

                <!-- Row 2: SNOWTAM + Crosswind -->
                <div class="top-sections" style="grid-template-columns: 1fr 1fr;">
                    <!-- Left: SNOWTAM Decoder -->
                    <div class="section">
                        <div class="section-title">SNOWTAM / GRF Decoder</div>

                        <!-- T/O vs LDG Toggle -->
                        <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                            <button class="preset-btn" id="phase-to-btn" onclick="setPhase('TO')" style="flex:1; background: rgba(255,130,0,0.3); border-color: #FF8200;">T/O</button>
                            <button class="preset-btn" id="phase-ldg-btn" onclick="setPhase('LDG')" style="flex:1;">LDG</button>
                        </div>

                        <!-- Quick RWYCC Entry -->
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; gap: 4px;">
                                <button class="preset-btn" onclick="setRWYCC(6)" style="flex:1; font-size:0.75rem; padding: 6px;">6</button>
                                <button class="preset-btn" onclick="setRWYCC(5)" style="flex:1; font-size:0.75rem; padding: 6px;">5</button>
                                <button class="preset-btn" onclick="setRWYCC(4)" style="flex:1; font-size:0.75rem; padding: 6px;">4</button>
                                <button class="preset-btn" onclick="setRWYCC(3)" style="flex:1; font-size:0.75rem; padding: 6px;">3</button>
                                <button class="preset-btn" onclick="setRWYCC(2)" style="flex:1; font-size:0.75rem; padding: 6px;">2</button>
                                <button class="preset-btn" onclick="setRWYCC(1)" style="flex:1; font-size:0.75rem; padding: 6px;">1</button>
                                <button class="preset-btn" onclick="setRWYCC(0)" style="flex:1; font-size:0.75rem; padding: 6px;">0</button>
                            </div>
                        </div>

                        <!-- Current RWYCC Display -->
                        <div id="rwycc-display" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center;">
                                <div>
                                    <div style="font-size: 0.55rem; color: #888;">RWYCC</div>
                                    <div id="current-rwycc" style="font-size: 1.3rem; font-weight: bold; color: #00ff88;">-</div>
                                    <div id="current-rwycc-desc" style="font-size: 0.55rem; color: #888;">---</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.55rem; color: #888;">BRAKING</div>
                                    <div id="current-braking" style="font-size: 0.9rem; font-weight: bold; color: #00ff88;">---</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.55rem; color: #888;" id="limit-label">MAX X-WIND T/O</div>
                                    <div id="current-limit" style="font-size: 1.3rem; font-weight: bold; color: #FF8200;">-- kt</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick RWY Code (R##/XXXXXX) -->
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; gap: 5px;">
                                <input type="text" class="fdp-input" id="rwy-code-input" placeholder="R01/490242" style="flex: 1; text-transform: uppercase; font-family: monospace; font-size: 0.8rem; text-align: center;">
                                <button class="preset-btn" onclick="decodeRwyCode()" style="padding: 6px 12px; font-size: 0.7rem;">Decode</button>
                            </div>
                            <div id="rwy-code-decoded" style="margin-top: 6px;"></div>
                        </div>

                        <!-- Full SNOWTAM Paste (collapsed) -->
                        <details>
                            <summary style="cursor: pointer; color: #888; font-size: 0.7rem; padding: 4px 0;">â–¶ Full SNOWTAM Paste</summary>
                            <textarea class="snowtam-input" id="snowtam-input" placeholder="Paste SNOWTAM..." style="height: 50px; margin-top: 6px; font-size: 0.75rem;"></textarea>
                            <button class="preset-btn" style="margin-top:4px; width:100%; font-size:0.7rem; padding: 5px;" onclick="decodeSnowtam()">Decode</button>
                            <div class="snowtam-decoded" id="snowtam-decoded"></div>
                        </details>

                        <!-- Manual RWYCC Entry (collapsed) -->
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; color: #888; font-size: 0.7rem; padding: 4px 0;">â–¶ Manual Entry (per third)</summary>
                            <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr; gap: 4px; font-size: 0.7rem; margin-top: 8px;">
                                <div></div>
                                <div style="text-align: center; color: #888;">TDZ</div>
                                <div style="text-align: center; color: #888;">MID</div>
                                <div style="text-align: center; color: #888;">END</div>
                                <div style="color: #888; padding: 4px 0;">RWYCC</div>
                                <input type="text" class="fdp-input" id="manual-rwycc-1" placeholder="5" maxlength="1" style="text-align: center; font-size: 0.8rem; padding: 5px;" oninput="decodeManualEntry()">
                                <input type="text" class="fdp-input" id="manual-rwycc-2" placeholder="5" maxlength="1" style="text-align: center; font-size: 0.8rem; padding: 5px;" oninput="decodeManualEntry()">
                                <input type="text" class="fdp-input" id="manual-rwycc-3" placeholder="4" maxlength="1" style="text-align: center; font-size: 0.8rem; padding: 5px;" oninput="decodeManualEntry()">
                            </div>
                            <div class="snowtam-decoded" id="manual-decoded" style="margin-top: 8px;"></div>
                        </details>

                        <!-- Limitation Checks -->
                        <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #333;">
                            <div class="input-label" style="font-size: 0.7rem; margin-bottom: 8px; color: #FF8200;">Limitation Checks</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <button class="preset-btn" id="limit-asymrev-btn" onclick="toggleLimitation('asymrev')" style="font-size: 0.65rem; padding: 8px 5px;">Asymmetric Rev?</button>
                                <button class="preset-btn" id="limit-rwywidth-btn" onclick="toggleLimitation('rwywidth')" style="font-size: 0.65rem; padding: 8px 5px;">RWY &lt;45m?</button>
                                <button class="preset-btn" id="limit-lda-btn" onclick="toggleLimitation('lda')" style="font-size: 0.65rem; padding: 8px 5px;">LDA &lt;2600m?</button>
                                <button class="clear-btn" onclick="clearLimitations()" style="font-size: 0.65rem; padding: 8px 5px; margin: 0;">Clear All</button>
                            </div>
                            <div id="limitation-warnings" style="margin-top: 8px;"></div>
                        </div>
                    </div>

                    <!-- Right: Crosswind Calculator -->
                    <div class="section">
                        <div class="section-title">Crosswind Calculator</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">Runway HDG (Â°)</label>
                                <button class="input-btn" id="xwind-rwy-btn" onclick="openRunwayHdgPicker()" style="max-width:100%">---Â°</button>
                                <input type="hidden" id="xwind-rwy" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Wind (220/13 or 220/3m)</label>
                                <button class="input-btn" id="xwind-opt-btn" onclick="openOPTWindPicker()" style="max-width:100%; font-size: 0.85rem;">---/--</button>
                                <input type="hidden" id="xwind-dir" value="">
                                <input type="hidden" id="xwind-spd" value="">
                            </div>
                        </div>
                        <div class="input-grid-2" style="margin-top:8px">
                            <div class="input-group">
                                <label class="input-label" style="font-size: 0.65rem; color: #666;">Or enter separately:</label>
                                <div style="display: flex; gap: 5px;">
                                    <button class="input-btn" id="xwind-dir-btn" onclick="openWindDirPicker()" style="flex: 1; font-size: 0.8rem;">---Â°</button>
                                    <button class="input-btn" id="xwind-spd-btn" onclick="openWindSpdPicker('xwind-spd', 'Wind Speed')" style="flex: 1; font-size: 0.8rem;">-- kt</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Gust (kt)</label>
                                <button class="input-btn placeholder" id="xwind-gust-btn" onclick="openWindSpdPicker('xwind-gust', 'Gust')" style="max-width:100%">-- kt</button>
                                <input type="hidden" id="xwind-gust" value="">
                            </div>
                        </div>
                        <div class="wind-display" id="wind-display" style="max-width: 180px; margin: 10px auto;">
                            <svg viewBox="0 0 200 200" class="wind-svg">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#444" stroke-width="2"/>
                                <text x="100" y="18" text-anchor="middle" fill="#666" font-size="12">N</text>
                                <text x="185" y="104" text-anchor="middle" fill="#666" font-size="12">E</text>
                                <text x="100" y="196" text-anchor="middle" fill="#666" font-size="12">S</text>
                                <text x="15" y="104" text-anchor="middle" fill="#666" font-size="12">W</text>
                                <g id="runway-svg" transform="rotate(0, 100, 100)">
                                    <rect x="95" y="30" width="10" height="140" fill="#555" stroke="#888" stroke-width="1" rx="2"/>
                                    <line x1="100" y1="35" x2="100" y2="165" stroke="#fff" stroke-width="1" stroke-dasharray="8,8"/>
                                </g>
                                <text id="rwy-num-approach" x="100" y="100" text-anchor="middle" fill="#FF8200" font-size="12" font-weight="bold"></text>
                                <text id="rwy-num-depart" x="100" y="100" text-anchor="middle" fill="#888" font-size="10"></text>
                                <g id="wind-arrow-svg" transform="rotate(0, 100, 100)">
                                    <line x1="100" y1="15" x2="100" y2="60" stroke="#00d4ff" stroke-width="3"/>
                                    <polygon points="100,65 94,50 106,50" fill="#00d4ff"/>
                                </g>
                                <text id="wind-dir-label" x="100" y="100" text-anchor="middle" fill="#00d4ff" font-size="10" font-weight="bold"></text>
                                <circle cx="100" cy="100" r="4" fill="#FF8200"/>
                            </svg>
                        </div>
                        <div class="component-display">
                            <div class="component-item">
                                <div class="component-label">HEAD/TAIL</div>
                                <div class="component-value headwind" id="headwind-val">--</div>
                            </div>
                            <div class="component-item">
                                <div class="component-label">CROSSWIND</div>
                                <div class="component-value crosswind" id="crosswind-val">--</div>
                            </div>
                        </div>

                        <!-- Crosswind Status vs Limit -->
                        <div id="xwind-status" style="margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; display: none;"></div>

                        <button class="clear-btn" onclick="clearCrosswind()">Clear</button>
                    </div>
                </div>

                <!-- Reference Table -->
                <div class="top-sections" style="grid-template-columns: 1fr; margin-top: 15px;">
                    <div class="section">
                        <div class="section-title" style="font-size: 0.8rem;">RWYCC / Crosswind Limits (B737 NG/MAX)</div>
                        <div class="friction-table">
                            <table style="font-size: 0.7rem;">
                                <tr><th>CC</th><th>Condition</th><th>Braking</th><th style="color:#FF8200">T/O</th><th style="color:#00d4ff">LDG</th></tr>
                                <tr><td>6</td><td>Dry</td><td class="grf-good">Dry</td><td>33</td><td>37</td></tr>
                                <tr><td>5</td><td>Wet/Frost/â‰¤3mm</td><td class="grf-good">Good</td><td>25</td><td>37</td></tr>
                                <tr><td>4</td><td>Compact snow â‰¤-15Â°C</td><td class="grf-medium">Med-Good</td><td>22</td><td>35</td></tr>
                                <tr><td>3</td><td>Wet snow/>3mm</td><td class="grf-medium">Medium</td><td>20</td><td>25</td></tr>
                                <tr><td>2</td><td>Water/Slush</td><td class="grf-poor">Med-Poor</td><td>15</td><td>17</td></tr>
                                <tr><td>1</td><td>Ice</td><td class="grf-bad">Poor</td><td>13</td><td>15</td></tr>
                                <tr><td>0</td><td>Wet ice/Water on ice</td><td class="grf-bad">&lt;Poor</td><td colspan="2" style="color:#ff5252">OPS PROHIBITED</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-map">
            <div class="fdp-container">
                <div class="fdp-section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Moving Map</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="preset-btn" id="map-center-btn" onclick="centerMapOnPosition()">Center</button>
                            <button class="preset-btn" id="map-follow-btn" onclick="toggleMapFollow()" style="background: rgba(0, 255, 136, 0.3); border-color: #00ff88;">Follow</button>
                        </div>
                    </div>
                    <div id="map-container" style="height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 130, 0, 0.3);"></div>
                    <div class="map-info-row" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">POSITION</div>
                            <div id="map-position" style="color: #00d4ff; font-family: monospace;">---</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">TRACK</div>
                            <div id="map-track" style="color: #00ff88; font-family: monospace;">---Â°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">GROUND SPEED</div>
                            <div id="map-gs" style="color: #FF8200; font-family: monospace;">--- kt</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">ALTITUDE</div>
                            <div id="map-alt" style="color: #ffd700; font-family: monospace;">--- ft</div>
                        </div>
                    </div>
                    <!-- Layer Toggles -->
                    <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="preset-btn" id="toggle-airspace-btn" onclick="toggleAirspaceLayer()" style="background: rgba(68, 68, 136, 0.4); border-color: #444488; font-size: 0.8rem; padding: 6px 12px;">
                            âœ“ Airspace
                        </button>
                        <button class="preset-btn" id="toggle-navaids-btn" onclick="toggleNavaidsLayer()" style="background: rgba(0, 200, 255, 0.3); border-color: #00c8ff; font-size: 0.8rem; padding: 6px 12px;">
                            âœ“ Navaids
                        </button>
                    </div>
                </div>
                <!-- Route Entry -->
                <div class="fdp-section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <span>Route / GeoJSON</span>
                        <div id="map-route-switcher" style="display: none; font-size: 0.85rem; align-items: center;">
                            <button class="preset-btn" onclick="mapRoutePrev()" style="padding: 4px 8px; font-size: 0.75rem;">â—€</button>
                            <span id="map-route-display" style="margin: 0 6px; color: #FF8200; font-size: 0.8rem;">---</span>
                            <button class="preset-btn" onclick="mapRouteNext()" style="padding: 4px 8px; font-size: 0.75rem;">â–¶</button>
                        </div>
                    </div>
                    <div class="map-route-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group">
                            <label class="input-label">From</label>
                            <input type="text" class="fdp-input" id="route-from" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase; text-align: center;">
                        </div>
                        <div class="input-group">
                            <label class="input-label">To</label>
                            <input type="text" class="fdp-input" id="route-to" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase; text-align: center;">
                        </div>
                    </div>
                    <button class="preset-btn" style="width: 100%; margin-top: 10px;" onclick="drawRoute()">Draw Great Circle</button>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,130,0,0.2);">
                        <label class="input-label">Paste GeoJSON Route</label>
                        <textarea id="geojson-input" class="fdp-input" placeholder='{"type":"Feature","geometry":{"type":"LineString","coordinates":[[55.36,25.25],[0.46,51.47]]}}' style="width: 100%; height: 80px; resize: vertical; font-family: monospace; font-size: 0.8rem;"></textarea>
                        <button class="preset-btn" style="width: 100%; margin-top: 8px;" onclick="loadGeoJSON()">Load GeoJSON</button>
                    </div>
                </div>
                <!-- Track Log -->
                <div class="fdp-section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Track Log</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="preset-btn" id="track-toggle-btn" onclick="toggleTrackLog()">Start Recording</button>
                            <button class="clear-btn" onclick="clearTrackLog()">Clear</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">POINTS</div>
                            <div id="track-points" style="color: #00d4ff; font-size: 1.2rem;">0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">DISTANCE</div>
                            <div id="track-distance" style="color: #00ff88; font-size: 1.2rem;">0 nm</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #888; font-size: 0.75rem;">DURATION</div>
                            <div id="track-duration" style="color: #FF8200; font-size: 1.2rem;">00:00</div>
                        </div>
                    </div>
                    <button class="preset-btn" style="width: 100%; margin-top: 10px;" onclick="exportTrackLog()">Export GPX</button>
                </div>
            </div>
        </div>

        <!-- Timers Tab -->
        <div class="tab-content" id="tab-tmr">
            <div class="timers-grid" id="timers-container"></div>
        </div>

        <!-- Fuel Tab -->
        <div class="tab-content" id="tab-fuel">
            <div class="fdp-container">
                <!-- Input Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Inputs</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Fuel Required (kg)</label>
                            <button class="input-btn" id="fuel-req-btn" onclick="openFuelPicker('fuel-req', 'Fuel Required', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-req" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pre Uplift (kg)</label>
                            <button class="input-btn" id="fuel-pre-btn" onclick="openFuelPicker('fuel-pre', 'Pre Uplift', 'kg')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-pre" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">SG (Density)</label>
                            <button class="input-btn" id="fuel-sg-btn" onclick="openSGPicker()" style="max-width:100%">0.800</button>
                            <input type="hidden" id="fuel-sg" value="800">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Uplift (L)</label>
                            <button class="input-btn" id="fuel-actual-btn" onclick="openFuelPicker('fuel-actual', 'Actual Uplift', 'L')" style="max-width:100%">0</button>
                            <input type="hidden" id="fuel-actual" value="">
                        </div>
                    </div>
                </div>

                <!-- Tank Split Block -->
                <div class="fdp-section">
                    <div class="section-title">Tank Split</div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Left Wing (kg)</label>
                            <button class="input-btn" id="tank-left-btn" onclick="openFuelPicker('tank-left', 'Left Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-left" value="3700">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Center (kg)</label>
                            <div class="fdp-result-value green" id="tank-center" style="padding-top:8px; text-align:center">---</div>
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Right Wing (kg)</label>
                            <button class="input-btn" id="tank-right-btn" onclick="openFuelPicker('tank-right', 'Right Wing', 'kg')" style="max-width:100%; margin:0 auto">3,700</button>
                            <input type="hidden" id="tank-right" value="3700">
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:5px;">
                        Center tank is auto-calculated: Total Required - Left - Right
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="preset-btn" onclick="setFullTanks()" style="flex:1;">Full Tanks (20,200 kg)</button>
                        <button class="preset-btn" onclick="resetTankSplit()" style="flex:1;">Reset Wings</button>
                    </div>
                </div>

                <!-- Fuel Summary Block -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Summary</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Fuel Required</div>
                                <div class="fdp-result-value" id="summary-req">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Pre Uplift</div>
                                <div class="fdp-result-value" id="summary-pre">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Uplift Required</div>
                                <div class="fdp-result-value yellow" id="summary-uplift-req">--- kg</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Departure Fuel</div>
                                <div class="fdp-result-value" id="summary-dep">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Adjustment (+/-)</div>
                                <div style="display:flex; gap:5px; justify-content:center">
                                    <button class="input-btn" id="fuel-adj-btn" onclick="openAdjustmentPicker()" style="max-width:80px; flex:1">0</button>
                                    <button class="input-btn" id="fuel-adj-sign-btn" onclick="toggleAdjustmentSign()" style="max-width:40px; padding:5px; font-size:1.2rem">+/-</button>
                                </div>
                                <input type="hidden" id="fuel-adj" value="">
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Final Departure Fuel</div>
                                <div class="fdp-result-value green" id="summary-final-dep">--- kg</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uplift Verification Block -->
                <div class="fdp-section">
                    <div class="section-title">Uplift Verification</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated Uplift</div>
                                <div class="fdp-result-value" id="calc-uplift">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Actual Uplift</div>
                                <div class="fdp-result-value" id="verify-actual">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Difference</div>
                                <div class="fdp-result-value" id="uplift-diff">--- %</div>
                            </div>
                        </div>
                        <div class="fdp-result-grid" style="margin-top:15px">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">-3% Limit</div>
                                <div class="fdp-result-value" id="limit-low">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Calculated</div>
                                <div class="fdp-result-value yellow" id="limit-calc">--- L</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">+3% Limit</div>
                                <div class="fdp-result-value" id="limit-high">--- L</div>
                            </div>
                        </div>
                        <div id="uplift-status" style="margin-top:15px; text-align:center;"></div>
                    </div>
                </div>

                <!-- Fuel Unit Converter -->
                <div class="fdp-section">
                    <div class="section-title">Fuel Unit Converter</div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-bottom:10px;">
                        Enter one value and press OK - others will auto-calculate (SG: 0.800)
                    </div>
                    <div class="fdp-row" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Litres (L)</label>
                            <button class="input-btn" id="conv-litres-btn" onclick="openConverterPicker('litres')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-litres" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">US Gallons</label>
                            <button class="input-btn" id="conv-gallons-btn" onclick="openConverterPicker('gallons')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-gallons" value="">
                        </div>
                        <div class="fdp-field" style="text-align:center">
                            <label class="fdp-label">Pounds (lbs)</label>
                            <button class="input-btn" id="conv-lbs-btn" onclick="openConverterPicker('lbs')" style="max-width:100%; margin:0 auto">0</button>
                            <input type="hidden" id="conv-lbs" value="">
                        </div>
                    </div>
                    <button class="clear-btn" id="conv-clear" style="margin-top:10px">Clear Converter</button>
                </div>

                <button class="clear-btn" id="fuel-clear" style="margin-top:15px">Clear All Fuel Data</button>
            </div>
        </div>

        <!-- Layover Tab -->
        <div class="tab-content" id="tab-lay">
            <div class="fdp-container">
                <!-- UTC Offset Selector -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="layover-offset" onchange="calculateLayover()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3 (MSK)</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0">UTC+0 (LGW)</option>
                        <option value="1">UTC+1 (BEG/PRG/ZAG)</option>
                        <option value="2">UTC+2 (CAI/AMM/TLV/ATH)</option>
                        <option value="3">UTC+3 (RUH/JED/KWI/BAH/DOH)</option>
                        <option value="3.5">UTC+3:30 (IKA/THR)</option>
                        <option value="4" selected>UTC+4 (DXB/MCT/TBS)</option>
                        <option value="4.5">UTC+4:30 (KBL)</option>
                        <option value="5">UTC+5 (KHI/LHE/ISB/TAS)</option>
                        <option value="5.5">UTC+5:30 (DEL/BOM/COK/CMB)</option>
                        <option value="6">UTC+6 (DAC/ALA)</option>
                        <option value="7">UTC+7 (BKK)</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Wake Up Calculator</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">STD (UTC)</label>
                            <button class="input-btn" id="layover-std-btn" onclick="openTimePicker('layover-std')" style="max-width:100%">----</button>
                            <input type="hidden" id="layover-std" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Pickup Before STD</label>
                            <button class="input-btn" id="layover-pickup-btn" onclick="openTimePicker('layover-pickup')" style="max-width:100%">0130</button>
                            <input type="hidden" id="layover-pickup" value="0130">
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Calculated Times</div>
                    <div class="fdp-results" style="margin-top:0">
                        <div class="fdp-result-grid">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">STD (Local)</div>
                                <div class="fdp-result-local" id="layover-std-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-std-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Wake Up Time</div>
                                <div class="fdp-result-local" id="layover-wake-local">--:--</div>
                                <div class="fdp-result-utc" id="layover-wake-utc">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Hotel Departure</div>
                                <div class="fdp-result-local" id="layover-hotel-local" style="color:#ffd700">--:--</div>
                                <div class="fdp-result-utc" id="layover-hotel-utc">UTC: --:--</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#888; margin-top:10px;">
                        Hotel Departure = STD - Pickup Time | Wake Up = Hotel Departure - 1 hour
                    </div>
                </div>

                <button class="clear-btn" id="layover-clear" style="margin-top:15px">Clear</button>
            </div>
        </div>

        <!-- FDP Calculator Tab -->
        <div class="tab-content" id="tab-fdp">
            <div class="fdp-container">
                <!-- Local Time Offset -->
                <div class="local-offset-selector">
                    <label>Local Time Offset:</label>
                    <select id="local-offset" onchange="calculateFDP()">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10</option>
                        <option value="-9">UTC-9</option>
                        <option value="-8">UTC-8</option>
                        <option value="-7">UTC-7</option>
                        <option value="-6">UTC-6</option>
                        <option value="-5">UTC-5</option>
                        <option value="-4">UTC-4</option>
                        <option value="-3">UTC-3 (MSK)</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0">UTC+0 (LGW)</option>
                        <option value="1">UTC+1 (BEG/PRG/ZAG)</option>
                        <option value="2">UTC+2 (CAI/AMM/TLV/ATH)</option>
                        <option value="3">UTC+3 (RUH/JED/KWI/BAH/DOH)</option>
                        <option value="3.5">UTC+3:30 (IKA/THR)</option>
                        <option value="4" selected>UTC+4 (DXB/MCT/TBS)</option>
                        <option value="4.5">UTC+4:30 (KBL)</option>
                        <option value="5">UTC+5 (KHI/LHE/ISB/TAS)</option>
                        <option value="5.5">UTC+5:30 (DEL/BOM/COK/CMB)</option>
                        <option value="6">UTC+6 (DAC/ALA)</option>
                        <option value="7">UTC+7 (BKK)</option>
                        <option value="8">UTC+8</option>
                        <option value="9">UTC+9</option>
                        <option value="10">UTC+10</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12</option>
                    </select>
                </div>

                <div class="fdp-section collapsible" id="fdp-duty-setup">
                    <div class="section-title" onclick="toggleFDPSetup()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>Duty Setup</span>
                        <span id="fdp-setup-toggle" style="font-size: 0.8rem; color: #888;">â–¼</span>
                    </div>
                    <div class="fdp-setup-content" id="fdp-setup-content">
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Crew Type</label>
                            <select class="fdp-select" id="fdp-crew-type" onchange="calculateFDP()">
                                <option value="flight">Flight Crew</option>
                                <option value="cabin">Cabin Crew</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Acclimatization</label>
                            <select class="fdp-select" id="fdp-acclimatized" onchange="calculateFDP()">
                                <option value="yes">Acclimatized</option>
                                <option value="no">Not Acclimatized</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Preceding Rest</label>
                            <select class="fdp-select" id="fdp-rest" onchange="calculateFDP()">
                                <option value="normal">Up to 18h or over 30h</option>
                                <option value="reduced">Between 18-30h</option>
                            </select>
                        </div>
                    </div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Report Time (Local)</label>
                            <button class="input-btn" id="fdp-report-btn" onclick="openTimePicker('fdp-report')" style="max-width:100%">0600</button>
                            <input type="hidden" id="fdp-report" value="0600">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Sectors (from Schedule)</label>
                            <div class="fdp-result-value" id="fdp-sectors-display" style="padding-top: 8px; font-size: 1.1rem;">1</div>
                            <input type="hidden" id="fdp-sectors" value="1">
                        </div>
                    </div>
                    </div><!-- End fdp-setup-content -->
                </div>

                <!-- FDP Results - Compact 2x3 grid for mobile -->
                <div class="fdp-section">
                    <div class="section-title">FDP Results</div>
                    <div class="fdp-results">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">Max FDP</div>
                                <div class="fdp-result-value green" id="fdp-max" style="font-size: 1.1rem;">--:--</div>
                            </div>
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">On-Chocks</div>
                                <div class="fdp-result-local" id="fdp-chocks-local" style="font-size: 1rem;">--:--</div>
                                <div class="fdp-result-utc" id="fdp-chocks" style="font-size: 0.6rem;">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">Off-Duty</div>
                                <div class="fdp-result-local" id="fdp-offduty-local" style="font-size: 1rem;">--:--</div>
                                <div class="fdp-result-utc" id="fdp-offduty" style="font-size: 0.6rem;">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">Discretion</div>
                                <div class="fdp-result-value yellow" id="fdp-discretion" style="font-size: 1.1rem;">+3:00</div>
                            </div>
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">Absolute</div>
                                <div class="fdp-result-local" id="fdp-absolute-local" style="color:#FF8200; font-size: 1rem;">--:--</div>
                                <div class="fdp-result-utc" id="fdp-absolute" style="font-size: 0.6rem;">UTC: --:--</div>
                            </div>
                            <div class="fdp-result-item" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.6rem;">Min Rest</div>
                                <div class="fdp-result-value" id="fdp-rest-after" style="font-size: 1.1rem;">12:00</div>
                            </div>
                        </div>
                        <div id="fdp-warnings"></div>
                    </div>
                </div>

                <!-- Duty Estimate (reads from Schedule) -->
                <div class="fdp-section">
                    <div class="section-title">Duty Estimate</div>
                    <div class="duty-estimate" id="duty-estimate">
                        <div class="duty-estimate-row">
                            <span class="duty-estimate-label">Estimated Duty End (Local):</span>
                            <span class="duty-estimate-value" id="est-duty-end-local" style="color:#00ff88; font-size:1.3rem">--:--</span>
                        </div>
                        <div class="duty-estimate-row">
                            <span class="duty-estimate-label" style="color:#666">UTC:</span>
                            <span class="duty-estimate-value" id="est-duty-end" style="color:#888; font-size:0.95rem">--:--</span>
                        </div>
                        <div class="duty-estimate-row">
                            <span class="duty-estimate-label">Status:</span>
                            <span class="duty-estimate-value green" id="duty-status">---</span>
                        </div>
                    </div>
                </div>

                <div class="fdp-section">
                    <div class="section-title">Live Duty Tracker</div>
                    <div class="fdp-row">
                        <div class="fdp-field">
                            <label class="fdp-label">Actual Report (Local)</label>
                            <button class="input-btn" id="fdp-actual-report-btn" onclick="openTimePicker('fdp-actual-report')" style="max-width:100%">----</button>
                            <input type="hidden" id="fdp-actual-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current UTC</label>
                            <div class="fdp-result-value" id="fdp-utc-time" style="padding-top:10px">--:--:--</div>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Current Local</label>
                            <div class="fdp-result-value" id="fdp-local-time" style="padding-top:10px">--:--:--</div>
                        </div>
                    </div>
                    <div class="fdp-result-grid" style="margin-top:15px">
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Elapsed</div>
                            <div class="fdp-result-value" id="fdp-elapsed">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">FDP Remaining</div>
                            <div class="fdp-result-value green" id="fdp-remaining">--:--</div>
                        </div>
                        <div class="fdp-result-item">
                            <div class="fdp-result-label">Into Discretion</div>
                            <div class="fdp-result-value" id="fdp-into-discretion">--:--</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Duty Calculator (standalone) -->
                <div class="fdp-section">
                    <div class="section-title">Quick Duty Calculator</div>
                    <div class="fdp-row" style="gap: 8px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Report (Local)</label>
                            <button class="input-btn" id="quick-report-btn" onclick="openTimePicker('quick-report')" style="max-width:100%">----</button>
                            <input type="hidden" id="quick-report" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">UTC+</label>
                            <select class="fdp-select" id="quick-utc-offset" onchange="calculateQuickDuty()" style="min-width: 55px;">
                                <option value="0">0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                                <option value="4" selected>+4</option>
                                <option value="5">+5</option>
                                <option value="6">+6</option>
                                <option value="7">+7</option>
                                <option value="8">+8</option>
                                <option value="9">+9</option>
                                <option value="10">+10</option>
                                <option value="11">+11</option>
                                <option value="12">+12</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Sectors</label>
                            <select class="fdp-select" id="quick-sectors" onchange="calculateQuickDuty()">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Accl.</label>
                            <select class="fdp-select" id="quick-accl" onchange="calculateQuickDuty()">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    <!-- Quick Results - compact 2x3 grid -->
                    <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px;">
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="Maximum Flight Duty Period based on report time, sectors, and acclimatization (EASA ORO.FTL)">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Max FDP</div>
                            <div class="fdp-result-value green" id="quick-max-fdp" style="font-size: 1.1rem;">--:--</div>
                        </div>
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="Latest wheels-stop time to finish within Max FDP (Report + Max FDP - 30min post-flight)">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Latest On-Chocks</div>
                            <div class="fdp-result-value" id="quick-chocks" style="font-size: 1rem; color: #00d4ff;">--:-- Z</div>
                            <div class="fdp-result-utc" id="quick-chocks-local" style="font-size: 0.7rem; color: #888;">--:-- L</div>
                        </div>
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="When you're officially off duty (On-Chocks + 30 min post-flight duties)">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Off-Duty</div>
                            <div class="fdp-result-value" id="quick-offduty" style="font-size: 1rem; color: #00d4ff;">--:-- Z</div>
                            <div class="fdp-result-utc" id="quick-offduty-local" style="font-size: 0.7rem; color: #888;">--:-- L</div>
                        </div>
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="Commander's discretion for unforeseen circumstances (ORO.FTL.205e): 2hr for 2+ sectors, 3hr for 1 sector">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Discretion</div>
                            <div class="fdp-result-value yellow" id="quick-discretion" style="font-size: 1.1rem;">--:--</div>
                        </div>
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="Absolute latest on-chocks if ALL discretion is used (On-Chocks + Max Discretion)">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Max Discr. Limit</div>
                            <div class="fdp-result-value" id="quick-absolute" style="color:#FF8200; font-size: 1rem;">--:-- Z</div>
                            <div class="fdp-result-utc" id="quick-absolute-local" style="font-size: 0.7rem; color: #888;">--:-- L</div>
                        </div>
                        <div class="fdp-result-item" style="padding: 8px 4px;" title="Minimum rest required after duty (greater of 12hr or duty length)">
                            <div class="fdp-result-label" style="font-size: 0.6rem;">Min Rest</div>
                            <div class="fdp-result-value" id="quick-rest" style="font-size: 1.1rem;">12:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nav Tab (Coordinates) -->
        <div class="tab-content" id="tab-nav">
            <div class="fdp-container">
                <!-- Coordinates Converter Row -->
                <div class="top-sections" style="grid-template-columns: 1fr;">
                    <div class="section">
                        <div class="section-title">Coordinates / LIDO Converter</div>

                        <!-- GPS Status Box -->
                        <div id="coord-gps-box" class="coord-gps-box" style="display: flex; align-items: center; justify-content: space-between; background: rgba(0,20,40,0.8); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 8px 12px; margin-bottom: 15px; font-family: 'Courier New', monospace; font-size: 0.8rem;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div><span style="color: #888;">LAT:</span> <span id="coord-gps-lat" style="color: #00d4ff;">---</span></div>
                                <div><span style="color: #888;">LON:</span> <span id="coord-gps-lon" style="color: #00d4ff;">---</span></div>
                                <div><span style="color: #888;">TRK:</span> <span id="coord-gps-trk" style="color: #00ff88;">---</span></div>
                                <div><span style="color: #888;">GS:</span> <span id="coord-gps-spd" style="color: #00ff88;">---</span></div>
                            </div>
                            <button class="preset-btn" onclick="fillCoordsFromGps()" id="coord-gps-fill-btn" style="padding: 5px 12px; font-size: 0.75rem;" disabled>Fill from GPS</button>
                        </div>

                        <!-- Manual Entry: Split Lat/Lon -->
                        <div style="margin-bottom: 15px;">
                            <div style="color: #888; font-size: 0.7rem; margin-bottom: 8px;">Manual Entry</div>
                            <div class="coord-manual-entry-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <button class="preset-btn" id="coord-ns-btn" onclick="toggleCoordNS()" style="width: 35px; padding: 8px 0; font-weight: bold; background: rgba(0,212,255,0.3); border-color: #00d4ff;">N</button>
                                    <input type="text" class="fdp-input" id="coord-lat-input" placeholder="25.2583 or 25Â°15'30&quot;" style="flex: 1; text-align: center;" oninput="convertFromManual()">
                                </div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <button class="preset-btn" id="coord-ew-btn" onclick="toggleCoordEW()" style="width: 35px; padding: 8px 0; font-weight: bold; background: rgba(255,130,0,0.3); border-color: #FF8200;">E</button>
                                    <input type="text" class="fdp-input" id="coord-lon-input" placeholder="55.3000 or 055Â°18'00&quot;" style="flex: 1; text-align: center;" oninput="convertFromManual()">
                                </div>
                            </div>
                        </div>

                        <!-- Paste Box -->
                        <div style="margin-bottom: 15px;">
                            <div style="color: #888; font-size: 0.7rem; margin-bottom: 8px;">Paste Any Format</div>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="fdp-input" id="coord-input" placeholder="N25151E055218, 2515N05518E, N25-15/E055-18, etc." style="flex: 1; text-transform: uppercase;" oninput="this.value = this.value.toUpperCase(); convertCoordinates()">
                                <div class="fdp-result-value" id="coord-format-detected" style="font-size: 0.7rem; min-width: 80px; text-align: center; padding: 8px;">---</div>
                            </div>
                        </div>

                        <div style="border-top: 1px solid #333; padding-top: 15px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 10px; text-align: center;">Converted Formats</div>
                            <div class="coord-results-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div class="coord-result-item">
                                    <div class="coord-label">Decimal Degrees (DD)</div>
                                    <div class="coord-value" id="coord-decimal">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">DMS (Degrees Minutes Seconds)</div>
                                    <div class="coord-value" id="coord-dms">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">DMM (Degrees Decimal Minutes)</div>
                                    <div class="coord-value" id="coord-dmm">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">DMM Compact (N25151E055218)</div>
                                    <div class="coord-value" id="coord-dmm-compact">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">LIDO 1: Simple (N25-15/E055-18)</div>
                                    <div class="coord-value" id="coord-lido1">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">LIDO 2: Deg/Min (N2515E05518)</div>
                                    <div class="coord-value" id="coord-lido2">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">LIDO 3: ICAO FPL (2515N05518E)</div>
                                    <div class="coord-value" id="coord-lido3">---</div>
                                </div>
                                <div class="coord-result-item">
                                    <div class="coord-label">ARINC 424 (5-Letter)</div>
                                    <div class="coord-value" id="coord-arinc">---</div>
                                </div>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearCoordConverter()">Clear</button>
                    </div>
                </div>

                <!-- Airport Distance & Info Row -->
                <div class="top-sections" style="grid-template-columns: 1fr; margin-top: 20px;">
                    <!-- Airport Distance Calculator -->
                    <div class="section">
                        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                            <span>Airport Distance Calculator</span>
                            <div id="dist-switcher" style="display: none; font-size: 0.85rem; align-items: center;">
                                <button class="preset-btn" onclick="distSwitcherPrev()" style="padding: 4px 8px; font-size: 0.75rem;">â—€</button>
                                <span id="dist-switcher-display" style="margin: 0 6px; color: #FF8200; font-size: 0.8rem;">---</span>
                                <button class="preset-btn" onclick="distSwitcherNext()" style="padding: 4px 8px; font-size: 0.75rem;">â–¶</button>
                            </div>
                        </div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">From (ICAO/IATA)</label>
                                <input type="text" class="fdp-input" id="dist-from" placeholder="OMDB or DXB" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value = this.value.toUpperCase(); calculateAirportDistance()">
                            </div>
                            <div class="input-group">
                                <label class="input-label">To (ICAO/IATA)</label>
                                <input type="text" class="fdp-input" id="dist-to" placeholder="EGLL or LHR" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value = this.value.toUpperCase(); calculateAirportDistance()">
                            </div>
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 5px;">GREAT CIRCLE DISTANCE</div>
                                <div class="fdp-result-value" id="dist-result-nm" style="font-size: 2rem; color: #FF8200;">--- nm</div>
                                <div class="fdp-result-value" id="dist-result-km" style="font-size: 1rem; color: #00d4ff; margin-top: 5px;">--- km</div>
                            </div>
                            <div class="dist-names-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 0.7rem; color: #888;">From</div>
                                    <div id="dist-from-name" style="font-size: 0.85rem; color: #00ff88;">---</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: #888;">To</div>
                                    <div id="dist-to-name" style="font-size: 0.85rem; color: #ff5252;">---</div>
                                </div>
                            </div>
                            <div class="dist-track-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; text-align: center; align-items: end;">
                                <div>
                                    <div style="font-size: 0.7rem; color: #888;">Initial Track</div>
                                    <div id="dist-track" style="font-size: 1.1rem; color: #00d4ff;">---Â°</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: #888;">GS (kt)</div>
                                    <input type="number" id="dist-gs" class="fdp-input" placeholder="450" min="50" max="999" style="text-align: center; padding: 5px; font-size: 0.9rem;" oninput="calculateAirportDistance()">
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: #888;">Est. Flight Time</div>
                                    <div id="dist-time" style="font-size: 1.1rem; color: #ffd700;">--:--</div>
                                </div>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearDistanceCalc()">Clear</button>
                    </div>

                    <!-- Airport Info Lookup -->
                    <div class="section">
                        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                            <span>Airport Info Lookup</span>
                            <div id="apt-info-switcher" style="display: none; font-size: 0.85rem; align-items: center;">
                                <button class="preset-btn" onclick="aptInfoSwitcherPrev()" style="padding: 4px 8px; font-size: 0.75rem;">â—€</button>
                                <span id="apt-info-switcher-display" style="margin: 0 6px; color: #FF8200; font-size: 0.8rem;">---</span>
                                <button class="preset-btn" onclick="aptInfoSwitcherNext()" style="padding: 4px 8px; font-size: 0.75rem;">â–¶</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">ICAO or IATA Code</label>
                            <input type="text" class="fdp-input" id="apt-lookup" placeholder="OMDB or DXB" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value = this.value.toUpperCase(); lookupAirport()">
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                            <div id="apt-info-result" style="display: none;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div id="apt-info-name" style="font-size: 1.1rem; color: #FF8200; font-weight: bold;">---</div>
                                    <div id="apt-info-city" style="font-size: 0.9rem; color: #00d4ff;">---</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #888;">ICAO</div>
                                        <div id="apt-info-icao" style="font-size: 1.2rem; color: #00ff88; font-family: monospace;">----</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #888;">IATA</div>
                                        <div id="apt-info-iata" style="font-size: 1.2rem; color: #00ff88; font-family: monospace;">---</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #888;">ELEVATION</div>
                                        <div id="apt-info-elev" style="font-size: 1.2rem; color: #ffd700; font-family: monospace;">--- ft</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 0.7rem; color: #888;">COUNTRY</div>
                                        <div id="apt-info-country" style="font-size: 1.2rem; color: #00d4ff; font-family: monospace;">--</div>
                                    </div>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px;">
                                    <div style="font-size: 0.7rem; color: #888;">COORDINATES</div>
                                    <div id="apt-info-coords" style="font-size: 0.95rem; color: #00d4ff; font-family: monospace;">---</div>
                                </div>
                            </div>
                            <div id="apt-info-empty" style="text-align: center; color: #666; padding: 30px;">
                                Enter ICAO or IATA code to lookup airport info<br>
                                <span style="font-size: 0.75rem;">Database: 8,800+ airports worldwide</span>
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearAirportLookup()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TIME Tab (ETA, Timezone, Time Calculations) -->
        <div class="tab-content" id="tab-time">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- ETA Countdown -->
                    <div class="section">
                        <div class="section-title">ETA Countdown</div>
                        <div class="utc-display">UTC: <span id="utc-clock">--:--:--</span></div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">ETA (UTC)</label>
                                <button class="input-btn placeholder" id="eta-time-btn" onclick="openTimePicker('eta-time')">0000</button>
                                <input type="hidden" id="eta-time" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">UTC NOW</label>
                                <button class="input-btn placeholder" id="utc-manual-btn" onclick="openTimePicker('utc-manual')">AUTO</button>
                                <input type="hidden" id="utc-manual" value="">
                            </div>
                        </div>
                        <div class="eta-countdown" id="eta-countdown">--:--:--</div>
                        <div class="results-row" style="border: none; padding-top: 10px;">
                            <div class="result-item">
                                <div class="result-label">ELAPSED</div>
                                <div class="result-value" id="time-elapsed" style="color: #00d4ff;">--:--</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">REMAINING</div>
                                <div class="result-value" id="time-remaining" style="color: #00ff88;">--:--</div>
                            </div>
                        </div>
                        <button class="clear-btn" id="eta-clear">Clear</button>
                    </div>

                </div>

                <!-- Speed-Distance-Time Calculator -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Speed-Distance-Time Calculator</div>

                    <!-- Row 1: Speed Ã— Time = Distance -->
                    <div class="sdt-row" style="display: flex; align-items: flex-end; gap: 8px; margin-bottom: 12px;">
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Speed (kts)</label>
                            <div style="display: flex; gap: 3px;">
                                <button class="input-btn" id="sdt1-speed-btn" onclick="openWeightPicker('sdt1-speed', 'Speed', 'kts')" style="flex: 1; padding: 8px 4px; font-size: 0.9rem;">---</button>
                                <button class="preset-btn" onclick="fillSpeedFromGps('sdt1-speed')" style="font-size: 0.6rem; padding: 4px 5px;">GPS</button>
                            </div>
                            <input type="hidden" id="sdt1-speed" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">Ã—</span>
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Time</label>
                            <button class="input-btn" id="sdt1-time-btn" onclick="openSDTDuration('sdt1-time')" style="padding: 8px 4px; font-size: 0.9rem;">---</button>
                            <input type="hidden" id="sdt1-time" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">=</span>
                        <div style="flex: 1; min-width: 80px; text-align: center;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Distance</label>
                            <div class="fdp-result-value" id="sdt1-result" style="font-size: 1.1rem; color: #00ff88; padding: 8px 0;">--- nm</div>
                        </div>
                    </div>

                    <!-- Row 2: Distance Ã· Speed = Time -->
                    <div class="sdt-row" style="display: flex; align-items: flex-end; gap: 8px; margin-bottom: 12px;">
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Distance (nm)</label>
                            <button class="input-btn" id="sdt2-dist-btn" onclick="openWeightPicker('sdt2-dist', 'Distance', 'nm')" style="padding: 8px 4px; font-size: 0.9rem;">---</button>
                            <input type="hidden" id="sdt2-dist" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">Ã·</span>
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Speed (kts)</label>
                            <div style="display: flex; gap: 3px;">
                                <button class="input-btn" id="sdt2-speed-btn" onclick="openWeightPicker('sdt2-speed', 'Speed', 'kts')" style="flex: 1; padding: 8px 4px; font-size: 0.9rem;">---</button>
                                <button class="preset-btn" onclick="fillSpeedFromGps('sdt2-speed')" style="font-size: 0.6rem; padding: 4px 5px;">GPS</button>
                            </div>
                            <input type="hidden" id="sdt2-speed" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">=</span>
                        <div style="flex: 1; min-width: 80px; text-align: center;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Time</label>
                            <div class="fdp-result-value" id="sdt2-result" style="font-size: 1.1rem; color: #00ff88; padding: 8px 0;">--- min</div>
                        </div>
                    </div>

                    <!-- Row 3: Distance Ã· Time = Speed -->
                    <div class="sdt-row" style="display: flex; align-items: flex-end; gap: 8px; margin-bottom: 12px;">
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Distance (nm)</label>
                            <button class="input-btn" id="sdt3-dist-btn" onclick="openWeightPicker('sdt3-dist', 'Distance', 'nm')" style="padding: 8px 4px; font-size: 0.9rem;">---</button>
                            <input type="hidden" id="sdt3-dist" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">Ã·</span>
                        <div style="flex: 1; min-width: 70px;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Time</label>
                            <button class="input-btn" id="sdt3-time-btn" onclick="openSDTDuration('sdt3-time')" style="padding: 8px 4px; font-size: 0.9rem;">---</button>
                            <input type="hidden" id="sdt3-time" value="">
                        </div>
                        <span style="color: #FF8200; font-size: 1.2rem; padding-bottom: 8px;">=</span>
                        <div style="flex: 1; min-width: 80px; text-align: center;">
                            <label class="fdp-label" style="font-size: 0.65rem;">Speed</label>
                            <div class="fdp-result-value" id="sdt3-result" style="font-size: 1.1rem; color: #00ff88; padding: 8px 0;">--- kts</div>
                        </div>
                    </div>

                    <button class="clear-btn" onclick="clearAllSDT()">Clear All</button>
                </div>

                <!-- Catch-Up Calculator -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Catch-Up Calculator</div>
                    <p style="color: #888; font-size: 0.75rem; text-align: center; margin-bottom: 10px;">
                        Calculate time to catch up or speed required
                    </p>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Distance Ahead (nm)</label>
                            <button class="input-btn" id="catchup-dist-btn" onclick="openWeightPicker('catchup-dist', 'Distance', 'nm')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-dist" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Their GS (kts)</label>
                            <button class="input-btn" id="catchup-their-gs-btn" onclick="openWeightPicker('catchup-their-gs', 'Their GS', 'kts')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-their-gs" value="">
                        </div>
                    </div>
                    <div class="fdp-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px;">
                        <div class="fdp-field">
                            <label class="fdp-label">Your GS (kts)</label>
                            <div style="display: flex; gap: 5px;">
                                <button class="input-btn" id="catchup-your-gs-btn" onclick="openWeightPicker('catchup-your-gs', 'Your GS', 'kts')" style="flex: 1;">---</button>
                                <button class="preset-btn" onclick="fillSpeedFromGps('catchup-your-gs')" style="font-size: 0.65rem; padding: 5px 6px;" title="Fill from GPS">GPS</button>
                            </div>
                            <input type="hidden" id="catchup-your-gs" value="">
                        </div>
                        <div class="fdp-field">
                            <label class="fdp-label">Time Limit</label>
                            <button class="input-btn" id="catchup-time-btn" onclick="openCatchupDuration('catchup-time')" style="max-width: 100%">---</button>
                            <input type="hidden" id="catchup-time" value="">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="preset-btn" onclick="calculateCatchUp('time')">Time to Catch Up</button>
                        <button class="preset-btn" onclick="calculateCatchUp('speed')">Speed Required</button>
                    </div>
                    <div class="fdp-result-value" id="catchup-result" style="text-align: center; margin-top: 15px; font-size: 1.3rem; color: #00ff88;">---</div>
                    <button class="clear-btn" onclick="clearCatchUp()">Clear</button>
                </div>

                <!-- Timezone Converter -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Timezone Converter</div>
                    <div class="input-grid-2" style="margin-bottom:15px">
                        <div class="input-group">
                            <label class="input-label">Input Time</label>
                            <button class="input-btn" id="tz-input-btn" onclick="openTimePicker('tz-input')" style="max-width:100%">----</button>
                            <input type="hidden" id="tz-input" value="">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Input Zone</label>
                            <select class="fdp-select" id="tz-input-zone" onchange="calculateTimezones()" style="max-width:100%">
                                <option value="0">UTC</option>
                                <option value="4" selected>DXB (+4)</option>
                            </select>
                        </div>
                    </div>
                    <div class="tz-converter" id="tz-results">
                        <div class="tz-row">
                            <span class="tz-offset">+0</span>
                            <span class="tz-time" id="tz-utc">--:--</span>
                            <span class="tz-label">UTC</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+3</span>
                            <span class="tz-time" id="tz-ruh">--:--</span>
                            <span class="tz-label">RUH/JED/KWI/BAH</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+3:30</span>
                            <span class="tz-time" id="tz-ika">--:--</span>
                            <span class="tz-label">IKA/MHD/SYZ</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+4</span>
                            <span class="tz-time" id="tz-dxb">--:--</span>
                            <span class="tz-label">DXB/MCT/TBS</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+4:30</span>
                            <span class="tz-time" id="tz-kbl">--:--</span>
                            <span class="tz-label">KBL</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+5</span>
                            <span class="tz-time" id="tz-khi">--:--</span>
                            <span class="tz-label">KHI/LHE/ISB/TAS</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+5:30</span>
                            <span class="tz-time" id="tz-del">--:--</span>
                            <span class="tz-label">DEL/BOM/COK/CMB</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+6</span>
                            <span class="tz-time" id="tz-dac">--:--</span>
                            <span class="tz-label">DAC/ALA</span>
                        </div>
                        <div class="tz-row">
                            <span class="tz-offset">+7</span>
                            <span class="tz-time" id="tz-bkk">--:--</span>
                            <span class="tz-label">BKK</span>
                        </div>
                    </div>
                    <button class="clear-btn" onclick="clearTimezones()">Clear</button>
                </div>
            </div>
        </div>

        <!-- LMC Tab (Last Minute Change Calculator) -->
        <div class="tab-content" id="tab-lmc">
            <div class="fdp-container">
                <!-- Setup Section -->
                <div class="top-sections" style="grid-template-columns: 1fr 1fr;">
                    <div class="section">
                        <div class="section-title">Aircraft & Method</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">Tail Number</label>
                                <div style="display: flex; gap: 5px;">
                                    <button class="input-btn" id="lmc-tail-btn" onclick="openLmcTailPicker()" style="flex: 1;">---</button>
                                    <button class="preset-btn" onclick="autofillLmcFromSchedule()" style="font-size: 0.7rem; padding: 5px 8px;">From Sched</button>
                                </div>
                                <input type="hidden" id="lmc-tail" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Type / Config</label>
                                <div id="lmc-aircraft-info" style="background: rgba(0,40,80,0.5); padding: 8px; border-radius: 6px; font-size: 0.85rem; color: #00d4ff;">---</div>
                                <div id="lmc-config-selector" style="display:none; gap:5px; margin-top:5px;"></div>
                            </div>
                        </div>
                        <div class="input-grid-2" style="margin-top: 10px;">
                            <div class="input-group">
                                <label class="input-label">Method</label>
                                <select class="fdp-select" id="lmc-method" onchange="lmcCalculate()">
                                    <option value="manual">Manual (max 3 changes)</option>
                                    <option value="skybook">Skybook (max 10 changes)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Pax Weights (M/F/C)</label>
                                <div style="display: flex; gap: 5px; font-size: 0.75rem; color: #888;">
                                    <span style="flex:1; text-align:center;">M: 88kg</span>
                                    <span style="flex:1; text-align:center;">F: 70kg</span>
                                    <span style="flex:1; text-align:center;">C: 35kg</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Baseline Weights (from Loadsheet)</div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">ZFW Initial (kg)</label>
                                <button class="input-btn" id="lmc-zfw-btn" onclick="openWeightPicker('lmc-zfw', 'ZFW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-zfw" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">MZFW Limit (kg)</label>
                                <button class="input-btn" id="lmc-mzfw-btn" onclick="openWeightPicker('lmc-mzfw', 'MZFW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-mzfw" value="">
                            </div>
                        </div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">TOW Initial (kg)</label>
                                <button class="input-btn" id="lmc-tow-btn" onclick="openWeightPicker('lmc-tow', 'TOW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-tow" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">RTOW Limit (kg)</label>
                                <button class="input-btn" id="lmc-rtow-btn" onclick="openWeightPicker('lmc-rtow', 'RTOW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-rtow" value="">
                            </div>
                        </div>
                        <div class="input-grid-2">
                            <div class="input-group">
                                <label class="input-label">LW Initial (kg)</label>
                                <button class="input-btn" id="lmc-lw-btn" onclick="openWeightPicker('lmc-lw', 'LW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-lw" value="">
                            </div>
                            <div class="input-group">
                                <label class="input-label">RLW Limit (kg)</label>
                                <button class="input-btn" id="lmc-rlw-btn" onclick="openWeightPicker('lmc-rlw', 'RLW', 'kg')" style="max-width:100%">0</button>
                                <input type="hidden" id="lmc-rlw" value="">
                            </div>
                        </div>
                        <div class="input-group" style="margin-top: 5px;">
                            <label class="input-label">Underload Available (kg)</label>
                            <button class="input-btn" id="lmc-underload-btn" onclick="openWeightPicker('lmc-underload', 'Underload', 'kg')" style="max-width:50%">0</button>
                            <input type="hidden" id="lmc-underload" value="">
                        </div>
                    </div>
                </div>

                <!-- LMC Changes Entry -->
                <div class="section" style="margin-top: 20px;">
                    <div class="section-title">LMC Changes</div>
                    <div id="lmc-changes-container">
                        <!-- Change entries will be added here -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="preset-btn" onclick="addLmcChange('PAX')" style="flex: 1;">+ PAX</button>
                        <button class="preset-btn" onclick="addLmcChange('CARGO')" style="flex: 1;">+ CARGO</button>
                        <button class="preset-btn" onclick="addLmcChange('BAGS')" style="flex: 1;">+ BAGS</button>
                        <button class="preset-btn" onclick="addLmcChange('FUEL')" style="flex: 1;">+ FUEL</button>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="top-sections" style="grid-template-columns: 1fr 1fr; margin-top: 20px;">
                    <!-- Summary -->
                    <div class="section">
                        <div class="section-title">LMC Summary</div>
                        <div class="lmc-summary">
                            <div class="lmc-summary-row">
                                <span>Total Weight Change:</span>
                                <span id="lmc-total-weight" class="lmc-value">0 kg</span>
                            </div>
                            <div class="lmc-summary-row">
                                <span>Total IU Correction:</span>
                                <span id="lmc-total-iu" class="lmc-value">0.0 IU</span>
                            </div>
                            <div class="lmc-summary-row">
                                <span>Number of Changes:</span>
                                <span id="lmc-num-changes" class="lmc-value">0</span>
                            </div>
                            <div class="lmc-summary-row" style="border-top: 1px solid #444; padding-top: 10px; margin-top: 10px;">
                                <span>ZFW Corrected:</span>
                                <span id="lmc-zfw-corr" class="lmc-value">--- kg</span>
                            </div>
                            <div class="lmc-summary-row">
                                <span>TOW Corrected:</span>
                                <span id="lmc-tow-corr" class="lmc-value">--- kg</span>
                            </div>
                            <div class="lmc-summary-row">
                                <span>LW Corrected:</span>
                                <span id="lmc-lw-corr" class="lmc-value">--- kg</span>
                            </div>
                        </div>
                    </div>

                    <!-- Validation -->
                    <div class="section">
                        <div class="section-title">Validation Checks</div>
                        <div class="lmc-validation" id="lmc-validation">
                            <div class="lmc-check" id="lmc-check-weight">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>Weight change â‰¤ 500 kg</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-iu">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>Index change â‰¤ 5.0 IU</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-zfw-min">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>ZFW â‰¥ 45,000 kg</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-changes">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>Changes within limit</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-underload">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>Within underload</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-mzfw">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>ZFW â‰¤ MZFW</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-rtow">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>TOW â‰¤ RTOW</span>
                            </div>
                            <div class="lmc-check" id="lmc-check-rlw">
                                <span class="lmc-check-icon">â—‹</span>
                                <span>LW â‰¤ RLW</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Decision Banner -->
                <div class="section" style="margin-top: 20px;">
                    <div class="section-title">Decision</div>
                    <div id="lmc-decision-banner" class="lmc-decision pending">
                        <div class="lmc-decision-main">
                            <span class="lmc-decision-icon">?</span>
                            <span class="lmc-decision-text">Enter LMC changes to calculate</span>
                        </div>
                    </div>
                    <div class="lmc-decision-details" id="lmc-decision-details" style="display: none;">
                        <div class="lmc-detail-row">
                            <span>New Loadsheet Required:</span>
                            <span id="lmc-new-loadsheet" class="lmc-detail-value">---</span>
                        </div>
                        <div class="lmc-detail-row">
                            <span>Recalc Takeoff Performance:</span>
                            <span id="lmc-recalc-perf" class="lmc-detail-value">---</span>
                        </div>
                        <div id="lmc-perf-reason" style="font-size: 0.75rem; color: #888; margin-top: 5px;"></div>
                    </div>
                </div>

                <!-- Line Items Audit -->
                <div class="section" style="margin-top: 20px;">
                    <div class="section-title">Line Item Details</div>
                    <div class="lmc-audit" id="lmc-audit">
                        <div style="color: #666; text-align: center; padding: 20px;">No changes entered</div>
                    </div>
                </div>

                <button class="clear-btn" onclick="clearLmc()" style="margin-top: 15px;">Clear All</button>
            </div>
        </div>

        <!-- NOTES Tab (Scratchpad) -->
        <div class="tab-content" id="tab-notes">
            <div class="fdp-container">
                <div class="section" style="max-width: 800px; margin: 0 auto;">
                    <div class="section-title">Scratchpad</div>
                    <div class="scratchpad-container">
                        <textarea class="scratchpad-textarea" id="notes-scratchpad" placeholder="ATIS, Clearances, Notes..." style="min-height: 300px;"></textarea>
                        <div style="display:flex;gap:10px;margin-top:10px">
                            <button class="preset-btn" style="flex:1;padding:10px" onclick="saveNotesScratchpad()">Save to History</button>
                            <button class="preset-btn" style="flex:1;padding:10px;background:rgba(255,80,80,0.2);border-color:#ff5050;color:#ff8888" onclick="clearNotesScratchpad()">Clear</button>
                        </div>
                        <div class="scratchpad-history" id="notes-scratchpad-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MISC Tab (Miscellaneous Tools) -->
        <div class="tab-content" id="tab-misc">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- Flight Route Lookup -->
                    <div class="section">
                        <div class="section-title">Flight Route Lookup</div>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                            Enter a flight number to find the route
                        </p>
                        <div class="fdp-field">
                            <label class="fdp-label">Flight</label>
                            <input type="text" class="fdp-input" id="route-flight-input" placeholder="e.g. FZ307, EK1, QR100"
                                   oninput="lookupFlightRoute()" style="text-transform: uppercase; font-size: 1.2rem; text-align: center;">
                        </div>
                        <div class="fdp-results" style="margin-top: 20px;">
                            <div class="fdp-result-grid" style="grid-template-columns: 1fr;">
                                <div class="fdp-result-item">
                                    <div class="fdp-result-label">Route</div>
                                    <div class="fdp-result-value" id="route-result" style="font-size: 1.3rem;">---</div>
                                    <div class="fdp-result-utc" id="route-icao" style="color: #888;">---</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; font-size: 0.75rem; color: #666;" id="route-status">
                            Loading route database...
                        </div>
                    </div>

                    <!-- Registration Prefix Lookup -->
                    <div class="section">
                        <div class="section-title">Registration Prefix Lookup</div>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                            Enter an aircraft registration prefix to find the country
                        </p>
                        <div class="fdp-field">
                            <label class="fdp-label">Prefix</label>
                            <input type="text" class="fdp-input" id="reg-prefix-input" placeholder="e.g. A6, N, G, VT"
                                   oninput="lookupRegistrationPrefix()" style="text-transform: uppercase; font-size: 1.2rem; text-align: center;">
                        </div>
                        <div class="fdp-results" style="margin-top: 20px;">
                            <div class="fdp-result-grid" style="grid-template-columns: 1fr;">
                                <div class="fdp-result-item">
                                    <div class="fdp-result-label">Country</div>
                                    <div class="fdp-result-value" id="reg-country-result" style="font-size: 1.5rem;">---</div>
                                    <div class="fdp-result-utc" id="reg-country-code" style="color: #888;">---</div>
                                </div>
                            </div>
                        </div>
                        <!-- Common prefixes quick buttons -->
                        <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='A6';lookupRegistrationPrefix()">A6</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='N';lookupRegistrationPrefix()">N</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='G';lookupRegistrationPrefix()">G</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='VT';lookupRegistrationPrefix()">VT</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='9V';lookupRegistrationPrefix()">9V</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='B';lookupRegistrationPrefix()">B</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='JA';lookupRegistrationPrefix()">JA</button>
                            <button class="preset-btn" onclick="document.getElementById('reg-prefix-input').value='HL';lookupRegistrationPrefix()">HL</button>
                        </div>
                    </div>
                </div>

                <!-- Callsign / Route Lookup -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title">Callsign / Route Lookup</div>
                    <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                        Search by callsign (e.g. 2LA, 307) or route (e.g. DXB-TBS, OMDB-UGTB)
                    </p>
                    <div class="fdp-field">
                        <label class="fdp-label">Callsign or Route</label>
                        <input type="text" class="fdp-input" id="callsign-input" placeholder="e.g. 2LA or DXB-TBS"
                               oninput="lookupCallsign()" style="text-transform: uppercase; font-size: 1.2rem; text-align: center;">
                    </div>
                    <div class="fdp-results" style="margin-top: 20px;">
                        <div id="callsign-results" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #888;">Enter a callsign to search</div>
                        </div>
                    </div>
                </div>

                <!-- Pantry Selector Calculator -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title">Pantry Selector (DXB)</div>
                    <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                        Calculate pantry code, weight and index for DOW/DOI
                    </p>
                    <div class="pantry-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label class="input-label">Aircraft</label>
                            <select id="pantry-aircraft" class="fdp-select" style="width: 100%; height: 44px; font-size: 1rem;" onchange="updatePantryConfigOptions(); calculatePantry();">
                                <option value="">Select</option>
                                <option value="B737-800">B737-800</option>
                                <option value="B737-8">B737-8</option>
                                <option value="B737-9">B737-9</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Config</label>
                            <select id="pantry-config" class="fdp-select" style="width: 100%; height: 44px; font-size: 1rem;" onchange="calculatePantry();">
                                <option value="">Select</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Direction</label>
                            <select id="pantry-direction" class="fdp-select" style="width: 100%; height: 44px; font-size: 1rem;" onchange="calculatePantry();">
                                <option value="">Select</option>
                                <option value="OUTBOUND_DXB">From DXB</option>
                                <option value="INBOUND_DXB">To DXB</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Type</label>
                            <select id="pantry-flight-type" class="fdp-select" style="width: 100%; height: 44px; font-size: 1rem;" onchange="calculatePantry();">
                                <option value="NORMAL">Normal</option>
                                <option value="TRAINING">Training</option>
                                <option value="DELIVERY">Delivery</option>
                                <option value="FERRY">Ferry</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Dest (IATA)</label>
                            <input type="text" class="fdp-input" id="pantry-destination" placeholder="TBS"
                                   oninput="calculatePantry()" style="text-transform: uppercase; font-size: 1rem; text-align: center;" maxlength="3">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Route Pair</label>
                            <input type="text" class="fdp-input" id="pantry-route-pair" placeholder="MLE-CMB"
                                   oninput="calculatePantry()" style="text-transform: uppercase; font-size: 1rem; text-align: center;" maxlength="7">
                        </div>
                    </div>
                    <div class="fdp-results" style="margin-top: 20px;">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Pantry Code</div>
                                <div class="fdp-result-value" id="pantry-code-result" style="font-size: 2rem; color: #00d4ff;">---</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Weight</div>
                                <div class="fdp-result-value" id="pantry-weight-result" style="font-size: 1.5rem;">--- kg</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Index</div>
                                <div class="fdp-result-value" id="pantry-index-result" style="font-size: 1.5rem;">--- IU</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; text-align: center; font-size: 0.85rem; color: #888;" id="pantry-match-reason">
                        Enter aircraft, config, direction and destination
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="clear-btn" onclick="clearPantryCalculator()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUN Tab (Solar Calculations) -->
        <div class="tab-content" id="tab-sun">
            <div class="fdp-container">
                <div class="fdp-section" style="text-align: center; padding: 15px;">
                    <h2 style="color: #FF8200; margin-bottom: 5px;">Solar Calculator</h2>
                    <div id="sun-current-utc" style="color: #888; font-size: 0.9rem;"></div>
                </div>

                <!-- Airport Input -->
                <div class="section" style="max-width: 800px; margin: 0 auto;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Location</span>
                        <div id="sun-sector-switcher" style="display: none; font-size: 0.85rem;">
                            <button class="preset-btn" onclick="sunSectorPrev()" style="padding: 4px 10px; font-size: 0.8rem;">â—€</button>
                            <span id="sun-sector-display" style="margin: 0 8px; color: #FF8200;">Sector 1/1</span>
                            <button class="preset-btn" onclick="sunSectorNext()" style="padding: 4px 10px; font-size: 0.8rem;">â–¶</button>
                        </div>
                    </div>
                    <div class="sun-location-grid" style="display: flex; flex-direction: column; gap: 10px;">
                        <div class="fdp-field">
                            <label>Airport</label>
                            <input type="text" id="sun-airport" class="fdp-input" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase;" oninput="this.value=this.value.toUpperCase()" onfocus="clearSunCoords()">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div class="fdp-field" style="flex: 2;">
                                <label>Lat</label>
                                <input type="text" id="sun-lat" class="fdp-input" placeholder="25.25" style="text-align: center;" onfocus="clearSunAirport()">
                            </div>
                            <div class="fdp-field" style="flex: 2;">
                                <label>Lon</label>
                                <input type="text" id="sun-lon" class="fdp-input" placeholder="55.36" style="text-align: center;" onfocus="clearSunAirport()">
                            </div>
                            <button class="preset-btn sun-gps-btn" onclick="useSunGps()" style="height: 38px; padding: 0 12px; font-size: 0.9rem;" title="Use GPS location">ðŸ“</button>
                        </div>
                    </div>
                    <div class="sun-date-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end; margin-top: 10px;">
                        <div class="fdp-field">
                            <label>Date</label>
                            <input type="date" id="sun-date" class="fdp-input">
                        </div>
                        <button class="preset-btn" onclick="calculateSunTimes()" style="padding: 10px 20px; font-size: 0.9rem;">Calc</button>
                    </div>
                    <div id="sun-location-info" style="color: #888; font-size: 0.85rem; margin-top: 5px; text-align: center;"></div>
                </div>

                <!-- Sun & Moon Rise/Set Times -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="sun-moon-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Sun Times -->
                        <div>
                            <div class="section-title" style="color: #FF8200;">Sun</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="text-align: center; padding: 12px; background: rgba(255,200,0,0.1); border-radius: 8px;">
                                    <div style="font-size: 0.8rem; color: #FFD700;">RISE</div>
                                    <div id="sun-sunrise-utc" style="font-size: 1.5rem; color: #FFD700; font-weight: bold;">--:--</div>
                                    <div id="sun-sunrise-local" style="font-size: 0.75rem; color: #888;">Local: --:--</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: rgba(255,100,0,0.1); border-radius: 8px;">
                                    <div style="font-size: 0.8rem; color: #FF6B35;">SET</div>
                                    <div id="sun-sunset-utc" style="font-size: 1.5rem; color: #FF6B35; font-weight: bold;">--:--</div>
                                    <div id="sun-sunset-local" style="font-size: 0.75rem; color: #888;">Local: --:--</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 8px;">
                                <span style="color: #888; font-size: 0.85rem;">Daylight: </span>
                                <span id="sun-daylight-hours" style="color: #4CAF50; font-weight: bold;">--:--</span>
                            </div>
                        </div>
                        <!-- Moon Times -->
                        <div>
                            <div class="section-title" style="color: #6495ED;">Moon</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="text-align: center; padding: 12px; background: rgba(100,149,237,0.1); border-radius: 8px;">
                                    <div style="font-size: 0.8rem; color: #6495ED;">RISE</div>
                                    <div id="moon-rise" style="font-size: 1.5rem; color: #6495ED; font-weight: bold;">--:--</div>
                                    <div style="font-size: 0.75rem; color: #888;">&nbsp;</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: rgba(100,149,237,0.1); border-radius: 8px;">
                                    <div style="font-size: 0.8rem; color: #6495ED;">SET</div>
                                    <div id="moon-set" style="font-size: 1.5rem; color: #6495ED; font-weight: bold;">--:--</div>
                                    <div style="font-size: 0.75rem; color: #888;">&nbsp;</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 8px;">
                                <span id="moon-phase" style="color: #888; font-size: 0.85rem;">--</span>
                                <span style="color: #666;"> Â· </span>
                                <span id="moon-illumination-pct" style="color: #e8e8e8; font-size: 0.85rem;">--%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Sun & Moon Position -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title">Sun & Moon Direction</div>
                    <div class="sun-moon-direction-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Sun Position -->
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="position: relative; width: 80px; height: 80px; flex-shrink: 0;">
                                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                    <circle cx="50" cy="50" r="40" fill="rgba(0,20,40,0.8)" stroke="rgba(255,130,0,0.4)" stroke-width="2"/>
                                    <text x="50" y="18" text-anchor="middle" fill="#666" font-size="9">N</text>
                                    <text x="85" y="53" text-anchor="middle" fill="#666" font-size="9">E</text>
                                    <text x="50" y="90" text-anchor="middle" fill="#666" font-size="9">S</text>
                                    <text x="15" y="53" text-anchor="middle" fill="#666" font-size="9">W</text>
                                    <g id="sun-compass-arrow" transform="rotate(0, 50, 50)">
                                        <line x1="50" y1="50" x2="50" y2="25" stroke="#FFD700" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="50" cy="25" r="6" fill="#FFD700"/>
                                    </g>
                                    <circle cx="50" cy="50" r="3" fill="#FF8200"/>
                                </svg>
                            </div>
                            <div style="display: grid; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Elev</span>
                                    <span id="sun-elevation" style="font-size: 1.1rem; color: #FF8200;">--Â°</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Azim</span>
                                    <span id="sun-azimuth" style="font-size: 1.1rem; color: #FF8200;">--Â°</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Status</span>
                                    <span id="sun-status" style="font-size: 0.9rem; color: #4CAF50;">--</span>
                                </div>
                            </div>
                        </div>
                        <!-- Moon Position -->
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="position: relative; width: 80px; height: 80px; flex-shrink: 0;">
                                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                    <circle cx="50" cy="50" r="40" fill="rgba(0,20,40,0.8)" stroke="rgba(100,149,237,0.4)" stroke-width="2"/>
                                    <text x="50" y="18" text-anchor="middle" fill="#666" font-size="9">N</text>
                                    <text x="85" y="53" text-anchor="middle" fill="#666" font-size="9">E</text>
                                    <text x="50" y="90" text-anchor="middle" fill="#666" font-size="9">S</text>
                                    <text x="15" y="53" text-anchor="middle" fill="#666" font-size="9">W</text>
                                    <g id="moon-compass-arrow" transform="rotate(0, 50, 50)">
                                        <line x1="50" y1="50" x2="50" y2="25" stroke="#6495ED" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="50" cy="25" r="6" fill="#6495ED"/>
                                    </g>
                                    <circle cx="50" cy="50" r="3" fill="#6495ED"/>
                                </svg>
                            </div>
                            <div style="display: grid; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Elev</span>
                                    <span id="moon-elevation" style="font-size: 1.1rem; color: #6495ED;">--Â°</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Azim</span>
                                    <span id="moon-azimuth" style="font-size: 1.1rem; color: #6495ED;">--Â°</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #888; font-size: 0.75rem; width: 50px;">Phase</span>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <svg viewBox="0 0 100 100" id="moon-phase-svg" style="width: 24px; height: 24px;">
                                            <circle cx="50" cy="50" r="40" fill="#1a1a1a" stroke="#333" stroke-width="2"/>
                                            <path id="moon-illumination" d="" fill="#e8e8e8"/>
                                        </svg>
                                        <span id="moon-illumination-pct-dir" style="font-size: 0.9rem; color: #6495ED;">--%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Twilight Times -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title">Twilight Times (UTC)</div>
                    <div class="twilight-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                        <div style="text-align: center; padding: 10px; background: rgba(100,149,237,0.15); border-radius: 8px;">
                            <div style="color: #6495ED; margin-bottom: 5px;">Civil</div>
                            <div style="color: #888; font-size: 0.8rem;">Sun 6Â° below</div>
                            <div id="sun-civil-dawn" style="color: #fff;">--:--</div>
                            <div id="sun-civil-dusk" style="color: #fff;">--:--</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(65,105,225,0.15); border-radius: 8px;">
                            <div style="color: #4169E1; margin-bottom: 5px;">Nautical</div>
                            <div style="color: #888; font-size: 0.8rem;">Sun 12Â° below</div>
                            <div id="sun-nautical-dawn" style="color: #fff;">--:--</div>
                            <div id="sun-nautical-dusk" style="color: #fff;">--:--</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(25,25,112,0.3); border-radius: 8px;">
                            <div style="color: #7B68EE; margin-bottom: 5px;">Astronomical</div>
                            <div style="color: #888; font-size: 0.8rem;">Sun 18Â° below</div>
                            <div id="sun-astro-dawn" style="color: #fff;">--:--</div>
                            <div id="sun-astro-dusk" style="color: #fff;">--:--</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: #888; font-size: 0.8rem;">
                        Position lights required: Sunset to Sunrise (or Civil Twilight)
                    </div>
                </div>

                <!-- Arrival Daylight & Glare Check -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <span>Arrival Conditions</span>
                        <div id="arr-cond-switcher" style="display: none; font-size: 0.85rem; align-items: center;">
                            <button class="preset-btn" onclick="arrCondPrev()" style="padding: 4px 8px; font-size: 0.75rem;">â—€</button>
                            <span id="arr-cond-display" style="margin: 0 6px; color: #FF8200; font-size: 0.8rem;">---</span>
                            <button class="preset-btn" onclick="arrCondNext()" style="padding: 4px 8px; font-size: 0.75rem;">â–¶</button>
                        </div>
                    </div>
                    <div class="arrival-conditions-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <div class="fdp-field">
                            <label>Destination</label>
                            <input type="text" id="sun-arr-airport" class="fdp-input" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase;" oninput="this.value=this.value.toUpperCase()">
                        </div>
                        <div class="fdp-field">
                            <label>Date</label>
                            <input type="date" id="sun-arr-date" class="fdp-input">
                        </div>
                        <div class="fdp-field">
                            <label>ETA (UTC)</label>
                            <input type="hidden" id="sun-arr-eta">
                            <button id="sun-arr-eta-btn" class="picker-btn placeholder" onclick="openTimePicker('sun-arr-eta')" style="padding: 10px; font-size: 1rem; background: rgba(0, 0, 0, 0.3);">----</button>
                        </div>
                        <div class="fdp-field">
                            <label>Rwy Hdg</label>
                            <input type="number" id="sun-arr-rwy" class="fdp-input" placeholder="e.g. 120" min="1" max="360" style="text-align: center;">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="preset-btn" onclick="checkArrivalConditions()" style="padding: 10px 20px; font-size: 0.9rem;">Check Conditions</button>
                    </div>
                    <div id="sun-arrival-result" style="margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center; display: none;">
                    </div>
                </div>

                <!-- Night Flight Time Calculator -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <span>Night Flight Time</span>
                        <div id="night-sector-switcher" style="display: none; font-size: 0.85rem; align-items: center;">
                            <button class="preset-btn" onclick="nightSectorPrev()" style="padding: 4px 8px; font-size: 0.75rem;">â—€</button>
                            <span id="night-sector-display" style="margin: 0 6px; color: #FF8200; font-size: 0.8rem;">---</span>
                            <button class="preset-btn" onclick="nightSectorNext()" style="padding: 4px 8px; font-size: 0.75rem;">â–¶</button>
                        </div>
                    </div>
                    <div class="night-time-grid" style="display: grid; grid-template-columns: 0.6fr 0.6fr 1fr 1fr 1fr; gap: 10px;">
                        <div class="fdp-field">
                            <label>Dep</label>
                            <input type="text" id="sun-night-dep" class="fdp-input" placeholder="CODE" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value=this.value.toUpperCase()">
                        </div>
                        <div class="fdp-field">
                            <label>Arr</label>
                            <input type="text" id="sun-night-arr" class="fdp-input" placeholder="CODE" maxlength="4" style="text-transform: uppercase; text-align: center;" oninput="this.value=this.value.toUpperCase()">
                        </div>
                        <div class="fdp-field">
                            <label>Date</label>
                            <input type="date" id="sun-night-date" class="fdp-input">
                        </div>
                        <div class="fdp-field">
                            <label>OFF (UTC)</label>
                            <input type="hidden" id="sun-night-off">
                            <button id="sun-night-off-btn" class="picker-btn placeholder" onclick="openTimePicker('sun-night-off')" style="padding: 10px; font-size: 1rem; background: rgba(0, 0, 0, 0.3);">----</button>
                        </div>
                        <div class="fdp-field">
                            <label>ON (UTC)</label>
                            <input type="hidden" id="sun-night-on">
                            <button id="sun-night-on-btn" class="picker-btn placeholder" onclick="openTimePicker('sun-night-on')" style="padding: 10px; font-size: 1rem; background: rgba(0, 0, 0, 0.3);">----</button>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="preset-btn" onclick="calculateNightTime()" style="padding: 10px 20px; font-size: 0.9rem;">Calculate Night Time</button>
                    </div>
                    <div id="sun-night-result" style="margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center; display: none;">
                    </div>
                </div>

                <!-- Daylight Hours Trend -->
                <div class="section" style="max-width: 800px; margin: 20px auto 0;">
                    <div class="section-title">Daylight Hours This Month</div>
                    <div id="sun-daylight-trend" style="display: flex; justify-content: space-between; align-items: flex-end; height: 100px; padding: 10px 0; border-bottom: 1px solid #333;">
                        <!-- Bars will be generated here -->
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.75rem; margin-top: 5px;">
                        <span>1</span>
                        <span id="sun-trend-month">--</span>
                        <span id="sun-trend-last-day">31</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span style="color: #888;">Longest day: </span>
                        <span id="sun-longest-day" style="color: #4CAF50;">--</span>
                        <span style="color: #888; margin-left: 15px;">Shortest: </span>
                        <span id="sun-shortest-day" style="color: #FF6B35;">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SET Tab (Settings) -->
        <div class="tab-content" id="tab-set">
            <div class="fdp-container">
                <div class="top-sections" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- Quick Reset -->
                    <div class="section">
                        <div class="section-title">Quick Reset</div>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; text-align: center;">
                            Reset all entries and timers. Notes will be preserved.
                        </p>
                        <button class="clear-btn" style="width: 100%; padding: 15px; font-size: 1.1rem;" onclick="quickResetAll()">
                            Reset All Data
                        </button>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 130, 0, 0.2);">
                            <button class="preset-btn" style="width: 100%;" onclick="exportAllData()">
                                Export to Markdown
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Data Status -->
                <div class="section" style="max-width: 600px; margin: 20px auto 0;">
                    <div class="section-title">Data Status</div>
                    <div class="fdp-results" style="margin-top: 0;">
                        <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Schedule Sectors</div>
                                <div class="fdp-result-value" id="status-sectors" style="color: #FF8200;">0</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Active Timers</div>
                                <div class="fdp-result-value" id="status-timers" style="color: #00ff88;">0</div>
                            </div>
                            <div class="fdp-result-item">
                                <div class="fdp-result-label">Notes Saved</div>
                                <div class="fdp-result-value" id="status-notes" style="color: #00d4ff;">0</div>
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 0.75rem; margin-top: 15px;">
                        All data is stored locally in your browser and persists across sessions.
                    </p>
                </div>
            </div>
        </div>

        <!-- REF Tab (Reference Data) -->
        <div class="tab-content" id="tab-ref">
            <div class="fdp-container">
                <!-- Airfield Authorization Lookup -->
                <div class="section" style="max-width: 400px; margin: 0 auto; padding: 12px;">
                    <div class="section-title" style="margin-bottom: 8px;">Airfield Auth Lookup</div>

                    <!-- Schedule Switcher -->
                    <div id="ref-switcher" style="display: none; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; padding: 6px; background: rgba(255, 130, 0, 0.1); border-radius: 6px;">
                        <button class="preset-btn" onclick="refSwitcherPrev()" style="padding: 4px 10px; min-width: auto;">&lt;</button>
                        <span id="ref-switcher-display" style="font-size: 0.85rem; min-width: 100px; text-align: center;"></span>
                        <button class="preset-btn" onclick="refSwitcherNext()" style="padding: 4px 10px; min-width: auto;">&gt;</button>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <input type="text" id="ref-airport-code" class="fdp-input" placeholder="ICAO/IATA" maxlength="4" style="text-transform: uppercase; text-align: center; font-size: 1.1rem; flex: 1;" oninput="this.value = this.value.toUpperCase()" onfocus="this.value = ''">
                        <button class="calc-btn" onclick="lookupAirfieldAuth()" style="padding: 8px 15px;">GO</button>
                    </div>

                    <!-- Results -->
                    <div id="ref-results" style="display: none;">
                        <div style="text-align: center; margin-bottom: 8px;">
                            <div id="ref-airport-name" style="font-size: 1.1rem; font-weight: bold; color: #fff;"></div>
                            <div id="ref-airport-codes" style="font-size: 0.8rem; color: #888;"></div>
                        </div>

                        <div id="ref-category" style="text-align: center; margin-bottom: 8px; padding: 6px; border-radius: 6px;"></div>

                        <div id="ref-restrictions" style="display: none; margin-bottom: 8px; padding: 8px; background: rgba(255, 100, 100, 0.1); border: 1px solid rgba(255, 100, 100, 0.3); border-radius: 6px;">
                            <div style="color: #ff6464; font-weight: bold; font-size: 0.8rem; margin-bottom: 3px;">Restrictions:</div>
                            <div id="ref-restrictions-text" style="color: #ff9999; font-size: 0.8rem;"></div>
                        </div>

                        <div class="fdp-result-grid" style="grid-template-columns: repeat(3, 1fr); gap: 6px;">
                            <div class="fdp-result-item" id="ref-auth-dest" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.65rem;">DEST</div>
                                <div class="fdp-result-value" id="ref-dest-status" style="font-size: 0.9rem;">-</div>
                            </div>
                            <div class="fdp-result-item" id="ref-auth-alt" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.65rem;">ALT</div>
                                <div class="fdp-result-value" id="ref-alt-status" style="font-size: 0.9rem;">-</div>
                            </div>
                            <div class="fdp-result-item" id="ref-auth-enr" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.65rem;">ERA</div>
                                <div class="fdp-result-value" id="ref-enr-status" style="font-size: 0.9rem;">-</div>
                            </div>
                            <div class="fdp-result-item" id="ref-auth-emerg" style="padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.65rem;">EMERG</div>
                                <div class="fdp-result-value" id="ref-emerg-status" style="font-size: 0.9rem;">-</div>
                            </div>
                            <div class="fdp-result-item" id="ref-auth-etops" style="grid-column: span 2; padding: 8px 4px;">
                                <div class="fdp-result-label" style="font-size: 0.65rem;">ETOPS ALT</div>
                                <div class="fdp-result-value" id="ref-etops-status" style="font-size: 0.9rem;">-</div>
                            </div>
                        </div>
                    </div>

                    <div id="ref-not-found" style="display: none; text-align: center; padding: 15px; color: #ff6464; font-size: 0.9rem;">
                        Not found in OM-C database
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Number Picker Modal -->
    <div class="modal-overlay" id="number-picker-modal">
        <div class="number-picker">
            <div class="picker-title" id="picker-title">Set Value</div>
            <div class="picker-display">
                <span class="picker-value" id="picker-value">0</span>
                <span class="picker-unit" id="picker-unit"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="pickerAppend('1')">1</button>
                <button class="picker-btn" onclick="pickerAppend('2')">2</button>
                <button class="picker-btn" onclick="pickerAppend('3')">3</button>
                <button class="picker-btn" onclick="pickerAppend('4')">4</button>
                <button class="picker-btn" onclick="pickerAppend('5')">5</button>
                <button class="picker-btn" onclick="pickerAppend('6')">6</button>
                <button class="picker-btn" onclick="pickerAppend('7')">7</button>
                <button class="picker-btn" onclick="pickerAppend('8')">8</button>
                <button class="picker-btn" onclick="pickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="pickerClear()">C</button>
                <button class="picker-btn" onclick="pickerAppend('0')">0</button>
                <button class="picker-btn" onclick="pickerBackspace()">&larr;</button>
                <button class="picker-btn" onclick="pickerAppend('00')">00</button>
                <button class="picker-btn" onclick="pickerAppend('000')">000</button>
                <button class="picker-btn" onclick="pickerAppend('.')" style="font-size:1.5rem;">.</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closePicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Duration Picker Modal (smart h/m entry) -->
    <div class="modal-overlay" id="duration-picker-modal">
        <div class="number-picker">
            <div class="picker-title" id="duration-picker-title">Enter Time</div>
            <div class="picker-display" style="flex-direction: column; gap: 5px;">
                <span class="picker-value" id="duration-picker-value" style="font-size: 1.8rem;">0m</span>
                <span style="font-size: 0.7rem; color: #888;" id="duration-picker-mins">= 0 minutes</span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="durationAppend('1')">1</button>
                <button class="picker-btn" onclick="durationAppend('2')">2</button>
                <button class="picker-btn" onclick="durationAppend('3')">3</button>
                <button class="picker-btn" onclick="durationAppend('4')">4</button>
                <button class="picker-btn" onclick="durationAppend('5')">5</button>
                <button class="picker-btn" onclick="durationAppend('6')">6</button>
                <button class="picker-btn" onclick="durationAppend('7')">7</button>
                <button class="picker-btn" onclick="durationAppend('8')">8</button>
                <button class="picker-btn" onclick="durationAppend('9')">9</button>
                <button class="picker-btn" onclick="durationAppend('h')" style="background: rgba(255,130,0,0.3); color: #FF8200; font-weight: bold;">h</button>
                <button class="picker-btn" onclick="durationAppend('0')">0</button>
                <button class="picker-btn" onclick="durationAppend('m')" style="background: rgba(0,212,255,0.3); color: #00d4ff; font-weight: bold;">m</button>
                <button class="picker-btn clear" onclick="durationClear()">C</button>
                <button class="picker-btn" onclick="durationBackspace()">&larr;</button>
                <button class="picker-btn" onclick="durationAppend('30')" style="font-size: 0.9rem;">30</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeDurationPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmDurationPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Aircraft Picker Modal -->
    <div class="modal-overlay" id="aircraft-picker-modal">
        <div class="number-picker" style="max-width: 280px;">
            <div class="picker-title">Select Aircraft</div>
            <div style="display: flex; flex-direction: column; gap: 10px; padding: 15px;">
                <button class="picker-btn" id="ac-pick-b738" onclick="selectAircraftPick('B738')" style="padding: 15px; font-size: 1.2rem;">B738</button>
                <button class="picker-btn" id="ac-pick-b38m" onclick="selectAircraftPick('B38M')" style="padding: 15px; font-size: 1.2rem;">B38M</button>
                <button class="picker-btn" id="ac-pick-b39m" onclick="selectAircraftPick('B39M')" style="padding: 15px; font-size: 1.2rem;">B39M</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeAircraftPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Flight Number Picker Modal -->
    <div class="modal-overlay" id="flight-picker-modal">
        <div class="number-picker" style="max-width: 320px;">
            <div class="picker-title">Flight Number</div>
            <div class="picker-display">
                <span style="color: #888; font-size: 1.4rem;">FZ</span>
                <span class="picker-value" id="flight-picker-value" style="font-size: 1.8rem;">___</span>
                <span id="flight-picker-suffix" style="font-size: 1.4rem; color: #FF8200; margin-left: 2px;"></span>
            </div>
            <div class="picker-buttons">
                <button class="picker-btn" onclick="flightPickerAppend('1')">1</button>
                <button class="picker-btn" onclick="flightPickerAppend('2')">2</button>
                <button class="picker-btn" onclick="flightPickerAppend('3')">3</button>
                <button class="picker-btn" onclick="flightPickerAppend('4')">4</button>
                <button class="picker-btn" onclick="flightPickerAppend('5')">5</button>
                <button class="picker-btn" onclick="flightPickerAppend('6')">6</button>
                <button class="picker-btn" onclick="flightPickerAppend('7')">7</button>
                <button class="picker-btn" onclick="flightPickerAppend('8')">8</button>
                <button class="picker-btn" onclick="flightPickerAppend('9')">9</button>
                <button class="picker-btn clear" onclick="flightPickerClear()">C</button>
                <button class="picker-btn" onclick="flightPickerAppend('0')">0</button>
                <button class="picker-btn" onclick="flightPickerBackspace()">&larr;</button>
            </div>
            <div style="display: flex; gap: 10px; padding: 10px 15px;">
                <button class="picker-btn" id="flight-suffix-none" onclick="setFlightSuffix('')" style="flex: 1; padding: 12px; background: rgba(255,130,0,0.3);">None</button>
                <button class="picker-btn" id="flight-suffix-a" onclick="setFlightSuffix('A')" style="flex: 1; padding: 12px;">A</button>
                <button class="picker-btn" id="flight-suffix-b" onclick="setFlightSuffix('B')" style="flex: 1; padding: 12px;">B</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeFlightPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmFlightPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Tail Number Picker Modal -->
    <div class="modal-overlay" id="tail-picker-modal">
        <div class="number-picker" style="max-width: 340px; width: 90%;">
            <div class="picker-title">Tail Number</div>
            <div class="picker-display">
                <span style="color: #888; font-size: 1.4rem;">A6-</span>
                <span class="picker-value" id="tail-picker-value" style="font-size: 1.8rem;">___</span>
            </div>
            <!-- Fleet prefixes -->
            <div class="picker-buttons" style="grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; gap: 4px;">
                <button class="picker-btn" onclick="tailPickerSetPrefix('FE')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FE</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FG')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FG</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FK')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FK</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FM')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FM</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FN')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FN</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FP')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FP</button>
                <button class="picker-btn" onclick="tailPickerSetPrefix('FQ')" style="background: rgba(255,130,0,0.3); min-width: 0; padding: 12px 0; font-size: 0.9rem;">FQ</button>
            </div>
            <!-- Last letter (dynamic based on prefix) -->
            <div class="picker-buttons" id="tail-letters-grid" style="grid-template-columns: repeat(7, 1fr); gap: 4px;">
                <button class="picker-btn" onclick="tailPickerAppend('A')" style="min-width: 0; padding: 12px 0;">A</button>
                <button class="picker-btn" onclick="tailPickerAppend('B')" style="min-width: 0; padding: 12px 0;">B</button>
                <button class="picker-btn" onclick="tailPickerAppend('C')" style="min-width: 0; padding: 12px 0;">C</button>
                <button class="picker-btn" onclick="tailPickerAppend('D')" style="min-width: 0; padding: 12px 0;">D</button>
                <button class="picker-btn" onclick="tailPickerAppend('E')" style="min-width: 0; padding: 12px 0;">E</button>
                <button class="picker-btn" onclick="tailPickerAppend('F')" style="min-width: 0; padding: 12px 0;">F</button>
                <button class="picker-btn" onclick="tailPickerAppend('G')" style="min-width: 0; padding: 12px 0;">G</button>
                <button class="picker-btn" onclick="tailPickerAppend('H')" style="min-width: 0; padding: 12px 0;">H</button>
                <button class="picker-btn" onclick="tailPickerAppend('I')" style="min-width: 0; padding: 12px 0;">I</button>
                <button class="picker-btn" onclick="tailPickerAppend('J')" style="min-width: 0; padding: 12px 0;">J</button>
                <button class="picker-btn" onclick="tailPickerAppend('K')" style="min-width: 0; padding: 12px 0;">K</button>
                <button class="picker-btn" onclick="tailPickerAppend('L')" style="min-width: 0; padding: 12px 0;">L</button>
                <button class="picker-btn" onclick="tailPickerAppend('M')" style="min-width: 0; padding: 12px 0;">M</button>
                <button class="picker-btn" onclick="tailPickerAppend('N')" style="min-width: 0; padding: 12px 0;">N</button>
                <button class="picker-btn" onclick="tailPickerAppend('O')" style="min-width: 0; padding: 12px 0;">O</button>
                <button class="picker-btn" onclick="tailPickerAppend('P')" style="min-width: 0; padding: 12px 0;">P</button>
                <button class="picker-btn" onclick="tailPickerAppend('Q')" style="min-width: 0; padding: 12px 0;">Q</button>
                <button class="picker-btn" onclick="tailPickerAppend('R')" style="min-width: 0; padding: 12px 0;">R</button>
                <button class="picker-btn" onclick="tailPickerAppend('S')" style="min-width: 0; padding: 12px 0;">S</button>
                <button class="picker-btn" onclick="tailPickerAppend('T')" style="min-width: 0; padding: 12px 0;">T</button>
                <button class="picker-btn" onclick="tailPickerAppend('U')" style="min-width: 0; padding: 12px 0;">U</button>
                <button class="picker-btn" onclick="tailPickerAppend('V')" style="min-width: 0; padding: 12px 0;">V</button>
                <button class="picker-btn" onclick="tailPickerAppend('W')" style="min-width: 0; padding: 12px 0;">W</button>
                <button class="picker-btn" onclick="tailPickerAppend('X')" style="min-width: 0; padding: 12px 0;">X</button>
                <button class="picker-btn" onclick="tailPickerAppend('Y')" style="min-width: 0; padding: 12px 0;">Y</button>
                <button class="picker-btn" onclick="tailPickerAppend('Z')" style="min-width: 0; padding: 12px 0;">Z</button>
                <button class="picker-btn clear" onclick="tailPickerClear()" style="min-width: 0; padding: 12px 0;">C</button>
                <button class="picker-btn" onclick="tailPickerBackspace()" style="min-width: 0; padding: 12px 0;">â†</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeTailPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmTailPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Stand Picker Modal -->
    <div class="modal-overlay" id="stand-picker-modal">
        <div class="number-picker" style="max-width: 340px; width: 90%;">
            <div class="picker-title">Stand Number</div>
            <div class="picker-display">
                <span class="picker-value" id="stand-picker-value" style="font-size: 2rem;">---</span>
            </div>
            <!-- Letters A-M -->
            <div class="picker-buttons" style="grid-template-columns: repeat(7, 1fr); gap: 3px; margin-bottom: 4px;">
                <button class="picker-btn" onclick="standPickerAppend('A')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">A</button>
                <button class="picker-btn" onclick="standPickerAppend('B')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">B</button>
                <button class="picker-btn" onclick="standPickerAppend('C')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">C</button>
                <button class="picker-btn" onclick="standPickerAppend('D')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">D</button>
                <button class="picker-btn" onclick="standPickerAppend('E')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">E</button>
                <button class="picker-btn" onclick="standPickerAppend('F')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">F</button>
                <button class="picker-btn" onclick="standPickerAppend('G')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">G</button>
                <button class="picker-btn" onclick="standPickerAppend('H')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">H</button>
                <button class="picker-btn" onclick="standPickerAppend('I')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">I</button>
                <button class="picker-btn" onclick="standPickerAppend('J')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">J</button>
                <button class="picker-btn" onclick="standPickerAppend('K')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">K</button>
                <button class="picker-btn" onclick="standPickerAppend('L')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">L</button>
                <button class="picker-btn" onclick="standPickerAppend('M')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">M</button>
                <button class="picker-btn" onclick="standPickerAppend('N')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">N</button>
            </div>
            <!-- Letters N-Z -->
            <div class="picker-buttons" style="grid-template-columns: repeat(7, 1fr); gap: 3px; margin-bottom: 8px;">
                <button class="picker-btn" onclick="standPickerAppend('O')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">O</button>
                <button class="picker-btn" onclick="standPickerAppend('P')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">P</button>
                <button class="picker-btn" onclick="standPickerAppend('Q')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">Q</button>
                <button class="picker-btn" onclick="standPickerAppend('R')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">R</button>
                <button class="picker-btn" onclick="standPickerAppend('S')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">S</button>
                <button class="picker-btn" onclick="standPickerAppend('T')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">T</button>
                <button class="picker-btn" onclick="standPickerAppend('U')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">U</button>
                <button class="picker-btn" onclick="standPickerAppend('V')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">V</button>
                <button class="picker-btn" onclick="standPickerAppend('W')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">W</button>
                <button class="picker-btn" onclick="standPickerAppend('X')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">X</button>
                <button class="picker-btn" onclick="standPickerAppend('Y')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">Y</button>
                <button class="picker-btn" onclick="standPickerAppend('Z')" style="min-width: 0; padding: 8px 0; background: rgba(255,130,0,0.3);">Z</button>
                <button class="picker-btn clear" onclick="standPickerClear()" style="min-width: 0; padding: 8px 0;">C</button>
                <button class="picker-btn" onclick="standPickerBackspace()" style="min-width: 0; padding: 8px 0;">â†</button>
            </div>
            <!-- Numbers -->
            <div class="picker-buttons" style="grid-template-columns: repeat(5, 1fr); gap: 4px;">
                <button class="picker-btn" onclick="standPickerAppend('1')">1</button>
                <button class="picker-btn" onclick="standPickerAppend('2')">2</button>
                <button class="picker-btn" onclick="standPickerAppend('3')">3</button>
                <button class="picker-btn" onclick="standPickerAppend('4')">4</button>
                <button class="picker-btn" onclick="standPickerAppend('5')">5</button>
                <button class="picker-btn" onclick="standPickerAppend('6')">6</button>
                <button class="picker-btn" onclick="standPickerAppend('7')">7</button>
                <button class="picker-btn" onclick="standPickerAppend('8')">8</button>
                <button class="picker-btn" onclick="standPickerAppend('9')">9</button>
                <button class="picker-btn" onclick="standPickerAppend('0')">0</button>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeStandPicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmStandPicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal (validates HHMM format) -->
    <div class="modal-overlay" id="time-picker-modal">
        <div class="number-picker" style="max-width: 300px;">
            <div class="picker-title" id="time-picker-title">Enter Time</div>
            <div class="picker-display">
                <span class="picker-value" id="time-picker-value" style="font-size: 2.2rem; letter-spacing: 4px;">----</span>
            </div>
            <div class="picker-buttons" id="time-picker-digits" style="grid-template-columns: repeat(5, 1fr); gap: 6px;">
                <!-- Digits will be dynamically generated -->
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeTimePicker()">Cancel</button>
                <button class="picker-confirm" onclick="confirmTimePicker()">OK</button>
            </div>
        </div>
    </div>

    <!-- Qibla Settings Modal -->
    <div class="modal-overlay" id="qibla-modal">
        <div class="number-picker" style="max-width: 350px;">
            <div class="picker-title">Qibla Direction</div>
            <div class="qibla-modal-content">
                <div class="qibla-source-toggle">
                    <button class="qibla-source-btn active" id="qibla-gps-btn" onclick="setQiblaSource('gps')">GPS</button>
                    <button class="qibla-source-btn" id="qibla-manual-btn" onclick="setQiblaSource('manual')">Manual</button>
                </div>

                <div id="qibla-gps-section">
                    <div class="qibla-gps-status disconnected" id="qibla-gps-status">
                        <div style="font-size: 1.2rem; margin-bottom: 5px;">GPS Status</div>
                        <div id="qibla-gps-status-text">Connecting...</div>
                        <div id="qibla-gps-position" style="margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem;"></div>
                    </div>
                </div>

                <div id="qibla-manual-section" style="display: none;">
                    <div class="input-grid-2">
                        <div class="input-group">
                            <label class="input-label">Latitude</label>
                            <input type="text" class="fdp-input" id="qibla-lat" placeholder="e.g. 25.2532" style="text-align: center;">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Longitude</label>
                            <input type="text" class="fdp-input" id="qibla-lon" placeholder="e.g. 55.3657" style="text-align: center;">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <label class="input-label">Aircraft Heading (Â°)</label>
                        <input type="number" class="fdp-input" id="qibla-heading" placeholder="e.g. 090" min="0" max="360" style="text-align: center;">
                    </div>
                    <button class="preset-btn" onclick="calculateQiblaFromManual()" style="margin-top: 10px; width: 100%;">Calculate Qibla</button>
                </div>

                <div class="section" style="margin-top: 10px; padding: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #888;">Qibla Bearing (True)</div>
                        <div id="qibla-bearing-result" style="font-size: 1.5rem; font-family: 'Courier New', monospace; color: #00d4ff;">---Â°</div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <div style="font-size: 0.75rem; color: #888;">Relative to Heading</div>
                        <div id="qibla-relative-result" style="font-size: 2rem; font-family: 'Courier New', monospace; color: #00ff88; font-weight: bold;">---Â°</div>
                        <div id="qibla-direction-text" style="font-size: 0.85rem; color: #888;"></div>
                    </div>
                </div>
            </div>
            <div class="picker-actions">
                <button class="picker-cancel" onclick="closeQiblaModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============ GLOBAL VARIABLES ============
        var currentSectorCount = 1;
        var fleetData = null;
        var airportDB = null;  // Global airport database

        // Load airport database
        function loadAirportDB() {
            var path = window.location.pathname;
            if (path === '/dashboard') path = '/dashboard/';
            path = path.replace(/index\.html$/, '');
            if (!path.endsWith('/')) path += '/';
            var url = path + 'airports.json';
            fetch(url)
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(data) {
                    airportDB = data;
                    console.log('Loaded ' + Object.keys(data).length + ' airports');
                })
                .catch(function(err) { console.error('Failed to load airport database:', err.message || err); });
        }
        loadAirportDB(); // Load immediately

        // Airport lookup functions
        function getAirport(icao) {
            if (!airportDB || !icao) return null;
            return airportDB[icao.toUpperCase()] || null;
        }

        function getAirportByIATA(iata) {
            if (!airportDB || !iata) return null;
            iata = iata.toUpperCase();
            for (var icao in airportDB) {
                if (airportDB[icao].i === iata) {
                    return { icao: icao, ...airportDB[icao] };
                }
            }
            return null;
        }

        function getAirportName(icao) {
            var apt = getAirport(icao);
            return apt ? apt.n : icao;
        }

        function getAirportCity(icao) {
            var apt = getAirport(icao);
            return apt ? (apt.m || apt.n) : icao;
        }

        function getAirportCoords(icao) {
            var apt = getAirport(icao);
            return apt ? apt.c : null;
        }

        // Load fleet data immediately on page load
        function loadFleetData() {
            // Build absolute URL - ensure we use /dashboard/ path
            var path = window.location.pathname;
            // If path is /dashboard (no trailing slash), add it
            if (path === '/dashboard') path = '/dashboard/';
            // If path ends with index.html, remove it
            path = path.replace(/index\.html$/, '');
            // Ensure trailing slash
            if (!path.endsWith('/')) path += '/';
            var url = path + 'fleet.json';
            fetch(url)
                .then(function(response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function(data) {
                    fleetData = data;
                    // Re-apply tail number now that fleet data is loaded
                    var savedTail = document.getElementById('sched-tail').value;
                    if (savedTail && typeof updateAircraftFromTail === 'function') {
                        updateAircraftFromTail(savedTail);
                        // Restore saved config from localStorage
                        var savedSchedule = localStorage.getItem('flightSchedule');
                        if (savedSchedule) {
                            try {
                                var schedule = JSON.parse(savedSchedule);
                                if (schedule.config) {
                                    document.getElementById('sched-config').value = schedule.config;
                                    selectedConfig = schedule.config;
                                }
                            } catch (e) {}
                        }
                    }
                })
                .catch(function(err) { console.error('Failed to load fleet data:', err.message || err); });
        }
        loadFleetData(); // Call immediately

        // Standard pax weights
        var LMC_PAX_WEIGHTS = { male: 88, female: 70, child: 35 };

        // LMC correction table by aircraft type and config (from OM-B Section 6)
        // IU values: negative = forward CG shift, positive = aft CG shift
        var lmcCorrectionTable = {
            'B738': {
                '189Y': {
                    'OA': { desc: 'Rows 1-5', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (742kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2440kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3157kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (474kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '12J162Y': {
                    'OA': { desc: 'Rows 1-3', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3157kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (474kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '174Y': {
                    'OA': { desc: 'Rows 1-5', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3157kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (474kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '10J156Y': {
                    'OA': { desc: 'Rows 1-3', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-26', onload: 0.3, offload: -0.3, unit: 'PAX' },
                    'OD': { desc: 'Rows 27-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3157kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (474kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '166Y': {
                    'OA': { desc: 'Rows 1-5', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3157kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (474kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                }
            },
            'B38M': {
                '10J156Y': {
                    'OA': { desc: 'Rows 1-3', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-26', onload: 0.3, offload: -0.3, unit: 'PAX' },
                    'OD': { desc: 'Rows 27-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3631kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (473kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '166Y': {
                    'OA': { desc: 'Rows 1-5', onload: -0.9, offload: 0.9, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.3, offload: -0.3, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3631kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (473kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '12J162Y': {
                    'OA': { desc: 'Rows 1-3', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 1.0, offload: -1.0, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3560kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (448kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '174Y': {
                    'OA': { desc: 'Rows 1-5', onload: -0.9, offload: 0.9, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-32', onload: 1.0, offload: -1.0, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3560kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (448kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                },
                '186Y': {
                    'OA': { desc: 'Rows 1-5', onload: -0.9, offload: 0.9, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-16', onload: -0.4, offload: 0.4, unit: 'PAX' },
                    'OC': { desc: 'Rows 17-26', onload: 0.3, offload: -0.3, unit: 'PAX' },
                    'OD': { desc: 'Rows 27-32', onload: 0.9, offload: -0.9, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (809kg)', onload: -1.2, offload: 1.2, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2670kg)', onload: -0.7, offload: 0.7, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (3560kg)', onload: 0.6, offload: -0.6, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (448kg)', onload: 1.2, offload: -1.2, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                }
            },
            'B39M': {
                'ALL': {
                    'OA': { desc: 'Rows 1-5', onload: -1.0, offload: 1.0, unit: 'PAX' },
                    'OB': { desc: 'Rows 6-17', onload: -0.3, offload: 0.3, unit: 'PAX' },
                    'OC': { desc: 'Rows 18-27', onload: 0.4, offload: -0.4, unit: 'PAX' },
                    'OD': { desc: 'Rows 28-33', onload: 1.0, offload: -1.0, unit: 'PAX' },
                    'CPT1': { desc: 'Fwd Hold (675kg)', onload: -1.4, offload: 1.4, unit: '100kg' },
                    'CPT2': { desc: 'Fwd Hold (2884kg)', onload: -0.8, offload: 0.8, unit: '100kg' },
                    'CPT3': { desc: 'Aft Hold (4715kg)', onload: 0.7, offload: -0.7, unit: '100kg' },
                    'CPT4': { desc: 'Bulk (370kg)', onload: 1.3, offload: -1.3, unit: '100kg' },
                    'WING': { desc: 'Wing Tank', onload: 1.0, offload: -1.0, unit: '300kg' },
                    'WING+CTR': { desc: 'Wing+Center', onload: -0.5, offload: 0.5, unit: '350kg' }
                }
            }
        };

        // Parse dual config from fleet.json
        // "10J156Y/166Y" -> ["10J156Y", "166Y"] (10 business+156 eco OR 166 all eco)
        // "12J162Y/174Y" -> ["12J162Y", "174Y"] (12 business+162 eco OR 174 all eco)
        function parseFleetConfig(config) {
            if (!config) return [];
            // Handle dual configs like "10J156Y/166Y" or "12J162Y/174Y"
            var match = config.match(/^(\d+J)(\d+Y)\/(\d+Y)$/);
            if (match) {
                return [match[1] + match[2], match[3]]; // e.g., ["10J156Y", "166Y"]
            }
            // Handle single configs like "186Y" or "189Y"
            return [config];
        }

        // Get available configs for an aircraft type
        function getAvailableConfigs(aircraftType) {
            var typeTable = lmcCorrectionTable[aircraftType];
            if (!typeTable) return [];
            return Object.keys(typeTable);
        }

        // ============ TAB SWITCHING ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Auto-sync FDP from schedule when opening FDP tab
            if (tab === 'fdp') {
                syncFromSchedule();
            }

            // Update all switchers when opening SUN tab
            if (tab === 'sun') {
                updateSunSectorSwitcher();
                updateArrCondSwitcher();
                updateNightSectorSwitcher();
            }

            // Update route switcher when opening MAP tab
            if (tab === 'map') {
                updateMapRouteSwitcher();
            }

            // Update NAV tab switchers
            if (tab === 'nav') {
                updateDistSwitcher();
                updateAptInfoSwitcher();
            }

            // Update REF tab switcher
            if (tab === 'ref') {
                updateRefSwitcher();
            }
        }

        // ============ NUMBER PICKER ============
        var pickerCallback = null;
        var pickerValue = '';
        var pickerMaxLength = 6;
        var pickerFormatCommas = false;
        var pickerFirstInput = true; // Track if this is first input since opening

        function openPicker(title, unit, currentValue, maxLength, formatCommas, callback) {
            pickerCallback = callback;
            pickerValue = currentValue.toString().replace(/,/g, '');
            pickerMaxLength = maxLength;
            pickerFormatCommas = formatCommas;
            pickerFirstInput = true; // Reset on open
            document.getElementById('picker-title').textContent = title;
            document.getElementById('picker-unit').textContent = unit || '';
            updatePickerDisplay();
            document.getElementById('number-picker-modal').classList.add('active');
        }

        function updatePickerDisplay() {
            let display = pickerValue || '0';
            if (pickerFormatCommas && display !== '0') {
                display = parseInt(display, 10).toLocaleString();
            }
            document.getElementById('picker-value').textContent = display;
        }

        function closePicker() {
            document.getElementById('number-picker-modal').classList.remove('active');
            pickerCallback = null;
        }

        function pickerAppend(digit) {
            // If this is first input and there's existing value, clear it first
            if (pickerFirstInput && pickerValue.length > 0) {
                pickerValue = '';
            }
            pickerFirstInput = false;

            // Prevent multiple decimal points
            if (digit === '.' && pickerValue.includes('.')) {
                return;
            }

            // Handle multi-digit append
            const newLength = pickerValue.length + digit.length;
            if (newLength <= pickerMaxLength) {
                pickerValue += digit;
                updatePickerDisplay();
            } else if (pickerValue.length < pickerMaxLength) {
                // Append as many digits as possible
                const remaining = pickerMaxLength - pickerValue.length;
                pickerValue += digit.substring(0, remaining);
                updatePickerDisplay();
            }
        }

        function pickerClear() {
            pickerValue = '';
            pickerFirstInput = false;
            updatePickerDisplay();
        }

        function pickerBackspace() {
            pickerFirstInput = false;
            pickerValue = pickerValue.slice(0, -1);
            updatePickerDisplay();
        }

        function confirmPicker() {
            try {
                if (pickerCallback) {
                    pickerCallback(pickerValue);
                }
            } catch (e) {
                console.error('Picker callback error:', e);
            }
            closePicker();
        }

        // ============ DURATION PICKER (smart h/m entry) ============
        var durationValue = '';
        var durationCallback = null;
        var durationFieldId = '';
        var durationFirstInput = true;

        function openDurationPicker(fieldId, title, callback) {
            durationFieldId = fieldId;
            durationCallback = callback;
            durationFirstInput = true;

            // Get current value and convert back to display format
            var currentMins = parseInt(document.getElementById(fieldId).value) || 0;
            if (currentMins > 0) {
                var h = Math.floor(currentMins / 60);
                var m = currentMins % 60;
                if (h > 0 && m > 0) {
                    durationValue = h + 'h' + m + 'm';
                } else if (h > 0) {
                    durationValue = h + 'h';
                } else {
                    durationValue = m + 'm';
                }
            } else {
                durationValue = '';
            }

            document.getElementById('duration-picker-title').textContent = title || 'Enter Time';
            updateDurationDisplay();
            document.getElementById('duration-picker-modal').classList.add('active');
        }

        function parseDurationToMinutes(str) {
            if (!str) return 0;
            str = str.toLowerCase().trim();

            // Try patterns: "1h30m", "1h30", "1h", "30m", "90"
            var hours = 0, mins = 0;

            // Pattern: XhYm or XhY
            var match = str.match(/^(\d+)h(\d+)m?$/);
            if (match) {
                hours = parseInt(match[1]) || 0;
                mins = parseInt(match[2]) || 0;
                return hours * 60 + mins;
            }

            // Pattern: Xh (hours only)
            match = str.match(/^(\d+)h$/);
            if (match) {
                hours = parseInt(match[1]) || 0;
                return hours * 60;
            }

            // Pattern: Xm (minutes only)
            match = str.match(/^(\d+)m$/);
            if (match) {
                mins = parseInt(match[1]) || 0;
                return mins;
            }

            // Plain number (assume minutes)
            if (/^\d+$/.test(str)) {
                return parseInt(str) || 0;
            }

            return 0;
        }

        function formatDurationDisplay(str) {
            var mins = parseDurationToMinutes(str);
            if (mins === 0) return '= 0 minutes';
            var h = Math.floor(mins / 60);
            var m = mins % 60;
            if (h > 0 && m > 0) {
                return '= ' + h + 'h ' + m + 'm (' + mins + ' min)';
            } else if (h > 0) {
                return '= ' + h + ' hour' + (h > 1 ? 's' : '') + ' (' + mins + ' min)';
            } else {
                return '= ' + m + ' minutes';
            }
        }

        function updateDurationDisplay() {
            var display = durationValue || '0';
            document.getElementById('duration-picker-value').textContent = display;
            document.getElementById('duration-picker-mins').textContent = formatDurationDisplay(durationValue);
        }

        function durationAppend(char) {
            if (durationFirstInput && durationValue.length > 0 && /\d/.test(char)) {
                durationValue = '';
            }
            durationFirstInput = false;

            // Prevent multiple h or m
            if (char === 'h' && durationValue.includes('h')) return;
            if (char === 'm' && durationValue.includes('m')) return;

            // Prevent h after m
            if (char === 'h' && durationValue.includes('m')) return;

            // Max reasonable length
            if (durationValue.length < 8) {
                durationValue += char;
                updateDurationDisplay();
            }
        }

        function durationClear() {
            durationValue = '';
            durationFirstInput = false;
            updateDurationDisplay();
        }

        function durationBackspace() {
            durationValue = durationValue.slice(0, -1);
            durationFirstInput = false;
            updateDurationDisplay();
        }

        function closeDurationPicker() {
            document.getElementById('duration-picker-modal').classList.remove('active');
            durationCallback = null;
        }

        function confirmDurationPicker() {
            var mins = parseDurationToMinutes(durationValue);
            if (durationCallback) {
                durationCallback(mins);
            }
            closeDurationPicker();
        }

        // ============ TIME PICKER (HHMM with validation) ============
        var timePickerValue = '';
        var timePickerFieldId = '';
        var timePickerCallback = null;

        function openTimePicker(fieldId) {
            timePickerFieldId = fieldId;
            const currentVal = document.getElementById(fieldId).value || '';
            timePickerValue = currentVal;

            // Set up callback for when confirmed
            timePickerCallback = function(val) {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? val.padStart(4, '0') : (fieldId === 'utc-manual' ? 'AUTO' : '----');
                    btn.classList.toggle('placeholder', !val);
                }
                // Handle sector OOOI (s1-out, s1-off, s2-on, etc.)
                const sectorMatch = fieldId.match(/^s(\d)-(out|off|on|in)$/);
                if (sectorMatch) {
                    calculateSectorTimes(parseInt(sectorMatch[1]));
                    const nextSector = parseInt(sectorMatch[1]) + 1;
                    if (nextSector <= currentSectorCount) {
                        calculateSectorTimes(nextSector);
                    }
                    saveSchedule();
                }
                else if (fieldId.match(/^s(\d)-(std|sta)$/)) {
                    const schedMatch = fieldId.match(/^s(\d)-(std|sta)$/);
                    const sectorNum = parseInt(schedMatch[1]);
                    const fieldType = schedMatch[2];
                    calculateSectorTimes(sectorNum);
                    // Dynamic update: If STA changed, update subsequent sectors
                    if (fieldType === 'sta') {
                        updateAllSubsequentSectors(sectorNum);
                    } else {
                        updateTurnaroundTimes();
                        saveSchedule();
                    }
                }
                else if (fieldId.startsWith('oooi-')) calculateOOOI();
                else if (fieldId === 'eta-time') { etaManualStartTime = null; saveETA(); calculateETA(); }
                else if (fieldId === 'utc-manual') { etaManualStartTime = val ? Date.now() : null; saveETA(); calculateETA(); }
                else if (fieldId === 'fdp-report' || fieldId === 'fdp-actual-report') calculateFDP();
                else if (fieldId === 'quick-report') calculateQuickDuty();
                else if (fieldId.startsWith('layover-')) calculateLayover();
                else if (fieldId.startsWith('time-tz-')) calculateTimeTabTimezones();
            };

            updateTimePickerDisplay();
            updateTimePickerDigits();
            document.getElementById('time-picker-modal').classList.add('active');
        }

        function updateTimePickerDisplay() {
            var display = timePickerValue.padEnd(4, '-');
            // Format as HH:MM style display
            var formatted = display.substring(0, 2) + display.substring(2, 4);
            document.getElementById('time-picker-value').textContent = formatted;
        }

        function getValidDigitsForPosition(pos) {
            // pos 0: First hour digit - 0, 1, 2
            // pos 1: Second hour digit - depends on first digit
            // pos 2: First minute digit - 0-5
            // pos 3: Second minute digit - 0-9

            if (pos === 0) {
                return [0, 1, 2];
            } else if (pos === 1) {
                var firstDigit = parseInt(timePickerValue[0]) || 0;
                if (firstDigit === 2) {
                    return [0, 1, 2, 3]; // 20-23
                } else {
                    return [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; // 00-19
                }
            } else if (pos === 2) {
                return [0, 1, 2, 3, 4, 5]; // 00-59 minutes
            } else if (pos === 3) {
                return [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            }
            return [];
        }

        function updateTimePickerDigits() {
            var grid = document.getElementById('time-picker-digits');
            var currentPos = timePickerValue.length;
            var validDigits = getValidDigitsForPosition(currentPos);
            var html = '';

            for (var d = 0; d <= 9; d++) {
                var isValid = validDigits.includes(d);
                if (isValid) {
                    html += '<button class="picker-btn" onclick="timePickerAppend(\'' + d + '\')" style="min-width: 0; padding: 15px 0; font-size: 1.3rem;">' + d + '</button>';
                } else {
                    html += '<button class="picker-btn" style="min-width: 0; padding: 15px 0; font-size: 1.3rem; opacity: 0.15; pointer-events: none;"> </button>';
                }
            }

            // Add Clear and Backspace buttons
            html += '<button class="picker-btn clear" onclick="timePickerClear()" style="min-width: 0; padding: 15px 0;">C</button>';
            html += '<button class="picker-btn" onclick="timePickerBackspace()" style="min-width: 0; padding: 15px 0;">â†</button>';

            // Add NOW button for quick current time entry
            html += '<button class="picker-btn" onclick="timePickerNow()" style="min-width: 0; padding: 15px 0; font-size: 0.8rem; background: rgba(0,212,255,0.3); grid-column: span 3;">NOW</button>';

            grid.innerHTML = html;
        }

        function timePickerAppend(digit) {
            if (timePickerValue.length < 4) {
                timePickerValue += digit;
                updateTimePickerDisplay();
                updateTimePickerDigits();

                // Auto-confirm when 4 digits entered
                if (timePickerValue.length === 4) {
                    confirmTimePicker();
                }
            }
        }

        function timePickerBackspace() {
            timePickerValue = timePickerValue.slice(0, -1);
            updateTimePickerDisplay();
            updateTimePickerDigits();
        }

        function timePickerClear() {
            timePickerValue = '';
            updateTimePickerDisplay();
            updateTimePickerDigits();
        }

        function timePickerNow() {
            var now = new Date();
            var h = String(now.getUTCHours()).padStart(2, '0');
            var m = String(now.getUTCMinutes()).padStart(2, '0');
            timePickerValue = h + m;
            updateTimePickerDisplay();
            confirmTimePicker();
        }

        function closeTimePicker() {
            document.getElementById('time-picker-modal').classList.remove('active');
        }

        function confirmTimePicker() {
            if (timePickerCallback && timePickerValue.length === 4) {
                timePickerCallback(timePickerValue);
            } else if (timePickerCallback && timePickerValue.length === 0) {
                timePickerCallback('');
            }
            closeTimePicker();
        }

        // Weight picker (with commas)
        function openWeightPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            // Use decimal format for angle fields
            const isAngleField = fieldId === 'gp-angle' || fieldId === 'qrod-angle';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, !isAngleField, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    // Preserve decimals for angle fields
                    if (isAngleField) {
                        btn.textContent = val ? parseFloat(val).toFixed(1) : '3.0';
                    } else {
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    }
                    btn.classList.toggle('placeholder', !val);
                }
                if (fieldId.startsWith('calc-')) {
                    calculateTOW();
                    calculateMLF();
                }
                else if (fieldId === 'opt-acc' || fieldId === 'airfield-elev') calculateACC();
                else if (fieldId.startsWith('xwind-')) calculateCrosswind();
                else if (fieldId.startsWith('hold-')) calculateHoldEntry();
                else if (fieldId === 'isa-alt') calculateISA();
                else if (fieldId.startsWith('sdt1-')) calculateSDT1();
                else if (fieldId.startsWith('sdt2-')) calculateSDT2();
                else if (fieldId.startsWith('sdt3-')) calculateSDT3();
                else if (fieldId.startsWith('wx-')) calculateWeather();
                else if (fieldId.startsWith('gp-')) calculateGlidePath();
                else if (fieldId.startsWith('climb-')) calculateClimbGradient();
                else if (fieldId.startsWith('qrod-')) calculateQuickRod();
                else if (fieldId.startsWith('catchup-')) {
                    // Auto-update catch-up display when values change
                }
                else if (fieldId.startsWith('lmc-')) {
                    lmcCalculate();
                }
            });
        }

        // Tonnes picker for VREF weight entry (format: xx.x)
        function openTonnesPicker(fieldId, title) {
            const currentVal = document.getElementById(fieldId).value || '';
            // Convert stored kg to tonnes for display
            const currentTonnes = currentVal ? (parseInt(currentVal) / 1000).toFixed(1) : '';

            openPicker(title || 'Enter Weight', 'T', currentTonnes, 5, false, (val) => {
                // val is now like "61.1" directly
                var tonnes = parseFloat(val) || 0;

                // Convert to kg and store
                var kg = Math.round(tonnes * 1000);
                document.getElementById(fieldId).value = kg;

                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = tonnes > 0 ? tonnes.toFixed(1) : '---';
                    btn.classList.toggle('placeholder', tonnes === 0);
                }

                if (fieldId === 'vref-weight') {
                    calculateVref();
                }
            });
        }

        // ============ AIRCRAFT & WEIGHT LIMITS ============
        const aircraftLimits = {
            'B738': {
                name: 'B737-800',
                mtw: 79242,
                mtow: 79015,
                mlw: 66360,
                mzfw: 62731,
                sfp: 'SFP1'
            },
            'B38M': {
                name: 'B737-8',
                mtw: 82417,
                mtow: 82190,
                mlw: 69308,
                mzfw: 65952,
                sfp: 'SFP1'
            },
            'B39M': {
                name: 'B737-9',
                mtw: 88541,
                mtow: 88314,
                mlw: 74343,
                mzfw: 70987,
                sfp: 'SFP2'
            }
        };
        var selectedAircraft = 'B738';

        function selectAircraft(type) {
            selectedAircraft = type;
            // Update all aircraft selector buttons
            document.querySelectorAll('.aircraft-btn').forEach(btn => btn.classList.remove('active'));
            var towBtn = document.getElementById('tow-ac-' + type.toLowerCase());
            if (towBtn) towBtn.classList.add('active');

            // Update limit displays
            updateLimitDisplays();

            // Recalculate
            calculateTOW();
            calculateMLF();

            // Check if matches scheduled aircraft
            checkAircraftMismatch();
        }

        function checkAircraftMismatch() {
            var schedAircraft = document.getElementById('sched-aircraft').value;
            var warningsEl = document.getElementById('tow-warnings');
            if (!warningsEl) return;

            if (schedAircraft && schedAircraft !== selectedAircraft) {
                warningsEl.innerHTML = '<div style="background:rgba(255,150,0,0.2);border:1px solid #ff9600;border-radius:8px;padding:10px;color:#ffaa00;text-align:center;font-size:0.85rem;">âš ï¸ Aircraft mismatch: Schedule shows <strong>' + schedAircraft + '</strong> but TOW calc set to <strong>' + selectedAircraft + '</strong></div>';
            } else {
                warningsEl.innerHTML = '';
            }
        }

        function updateLimitDisplays() {
            const limits = aircraftLimits[selectedAircraft];
            document.getElementById('mtw-limit').textContent = 'MTW: ' + limits.mtw.toLocaleString();
            document.getElementById('mtow-limit').textContent = 'MTOW: ' + limits.mtow.toLocaleString();
            document.getElementById('mlw-limit').textContent = 'MLW: ' + limits.mlw.toLocaleString();
            document.getElementById('mzfw-limit').textContent = 'MZFW: ' + limits.mzfw.toLocaleString();
        }

        function calculateMLF() {
            const zfwEl = document.getElementById('calc-zfw');
            const resultEl = document.getElementById('mlf-result');
            if (!zfwEl || !resultEl) return;

            const zfw = parseInt(zfwEl.value, 10) || 0;
            const mlw = aircraftLimits[selectedAircraft].mlw;

            if (zfw === 0) {
                resultEl.textContent = '---';
            } else {
                const maxFuel = mlw - zfw;
                resultEl.textContent = maxFuel.toLocaleString() + ' kg';
            }
        }

        // ============ FUEL CALCULATOR ============
        function openFuelPicker(fieldId, title, unit) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title || 'Enter Value', unit || '', currentVal, 6, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                    btn.classList.toggle('placeholder', !val);
                }
                calculateFuel();
            });
        }

        function openSGPicker() {
            const currentVal = document.getElementById('fuel-sg').value || '800';
            openPicker('SG (e.g. 800 = 0.800)', '', currentVal, 3, false, (val) => {
                document.getElementById('fuel-sg').value = val;
                const btn = document.getElementById('fuel-sg-btn');
                if (btn) {
                    const sg = parseInt(val, 10) || 800;
                    btn.textContent = '0.' + sg.toString().padStart(3, '0');
                }
                calculateFuel();
            });
        }

        function openAdjustmentPicker() {
            const currentVal = document.getElementById('fuel-adj').value || '';
            const absVal = currentVal.replace('-', '');
            openPicker('Adjustment (+/-)', 'kg', absVal, 5, true, (val) => {
                const adj = parseInt(val, 10) || 0;
                if (adj !== 0) {
                    // Default to positive, can toggle with +/- button
                    document.getElementById('fuel-adj').value = val;
                    const btn = document.getElementById('fuel-adj-btn');
                    if (btn) {
                        btn.textContent = '+' + adj.toLocaleString();
                    }
                } else {
                    document.getElementById('fuel-adj').value = '';
                    document.getElementById('fuel-adj-btn').textContent = '0';
                }
                calculateFuel();
            });
        }

        function toggleAdjustmentSign() {
            const val = document.getElementById('fuel-adj').value;
            if (!val) return;
            if (val.startsWith('-')) {
                document.getElementById('fuel-adj').value = val.substring(1);
                document.getElementById('fuel-adj-btn').textContent = '+' + parseInt(val.substring(1), 10).toLocaleString();
            } else {
                document.getElementById('fuel-adj').value = '-' + val;
                document.getElementById('fuel-adj-btn').textContent = '-' + parseInt(val, 10).toLocaleString();
            }
            calculateFuel();
        }

        function loadFuel() {
            const saved = localStorage.getItem('flightFuel');
            if (saved) {
                try {
                    const fuel = JSON.parse(saved);
                    // Restore values
                    if (fuel.req) {
                        document.getElementById('fuel-req').value = fuel.req;
                        document.getElementById('fuel-req-btn').textContent = parseInt(fuel.req, 10).toLocaleString();
                        document.getElementById('fuel-req-btn').classList.remove('placeholder');
                    }
                    if (fuel.pre) {
                        document.getElementById('fuel-pre').value = fuel.pre;
                        document.getElementById('fuel-pre-btn').textContent = parseInt(fuel.pre, 10).toLocaleString();
                        document.getElementById('fuel-pre-btn').classList.remove('placeholder');
                    }
                    if (fuel.sg) {
                        document.getElementById('fuel-sg').value = fuel.sg;
                        document.getElementById('fuel-sg-btn').textContent = '0.' + fuel.sg.toString().padStart(3, '0');
                    }
                    if (fuel.actual) {
                        document.getElementById('fuel-actual').value = fuel.actual;
                        document.getElementById('fuel-actual-btn').textContent = parseInt(fuel.actual, 10).toLocaleString();
                        document.getElementById('fuel-actual-btn').classList.remove('placeholder');
                    }
                    if (fuel.left) {
                        document.getElementById('tank-left').value = fuel.left;
                        document.getElementById('tank-left-btn').textContent = parseInt(fuel.left, 10).toLocaleString();
                    }
                    if (fuel.right) {
                        document.getElementById('tank-right').value = fuel.right;
                        document.getElementById('tank-right-btn').textContent = parseInt(fuel.right, 10).toLocaleString();
                    }
                    if (fuel.adj) {
                        document.getElementById('fuel-adj').value = fuel.adj;
                        const adj = parseInt(fuel.adj, 10);
                        document.getElementById('fuel-adj-btn').textContent = (adj >= 0 ? '+' : '') + adj.toLocaleString();
                        document.getElementById('fuel-adj-btn').onclick = function() { toggleAdjustmentSign(); };
                    }
                    calculateFuel();
                } catch (e) {}
            }
        }

        function saveFuel() {
            const fuel = {
                req: document.getElementById('fuel-req').value,
                pre: document.getElementById('fuel-pre').value,
                sg: document.getElementById('fuel-sg').value,
                actual: document.getElementById('fuel-actual').value,
                left: document.getElementById('tank-left').value,
                right: document.getElementById('tank-right').value,
                adj: document.getElementById('fuel-adj').value
            };
            localStorage.setItem('flightFuel', JSON.stringify(fuel));
        }

        function setFullTanks() {
            // B737 max fuel: 20,200 kg (wing tanks 3,700 per side = 7,400 + center tank 12,800)
            document.getElementById('fuel-req').value = '20200';
            document.getElementById('fuel-req-btn').textContent = '20,200';
            document.getElementById('fuel-req-btn').classList.remove('placeholder');
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            calculateFuel();
            saveFuel();
        }

        function resetTankSplit() {
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            calculateFuel();
            saveFuel();
        }

        function calculateFuel() {
            const fuelReq = parseInt(document.getElementById('fuel-req').value, 10) || 0;
            const preUplift = parseInt(document.getElementById('fuel-pre').value, 10) || 0;
            const sgVal = parseInt(document.getElementById('fuel-sg').value, 10) || 800;
            const sg = sgVal / 1000; // Convert 800 to 0.800
            const actualUplift = parseInt(document.getElementById('fuel-actual').value, 10) || 0;
            const tankLeft = parseInt(document.getElementById('tank-left').value, 10) || 3700;
            const tankRight = parseInt(document.getElementById('tank-right').value, 10) || 3700;
            const adjustment = parseInt(document.getElementById('fuel-adj').value, 10) || 0;

            // Tank split - center tank calculation
            const centerTank = fuelReq - tankLeft - tankRight;
            document.getElementById('tank-center').textContent = fuelReq > 0 ?
                (centerTank >= 0 ? centerTank.toLocaleString() + ' kg' : 'Wings exceed total!') : '---';
            if (centerTank < 0 && fuelReq > 0) {
                document.getElementById('tank-center').className = 'fdp-result-value red';
            } else {
                document.getElementById('tank-center').className = 'fdp-result-value green';
            }

            // Fuel Summary
            document.getElementById('summary-req').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';
            document.getElementById('summary-pre').textContent = preUplift > 0 ? preUplift.toLocaleString() + ' kg' : '--- kg';

            const upliftReq = fuelReq - preUplift;
            document.getElementById('summary-uplift-req').textContent = fuelReq > 0 ? upliftReq.toLocaleString() + ' kg' : '--- kg';

            // Departure fuel
            document.getElementById('summary-dep').textContent = fuelReq > 0 ? fuelReq.toLocaleString() + ' kg' : '--- kg';

            const finalDep = fuelReq + adjustment;
            if (fuelReq > 0) {
                document.getElementById('summary-final-dep').textContent = finalDep.toLocaleString() + ' kg';
            } else {
                document.getElementById('summary-final-dep').textContent = '--- kg';
            }

            // Uplift verification
            // Calculate uplift in litres: uplift kg / SG = litres
            const calcUpliftLitres = upliftReq > 0 && sg > 0 ? Math.round(upliftReq / sg) : 0;

            document.getElementById('calc-uplift').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';
            document.getElementById('verify-actual').textContent = actualUplift > 0 ? actualUplift.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-calc').textContent = calcUpliftLitres > 0 ? calcUpliftLitres.toLocaleString() + ' L' : '--- L';

            // 3% limits
            const lowLimit = Math.round(calcUpliftLitres * 0.97);
            const highLimit = Math.round(calcUpliftLitres * 1.03);
            document.getElementById('limit-low').textContent = calcUpliftLitres > 0 ? lowLimit.toLocaleString() + ' L' : '--- L';
            document.getElementById('limit-high').textContent = calcUpliftLitres > 0 ? highLimit.toLocaleString() + ' L' : '--- L';

            // Percentage difference
            if (calcUpliftLitres > 0 && actualUplift > 0) {
                const diff = ((actualUplift - calcUpliftLitres) / calcUpliftLitres) * 100;
                const diffEl = document.getElementById('uplift-diff');
                diffEl.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';

                // Color based on range
                if (Math.abs(diff) <= 3) {
                    diffEl.className = 'fdp-result-value green';
                } else if (Math.abs(diff) <= 5) {
                    diffEl.className = 'fdp-result-value yellow';
                } else {
                    diffEl.className = 'fdp-result-value red';
                }

                // Status message
                const statusEl = document.getElementById('uplift-status');
                if (actualUplift >= lowLimit && actualUplift <= highLimit) {
                    statusEl.innerHTML = '<div class="fdp-warning" style="background:rgba(0,200,80,0.2);border-color:rgba(0,200,80,0.5);color:#00ff88">Actual uplift within 3% tolerance</div>';
                } else {
                    statusEl.innerHTML = '<div class="fdp-danger">Actual uplift outside 3% tolerance - verify figures</div>';
                }
            } else {
                document.getElementById('uplift-diff').textContent = '--- %';
                document.getElementById('uplift-diff').className = 'fdp-result-value';
                document.getElementById('uplift-status').innerHTML = '';
            }

            // Autofill converter with actual uplift (if entered and converter is empty or matches previous value)
            if (actualUplift > 0) {
                var convLitres = parseInt(document.getElementById('conv-litres').value, 10) || 0;
                // Only autofill if converter is empty or was previously autofilled with same value
                if (convLitres === 0 || convLitres === window.lastAutofilledUplift) {
                    calculateConverter('litres', actualUplift);
                    window.lastAutofilledUplift = actualUplift;
                }
            }

            saveFuel();
        }

        // ============ FUEL UNIT CONVERTER ============
        // Constants: 1 US gallon = 3.78541 litres, Jet-A density ~0.800 kg/L = 1.764 lbs/L
        const LITRES_PER_GALLON = 3.78541;
        const LBS_PER_LITRE = 1.764; // at SG 0.800

        function openConverterPicker(unit) {
            const fieldId = 'conv-' + unit;
            const currentVal = document.getElementById(fieldId).value || '';
            const titles = {
                'litres': 'Enter Litres',
                'gallons': 'Enter US Gallons',
                'lbs': 'Enter Pounds'
            };
            const units = {
                'litres': 'L',
                'gallons': 'gal',
                'lbs': 'lbs'
            };
            openPicker(titles[unit], units[unit], currentVal, 7, true, (val) => {
                document.getElementById(fieldId).value = val;
                const btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                }
                calculateConverter(unit, parseInt(val, 10) || 0);
            });
        }

        function calculateConverter(sourceUnit, value) {
            let litres, gallons, lbs;

            if (sourceUnit === 'litres') {
                litres = value;
                gallons = Math.round(litres / LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'gallons') {
                gallons = value;
                litres = Math.round(gallons * LITRES_PER_GALLON);
                lbs = Math.round(litres * LBS_PER_LITRE);
            } else if (sourceUnit === 'lbs') {
                lbs = value;
                litres = Math.round(lbs / LBS_PER_LITRE);
                gallons = Math.round(litres / LITRES_PER_GALLON);
            }

            // Update all fields
            document.getElementById('conv-litres').value = litres || '';
            document.getElementById('conv-gallons').value = gallons || '';
            document.getElementById('conv-lbs').value = lbs || '';

            document.getElementById('conv-litres-btn').textContent = litres ? litres.toLocaleString() : '0';
            document.getElementById('conv-gallons-btn').textContent = gallons ? gallons.toLocaleString() : '0';
            document.getElementById('conv-lbs-btn').textContent = lbs ? lbs.toLocaleString() : '0';
        }

        // ============ LAYOVER CALCULATOR ============
        function getLayoverOffset() {
            return parseFloat(document.getElementById('layover-offset').value) || 0;
        }

        function layoverUtcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLayoverOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function subtractTime(timeStr, hoursToSubtract, minsToSubtract) {
            const time = parseTime(timeStr);
            if (!time) return null;
            let totalMins = time.hours * 60 + time.minutes - (hoursToSubtract * 60) - minsToSubtract;
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function calculateLayover() {
            const stdStr = document.getElementById('layover-std').value;
            const pickupStr = document.getElementById('layover-pickup').value || '0130';

            // Update button displays
            const stdBtn = document.getElementById('layover-std-btn');
            stdBtn.textContent = stdStr ? stdStr.padStart(4, '0') : '----';

            const pickupBtn = document.getElementById('layover-pickup-btn');
            pickupBtn.textContent = pickupStr.padStart(4, '0');

            const std = parseTime(stdStr);
            const pickup = parseTime(pickupStr);

            if (!std) {
                document.getElementById('layover-std-local').textContent = '--:--';
                document.getElementById('layover-std-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-hotel-local').textContent = '--:--';
                document.getElementById('layover-hotel-utc').textContent = 'UTC: --:--';
                document.getElementById('layover-wake-local').textContent = '--:--';
                document.getElementById('layover-wake-utc').textContent = 'UTC: --:--';
                return;
            }

            // STD display (Local prominent, UTC secondary)
            const stdFormatted = stdStr.padStart(4, '0');
            const stdUtcDisplay = stdFormatted.substring(0, 2) + ':' + stdFormatted.substring(2);
            document.getElementById('layover-std-local').textContent = layoverUtcToLocal(stdStr);
            document.getElementById('layover-std-utc').textContent = 'UTC: ' + stdUtcDisplay;

            // Hotel departure = STD - pickup time
            const pickupHours = pickup ? pickup.hours : 1;
            const pickupMins = pickup ? pickup.minutes : 30;
            const hotelUTC = subtractTime(stdStr, pickupHours, pickupMins);
            if (hotelUTC) {
                const hotelUtcDisplay = hotelUTC.substring(0, 2) + ':' + hotelUTC.substring(2);
                document.getElementById('layover-hotel-local').textContent = layoverUtcToLocal(hotelUTC);
                document.getElementById('layover-hotel-utc').textContent = 'UTC: ' + hotelUtcDisplay;

                // Wake up = Hotel departure - 1 hour
                const wakeUTC = subtractTime(hotelUTC, 1, 0);
                if (wakeUTC) {
                    const wakeUtcDisplay = wakeUTC.substring(0, 2) + ':' + wakeUTC.substring(2);
                    document.getElementById('layover-wake-local').textContent = layoverUtcToLocal(wakeUTC);
                    document.getElementById('layover-wake-utc').textContent = 'UTC: ' + wakeUtcDisplay;
                }
            }

            saveLayover();
        }

        function loadLayover() {
            const saved = localStorage.getItem('flightLayover');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.std) {
                        document.getElementById('layover-std').value = data.std;
                        document.getElementById('layover-std-btn').textContent = data.std.padStart(4, '0');
                    }
                    if (data.pickup) {
                        document.getElementById('layover-pickup').value = data.pickup;
                        document.getElementById('layover-pickup-btn').textContent = data.pickup.padStart(4, '0');
                    }
                    if (data.offset !== undefined) {
                        document.getElementById('layover-offset').value = data.offset;
                    }
                    calculateLayover();
                } catch (e) {}
            }
        }

        function saveLayover() {
            const data = {
                std: document.getElementById('layover-std').value,
                pickup: document.getElementById('layover-pickup').value,
                offset: document.getElementById('layover-offset').value
            };
            localStorage.setItem('flightLayover', JSON.stringify(data));
        }

        // ============ DEFAULT TIMERS ============
        const defaultTimers = [
            { name: 'APU', type: 'countdown', hours: 0, minutes: 11 },
            { name: 'APU Start', type: 'countdown', hours: 3, minutes: 0 },
            { name: 'Ctrl Rest', type: 'countdown', hours: 0, minutes: 30 },
            { name: 'Timer 4', type: 'stopwatch', hours: 0, minutes: 0 },
            { name: 'Timer 5', type: 'stopwatch', hours: 0, minutes: 0 }
        ];

        var timers = [];
        var animationFrameId = null;
        var etaManualStartTime = null;

        // ============ TIMER STATE ============
        function loadState() {
            const saved = localStorage.getItem('flightTimers');
            if (saved) {
                try {
                    timers = JSON.parse(saved);
                    const now = Date.now();
                    timers.forEach((timer) => {
                        if (timer.running && timer.lastUpdate) {
                            const elapsed = now - timer.lastUpdate;
                            if (timer.type === 'countdown') {
                                timer.remaining = Math.max(0, timer.remaining - elapsed);
                            } else {
                                timer.elapsed = (timer.elapsed || 0) + elapsed;
                            }
                        }
                        if (timer.running) {
                            timer.lastUpdate = now;
                        }
                    });
                } catch (e) {
                    timers = JSON.parse(JSON.stringify(defaultTimers));
                }
            } else {
                timers = JSON.parse(JSON.stringify(defaultTimers));
            }

            timers.forEach((timer) => {
                if (timer.remaining === undefined) {
                    timer.remaining = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
                if (timer.elapsed === undefined) {
                    timer.elapsed = 0;
                }
                if (timer.initialTime === undefined) {
                    timer.initialTime = (timer.hours * 3600 + timer.minutes * 60) * 1000;
                }
            });
        }

        function saveState() {
            const now = Date.now();
            timers.forEach(timer => {
                if (timer.running) {
                    timer.lastUpdate = now;
                }
            });
            localStorage.setItem('flightTimers', JSON.stringify(timers));
        }

        // ============ OOOI ============
        function loadOOOI() {
            // Load OOOI data for all 4 sectors
            const saved = localStorage.getItem('flightOOOI');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    for (let s = 1; s <= 4; s++) {
                        const sectorData = data['s' + s] || {};
                        ['out', 'off', 'on', 'in'].forEach(field => {
                            const val = sectorData[field] || '';
                            const el = document.getElementById(`s${s}-${field}`);
                            if (el) {
                                el.value = val;
                                const btn = document.getElementById(`s${s}-${field}-btn`);
                                if (btn) {
                                    btn.textContent = val ? val.padStart(4, '0') : '----';
                                }
                            }
                        });
                        calculateSectorTimes(s);
                    }
                } catch (e) {
                    console.log('Error loading OOOI:', e);
                }
            }
        }

        function saveOOOI() {
            const data = {};
            for (let s = 1; s <= 4; s++) {
                data['s' + s] = {
                    out: document.getElementById(`s${s}-out`)?.value || '',
                    off: document.getElementById(`s${s}-off`)?.value || '',
                    on: document.getElementById(`s${s}-on`)?.value || '',
                    in: document.getElementById(`s${s}-in`)?.value || ''
                };
            }
            localStorage.setItem('flightOOOI', JSON.stringify(data));
        }

        function parseTime(str) {
            if (!str || str.length < 3) return null;
            str = str.padStart(4, '0');
            const hours = parseInt(str.substring(0, 2), 10);
            const minutes = parseInt(str.substring(2, 4), 10);
            if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return null;
            return { hours, minutes };
        }

        function timeDiff(start, end) {
            if (!start || !end) return null;
            let startMins = start.hours * 60 + start.minutes;
            let endMins = end.hours * 60 + end.minutes;
            if (endMins < startMins) {
                endMins += 24 * 60;
            }
            return endMins - startMins;
        }

        function formatMinutes(mins) {
            if (mins === null) return '--:--';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function calculateSectorTimes(sectorNum) {
            const std = parseTime(document.getElementById(`s${sectorNum}-std`)?.value);
            const sta = parseTime(document.getElementById(`s${sectorNum}-sta`)?.value);
            const out = parseTime(document.getElementById(`s${sectorNum}-out`)?.value);
            const off = parseTime(document.getElementById(`s${sectorNum}-off`)?.value);
            const on = parseTime(document.getElementById(`s${sectorNum}-on`)?.value);
            const inn = parseTime(document.getElementById(`s${sectorNum}-in`)?.value);

            const blockEl = document.getElementById(`s${sectorNum}-block`);
            const flightEl = document.getElementById(`s${sectorNum}-flight`);
            const depDelayEl = document.getElementById(`s${sectorNum}-dep-delay`);
            const arrDelayEl = document.getElementById(`s${sectorNum}-arr-delay`);

            if (blockEl) blockEl.textContent = formatMinutes(timeDiff(out, inn));
            if (flightEl) flightEl.textContent = formatMinutes(timeDiff(off, on));

            // Calculate departure delay (OUT - STD)
            if (depDelayEl) {
                if (std && out) {
                    const delayMins = timeDiff(std, out);
                    if (delayMins !== null) {
                        if (delayMins === 0) {
                            depDelayEl.textContent = 'OT';
                            depDelayEl.style.color = '#00ff88';
                        } else if (delayMins > 0) {
                            depDelayEl.textContent = '+' + delayMins;
                            depDelayEl.style.color = delayMins > 15 ? '#ff5252' : '#ffd700';
                        } else {
                            depDelayEl.textContent = delayMins.toString();
                            depDelayEl.style.color = '#00d4ff';
                        }
                    } else {
                        depDelayEl.textContent = '--';
                        depDelayEl.style.color = '#888';
                    }
                } else {
                    depDelayEl.textContent = '--';
                    depDelayEl.style.color = '#888';
                }
            }

            // Calculate arrival delay (IN - STA)
            if (arrDelayEl) {
                if (sta && inn) {
                    const delayMins = timeDiff(sta, inn);
                    if (delayMins !== null) {
                        if (delayMins === 0) {
                            arrDelayEl.textContent = 'OT';
                            arrDelayEl.style.color = '#00ff88';
                        } else if (delayMins > 0) {
                            arrDelayEl.textContent = '+' + delayMins;
                            arrDelayEl.style.color = delayMins > 15 ? '#ff5252' : '#ffd700';
                        } else {
                            arrDelayEl.textContent = delayMins.toString();
                            arrDelayEl.style.color = '#00d4ff';
                        }
                    } else {
                        arrDelayEl.textContent = '--';
                        arrDelayEl.style.color = '#888';
                    }
                } else {
                    arrDelayEl.textContent = '--';
                    arrDelayEl.style.color = '#888';
                }
            }

            // Calculate turnaround from previous sector
            if (sectorNum > 1) {
                const prevIn = parseTime(document.getElementById(`s${sectorNum - 1}-in`)?.value);
                const currOut = out;
                const taEl = document.getElementById(`sector-${sectorNum}-turnaround`);
                if (taEl && prevIn && currOut) {
                    taEl.textContent = 'T/A: ' + formatMinutes(timeDiff(prevIn, currOut));
                    taEl.style.display = 'inline';
                }
            }

            saveOOOI();
        }

        function calculateOOOI() {
            // Calculate times for all visible sectors
            for (let s = 1; s <= currentSectorCount; s++) {
                calculateSectorTimes(s);
            }
        }

        // ============ ETA ============
        function loadETA() {
            const saved = localStorage.getItem('flightETA');
            if (saved) {
                try {
                    const eta = JSON.parse(saved);
                    document.getElementById('eta-time').value = eta.time || '';
                    document.getElementById('utc-manual').value = eta.manual || '';

                    const etaBtn = document.getElementById('eta-time-btn');
                    etaBtn.textContent = eta.time ? eta.time.padStart(4, '0') : '0000';
                    etaBtn.classList.toggle('placeholder', !eta.time);

                    const manualBtn = document.getElementById('utc-manual-btn');
                    manualBtn.textContent = eta.manual ? eta.manual.padStart(4, '0') : 'AUTO';
                    manualBtn.classList.toggle('placeholder', !eta.manual);

                    if (eta.manual && eta.manualStartTime) {
                        etaManualStartTime = eta.manualStartTime;
                    }
                } catch (e) {}
            }
        }

        function saveETA() {
            const eta = {
                time: document.getElementById('eta-time').value,
                manual: document.getElementById('utc-manual').value,
                manualStartTime: etaManualStartTime
            };
            localStorage.setItem('flightETA', JSON.stringify(eta));
        }

        function updateUTCClock() {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            const utcEl = document.getElementById('utc-clock');
            const stripUtcEl = document.getElementById('strip-utc-clock');
            if (utcEl) utcEl.textContent = utcTime;
            if (stripUtcEl) stripUtcEl.textContent = utcTime;

            // DXB time (UTC+4)
            const dxbTime = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            const dxbTimeStr = dxbTime.toISOString().substring(11, 16);  // HH:MM only
            const stripDxbEl = document.getElementById('strip-dxb-clock');
            if (stripDxbEl) stripDxbEl.textContent = dxbTimeStr;
        }

        function updateActiveTimersStrip() {
            const stripContainer = document.getElementById('strip-timers');
            const activeTimers = timers.filter(t => t.running || t.expired || (t.type === 'countdown' && t.remaining > 0 && t.remaining < t.initialTime));

            if (activeTimers.length === 0) {
                stripContainer.innerHTML = '';
                stripContainer.classList.add('hidden');
                return;
            }

            stripContainer.classList.remove('hidden');
            stripContainer.innerHTML = timers.map((timer, index) => {
                if (!timer.running && !timer.expired && !(timer.type === 'countdown' && timer.remaining > 0 && timer.remaining < timer.initialTime)) {
                    return '';
                }
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                return `
                    <div class="strip-timer ${colorClass}${timer.expired ? ' flashing' : ''}" onclick="switchTab('tmr')" data-timer-index="${index}">
                        <div class="strip-timer-icon" style="--strip-progress: ${progress}%">
                            <div class="strip-timer-icon-inner"></div>
                        </div>
                        <div class="strip-timer-info">
                            <span class="strip-timer-name">${timer.name}</span>
                            <span class="strip-timer-value">${formatTime(displayTime)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStripTimerDisplay(index) {
            const timer = timers[index];
            const stripTimer = document.querySelector(`.strip-timer[data-timer-index="${index}"]`);
            if (!stripTimer) return;

            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

            stripTimer.className = `strip-timer ${colorClass}${timer.expired ? ' flashing' : ''}`;
            stripTimer.querySelector('.strip-timer-icon').style.setProperty('--strip-progress', `${progress}%`);
            stripTimer.querySelector('.strip-timer-value').textContent = formatTime(displayTime);
        }

        function calculateETA() {
            const etaStr = document.getElementById('eta-time').value;
            const manualStr = document.getElementById('utc-manual').value;
            const etaDisplay = document.getElementById('eta-countdown');
            const stripEta = document.getElementById('strip-eta');
            const stripEtaTime = document.getElementById('strip-eta-time');
            const stripEtaTarget = document.getElementById('strip-eta-target');

            const eta = parseTime(etaStr);
            if (!eta) {
                etaDisplay.textContent = '--:--:--';
                etaDisplay.className = 'eta-countdown';
                stripEta.style.display = 'none';
                return;
            }

            // Update ETA target display
            stripEtaTarget.textContent = etaStr;

            let nowMins, nowSecs = 0;

            if (manualStr && manualStr.length >= 3 && etaManualStartTime) {
                // Manual mode: countdown from when manual time was entered
                const manual = parseTime(manualStr);
                if (manual) {
                    const elapsedSinceEntry = (Date.now() - etaManualStartTime) / 1000;
                    const manualTotalSecs = manual.hours * 3600 + manual.minutes * 60;
                    const currentSimSecs = manualTotalSecs + elapsedSinceEntry;
                    nowMins = currentSimSecs / 60;
                    nowSecs = currentSimSecs % 60;
                } else {
                    const now = new Date();
                    nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
                }
            } else {
                const now = new Date();
                nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            }

            let etaMins = eta.hours * 60 + eta.minutes;
            if (etaMins < nowMins - 60) {
                etaMins += 24 * 60;
            }

            const diffMins = etaMins - nowMins;
            const diffSecs = Math.max(0, Math.floor(diffMins * 60));

            // Update strip ETA
            stripEta.style.display = 'flex';
            const h = Math.floor(diffSecs / 3600);
            const m = Math.floor((diffSecs % 3600) / 60);
            const s = diffSecs % 60;
            const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            if (diffSecs <= 0) {
                etaDisplay.textContent = '00:00:00';
                etaDisplay.className = 'eta-countdown critical';
                stripEtaTime.textContent = '00:00';
                stripEtaTime.className = 'strip-eta-time critical';
            } else {
                etaDisplay.textContent = timeStr;
                stripEtaTime.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

                if (diffMins <= 10) {
                    etaDisplay.className = 'eta-countdown critical';
                    stripEtaTime.className = 'strip-eta-time critical';
                } else if (diffMins <= 30) {
                    etaDisplay.className = 'eta-countdown warning';
                    stripEtaTime.className = 'strip-eta-time warning';
                } else {
                    etaDisplay.className = 'eta-countdown';
                    stripEtaTime.className = 'strip-eta-time';
                }
            }
        }

        // ============ TOW ============
        function loadTOW() {
            const saved = localStorage.getItem('flightTOW');
            if (saved) {
                try {
                    const tow = JSON.parse(saved);
                    ['zfw', 'fob', 'taxi'].forEach(field => {
                        const val = tow[field] || '';
                        document.getElementById('calc-' + field).value = val;
                        const btn = document.getElementById('calc-' + field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateTOW();
                    calculateMLF();
                } catch (e) {}
            }
        }

        function saveTOW() {
            const tow = {
                zfw: document.getElementById('calc-zfw').value,
                fob: document.getElementById('calc-fob').value,
                taxi: document.getElementById('calc-taxi').value
            };
            localStorage.setItem('flightTOW', JSON.stringify(tow));
        }

        function calculateTOW() {
            const zfw = parseInt(document.getElementById('calc-zfw').value, 10) || 0;
            const fob = parseInt(document.getElementById('calc-fob').value, 10) || 0;
            const taxi = parseInt(document.getElementById('calc-taxi').value, 10) || 0;
            const trip = parseInt(document.getElementById('calc-trip').value, 10) || 0;

            const limits = aircraftLimits[selectedAircraft];
            let warnings = [];

            // Calculate weights
            const taxiWt = zfw + fob;  // Taxi weight = ZFW + total fuel
            const tow = zfw + fob - taxi;  // TOW = ZFW + FOB - Taxi fuel
            const estLdgFuel = fob - taxi - trip;  // Estimated landing fuel
            const ldw = zfw + estLdgFuel;  // Landing weight = ZFW + landing fuel

            // Update ZFW display
            const zfwEl = document.getElementById('zfw-display');
            if (zfw > 0) {
                zfwEl.textContent = zfw.toLocaleString();
                if (zfw > limits.mzfw) {
                    zfwEl.style.color = '#ff5252';
                    warnings.push(`ZFW exceeds MZFW by ${(zfw - limits.mzfw).toLocaleString()} kg`);
                } else {
                    zfwEl.style.color = '#7ec8e3';
                }
            } else {
                zfwEl.textContent = '---';
                zfwEl.style.color = '#7ec8e3';
            }

            // Update Taxi Weight display
            const taxiWtEl = document.getElementById('taxi-wt-result');
            if (zfw > 0 && fob > 0) {
                taxiWtEl.textContent = taxiWt.toLocaleString();
                if (taxiWt > limits.mtw) {
                    taxiWtEl.style.color = '#ff5252';
                    warnings.push(`Taxi Weight exceeds MTW by ${(taxiWt - limits.mtw).toLocaleString()} kg`);
                } else {
                    taxiWtEl.style.color = '#00ff88';
                }
            } else {
                taxiWtEl.textContent = '---';
                taxiWtEl.style.color = '#00ff88';
            }

            // Update TOW display
            const towEl = document.getElementById('tow-result');
            if (zfw === 0 && fob === 0) {
                towEl.textContent = '---';
                towEl.style.color = '#FF8200';
            } else {
                towEl.textContent = tow.toLocaleString();
                if (tow > limits.mtow) {
                    towEl.style.color = '#ff5252';
                    warnings.push(`TOW exceeds MTOW by ${(tow - limits.mtow).toLocaleString()} kg`);
                } else {
                    towEl.style.color = '#FF8200';
                }
            }

            // Update estimated landing fuel display
            const estLdgFuelEl = document.getElementById('est-ldg-fuel');
            if (fob > 0 && trip > 0) {
                estLdgFuelEl.textContent = estLdgFuel.toLocaleString() + ' kg';
                estLdgFuelEl.style.color = estLdgFuel < 0 ? '#ff5252' : '#7ec8e3';
            } else {
                estLdgFuelEl.textContent = '---';
            }

            // Update Landing Weight display
            const ldwEl = document.getElementById('ldw-result');
            if (zfw > 0 && fob > 0 && trip > 0) {
                ldwEl.textContent = ldw.toLocaleString();
                if (ldw > limits.mlw) {
                    ldwEl.style.color = '#ff5252';
                    warnings.push(`Est. LDW exceeds MLW by ${(ldw - limits.mlw).toLocaleString()} kg`);
                } else {
                    ldwEl.style.color = '#00ff88';
                }
            } else {
                ldwEl.textContent = '---';
                ldwEl.style.color = '#00ff88';
            }

            // Display warnings
            const warningsEl = document.getElementById('tow-warnings');
            if (warnings.length > 0) {
                warningsEl.innerHTML = warnings.map(w =>
                    `<div class="fdp-danger" style="margin-bottom:5px; padding:8px; font-size:0.8rem">${w}</div>`
                ).join('');
            } else {
                warningsEl.innerHTML = '';
            }

            saveTOW();
        }

        // ============ ACC HEIGHT ============
        function loadACC() {
            const saved = localStorage.getItem('flightACC');
            if (saved) {
                try {
                    const acc = JSON.parse(saved);
                    ['opt-acc', 'airfield-elev'].forEach(field => {
                        const key = field === 'opt-acc' ? 'optAcc' : 'elev';
                        const val = acc[key] || '';
                        document.getElementById(field).value = val;
                        const btn = document.getElementById(field + '-btn');
                        btn.textContent = val ? parseInt(val, 10).toLocaleString() : '0';
                        btn.classList.toggle('placeholder', !val);
                    });
                    calculateACC();
                } catch (e) {}
            }
        }

        function saveACC() {
            const acc = {
                optAcc: document.getElementById('opt-acc').value,
                elev: document.getElementById('airfield-elev').value
            };
            localStorage.setItem('flightACC', JSON.stringify(acc));
        }

        function calculateACC() {
            const optAcc = parseInt(document.getElementById('opt-acc').value, 10) || 0;
            const elev = parseInt(document.getElementById('airfield-elev').value, 10) || 0;

            if (optAcc === 0) {
                document.getElementById('acc-result').textContent = '--- ft';
            } else {
                const result = optAcc - elev;
                document.getElementById('acc-result').textContent = result.toLocaleString() + ' ft';
            }
            saveACC();
        }

        // ============ VREF / MANEUVER SPEED CALCULATOR ============
        var vrefAircraftData = {
            'B738': {
                name: 'B737-800',
                engine: 'CFM56-7B27B1',
                refAlt: 10000,
                vref: [
                    { weight: 85000, f40: 159, f30: 167, f15: 174 },
                    { weight: 80000, f40: 154, f30: 162, f15: 169 },
                    { weight: 75000, f40: 148, f30: 156, f15: 163 },
                    { weight: 70000, f40: 143, f30: 151, f15: 157 },
                    { weight: 65000, f40: 139, f30: 147, f15: 153 },
                    { weight: 60000, f40: 133, f30: 141, f15: 147 },
                    { weight: 55000, f40: 127, f30: 134, f15: 140 },
                    { weight: 50000, f40: 121, f30: 128, f15: 133 },
                    { weight: 45000, f40: 114, f30: 121, f15: 126 },
                    { weight: 40000, f40: 107, f30: 114, f15: 119 }
                ]
            },
            'B38M': {
                name: 'B737-8 MAX',
                engine: 'LEAP-1B28B1',
                refAlt: 14500,
                vref: [
                    { weight: 90000, f40: 169, f30: 169, f15: 179 },
                    { weight: 85000, f40: 163, f30: 165, f15: 173 },
                    { weight: 80000, f40: 156, f30: 160, f15: 168 },
                    { weight: 75000, f40: 149, f30: 154, f15: 162 },
                    { weight: 70000, f40: 144, f30: 149, f15: 156 },
                    { weight: 65000, f40: 140, f30: 145, f15: 152 },
                    { weight: 60000, f40: 134, f30: 139, f15: 145 },
                    { weight: 55000, f40: 128, f30: 132, f15: 139 },
                    { weight: 50000, f40: 121, f30: 126, f15: 132 },
                    { weight: 45000, f40: 115, f30: 119, f15: 125 },
                    { weight: 40000, f40: 108, f30: 112, f15: 118 }
                ]
            },
            'B39M': {
                name: 'B737-9 MAX',
                engine: 'LEAP-1B28B1',
                refAlt: 14500,
                vref: [
                    { weight: 90000, f40: 169, f30: 167, f15: 177 },
                    { weight: 85000, f40: 163, f30: 162, f15: 171 },
                    { weight: 80000, f40: 156, f30: 157, f15: 166 },
                    { weight: 75000, f40: 149, f30: 152, f15: 160 },
                    { weight: 70000, f40: 144, f30: 148, f15: 155 },
                    { weight: 65000, f40: 139, f30: 142, f15: 150 },
                    { weight: 60000, f40: 134, f30: 137, f15: 143 },
                    { weight: 55000, f40: 127, f30: 131, f15: 137 },
                    { weight: 50000, f40: 121, f30: 124, f15: 130 },
                    { weight: 45000, f40: 114, f30: 118, f15: 123 },
                    { weight: 40000, f40: 107, f30: 111, f15: 115 }
                ]
            }
        };

        var selectedVrefAircraft = 'B738';

        function selectVrefAircraft(acType) {
            selectedVrefAircraft = acType;
            // Update button states
            document.querySelectorAll('[id^="vref-ac-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById('vref-ac-' + acType.toLowerCase()).classList.add('active');
            calculateVref();
        }

        function interpolateVref(weight, acType) {
            var data = vrefAircraftData[acType];
            if (!data) return null;

            var vrefTable = data.vref;
            // Find the two weights to interpolate between
            var lower = null, upper = null;

            for (var i = 0; i < vrefTable.length; i++) {
                if (weight >= vrefTable[i].weight) {
                    upper = vrefTable[i];
                    lower = vrefTable[i + 1] || vrefTable[i];
                    break;
                }
            }

            // If weight is below minimum in table
            if (!upper) {
                upper = vrefTable[vrefTable.length - 1];
                lower = upper;
            }

            // If weight is above maximum in table
            if (weight > vrefTable[0].weight) {
                upper = vrefTable[0];
                lower = vrefTable[0];
            }

            // Linear interpolation
            if (upper.weight === lower.weight) {
                return { f40: upper.f40, f30: upper.f30, f15: upper.f15 };
            }

            var ratio = (weight - lower.weight) / (upper.weight - lower.weight);
            return {
                f40: Math.round(lower.f40 + ratio * (upper.f40 - lower.f40)),
                f30: Math.round(lower.f30 + ratio * (upper.f30 - lower.f30)),
                f15: Math.round(lower.f15 + ratio * (upper.f15 - lower.f15))
            };
        }

        function calculateVref() {
            var weight = parseInt(document.getElementById('vref-weight').value, 10) || 0;
            var acData = vrefAircraftData[selectedVrefAircraft];

            if (weight === 0) {
                // Clear all displays
                document.getElementById('vref-40').textContent = '---';
                document.getElementById('vref-30').textContent = '---';
                document.getElementById('vref-15').textContent = '---';
                ['up', '1', '5', '10', '15', '25', '30', '40'].forEach(function(f) {
                    document.getElementById('man-' + f).textContent = '---';
                });
                document.getElementById('vref-info').textContent = 'Select aircraft and enter landing weight';
                return;
            }

            // Get interpolated VREF values
            var vref = interpolateVref(weight, selectedVrefAircraft);
            if (!vref) return;

            // Display VREF speeds
            document.getElementById('vref-40').textContent = vref.f40;
            document.getElementById('vref-30').textContent = vref.f30;
            document.getElementById('vref-15').textContent = vref.f15;

            // Calculate and display maneuver speeds based on VREF40
            // Formulas: UP = VREF40+70, F1 = VREF40+50, F5/F10 = VREF40+30, F15 = VREF40+20, F25 = VREF40+10
            document.getElementById('man-up').textContent = vref.f40 + 70;
            document.getElementById('man-1').textContent = vref.f40 + 50;
            document.getElementById('man-5').textContent = vref.f40 + 30;
            document.getElementById('man-10').textContent = vref.f40 + 30;
            document.getElementById('man-15').textContent = vref.f40 + 20;
            document.getElementById('man-25').textContent = vref.f40 + 10;
            document.getElementById('man-30').textContent = vref.f30;
            document.getElementById('man-40').textContent = vref.f40;

            // Update info
            var minW = acData.vref[acData.vref.length - 1].weight;
            var maxW = acData.vref[0].weight;
            var info = acData.name + ' | ' + acData.engine + ' | Ref Alt: ' + acData.refAlt.toLocaleString() + ' ft';
            if (weight < minW || weight > maxW) {
                info += ' | RANGE: ' + (minW/1000).toFixed(1) + '-' + (maxW/1000).toFixed(1) + ' T';
                document.getElementById('vref-info').style.color = '#ff5252';
            } else {
                document.getElementById('vref-info').style.color = '#666';
            }
            document.getElementById('vref-info').textContent = info;
        }

        function clearVref() {
            document.getElementById('vref-weight').value = '';
            document.getElementById('vref-weight-btn').textContent = '---';
            document.getElementById('vref-weight-btn').classList.add('placeholder');
            document.getElementById('vref-40').textContent = '---';
            document.getElementById('vref-30').textContent = '---';
            document.getElementById('vref-15').textContent = '---';
            ['up', '1', '5', '10', '15', '25', '30', '40'].forEach(function(f) {
                document.getElementById('man-' + f).textContent = '---';
            });
            document.getElementById('vref-info').textContent = 'Select aircraft and enter landing weight';
            document.getElementById('vref-info').style.color = '#666';
        }

        // ============ FDP CALCULATOR ============
        const fdpTableFlightAcclimatized = {
            '0600': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '0800': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 9.5],
            '1300': [13, 12.25, 11.5, 10.75, 10, 9.5, 9, 9],
            '1800': [12, 11.25, 10.5, 9.75, 9, 9, 9, 9],
            '2200': [11, 10.25, 9.5, 9, 9, 9, 9, 9]
        };

        const fdpTableCabinAcclimatized = {
            '0600': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '0800': [15, 14.25, 13.5, 12.75, 12, 11.5, 11, 10.5],
            '1300': [14, 13.25, 12.5, 11.75, 11, 10.5, 10, 10],
            '1800': [13, 12.25, 11.5, 10.75, 10, 10, 10, 10],
            '2200': [12, 11.25, 10.5, 10, 10, 10, 10, 10]
        };

        const fdpTableFlightUnacclimatized = {
            'normal': [13, 12.25, 11.5, 10.75, 10, 9.25, 9],
            'reduced': [11.5, 11, 10.5, 9.75, 9, 9, 9]
        };

        const fdpTableCabinUnacclimatized = {
            'normal': [14, 13.25, 12.5, 11.75, 11, 10.25, 10],
            'reduced': [12.5, 12, 11.5, 10.75, 10, 10, 10]
        };

        function getTimeBand(reportTime) {
            const time = parseTime(reportTime);
            if (!time) return '0800';
            const mins = time.hours * 60 + time.minutes;

            if (mins >= 360 && mins < 480) return '0600';      // 0600-0759
            if (mins >= 480 && mins < 780) return '0800';      // 0800-1259
            if (mins >= 780 && mins < 1080) return '1300';     // 1300-1759
            if (mins >= 1080 && mins < 1320) return '1800';    // 1800-2159
            return '2200';                                      // 2200-0559
        }

        function getMaxFDP(crewType, acclimatized, restType, reportTime, sectors) {
            const sectorIdx = Math.min(sectors - 1, 7);

            if (acclimatized === 'yes') {
                const timeBand = getTimeBand(reportTime);
                const table = crewType === 'flight' ? fdpTableFlightAcclimatized : fdpTableCabinAcclimatized;
                return table[timeBand][sectorIdx];
            } else {
                const table = crewType === 'flight' ? fdpTableFlightUnacclimatized : fdpTableCabinUnacclimatized;
                return table[restType][Math.min(sectorIdx, 6)];
            }
        }

        function formatHoursToHHMM(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function addTime(timeStr, hoursToAdd) {
            const time = parseTime(timeStr);
            if (!time) return '--:--';
            let totalMins = time.hours * 60 + time.minutes + Math.round(hoursToAdd * 60);
            totalMins = totalMins % (24 * 60);
            if (totalMins < 0) totalMins += 24 * 60;
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function formatTimeDisplay(timeStr) {
            if (!timeStr || timeStr === '--:--') return '--:--';
            return timeStr.substring(0, 2) + ':' + timeStr.substring(2);
        }

        function getLocalOffset() {
            return parseFloat(document.getElementById('local-offset').value) || 4;
        }

        function localToUTC(localTimeStr) {
            const time = parseTime(localTimeStr);
            if (!time) return null;
            const offset = getLocalOffset();
            let utcMins = time.hours * 60 + time.minutes - (offset * 60);
            if (utcMins < 0) utcMins += 24 * 60;
            if (utcMins >= 24 * 60) utcMins -= 24 * 60;
            const h = Math.floor(utcMins / 60);
            const m = utcMins % 60;
            return `${h.toString().padStart(2, '0')}${m.toString().padStart(2, '0')}`;
        }

        function utcToLocal(utcTimeStr) {
            const time = parseTime(utcTimeStr);
            if (!time) return '--:--';
            const offset = getLocalOffset();
            let localMins = time.hours * 60 + time.minutes + (offset * 60);
            if (localMins < 0) localMins += 24 * 60;
            if (localMins >= 24 * 60) localMins -= 24 * 60;
            const h = Math.floor(localMins / 60);
            const m = localMins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function estimateDutyEnd() {
            const sectors = currentSectorCount;
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;

            // Check if we have actual ON times from Schedule
            let lastActualOn = null;
            for (let i = sectors; i >= 1; i--) {
                const onEl = document.getElementById(`s${i}-on`);
                if (onEl && onEl.value) {
                    lastActualOn = onEl.value;
                    break;
                }
            }

            // If we have actual ON time, estimate duty end as ON + 30 min post-flight
            let estDutyEndUTC = null;
            if (lastActualOn) {
                estDutyEndUTC = addTime(lastActualOn, 0.5); // Add 30 min post-flight
            } else {
                // Use last scheduled STA from Schedule
                const lastStaEl = document.getElementById(`s${sectors}-sta`);
                if (lastStaEl && lastStaEl.value) {
                    const staUTC = localToUTC(lastStaEl.value);
                    estDutyEndUTC = addTime(staUTC, 0.5);
                }
            }

            const estEndEl = document.getElementById('est-duty-end');
            const estEndLocalEl = document.getElementById('est-duty-end-local');
            const statusEl = document.getElementById('duty-status');

            if (estDutyEndUTC) {
                estEndEl.textContent = formatTimeDisplay(estDutyEndUTC);
                estEndLocalEl.textContent = utcToLocal(estDutyEndUTC);

                // Calculate if within limits
                const reportUTC = localToUTC(reportTime);
                const reportParsed = parseTime(reportUTC);
                const estEndParsed = parseTime(estDutyEndUTC);

                if (reportParsed && estEndParsed) {
                    let dutyMins = (estEndParsed.hours * 60 + estEndParsed.minutes) - (reportParsed.hours * 60 + reportParsed.minutes);
                    if (dutyMins < 0) dutyMins += 24 * 60;

                    const maxFDPMins = maxFDP * 60;
                    const absoluteLimitMins = (maxFDP + maxDiscretion) * 60;

                    if (dutyMins <= maxFDPMins) {
                        statusEl.textContent = 'Within FDP';
                        statusEl.className = 'duty-estimate-value green';
                    } else if (dutyMins <= absoluteLimitMins) {
                        const intoDiscretion = Math.floor(dutyMins - maxFDPMins);
                        statusEl.textContent = `In Discretion (+${formatMinutes(intoDiscretion)})`;
                        statusEl.className = 'duty-estimate-value orange';
                    } else {
                        statusEl.textContent = 'EXCEEDS LIMIT';
                        statusEl.className = 'duty-estimate-value red';
                    }
                }
            } else {
                estEndEl.textContent = '--:--';
                estEndLocalEl.textContent = '--:--';
                statusEl.textContent = '---';
                statusEl.className = 'duty-estimate-value';
            }
        }

        function calculateFDP() {
            const crewType = document.getElementById('fdp-crew-type').value;
            const acclimatized = document.getElementById('fdp-acclimatized').value;
            const restType = document.getElementById('fdp-rest').value;
            const reportTime = document.getElementById('fdp-report').value || '0600';
            const sectors = parseInt(document.getElementById('fdp-sectors').value, 10);

            // Update report button display
            const reportBtn = document.getElementById('fdp-report-btn');
            reportBtn.textContent = reportTime.padStart(4, '0');

            const maxFDP = getMaxFDP(crewType, acclimatized, restType, reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;
            const absoluteLimit = maxFDP + maxDiscretion;
            const minRest = crewType === 'flight' ? 12 : 11;

            // Convert report time to UTC for calculations
            const reportUTC = localToUTC(reportTime);
            const latestChocksUTC = addTime(reportUTC, maxFDP);
            const latestOffDutyUTC = addTime(reportUTC, maxFDP + 0.5);
            const absoluteChocksUTC = addTime(reportUTC, absoluteLimit);

            document.getElementById('fdp-max').textContent = formatHoursToHHMM(maxFDP);
            // Local time prominent, UTC secondary
            document.getElementById('fdp-chocks-local').textContent = utcToLocal(latestChocksUTC);
            document.getElementById('fdp-chocks').textContent = 'UTC: ' + formatTimeDisplay(latestChocksUTC);
            document.getElementById('fdp-offduty-local').textContent = utcToLocal(latestOffDutyUTC);
            document.getElementById('fdp-offduty').textContent = 'UTC: ' + formatTimeDisplay(latestOffDutyUTC);
            document.getElementById('fdp-discretion').textContent = '+' + maxDiscretion + ':00';
            document.getElementById('fdp-absolute-local').textContent = utcToLocal(absoluteChocksUTC);
            document.getElementById('fdp-absolute').textContent = 'UTC: ' + formatTimeDisplay(absoluteChocksUTC);
            document.getElementById('fdp-rest-after').textContent = minRest + ':00';

            // Warnings
            let warnings = '';
            if (acclimatized === 'no' && restType === 'reduced') {
                warnings += '<div class="fdp-warning">Reduced rest (18-30h) - Lower FDP limits apply</div>';
            }

            const timeBand = getTimeBand(reportTime);
            if (timeBand === '2200' || timeBand === '0600') {
                warnings += '<div class="fdp-warning">Early/Night duty - Check consecutive duty limits (max 3)</div>';
            }

            document.getElementById('fdp-warnings').innerHTML = warnings;

            // Live tracker
            updateLiveTracker(maxFDP);
            estimateDutyEnd();
        }

        function calculateQuickDuty() {
            const reportTime = document.getElementById('quick-report').value;
            const sectors = parseInt(document.getElementById('quick-sectors').value, 10);
            const acclimatized = document.getElementById('quick-accl').value;
            const utcOffset = parseInt(document.getElementById('quick-utc-offset').value, 10);

            // Update button display
            const reportBtn = document.getElementById('quick-report-btn');
            reportBtn.textContent = reportTime ? reportTime.padStart(4, '0') : '----';

            if (!reportTime) {
                document.getElementById('quick-max-fdp').textContent = '--:--';
                document.getElementById('quick-chocks').textContent = '--:-- Z';
                document.getElementById('quick-chocks-local').textContent = '--:-- L';
                document.getElementById('quick-offduty').textContent = '--:-- Z';
                document.getElementById('quick-offduty-local').textContent = '--:-- L';
                document.getElementById('quick-discretion').textContent = '--:--';
                document.getElementById('quick-absolute').textContent = '--:-- Z';
                document.getElementById('quick-absolute-local').textContent = '--:-- L';
                document.getElementById('quick-rest').textContent = '12:00';
                return;
            }

            // Use flight crew, normal rest for quick calc
            const maxFDP = getMaxFDP('flight', acclimatized, 'normal', reportTime, sectors);
            const maxDiscretion = sectors === 1 ? 3 : 2;
            const absoluteLimit = maxFDP + maxDiscretion;

            // Helper to convert local time to UTC using the selected offset
            function localToUTCWithOffset(localTime) {
                if (!localTime) return null;
                var hours = parseInt(localTime.substring(0, 2), 10);
                var mins = parseInt(localTime.substring(2, 4), 10);
                hours = hours - utcOffset;
                if (hours < 0) hours += 24;
                if (hours >= 24) hours -= 24;
                return String(hours).padStart(2, '0') + String(mins).padStart(2, '0');
            }

            // Helper to convert UTC time to local using the selected offset
            function utcToLocalWithOffset(utcTime) {
                if (!utcTime) return null;
                var hours = parseInt(utcTime.substring(0, 2), 10);
                var mins = parseInt(utcTime.substring(2, 4), 10);
                hours = hours + utcOffset;
                if (hours < 0) hours += 24;
                if (hours >= 24) hours -= 24;
                return String(hours).padStart(2, '0') + String(mins).padStart(2, '0');
            }

            // Convert report time (local) to UTC for calculations
            const reportUTC = localToUTCWithOffset(reportTime);

            // Calculate times in UTC
            const latestChocksUTC = addTime(reportUTC, maxFDP);
            const latestOffDutyUTC = addTime(reportUTC, maxFDP + 0.5);
            const absoluteChocksUTC = addTime(reportUTC, absoluteLimit);

            // Convert UTC times back to local for display
            const latestChocksLocal = utcToLocalWithOffset(latestChocksUTC);
            const latestOffDutyLocal = utcToLocalWithOffset(latestOffDutyUTC);
            const absoluteChocksLocal = utcToLocalWithOffset(absoluteChocksUTC);

            // Format time for display (HHMM -> HH:MM)
            function formatTimeDisplay(time) {
                if (!time || time.length < 4) return '--:--';
                return time.substring(0, 2) + ':' + time.substring(2, 4);
            }

            document.getElementById('quick-max-fdp').textContent = formatHoursToHHMM(maxFDP);
            document.getElementById('quick-chocks').textContent = formatTimeDisplay(latestChocksUTC) + ' Z';
            document.getElementById('quick-chocks-local').textContent = formatTimeDisplay(latestChocksLocal) + ' L';
            document.getElementById('quick-offduty').textContent = formatTimeDisplay(latestOffDutyUTC) + ' Z';
            document.getElementById('quick-offduty-local').textContent = formatTimeDisplay(latestOffDutyLocal) + ' L';
            document.getElementById('quick-discretion').textContent = '+' + maxDiscretion + ':00';
            document.getElementById('quick-absolute').textContent = formatTimeDisplay(absoluteChocksUTC) + ' Z';
            document.getElementById('quick-absolute-local').textContent = formatTimeDisplay(absoluteChocksLocal) + ' L';
            document.getElementById('quick-rest').textContent = '12:00';
        }

        function updateLiveTracker(maxFDP) {
            const now = new Date();
            const utcTime = now.toISOString().substring(11, 19);
            document.getElementById('fdp-utc-time').textContent = utcTime;

            const offset = getLocalOffset();
            const localDate = new Date(now.getTime() + offset * 60 * 60 * 1000);
            const localTime = localDate.toISOString().substring(11, 19);
            document.getElementById('fdp-local-time').textContent = localTime;

            const actualReport = document.getElementById('fdp-actual-report').value;
            const actualBtn = document.getElementById('fdp-actual-report-btn');
            actualBtn.textContent = actualReport ? actualReport.padStart(4, '0') : '----';

            if (!actualReport) {
                document.getElementById('fdp-elapsed').textContent = '--:--';
                document.getElementById('fdp-remaining').textContent = '--:--';
                document.getElementById('fdp-into-discretion').textContent = '--:--';
                return;
            }

            // Convert actual report from local to UTC for calculations
            const reportUTC = localToUTC(actualReport);
            const report = parseTime(reportUTC);
            if (!report) return;

            const reportMins = report.hours * 60 + report.minutes;
            const nowMins = now.getUTCHours() * 60 + now.getUTCMinutes() + now.getUTCSeconds() / 60;
            let elapsedMins = nowMins - reportMins;
            if (elapsedMins < -60) elapsedMins += 24 * 60;

            const maxFDPMins = maxFDP * 60;
            const remainingMins = maxFDPMins - elapsedMins;
            const intoDiscretionMins = elapsedMins - maxFDPMins;

            document.getElementById('fdp-elapsed').textContent = formatMinutes(Math.max(0, Math.floor(elapsedMins)));

            const remainingEl = document.getElementById('fdp-remaining');
            if (remainingMins > 0) {
                remainingEl.textContent = formatMinutes(Math.floor(remainingMins));
                remainingEl.className = 'fdp-result-value ' + (remainingMins > 60 ? 'green' : remainingMins > 30 ? 'yellow' : 'red');
            } else {
                remainingEl.textContent = '00:00';
                remainingEl.className = 'fdp-result-value red';
            }

            const discretionEl = document.getElementById('fdp-into-discretion');
            if (intoDiscretionMins > 0) {
                discretionEl.textContent = '+' + formatMinutes(Math.floor(intoDiscretionMins));
                discretionEl.className = 'fdp-result-value ' + (intoDiscretionMins > 120 ? 'red' : 'orange');
            } else {
                discretionEl.textContent = '--:--';
                discretionEl.className = 'fdp-result-value';
            }
        }

        // ============ TIMER FUNCTIONS ============
        function formatTime(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const prefix = ms < 0 ? '-' : '';
            return `${prefix}${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getColorClass(timer) {
            if (timer.type === 'stopwatch') return 'color-neutral';
            if (timer.remaining <= 0) return 'color-expired';
            const percent = (timer.remaining / timer.initialTime) * 100;
            if (percent > 50) return 'color-green';
            if (percent > 25) return 'color-yellow';
            if (percent > 10) return 'color-orange';
            return 'color-red';
        }

        function getProgress(timer) {
            if (timer.type === 'stopwatch') return ((timer.elapsed % 60000) / 60000) * 100;
            if (timer.initialTime === 0) return 0;
            return Math.max(0, (timer.remaining / timer.initialTime) * 100);
        }

        // Start continuous flashing on timer (CSS animation handles the visual)
        function flashTimer(index) {
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                card.classList.add('flashing');
            }
        }

        // Stop flashing when timer is reset
        function stopFlashing(index) {
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                card.classList.remove('flashing');
            }
        }

        function createTimerHTML(timer, index) {
            const colorClass = getColorClass(timer);
            const progress = getProgress(timer);
            const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;
            const isRunning = timer.running;
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            return `
                <div class="timer-card ${colorClass}${timer.expired ? ' flashing' : ''}" id="timer-${index}">
                    <div class="clock-container">
                        <div class="clock-face" style="--progress: ${progress}%">
                            <div class="clock-inner">
                                <span class="clock-time">${formatTime(displayTime)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timer-content">
                        <input type="text" class="timer-name-input" value="${timer.name}"
                               onchange="updateTimerName(${index}, this.value)">
                        <div class="timer-type-toggle">
                            <button class="type-btn ${timer.type === 'countdown' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'countdown')">Countdown</button>
                            <button class="type-btn ${timer.type === 'stopwatch' ? 'active' : ''}"
                                    onclick="setTimerType(${index}, 'stopwatch')">Stopwatch</button>
                        </div>
                        <div class="timer-time-setup" style="${timer.type === 'stopwatch' ? 'visibility: hidden;' : ''}">
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'hours')" ${isRunning ? 'disabled' : ''}>${hours}</button>
                            <span class="time-separator">h</span>
                            <button class="time-input-btn" onclick="openTimerPicker(${index}, 'minutes')" ${isRunning ? 'disabled' : ''}>${minutes}</button>
                            <span class="time-separator">m</span>
                        </div>
                        <div class="timer-display">${formatTime(displayTime)}</div>
                        <div class="timer-buttons">
                            <button class="timer-btn ${isRunning ? 'btn-pause' : 'btn-start'}"
                                    onclick="toggleTimer(${index})">
                                ${isRunning ? 'Pause' : 'Start'}
                            </button>
                            <button class="timer-btn btn-reset" onclick="resetTimer(${index})">Reset</button>
                            <button class="timer-btn btn-repeat" onclick="repeatTimer(${index})" title="Reset & Start" style="${timer.type === 'stopwatch' ? 'visibility: hidden;' : ''}">â†»</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimers() {
            document.getElementById('timers-container').innerHTML = timers.map((timer, index) => createTimerHTML(timer, index)).join('');
            updateActiveTimersStrip();
        }

        function updateTimerDisplay(index) {
            const timer = timers[index];
            const card = document.getElementById(`timer-${index}`);
            if (card) {
                const colorClass = getColorClass(timer);
                const progress = getProgress(timer);
                const displayTime = timer.type === 'countdown' ? timer.remaining : timer.elapsed;

                const isFlashing = card.classList.contains('flashing');
                card.className = `timer-card ${colorClass}${isFlashing ? ' flashing' : ''}`;
                card.querySelector('.clock-face').style.setProperty('--progress', `${progress}%`);
                card.querySelector('.clock-time').textContent = formatTime(displayTime);
                card.querySelector('.timer-display').textContent = formatTime(displayTime);
            }

            // Also update strip display
            updateStripTimerDisplay(index);
        }

        var lastFrameTime = 0;
        function tick(currentTime) {
            if (lastFrameTime === 0) lastFrameTime = currentTime;
            const delta = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            let anyRunning = false;
            timers.forEach((timer, index) => {
                if (timer.running) {
                    anyRunning = true;
                    const now = Date.now();
                    const elapsed = now - timer.lastUpdate;
                    timer.lastUpdate = now;

                    if (timer.type === 'countdown') {
                        const wasPositive = timer.remaining > 0;
                        timer.remaining = Math.max(0, timer.remaining - elapsed);
                        if (wasPositive && timer.remaining === 0) {
                            timer.running = false;
                            timer.expired = true; // Mark as expired for continuous flashing
                            flashTimer(index); // Flash continuously until reset
                            renderTimers();
                            return;
                        }
                    } else {
                        timer.elapsed += elapsed;
                    }
                    updateTimerDisplay(index);
                }
            });

            if (Math.floor(currentTime / 5000) !== Math.floor((currentTime - delta) / 5000)) {
                saveState();
            }

            if (anyRunning) {
                animationFrameId = requestAnimationFrame(tick);
            } else {
                animationFrameId = null;
                lastFrameTime = 0;
            }
        }

        function startAnimationLoop() {
            if (animationFrameId === null && timers.some(t => t.running)) {
                lastFrameTime = 0;
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        function openTimerPicker(index, unit) {
            const timer = timers[index];
            const hours = Math.floor(timer.initialTime / 3600000);
            const minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') {
                openPicker('Set Hours', 'h', hours, 2, false, (val) => updateTimerTime(index, 'hours', parseInt(val, 10) || 0));
            } else {
                openPicker('Set Minutes', 'm', minutes, 2, false, (val) => updateTimerTime(index, 'minutes', Math.min(59, parseInt(val, 10) || 0)));
            }
        }

        function toggleTimer(index) {
            const timer = timers[index];
            if (timer.running) {
                timer.running = false;
            } else {
                if (timer.type === 'countdown' && timer.remaining === 0) {
                    timer.remaining = timer.initialTime;
                }
                timer.running = true;
                timer.lastUpdate = Date.now();
                startAnimationLoop();
            }
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function resetTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.expired = false; // Clear expired flag
            timer.remaining = timer.type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            stopFlashing(index); // Stop continuous flashing
            saveState();
            renderTimers();
        }

        function repeatTimer(index) {
            const timer = timers[index];
            timer.running = false;
            timer.expired = false;
            timer.remaining = timer.initialTime;
            timer.elapsed = 0;
            stopFlashing(index);
            // Immediately start the timer
            timer.running = true;
            timer.lastUpdate = Date.now();
            saveState();
            renderTimers();
            startAnimationLoop();
        }

        function setTimerType(index, type) {
            const timer = timers[index];
            timer.type = type;
            timer.running = false;
            timer.remaining = type === 'countdown' ? timer.initialTime : 0;
            timer.elapsed = 0;
            saveState();
            renderTimers();
        }

        function updateTimerName(index, name) {
            timers[index].name = name;
            saveState();
        }

        function updateTimerTime(index, unit, value) {
            const timer = timers[index];
            let hours = Math.floor(timer.initialTime / 3600000);
            let minutes = Math.floor((timer.initialTime % 3600000) / 60000);

            if (unit === 'hours') hours = value;
            if (unit === 'minutes') minutes = Math.min(59, value);

            timer.initialTime = (hours * 3600 + minutes * 60) * 1000;
            timer.remaining = timer.initialTime;
            timer.hours = hours;
            timer.minutes = minutes;

            saveState();
            renderTimers();
        }

        // ============ CLEAR HANDLERS ============
        document.getElementById('oooi-clear')?.addEventListener('click', () => {
            ['out', 'off', 'on', 'in'].forEach(field => {
                document.getElementById('oooi-' + field).value = '';
                const btn = document.getElementById('oooi-' + field + '-btn');
                if (btn) { btn.textContent = '0000'; btn.classList.add('placeholder'); }
            });
            const bt = document.getElementById('block-time'); if (bt) bt.textContent = '--:--';
            const ft = document.getElementById('flight-time'); if (ft) ft.textContent = '--:--';
            localStorage.removeItem('flightOOOI');
        });

        document.getElementById('eta-clear')?.addEventListener('click', () => {
            document.getElementById('eta-time').value = '';
            document.getElementById('utc-manual').value = '';
            document.getElementById('eta-time-btn').textContent = '0000';
            document.getElementById('eta-time-btn').classList.add('placeholder');
            document.getElementById('utc-manual-btn').textContent = 'AUTO';
            document.getElementById('utc-manual-btn').classList.add('placeholder');
            document.getElementById('eta-countdown').textContent = '--:--:--';
            document.getElementById('eta-countdown').className = 'eta-countdown';
            etaManualStartTime = null;
            localStorage.removeItem('flightETA');
        });

        document.getElementById('calc-clear')?.addEventListener('click', () => {
            ['zfw', 'fob', 'taxi', 'trip'].forEach(field => {
                document.getElementById('calc-' + field).value = '';
                const btn = document.getElementById('calc-' + field + '-btn');
                if (btn) { btn.textContent = '0'; btn.classList.add('placeholder'); }
            });
            document.getElementById('tow-result').textContent = '---';
            document.getElementById('tow-result').style.color = '#FF8200';
            document.getElementById('taxi-wt-result').textContent = '---';
            document.getElementById('taxi-wt-result').style.color = '#00ff88';
            document.getElementById('ldw-result').textContent = '---';
            document.getElementById('ldw-result').style.color = '#00ff88';
            document.getElementById('est-ldg-fuel').textContent = '---';
            document.getElementById('zfw-display').textContent = '---';
            document.getElementById('zfw-display').style.color = '#7ec8e3';
            document.getElementById('tow-warnings').innerHTML = '';
            document.getElementById('mlf-result').textContent = '---';
            localStorage.removeItem('flightTOW');
        });

        document.getElementById('acc-clear')?.addEventListener('click', () => {
            document.getElementById('acc-airport').value = '';
            ['opt-acc', 'airfield-elev'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                if (btn) { btn.textContent = '---'; btn.classList.add('placeholder'); }
            });
            document.getElementById('acc-result').textContent = '--- ft';
            localStorage.removeItem('flightACC');
        });

        // ============ FUEL CLEAR HANDLER ============
        document.getElementById('fuel-clear')?.addEventListener('click', () => {
            ['fuel-req', 'fuel-pre', 'fuel-actual'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                if (btn) { btn.textContent = '0'; btn.classList.add('placeholder'); }
            });
            document.getElementById('fuel-sg').value = '800';
            document.getElementById('fuel-sg-btn').textContent = '0.800';
            document.getElementById('tank-left').value = '3700';
            document.getElementById('tank-left-btn').textContent = '3,700';
            document.getElementById('tank-right').value = '3700';
            document.getElementById('tank-right-btn').textContent = '3,700';
            document.getElementById('fuel-adj').value = '';
            document.getElementById('fuel-adj-btn').textContent = '0';
            calculateFuel();
            localStorage.removeItem('flightFuel');
        });

        // ============ CONVERTER CLEAR HANDLER ============
        document.getElementById('conv-clear')?.addEventListener('click', () => {
            ['conv-litres', 'conv-gallons', 'conv-lbs'].forEach(field => {
                document.getElementById(field).value = '';
                const btn = document.getElementById(field + '-btn');
                if (btn) btn.textContent = '0';
            });
        });

        // ============ LAYOVER CLEAR HANDLER ============
        document.getElementById('layover-clear')?.addEventListener('click', () => {
            document.getElementById('layover-std').value = '';
            document.getElementById('layover-std-btn').textContent = '----';
            document.getElementById('layover-pickup').value = '0130';
            document.getElementById('layover-pickup-btn').textContent = '0130';
            document.getElementById('layover-offset').value = '0';
            calculateLayover();
            localStorage.removeItem('flightLayover');
        });

        // ============ FDP SYNC FUNCTIONS ============
        var fdpSetupCollapsed = false;

        function toggleFDPSetup() {
            const content = document.getElementById('fdp-setup-content');
            const toggle = document.getElementById('fdp-setup-toggle');
            fdpSetupCollapsed = !fdpSetupCollapsed;
            if (fdpSetupCollapsed) {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            } else {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            }
        }

        function syncFromSchedule() {
            // Count actually visible sectors in Schedule tab
            let visibleSectors = 0;
            for (let s = 1; s <= 4; s++) {
                const block = document.getElementById(`sector-${s}-block`);
                if (block && block.style.display !== 'none') {
                    visibleSectors++;
                }
            }
            if (visibleSectors === 0) visibleSectors = 1; // At least 1 sector

            // Sync sector count
            currentSectorCount = visibleSectors;
            document.getElementById('fdp-sectors').value = visibleSectors.toString();
            const sectorsDisplay = document.getElementById('fdp-sectors-display');
            if (sectorsDisplay) sectorsDisplay.textContent = visibleSectors;

            // Auto-calculate report time: 1 hour before first sector STD (in local time)
            const firstStd = document.getElementById('s1-std')?.value;
            if (firstStd) {
                const stdTime = parseTime(firstStd);
                if (stdTime) {
                    // Convert STD from UTC to local time, then subtract 60 minutes for report
                    const offset = getLocalOffset();
                    let localMins = (stdTime.hours * 60 + stdTime.minutes) + (offset * 60) - 60;
                    if (localMins < 0) localMins += 1440; // Handle day wrap
                    if (localMins >= 1440) localMins -= 1440;
                    const reportHours = Math.floor(localMins / 60);
                    const reportMinutes = localMins % 60;
                    const reportTime = String(reportHours).padStart(2, '0') + String(reportMinutes).padStart(2, '0');
                    document.getElementById('fdp-report').value = reportTime;
                    document.getElementById('fdp-report-btn').textContent = reportTime;
                }
            }

            // Calculate FDP (reads directly from Schedule fields)
            calculateFDP();
            estimateDutyEnd();
        }

        // ============ SCHEDULE TAB FUNCTIONS ============

        function addSector() {
            // Find the last visible sector and the first hidden one after it
            var lastVisible = 0;
            for (var s = 1; s <= 4; s++) {
                var block = document.getElementById('sector-' + s + '-block');
                if (block && block.style.display !== 'none') {
                    lastVisible = s;
                }
            }

            // Add the next sector after the last visible one
            var nextSector = lastVisible + 1;
            if (nextSector <= 4) {
                document.getElementById('sector-' + nextSector + '-block').style.display = 'block';
                currentSectorCount = nextSector;
                document.getElementById('sched-total-sectors').textContent = currentSectorCount;

                // Update the new sector based on previous sector's current values
                updateSectorFromPrevious(nextSector);
                updateTurnaroundTimes();
                saveSchedule();
            }
        }

        function removeSector() {
            // Find the last visible sector
            var lastVisible = 0;
            for (var s = 1; s <= 4; s++) {
                var block = document.getElementById('sector-' + s + '-block');
                if (block && block.style.display !== 'none') {
                    lastVisible = s;
                }
            }

            if (lastVisible > 1) {
                // Clear the sector data before hiding
                clearSectorData(lastVisible);
                document.getElementById('sector-' + lastVisible + '-block').style.display = 'none';
                currentSectorCount = lastVisible - 1;
                document.getElementById('sched-total-sectors').textContent = currentSectorCount;
                updateTurnaroundTimes();
                saveSchedule();
            }
        }

        function clearSectorData(sectorNum) {
            ['flt', 'dep', 'arr', 'std', 'sta', 'pax', 'stand', 'out', 'off', 'on', 'in'].forEach(function(field) {
                var input = document.getElementById('s' + sectorNum + '-' + field);
                var btn = document.getElementById('s' + sectorNum + '-' + field + '-btn');
                if (input) input.value = '';
                if (btn) {
                    if (field === 'pax') btn.textContent = '---';
                    else if (field === 'flt') btn.textContent = 'FZ___';
                    else if (field === 'dep' || field === 'arr') btn.textContent = field.toUpperCase();
                    else if (field === 'stand') btn.textContent = '---';
                    else btn.textContent = '----';
                }
            });
            var blockEl = document.getElementById('s' + sectorNum + '-block');
            var flightEl = document.getElementById('s' + sectorNum + '-flight');
            if (blockEl) blockEl.textContent = '--:--';
            if (flightEl) flightEl.textContent = '--:--';
            var taEl = document.getElementById('sector-' + sectorNum + '-turnaround');
            if (taEl) {
                taEl.textContent = 'T/A: --:--';
                taEl.style.display = 'none';
            }
        }

        function updateSectorFromPrevious(sectorNum) {
            if (sectorNum <= 1) return;
            var prevSector = sectorNum - 1;

            // Increment flight number first
            var prevFlt = document.getElementById('s' + prevSector + '-flt').value;
            var newFlt = '';
            if (prevFlt) {
                var match = prevFlt.match(/^([A-Z]{2})(\d+)([A-Z]?)$/i);
                if (match) {
                    var prefix = match[1].toUpperCase();
                    var num = parseInt(match[2], 10) + 1;
                    var suffix = match[3] || '';
                    newFlt = prefix + num.toString() + suffix;
                    document.getElementById('s' + sectorNum + '-flt').value = newFlt;
                    document.getElementById('s' + sectorNum + '-flt-btn').textContent = newFlt;
                }
            }

            // Try to look up route from the new flight number
            var routeFound = false;
            if (newFlt && routeDatabase) {
                routeFound = autoFillRouteFromFlight('s' + sectorNum + '-flt', newFlt);
            }

            // Only use previous sector's ARR as DEP if route not found
            if (!routeFound) {
                var prevArr = document.getElementById('s' + prevSector + '-arr').value;
                if (prevArr) {
                    document.getElementById('s' + sectorNum + '-dep').value = prevArr;
                    document.getElementById('s' + sectorNum + '-dep-btn').textContent = prevArr;
                }
            }

            // STD = STA of previous sector + turnaround (default 1 hour)
            var prevSta = document.getElementById('s' + prevSector + '-sta').value;
            if (prevSta && prevSta.length === 4) {
                var hours = parseInt(prevSta.substring(0, 2), 10);
                var mins = parseInt(prevSta.substring(2, 4), 10);
                hours = (hours + 1) % 24; // Add 1 hour turnaround
                var newStd = hours.toString().padStart(2, '0') + mins.toString().padStart(2, '0');
                document.getElementById('s' + sectorNum + '-std').value = newStd;
                document.getElementById('s' + sectorNum + '-std-btn').textContent = newStd;
            }
        }

        function updateAllSubsequentSectors(changedSector) {
            // Update all sectors after the changed one
            for (var s = changedSector + 1; s <= currentSectorCount; s++) {
                updateSectorFromPrevious(s);
            }
            updateTurnaroundTimes();
            saveSchedule();
        }

        function updateTurnaroundTimes() {
            for (var s = 2; s <= 4; s++) {
                var taEl = document.getElementById('sector-' + s + '-turnaround');
                if (!taEl) continue;

                if (s > currentSectorCount) {
                    taEl.style.display = 'none';
                    continue;
                }

                var prevSta = document.getElementById('s' + (s - 1) + '-sta').value;
                var currStd = document.getElementById('s' + s + '-std').value;

                if (prevSta && prevSta.length === 4 && currStd && currStd.length === 4) {
                    var prevMins = parseInt(prevSta.substring(0, 2), 10) * 60 + parseInt(prevSta.substring(2, 4), 10);
                    var currMins = parseInt(currStd.substring(0, 2), 10) * 60 + parseInt(currStd.substring(2, 4), 10);
                    var diff = currMins - prevMins;
                    if (diff < 0) diff += 1440; // Handle day wrap
                    var h = Math.floor(diff / 60);
                    var m = diff % 60;
                    taEl.textContent = 'T/A: ' + h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
                    taEl.style.display = 'inline';

                    // Color based on turnaround time
                    if (diff < 45) {
                        taEl.classList.add('behind');
                        taEl.classList.remove('ahead');
                    } else if (diff >= 60) {
                        taEl.classList.add('ahead');
                        taEl.classList.remove('behind');
                    } else {
                        taEl.classList.remove('ahead', 'behind');
                    }
                } else {
                    taEl.textContent = 'T/A: --:--';
                    taEl.style.display = s <= currentSectorCount ? 'inline' : 'none';
                }
            }
        }

        function clearSchedule() {
            if (confirm('Clear all schedule data?')) {
                for (let s = 1; s <= 4; s++) {
                    ['flt', 'dep', 'arr', 'std', 'sta', 'pax', 'stand', 'out', 'off', 'on', 'in'].forEach(field => {
                        const input = document.getElementById(`s${s}-${field}`);
                        const btn = document.getElementById(`s${s}-${field}-btn`);
                        if (input) input.value = '';
                        if (btn) btn.textContent = field === 'pax' ? '---' : (field === 'flt' ? 'FZ___' : (field === 'dep' || field === 'arr' ? field.toUpperCase() : (field === 'stand' ? '---' : '----')));
                    });
                    document.getElementById(`s${s}-block`).textContent = '--:--';
                    document.getElementById(`s${s}-flight`).textContent = '--:--';
                    // Clear delay displays
                    const depDelay = document.getElementById(`s${s}-dep-delay`);
                    const arrDelay = document.getElementById(`s${s}-arr-delay`);
                    if (depDelay) { depDelay.textContent = '--'; depDelay.style.color = '#888'; }
                    if (arrDelay) { arrDelay.textContent = '--'; arrDelay.style.color = '#888'; }
                }
                document.getElementById('sched-tail').value = '';
                document.getElementById('sched-tail-btn').textContent = 'A6';
                currentSectorCount = 1;
                for (let s = 2; s <= 4; s++) {
                    document.getElementById(`sector-${s}-block`).style.display = 'none';
                }
                document.getElementById('sched-total-sectors').textContent = '1';
                document.getElementById('sched-total-block').textContent = '--:--';
                document.getElementById('sched-total-flight').textContent = '--:--';
                document.getElementById('sched-duty-time').textContent = '--:--';
                localStorage.removeItem('flightSchedule');
            }
        }

        function onScheduleChange() {
            saveSchedule();
            // Sync aircraft selection to PERF tab
            const aircraft = document.getElementById('sched-aircraft').value;
            selectAircraft(aircraft);
        }

        function saveSchedule() {
            const schedule = {
                sectorCount: currentSectorCount,
                aircraft: document.getElementById('sched-aircraft').value,
                tail: document.getElementById('sched-tail').value,
                config: document.getElementById('sched-config').value,
                sectors: []
            };
            for (let s = 1; s <= 4; s++) {
                schedule.sectors.push({
                    flt: document.getElementById(`s${s}-flt`)?.value || '',
                    dep: document.getElementById(`s${s}-dep`)?.value || '',
                    arr: document.getElementById(`s${s}-arr`)?.value || '',
                    std: document.getElementById(`s${s}-std`)?.value || '',
                    sta: document.getElementById(`s${s}-sta`)?.value || '',
                    pax: document.getElementById(`s${s}-pax`)?.value || '',
                    stand: document.getElementById(`s${s}-stand`)?.value || '',
                    out: document.getElementById(`s${s}-out`)?.value || '',
                    off: document.getElementById(`s${s}-off`)?.value || '',
                    on: document.getElementById(`s${s}-on`)?.value || '',
                    in: document.getElementById(`s${s}-in`)?.value || ''
                });
            }
            localStorage.setItem('flightSchedule', JSON.stringify(schedule));
        }

        function loadSchedule() {
            try {
                const saved = localStorage.getItem('flightSchedule');
                if (saved) {
                    const schedule = JSON.parse(saved);
                    currentSectorCount = schedule.sectorCount || 1;
                    if (schedule.aircraft) {
                        // Migrate old aircraft names to ICAO codes
                        var aircraftMap = {
                            'B737-800': 'B738',
                            'B737-8': 'B38M',
                            'B737-8 MAX': 'B38M',
                            'B737-9': 'B39M',
                            'B737-9 MAX': 'B39M'
                        };
                        var aircraft = aircraftMap[schedule.aircraft] || schedule.aircraft;
                        document.getElementById('sched-aircraft').value = aircraft;
                        document.getElementById('sched-aircraft-display').textContent = aircraft;
                    }
                    if (schedule.tail) {
                        document.getElementById('sched-tail').value = schedule.tail;
                        document.getElementById('sched-tail-btn').textContent = schedule.tail || 'A6';
                        // Populate config dropdown based on tail
                        if (typeof updateAircraftFromTail === 'function') {
                            updateAircraftFromTail(schedule.tail);
                        }
                        // Restore saved config selection
                        if (schedule.config) {
                            document.getElementById('sched-config').value = schedule.config;
                            selectedConfig = schedule.config;
                        }
                    }
                    for (let s = 1; s <= 4; s++) {
                        // Show or hide sector based on count
                        document.getElementById(`sector-${s}-block`).style.display = s <= currentSectorCount ? 'block' : 'none';
                        if (schedule.sectors && schedule.sectors[s-1]) {
                            const sector = schedule.sectors[s-1];
                            const timeFields = ['std', 'sta', 'out', 'off', 'on', 'in'];
                            Object.keys(sector).forEach(field => {
                                const input = document.getElementById(`s${s}-${field}`);
                                const btn = document.getElementById(`s${s}-${field}-btn`);
                                if (input && sector[field]) {
                                    input.value = sector[field];
                                    if (btn) {
                                        // Format time fields with padding
                                        if (timeFields.includes(field)) {
                                            btn.textContent = sector[field].toString().padStart(4, '0');
                                        } else {
                                            btn.textContent = sector[field];
                                        }
                                    }
                                }
                            });
                            // Calculate sector times after loading
                            calculateSectorTimes(s);
                        }
                    }
                    document.getElementById('sched-total-sectors').textContent = currentSectorCount;
                    // Update turnaround displays
                    if (typeof updateTurnaroundTimes === 'function') {
                        updateTurnaroundTimes();
                    }
                }
                // Default Sector 1 DEP to DXB (home base) if empty
                if (!document.getElementById('s1-dep').value) {
                    document.getElementById('s1-dep').value = 'DXB';
                    document.getElementById('s1-dep-btn').textContent = 'DXB';
                }
                // Check aircraft mismatch after loading
                if (typeof checkAircraftMismatch === 'function') {
                    checkAircraftMismatch();
                }
            } catch (e) {
                console.error('Error loading schedule:', e);
            }
        }

        // Text picker for non-numeric inputs
        function openTextPicker(fieldId, title) {
            const currentValue = document.getElementById(fieldId).value || '';
            const newValue = prompt(title + ':', currentValue);
            if (newValue !== null) {
                // Auto-capitalize the input
                const upperValue = newValue.toUpperCase();
                document.getElementById(fieldId).value = upperValue;
                document.getElementById(fieldId + '-btn').textContent = upperValue || (fieldId.includes('flt') ? 'FZ___' : (fieldId.includes('tail') ? 'A6' : '---'));

                // Dynamic update: If ARR changed, update subsequent sectors
                var arrMatch = fieldId.match(/^s(\d)-arr$/);
                if (arrMatch) {
                    updateAllSubsequentSectors(parseInt(arrMatch[1]));
                } else {
                    saveSchedule();
                }
            }
        }

        // ============ AIRCRAFT PICKER ============
        function openAircraftPicker() {
            const current = document.getElementById('sched-aircraft').value || 'B738';
            // Highlight current selection
            document.querySelectorAll('#aircraft-picker-modal .picker-btn').forEach(btn => {
                btn.style.background = 'rgba(0, 0, 0, 0.3)';
            });
            const currentBtn = document.getElementById('ac-pick-' + current.toLowerCase());
            if (currentBtn) {
                currentBtn.style.background = 'rgba(255, 130, 0, 0.4)';
            }
            document.getElementById('aircraft-picker-modal').classList.add('active');
        }

        function closeAircraftPicker() {
            document.getElementById('aircraft-picker-modal').classList.remove('active');
        }

        function selectAircraftPick(type) {
            document.getElementById('sched-aircraft').value = type;
            document.getElementById('sched-aircraft-display').textContent = type;
            closeAircraftPicker();
            onScheduleChange();
            saveSchedule();
            // Check if TOW calculator aircraft matches
            if (typeof checkAircraftMismatch === 'function') {
                checkAircraftMismatch();
            }
        }

        // ============ FLIGHT NUMBER PICKER ============
        var flightPickerFieldId = '';
        var flightPickerValue = '';
        var flightPickerSuffix = '';

        function openFlightPicker(fieldId) {
            flightPickerFieldId = fieldId;
            // Always start fresh - user can type new number immediately
            flightPickerValue = '';
            flightPickerSuffix = '';
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
            document.getElementById('flight-picker-modal').classList.add('active');
        }

        function updateFlightPickerDisplay() {
            document.getElementById('flight-picker-value').textContent = flightPickerValue || '___';
            document.getElementById('flight-picker-suffix').textContent = flightPickerSuffix;
        }

        function updateFlightSuffixButtons() {
            document.getElementById('flight-suffix-none').style.background = flightPickerSuffix === '' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
            document.getElementById('flight-suffix-a').style.background = flightPickerSuffix === 'A' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
            document.getElementById('flight-suffix-b').style.background = flightPickerSuffix === 'B' ? 'rgba(255,130,0,0.4)' : 'rgba(0,0,0,0.3)';
        }

        function flightPickerAppend(digit) {
            if (flightPickerValue.length < 4) {
                flightPickerValue += digit;
                updateFlightPickerDisplay();
            }
        }

        function flightPickerBackspace() {
            flightPickerValue = flightPickerValue.slice(0, -1);
            updateFlightPickerDisplay();
        }

        function flightPickerClear() {
            flightPickerValue = '';
            flightPickerSuffix = '';
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
        }

        function setFlightSuffix(suffix) {
            flightPickerSuffix = suffix;
            updateFlightPickerDisplay();
            updateFlightSuffixButtons();
        }

        function closeFlightPicker() {
            document.getElementById('flight-picker-modal').classList.remove('active');
            flightPickerFieldId = '';
        }

        function confirmFlightPicker() {
            if (flightPickerFieldId && flightPickerValue) {
                const fullValue = 'FZ' + flightPickerValue + flightPickerSuffix;
                document.getElementById(flightPickerFieldId).value = fullValue;
                document.getElementById(flightPickerFieldId + '-btn').textContent = fullValue;

                // Auto-fill route from database
                autoFillRouteFromFlight(flightPickerFieldId, fullValue);

                // Dynamic update: Update subsequent sectors with new flight number
                var sectorMatch = flightPickerFieldId.match(/^s(\d)-flt$/);
                if (sectorMatch) {
                    updateAllSubsequentSectors(parseInt(sectorMatch[1]));
                } else {
                    saveSchedule();
                }
            }
            closeFlightPicker();
        }

        function autoFillRouteFromFlight(fieldId, flightNumber) {
            if (!routeDatabase) return false;

            // Extract sector number from field ID (e.g., "s1-flt" -> 1)
            var sectorMatch = fieldId.match(/^s(\d+)-flt$/);
            if (!sectorMatch) return false;
            var sectorNum = sectorMatch[1];

            // Parse flight number
            var fltMatch = flightNumber.match(/^([A-Z]{2,3})(\d+[A-Z]?)$/i);
            if (!fltMatch) return false;

            var airlineCode = fltMatch[1].toUpperCase();
            var flightNum = fltMatch[2].toUpperCase();

            // Convert IATA to ICAO
            var icaoCode = airlineIataToIcao[airlineCode] || airlineCode;

            // Look up route
            if (routeDatabase[icaoCode] && routeDatabase[icaoCode][flightNum]) {
                var routeIcao = routeDatabase[icaoCode][flightNum];
                var airports = routeIcao.split('-');

                if (airports.length >= 2) {
                    // Get IATA codes
                    var depIcao = airports[0];
                    var arrIcao = airports[airports.length - 1]; // Last airport for multi-stop

                    var depIata = (airportsDatabase && airportsDatabase[depIcao] && airportsDatabase[depIcao].i)
                                  ? airportsDatabase[depIcao].i : depIcao;
                    var arrIata = (airportsDatabase && airportsDatabase[arrIcao] && airportsDatabase[arrIcao].i)
                                  ? airportsDatabase[arrIcao].i : arrIcao;

                    // Fill DEP and ARR fields
                    var depInput = document.getElementById('s' + sectorNum + '-dep');
                    var depBtn = document.getElementById('s' + sectorNum + '-dep-btn');
                    var arrInput = document.getElementById('s' + sectorNum + '-arr');
                    var arrBtn = document.getElementById('s' + sectorNum + '-arr-btn');

                    if (depInput && depBtn) {
                        depInput.value = depIata;
                        depBtn.textContent = depIata;
                    }
                    if (arrInput && arrBtn) {
                        arrInput.value = arrIata;
                        arrBtn.textContent = arrIata;
                    }
                    return true; // Route found and filled
                }
            }
            return false; // Route not found
        }

        // ============ TAIL NUMBER PICKER ============
        var tailPickerValue = '';
        var tailSelectedPrefix = '';

        // Valid last letters for each fleet prefix (from fleet database)
        var fleetValidLetters = {
            'FE': ['B', 'C', 'D', 'E', 'G', 'K', 'M', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X'],
            'FG': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'],
            'FK': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T'],
            'FM': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
            'FN': ['A', 'B', 'C'],
            'FP': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'],
            'FQ': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L']
        };

        var tailPickerContext = 'schedule'; // 'schedule' or 'lmc'

        function openTailPicker(context) {
            tailPickerContext = context || 'schedule';
            var currentValue = '';
            if (tailPickerContext === 'lmc') {
                currentValue = document.getElementById('lmc-tail').value || '';
            } else {
                currentValue = document.getElementById('sched-tail').value || '';
            }
            tailPickerValue = currentValue.replace(/^A6-/i, '');
            tailSelectedPrefix = '';
            updateTailPickerDisplay();
            updateTailLettersGrid(null); // Show full alphabet initially
            document.getElementById('tail-picker-modal').classList.add('active');
        }

        function updateTailPickerDisplay() {
            document.getElementById('tail-picker-value').textContent = tailPickerValue || '___';
        }

        function tailPickerSetPrefix(prefix) {
            tailPickerValue = prefix;
            tailSelectedPrefix = prefix;
            updateTailPickerDisplay();
            updateTailLettersGrid(prefix);
        }

        function updateTailLettersGrid(prefix) {
            var grid = document.getElementById('tail-letters-grid');
            var validLetters = prefix ? fleetValidLetters[prefix] : null;
            var html = '';
            var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

            alphabet.forEach(function(letter) {
                var isValid = !validLetters || validLetters.includes(letter);
                if (isValid) {
                    html += '<button class="picker-btn" onclick="tailPickerAppend(\'' + letter + '\')" style="min-width: 0; padding: 12px 0;">' + letter + '</button>';
                } else {
                    html += '<button class="picker-btn" style="min-width: 0; padding: 12px 0; opacity: 0.2; pointer-events: none;"> </button>';
                }
            });

            // Add Clear and Backspace buttons
            html += '<button class="picker-btn clear" onclick="tailPickerClear()" style="min-width: 0; padding: 12px 0;">C</button>';
            html += '<button class="picker-btn" onclick="tailPickerBackspace()" style="min-width: 0; padding: 12px 0;">â†</button>';

            grid.innerHTML = html;
        }

        function tailPickerAppend(char) {
            if (tailPickerValue.length < 3) {
                tailPickerValue += char;
                updateTailPickerDisplay();
                // Auto-confirm if we have 3 characters
                if (tailPickerValue.length === 3) {
                    confirmTailPicker();
                }
            }
        }

        function tailPickerBackspace() {
            tailPickerValue = tailPickerValue.slice(0, -1);
            // If we delete back to just the prefix, keep the grid filtered
            if (tailPickerValue.length === 2 && fleetValidLetters[tailPickerValue]) {
                tailSelectedPrefix = tailPickerValue;
            } else if (tailPickerValue.length < 2) {
                tailSelectedPrefix = '';
                updateTailLettersGrid(null);
            }
            updateTailPickerDisplay();
        }

        function tailPickerClear() {
            tailPickerValue = '';
            tailSelectedPrefix = '';
            updateTailPickerDisplay();
            updateTailLettersGrid(null);
        }

        function closeTailPicker() {
            document.getElementById('tail-picker-modal').classList.remove('active');
        }

        function confirmTailPicker() {
            if (tailPickerContext === 'lmc') {
                setLmcTail(tailPickerValue);
                closeTailPicker();
            } else {
                var fullValue = tailPickerValue ? 'A6-' + tailPickerValue : '';
                document.getElementById('sched-tail').value = fullValue;
                document.getElementById('sched-tail-btn').textContent = fullValue || 'A6';
                closeTailPicker();

                // Auto-fill aircraft type and config from fleet database
                updateAircraftFromTail(fullValue);
                saveSchedule();
            }
        }

        // ============ STAND PICKER ============
        var standPickerValue = '';
        var standPickerFieldId = '';

        function openStandPicker(fieldId) {
            standPickerFieldId = fieldId;
            var currentValue = document.getElementById(fieldId).value || '';
            standPickerValue = currentValue;
            updateStandPickerDisplay();
            document.getElementById('stand-picker-modal').classList.add('active');
        }

        function updateStandPickerDisplay() {
            document.getElementById('stand-picker-value').textContent = standPickerValue || '---';
        }

        function standPickerAppend(char) {
            if (standPickerValue.length < 4) {
                standPickerValue += char;
                updateStandPickerDisplay();
            }
        }

        function standPickerBackspace() {
            standPickerValue = standPickerValue.slice(0, -1);
            updateStandPickerDisplay();
        }

        function standPickerClear() {
            standPickerValue = '';
            updateStandPickerDisplay();
        }

        function closeStandPicker() {
            document.getElementById('stand-picker-modal').classList.remove('active');
        }

        function confirmStandPicker() {
            document.getElementById(standPickerFieldId).value = standPickerValue;
            document.getElementById(standPickerFieldId + '-btn').textContent = standPickerValue || '---';
            closeStandPicker();
            saveSchedule();
        }

        // Global selected config for use across tabs
        var selectedConfig = '';
        var selectedAircraftType = '';

        function updateAircraftFromTail(tailNumber) {
            var aircraftDisplay = document.getElementById('sched-aircraft-display');
            var aircraftInput = document.getElementById('sched-aircraft');
            var configSelect = document.getElementById('sched-config');

            if (!tailNumber || !fleetData || !fleetData.aircraft) {
                aircraftDisplay.textContent = '---';
                aircraftDisplay.style.color = '#888';
                aircraftInput.value = '';
                configSelect.innerHTML = '<option value="">Select tail first</option>';
                selectedConfig = '';
                selectedAircraftType = '';
                return;
            }

            var ac = fleetData.aircraft[tailNumber];
            if (ac) {
                // Set aircraft type
                selectedAircraftType = ac.type;
                aircraftDisplay.textContent = ac.type;
                aircraftDisplay.style.color = '#00d4ff';
                aircraftInput.value = ac.type;

                // Populate config dropdown based on aircraft type
                populateConfigDropdown(ac.type, ac.config);
            } else {
                aircraftDisplay.textContent = '---';
                aircraftDisplay.style.color = '#888';
                aircraftInput.value = '';
                configSelect.innerHTML = '<option value="">Tail not in fleet</option>';
                selectedConfig = '';
                selectedAircraftType = '';
            }
        }

        function populateConfigDropdown(aircraftType, defaultConfig) {
            var configSelect = document.getElementById('sched-config');
            configSelect.innerHTML = '';

            // Parse config like "10J156Y/166Y" into ["10J/156Y", "10J/166Y"]
            // Or "186Y" stays as ["186Y"]
            var configs = parseConfigOptions(defaultConfig);

            // Add options
            configs.forEach(function(cfg, index) {
                var option = document.createElement('option');
                option.value = cfg;
                option.textContent = cfg;
                if (index === 0) {
                    option.selected = true;
                    selectedConfig = cfg;
                }
                configSelect.appendChild(option);
            });

            // Trigger config change to update other tabs
            onConfigChange();
        }

        // Parse config string into selectable options
        // "10J156Y/166Y" -> ["10J156Y", "166Y"] (10 business+156 eco OR 166 all eco)
        // "12J162Y/174Y" -> ["12J162Y", "174Y"] (12 business+162 eco OR 174 all eco)
        // "16J156Y/172Y" -> ["16J156Y", "172Y"] (16 business+156 eco OR 172 all eco)
        // "186Y" -> ["186Y"]
        function parseConfigOptions(config) {
            if (!config) return [];

            // Check if it has the pattern {digits}J{digits}Y/{digits}Y
            var match = config.match(/^(\d+J)(\d+Y)\/(\d+Y)$/);
            if (match) {
                // Split into two options:
                // First: business + economy (e.g., "10J156Y")
                // Second: all economy (e.g., "166Y")
                return [
                    match[1] + match[2],  // e.g., "10J156Y" (10 business + 156 economy)
                    match[3]              // e.g., "166Y" (all economy)
                ];
            }

            // Single config like "186Y" - just return as-is
            return [config];
        }

        function onConfigChange() {
            var configSelect = document.getElementById('sched-config');
            selectedConfig = configSelect.value;

            // Update LMC calculator config if it exists
            var lmcConfigEl = document.getElementById('lmc-config');
            if (lmcConfigEl && selectedConfig) {
                lmcConfigEl.value = selectedConfig;
            }

            // Update any other tabs that need config
            saveSchedule();
        }

        // ============ TIME TAB FUNCTIONS ============
        function setCurrentUTC() {
            const now = new Date();
            const utcHours = String(now.getUTCHours()).padStart(2, '0');
            const utcMins = String(now.getUTCMinutes()).padStart(2, '0');
            const timeStr = utcHours + utcMins;
            document.getElementById('time-tz-input').value = timeStr;
            document.getElementById('time-tz-input-btn').textContent = timeStr;
            calculateTimeTabTimezones();
        }

        function calculateTimeTabTimezones() {
            const inputStr = document.getElementById('time-tz-input').value;
            const inputZone = parseFloat(document.getElementById('time-tz-zone').value);
            const outputZone = parseFloat(document.getElementById('time-tz-output-zone').value);
            if (!inputStr || inputStr.length < 3) return;

            const input = parseTime(inputStr);
            if (!input) return;

            const utcMins = input.hours * 60 + input.minutes - (inputZone * 60);
            const formatTimeOffset = (mins) => {
                let m = ((mins % 1440) + 1440) % 1440;
                const h = Math.floor(m / 60);
                const min = m % 60;
                return String(h).padStart(2, '0') + ':' + String(min).padStart(2, '0');
            };

            document.getElementById('time-tz-utc').textContent = formatTimeOffset(utcMins);
            document.getElementById('time-tz-dxb').textContent = formatTimeOffset(utcMins + 240);
            document.getElementById('time-tz-custom').textContent = formatTimeOffset(utcMins + (outputZone * 60));
        }

        function clearTimeTabTimezones() {
            document.getElementById('time-tz-input').value = '';
            document.getElementById('time-tz-input-btn').textContent = '----';
            document.getElementById('time-tz-utc').textContent = '--:--';
            document.getElementById('time-tz-dxb').textContent = '--:--';
            document.getElementById('time-tz-custom').textContent = '--:--';
        }

        // Helper to format minutes as h:mm or just minutes
        function formatMinutesDisplay(mins) {
            if (!mins || mins <= 0) return '---';
            var h = Math.floor(mins / 60);
            var m = mins % 60;
            if (h > 0 && m > 0) {
                return h + 'h' + m + 'm';
            } else if (h > 0) {
                return h + 'h';
            } else {
                return m + 'm';
            }
        }

        // Open duration picker for SDT time fields
        function openSDTDuration(fieldId) {
            openDurationPicker(fieldId, 'Enter Time', function(mins) {
                document.getElementById(fieldId).value = mins;
                document.getElementById(fieldId + '-btn').textContent = formatMinutesDisplay(mins);
                // Trigger calculation
                if (fieldId === 'sdt1-time') calculateSDT1();
                else if (fieldId === 'sdt3-time') calculateSDT3();
            });
        }

        // Open duration picker for catch-up time field
        function openCatchupDuration(fieldId) {
            openDurationPicker(fieldId, 'Time Limit', function(mins) {
                document.getElementById(fieldId).value = mins;
                document.getElementById(fieldId + '-btn').textContent = formatMinutesDisplay(mins);
            });
        }

        // Row 1: Speed Ã— Time = Distance
        function calculateSDT1() {
            const speed = parseFloat(document.getElementById('sdt1-speed').value) || 0;
            const time = parseFloat(document.getElementById('sdt1-time').value) || 0;
            if (speed > 0 && time > 0) {
                const dist = Math.round((speed * time) / 60);
                document.getElementById('sdt1-result').textContent = dist + ' nm';
            } else {
                document.getElementById('sdt1-result').textContent = '--- nm';
            }
        }

        // Row 2: Distance Ã· Speed = Time
        function calculateSDT2() {
            const dist = parseFloat(document.getElementById('sdt2-dist').value) || 0;
            const speed = parseFloat(document.getElementById('sdt2-speed').value) || 0;
            if (dist > 0 && speed > 0) {
                const time = Math.round((dist / speed) * 60);
                document.getElementById('sdt2-result').textContent = time + ' min';
            } else {
                document.getElementById('sdt2-result').textContent = '--- min';
            }
        }

        // Row 3: Distance Ã· Time = Speed
        function calculateSDT3() {
            const dist = parseFloat(document.getElementById('sdt3-dist').value) || 0;
            const time = parseFloat(document.getElementById('sdt3-time').value) || 0;
            if (dist > 0 && time > 0) {
                const speed = Math.round((dist / time) * 60);
                document.getElementById('sdt3-result').textContent = speed + ' kts';
            } else {
                document.getElementById('sdt3-result').textContent = '--- kts';
            }
        }

        function clearAllSDT() {
            ['sdt1-speed', 'sdt1-time', 'sdt2-dist', 'sdt2-speed', 'sdt3-dist', 'sdt3-time'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
            });
            document.getElementById('sdt1-result').textContent = '--- nm';
            document.getElementById('sdt2-result').textContent = '--- min';
            document.getElementById('sdt3-result').textContent = '--- kts';
        }

        // ============ CATCH-UP CALCULATOR ============
        function calculateCatchUp(solve) {
            const dist = parseFloat(document.getElementById('catchup-dist').value) || 0;
            const theirGS = parseFloat(document.getElementById('catchup-their-gs').value) || 0;
            const yourGS = parseFloat(document.getElementById('catchup-your-gs').value) || 0;
            const timeLimit = parseFloat(document.getElementById('catchup-time').value) || 0;
            let result = '---';
            let color = '#00ff88';

            if (solve === 'time') {
                // Calculate time to catch up: Distance / (YourGS - TheirGS)
                if (dist > 0 && yourGS > theirGS) {
                    const gsDiff = yourGS - theirGS;
                    const timeHours = dist / gsDiff;
                    const timeMins = Math.round(timeHours * 60);
                    const hours = Math.floor(timeMins / 60);
                    const mins = timeMins % 60;
                    if (hours > 0) {
                        result = hours + 'h ' + mins + 'm to catch up';
                    } else {
                        result = timeMins + ' min to catch up';
                    }
                } else if (yourGS <= theirGS && dist > 0) {
                    result = 'Cannot catch up (too slow)';
                    color = '#ff5252';
                }
            } else if (solve === 'speed') {
                // Calculate speed required: (Distance / Time) + TheirGS
                if (dist > 0 && timeLimit > 0 && theirGS > 0) {
                    const timeHours = timeLimit / 60;
                    const requiredGS = Math.round((dist / timeHours) + theirGS);
                    result = requiredGS + ' kts required';
                    if (requiredGS > 500) {
                        color = '#ffd700'; // Yellow warning for high speed
                    }
                }
            }

            const resultEl = document.getElementById('catchup-result');
            resultEl.textContent = result;
            resultEl.style.color = color;
        }

        function clearCatchUp() {
            ['catchup-dist', 'catchup-their-gs', 'catchup-your-gs', 'catchup-time'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
            });
            document.getElementById('catchup-result').textContent = '---';
            document.getElementById('catchup-result').style.color = '#00ff88';
        }

        // GPS autofill for speed fields
        function fillSpeedFromGps(fieldId) {
            if (currentGpsSpeed !== null && currentGpsSpeed > 0) {
                document.getElementById(fieldId).value = currentGpsSpeed;
                document.getElementById(fieldId + '-btn').textContent = currentGpsSpeed;
            } else {
                alert('No GPS speed available');
            }
        }

        // ============ NOTES TAB FUNCTIONS ============
        function saveNotesScratchpad() {
            const content = document.getElementById('notes-scratchpad').value.trim();
            if (!content) return;

            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                content: content
            });
            if (history.length > 20) history.pop();
            localStorage.setItem('notesScratchpadHistory', JSON.stringify(history));
            renderNotesScratchpadHistory();
        }

        function clearNotesScratchpad() {
            document.getElementById('notes-scratchpad').value = '';
            localStorage.setItem('notesScratchpadCurrent', '');
        }

        function loadNotesScratchpad() {
            // Load current notes
            const current = localStorage.getItem('notesScratchpadCurrent');
            if (current) {
                document.getElementById('notes-scratchpad').value = current;
            }
            // Load history
            renderNotesScratchpadHistory();
        }

        function renderNotesScratchpadHistory() {
            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            const container = document.getElementById('notes-scratchpad-history');
            if (!container) return;

            container.innerHTML = history.map((item, index) => `
                <div class="scratchpad-history-item">
                    <div class="history-timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                    <div class="history-content">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</div>
                    <button class="history-delete" onclick="deleteNotesHistoryItem(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function deleteNotesHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('notesScratchpadHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('notesScratchpadHistory', JSON.stringify(history));
            renderNotesScratchpadHistory();
        }

        // ============ SETTINGS TAB FUNCTIONS ============
        function quickResetAll() {
            if (confirm('Reset all data except notes? This cannot be undone.')) {
                // Clear schedule
                localStorage.removeItem('flightSchedule');
                // Clear timers
                localStorage.removeItem('flightTimers');
                // Clear OOOI
                localStorage.removeItem('flightOOOI');
                // Clear ETA
                localStorage.removeItem('flightETA');
                // Clear TOW
                localStorage.removeItem('flightTOW');
                // Clear ACC
                localStorage.removeItem('flightACC');
                // Clear Fuel
                localStorage.removeItem('flightFuel');
                // Clear Layover
                localStorage.removeItem('flightLayover');
                // Clear FDP
                localStorage.removeItem('flightFDP');

                // Reload page to reset all values
                location.reload();
            }
        }

        // ============ FLIGHT ROUTE LOOKUP ============
        var routeDatabase = null;
        var airportsDatabase = null;

        // IATA to ICAO airline code mapping
        var airlineIataToIcao = {
            // Gulf
            'FZ': 'FDB', 'EK': 'UAE', 'EY': 'ETD', 'GF': 'GFA', 'QR': 'QTR',
            'SV': 'SVA', 'WY': 'OMA', 'KU': 'KAC', 'RJ': 'RJA', 'TK': 'THY',
            // Indian
            'AI': 'AIC', 'IX': 'AXB', '6E': 'IGO', 'SG': 'SEJ',
            '9W': 'JAI', 'G8': 'GOW', 'QP': 'AKJ',
            // Pakistani
            'PK': 'PIA', 'PA': 'ABQ'
        };

        // Load route database
        fetch('/dashboard/routes.json')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                routeDatabase = data;
                var totalRoutes = Object.values(data).reduce(function(sum, routes) {
                    return sum + Object.keys(routes).length;
                }, 0);
                var statusEl = document.getElementById('route-status');
                if (statusEl) {
                    statusEl.textContent = Object.keys(data).length + ' airlines, ' + totalRoutes.toLocaleString() + ' routes loaded';
                    statusEl.style.color = '#00ff88';
                }
            })
            .catch(function(err) {
                var statusEl = document.getElementById('route-status');
                if (statusEl) {
                    statusEl.textContent = 'Failed to load route database';
                    statusEl.style.color = '#ff5252';
                }
            });

        // Load airports database for ICAO to IATA conversion
        fetch('/dashboard/airports.json')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                airportsDatabase = data;
            })
            .catch(function(err) {
                console.log('Airports database not loaded');
            });

        // ============ OM-C AIRFIELD AUTHORIZATION DATABASE ============
        var omcAirfieldsDatabase = null;

        // Load OM-C airfield authorizations
        fetch('/dashboard/database/aerodrome_briefings.json')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                omcAirfieldsDatabase = data;
                console.log('OM-C database loaded: ' + data.airfields.length + ' airfields');
            })
            .catch(function(err) {
                console.log('OM-C airfield database not loaded:', err);
            });

        // REF Tab Switcher
        var refSwitcherIndex = 0;

        function updateRefSwitcher() {
            var airports = getUniqueAirports();
            var switcher = document.getElementById('ref-switcher');
            var display = document.getElementById('ref-switcher-display');

            if (airports.length > 0) {
                switcher.style.display = 'flex';
                if (refSwitcherIndex >= airports.length) refSwitcherIndex = 0;
                var apt = airports[refSwitcherIndex];
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + apt + '</span> <span style="color: #888;">(' + (refSwitcherIndex + 1) + '/' + airports.length + ')</span>';
                document.getElementById('ref-airport-code').value = apt;
                lookupAirfieldAuth();
            } else {
                switcher.style.display = 'none';
            }
        }

        function refSwitcherPrev() {
            var airports = getUniqueAirports();
            if (airports.length === 0) return;
            refSwitcherIndex = (refSwitcherIndex - 1 + airports.length) % airports.length;
            updateRefSwitcher();
        }

        function refSwitcherNext() {
            var airports = getUniqueAirports();
            if (airports.length === 0) return;
            refSwitcherIndex = (refSwitcherIndex + 1) % airports.length;
            updateRefSwitcher();
        }

        function lookupAirfieldAuth() {
            var code = document.getElementById('ref-airport-code').value.toUpperCase().trim();
            var resultsEl = document.getElementById('ref-results');
            var notFoundEl = document.getElementById('ref-not-found');

            resultsEl.style.display = 'none';
            notFoundEl.style.display = 'none';

            if (!code || !omcAirfieldsDatabase) {
                return;
            }

            // Search by ICAO or IATA
            var airfield = omcAirfieldsDatabase.airfields.find(function(a) {
                return a.icao === code || a.iata === code;
            });

            if (!airfield) {
                notFoundEl.style.display = 'block';
                return;
            }

            // Display results
            resultsEl.style.display = 'block';
            document.getElementById('ref-airport-name').textContent = airfield.name;
            document.getElementById('ref-airport-codes').textContent = airfield.icao + ' / ' + airfield.iata;

            // Category styling
            var categoryEl = document.getElementById('ref-category');
            var catColors = {
                'A': { bg: 'rgba(255, 100, 100, 0.2)', border: '#ff6464', text: '#ff6464' },
                'B': { bg: 'rgba(255, 180, 0, 0.2)', border: '#ffb400', text: '#ffb400' },
                'C': { bg: 'rgba(0, 255, 136, 0.2)', border: '#00ff88', text: '#00ff88' }
            };
            var catStyle = catColors[airfield.category] || catColors['C'];
            categoryEl.style.background = catStyle.bg;
            categoryEl.style.border = '1px solid ' + catStyle.border;
            categoryEl.innerHTML = '<span style="color: ' + catStyle.text + '; font-weight: bold; font-size: 1.2rem;">Category ' + airfield.category + '</span>';

            // Restrictions
            var restrictEl = document.getElementById('ref-restrictions');
            var restrictTextEl = document.getElementById('ref-restrictions-text');
            if (airfield.restrictions && airfield.restrictions.trim()) {
                restrictEl.style.display = 'block';
                restrictTextEl.textContent = airfield.restrictions;
            } else {
                restrictEl.style.display = 'none';
            }

            // Authorization statuses
            var auths = airfield.authorizations;
            setAuthStatus('ref-dest-status', 'ref-auth-dest', auths.destination);
            setAuthStatus('ref-alt-status', 'ref-auth-alt', auths.alternate);
            setAuthStatus('ref-enr-status', 'ref-auth-enr', auths.enroute_alternate);
            setAuthStatus('ref-emerg-status', 'ref-auth-emerg', auths.emergency_alternate);
            setAuthStatus('ref-etops-status', 'ref-auth-etops', auths.etops_alternate);
        }

        function setAuthStatus(statusId, itemId, authorized) {
            var statusEl = document.getElementById(statusId);
            var itemEl = document.getElementById(itemId);
            if (authorized) {
                statusEl.textContent = 'YES';
                statusEl.style.color = '#00ff88';
                itemEl.style.background = 'rgba(0, 255, 136, 0.1)';
                itemEl.style.borderColor = 'rgba(0, 255, 136, 0.3)';
            } else {
                statusEl.textContent = 'NO';
                statusEl.style.color = '#ff6464';
                itemEl.style.background = 'rgba(255, 100, 100, 0.1)';
                itemEl.style.borderColor = 'rgba(255, 100, 100, 0.3)';
            }
        }

        function lookupFlightRoute() {
            var input = document.getElementById('route-flight-input').value.toUpperCase().trim();
            var resultEl = document.getElementById('route-result');
            var icaoEl = document.getElementById('route-icao');

            if (!input || !routeDatabase) {
                resultEl.textContent = '---';
                icaoEl.textContent = '---';
                return;
            }

            // Parse flight number - extract airline code and number
            var match = input.match(/^([A-Z]{2,3})(\d+[A-Z]?)$/);
            if (!match) {
                resultEl.textContent = 'Invalid format';
                resultEl.style.color = '#ff5252';
                icaoEl.textContent = 'Use format: FZ307, EK1';
                return;
            }

            var airlineCode = match[1];
            var flightNum = match[2];

            // Convert IATA to ICAO if needed
            var icaoCode = airlineIataToIcao[airlineCode] || airlineCode;

            // Look up route
            if (routeDatabase[icaoCode] && routeDatabase[icaoCode][flightNum]) {
                var routeIcao = routeDatabase[icaoCode][flightNum];
                var routeIata = icaoToIataRoute(routeIcao);

                resultEl.textContent = routeIata;
                resultEl.style.color = '#00ff88';
                icaoEl.textContent = icaoCode + flightNum + ': ' + routeIcao;
            } else {
                resultEl.textContent = 'Not found';
                resultEl.style.color = '#ff5252';
                icaoEl.textContent = icaoCode + flightNum + ' not in database';
            }
        }

        function icaoToIataRoute(icaoRoute) {
            if (!airportsDatabase) return icaoRoute;

            var parts = icaoRoute.split('-');
            var iataParts = parts.map(function(icao) {
                if (airportsDatabase[icao] && airportsDatabase[icao].i) {
                    return airportsDatabase[icao].i;
                }
                return icao;
            });
            return iataParts.join('-');
        }

        // ============ CALLSIGN / ROUTE LOOKUP ============
        function iataToIcaoAirport(iata) {
            if (!airportsDatabase) return iata;
            // Search for IATA code in airports database
            for (var icao in airportsDatabase) {
                if (airportsDatabase[icao].i === iata) {
                    return icao;
                }
            }
            return iata; // Return as-is if not found (might already be ICAO)
        }

        function lookupCallsign() {
            var input = document.getElementById('callsign-input').value.toUpperCase().trim();
            var resultsEl = document.getElementById('callsign-results');

            if (!input) {
                resultsEl.innerHTML = '<div style="text-align: center; color: #888;">Enter a callsign or route to search</div>';
                return;
            }

            if (!routeDatabase) {
                resultsEl.innerHTML = '<div style="text-align: center; color: #ff5252;">Route database not loaded</div>';
                return;
            }

            var matches = [];
            var isRouteSearch = input.indexOf('-') !== -1;

            if (isRouteSearch) {
                // Route search - find all flights for this route
                var parts = input.split('-');
                var searchRouteIcao = '';

                // Convert IATA to ICAO if needed
                if (parts.length >= 2) {
                    var dep = parts[0].length === 3 ? iataToIcaoAirport(parts[0]) : parts[0];
                    var arr = parts[1].length === 3 ? iataToIcaoAirport(parts[1]) : parts[1];
                    searchRouteIcao = dep + '-' + arr;
                    if (parts.length > 2) {
                        // Handle multi-leg routes
                        for (var i = 2; i < parts.length; i++) {
                            var leg = parts[i].length === 3 ? iataToIcaoAirport(parts[i]) : parts[i];
                            searchRouteIcao += '-' + leg;
                        }
                    }
                }

                Object.keys(routeDatabase).forEach(function(airlineIcao) {
                    var flights = routeDatabase[airlineIcao];
                    Object.keys(flights).forEach(function(flightNum) {
                        var routeIcao = flights[flightNum];
                        // Check if route matches (exact or contains)
                        if (routeIcao === searchRouteIcao || routeIcao.indexOf(searchRouteIcao) !== -1) {
                            var routeIata = icaoToIataRoute(routeIcao);
                            matches.push({
                                airline: airlineIcao,
                                flight: flightNum,
                                routeIcao: routeIcao,
                                routeIata: routeIata,
                                exact: routeIcao === searchRouteIcao
                            });
                        }
                    });
                });
            } else {
                // Callsign search
                Object.keys(routeDatabase).forEach(function(airlineIcao) {
                    var flights = routeDatabase[airlineIcao];
                    Object.keys(flights).forEach(function(flightNum) {
                        if (flightNum.toUpperCase() === input || flightNum.toUpperCase().indexOf(input) === 0) {
                            var routeIcao = flights[flightNum];
                            var routeIata = icaoToIataRoute(routeIcao);
                            matches.push({
                                airline: airlineIcao,
                                flight: flightNum,
                                routeIcao: routeIcao,
                                routeIata: routeIata,
                                exact: flightNum.toUpperCase() === input
                            });
                        }
                    });
                });
            }

            // Sort: exact matches first, then by flight number
            matches.sort(function(a, b) {
                if (a.exact && !b.exact) return -1;
                if (!a.exact && b.exact) return 1;
                // Sort numerically if possible
                var aNum = parseInt(a.flight, 10);
                var bNum = parseInt(b.flight, 10);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                return (a.airline + a.flight).localeCompare(b.airline + b.flight);
            });

            if (matches.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; color: #ff5252;">No matches found for "' + input + '"</div>';
                return;
            }

            // Limit to 50 results for route searches
            var limit = isRouteSearch ? 50 : 20;
            var displayMatches = matches.slice(0, limit);
            var html = '';

            if (isRouteSearch) {
                html += '<div style="text-align: center; color: #00d4ff; padding: 10px; border-bottom: 1px solid rgba(255,130,0,0.3);">' + matches.length + ' flight(s) found</div>';
            }

            displayMatches.forEach(function(m) {
                html += '<div style="padding: 10px; border-bottom: 1px solid rgba(255,130,0,0.2); display: flex; justify-content: space-between; align-items: center;">';
                html += '<div>';
                html += '<span style="color: #00d4ff; font-weight: bold; font-size: 1.3rem;">' + m.flight + '</span>';
                html += '<span style="color: #888; font-size: 0.85rem; margin-left: 8px;">(' + m.airline + ')</span>';
                html += '</div>';
                html += '<div style="text-align: right;">';
                html += '<div style="color: #00ff88; font-size: 1.1rem;">' + m.routeIata + '</div>';
                html += '<div style="color: #888; font-size: 0.8rem;">' + m.routeIcao + '</div>';
                html += '</div>';
                html += '</div>';
            });

            if (matches.length > limit) {
                html += '<div style="text-align: center; color: #888; padding: 10px;">...and ' + (matches.length - limit) + ' more matches</div>';
            }

            resultsEl.innerHTML = html;
        }

        // ============ REGISTRATION PREFIX LOOKUP ============
        var regPrefixData = {
            // ISO2 to country name mapping (official names)
            'AD': 'Andorra', 'AE': 'United Arab Emirates', 'AF': 'Afghanistan', 'AG': 'Antigua and Barbuda',
            'AI': 'Anguilla', 'AL': 'Albania', 'AM': 'Armenia', 'AO': 'Angola', 'AR': 'Argentina',
            'AT': 'Austria', 'AU': 'Australia', 'AW': 'Aruba', 'AZ': 'Azerbaijan',
            'BA': 'Bosnia and Herzegovina', 'BB': 'Barbados', 'BD': 'Bangladesh', 'BE': 'Belgium',
            'BF': 'Burkina Faso', 'BG': 'Bulgaria', 'BH': 'Bahrain', 'BI': 'Burundi', 'BJ': 'Benin',
            'BM': 'Bermuda', 'BN': 'Brunei', 'BO': 'Bolivia', 'BR': 'Brazil', 'BS': 'Bahamas',
            'BT': 'Bhutan', 'BW': 'Botswana', 'BY': 'Belarus', 'BZ': 'Belize',
            'CA': 'Canada', 'CD': 'Congo (Kinshasa)', 'CF': 'Central African Republic',
            'CG': 'Congo (Brazzaville)', 'CH': 'Switzerland', 'CI': "CÃ´te d'Ivoire", 'CK': 'Cook Islands',
            'CL': 'Chile', 'CM': 'Cameroon', 'CN': 'China', 'CO': 'Colombia', 'CR': 'Costa Rica',
            'CU': 'Cuba', 'CV': 'Cape Verde', 'CY': 'Cyprus', 'CZ': 'Czech Republic',
            'DE': 'Germany', 'DJ': 'Djibouti', 'DK': 'Denmark', 'DM': 'Dominica', 'DO': 'Dominican Republic',
            'DZ': 'Algeria', 'EC': 'Ecuador', 'EE': 'Estonia', 'EG': 'Egypt', 'ER': 'Eritrea',
            'ES': 'Spain', 'ET': 'Ethiopia', 'FI': 'Finland', 'FJ': 'Fiji', 'FK': 'Falkland Islands',
            'FM': 'Micronesia', 'FR': 'France', 'GA': 'Gabon', 'GB': 'United Kingdom', 'GD': 'Grenada',
            'GE': 'Georgia', 'GF': 'French Guiana', 'GG': 'Guernsey', 'GH': 'Ghana', 'GI': 'Gibraltar',
            'GM': 'Gambia', 'GN': 'Guinea', 'GQ': 'Equatorial Guinea', 'GR': 'Greece', 'GT': 'Guatemala',
            'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HK': 'Hong Kong', 'HN': 'Honduras', 'HR': 'Croatia',
            'HT': 'Haiti', 'HU': 'Hungary', 'ID': 'Indonesia', 'IE': 'Ireland', 'IL': 'Israel',
            'IM': 'Isle of Man', 'IN': 'India', 'IQ': 'Iraq', 'IR': 'Iran', 'IS': 'Iceland', 'IT': 'Italy',
            'JE': 'Jersey', 'JM': 'Jamaica', 'JO': 'Jordan', 'JP': 'Japan', 'KE': 'Kenya',
            'KG': 'Kyrgyzstan', 'KH': 'Cambodia', 'KI': 'Kiribati', 'KM': 'Comoros',
            'KN': 'Saint Kitts and Nevis', 'KP': 'North Korea', 'KR': 'South Korea', 'KS': 'Kosovo',
            'KW': 'Kuwait', 'KY': 'Cayman Islands', 'KZ': 'Kazakhstan', 'LA': 'Laos', 'LB': 'Lebanon',
            'LC': 'Saint Lucia', 'LK': 'Sri Lanka', 'LR': 'Liberia', 'LS': 'Lesotho', 'LT': 'Lithuania',
            'LU': 'Luxembourg', 'LV': 'Latvia', 'LY': 'Libya', 'MA': 'Morocco', 'MC': 'Monaco',
            'MD': 'Moldova', 'ME': 'Montenegro', 'MG': 'Madagascar', 'MH': 'Marshall Islands',
            'MK': 'Macedonia', 'ML': 'Mali', 'MM': 'Myanmar', 'MN': 'Mongolia', 'MO': 'Macau',
            'MQ': 'Martinique', 'MR': 'Mauritania', 'MS': 'Montserrat', 'MT': 'Malta', 'MU': 'Mauritius',
            'MV': 'Maldives', 'MW': 'Malawi', 'MX': 'Mexico', 'MY': 'Malaysia', 'MZ': 'Mozambique',
            'NA': 'Namibia', 'NE': 'Niger', 'NG': 'Nigeria', 'NI': 'Nicaragua', 'NL': 'Netherlands',
            'NO': 'Norway', 'NP': 'Nepal', 'NR': 'Nauru', 'NZ': 'New Zealand', 'OM': 'Oman',
            'PA': 'Panama', 'PE': 'PerÃº', 'PG': 'Papua New Guinea', 'PH': 'Philippines', 'PK': 'Pakistan',
            'PL': 'Poland', 'PS': 'Palestinian Territory', 'PT': 'Portugal', 'PY': 'Paraguay', 'QA': 'Qatar',
            'RE': 'RÃ©union', 'RO': 'Romania', 'RS': 'Serbia', 'RU': 'Russia', 'RW': 'Rwanda',
            'SA': 'Saudi Arabia', 'SB': 'Solomon Islands', 'SC': 'Seychelles', 'SD': 'Sudan', 'SE': 'Sweden',
            'SG': 'Singapore', 'SH': 'Saint Helena', 'SI': 'Slovenia', 'SK': 'Slovakia', 'SL': 'Sierra Leone',
            'SM': 'San Marino', 'SN': 'Senegal', 'SO': 'Somalia', 'SR': 'Suriname', 'SS': 'South Sudan',
            'ST': 'SÃ£o TomÃ© and Principe', 'SV': 'El Salvador', 'SY': 'Syria', 'SZ': 'Swaziland',
            'TC': 'Turks and Caicos Islands', 'TD': 'Chad', 'TG': 'Togo', 'TH': 'Thailand',
            'TJ': 'Tajikistan', 'TL': 'Timor-Leste', 'TM': 'Turkmenistan', 'TN': 'Tunisia', 'TO': 'Tonga',
            'TR': 'Turkey', 'TT': 'Trinidad and Tobago', 'TV': 'Tuvalu', 'TZ': 'Tanzania', 'UA': 'Ukraine',
            'UG': 'Uganda', 'US': 'United States', 'UY': 'Uruguay', 'UZ': 'Uzbekistan',
            'VC': 'Saint Vincent and the Grenadines', 'VE': 'Venezuela', 'VG': 'British Virgin Islands',
            'VN': 'Viet Nam', 'VU': 'Vanuatu', 'WS': 'Samoa', 'XC': 'Netherlands Antilles',
            'YE': 'Yemen', 'ZA': 'South Africa', 'ZM': 'Zambia', 'ZW': 'Zimbabwe',
            'ZZ': 'Unknown or unassigned country'
        };

        // Prefix to ISO2 mapping (from the CSV data)
        var regPrefixes = {
            '2': 'GG', '3A': 'MC', '3B': 'MU', '3C': 'GQ', '3DC': 'SZ', '3X': 'GN',
            '4K': 'AZ', '4L': 'GE', '4O': 'ME', '4R': 'LK', '4U': 'ZZ', '4W': 'TL',
            '4X': 'IL', '5A': 'LY', '5B': 'CY', '5H': 'TZ', '5N': 'NG', '5R': 'MG',
            '5T': 'MR', '5U': 'NE', '5V': 'TG', '5W': 'WS', '5X': 'UG', '5Y': 'KE',
            '6O': 'SO', '6V': 'SN', '6W': 'SN', '6Y': 'JM', '7O': 'YE', '7P': 'LS',
            '7Q': 'MW', '7T': 'DZ', '8P': 'BB', '8Q': 'MV', '8R': 'GY', '9A': 'HR',
            '9G': 'GH', '9H': 'MT', '9J': 'ZM', '9K': 'KW', '9L': 'SL', '9M': 'MY',
            '9N': 'NP', '9S': 'CD', '9U': 'BI', '9V': 'SG', '9XR': 'RW', '9Y': 'TT',
            'A2': 'BW', 'A3': 'TO', 'A4O': 'OM', 'A5': 'BT', 'A6': 'AE', 'A7': 'QA',
            'A8': 'LR', 'A9C': 'BH', 'AP': 'PK', 'B': 'CN', 'C': 'CA', 'C2': 'NR',
            'C3': 'AD', 'C5': 'GM', 'C6': 'BS', 'C9': 'MZ', 'CC': 'CL', 'CN': 'MA',
            'CNA': 'MA', 'CP': 'BO', 'CR': 'PT', 'CS': 'PT', 'CU': 'CU', 'CX': 'UY',
            'D': 'DE', 'D2': 'AO', 'D4': 'CV', 'D6': 'KM', 'DQ': 'FJ', 'E3': 'ER',
            'E4': 'PS', 'E5': 'CK', 'E7': 'BA', 'EC': 'ES', 'EI': 'IE', 'EJ': 'IE',
            'EK': 'AM', 'EM': 'ES', 'EP': 'IR', 'ER': 'MD', 'ES': 'EE', 'ET': 'ET',
            'EW': 'BY', 'EX': 'KG', 'EY': 'TJ', 'EZ': 'TM', 'F': 'FR', 'G': 'GB',
            'H4': 'SB', 'HA': 'HU', 'HB': 'CH', 'HC': 'EC', 'HH': 'HT', 'HI': 'DO',
            'HJ': 'CO', 'HK': 'CO', 'HL': 'KR', 'HP': 'PA', 'HR': 'HN', 'HS': 'TH',
            'HZ': 'SA', 'I': 'IT', 'J2': 'DJ', 'J3': 'GD', 'J5': 'GW', 'J6': 'LC',
            'J7': 'DM', 'J8': 'VC', 'JA': 'JP', 'JR': 'JP', 'JU': 'MN', 'JY': 'JO',
            'LN': 'NO', 'LQ': 'AR', 'LV': 'AR', 'LX': 'LU', 'LY': 'LT', 'LZ': 'BG',
            'M': 'IM', 'N': 'US', 'OB': 'PE', 'OD': 'LB', 'OE': 'AT', 'OH': 'FI',
            'OK': 'CZ', 'OM': 'SK', 'OO': 'BE', 'OY': 'DK', 'P': 'KP', 'P2': 'PG',
            'P4': 'AW', 'PH': 'NL', 'PJ': 'XC', 'PK': 'ID', 'PP': 'BR', 'PR': 'BR',
            'PS': 'BR', 'PT': 'BR', 'PU': 'BR', 'PZ': 'SR', 'RA': 'RU', 'RDPL': 'LA',
            'RF': 'RU', 'RP': 'PH', 'S2': 'BD', 'S5': 'SI', 'S7': 'SC', 'S9': 'ST',
            'SE': 'SE', 'SN': 'PL', 'SP': 'PL', 'ST': 'SD', 'SU': 'EG', 'SX': 'GR',
            'T2': 'TV', 'T3': 'KI', 'T7': 'SM', 'TC': 'TR', 'TF': 'IS', 'TG': 'GT',
            'TI': 'CR', 'TJ': 'CM', 'TL': 'CF', 'TN': 'CG', 'TR': 'GA', 'TS': 'TN',
            'TT': 'TD', 'TU': 'CI', 'TY': 'BJ', 'TZ': 'ML', 'UK': 'UZ', 'UP': 'KZ',
            'UR': 'UA', 'V2': 'AG', 'V3': 'BZ', 'V4': 'KN', 'V5': 'NA', 'V6': 'FM',
            'V7': 'MH', 'V8': 'BN', 'VH': 'AU', 'VN': 'VN', 'VP-A': 'AI', 'VP-B': 'BM',
            'VP-F': 'FK', 'VP-G': 'GI', 'VP-C': 'KY', 'VP-M': 'MS', 'VP-L': 'VG',
            'VQ-B': 'BM', 'VQ-C': 'KY', 'VQ-H': 'SH', 'VQ-T': 'TC', 'VT': 'IN',
            'XA': 'MX', 'XB': 'MX', 'XC': 'MX', 'XT': 'BF', 'XU': 'KH', 'XY': 'MM',
            'XZ': 'MM', 'YA': 'AF', 'YI': 'IQ', 'YJ': 'VU', 'YK': 'SY', 'YL': 'LV',
            'YN': 'NI', 'YR': 'RO', 'YS': 'SV', 'YU': 'RS', 'YV': 'VE', 'Z': 'ZW',
            'Z3': 'MK', 'Z6': 'KS', 'Z8': 'SS', 'ZA': 'AL', 'ZJ': 'JE', 'ZK': 'NZ',
            'ZL': 'NZ', 'ZM': 'NZ', 'ZP': 'PY', 'ZS': 'ZA', 'ZT': 'ZA', 'ZU': 'ZA'
        };

        function lookupRegistrationPrefix() {
            var input = document.getElementById('reg-prefix-input').value.toUpperCase().trim();
            var resultEl = document.getElementById('reg-country-result');
            var codeEl = document.getElementById('reg-country-code');

            if (!input) {
                resultEl.textContent = '---';
                codeEl.textContent = '---';
                return;
            }

            // Try exact match first, then progressively shorter prefixes
            var iso2 = null;
            var matchedPrefix = null;

            // Sort prefixes by length (longest first) for best match
            var sortedPrefixes = Object.keys(regPrefixes).sort(function(a, b) {
                return b.length - a.length;
            });

            for (var i = 0; i < sortedPrefixes.length; i++) {
                var prefix = sortedPrefixes[i];
                if (input.startsWith(prefix) || input === prefix) {
                    iso2 = regPrefixes[prefix];
                    matchedPrefix = prefix;
                    break;
                }
            }

            if (iso2 && regPrefixData[iso2]) {
                resultEl.textContent = regPrefixData[iso2];
                resultEl.style.color = '#00ff88';
                codeEl.textContent = matchedPrefix + ' â†’ ' + iso2;
            } else {
                resultEl.textContent = 'Not found';
                resultEl.style.color = '#ff5252';
                codeEl.textContent = 'Unknown prefix';
            }
        }

        // ============ PANTRY SELECTOR CALCULATOR ============
        var pantryDatabase = {
            "B737-800": {
                "TWO_CLASS_10J156Y_OR_12J162Y_OR_SINGLE_166Y174Y": {
                    label: "Two Class (10J156Y/12J162Y) / Single (166Y/174Y)",
                    specialRouteOverrides: [
                        { routePair: "MLE-CMB", direction: "OUTBOUND_DXB", pantryCode: "E" },
                        { routePair: "CMB-MLE", direction: "INBOUND_DXB", pantryCode: "F" },
                        { routePair: "PEN-LGK", direction: "OUTBOUND_DXB", pantryCode: "G" },
                        { routePair: "LGK-PEN", direction: "INBOUND_DXB", pantryCode: "H" }
                    ],
                    pantryByDirection: {
                        OUTBOUND_DXB: {
                            A: { weightKg: 780, indexIU: 4.8 },
                            C: { weightKg: 838, indexIU: 6.4 },
                            E: { weightKg: 670, indexIU: 2.9 },
                            G: { weightKg: 604, indexIU: 2.0 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        },
                        INBOUND_DXB: {
                            B: { weightKg: 658, indexIU: 3.7 },
                            D: { weightKg: 721, indexIU: 5.3 },
                            F: { weightKg: 569, indexIU: 2.3 },
                            H: { weightKg: 509, indexIU: 1.4 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        }
                    },
                    destinationGroups: {
                        OUTBOUND_DXB: [
                            { pantryCode: "A", destinations: ["AER","AHB","AJF","ALA","AMD","AMM","ASB","ASM","AQI","BEG","BEY","BGW","BOM","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DEL","DYU","EAM","EBL","ELQ","EVN","GIZ","GYD","HAS","HBE","HGA","HYD","IAS","IFN","IKA","ISB","ISU","JED","JIB","JMK","JTR","JUB","KBL","KHI","KUF","KWI","KZN","LED","LHE","LJU","LKO","LYP","MCX","MED","MHD","MRV","MSQ","MUX","NJF","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","RUH","SJJ","SKD","SKT","SLL","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TLV","TUU","TZX","UET","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "C", destinations: ["ADD","AYT","BGY","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ESB","IST","KBV","KRK","KTM","MLE","OTP","PEN","POZ","PRG","PSA","RIX","SAW","SOF","MBA","NAP","NBO","TIA","VNO","WAW","ZNZ"] },
                            { pantryCode: "E", destinations: ["BAH","BSR","BUZ","DMM","DOH","HOF","KER","LRR","MCT","SYZ"] },
                            { pantryCode: "G", destinations: ["BND","GSM","KIH"] }
                        ],
                        INBOUND_DXB: [
                            { pantryCode: "B", destinations: ["AER","AHB","AJF","ALA","AMD","AMM","ASB","ASM","AQI","BEG","BEY","BGW","BOM","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DEL","DYU","EAM","EBL","ELQ","EVN","GIZ","GYD","HAS","HBE","HGA","HYD","IAS","IFN","IKA","ISB","ISU","JED","JIB","JMK","JTR","JUB","KBL","KHI","KUF","KWI","KZN","LED","LHE","LJU","LKO","LYP","MCX","MED","MHD","MRV","MSQ","MUX","NJF","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","RUH","SJJ","SKD","SKT","SLL","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TLV","TUU","TZX","UET","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "D", destinations: ["ADD","AYT","BGY","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ESB","IST","KBV","KRK","KTM","MLE","OTP","PEN","POZ","PRG","PSA","RIX","SAW","SOF","MBA","NAP","NBO","TIA","VNO","WAW","ZNZ"] },
                            { pantryCode: "F", destinations: ["BAH","BSR","BUZ","DMM","DOH","HOF","KER","LRR","MCT","SYZ"] },
                            { pantryCode: "H", destinations: ["BND","GSM","KIH"] }
                        ]
                    }
                }
            },
            "B737-8": {
                "TWO_CLASS_10J156Y_OR_12J162Y_OR_SINGLE_166Y174Y": {
                    label: "Two Class (10J156Y/12J162Y) / Single (166Y/174Y)",
                    specialRouteOverrides: [
                        { routePair: "MLE-CMB", direction: "OUTBOUND_DXB", pantryCode: "E" },
                        { routePair: "CMB-MLE", direction: "INBOUND_DXB", pantryCode: "F" },
                        { routePair: "PEN-LGK", direction: "OUTBOUND_DXB", pantryCode: "E" },
                        { routePair: "LGK-PEN", direction: "INBOUND_DXB", pantryCode: "F" }
                    ],
                    pantryByDirection: {
                        OUTBOUND_DXB: {
                            A: { weightKg: 783, indexIU: 4.7 },
                            C: { weightKg: 851, indexIU: 6.2 },
                            E: { weightKg: 659, indexIU: 3.0 },
                            G: { weightKg: 600, indexIU: 1.6 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        },
                        INBOUND_DXB: {
                            B: { weightKg: 649, indexIU: 3.4 },
                            D: { weightKg: 735, indexIU: 5.0 },
                            F: { weightKg: 560, indexIU: 2.4 },
                            H: { weightKg: 502, indexIU: 1.0 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        }
                    },
                    destinationGroups: "SAME_AS_B737_800"
                },
                "ONE_CLASS_186Y": {
                    label: "One Class (186Y)",
                    specialRouteOverrides: [
                        { routePair: "ZNZ-DAR", direction: "OUTBOUND_DXB", pantryCode: "K" },
                        { routePair: "DAR-ZNZ", direction: "INBOUND_DXB", pantryCode: "L" },
                        { routePair: "MLE-CMB", direction: "OUTBOUND_DXB", pantryCode: "O" },
                        { routePair: "CMB-MLE", direction: "INBOUND_DXB", pantryCode: "P" },
                        { routePair: "PEN-LGK", direction: "OUTBOUND_DXB", pantryCode: "Q" },
                        { routePair: "LGK-PEN", direction: "INBOUND_DXB", pantryCode: "R" }
                    ],
                    pantryByDirection: {
                        OUTBOUND_DXB: {
                            I: { weightKg: 672, indexIU: 7.3 },
                            K: { weightKg: 718, indexIU: 7.9 },
                            M: { weightKg: 586, indexIU: 6.7 },
                            O: { weightKg: 520, indexIU: 5.4 },
                            Q: { weightKg: 414, indexIU: 3.7 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        },
                        INBOUND_DXB: {
                            J: { weightKg: 528, indexIU: 5.7 },
                            L: { weightKg: 611, indexIU: 7.1 },
                            N: { weightKg: 446, indexIU: 5.2 },
                            P: { weightKg: 425, indexIU: 4.7 },
                            R: { weightKg: 335, indexIU: 3.2 },
                            T: { weightKg: 25, indexIU: -0.4 }
                        }
                    },
                    destinationGroups: {
                        OUTBOUND_DXB: [
                            { pantryCode: "I", destinations: ["AER","AHB","ALA","AMM","ASB","ASM","BEG","BEY","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DYU","EAM","EBL","EVN","GIZ","GYD","HBE","HGA","IAS","ISB","JED","JIB","JMK","JTR","JUB","KBL","KUF","KZN","LED","LHE","LJU","LKO","LYP","MCX","MRV","MSQ","MUX","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","SJJ","SKD","SKT","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TUU","TZX","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "K", destinations: ["ADD","AYT","BGY","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ESB","IST","KBV","KRK","KTM","MBA","MLE","NAP","NBO","OTP","PEN","POZ","PRG","PSA","RIX","SAW","SOF","TIA","VNO","WAW","ZNZ"] },
                            { pantryCode: "M", destinations: ["AIF","AQI","BGW","ELQ","HAS","IFN","IKA","ISU","KHI","KWI","MED","MHD","NJF","RUH","SLL","UET"] },
                            { pantryCode: "O", destinations: ["AMD","BAH","BOM","BSR","BUZ","DEL","DMM","DOH","HOF","HYD","KER","LRR","MCT","SYZ","TLV"] },
                            { pantryCode: "Q", destinations: ["BND","GSM","KIH"] }
                        ],
                        INBOUND_DXB: [
                            { pantryCode: "J", destinations: ["AER","AHB","ALA","AMM","ASB","ASM","BEG","BEY","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DYU","EAM","EBL","EVN","GIZ","GYD","HBE","HGA","IAS","ISB","JED","JIB","JMK","JTR","JUB","KBL","KUF","KZN","LED","LHE","LJU","LKO","LYP","MCX","MRV","MSQ","MUX","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","SJJ","SKD","SKT","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TUU","TZX","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "L", destinations: ["ADD","AYT","BGY","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ESB","IST","KBV","KRK","KTM","MBA","MLE","NAP","NBO","OTP","PEN","POZ","PRG","PSA","RIX","SAW","SOF","TIA","VNO","WAW","ZNZ"] },
                            { pantryCode: "N", destinations: ["AIF","AQI","BGW","ELQ","HAS","IFN","IKA","ISU","KHI","KWI","MED","MHD","NJF","RUH","SLL","UET"] },
                            { pantryCode: "P", destinations: ["AMD","BAH","BOM","BSR","BUZ","DEL","DMM","DOH","HOF","HYD","KER","LRR","MCT","SYZ","TLV"] },
                            { pantryCode: "R", destinations: ["BND","GSM","KIH"] }
                        ]
                    }
                }
            },
            "B737-9": {
                "TWO_CLASS_16J156Y_OR_SINGLE_172Y": {
                    label: "Two Class (16J156Y) / Single (172Y)",
                    specialRouteOverrides: [
                        { routePair: "MLE-CMB", direction: "OUTBOUND_DXB", pantryCode: "E" },
                        { routePair: "CMB-MLE", direction: "INBOUND_DXB", pantryCode: "F" },
                        { routePair: "PEN-LGK", direction: "OUTBOUND_DXB", pantryCode: "G" },
                        { routePair: "LGK-PEN", direction: "INBOUND_DXB", pantryCode: "H" }
                    ],
                    pantryByDirection: {
                        OUTBOUND_DXB: {
                            A: { weightKg: 926, indexIU: 6.9 },
                            C: { weightKg: 864, indexIU: 5.9 },
                            E: { weightKg: 803, indexIU: 4.8 },
                            G: { weightKg: 625, indexIU: 2.4 },
                            T: { weightKg: 25, indexIU: -0.5 }
                        },
                        INBOUND_DXB: {
                            B: { weightKg: 777, indexIU: 5.5 },
                            D: { weightKg: 724, indexIU: 4.7 },
                            F: { weightKg: 692, indexIU: 4.1 },
                            H: { weightKg: 546, indexIU: 2.2 },
                            T: { weightKg: 25, indexIU: -0.5 }
                        }
                    },
                    destinationGroups: {
                        OUTBOUND_DXB: [
                            { pantryCode: "A", destinations: ["AER","AHB","ALA","AMM","ASB","ASM","BEG","BEY","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DYU","EAM","EBL","EVN","GIZ","GYD","HBE","HGA","IAS","ISB","JED","JIB","JMK","JTR","JUB","KBL","KUF","KZN","LHE","LJU","LKO","LYP","MCX","MRV","MSQ","MUX","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","SJJ","SKD","SKT","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TUU","TZX","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "C", destinations: ["ADD","AIF","AQI","AYT","BGY","BGW","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ELQ","ESB","HAS","IFN","IKA","IST","ISU","KBV","KHI","KRK","KTM","KWI","LED","MBA","MED","MHD","MLE","NAP","NBO","OTP","PEN","POZ","PRG","PSA","RUH","RIX","SAW","SLL","SOF","TIA","UET","VNO","WAW","ZNZ"] },
                            { pantryCode: "E", destinations: ["AMD","BAH","BOM","BSR","BUZ","DEL","DMM","DOH","HOF","KER","LRR","HYD","MCT","SYZ","TLV"] },
                            { pantryCode: "G", destinations: ["BND","GSM","KIH"] }
                        ],
                        INBOUND_DXB: [
                            { pantryCode: "B", destinations: ["AER","AHB","ALA","AMM","ASB","ASM","BEG","BEY","BSZ","BUS","BWA","CFU","CGP","CIT","DAC","DAM","DBB","DBV","DYU","EAM","EBL","EVN","GIZ","GYD","HBE","HGA","IAS","ISB","JED","JIB","JMK","JTR","JUB","KBL","KUF","KZN","LHE","LJU","LKO","LYP","MCX","MRV","MSQ","MUX","NQZ","NUM","OLB","OVB","PEW","RMO","RSI","SJJ","SKD","SKT","SPX","SVX","SZG","TAS","TBS","TBZ","TIF","TIV","TUU","TZX","UFA","ULH","VKO","VOG","YNB","ZAG"] },
                            { pantryCode: "D", destinations: ["ADD","AIF","AQI","AYT","BGY","BGW","BJV","BSL","BUD","CCJ","CCU","CMB","COK","CTA","DAR","EBB","ELQ","ESB","HAS","IFN","IKA","IST","ISU","KBV","KHI","KRK","KTM","KWI","LED","MBA","MED","MHD","MLE","NAP","NBO","OTP","PEN","POZ","PRG","PSA","RUH","RIX","SAW","SLL","SOF","TIA","UET","VNO","WAW","ZNZ"] },
                            { pantryCode: "F", destinations: ["AMD","BAH","BOM","BSR","BUZ","DEL","DMM","DOH","HOF","KER","LRR","HYD","MCT","SYZ","TLV"] },
                            { pantryCode: "H", destinations: ["BND","GSM","KIH"] }
                        ]
                    }
                }
            }
        };

        var pantryConfigLabels = {
            "TWO_CLASS_10J156Y_OR_12J162Y_OR_SINGLE_166Y174Y": "Two Class / Single Class",
            "ONE_CLASS_186Y": "One Class (186Y)",
            "TWO_CLASS_16J156Y_OR_SINGLE_172Y": "Two Class / Single Class"
        };

        function updatePantryConfigOptions() {
            var aircraft = document.getElementById('pantry-aircraft').value;
            var configSelect = document.getElementById('pantry-config');
            configSelect.innerHTML = '<option value="">Select Config</option>';

            if (aircraft && pantryDatabase[aircraft]) {
                var configs = Object.keys(pantryDatabase[aircraft]);
                configs.forEach(function(cfg) {
                    var opt = document.createElement('option');
                    opt.value = cfg;
                    opt.textContent = pantryDatabase[aircraft][cfg].label || pantryConfigLabels[cfg] || cfg;
                    configSelect.appendChild(opt);
                });
                // Auto-select if only one config
                if (configs.length === 1) {
                    configSelect.value = configs[0];
                }
            }
        }

        function getDestinationGroups(aircraft, config, direction) {
            var acData = pantryDatabase[aircraft];
            if (!acData) return null;
            var cfg = acData[config];
            if (!cfg) return null;

            var groups = cfg.destinationGroups;
            if (groups === "SAME_AS_B737_800") {
                // Use B737-800 destination groups
                groups = pantryDatabase["B737-800"]["TWO_CLASS_10J156Y_OR_12J162Y_OR_SINGLE_166Y174Y"].destinationGroups;
            }
            return groups && groups[direction] ? groups[direction] : null;
        }

        function calculatePantry() {
            var aircraft = document.getElementById('pantry-aircraft').value;
            var config = document.getElementById('pantry-config').value;
            var direction = document.getElementById('pantry-direction').value;
            var flightType = document.getElementById('pantry-flight-type').value;
            var destination = document.getElementById('pantry-destination').value.toUpperCase().trim();
            var routePair = document.getElementById('pantry-route-pair').value.toUpperCase().trim().replace(/\s/g, '');

            var codeEl = document.getElementById('pantry-code-result');
            var weightEl = document.getElementById('pantry-weight-result');
            var indexEl = document.getElementById('pantry-index-result');
            var reasonEl = document.getElementById('pantry-match-reason');

            // Reset display
            function showResult(code, weight, index, reason, isError) {
                codeEl.textContent = code || '---';
                codeEl.style.color = isError ? '#ff5252' : '#00d4ff';
                weightEl.textContent = weight !== null ? weight + ' kg' : '--- kg';
                indexEl.textContent = index !== null ? index + ' IU' : '--- IU';
                reasonEl.textContent = reason;
                reasonEl.style.color = isError ? '#ff5252' : '#888';
            }

            // Check required inputs
            if (!aircraft || !config || !direction) {
                showResult(null, null, null, 'Enter aircraft, config, direction and destination', false);
                return;
            }

            var acData = pantryDatabase[aircraft];
            var cfg = acData ? acData[config] : null;
            if (!cfg) {
                showResult('ERR', null, null, 'Invalid aircraft/config combination', true);
                return;
            }

            var pantryData = cfg.pantryByDirection[direction];
            if (!pantryData) {
                showResult('ERR', null, null, 'Invalid direction for this config', true);
                return;
            }

            // Special flights use pantry T
            if (flightType === 'TRAINING' || flightType === 'DELIVERY' || flightType === 'FERRY') {
                var tData = pantryData['T'];
                if (tData) {
                    showResult('T', tData.weightKg, tData.indexIU, flightType + ' flight - Pantry T', false);
                    return;
                }
            }

            if (!destination && !routePair) {
                showResult(null, null, null, 'Enter destination or route pair', false);
                return;
            }

            // Check route pair overrides first
            if (routePair && cfg.specialRouteOverrides) {
                var override = cfg.specialRouteOverrides.find(function(o) {
                    return o.routePair === routePair && o.direction === direction;
                });
                if (override) {
                    var data = pantryData[override.pantryCode];
                    if (data) {
                        showResult(override.pantryCode, data.weightKg, data.indexIU, 'Route override: ' + routePair, false);
                        return;
                    }
                }
            }

            // Destination group lookup
            if (destination) {
                var destGroups = getDestinationGroups(aircraft, config, direction);
                if (destGroups) {
                    for (var i = 0; i < destGroups.length; i++) {
                        var group = destGroups[i];
                        if (group.destinations && group.destinations.indexOf(destination) !== -1) {
                            var data = pantryData[group.pantryCode];
                            if (data) {
                                showResult(group.pantryCode, data.weightKg, data.indexIU, 'Destination: ' + destination + ' (Group ' + group.pantryCode + ')', false);
                                return;
                            }
                        }
                    }
                }
                showResult('?', null, null, 'Destination ' + destination + ' not found - select pantry manually', true);
                return;
            }

            showResult(null, null, null, 'Enter destination IATA code', false);
        }

        function clearPantryCalculator() {
            document.getElementById('pantry-aircraft').value = '';
            document.getElementById('pantry-config').innerHTML = '<option value="">Select Config</option>';
            document.getElementById('pantry-direction').value = '';
            document.getElementById('pantry-flight-type').value = 'NORMAL';
            document.getElementById('pantry-destination').value = '';
            document.getElementById('pantry-route-pair').value = '';
            document.getElementById('pantry-code-result').textContent = '---';
            document.getElementById('pantry-code-result').style.color = '#00d4ff';
            document.getElementById('pantry-weight-result').textContent = '--- kg';
            document.getElementById('pantry-index-result').textContent = '--- IU';
            document.getElementById('pantry-match-reason').textContent = 'Enter aircraft, config, direction and destination';
            document.getElementById('pantry-match-reason').style.color = '#888';
        }

        // ============ SUN TAB FUNCTIONS ============
        // Solar calculation algorithms based on NOAA formulas

        var sunCalcCache = {};  // Cache for calculated sun times

        // Initialize sun tab with today's date
        function initSunTab() {
            var today = new Date();
            var dateStr = today.toISOString().split('T')[0];
            document.getElementById('sun-date').value = dateStr;
            document.getElementById('sun-arr-date').value = dateStr;
            document.getElementById('sun-night-date').value = dateStr;
            updateSunCurrentTime();
            setInterval(updateSunCurrentTime, 1000);
        }

        function updateSunCurrentTime() {
            var now = new Date();
            var utc = now.toISOString().substring(11, 19) + ' UTC';
            var el = document.getElementById('sun-current-utc');
            if (el) el.textContent = utc;
        }

        // Convert degrees to radians
        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        // Julian date calculation
        function getJulianDate(year, month, day, hour) {
            if (month <= 2) { year--; month += 12; }
            var A = Math.floor(year / 100);
            var B = 2 - A + Math.floor(A / 4);
            var JD = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
            return JD + hour / 24.0;
        }

        // Calculate sun position for a given date/time and location
        function calculateSunPosition(lat, lon, date) {
            var year = date.getUTCFullYear();
            var month = date.getUTCMonth() + 1;
            var day = date.getUTCDate();
            var hour = date.getUTCHours() + date.getUTCMinutes() / 60 + date.getUTCSeconds() / 3600;

            var JD = getJulianDate(year, month, day, hour);
            var T = (JD - 2451545.0) / 36525.0;

            // Mean longitude of the sun
            var L0 = (280.46646 + 36000.76983 * T + 0.0003032 * T * T) % 360;

            // Mean anomaly of the sun
            var M = (357.52911 + 35999.05029 * T - 0.0001537 * T * T) % 360;
            var Mrad = toRad(M);

            // Eccentricity of Earth's orbit
            var e = 0.016708634 - 0.000042037 * T - 0.0000001267 * T * T;

            // Sun's equation of center
            var C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(Mrad)
                  + (0.019993 - 0.000101 * T) * Math.sin(2 * Mrad)
                  + 0.000289 * Math.sin(3 * Mrad);

            // Sun's true longitude
            var sunLon = L0 + C;

            // Sun's apparent longitude
            var omega = 125.04 - 1934.136 * T;
            var lambda = sunLon - 0.00569 - 0.00478 * Math.sin(toRad(omega));
            var lambdaRad = toRad(lambda);

            // Obliquity of the ecliptic
            var epsilon0 = 23.439291 - 0.013004 * T;
            var epsilon = epsilon0 + 0.00256 * Math.cos(toRad(omega));
            var epsilonRad = toRad(epsilon);

            // Sun's right ascension and declination
            var sinLambda = Math.sin(lambdaRad);
            var cosLambda = Math.cos(lambdaRad);
            var sinEpsilon = Math.sin(epsilonRad);
            var cosEpsilon = Math.cos(epsilonRad);

            var RA = toDeg(Math.atan2(cosEpsilon * sinLambda, cosLambda));
            var dec = toDeg(Math.asin(sinEpsilon * sinLambda));

            // Equation of time (in minutes)
            var y = Math.tan(epsilonRad / 2) * Math.tan(epsilonRad / 2);
            var L0rad = toRad(L0);
            var EoT = 4 * toDeg(y * Math.sin(2 * L0rad) - 2 * e * Math.sin(Mrad) + 4 * e * y * Math.sin(Mrad) * Math.cos(2 * L0rad)
                      - 0.5 * y * y * Math.sin(4 * L0rad) - 1.25 * e * e * Math.sin(2 * Mrad));

            // Solar noon (in minutes from midnight UTC)
            var solarNoon = 720 - 4 * lon - EoT;

            // Hour angle
            var trueSolarTime = (hour * 60 + 4 * lon + EoT) % 1440;
            var hourAngle = trueSolarTime / 4 - 180;
            if (hourAngle < -180) hourAngle += 360;

            // Solar zenith and elevation
            var latRad = toRad(lat);
            var decRad = toRad(dec);
            var haRad = toRad(hourAngle);

            var cosZenith = Math.sin(latRad) * Math.sin(decRad) + Math.cos(latRad) * Math.cos(decRad) * Math.cos(haRad);
            // Clamp to avoid NaN from floating point errors
            cosZenith = Math.max(-1, Math.min(1, cosZenith));
            var zenith = toDeg(Math.acos(cosZenith));
            var elevation = 90 - zenith;

            // Solar azimuth using atan2 for robustness
            var sinZenith = Math.sin(toRad(zenith));
            var azimuth;
            if (sinZenith === 0) {
                azimuth = 0;
            } else {
                var cosAz = (Math.sin(latRad) * cosZenith - Math.sin(decRad)) / (Math.cos(latRad) * sinZenith);
                cosAz = Math.max(-1, Math.min(1, cosAz));
                if (hourAngle > 0) {
                    azimuth = toDeg(Math.acos(cosAz)) + 180;
                } else {
                    azimuth = 540 - toDeg(Math.acos(cosAz));
                }
            }
            azimuth = azimuth % 360;

            return {
                elevation: elevation,
                azimuth: azimuth,
                declination: dec,
                solarNoon: solarNoon,
                EoT: EoT
            };
        }

        // Get compass direction from azimuth
        function getCompassDirection(azimuth) {
            var dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            var index = Math.round(azimuth / 22.5) % 16;
            return dirs[index];
        }

        // Calculate sunrise/sunset for a given zenith angle
        function calculateSunEvent(lat, lon, date, zenithAngle) {
            var year = date.getUTCFullYear();
            var month = date.getUTCMonth() + 1;
            var day = date.getUTCDate();

            var JD = getJulianDate(year, month, day, 12);
            var T = (JD - 2451545.0) / 36525.0;

            // Mean longitude and anomaly
            var L0 = (280.46646 + 36000.76983 * T) % 360;
            var M = (357.52911 + 35999.05029 * T) % 360;
            var Mrad = toRad(M);

            // Eccentricity and equation of center
            var e = 0.016708634 - 0.000042037 * T;
            var C = (1.914602 - 0.004817 * T) * Math.sin(Mrad) + 0.019993 * Math.sin(2 * Mrad);

            var sunLon = L0 + C;
            var omega = 125.04 - 1934.136 * T;
            var lambda = sunLon - 0.00569 - 0.00478 * Math.sin(toRad(omega));

            var epsilon = 23.439291 - 0.013004 * T + 0.00256 * Math.cos(toRad(omega));
            var dec = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));

            // Equation of time
            var y = Math.tan(toRad(epsilon) / 2) * Math.tan(toRad(epsilon) / 2);
            var EoT = 4 * toDeg(y * Math.sin(2 * toRad(L0)) - 2 * e * Math.sin(Mrad));

            // Hour angle for the given zenith
            var latRad = toRad(lat);
            var decRad = toRad(dec);
            var zenithRad = toRad(zenithAngle);

            // Avoid division by zero at poles
            var cosLat = Math.cos(latRad);
            var cosDec = Math.cos(decRad);
            if (Math.abs(cosLat) < 0.0001 || Math.abs(cosDec) < 0.0001) {
                // At or very near poles - approximate
                return { rise: null, set: null, alwaysDay: dec * lat > 0 };
            }

            var cosHA = (Math.cos(zenithRad) - Math.sin(latRad) * Math.sin(decRad)) / (cosLat * cosDec);

            if (cosHA > 1) return { rise: null, set: null, alwaysNight: true };
            if (cosHA < -1) return { rise: null, set: null, alwaysDay: true };

            var HA = toDeg(Math.acos(cosHA));

            // Sunrise and sunset in minutes from midnight UTC
            var solarNoon = 720 - 4 * lon - EoT;
            var riseMin = solarNoon - HA * 4;
            var setMin = solarNoon + HA * 4;

            // Handle day wrap
            if (riseMin < 0) riseMin += 1440;
            if (riseMin >= 1440) riseMin -= 1440;
            if (setMin < 0) setMin += 1440;
            if (setMin >= 1440) setMin -= 1440;

            return { rise: riseMin, set: setMin };
        }

        // Format minutes to HH:MM
        function minsToTime(mins) {
            if (mins === null || mins === undefined) return '--:--';
            var h = Math.floor(mins / 60) % 24;
            var m = Math.round(mins % 60);
            if (m === 60) { h++; m = 0; }
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }

        // Get airport coordinates from ICAO/IATA
        function getAirportCoords(code) {
            if (!airportsDatabase) return null;
            code = code.toUpperCase().trim();

            // Try ICAO first
            if (airportsDatabase[code] && airportsDatabase[code].c) {
                var coords = airportsDatabase[code].c;
                return {
                    lat: coords[0],
                    lon: coords[1],
                    name: airportsDatabase[code].n || code,
                    tz: Math.round(coords[1] / 15)  // Approximate timezone from longitude
                };
            }

            // Try IATA
            for (var icao in airportsDatabase) {
                if (airportsDatabase[icao].i === code && airportsDatabase[icao].c) {
                    var coords = airportsDatabase[icao].c;
                    return {
                        lat: coords[0],
                        lon: coords[1],
                        name: airportsDatabase[icao].n || code,
                        tz: Math.round(coords[1] / 15)  // Approximate timezone from longitude
                    };
                }
            }

            return null;
        }

        // Sun tab airport switcher - cycles through unique airports from all sectors
        var sunAirportList = [];
        var sunCurrentAirportIndex = 0;

        function getUniqueAirports() {
            var airports = [];
            for (var i = 1; i <= 4; i++) {
                var dep = document.getElementById('s' + i + '-dep');
                var arr = document.getElementById('s' + i + '-arr');
                if (dep && dep.value && airports.indexOf(dep.value) === -1) {
                    airports.push(dep.value);
                }
                if (arr && arr.value && airports.indexOf(arr.value) === -1) {
                    airports.push(arr.value);
                }
            }
            return airports;
        }

        function updateSunSectorSwitcher() {
            sunAirportList = getUniqueAirports();
            var switcher = document.getElementById('sun-sector-switcher');
            var display = document.getElementById('sun-sector-display');

            if (sunAirportList.length > 1) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (sunCurrentAirportIndex >= sunAirportList.length) sunCurrentAirportIndex = 0;

                var currentAirport = sunAirportList[sunCurrentAirportIndex] || '---';
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + currentAirport + '</span> <span style="color: #888;">(' + (sunCurrentAirportIndex + 1) + '/' + sunAirportList.length + ')</span>';
            } else {
                switcher.style.display = 'none';
            }
        }

        function sunSectorPrev() {
            if (sunAirportList.length === 0) return;
            sunCurrentAirportIndex--;
            if (sunCurrentAirportIndex < 0) sunCurrentAirportIndex = sunAirportList.length - 1;
            applySunAirport();
        }

        function sunSectorNext() {
            if (sunAirportList.length === 0) return;
            sunCurrentAirportIndex++;
            if (sunCurrentAirportIndex >= sunAirportList.length) sunCurrentAirportIndex = 0;
            applySunAirport();
        }

        function applySunAirport() {
            var airport = sunAirportList[sunCurrentAirportIndex];
            if (airport) {
                document.getElementById('sun-airport').value = airport;
                clearSunCoords();
                calculateSunTimes();
            }
            updateSunSectorSwitcher();
        }

        // Arrival Conditions airport switcher (cycles through unique airports)
        var arrCondAirportIndex = 0;

        function updateArrCondSwitcher() {
            sunAirportList = getUniqueAirports();
            var switcher = document.getElementById('arr-cond-switcher');
            var display = document.getElementById('arr-cond-display');

            if (sunAirportList.length > 0) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (arrCondAirportIndex >= sunAirportList.length) arrCondAirportIndex = 0;
                var currentAirport = sunAirportList[arrCondAirportIndex] || '---';
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + currentAirport + '</span> <span style="color: #888;">(' + (arrCondAirportIndex + 1) + '/' + sunAirportList.length + ')</span>';
                // Auto-fill destination
                document.getElementById('sun-arr-airport').value = currentAirport;
            } else {
                switcher.style.display = 'none';
            }
        }

        function arrCondPrev() {
            if (sunAirportList.length === 0) return;
            arrCondAirportIndex--;
            if (arrCondAirportIndex < 0) arrCondAirportIndex = sunAirportList.length - 1;
            applyArrCondAirport();
        }

        function arrCondNext() {
            if (sunAirportList.length === 0) return;
            arrCondAirportIndex++;
            if (arrCondAirportIndex >= sunAirportList.length) arrCondAirportIndex = 0;
            applyArrCondAirport();
        }

        function applyArrCondAirport() {
            var airport = sunAirportList[arrCondAirportIndex];
            if (airport) {
                document.getElementById('sun-arr-airport').value = airport;
            }
            updateArrCondSwitcher();
        }

        // Night Flight Time sector switcher (cycles through sectors with DEPâ†’ARR)
        var nightSectorIndex = 0;

        function getSectorList() {
            var sectors = [];
            for (var i = 1; i <= 4; i++) {
                var dep = document.getElementById('s' + i + '-dep');
                var arr = document.getElementById('s' + i + '-arr');
                if (dep && dep.value && arr && arr.value) {
                    sectors.push({ dep: dep.value, arr: arr.value, index: i });
                }
            }
            return sectors;
        }

        function updateNightSectorSwitcher() {
            var sectors = getSectorList();
            var switcher = document.getElementById('night-sector-switcher');
            var display = document.getElementById('night-sector-display');

            if (sectors.length > 0) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (nightSectorIndex >= sectors.length) nightSectorIndex = 0;
                var sector = sectors[nightSectorIndex];
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + sector.dep + 'â†’' + sector.arr + '</span> <span style="color: #888;">(' + (nightSectorIndex + 1) + '/' + sectors.length + ')</span>';
                // Auto-fill dep/arr
                document.getElementById('sun-night-dep').value = sector.dep;
                document.getElementById('sun-night-arr').value = sector.arr;
            } else {
                switcher.style.display = 'none';
            }
        }

        function nightSectorPrev() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            nightSectorIndex--;
            if (nightSectorIndex < 0) nightSectorIndex = sectors.length - 1;
            applyNightSector();
        }

        function nightSectorNext() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            nightSectorIndex++;
            if (nightSectorIndex >= sectors.length) nightSectorIndex = 0;
            applyNightSector();
        }

        function applyNightSector() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            var sector = sectors[nightSectorIndex];
            if (sector) {
                document.getElementById('sun-night-dep').value = sector.dep;
                document.getElementById('sun-night-arr').value = sector.arr;
            }
            updateNightSectorSwitcher();
        }

        // MAP tab route switcher (cycles through sectors for route drawing)
        var mapRouteSectorIndex = 0;

        function updateMapRouteSwitcher() {
            var sectors = getSectorList();
            var switcher = document.getElementById('map-route-switcher');
            var display = document.getElementById('map-route-display');

            if (sectors.length > 0) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (mapRouteSectorIndex >= sectors.length) mapRouteSectorIndex = 0;
                var sector = sectors[mapRouteSectorIndex];
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + sector.dep + 'â†’' + sector.arr + '</span> <span style="color: #888;">(' + (mapRouteSectorIndex + 1) + '/' + sectors.length + ')</span>';
                // Auto-fill the From/To inputs
                document.getElementById('route-from').value = sector.dep;
                document.getElementById('route-to').value = sector.arr;
            } else {
                switcher.style.display = 'none';
            }
        }

        function mapRoutePrev() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            mapRouteSectorIndex--;
            if (mapRouteSectorIndex < 0) mapRouteSectorIndex = sectors.length - 1;
            applyMapRoute();
        }

        function mapRouteNext() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            mapRouteSectorIndex++;
            if (mapRouteSectorIndex >= sectors.length) mapRouteSectorIndex = 0;
            applyMapRoute();
        }

        function applyMapRoute() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            var sector = sectors[mapRouteSectorIndex];
            if (sector) {
                document.getElementById('route-from').value = sector.dep;
                document.getElementById('route-to').value = sector.arr;
                drawRoute();
            }
            updateMapRouteSwitcher();
        }

        // NAV tab Distance Calculator switcher
        var distSwitcherIndex = 0;

        function updateDistSwitcher() {
            var sectors = getSectorList();
            var switcher = document.getElementById('dist-switcher');
            var display = document.getElementById('dist-switcher-display');

            if (sectors.length > 0) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (distSwitcherIndex >= sectors.length) distSwitcherIndex = 0;
                var sector = sectors[distSwitcherIndex];
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + sector.dep + 'â†’' + sector.arr + '</span> <span style="color: #888;">(' + (distSwitcherIndex + 1) + '/' + sectors.length + ')</span>';
                // Auto-fill
                document.getElementById('dist-from').value = sector.dep;
                document.getElementById('dist-to').value = sector.arr;
                calculateAirportDistance();
            } else {
                switcher.style.display = 'none';
            }
        }

        function distSwitcherPrev() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            distSwitcherIndex--;
            if (distSwitcherIndex < 0) distSwitcherIndex = sectors.length - 1;
            updateDistSwitcher();
        }

        function distSwitcherNext() {
            var sectors = getSectorList();
            if (sectors.length === 0) return;
            distSwitcherIndex++;
            if (distSwitcherIndex >= sectors.length) distSwitcherIndex = 0;
            updateDistSwitcher();
        }

        // NAV tab Airport Info switcher (cycles through unique airports)
        var aptInfoSwitcherIndex = 0;

        function updateAptInfoSwitcher() {
            var airports = getUniqueAirports();
            var switcher = document.getElementById('apt-info-switcher');
            var display = document.getElementById('apt-info-switcher-display');

            if (airports.length > 0) {
                switcher.style.display = 'flex';
                switcher.style.alignItems = 'center';
                if (aptInfoSwitcherIndex >= airports.length) aptInfoSwitcherIndex = 0;
                var apt = airports[aptInfoSwitcherIndex];
                display.innerHTML = '<span style="color: #FF8200; font-weight: bold;">' + apt + '</span> <span style="color: #888;">(' + (aptInfoSwitcherIndex + 1) + '/' + airports.length + ')</span>';
                // Auto-fill and lookup
                document.getElementById('apt-lookup').value = apt;
                lookupAirport();
            } else {
                switcher.style.display = 'none';
            }
        }

        function aptInfoSwitcherPrev() {
            var airports = getUniqueAirports();
            if (airports.length === 0) return;
            aptInfoSwitcherIndex--;
            if (aptInfoSwitcherIndex < 0) aptInfoSwitcherIndex = airports.length - 1;
            updateAptInfoSwitcher();
        }

        function aptInfoSwitcherNext() {
            var airports = getUniqueAirports();
            if (airports.length === 0) return;
            aptInfoSwitcherIndex++;
            if (aptInfoSwitcherIndex >= airports.length) aptInfoSwitcherIndex = 0;
            updateAptInfoSwitcher();
        }

        // Clear coordinate inputs when airport is focused
        function clearSunCoords() {
            document.getElementById('sun-lat').value = '';
            document.getElementById('sun-lon').value = '';
        }

        // Clear airport input when coordinates are focused
        function clearSunAirport() {
            document.getElementById('sun-airport').value = '';
        }

        // Use GPS location for solar calculations (from existing GPS feed)
        function useSunGps() {
            clearSunAirport();

            // Use GPS data from the Qibla/GPS feed if available
            if (qiblaCurrentLat !== null && qiblaCurrentLon !== null) {
                document.getElementById('sun-lat').value = qiblaCurrentLat.toFixed(4);
                document.getElementById('sun-lon').value = qiblaCurrentLon.toFixed(4);
                document.getElementById('sun-location-info').textContent = 'GPS location loaded';
                return;
            }

            // Try to fetch from GPS endpoint directly
            fetch('/gps.json')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data && data.lat && data.lon) {
                        document.getElementById('sun-lat').value = data.lat.toFixed(4);
                        document.getElementById('sun-lon').value = data.lon.toFixed(4);
                        document.getElementById('sun-location-info').textContent = 'GPS location loaded';
                    } else {
                        document.getElementById('sun-location-info').innerHTML = '<span style="color: #ff5252;">No GPS fix available</span>';
                    }
                })
                .catch(function() {
                    document.getElementById('sun-location-info').innerHTML = '<span style="color: #ff5252;">GPS not available</span>';
                });
        }

        // Main function to calculate all sun times for an airport or coordinates
        function calculateSunTimes() {
            var code = document.getElementById('sun-airport').value.trim();
            var latStr = document.getElementById('sun-lat').value.trim();
            var lonStr = document.getElementById('sun-lon').value.trim();
            var dateStr = document.getElementById('sun-date').value;

            var lat, lon, tz, locationName;

            // Check if using airport or coordinates
            if (code) {
                var airport = getAirportCoords(code);
                if (!airport) {
                    document.getElementById('sun-location-info').innerHTML = '<span style="color: #ff5252;">Airport not found</span>';
                    return;
                }
                lat = airport.lat;
                lon = airport.lon;
                tz = airport.tz;
                locationName = airport.name;
            } else if (latStr && lonStr) {
                lat = parseFloat(latStr);
                lon = parseFloat(lonStr);
                if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                    document.getElementById('sun-location-info').innerHTML = '<span style="color: #ff5252;">Invalid coordinates</span>';
                    return;
                }
                tz = Math.round(lon / 15);
                locationName = 'Custom Location';
            } else {
                document.getElementById('sun-location-info').textContent = 'Enter airport code or coordinates';
                return;
            }

            var date = dateStr ? new Date(dateStr + 'T12:00:00Z') : new Date();

            document.getElementById('sun-location-info').textContent = locationName + ' (' + lat.toFixed(2) + 'Â°, ' + lon.toFixed(2) + 'Â°) UTC' + (tz >= 0 ? '+' : '') + tz;

            // Calculate sunrise/sunset (zenith 90.833Â° accounts for refraction)
            var sunRiseSet = calculateSunEvent(lat, lon, date, 90.833);

            // Display sunrise/sunset
            if (sunRiseSet.alwaysDay) {
                document.getElementById('sun-sunrise-utc').textContent = 'Polar Day';
                document.getElementById('sun-sunset-utc').textContent = 'No Sunset';
                document.getElementById('sun-sunrise-local').textContent = '24hr daylight';
                document.getElementById('sun-sunset-local').textContent = '';
                document.getElementById('sun-daylight-hours').textContent = '24:00';
            } else if (sunRiseSet.alwaysNight) {
                document.getElementById('sun-sunrise-utc').textContent = 'Polar Night';
                document.getElementById('sun-sunset-utc').textContent = 'No Sunrise';
                document.getElementById('sun-sunrise-local').textContent = '24hr darkness';
                document.getElementById('sun-sunset-local').textContent = '';
                document.getElementById('sun-daylight-hours').textContent = '00:00';
            } else {
                document.getElementById('sun-sunrise-utc').textContent = minsToTime(sunRiseSet.rise);
                document.getElementById('sun-sunset-utc').textContent = minsToTime(sunRiseSet.set);

                // Local times
                var riseLocal = (sunRiseSet.rise + tz * 60) % 1440;
                var setLocal = (sunRiseSet.set + tz * 60) % 1440;
                if (riseLocal < 0) riseLocal += 1440;
                if (setLocal < 0) setLocal += 1440;
                document.getElementById('sun-sunrise-local').textContent = 'Local: ' + minsToTime(riseLocal);
                document.getElementById('sun-sunset-local').textContent = 'Local: ' + minsToTime(setLocal);

                // Daylight hours
                var daylight = sunRiseSet.set - sunRiseSet.rise;
                if (daylight < 0) daylight += 1440;
                document.getElementById('sun-daylight-hours').textContent = minsToTime(daylight);
            }

            // Calculate twilight times
            var civil = calculateSunEvent(lat, lon, date, 96);     // 6Â° below
            var nautical = calculateSunEvent(lat, lon, date, 102); // 12Â° below
            var astro = calculateSunEvent(lat, lon, date, 108);    // 18Â° below

            document.getElementById('sun-civil-dawn').textContent = civil.alwaysDay ? 'N/A' : minsToTime(civil.rise);
            document.getElementById('sun-civil-dusk').textContent = civil.alwaysDay ? 'N/A' : minsToTime(civil.set);
            document.getElementById('sun-nautical-dawn').textContent = nautical.alwaysDay ? 'N/A' : minsToTime(nautical.rise);
            document.getElementById('sun-nautical-dusk').textContent = nautical.alwaysDay ? 'N/A' : minsToTime(nautical.set);
            document.getElementById('sun-astro-dawn').textContent = astro.alwaysDay ? 'N/A' : minsToTime(astro.rise);
            document.getElementById('sun-astro-dusk').textContent = astro.alwaysDay ? 'N/A' : minsToTime(astro.set);

            // Calculate current sun position
            var now = new Date();
            var sunPos = calculateSunPosition(lat, lon, now);

            document.getElementById('sun-elevation').textContent = sunPos.elevation.toFixed(1) + 'Â°';
            document.getElementById('sun-azimuth').textContent = sunPos.azimuth.toFixed(0) + 'Â°';

            // Update sun compass arrow rotation
            var sunCompassArrow = document.getElementById('sun-compass-arrow');
            if (sunCompassArrow) {
                sunCompassArrow.setAttribute('transform', 'rotate(' + sunPos.azimuth.toFixed(0) + ', 50, 50)');
            }

            // Status based on elevation
            var statusEl = document.getElementById('sun-status');
            if (sunPos.elevation > 0) {
                statusEl.textContent = 'Day';
                statusEl.style.color = '#FFD700';
            } else if (sunPos.elevation > -6) {
                statusEl.textContent = 'Civil Twilight';
                statusEl.style.color = '#6495ED';
            } else if (sunPos.elevation > -12) {
                statusEl.textContent = 'Nautical Twilight';
                statusEl.style.color = '#4169E1';
            } else if (sunPos.elevation > -18) {
                statusEl.textContent = 'Astro Twilight';
                statusEl.style.color = '#7B68EE';
            } else {
                statusEl.textContent = 'Night';
                statusEl.style.color = '#888';
            }

            // Cache for other functions
            sunCalcCache = {
                lat: lat,
                lon: lon,
                tz: tz,
                date: date,
                sunrise: sunRiseSet.rise,
                sunset: sunRiseSet.set,
                sunPos: sunPos
            };

            // Generate daylight trend
            generateDaylightTrend(lat, lon, tz, date);

            // Update moon display
            updateMoonDisplay(lat, lon, date);
        }

        // Check sun glare on runway heading
        function checkSunGlare() {
            if (!sunCalcCache.lat) {
                document.getElementById('sun-glare-result').style.display = 'block';
                document.getElementById('sun-glare-result').innerHTML = '<span style="color: #ff5252;">Calculate sun times first</span>';
                return;
            }

            var rwyHdg = parseInt(document.getElementById('sun-runway-hdg').value);
            if (isNaN(rwyHdg) || rwyHdg < 1 || rwyHdg > 360) {
                document.getElementById('sun-glare-result').style.display = 'block';
                document.getElementById('sun-glare-result').innerHTML = '<span style="color: #ff5252;">Enter valid runway heading (1-360)</span>';
                return;
            }

            var sunAz = sunCalcCache.sunPos.azimuth;
            var sunEl = sunCalcCache.sunPos.elevation;

            // Calculate angle difference
            var diff = Math.abs(sunAz - rwyHdg);
            if (diff > 180) diff = 360 - diff;

            var resultEl = document.getElementById('sun-glare-result');
            resultEl.style.display = 'block';

            // Sun glare is an issue when sun is in front (within ~30Â°) and low (0-15Â°)
            if (sunEl < 0) {
                resultEl.style.background = 'rgba(136, 136, 136, 0.2)';
                resultEl.innerHTML = '<div style="color: #888;">Sun is below horizon</div>' +
                    '<div style="font-size: 0.85rem; color: #888;">Elevation: ' + sunEl.toFixed(1) + 'Â°</div>';
            } else if (diff <= 30 && sunEl > 0 && sunEl < 15) {
                resultEl.style.background = 'rgba(255, 82, 82, 0.3)';
                resultEl.innerHTML = '<div style="color: #ff5252; font-weight: bold; font-size: 1.2rem;">HIGH GLARE RISK</div>' +
                    '<div style="margin-top: 8px;">Sun: ' + sunAz.toFixed(0) + 'Â° azimuth, ' + sunEl.toFixed(1) + 'Â° elevation</div>' +
                    '<div style="color: #ff5252;">Sun is ' + diff.toFixed(0) + 'Â° off runway heading</div>';
            } else if (diff <= 45 && sunEl > 0 && sunEl < 25) {
                resultEl.style.background = 'rgba(255, 193, 7, 0.3)';
                resultEl.innerHTML = '<div style="color: #FFC107; font-weight: bold; font-size: 1.2rem;">MODERATE GLARE</div>' +
                    '<div style="margin-top: 8px;">Sun: ' + sunAz.toFixed(0) + 'Â° azimuth, ' + sunEl.toFixed(1) + 'Â° elevation</div>' +
                    '<div style="color: #FFC107;">Sun is ' + diff.toFixed(0) + 'Â° off runway heading</div>';
            } else {
                resultEl.style.background = 'rgba(76, 175, 80, 0.2)';
                resultEl.innerHTML = '<div style="color: #4CAF50; font-weight: bold;">LOW GLARE RISK</div>' +
                    '<div style="margin-top: 8px;">Sun: ' + sunAz.toFixed(0) + 'Â° azimuth, ' + sunEl.toFixed(1) + 'Â° elevation</div>' +
                    '<div style="color: #888;">Sun is ' + diff.toFixed(0) + 'Â° off runway heading</div>';
            }
        }

        // Autofill Arrival Daylight Check from schedule (sector 1)
        function autofillArrivalDaylight() {
            try {
                var saved = localStorage.getItem('flightSchedule');
                if (!saved) {
                    alert('No schedule data found');
                    return;
                }
                var schedule = JSON.parse(saved);
                if (!schedule.sectors || !schedule.sectors[0]) {
                    alert('No sector data found');
                    return;
                }
                var sector = schedule.sectors[0];

                // Fill destination
                if (sector.arr) {
                    document.getElementById('sun-arr-airport').value = sector.arr;
                }

                // Fill ETA from STA or ON time
                var eta = sector.on || sector.sta;
                if (eta && eta.length === 4) {
                    document.getElementById('sun-arr-eta').value = eta;
                    document.getElementById('sun-arr-eta-btn').textContent = eta;
                    document.getElementById('sun-arr-eta-btn').classList.remove('placeholder');
                }

                // Set today's date
                var today = new Date().toISOString().split('T')[0];
                document.getElementById('sun-arr-date').value = today;
            } catch (e) {
                alert('Error reading schedule: ' + e.message);
            }
        }

        // Autofill Night Flight Time from schedule (sector 1)
        function autofillNightTime() {
            try {
                var saved = localStorage.getItem('flightSchedule');
                if (!saved) {
                    alert('No schedule data found');
                    return;
                }
                var schedule = JSON.parse(saved);
                if (!schedule.sectors || !schedule.sectors[0]) {
                    alert('No sector data found');
                    return;
                }
                var sector = schedule.sectors[0];

                // Fill departure and arrival airports
                if (sector.dep) {
                    document.getElementById('sun-night-dep').value = sector.dep;
                }
                if (sector.arr) {
                    document.getElementById('sun-night-arr').value = sector.arr;
                }

                // Fill OFF time
                var off = sector.off || sector.std;
                if (off && off.length === 4) {
                    document.getElementById('sun-night-off').value = off;
                    document.getElementById('sun-night-off-btn').textContent = off;
                    document.getElementById('sun-night-off-btn').classList.remove('placeholder');
                }

                // Fill ON time
                var on = sector.on || sector.sta;
                if (on && on.length === 4) {
                    document.getElementById('sun-night-on').value = on;
                    document.getElementById('sun-night-on-btn').textContent = on;
                    document.getElementById('sun-night-on-btn').classList.remove('placeholder');
                }

                // Set today's date
                var today = new Date().toISOString().split('T')[0];
                document.getElementById('sun-night-date').value = today;
            } catch (e) {
                alert('Error reading schedule: ' + e.message);
            }
        }

        // Check arrival conditions (daylight + glare)
        function checkArrivalConditions() {
            var code = document.getElementById('sun-arr-airport').value.trim();
            var dateStr = document.getElementById('sun-arr-date').value;
            var eta = document.getElementById('sun-arr-eta').value;
            var rwyHdg = parseInt(document.getElementById('sun-arr-rwy').value);

            var resultEl = document.getElementById('sun-arrival-result');
            resultEl.style.display = 'block';

            if (!code || !dateStr || !eta || eta.length !== 4) {
                resultEl.innerHTML = '<span style="color: #ff5252;">Enter destination, date, and ETA</span>';
                return;
            }

            var airport = getAirportCoords(code);
            if (!airport) {
                resultEl.innerHTML = '<span style="color: #ff5252;">Airport not found</span>';
                return;
            }

            var date = new Date(dateStr + 'T12:00:00Z');
            var sunRiseSet = calculateSunEvent(airport.lat, airport.lon, date, 90.833);
            var etaMins = parseInt(eta.substring(0, 2)) * 60 + parseInt(eta.substring(2, 4));

            // Calculate sun position at ETA time
            var etaDate = new Date(dateStr + 'T00:00:00Z');
            etaDate.setUTCMinutes(etaMins);
            var sunPos = calculateSunPosition(airport.lat, airport.lon, etaDate);

            var html = '';
            var bgColor = '';

            // Daylight check
            if (sunRiseSet.alwaysDay) {
                bgColor = 'rgba(76, 175, 80, 0.2)';
                html = '<div style="color: #4CAF50; font-weight: bold; font-size: 1.2rem;">DAYLIGHT</div>' +
                    '<div style="color: #888; font-size: 0.85rem;">Polar day - 24hr daylight</div>';
            } else if (sunRiseSet.alwaysNight) {
                bgColor = 'rgba(136, 136, 136, 0.3)';
                html = '<div style="color: #888; font-weight: bold; font-size: 1.2rem;">DARKNESS</div>' +
                    '<div style="color: #888; font-size: 0.85rem;">Polar night</div>';
            } else {
                var isDay = (etaMins >= sunRiseSet.rise && etaMins <= sunRiseSet.set) ||
                            (sunRiseSet.rise > sunRiseSet.set && (etaMins >= sunRiseSet.rise || etaMins <= sunRiseSet.set));

                if (isDay) {
                    bgColor = 'rgba(76, 175, 80, 0.2)';
                    html = '<div style="color: #4CAF50; font-weight: bold; font-size: 1.2rem;">DAYLIGHT ARRIVAL</div>';
                } else {
                    bgColor = 'rgba(136, 136, 136, 0.3)';
                    html = '<div style="color: #888; font-weight: bold; font-size: 1.2rem;">NIGHT ARRIVAL</div>';
                }
                html += '<div style="color: #888; font-size: 0.85rem;">' + airport.name + '</div>';
                html += '<div style="color: #666; font-size: 0.8rem;">Sunrise: ' + minsToTime(sunRiseSet.rise) + ' | Sunset: ' + minsToTime(sunRiseSet.set) + ' UTC</div>';
            }

            // Glare check (only if runway heading provided and sun is up)
            if (!isNaN(rwyHdg) && rwyHdg >= 1 && rwyHdg <= 360 && sunPos.elevation > 0) {
                var diff = Math.abs(sunPos.azimuth - rwyHdg);
                if (diff > 180) diff = 360 - diff;

                // Get compass direction for sun
                var sunDir = getCompassDirection(sunPos.azimuth);

                html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">';

                if (diff <= 30 && sunPos.elevation < 15) {
                    html += '<div style="color: #ff5252; font-weight: bold; font-size: 1.1rem;">âš ï¸ HIGH GLARE RISK</div>';
                    html += '<div style="color: #ff8a80; font-size: 0.95rem; margin-top: 4px;">Sun aligned with runway at low angle</div>';
                    bgColor = 'rgba(255, 82, 82, 0.25)';
                } else if (diff <= 45 && sunPos.elevation < 25) {
                    html += '<div style="color: #FFC107; font-weight: bold; font-size: 1.1rem;">âš ï¸ MODERATE GLARE</div>';
                    html += '<div style="color: #FFE082; font-size: 0.95rem; margin-top: 4px;">Sun near runway heading</div>';
                    if (bgColor === 'rgba(76, 175, 80, 0.2)') bgColor = 'rgba(255, 193, 7, 0.2)';
                } else {
                    html += '<div style="color: #4CAF50; font-weight: bold; font-size: 1.1rem;">âœ“ LOW GLARE RISK</div>';
                }

                // Compass rose and sun position details
                html += '<div style="display: flex; align-items: center; gap: 15px; margin-top: 12px;">';

                // Compass rose SVG
                var sunAngle = sunPos.azimuth - 90; // SVG starts at 3 o'clock, adjust to start at 12
                var rwyAngle = rwyHdg - 90;
                // Sun on outer edge
                var sunX = 60 + 48 * Math.cos(sunAngle * Math.PI / 180);
                var sunY = 60 + 48 * Math.sin(sunAngle * Math.PI / 180);
                // Aircraft over the runway
                var acX = 60 + 15 * Math.cos(rwyAngle * Math.PI / 180);
                var acY = 60 + 15 * Math.sin(rwyAngle * Math.PI / 180);

                html += '<svg width="120" height="120" viewBox="0 0 120 120" style="flex-shrink: 0;">';
                // Outer circle
                html += '<circle cx="60" cy="60" r="55" fill="rgba(0,0,0,0.3)" stroke="#444" stroke-width="1"/>';
                // Cardinal tick marks
                html += '<line x1="60" y1="5" x2="60" y2="12" stroke="#666" stroke-width="2"/>';
                html += '<line x1="115" y1="60" x2="108" y2="60" stroke="#555" stroke-width="1"/>';
                html += '<line x1="60" y1="115" x2="60" y2="108" stroke="#555" stroke-width="1"/>';
                html += '<line x1="5" y1="60" x2="12" y2="60" stroke="#555" stroke-width="1"/>';
                // Cardinal labels
                html += '<text x="60" y="22" text-anchor="middle" fill="#888" font-size="9" font-weight="bold">N</text>';
                html += '<text x="100" y="63" text-anchor="middle" fill="#555" font-size="8">E</text>';
                html += '<text x="60" y="104" text-anchor="middle" fill="#555" font-size="8">S</text>';
                html += '<text x="20" y="63" text-anchor="middle" fill="#555" font-size="8">W</text>';
                // Runway rectangle
                html += '<g transform="rotate(' + rwyHdg + ', 60, 60)">';
                html += '<rect x="56" y="28" width="8" height="64" fill="#4CAF50" rx="1"/>';
                html += '<line x1="60" y1="32" x2="60" y2="40" stroke="#fff" stroke-width="1"/>';
                html += '<line x1="60" y1="44" x2="60" y2="52" stroke="#fff" stroke-width="1"/>';
                html += '<line x1="60" y1="56" x2="60" y2="64" stroke="#fff" stroke-width="1"/>';
                html += '<line x1="60" y1="68" x2="60" y2="76" stroke="#fff" stroke-width="1"/>';
                html += '<line x1="60" y1="80" x2="60" y2="88" stroke="#fff" stroke-width="1"/>';
                html += '</g>';
                // Aircraft icon (over runway, bigger)
                html += '<g transform="translate(' + acX + ',' + acY + ') rotate(' + (rwyHdg + 180) + ') scale(1.4)">';
                html += '<path d="M0,-6 L2,-2 L2,2 L6,4 L6,6 L2,5 L2,7 L4,8 L4,10 L0,9 L-4,10 L-4,8 L-2,7 L-2,5 L-6,6 L-6,4 L-2,2 L-2,-2 Z" fill="#fff" stroke="#333" stroke-width="0.5"/>';
                html += '</g>';
                // Sun icon (outer edge, smaller)
                html += '<circle cx="' + sunX + '" cy="' + sunY + '" r="6" fill="#FFB300" stroke="#FF8300" stroke-width="2"/>';
                html += '</svg>';

                // Details grid
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; flex: 1; text-align: left;">';
                html += '<div style="background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 6px;">';
                html += '<div style="color: #888; font-size: 0.7rem;">SUN AZIMUTH</div>';
                html += '<div style="color: #fff; font-size: 0.9rem; font-weight: bold;">' + sunPos.azimuth.toFixed(0) + 'Â° <span style="color: #FF8300;">(' + sunDir + ')</span></div>';
                html += '</div>';
                html += '<div style="background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 6px;">';
                html += '<div style="color: #888; font-size: 0.7rem;">SUN ELEVATION</div>';
                html += '<div style="color: #fff; font-size: 0.9rem; font-weight: bold;">' + sunPos.elevation.toFixed(1) + 'Â°</div>';
                html += '</div>';
                html += '<div style="background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 6px;">';
                html += '<div style="color: #4CAF50; font-size: 0.7rem;">RUNWAY HDG</div>';
                html += '<div style="color: #fff; font-size: 0.9rem; font-weight: bold;">' + rwyHdg + 'Â°</div>';
                html += '</div>';
                html += '<div style="background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 6px;">';
                html += '<div style="color: #888; font-size: 0.7rem;">OFFSET</div>';
                html += '<div style="color: #fff; font-size: 0.9rem; font-weight: bold;">' + diff.toFixed(0) + 'Â°</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            } else if (!isNaN(rwyHdg) && sunPos.elevation <= 0) {
                html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">';
                html += '<div style="color: #888; font-size: 0.95rem;">â˜¾ Sun below horizon - no glare concern</div>';
                html += '<div style="color: #666; font-size: 0.85rem; margin-top: 4px;">Sun elevation: ' + sunPos.elevation.toFixed(1) + 'Â°</div>';
                html += '</div>';
            }

            resultEl.style.background = bgColor;
            resultEl.innerHTML = html;
        }

        // Keep old function name for backwards compatibility
        function checkArrivalDaylight() {
            checkArrivalConditions();
        }

        // Calculate night flight time
        function calculateNightTime() {
            var depCode = document.getElementById('sun-night-dep').value.trim();
            var arrCode = document.getElementById('sun-night-arr').value.trim();
            var dateStr = document.getElementById('sun-night-date').value;
            var offTime = document.getElementById('sun-night-off').value;
            var onTime = document.getElementById('sun-night-on').value;

            var resultEl = document.getElementById('sun-night-result');
            resultEl.style.display = 'block';

            if (!depCode || !arrCode || !dateStr || !offTime || !onTime) {
                resultEl.innerHTML = '<span style="color: #ff5252;">Fill in all fields</span>';
                return;
            }

            var depAirport = getAirportCoords(depCode);
            var arrAirport = getAirportCoords(arrCode);

            if (!depAirport || !arrAirport) {
                resultEl.innerHTML = '<span style="color: #ff5252;">Airport not found</span>';
                return;
            }

            var date = new Date(dateStr + 'T12:00:00Z');
            var offMins = parseInt(offTime.substring(0, 2)) * 60 + parseInt(offTime.substring(2, 4));
            var onMins = parseInt(onTime.substring(0, 2)) * 60 + parseInt(onTime.substring(2, 4));
            if (onMins < offMins) onMins += 1440; // Next day

            var totalFlight = onMins - offMins;

            // Get sunset/sunrise at departure and arrival
            var depSun = calculateSunEvent(depAirport.lat, depAirport.lon, date, 90.833);
            var arrSun = calculateSunEvent(arrAirport.lat, arrAirport.lon, date, 90.833);

            // Simplify: use midpoint sunset/sunrise for approximation
            var midLat = (depAirport.lat + arrAirport.lat) / 2;
            var midLon = (depAirport.lon + arrAirport.lon) / 2;
            var midSun = calculateSunEvent(midLat, midLon, date, 90.833);

            // Calculate night portion
            var nightMins = 0;

            if (midSun.alwaysNight) {
                nightMins = totalFlight;
            } else if (!midSun.alwaysDay) {
                // Check each minute of flight (simplified)
                var sunrise = midSun.rise;
                var sunset = midSun.set;

                for (var m = offMins; m < onMins; m++) {
                    var checkMins = m % 1440;
                    var isNight = false;

                    if (sunrise < sunset) {
                        // Normal day (sunrise before sunset)
                        isNight = (checkMins < sunrise || checkMins > sunset);
                    } else {
                        // Polar region edge case
                        isNight = (checkMins > sunset && checkMins < sunrise);
                    }

                    if (isNight) nightMins++;
                }
            }

            var nightHrs = Math.floor(nightMins / 60);
            var nightRem = nightMins % 60;
            var totalHrs = Math.floor(totalFlight / 60);
            var totalRem = totalFlight % 60;

            var pct = totalFlight > 0 ? Math.round((nightMins / totalFlight) * 100) : 0;

            resultEl.style.background = nightMins > 0 ? 'rgba(100, 149, 237, 0.2)' : 'rgba(76, 175, 80, 0.2)';
            resultEl.innerHTML = '<div style="font-size: 1.3rem; font-weight: bold;">' +
                '<span style="color: #6495ED;">' + nightHrs.toString().padStart(2, '0') + ':' + nightRem.toString().padStart(2, '0') + '</span>' +
                '<span style="color: #888; font-size: 1rem;"> night time</span></div>' +
                '<div style="margin-top: 8px; color: #888;">Total flight: ' + totalHrs.toString().padStart(2, '0') + ':' + totalRem.toString().padStart(2, '0') +
                ' (' + pct + '% night)</div>' +
                '<div style="color: #888; font-size: 0.85rem; margin-top: 5px;">Based on midpoint sunset at ' + minsToTime(midSun.set) + ' UTC</div>';
        }

        // Generate daylight hours trend for the month
        function generateDaylightTrend(lat, lon, tz, currentDate) {
            var container = document.getElementById('sun-daylight-trend');
            container.innerHTML = '';

            var year = currentDate.getUTCFullYear();
            var month = currentDate.getUTCMonth();
            var daysInMonth = new Date(year, month + 1, 0).getDate();

            var monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            document.getElementById('sun-trend-month').textContent = monthNames[month] + ' ' + year;
            document.getElementById('sun-trend-last-day').textContent = daysInMonth;

            var maxDaylight = 0;
            var minDaylight = 1440;
            var longestDay = 1;
            var shortestDay = 1;
            var daylightMins = [];

            // Calculate daylight for each day
            for (var d = 1; d <= daysInMonth; d++) {
                var date = new Date(year, month, d, 12, 0, 0);
                var sun = calculateSunEvent(lat, lon, date, 90.833);

                var daylight = 0;
                if (sun.alwaysDay) {
                    daylight = 1440;
                } else if (!sun.alwaysNight) {
                    daylight = sun.set - sun.rise;
                    if (daylight < 0) daylight += 1440;
                }

                daylightMins.push(daylight);

                if (daylight > maxDaylight) {
                    maxDaylight = daylight;
                    longestDay = d;
                }
                if (daylight < minDaylight) {
                    minDaylight = daylight;
                    shortestDay = d;
                }
            }

            // Create bars
            var barWidth = 100 / daysInMonth;
            for (var i = 0; i < daysInMonth; i++) {
                var height = (daylightMins[i] / 1440) * 100;
                var bar = document.createElement('div');
                bar.style.width = (barWidth - 0.5) + '%';
                bar.style.height = height + '%';
                bar.style.background = 'linear-gradient(to top, #FF6B35, #FFD700)';
                bar.style.borderRadius = '2px 2px 0 0';
                bar.title = 'Day ' + (i + 1) + ': ' + minsToTime(daylightMins[i]) + ' daylight';
                container.appendChild(bar);
            }

            // Display longest/shortest day
            document.getElementById('sun-longest-day').textContent = longestDay + ' ' + monthNames[month] + ' (' + minsToTime(maxDaylight) + ')';
            document.getElementById('sun-shortest-day').textContent = shortestDay + ' ' + monthNames[month] + ' (' + minsToTime(minDaylight) + ')';
        }

        // ============ MOON CALCULATIONS ============

        // Calculate moon phase and illumination
        function calculateMoonPhase(date) {
            // Based on simplified algorithm - synodic month is ~29.53 days
            var year = date.getUTCFullYear();
            var month = date.getUTCMonth() + 1;
            var day = date.getUTCDate();

            if (month < 3) {
                year--;
                month += 12;
            }

            // Julian date calculation
            var A = Math.floor(year / 100);
            var B = 2 - A + Math.floor(A / 4);
            var JD = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;

            // Days since known new moon (Jan 6, 2000)
            var daysSinceNew = JD - 2451550.1;
            var synodicMonth = 29.530588853;
            var phase = (daysSinceNew % synodicMonth) / synodicMonth;
            if (phase < 0) phase += 1;

            // Illumination: 0 at new, 1 at full
            var illumination = (1 - Math.cos(phase * 2 * Math.PI)) / 2;

            // Phase name
            var phaseName;
            if (phase < 0.0625) phaseName = 'New Moon';
            else if (phase < 0.1875) phaseName = 'Waxing Crescent';
            else if (phase < 0.3125) phaseName = 'First Quarter';
            else if (phase < 0.4375) phaseName = 'Waxing Gibbous';
            else if (phase < 0.5625) phaseName = 'Full Moon';
            else if (phase < 0.6875) phaseName = 'Waning Gibbous';
            else if (phase < 0.8125) phaseName = 'Last Quarter';
            else if (phase < 0.9375) phaseName = 'Waning Crescent';
            else phaseName = 'New Moon';

            return {
                phase: phase,
                illumination: illumination * 100,
                name: phaseName
            };
        }

        // Calculate moon position (elevation, azimuth)
        function calculateMoonPosition(lat, lon, date) {
            var toRad = Math.PI / 180;
            var toDeg = 180 / Math.PI;

            // Calculate Julian Date
            var JD = date.getTime() / 86400000 + 2440587.5;
            var T = (JD - 2451545) / 36525;

            // Moon's geocentric ecliptic coordinates (simplified)
            var L0 = 218.316 + 13.176396 * (JD - 2451545); // Mean longitude
            var M = 134.963 + 13.064993 * (JD - 2451545);   // Mean anomaly
            var F = 93.272 + 13.229350 * (JD - 2451545);    // Latitude argument

            L0 = (L0 % 360 + 360) % 360;
            M = ((M % 360 + 360) % 360) * toRad;
            F = ((F % 360 + 360) % 360) * toRad;

            // Ecliptic longitude
            var longitude = L0 + 6.289 * Math.sin(M);
            longitude = (longitude % 360 + 360) % 360;

            // Ecliptic latitude
            var latitude = 5.128 * Math.sin(F);

            // Convert to equatorial coordinates
            var obliquity = 23.439 - 0.0000004 * (JD - 2451545);
            obliquity *= toRad;

            var lonRad = longitude * toRad;
            var latRad = latitude * toRad;

            // Right ascension and declination
            var RA = Math.atan2(Math.sin(lonRad) * Math.cos(obliquity) - Math.tan(latRad) * Math.sin(obliquity), Math.cos(lonRad));
            var dec = Math.asin(Math.sin(latRad) * Math.cos(obliquity) + Math.cos(latRad) * Math.sin(obliquity) * Math.sin(lonRad));

            // Local sidereal time
            var JD0 = Math.floor(JD - 0.5) + 0.5;
            var S = JD0 - 2451545;
            var T0 = S / 36525;
            var theta0 = 100.46061837 + 36000.770053608 * T0 + 0.000387933 * T0 * T0;
            theta0 = (theta0 % 360 + 360) % 360;

            var UT = (JD - JD0) * 24;
            var theta = theta0 + 360.98564736629 * UT / 24 + lon;
            theta = (theta % 360 + 360) % 360;

            // Hour angle
            var HA = (theta * toRad) - RA;

            // Altitude and azimuth
            var latRad2 = lat * toRad;
            var sinAlt = Math.sin(latRad2) * Math.sin(dec) + Math.cos(latRad2) * Math.cos(dec) * Math.cos(HA);
            var altitude = Math.asin(sinAlt) * toDeg;

            var cosAz = (Math.sin(dec) - Math.sin(latRad2) * sinAlt) / (Math.cos(latRad2) * Math.cos(Math.asin(sinAlt)));
            cosAz = Math.max(-1, Math.min(1, cosAz));
            var azimuth = Math.acos(cosAz) * toDeg;
            if (Math.sin(HA) > 0) azimuth = 360 - azimuth;

            return {
                elevation: altitude,
                azimuth: azimuth
            };
        }

        // Calculate moonrise/moonset times (simplified approach)
        function calculateMoonRiseSet(lat, lon, date) {
            var rise = null, set = null;

            // Check moon position every 15 minutes to find rise/set
            var prevAboveHorizon = null;
            for (var mins = 0; mins <= 1440; mins += 15) {
                var checkDate = new Date(date.getTime());
                checkDate.setUTCHours(0, mins, 0, 0);
                var pos = calculateMoonPosition(lat, lon, checkDate);
                var aboveHorizon = pos.elevation > 0;

                if (prevAboveHorizon !== null) {
                    if (!prevAboveHorizon && aboveHorizon && rise === null) {
                        rise = mins - 7; // Approximate
                    } else if (prevAboveHorizon && !aboveHorizon && set === null) {
                        set = mins - 7;
                    }
                }
                prevAboveHorizon = aboveHorizon;
            }

            return { rise: rise, set: set };
        }

        // Update moon display
        function updateMoonDisplay(lat, lon, date) {
            var now = new Date();
            var moonPhase = calculateMoonPhase(now);
            var moonPos = calculateMoonPosition(lat, lon, now);
            var moonRiseSet = calculateMoonRiseSet(lat, lon, date);

            // Update phase and illumination
            document.getElementById('moon-phase').textContent = moonPhase.name;
            document.getElementById('moon-illumination-pct').textContent = moonPhase.illumination.toFixed(0) + '%';
            document.getElementById('moon-illumination-pct-dir').textContent = moonPhase.illumination.toFixed(0) + '%';

            // Update position
            document.getElementById('moon-elevation').textContent = moonPos.elevation.toFixed(1) + 'Â°';
            document.getElementById('moon-azimuth').textContent = moonPos.azimuth.toFixed(0) + 'Â°';

            // Update compass arrow
            var moonCompassArrow = document.getElementById('moon-compass-arrow');
            if (moonCompassArrow) {
                moonCompassArrow.setAttribute('transform', 'rotate(' + moonPos.azimuth.toFixed(0) + ', 50, 50)');
            }

            // Update rise/set times
            document.getElementById('moon-rise').textContent = moonRiseSet.rise !== null ? minsToTime(moonRiseSet.rise) : '--:--';
            document.getElementById('moon-set').textContent = moonRiseSet.set !== null ? minsToTime(moonRiseSet.set) : '--:--';

            // Draw moon phase SVG
            drawMoonPhase(moonPhase.phase);
        }

        // Draw moon phase on SVG
        function drawMoonPhase(phase) {
            var path = document.getElementById('moon-illumination');
            if (!path) return;

            var cx = 50, cy = 50, r = 40;

            // Determine which side is lit based on phase
            // phase 0 = new (dark), 0.5 = full (bright)
            var illumAngle = phase * 2 * Math.PI;

            // Calculate inner curve radius for crescent/gibbous effect
            var k = Math.cos(illumAngle);

            var d = '';
            if (phase < 0.01 || phase > 0.99) {
                // New moon - no illumination
                d = '';
            } else if (phase < 0.5) {
                // Waxing - right side lit
                d = 'M ' + cx + ' ' + (cy - r) +
                    ' A ' + r + ' ' + r + ' 0 0 1 ' + cx + ' ' + (cy + r) +
                    ' A ' + (r * Math.abs(k)) + ' ' + r + ' 0 0 ' + (k > 0 ? '1' : '0') + ' ' + cx + ' ' + (cy - r);
            } else {
                // Waning - left side lit
                d = 'M ' + cx + ' ' + (cy - r) +
                    ' A ' + r + ' ' + r + ' 0 0 0 ' + cx + ' ' + (cy + r) +
                    ' A ' + (r * Math.abs(k)) + ' ' + r + ' 0 0 ' + (k > 0 ? '0' : '1') + ' ' + cx + ' ' + (cy - r);
            }

            path.setAttribute('d', d);
        }

        // Add sun-arr-eta to time picker callback
        var originalTimePickerCallback = null;

        function exportAllData() {
            const now = new Date();
            let md = `# Flight Ops Export\n\n`;
            md += `**Generated:** ${now.toISOString()}\n\n`;

            // Schedule
            const schedule = JSON.parse(localStorage.getItem('flightSchedule') || '{}');
            md += `## Schedule\n\n`;
            md += `- Sectors: ${schedule.sectorCount || 0}\n`;
            md += `- Aircraft: ${schedule.aircraft || 'N/A'}\n`;
            md += `- Tail: ${schedule.tail || 'N/A'}\n\n`;

            // Notes
            const notes = document.getElementById('notes-scratchpad')?.value || '';
            md += `## Notes\n\n\`\`\`\n${notes || 'No notes'}\n\`\`\`\n\n`;

            // Download
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flight-ops-${now.toISOString().split('T')[0]}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ INITIALIZE ============
        loadState();
        loadSchedule();
        loadOOOI();
        loadETA();
        loadTOW();
        initSunTab();
        loadACC();
        loadFuel();
        loadLayover();
        renderTimers();
        updateLimitDisplays();
        calculateFDP();
        calculateTOW();
        calculateMLF();
        calculateFuel();
        calculateLayover();
        startAnimationLoop();
        setInterval(() => {
            updateUTCClock();
            calculateETA();
            if (document.getElementById('tab-fdp').classList.contains('active')) {
                const maxFDP = getMaxFDP(
                    document.getElementById('fdp-crew-type').value,
                    document.getElementById('fdp-acclimatized').value,
                    document.getElementById('fdp-rest').value,
                    document.getElementById('fdp-report').value || '0600',
                    parseInt(document.getElementById('fdp-sectors').value, 10)
                );
                updateLiveTracker(maxFDP);
            }
        }, 1000);

        updateUTCClock();
        updateActiveTimersStrip();

        // Coordinate converter GPS data (must be defined before startGpsPolling)
        var coordGpsData = { lat: null, lon: null, track: null, speed: null, available: false };

        startGpsPolling(); // Start GPS for info strip display

        window.addEventListener('beforeunload', saveState);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const now = Date.now();
                timers.forEach((timer, index) => {
                    if (timer.running && timer.lastUpdate) {
                        const elapsed = now - timer.lastUpdate;
                        if (timer.type === 'countdown') {
                            const wasPositive = timer.remaining > 0;
                            timer.remaining = Math.max(0, timer.remaining - elapsed);
                            if (wasPositive && timer.remaining === 0) {
                                timer.running = false;
                                flashTimer(index, 5);
                            }
                        } else {
                            timer.elapsed += elapsed;
                        }
                        timer.lastUpdate = now;
                        updateTimerDisplay(index);
                    }
                });
                renderTimers();
                startAnimationLoop();
            }
        });

        // ============ CROSSWIND CALCULATOR ============
        function openRunwayHdgPicker() {
            const currentVal = document.getElementById('xwind-rwy').value || '';
            openPicker('Runway Heading', 'Â°', currentVal, 3, false, (val) => {
                let hdg = parseInt(val) || 0;
                if (hdg > 360) hdg = 360;
                const hdgStr = hdg ? hdg.toString().padStart(3, '0') : '';
                document.getElementById('xwind-rwy').value = hdgStr;
                document.getElementById('xwind-rwy-btn').textContent = hdgStr ? hdgStr + 'Â°' : '---Â°';
                document.getElementById('xwind-rwy-btn').classList.toggle('placeholder', !hdgStr);
                calculateCrosswind();
            });
        }

        function openWindDirPicker() {
            const currentVal = document.getElementById('xwind-dir').value || '';
            openPicker('Wind Direction', 'Â°', currentVal, 3, false, (val) => {
                let dir = parseInt(val) || 0;
                if (dir > 360) dir = 360;
                const dirStr = dir ? dir.toString().padStart(3, '0') : '';
                document.getElementById('xwind-dir').value = dirStr;
                document.getElementById('xwind-dir-btn').textContent = dirStr ? dirStr + 'Â°' : '---Â°';
                document.getElementById('xwind-dir-btn').classList.toggle('placeholder', !dirStr);
                calculateCrosswind();
            });
        }

        function openWindSpdPicker(fieldId, title) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title, 'kt', currentVal, 3, false, (val) => {
                const spd = parseInt(val) || 0;
                document.getElementById(fieldId).value = spd || '';
                document.getElementById(fieldId + '-btn').textContent = spd ? spd + ' kt' : '-- kt';
                document.getElementById(fieldId + '-btn').classList.toggle('placeholder', !spd);
                calculateCrosswind();
            });
        }

        function calculateCrosswind() {
            const rwyInput = document.getElementById('xwind-rwy').value;
            const dirInput = document.getElementById('xwind-dir').value;
            const spdInput = document.getElementById('xwind-spd').value;
            const gustInput = document.getElementById('xwind-gust').value;

            // Update SVG runway rotation
            const runwaySvg = document.getElementById('runway-svg');
            const windArrowSvg = document.getElementById('wind-arrow-svg');

            if (rwyInput) {
                const rwyHdg = parseInt(rwyInput);
                runwaySvg.setAttribute('transform', `rotate(${rwyHdg}, 100, 100)`);

                // Update runway numbers (heading / 10, rounded)
                const rwyNum = Math.round(rwyHdg / 10) || 36;
                const reciprocal = rwyNum > 18 ? rwyNum - 18 : rwyNum + 18;

                // Position runway numbers at the ends of the runway (accounting for rotation)
                const rwyRad = rwyHdg * Math.PI / 180;
                // Approach end (where the runway number faces - at threshold end)
                const approachX = 100 + Math.sin(rwyRad) * 80;
                const approachY = 100 - Math.cos(rwyRad) * 80;
                // Departure end (reciprocal)
                const departX = 100 - Math.sin(rwyRad) * 80;
                const departY = 100 + Math.cos(rwyRad) * 80;

                const rwyNumApproach = document.getElementById('rwy-num-approach');
                const rwyNumDepart = document.getElementById('rwy-num-depart');
                rwyNumApproach.setAttribute('x', approachX);
                rwyNumApproach.setAttribute('y', approachY + 4);
                rwyNumApproach.textContent = rwyNum.toString().padStart(2, '0');
                rwyNumDepart.setAttribute('x', departX);
                rwyNumDepart.setAttribute('y', departY + 4);
                rwyNumDepart.textContent = reciprocal.toString().padStart(2, '0');
            }

            if (dirInput) {
                const windDir = parseInt(dirInput);
                // Wind arrow shows where wind is coming FROM (arrow points toward center)
                windArrowSvg.setAttribute('transform', `rotate(${windDir}, 100, 100)`);

                // Position wind direction label near the arrow source
                const windRad = windDir * Math.PI / 180;
                const labelX = 100 + Math.sin(windRad) * 75;
                const labelY = 100 - Math.cos(windRad) * 75;
                const windLabel = document.getElementById('wind-dir-label');
                windLabel.setAttribute('x', labelX);
                windLabel.setAttribute('y', labelY + 4);
                windLabel.textContent = dirInput.padStart(3, '0') + 'Â°';
            }

            if (!rwyInput || !dirInput || !spdInput) {
                document.getElementById('headwind-val').textContent = '--';
                document.getElementById('crosswind-val').textContent = '--';
                return;
            }

            const rwyHdg = parseInt(rwyInput); // Now using heading directly
            const windDir = parseInt(dirInput);
            const windSpd = parseInt(spdInput);
            const gust = gustInput ? parseInt(gustInput) : windSpd;

            // Calculate angle difference
            let angleDiff = windDir - rwyHdg;
            while (angleDiff > 180) angleDiff -= 360;
            while (angleDiff < -180) angleDiff += 360;

            const angleRad = angleDiff * Math.PI / 180;

            // Calculate components using max of steady wind and gust
            const maxWind = Math.max(windSpd, gust);
            const headwind = Math.round(Math.cos(angleRad) * maxWind);
            const crosswind = Math.round(Math.abs(Math.sin(angleRad) * maxWind));

            // Update display
            const headwindEl = document.getElementById('headwind-val');
            if (headwind >= 0) {
                headwindEl.textContent = `H${headwind}`;
                headwindEl.className = 'component-value headwind';
            } else {
                headwindEl.textContent = `T${Math.abs(headwind)}`;
                headwindEl.className = 'component-value tailwind';
            }

            const crosswindEl = document.getElementById('crosswind-val');
            const side = angleDiff > 0 ? 'R' : 'L';
            crosswindEl.textContent = `${crosswind}${side}`;

            // Check against RWYCC limit
            checkCrosswindLimit();
        }

        function openOPTWindPicker() {
            const currentDir = document.getElementById('xwind-dir').value || '';
            const currentSpd = document.getElementById('xwind-spd').value || '';
            const currentVal = currentDir && currentSpd ? `${currentDir}/${currentSpd}` : '';

            const input = prompt('Enter wind in OPT format:\nâ€¢ 220/13 (direction/speed in kt)\nâ€¢ 220/3m (direction/speed in m/s)\n\nExamples: 270/15, 180/5m', currentVal);

            if (input !== null && input.trim()) {
                // Parse OPT format: DIR/SPD or DIR/SPDm
                const match = input.trim().match(/^(\d{1,3})\/(\d{1,3})(m)?$/i);
                if (match) {
                    let dir = parseInt(match[1]);
                    let spd = parseInt(match[2]);
                    const isMetersPerSec = match[3] && match[3].toLowerCase() === 'm';

                    // Convert m/s to knots if needed (1 m/s â‰ˆ 1.944 kt)
                    if (isMetersPerSec) {
                        spd = Math.round(spd * 1.944);
                    }

                    // Validate direction
                    if (dir > 360) dir = 360;
                    if (dir === 0) dir = 360;

                    // Set values
                    document.getElementById('xwind-dir').value = dir.toString();
                    document.getElementById('xwind-dir-btn').textContent = dir.toString().padStart(3, '0') + 'Â°';
                    document.getElementById('xwind-spd').value = spd.toString();
                    document.getElementById('xwind-spd-btn').textContent = spd + ' kt';
                    document.getElementById('xwind-opt-btn').textContent = `${dir.toString().padStart(3, '0')}/${spd}`;

                    calculateCrosswind();
                } else {
                    alert('Invalid format. Use: 220/13 or 220/3m');
                }
            }
        }

        function clearCrosswind() {
            ['xwind-rwy', 'xwind-dir', 'xwind-spd', 'xwind-gust'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('xwind-rwy-btn').textContent = '---Â°';
            document.getElementById('xwind-dir-btn').textContent = '---Â°';
            document.getElementById('xwind-spd-btn').textContent = '-- kt';
            document.getElementById('xwind-gust-btn').textContent = '-- kt';
            document.getElementById('headwind-val').textContent = '--';
            document.getElementById('crosswind-val').textContent = '--';
            document.getElementById('runway-svg').setAttribute('transform', 'rotate(0, 100, 100)');
            document.getElementById('wind-arrow-svg').setAttribute('transform', 'rotate(0, 100, 100)');
            document.getElementById('rwy-num-approach').textContent = '';
            document.getElementById('rwy-num-depart').textContent = '';
            document.getElementById('wind-dir-label').textContent = '';
        }

        // ============ HOLD ENTRY CALCULATOR ============
        function openHeadingPicker(fieldId, title) {
            const currentVal = document.getElementById(fieldId).value || '';
            openPicker(title, 'Â°', currentVal, 3, false, (val) => {
                let hdg = parseInt(val) || 0;
                if (hdg > 360) hdg = 360;
                const hdgStr = hdg ? hdg.toString().padStart(3, '0') : '';
                document.getElementById(fieldId).value = hdgStr;
                document.getElementById(fieldId + '-btn').textContent = hdgStr || '---';
                document.getElementById(fieldId + '-btn').classList.toggle('placeholder', !hdgStr);
                calculateHoldEntry();
            });
        }

        function setHoldTurn(dir) {
            document.getElementById('hold-turn-dir').value = dir;
            document.getElementById('hold-turn-l').classList.toggle('active', dir === 'left');
            document.getElementById('hold-turn-r').classList.toggle('active', dir === 'right');
            calculateHoldEntry();
        }

        function calculateHoldEntry() {
            const inboundInput = document.getElementById('hold-inbound').value;
            const hdgInput = document.getElementById('hold-hdg').value;
            const turnDir = document.getElementById('hold-turn-dir').value;

            if (!inboundInput || !hdgInput) {
                document.getElementById('hold-entry-type').textContent = '---';
                document.getElementById('hold-entry-desc').textContent = '';
                return;
            }

            const inboundCourse = parseInt(inboundInput);
            const yourHdg = parseInt(hdgInput);

            // Calculate relative bearing to the fix
            let relativeBearing = inboundCourse - yourHdg;
            while (relativeBearing < 0) relativeBearing += 360;
            while (relativeBearing >= 360) relativeBearing -= 360;

            // For right turns, the sectors are:
            // Direct: 0-110Â° relative to inbound
            // Teardrop: 110-180Â° relative to inbound (plus 70Â° offset)
            // Parallel: 180-360Â° relative to inbound

            let entryType, entryDesc;

            if (turnDir === 'right') {
                if (relativeBearing >= 0 && relativeBearing <= 70) {
                    entryType = 'DIRECT';
                    entryDesc = 'Turn right to join hold';
                } else if (relativeBearing > 70 && relativeBearing <= 180) {
                    entryType = 'TEARDROP';
                    entryDesc = 'Fly 30Â° offset, then turn to intercept inbound';
                } else {
                    entryType = 'PARALLEL';
                    entryDesc = 'Fly parallel to outbound, then turn back';
                }
            } else {
                // Left turns - mirror the sectors
                if (relativeBearing >= 290 || relativeBearing <= 0) {
                    entryType = 'DIRECT';
                    entryDesc = 'Turn left to join hold';
                } else if (relativeBearing >= 180 && relativeBearing < 290) {
                    entryType = 'TEARDROP';
                    entryDesc = 'Fly 30Â° offset, then turn to intercept inbound';
                } else {
                    entryType = 'PARALLEL';
                    entryDesc = 'Fly parallel to outbound, then turn back';
                }
            }

            document.getElementById('hold-entry-type').textContent = entryType;
            document.getElementById('hold-entry-desc').textContent = entryDesc;

            // Update SVG visualization
            updateHoldGraphic(inboundCourse, yourHdg, turnDir, entryType);
        }

        function updateHoldGraphic(inbound, yourHdg, turnDir, entryType) {
            const sectors = document.getElementById('hold-sectors');
            const holdPattern = document.getElementById('hold-pattern');
            const aircraft = document.getElementById('aircraft-symbol');

            // Rotate sectors and hold pattern based on inbound course
            // Inbound is from the south (180Â°) by default, so rotation = inbound - 180
            // This makes the inbound leg point in the direction of the inbound course
            const rotation = inbound - 180;
            sectors.setAttribute('transform', `rotate(${rotation}, 150, 150)`);

            // For left-hand holds, mirror the pattern horizontally around the fix
            if (turnDir === 'left') {
                holdPattern.setAttribute('transform', `rotate(${rotation}, 150, 150) scale(-1,1) translate(-300,0)`);
            } else {
                holdPattern.setAttribute('transform', `rotate(${rotation}, 150, 150)`);
            }

            // Position aircraft based on your heading approaching the fix
            // Aircraft is positioned at the edge of the sector circle, pointing toward fix
            const radius = 110;
            const angleRad = (yourHdg - 90) * Math.PI / 180; // -90 to align with SVG coords (0Â° = up)
            const acX = 150 + radius * Math.cos(angleRad);
            const acY = 150 + radius * Math.sin(angleRad);

            // Aircraft points toward center (fix) at 150,150
            const pointAngle = Math.atan2(150 - acY, 150 - acX) * 180 / Math.PI + 90;
            aircraft.setAttribute('transform', `translate(${acX}, ${acY}) rotate(${pointAngle})`);

            // Highlight active sector based on entry type
            const sectorDirect = document.getElementById('sector-direct');
            const sectorTeardrop = document.getElementById('sector-teardrop');
            const sectorParallel = document.getElementById('sector-parallel');

            // Reset all sectors to dim
            sectorDirect.setAttribute('fill', 'rgba(0,255,136,0.15)');
            sectorTeardrop.setAttribute('fill', 'rgba(255,215,0,0.15)');
            sectorParallel.setAttribute('fill', 'rgba(0,212,255,0.15)');

            // Highlight the active entry sector
            if (entryType === 'DIRECT') {
                sectorDirect.setAttribute('fill', 'rgba(0,255,136,0.4)');
            } else if (entryType === 'TEARDROP') {
                sectorTeardrop.setAttribute('fill', 'rgba(255,215,0,0.4)');
            } else if (entryType === 'PARALLEL') {
                sectorParallel.setAttribute('fill', 'rgba(0,212,255,0.4)');
            }
        }

        function clearHoldEntry() {
            ['hold-inbound', 'hold-hdg'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id + '-btn').textContent = '---';
                document.getElementById(id + '-btn').classList.add('placeholder');
            });
            document.getElementById('hold-entry-type').textContent = '---';
            document.getElementById('hold-entry-desc').textContent = '';
        }

        // ============ ISA CALCULATOR ============
        function calculateISA() {
            const altInput = document.getElementById('isa-alt').value;
            const oatInput = document.getElementById('isa-oat').value;

            const altitude = altInput ? parseInt(altInput) : 0;
            const oat = oatInput ? parseInt(oatInput) : 15;

            // ISA temperature at altitude: 15Â°C - (1.98Â°C per 1000ft)
            const isaTemp = 15 - (altitude / 1000 * 1.98);
            const isaDev = oat - isaTemp;

            document.getElementById('isa-temp').textContent = `${isaTemp >= 0 ? '+' : ''}${isaTemp.toFixed(1)}Â°C`;

            const devEl = document.getElementById('isa-dev');
            if (Math.abs(isaDev) < 0.5) {
                devEl.textContent = 'ISA Â±0Â°C';
                devEl.className = 'isa-deviation neutral';
            } else if (isaDev > 0) {
                devEl.textContent = `ISA +${isaDev.toFixed(0)}Â°C`;
                devEl.className = 'isa-deviation positive';
            } else {
                devEl.textContent = `ISA ${isaDev.toFixed(0)}Â°C`;
                devEl.className = 'isa-deviation negative';
            }
        }

        function syncAirfieldElev() {
            var icao = document.getElementById('isa-airfield').value.toUpperCase().trim();
            var nameEl = document.getElementById('isa-airfield-name');

            if (!icao || icao.length !== 4) {
                nameEl.textContent = '';
                return;
            }

            var apt = getAirport(icao);
            if (!apt) {
                nameEl.textContent = 'Not found';
                nameEl.style.color = '#ff5252';
                return;
            }

            // Display airport name
            nameEl.textContent = apt.m ? apt.m : apt.n.replace(/Airport|International|Intl/gi, '').trim();
            nameEl.style.color = '#00d4ff';

            // Get elevation - 'e' field in airport data
            var elev = apt.e || 0;

            // Set ISA altitude
            document.getElementById('isa-alt').value = elev;
            document.getElementById('isa-alt-btn').textContent = elev.toLocaleString() + ' ft';
            document.getElementById('isa-alt-btn').classList.remove('placeholder');

            calculateISA();
        }

        var isaTempNegative = false;

        function openISAPicker() {
            const currentVal = document.getElementById('isa-oat').value || '15';
            const absVal = Math.abs(parseInt(currentVal));
            isaTempNegative = parseInt(currentVal) < 0;
            openTempPicker('OAT Temperature', absVal.toString(), (val, isNeg) => {
                const finalVal = isNeg ? -parseInt(val || 0) : parseInt(val || 0);
                document.getElementById('isa-oat').value = finalVal;
                document.getElementById('isa-oat-btn').textContent = `${finalVal >= 0 ? '+' : ''}${finalVal}`;
                document.getElementById('isa-oat-btn').classList.remove('placeholder');
                calculateISA();
            });
        }

        function openTempPicker(title, currentValue, callback) {
            // Create temp picker modal if it doesn't exist
            let tempModal = document.getElementById('temp-picker-modal');
            if (!tempModal) {
                tempModal = document.createElement('div');
                tempModal.id = 'temp-picker-modal';
                tempModal.className = 'modal-overlay';
                tempModal.innerHTML = `
                    <div class="picker-container">
                        <div class="picker-display">
                            <span id="temp-picker-sign" style="font-size:1.8rem;color:#FF8200;cursor:pointer" onclick="toggleTempSign()">+</span>
                            <span id="temp-picker-value">0</span>
                            <span class="picker-unit">Â°C</span>
                        </div>
                        <div class="picker-title" id="temp-picker-title">${title}</div>
                        <div class="picker-grid">
                            <button class="picker-btn" onclick="tempPickerAppend('1')">1</button>
                            <button class="picker-btn" onclick="tempPickerAppend('2')">2</button>
                            <button class="picker-btn" onclick="tempPickerAppend('3')">3</button>
                            <button class="picker-btn" onclick="tempPickerAppend('4')">4</button>
                            <button class="picker-btn" onclick="tempPickerAppend('5')">5</button>
                            <button class="picker-btn" onclick="tempPickerAppend('6')">6</button>
                            <button class="picker-btn" onclick="tempPickerAppend('7')">7</button>
                            <button class="picker-btn" onclick="tempPickerAppend('8')">8</button>
                            <button class="picker-btn" onclick="tempPickerAppend('9')">9</button>
                            <button class="picker-btn sign-btn" onclick="toggleTempSign()">+/-</button>
                            <button class="picker-btn" onclick="tempPickerAppend('0')">0</button>
                            <button class="picker-btn" onclick="tempPickerBackspace()">&#9003;</button>
                        </div>
                        <div class="picker-actions">
                            <button class="picker-cancel" onclick="closeTempPicker()">Cancel</button>
                            <button class="picker-confirm" onclick="confirmTempPicker()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(tempModal);
            }

            window.tempPickerCallback = callback;
            window.tempPickerValue = currentValue || '';
            window.tempPickerFirstInput = true;
            document.getElementById('temp-picker-title').textContent = title;
            document.getElementById('temp-picker-sign').textContent = isaTempNegative ? '-' : '+';
            updateTempPickerDisplay();
            tempModal.classList.add('active');
        }

        function updateTempPickerDisplay() {
            document.getElementById('temp-picker-value').textContent = window.tempPickerValue || '0';
        }

        function toggleTempSign() {
            isaTempNegative = !isaTempNegative;
            document.getElementById('temp-picker-sign').textContent = isaTempNegative ? '-' : '+';
        }

        function tempPickerAppend(digit) {
            if (window.tempPickerFirstInput && window.tempPickerValue.length > 0) {
                window.tempPickerValue = '';
            }
            window.tempPickerFirstInput = false;
            if (window.tempPickerValue.length < 3) {
                window.tempPickerValue += digit;
                updateTempPickerDisplay();
            }
        }

        function tempPickerBackspace() {
            window.tempPickerFirstInput = false;
            window.tempPickerValue = window.tempPickerValue.slice(0, -1);
            updateTempPickerDisplay();
        }

        function closeTempPicker() {
            document.getElementById('temp-picker-modal').classList.remove('active');
            window.tempPickerCallback = null;
        }

        function confirmTempPicker() {
            if (window.tempPickerCallback) {
                window.tempPickerCallback(window.tempPickerValue, isaTempNegative);
            }
            closeTempPicker();
        }

        function clearISA() {
            document.getElementById('isa-alt').value = '';
            document.getElementById('isa-alt-btn').textContent = '0';
            document.getElementById('isa-oat').value = '15';
            document.getElementById('isa-oat-btn').textContent = '+15';
            document.getElementById('isa-temp').textContent = '+15Â°C';
            document.getElementById('isa-dev').textContent = 'ISA Â±0Â°C';
            document.getElementById('isa-dev').className = 'isa-deviation neutral';
        }

        // ============ WEATHER TEMPERATURE PICKER ============
        var wxTempFieldId = '';
        var wxTempNegative = false;

        function openWxTempPicker(fieldId, title) {
            wxTempFieldId = fieldId;
            var currentVal = document.getElementById(fieldId).value || '0';
            var absVal = Math.abs(parseInt(currentVal)) || 0;
            wxTempNegative = parseInt(currentVal) < 0;

            openTempPicker(title, absVal.toString(), function(val, isNeg) {
                var finalVal = isNeg ? -parseInt(val || 0) : parseInt(val || 0);
                document.getElementById(fieldId).value = finalVal;
                var btn = document.getElementById(fieldId + '-btn');
                if (btn) {
                    btn.textContent = (finalVal >= 0 ? '+' : '') + finalVal + 'Â°C';
                }
                // Trigger appropriate calculate function
                if (fieldId.startsWith('wx-')) {
                    calculateWeather();
                } else if (fieldId.startsWith('gp-')) {
                    calculateGlidePath();
                }
            });
        }

        // ============ GLIDE PATH ANGLE PICKER ============
        function openGlidePicker(fieldId, title) {
            var currentVal = document.getElementById(fieldId).value || '3.0';
            // Use the generic weight picker but format for decimal
            openWeightPicker(fieldId, title, 'Â°');
        }

        // ============ WEATHER / FEELS LIKE CALCULATOR ============
        function calculateWeather() {
            var temp = parseFloat(document.getElementById('wx-temp').value);
            var dewpoint = parseFloat(document.getElementById('wx-dewpoint').value);
            var windKt = parseFloat(document.getElementById('wx-wind').value) || 0;
            var windKmh = windKt * 1.852;

            var feelsEl = document.getElementById('wx-feels');
            var heatIndexEl = document.getElementById('wx-heat-index');
            var windChillEl = document.getElementById('wx-wind-chill');
            var rhEl = document.getElementById('wx-rh');

            // Calculate Relative Humidity
            var rh = null;
            if (!isNaN(temp) && !isNaN(dewpoint)) {
                var a = 17.625, b = 243.04;
                rh = 100 * (Math.exp((a * dewpoint) / (b + dewpoint)) / Math.exp((a * temp) / (b + temp)));
                rh = Math.min(100, Math.max(0, rh));
                rhEl.textContent = Math.round(rh) + '%';
            } else {
                rhEl.textContent = '---%';
            }

            // Calculate Heat Index (T >= 27Â°C)
            var hiC = null;
            if (!isNaN(temp) && temp >= 27 && rh !== null) {
                var tempF = temp * 9/5 + 32;
                var hi = -42.379 + 2.04901523*tempF + 10.14333127*rh - 0.22475541*tempF*rh
                       - 0.00683783*tempF*tempF - 0.05481717*rh*rh + 0.00122874*tempF*tempF*rh
                       + 0.00085282*tempF*rh*rh - 0.00000199*tempF*tempF*rh*rh;
                hiC = Math.round((hi - 32) * 5/9);
                heatIndexEl.textContent = hiC + 'Â°C';
                heatIndexEl.style.color = hiC >= 41 ? '#ff5252' : hiC >= 32 ? '#ff8200' : '#ffd700';
            } else {
                heatIndexEl.textContent = '---';
                heatIndexEl.style.color = '#ff8200';
            }

            // Calculate Wind Chill (T <= 10Â°C, wind >= 4.8 km/h)
            var wcC = null;
            if (!isNaN(temp) && temp <= 10 && windKmh >= 4.8) {
                wcC = Math.round(13.12 + 0.6215*temp - 11.37*Math.pow(windKmh, 0.16) + 0.3965*temp*Math.pow(windKmh, 0.16));
                windChillEl.textContent = wcC + 'Â°C';
                windChillEl.style.color = wcC <= -28 ? '#ff5252' : wcC <= -10 ? '#00d4ff' : '#00ff88';
            } else {
                windChillEl.textContent = '---';
                windChillEl.style.color = '#00d4ff';
            }

            // Determine "Feels Like" - use heat index or wind chill, or actual temp
            if (feelsEl) {
                if (hiC !== null && hiC > temp) {
                    feelsEl.textContent = hiC + 'Â°C';
                    feelsEl.style.color = hiC >= 41 ? '#ff5252' : '#ff8200';
                } else if (wcC !== null && wcC < temp) {
                    feelsEl.textContent = wcC + 'Â°C';
                    feelsEl.style.color = wcC <= -10 ? '#00d4ff' : '#00ff88';
                } else if (!isNaN(temp)) {
                    feelsEl.textContent = temp + 'Â°C';
                    feelsEl.style.color = '#00ff88';
                } else {
                    feelsEl.textContent = '---';
                    feelsEl.style.color = '#FF8200';
                }
            }
        }

        function clearWeather() {
            document.getElementById('wx-temp').value = '';
            document.getElementById('wx-temp-btn').textContent = '---';
            document.getElementById('wx-dewpoint').value = '';
            document.getElementById('wx-dewpoint-btn').textContent = '---';
            document.getElementById('wx-wind').value = '';
            document.getElementById('wx-wind-btn').textContent = '---';
            document.getElementById('wx-rh').textContent = '---%';
            document.getElementById('wx-heat-index').textContent = '---';
            document.getElementById('wx-wind-chill').textContent = '---';
            var feelsEl = document.getElementById('wx-feels');
            if (feelsEl) feelsEl.textContent = '---';
        }

        // ============ METAR PARSER ============
        function syncFromMETAR() {
            var input = document.getElementById('metar-input').value.toUpperCase().trim();
            var parsedEl = document.getElementById('metar-parsed');

            if (!input) {
                parsedEl.innerHTML = '';
                return;
            }

            var parsed = {};

            // Parse wind: 31008KT, 31008G15KT, VRB03KT
            var windMatch = input.match(/\b(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT\b/);
            if (windMatch) {
                parsed.windDir = windMatch[1] === 'VRB' ? null : parseInt(windMatch[1]);
                parsed.windSpd = parseInt(windMatch[2]);
                parsed.gust = windMatch[4] ? parseInt(windMatch[4]) : null;
            }

            // Parse temp/dewpoint: 22/08, M05/M10
            var tempMatch = input.match(/\b(M?\d{2})\/(M?\d{2})\b/);
            if (tempMatch) {
                parsed.temp = parseInt(tempMatch[1].replace('M', '-'));
                parsed.dewpoint = parseInt(tempMatch[2].replace('M', '-'));
            }

            // Parse QNH: Q1018 or A2992
            var qnhMatch = input.match(/\b(Q(\d{4})|A(\d{4}))\b/);
            if (qnhMatch) {
                if (qnhMatch[2]) {
                    parsed.qnh = parseInt(qnhMatch[2]);
                } else if (qnhMatch[3]) {
                    parsed.qnh = Math.round(parseInt(qnhMatch[3]) / 100 * 33.8639);
                }
            }

            // Parse ICAO
            var icaoMatch = input.match(/^([A-Z]{4})\s/);
            if (icaoMatch) {
                parsed.icao = icaoMatch[1];
            }

            // Display parsed data
            var info = [];
            if (parsed.icao) info.push(parsed.icao);
            if (parsed.windDir !== undefined) {
                var windStr = parsed.windDir === null ? 'VRB' : parsed.windDir.toString().padStart(3, '0');
                windStr += '/' + parsed.windSpd;
                if (parsed.gust) windStr += 'G' + parsed.gust;
                windStr += 'kt';
                info.push('Wind: ' + windStr);
            }
            if (parsed.temp !== undefined) {
                info.push('Temp: ' + parsed.temp + '/' + parsed.dewpoint + 'Â°C');
            }
            if (parsed.qnh) info.push('QNH: ' + parsed.qnh);

            parsedEl.innerHTML = info.length > 0 ?
                '<span style="color:#00ff88;">âœ“ ' + info.join(' | ') + '</span>' :
                '<span style="color:#ff5252;">Could not parse METAR</span>';

            // Sync to crosswind calculator
            if (parsed.windDir !== null && parsed.windDir !== undefined) {
                document.getElementById('xwind-dir').value = parsed.windDir;
                document.getElementById('xwind-dir-btn').textContent = parsed.windDir.toString().padStart(3, '0') + 'Â°';
            }
            if (parsed.windSpd !== undefined) {
                document.getElementById('xwind-spd').value = parsed.windSpd;
                document.getElementById('xwind-spd-btn').textContent = parsed.windSpd + ' kt';
                var optBtn = document.getElementById('xwind-opt-btn');
                if (parsed.windDir !== null && parsed.windDir !== undefined) {
                    optBtn.textContent = parsed.windDir.toString().padStart(3, '0') + '/' + parsed.windSpd;
                }
            }
            if (parsed.gust) {
                document.getElementById('xwind-gust').value = parsed.gust;
                document.getElementById('xwind-gust-btn').textContent = parsed.gust + ' kt';
            }
            calculateCrosswind();

            // Sync to Real Feel calculator
            if (parsed.temp !== undefined) {
                document.getElementById('wx-temp').value = parsed.temp;
                document.getElementById('wx-temp-btn').textContent = (parsed.temp >= 0 ? '+' : '') + parsed.temp + 'Â°C';
                // Also set ISA OAT
                document.getElementById('isa-oat').value = parsed.temp;
                document.getElementById('isa-oat-btn').textContent = (parsed.temp >= 0 ? '+' : '') + parsed.temp + 'Â°C';
            }
            if (parsed.dewpoint !== undefined) {
                document.getElementById('wx-dewpoint').value = parsed.dewpoint;
                document.getElementById('wx-dewpoint-btn').textContent = (parsed.dewpoint >= 0 ? '+' : '') + parsed.dewpoint + 'Â°C';
            }
            if (parsed.windSpd !== undefined) {
                document.getElementById('wx-wind').value = parsed.windSpd;
                document.getElementById('wx-wind-btn').textContent = parsed.windSpd + ' kt';
            }
            calculateWeather();
            calculateISA();
        }

        // ============ GLIDE PATH / RATE OF DESCENT CALCULATOR ============
        function calculateGlidePath() {
            var elev = parseFloat(document.getElementById('gp-elev').value) || 0;
            var oat = parseFloat(document.getElementById('gp-oat').value);
            var gpAngle = parseFloat(document.getElementById('gp-angle').value) || 3.0;
            var gs = parseFloat(document.getElementById('gp-gs').value);

            // Calculate ISA temperature at airport elevation
            // ISA at sea level = 15Â°C, lapse rate = 1.98Â°C per 1000ft
            var isaAtElev = 15 - (elev / 1000) * 1.98;
            document.getElementById('gp-isa').textContent = isaAtElev.toFixed(1) + 'Â°C';

            // Calculate temperature deviation from ISA
            var gpDevEl = document.getElementById('gp-dev');
            var gpEffectiveEl = document.getElementById('gp-effective');
            var gpHotColdEl = document.getElementById('gp-hot-cold');
            var gpRodEl = document.getElementById('gp-rod');

            if (!isNaN(oat)) {
                var tempDev = oat - isaAtElev;
                if (tempDev >= 0) {
                    gpDevEl.textContent = 'ISA +' + Math.round(tempDev) + 'Â°C';
                    gpDevEl.style.color = '#ff8200';
                } else {
                    gpDevEl.textContent = 'ISA ' + Math.round(tempDev) + 'Â°C';
                    gpDevEl.style.color = '#00d4ff';
                }

                // Calculate effective glide path angle
                // Hot = air is less dense = fly lower = steeper effective angle
                // Cold = air is denser = fly higher = shallower effective angle
                // Correction: approximately 0.1Â° per 15Â°C deviation from ISA
                // More accurate: use temperature ratio
                var tempRatio = (273.15 + isaAtElev) / (273.15 + oat);
                var effectiveGP = gpAngle * tempRatio;

                gpEffectiveEl.textContent = effectiveGP.toFixed(2) + 'Â°';

                if (tempDev > 5) {
                    gpHotColdEl.innerHTML = '<span style="color:#ff8200">HOT - Fly Lower</span>';
                    gpEffectiveEl.style.color = '#ff8200';
                } else if (tempDev < -5) {
                    gpHotColdEl.innerHTML = '<span style="color:#00d4ff">COLD - Fly Higher</span>';
                    gpEffectiveEl.style.color = '#00d4ff';
                } else {
                    gpHotColdEl.innerHTML = '<span style="color:#00ff88">Near ISA</span>';
                    gpEffectiveEl.style.color = '#00ff88';
                }
            } else {
                gpDevEl.textContent = '---';
                gpDevEl.style.color = '#888';
                gpEffectiveEl.textContent = gpAngle.toFixed(2) + 'Â°';
                gpEffectiveEl.style.color = '#00ff88';
                gpHotColdEl.innerHTML = '';
            }

            // Calculate Rate of Descent
            // ROD (fpm) = Ground Speed (nm/hr) Ã— tan(GP angle) Ã— 6076.12 / 60
            // Simplified: ROD = GS Ã— GP(degrees) Ã— 17.45 / 60 â‰ˆ GS Ã— GP Ã— 0.29
            // Or using tangent: ROD = GS Ã— tan(GP Ã— Ï€/180) Ã— 101.27
            if (!isNaN(gs) && gs > 0) {
                var gpRad = gpAngle * Math.PI / 180;
                var rod = gs * Math.tan(gpRad) * 101.27;
                gpRodEl.textContent = Math.round(rod) + ' fpm';

                // Color based on typical ranges
                if (rod > 1000) {
                    gpRodEl.style.color = '#ff5252';
                } else if (rod > 800) {
                    gpRodEl.style.color = '#ff8200';
                } else {
                    gpRodEl.style.color = '#00ff88';
                }
            } else {
                gpRodEl.textContent = '--- fpm';
                gpRodEl.style.color = '#ff8200';
            }
        }

        function clearGlidePath() {
            document.getElementById('gp-airport').value = '';
            document.getElementById('gp-elev').value = '';
            document.getElementById('gp-elev-btn').textContent = '---';
            document.getElementById('gp-elev-btn').classList.add('placeholder');
            document.getElementById('gp-oat').value = '';
            document.getElementById('gp-oat-btn').textContent = '---';
            document.getElementById('gp-angle').value = '3.0';
            document.getElementById('gp-angle-btn').textContent = '3.0';
            document.getElementById('gp-gs').value = '';
            document.getElementById('gp-gs-btn').textContent = '---';
            document.getElementById('gp-isa').textContent = '---Â°C';
            document.getElementById('gp-dev').textContent = '---';
            document.getElementById('gp-dev').style.color = '#888';
            document.getElementById('gp-effective').textContent = '---Â°';
            document.getElementById('gp-effective').style.color = '#00ff88';
            document.getElementById('gp-hot-cold').innerHTML = '';
            document.getElementById('gp-rod').textContent = '--- fpm';
            document.getElementById('gp-rod').style.color = '#ff8200';
        }

        // ============ CLIMB GRADIENT CALCULATOR ============
        function calculateClimbGradient() {
            var roc = parseFloat(document.getElementById('climb-roc').value);
            var gs = parseFloat(document.getElementById('climb-gs').value);

            var gradientEl = document.getElementById('climb-gradient');
            var angleEl = document.getElementById('climb-angle');

            if (!isNaN(roc) && !isNaN(gs) && gs > 0) {
                // Gradient (%) = (ROC in fpm / GS in kt) Ã— (60 / 6076.12) Ã— 100
                // Simplified: Gradient = ROC / (GS Ã— 101.27) Ã— 100
                var gradient = (roc / (gs * 101.27)) * 100;
                var angle = Math.atan(gradient / 100) * (180 / Math.PI);

                gradientEl.textContent = gradient.toFixed(1) + ' %';
                angleEl.textContent = angle.toFixed(2) + 'Â°';

                // Color based on typical climb gradients
                if (gradient >= 3.3) {
                    gradientEl.style.color = '#00ff88'; // Good climb
                } else if (gradient >= 2.4) {
                    gradientEl.style.color = '#ffd700'; // Marginal
                } else {
                    gradientEl.style.color = '#ff5252'; // Low
                }
            } else {
                gradientEl.textContent = '--- %';
                gradientEl.style.color = '#00ff88';
                angleEl.textContent = '---Â°';
            }
        }

        function clearClimbGradient() {
            document.getElementById('climb-roc').value = '';
            document.getElementById('climb-roc-btn').textContent = '---';
            document.getElementById('climb-gs').value = '';
            document.getElementById('climb-gs-btn').textContent = '---';
            document.getElementById('climb-gradient').textContent = '--- %';
            document.getElementById('climb-gradient').style.color = '#00ff88';
            document.getElementById('climb-angle').textContent = '---Â°';
        }

        // ============ QUICK ROD CALCULATOR ============
        function calculateQuickRod() {
            var angle = parseFloat(document.getElementById('qrod-angle').value) || 3.0;
            var gs = parseFloat(document.getElementById('qrod-gs').value);

            var rodEl = document.getElementById('qrod-result');

            if (!isNaN(gs) && gs > 0) {
                // ROD = GS Ã— tan(angle) Ã— 101.27
                var gpRad = angle * Math.PI / 180;
                var rod = gs * Math.tan(gpRad) * 101.27;

                rodEl.textContent = Math.round(rod) + ' fpm';

                // Color based on typical ranges
                if (rod > 1000) {
                    rodEl.style.color = '#ff5252';
                } else if (rod > 800) {
                    rodEl.style.color = '#ff8200';
                } else {
                    rodEl.style.color = '#00ff88';
                }
            } else {
                rodEl.textContent = '--- fpm';
                rodEl.style.color = '#ff8200';
            }
        }

        function clearQuickRod() {
            document.getElementById('qrod-angle').value = '3.0';
            document.getElementById('qrod-angle-btn').textContent = '3.0';
            document.getElementById('qrod-gs').value = '';
            document.getElementById('qrod-gs-btn').textContent = '---';
            document.getElementById('qrod-result').textContent = '--- fpm';
            document.getElementById('qrod-result').style.color = '#ff8200';
        }

        function autofillGpElevation() {
            var code = document.getElementById('gp-airport').value.trim().toUpperCase();
            if (code.length < 3) return;

            var apt = getAirport(code) || getAirportByIATA(code);
            if (apt && apt.e !== undefined) {
                document.getElementById('gp-elev').value = apt.e;
                document.getElementById('gp-elev-btn').textContent = apt.e;
                document.getElementById('gp-elev-btn').classList.remove('placeholder');
                calculateGlidePath();
            }
        }

        function autofillAccElevation() {
            var code = document.getElementById('acc-airport').value.trim().toUpperCase();
            if (code.length < 3) return;

            var apt = getAirport(code) || getAirportByIATA(code);
            if (apt && apt.e !== undefined) {
                document.getElementById('airfield-elev').value = apt.e;
                document.getElementById('airfield-elev-btn').textContent = apt.e;
                document.getElementById('airfield-elev-btn').classList.remove('placeholder');
                calculateACC();
            }
        }

        // ============ COORDINATES / LIDO CONVERTER ============
        function parseCoordinates(input) {
            if (!input || input.trim() === '') return null;
            input = input.trim().toUpperCase();

            var lat = null, lon = null, formatName = '';

            // Pattern 1: Decimal degrees with optional direction suffix/prefix (with separator)
            // Examples: 25.2583, 55.3000 or 25.2583N 55.3000E or N25.2583 E55.3000
            var decimalMatch = input.match(/^([NS])?(-?\d+\.?\d*)\s*([NS])?\s*[,\/\s]+\s*([EW])?(-?\d+\.?\d*)\s*([EW])?$/i);
            if (decimalMatch) {
                var latDir = decimalMatch[1] || decimalMatch[3] || 'N';
                var lonDir = decimalMatch[4] || decimalMatch[6] || 'E';
                lat = parseFloat(decimalMatch[2]);
                lon = parseFloat(decimalMatch[5]);
                if (latDir === 'S') lat = -Math.abs(lat);
                if (lonDir === 'W') lon = -Math.abs(lon);
                formatName = 'Decimal Degrees';
                return { lat, lon, format: formatName };
            }

            // Pattern 1b: Decimal degrees with direction prefix, no separator
            // Examples: N25.283E055.384 or S12.345W045.678
            var decimalNoSepMatch = input.match(/^([NS])(\d+\.?\d*)([EW])(\d+\.?\d*)$/i);
            if (decimalNoSepMatch) {
                var latDir = decimalNoSepMatch[1];
                var lonDir = decimalNoSepMatch[3];
                lat = parseFloat(decimalNoSepMatch[2]);
                lon = parseFloat(decimalNoSepMatch[4]);
                if (latDir === 'S') lat = -Math.abs(lat);
                if (lonDir === 'W') lon = -Math.abs(lon);
                formatName = 'Decimal Degrees';
                return { lat, lon, format: formatName };
            }

            // Pattern 2: DMS format - N25Â°15'30" E055Â°18'00" or 25Â°15'30"N 55Â°18'00"E
            var dmsMatch = input.match(/([NS])?\s*(\d+)[Â°Âº]\s*(\d+)[''â€²]\s*(\d+\.?\d*)[""â€³]?\s*([NS])?\s*[,\/\s]*\s*([EW])?\s*(\d+)[Â°Âº]\s*(\d+)[''â€²]\s*(\d+\.?\d*)[""â€³]?\s*([EW])?/i);
            if (dmsMatch) {
                var latDir = dmsMatch[1] || dmsMatch[5] || 'N';
                var lonDir = dmsMatch[6] || dmsMatch[10] || 'E';
                var latDeg = parseInt(dmsMatch[2]);
                var latMin = parseInt(dmsMatch[3]);
                var latSec = parseFloat(dmsMatch[4]);
                var lonDeg = parseInt(dmsMatch[7]);
                var lonMin = parseInt(dmsMatch[8]);
                var lonSec = parseFloat(dmsMatch[9]);
                lat = latDeg + latMin / 60 + latSec / 3600;
                lon = lonDeg + lonMin / 60 + lonSec / 3600;
                if (latDir === 'S') lat = -lat;
                if (lonDir === 'W') lon = -lon;
                formatName = 'DMS (Degrees Minutes Seconds)';
                return { lat, lon, format: formatName };
            }

            // Pattern 3: LIDO Format 1 - Simple Degrees: N25-15/E055-18 or N25-15E055-18
            var lido1Match = input.match(/([NS])(\d{1,2})-(\d{2})\s*[\/\s]*([EW])(\d{1,3})-(\d{2})/i);
            if (lido1Match) {
                var latDir = lido1Match[1];
                var latDeg = parseInt(lido1Match[2]);
                var latMin = parseInt(lido1Match[3]);
                var lonDir = lido1Match[4];
                var lonDeg = parseInt(lido1Match[5]);
                var lonMin = parseInt(lido1Match[6]);
                lat = latDeg + latMin / 60;
                lon = lonDeg + lonMin / 60;
                if (latDir === 'S') lat = -lat;
                if (lonDir === 'W') lon = -lon;
                formatName = 'LIDO Format 1 (Simple Degrees)';
                return { lat, lon, format: formatName };
            }

            // Pattern 4: LIDO Format 2 - N2515E05518 or NS2515EW05518
            var lido2Match = input.match(/^([NS])[S]?(\d{2})(\d{2})([EW])[W]?(\d{2,3})(\d{2})$/i);
            if (lido2Match) {
                var latDir = lido2Match[1];
                var latDeg = parseInt(lido2Match[2]);
                var latMin = parseInt(lido2Match[3]);
                var lonDir = lido2Match[4];
                var lonDeg = parseInt(lido2Match[5]);
                var lonMin = parseInt(lido2Match[6]);
                lat = latDeg + latMin / 60;
                lon = lonDeg + lonMin / 60;
                if (latDir === 'S') lat = -lat;
                if (lonDir === 'W') lon = -lon;
                formatName = 'LIDO Format 2 (Deg/Min)';
                return { lat, lon, format: formatName };
            }

            // Pattern 4b: Decimal Minutes format - N25151E055218 (DD MM.M / DDD MM.M)
            // N25151 = N 25Â° 15.1', E055218 = E 055Â° 21.8'
            var decMinMatch = input.match(/^([NS])(\d{2})(\d{2})(\d)([EW])(\d{3})(\d{2})(\d)$/i);
            if (decMinMatch) {
                var latDir = decMinMatch[1];
                var latDeg = parseInt(decMinMatch[2]);
                var latMinWhole = parseInt(decMinMatch[3]);
                var latMinDec = parseInt(decMinMatch[4]);
                var lonDir = decMinMatch[5];
                var lonDeg = parseInt(decMinMatch[6]);
                var lonMinWhole = parseInt(decMinMatch[7]);
                var lonMinDec = parseInt(decMinMatch[8]);
                var latMinTotal = latMinWhole + latMinDec / 10;
                var lonMinTotal = lonMinWhole + lonMinDec / 10;
                lat = latDeg + latMinTotal / 60;
                lon = lonDeg + lonMinTotal / 60;
                if (latDir === 'S') lat = -lat;
                if (lonDir === 'W') lon = -lon;
                formatName = 'Decimal Minutes (DDM)';
                return { lat, lon, format: formatName };
            }

            // Pattern 5: LIDO Format 3 - ICAO FPL: 2515N05518E or 251530N0551800E
            var lido3Match = input.match(/^(\d{2})(\d{2})(\d{2})?([NS])(\d{2,3})(\d{2})(\d{2})?([EW])$/i);
            if (lido3Match) {
                var latDeg = parseInt(lido3Match[1]);
                var latMin = parseInt(lido3Match[2]);
                var latSec = lido3Match[3] ? parseInt(lido3Match[3]) : 0;
                var latDir = lido3Match[4];
                var lonDeg = parseInt(lido3Match[5]);
                var lonMin = parseInt(lido3Match[6]);
                var lonSec = lido3Match[7] ? parseInt(lido3Match[7]) : 0;
                var lonDir = lido3Match[8];
                lat = latDeg + latMin / 60 + latSec / 3600;
                lon = lonDeg + lonMin / 60 + lonSec / 3600;
                if (latDir === 'S') lat = -lat;
                if (lonDir === 'W') lon = -lon;
                formatName = 'LIDO Format 3 (ICAO FPL)';
                return { lat, lon, format: formatName };
            }

            // Pattern 6: ARINC 424 Five-Letter format
            // Examples: 5530N or N5530 (for latitudes in northern half, like 55N30)
            // H = NH (NE hemisphere), N = NH/NH (NE), E = SH/EH (SE), S = SH/SH (SW), W = NH/WH (NW)
            var arincMatch = input.match(/^([HNESW])?(\d)(\d)([HNESW])(\d)(\d)$/i);
            if (arincMatch) {
                var result = parseArinc424(input);
                if (result) {
                    return { lat: result.lat, lon: result.lon, format: 'ARINC 424 (5-Letter)' };
                }
            }

            // Simple ARINC: 25N55 or N2555
            var simpleArincMatch = input.match(/^(\d{2})([NSEW])(\d{2,3})$/i);
            if (simpleArincMatch) {
                var latDeg = parseInt(simpleArincMatch[1]);
                var lonDeg = parseInt(simpleArincMatch[3]);
                var dir = simpleArincMatch[2];
                if (dir === 'N' || dir === 'S') {
                    lat = latDeg;
                    lon = lonDeg;
                    if (dir === 'S') lat = -lat;
                } else {
                    lat = latDeg;
                    lon = lonDeg;
                    if (dir === 'W') lon = -lon;
                }
                formatName = 'ARINC 424 Simple';
                return { lat, lon, format: formatName };
            }

            return null;
        }

        function parseArinc424(code) {
            // ARINC 424 uses identifier letter to encode hemisphere
            // H = N lat, E lon (NE)
            // N = N lat, E lon (NE, lat < 10)
            // E = S lat, E lon (SE)
            // S = S lat, W lon (SW)
            // W = N lat, W lon (NW)
            code = code.toUpperCase();
            if (code.length !== 5) return null;

            var firstChar = code.charAt(0);
            var lastChar = code.charAt(4);
            var identifier = null;
            var digits = null;

            // Check if identifier is first or last character
            if (/[HNESW]/.test(firstChar)) {
                identifier = firstChar;
                digits = code.substring(1);
            } else if (/[HNESW]/.test(lastChar)) {
                identifier = lastChar;
                digits = code.substring(0, 4);
            } else {
                return null;
            }

            if (!/^\d{4}$/.test(digits)) return null;

            var latDeg = parseInt(digits.substring(0, 2));
            var lonTens = parseInt(digits.substring(2, 4));

            var lat = latDeg;
            var lon = lonTens * 10; // Only tens of degrees encoded

            switch (identifier) {
                case 'H': // NE hemisphere
                    lon = 100 + lonTens; // For E100+
                    break;
                case 'N': // NE, standard
                    // lat and lon are positive, lon < 100
                    break;
                case 'E': // SE hemisphere
                    lat = -lat;
                    break;
                case 'S': // SW hemisphere
                    lat = -lat;
                    lon = -lon;
                    break;
                case 'W': // NW hemisphere
                    lon = -lon;
                    break;
            }

            return { lat, lon };
        }

        function formatToDecimal(lat, lon) {
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            return Math.abs(lat).toFixed(4) + 'Â° ' + latDir + ', ' + Math.abs(lon).toFixed(4) + 'Â° ' + lonDir;
        }

        function formatToDMS(lat, lon) {
            function toDMS(deg, isLat) {
                var dir = isLat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
                deg = Math.abs(deg);
                var d = Math.floor(deg);
                var m = Math.floor((deg - d) * 60);
                var s = ((deg - d) * 60 - m) * 60;
                var dStr = isLat ? String(d).padStart(2, '0') : String(d).padStart(3, '0');
                return dir + dStr + 'Â°' + String(m).padStart(2, '0') + "'" + s.toFixed(1).padStart(4, '0') + '"';
            }
            return toDMS(lat, true) + ' ' + toDMS(lon, false);
        }

        function formatToDMM(lat, lon) {
            // DMM: N25Â° 15.25' E055Â° 21.80'
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            lat = Math.abs(lat);
            lon = Math.abs(lon);
            var latDeg = Math.floor(lat);
            var latMin = (lat - latDeg) * 60;
            var lonDeg = Math.floor(lon);
            var lonMin = (lon - lonDeg) * 60;
            return latDir + String(latDeg).padStart(2, '0') + 'Â° ' + latMin.toFixed(2).padStart(5, '0') + "' " +
                   lonDir + String(lonDeg).padStart(3, '0') + 'Â° ' + lonMin.toFixed(2).padStart(5, '0') + "'";
        }

        function formatToDMMCompact(lat, lon) {
            // DMM Compact: N25151E055218 (2 deg + 2 min + 1 tenth for lat, 3 deg + 2 min + 1 tenth for lon)
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            lat = Math.abs(lat);
            lon = Math.abs(lon);
            var latDeg = Math.floor(lat);
            var latMinTotal = (lat - latDeg) * 60;
            var latMinWhole = Math.floor(latMinTotal);
            var latMinTenth = Math.round((latMinTotal - latMinWhole) * 10);
            if (latMinTenth >= 10) { latMinWhole++; latMinTenth = 0; }
            var lonDeg = Math.floor(lon);
            var lonMinTotal = (lon - lonDeg) * 60;
            var lonMinWhole = Math.floor(lonMinTotal);
            var lonMinTenth = Math.round((lonMinTotal - lonMinWhole) * 10);
            if (lonMinTenth >= 10) { lonMinWhole++; lonMinTenth = 0; }
            return latDir + String(latDeg).padStart(2, '0') + String(latMinWhole).padStart(2, '0') + latMinTenth +
                   lonDir + String(lonDeg).padStart(3, '0') + String(lonMinWhole).padStart(2, '0') + lonMinTenth;
        }

        function formatToLido1(lat, lon) {
            // Format 1: N25-15/E055-18
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            lat = Math.abs(lat);
            lon = Math.abs(lon);
            var latDeg = Math.floor(lat);
            var latMin = Math.round((lat - latDeg) * 60);
            var lonDeg = Math.floor(lon);
            var lonMin = Math.round((lon - lonDeg) * 60);
            return latDir + String(latDeg).padStart(2, '0') + '-' + String(latMin).padStart(2, '0') + '/' +
                   lonDir + String(lonDeg).padStart(3, '0') + '-' + String(lonMin).padStart(2, '0');
        }

        function formatToLido2(lat, lon) {
            // Format 2: N2515E05518 or NS2515EW05518
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            lat = Math.abs(lat);
            lon = Math.abs(lon);
            var latDeg = Math.floor(lat);
            var latMin = Math.round((lat - latDeg) * 60);
            var lonDeg = Math.floor(lon);
            var lonMin = Math.round((lon - lonDeg) * 60);
            return latDir + String(latDeg).padStart(2, '0') + String(latMin).padStart(2, '0') +
                   lonDir + String(lonDeg).padStart(3, '0') + String(lonMin).padStart(2, '0');
        }

        function formatToLido3(lat, lon) {
            // Format 3: 2515N05518E (ICAO FPL)
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            lat = Math.abs(lat);
            lon = Math.abs(lon);
            var latDeg = Math.floor(lat);
            var latMin = Math.round((lat - latDeg) * 60);
            var lonDeg = Math.floor(lon);
            var lonMin = Math.round((lon - lonDeg) * 60);
            return String(latDeg).padStart(2, '0') + String(latMin).padStart(2, '0') + latDir +
                   String(lonDeg).padStart(3, '0') + String(lonMin).padStart(2, '0') + lonDir;
        }

        function formatToArinc424(lat, lon) {
            // ARINC 424 Five-Letter Format
            // This creates a simplified version based on whole degrees
            var latDeg = Math.abs(Math.round(lat));
            var lonDeg = Math.abs(Math.round(lon));
            var identifier = '';

            if (lat >= 0 && lon >= 0) {
                if (lonDeg >= 100) {
                    identifier = 'H';
                    lonDeg = lonDeg - 100;
                } else {
                    identifier = 'N';
                }
            } else if (lat < 0 && lon >= 0) {
                identifier = 'E';
            } else if (lat < 0 && lon < 0) {
                identifier = 'S';
            } else {
                identifier = 'W';
            }

            var latStr = String(latDeg).padStart(2, '0');
            var lonStr = String(Math.floor(lonDeg / 10)).padStart(2, '0'); // Tens of degrees

            return latStr + identifier + lonStr + ' (approx)';
        }

        // Toggle N/S button for latitude
        function toggleCoordNS() {
            var btn = document.getElementById('coord-ns-btn');
            if (btn.textContent === 'N') {
                btn.textContent = 'S';
                btn.style.background = 'rgba(255,80,80,0.3)';
                btn.style.borderColor = '#ff5050';
            } else {
                btn.textContent = 'N';
                btn.style.background = 'rgba(0,212,255,0.3)';
                btn.style.borderColor = '#00d4ff';
            }
            convertFromManual();
        }

        // Toggle E/W button for longitude
        function toggleCoordEW() {
            var btn = document.getElementById('coord-ew-btn');
            if (btn.textContent === 'E') {
                btn.textContent = 'W';
                btn.style.background = 'rgba(80,180,255,0.3)';
                btn.style.borderColor = '#50b4ff';
            } else {
                btn.textContent = 'E';
                btn.style.background = 'rgba(255,130,0,0.3)';
                btn.style.borderColor = '#FF8200';
            }
            convertFromManual();
        }

        // Convert from manual lat/lon split inputs
        function convertFromManual() {
            var latInput = document.getElementById('coord-lat-input').value.trim();
            var lonInput = document.getElementById('coord-lon-input').value.trim();
            var nsBtn = document.getElementById('coord-ns-btn').textContent;
            var ewBtn = document.getElementById('coord-ew-btn').textContent;

            if (!latInput && !lonInput) {
                // Clear outputs if both empty
                updateCoordOutputs(null, null, '---');
                return;
            }

            // Parse latitude - supports decimal or DMS
            var lat = parseCoordValue(latInput, true);
            var lon = parseCoordValue(lonInput, false);

            if (lat === null || lon === null) {
                updateCoordOutputs(null, null, 'Invalid format');
                return;
            }

            // Apply N/S and E/W signs
            if (nsBtn === 'S') lat = -Math.abs(lat);
            else lat = Math.abs(lat);

            if (ewBtn === 'W') lon = -Math.abs(lon);
            else lon = Math.abs(lon);

            // Validate ranges
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                updateCoordOutputs(null, null, 'Out of range');
                return;
            }

            updateCoordOutputs(lat, lon, 'Manual Entry');
        }

        // Parse a single coordinate value (lat or lon)
        function parseCoordValue(val, isLat) {
            if (!val) return null;
            val = val.trim();

            // Try decimal first
            if (/^-?\d+\.?\d*$/.test(val)) {
                return parseFloat(val);
            }

            // Try DMS format: 25Â°15'30" or 25 15 30 or 25-15-30
            var dmsMatch = val.match(/^(\d{1,3})[Â°\s\-](\d{1,2})['â€²\s\-]?(\d{1,2}(?:\.\d+)?)?["â€³]?$/);
            if (dmsMatch) {
                var d = parseInt(dmsMatch[1], 10);
                var m = parseInt(dmsMatch[2], 10);
                var s = dmsMatch[3] ? parseFloat(dmsMatch[3]) : 0;
                return d + m / 60 + s / 3600;
            }

            // Try DMM format: 25Â°15.5' or 25 15.5
            var dmmMatch = val.match(/^(\d{1,3})[Â°\s\-](\d{1,2}(?:\.\d+)?)['â€²]?$/);
            if (dmmMatch) {
                var d = parseInt(dmmMatch[1], 10);
                var m = parseFloat(dmmMatch[2]);
                return d + m / 60;
            }

            return null;
        }

        // Update all coordinate output fields
        function updateCoordOutputs(lat, lon, formatName) {
            var formatEl = document.getElementById('coord-format-detected');

            if (lat === null || lon === null) {
                formatEl.textContent = formatName || '---';
                formatEl.style.color = formatName === 'Invalid format' || formatName === 'Out of range' ? '#ff4444' : '#888';
                document.getElementById('coord-decimal').textContent = '---';
                document.getElementById('coord-dms').textContent = '---';
                document.getElementById('coord-dmm').textContent = '---';
                document.getElementById('coord-dmm-compact').textContent = '---';
                document.getElementById('coord-lido1').textContent = '---';
                document.getElementById('coord-lido2').textContent = '---';
                document.getElementById('coord-lido3').textContent = '---';
                document.getElementById('coord-arinc').textContent = '---';
                return;
            }

            formatEl.textContent = formatName;
            formatEl.style.color = '#00ff88';

            document.getElementById('coord-decimal').textContent = formatToDecimal(lat, lon);
            document.getElementById('coord-dms').textContent = formatToDMS(lat, lon);
            document.getElementById('coord-dmm').textContent = formatToDMM(lat, lon);
            document.getElementById('coord-dmm-compact').textContent = formatToDMMCompact(lat, lon);
            document.getElementById('coord-lido1').textContent = formatToLido1(lat, lon);
            document.getElementById('coord-lido2').textContent = formatToLido2(lat, lon);
            document.getElementById('coord-lido3').textContent = formatToLido3(lat, lon);
            document.getElementById('coord-arinc').textContent = formatToArinc424(lat, lon);
        }

        function convertCoordinates() {
            var input = document.getElementById('coord-input').value;

            if (!input || input.trim() === '') {
                updateCoordOutputs(null, null, '---');
                return;
            }

            var parsed = parseCoordinates(input);

            if (!parsed) {
                updateCoordOutputs(null, null, 'Invalid format');
                return;
            }

            var lat = parsed.lat;
            var lon = parsed.lon;

            // Validate ranges
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                updateCoordOutputs(null, null, 'Out of range');
                return;
            }

            updateCoordOutputs(lat, lon, parsed.format);
        }

        function clearCoordConverter() {
            // Clear paste input
            document.getElementById('coord-input').value = '';
            // Clear manual inputs
            document.getElementById('coord-lat-input').value = '';
            document.getElementById('coord-lon-input').value = '';
            // Reset N/S button to N
            var nsBtn = document.getElementById('coord-ns-btn');
            nsBtn.textContent = 'N';
            nsBtn.style.background = 'rgba(0,212,255,0.3)';
            nsBtn.style.borderColor = '#00d4ff';
            // Reset E/W button to E
            var ewBtn = document.getElementById('coord-ew-btn');
            ewBtn.textContent = 'E';
            ewBtn.style.background = 'rgba(255,130,0,0.3)';
            ewBtn.style.borderColor = '#FF8200';
            // Clear outputs
            document.getElementById('coord-format-detected').textContent = '---';
            document.getElementById('coord-format-detected').style.color = '#888';
            document.getElementById('coord-decimal').textContent = '---';
            document.getElementById('coord-dms').textContent = '---';
            document.getElementById('coord-dmm').textContent = '---';
            document.getElementById('coord-dmm-compact').textContent = '---';
            document.getElementById('coord-lido1').textContent = '---';
            document.getElementById('coord-lido2').textContent = '---';
            document.getElementById('coord-lido3').textContent = '---';
            document.getElementById('coord-arinc').textContent = '---';
        }

        // ============ AIRPORT DISTANCE CALCULATOR ============
        var lastLookupIcao = null;
        var lastLookupElev = null;

        function calculateAirportDistance() {
            var fromCode = document.getElementById('dist-from').value.trim().toUpperCase();
            var toCode = document.getElementById('dist-to').value.trim().toUpperCase();

            // Reset if inputs incomplete
            if (fromCode.length < 3 || toCode.length < 3) {
                document.getElementById('dist-result-nm').textContent = '--- nm';
                document.getElementById('dist-result-km').textContent = '--- km';
                document.getElementById('dist-from-name').textContent = '---';
                document.getElementById('dist-to-name').textContent = '---';
                document.getElementById('dist-track').textContent = '---Â°';
                document.getElementById('dist-time').textContent = '--:--';
                return;
            }

            // Try to find airports (ICAO first, then IATA)
            var fromApt = null, fromIcao = null;
            var toApt = null, toIcao = null;

            // Try ICAO lookup first
            if (airportDB && airportDB[fromCode]) {
                fromApt = airportDB[fromCode];
                fromIcao = fromCode;
            } else {
                // Try IATA lookup
                var iataResult = getAirportByIATA(fromCode);
                if (iataResult) {
                    fromApt = iataResult;
                    fromIcao = iataResult.icao;
                }
            }

            if (airportDB && airportDB[toCode]) {
                toApt = airportDB[toCode];
                toIcao = toCode;
            } else {
                var iataResult = getAirportByIATA(toCode);
                if (iataResult) {
                    toApt = iataResult;
                    toIcao = iataResult.icao;
                }
            }

            if (!fromApt) {
                document.getElementById('dist-from-name').textContent = 'Not found';
                document.getElementById('dist-from-name').style.color = '#ff5252';
                return;
            } else {
                var displayName = fromApt.m || fromApt.n;
                var codes = fromIcao + (fromApt.i ? '/' + fromApt.i : '');
                document.getElementById('dist-from-name').textContent = displayName + ' (' + codes + ')';
                document.getElementById('dist-from-name').style.color = '#00ff88';
            }

            if (!toApt) {
                document.getElementById('dist-to-name').textContent = 'Not found';
                document.getElementById('dist-to-name').style.color = '#ff5252';
                return;
            } else {
                var displayName = toApt.m || toApt.n;
                var codes = toIcao + (toApt.i ? '/' + toApt.i : '');
                document.getElementById('dist-to-name').textContent = displayName + ' (' + codes + ')';
                document.getElementById('dist-to-name').style.color = '#00ff88';
            }

            // Calculate great circle distance
            var lat1 = fromApt.c[0], lon1 = fromApt.c[1];
            var lat2 = toApt.c[0], lon2 = toApt.c[1];

            var distNm = calculateDistanceNm(lat1, lon1, lat2, lon2);
            var distKm = distNm * 1.852;

            document.getElementById('dist-result-nm').textContent = Math.round(distNm).toLocaleString() + ' nm';
            document.getElementById('dist-result-km').textContent = Math.round(distKm).toLocaleString() + ' km';

            // Calculate initial track
            var track = calculateInitialBearing(lat1, lon1, lat2, lon2);
            document.getElementById('dist-track').textContent = Math.round(track) + 'Â°';

            // Estimated flight time - use custom GS or default to 450 kt
            var gsInput = document.getElementById('dist-gs').value;
            var gs = gsInput && parseInt(gsInput) > 0 ? parseInt(gsInput) : 450;
            var timeHrs = distNm / gs;
            var hrs = Math.floor(timeHrs);
            var mins = Math.round((timeHrs - hrs) * 60);
            document.getElementById('dist-time').textContent = hrs + ':' + String(mins).padStart(2, '0');
        }

        function calculateDistanceNm(lat1, lon1, lat2, lon2) {
            var R = 3440.065; // Earth radius in nm
            var toRad = Math.PI / 180;
            var dLat = (lat2 - lat1) * toRad;
            var dLon = (lon2 - lon1) * toRad;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateInitialBearing(lat1, lon1, lat2, lon2) {
            var toRad = Math.PI / 180;
            var toDeg = 180 / Math.PI;
            var dLon = (lon2 - lon1) * toRad;
            lat1 = lat1 * toRad;
            lat2 = lat2 * toRad;
            var y = Math.sin(dLon) * Math.cos(lat2);
            var x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            var brng = Math.atan2(y, x) * toDeg;
            return (brng + 360) % 360;
        }

        function clearDistanceCalc() {
            document.getElementById('dist-from').value = '';
            document.getElementById('dist-to').value = '';
            document.getElementById('dist-gs').value = '';
            document.getElementById('dist-result-nm').textContent = '--- nm';
            document.getElementById('dist-result-km').textContent = '--- km';
            document.getElementById('dist-from-name').textContent = '---';
            document.getElementById('dist-to-name').textContent = '---';
            document.getElementById('dist-track').textContent = '---Â°';
            document.getElementById('dist-time').textContent = '--:--';
        }

        // ============ AIRPORT INFO LOOKUP ============
        function lookupAirport() {
            var code = document.getElementById('apt-lookup').value.trim().toUpperCase();

            if (code.length < 3) {
                document.getElementById('apt-info-result').style.display = 'none';
                document.getElementById('apt-info-empty').style.display = 'block';
                lastLookupIcao = null;
                lastLookupElev = null;
                return;
            }

            // Try ICAO first, then IATA
            var apt = getAirport(code);
            var icao = code;
            if (!apt) {
                var result = getAirportByIATA(code);
                if (result) {
                    apt = result;
                    icao = result.icao;
                }
            }

            if (!apt) {
                document.getElementById('apt-info-result').style.display = 'none';
                document.getElementById('apt-info-empty').style.display = 'block';
                document.getElementById('apt-info-empty').innerHTML = 'Airport not found: ' + code + '<br><span style="font-size: 0.75rem;">Try ICAO (4 letters) or IATA (3 letters)</span>';
                lastLookupIcao = null;
                lastLookupElev = null;
                return;
            }

            // Display info
            document.getElementById('apt-info-result').style.display = 'block';
            document.getElementById('apt-info-empty').style.display = 'none';

            document.getElementById('apt-info-name').textContent = apt.n;
            document.getElementById('apt-info-city').textContent = apt.m || 'N/A';
            document.getElementById('apt-info-icao').textContent = icao;
            document.getElementById('apt-info-iata').textContent = apt.i || '---';
            document.getElementById('apt-info-elev').textContent = apt.e !== undefined ? apt.e + ' ft' : '--- ft';
            document.getElementById('apt-info-country').textContent = apt.y || '--';

            // Format coordinates
            var lat = apt.c[0], lon = apt.c[1];
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            document.getElementById('apt-info-coords').textContent = Math.abs(lat).toFixed(4) + 'Â°' + latDir + '  ' + Math.abs(lon).toFixed(4) + 'Â°' + lonDir;

            // Store for elevation use
            lastLookupIcao = icao;
            lastLookupElev = apt.e;
        }

        function clearAirportLookup() {
            document.getElementById('apt-lookup').value = '';
            document.getElementById('apt-info-result').style.display = 'none';
            document.getElementById('apt-info-empty').style.display = 'block';
            document.getElementById('apt-info-empty').innerHTML = 'Enter ICAO or IATA code to lookup airport info<br><span style="font-size: 0.75rem;">Database: 8,800+ airports worldwide</span>';
            lastLookupIcao = null;
            lastLookupElev = null;
        }

        // ============ TIMEZONE CONVERTER ============
        function calculateTimezones() {
            const inputTime = document.getElementById('tz-input').value;
            const inputZone = parseFloat(document.getElementById('tz-input-zone').value);

            if (!inputTime || inputTime.length < 3) {
                ['tz-utc', 'tz-ruh', 'tz-ika', 'tz-dxb', 'tz-kbl', 'tz-khi', 'tz-del', 'tz-dac', 'tz-bkk'].forEach(id => {
                    document.getElementById(id).textContent = '--:--';
                });
                return;
            }

            const parsed = parseTime(inputTime);
            if (!parsed) return;

            // Convert to UTC minutes
            let utcMins = parsed.hours * 60 + parsed.minutes - (inputZone * 60);

            // Normalize to 0-1440
            while (utcMins < 0) utcMins += 1440;
            while (utcMins >= 1440) utcMins -= 1440;

            const zones = [
                { id: 'tz-utc', offset: 0 },
                { id: 'tz-ruh', offset: 3 },
                { id: 'tz-ika', offset: 3.5 },
                { id: 'tz-dxb', offset: 4 },
                { id: 'tz-kbl', offset: 4.5 },
                { id: 'tz-khi', offset: 5 },
                { id: 'tz-del', offset: 5.5 },
                { id: 'tz-dac', offset: 6 },
                { id: 'tz-bkk', offset: 7 }
            ];

            zones.forEach(zone => {
                let localMins = utcMins + (zone.offset * 60);
                while (localMins < 0) localMins += 1440;
                while (localMins >= 1440) localMins -= 1440;

                const hours = Math.floor(localMins / 60);
                const mins = Math.floor(localMins % 60);
                document.getElementById(zone.id).textContent =
                    `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            });
        }

        function clearTimezones() {
            document.getElementById('tz-input').value = '';
            document.getElementById('tz-input-btn').textContent = '----';
            document.getElementById('tz-input-btn').classList.add('placeholder');
            ['tz-utc', 'tz-ruh', 'tz-ika', 'tz-dxb', 'tz-kbl', 'tz-khi', 'tz-del', 'tz-dac', 'tz-bkk'].forEach(id => {
                document.getElementById(id).textContent = '--:--';
            });
        }

        // ============ SNOWTAM DECODER ============
        // flydubai RWYCC codes with crosswind limits (B737 NG/MAX)
        var grfDescriptions = {
            '6': { text: 'Dry', braking: 'DRY', class: 'grf-good', xwTO: 33, xwLDG: 37 },
            '5': { text: 'Wet/Frost/â‰¤3mm', braking: 'GOOD', class: 'grf-good', xwTO: 25, xwLDG: 37 },
            '4': { text: 'Compact snow â‰¤-15Â°C', braking: 'MED-GOOD', class: 'grf-medium', xwTO: 22, xwLDG: 35 },
            '3': { text: 'Wet snow/>3mm', braking: 'MEDIUM', class: 'grf-medium', xwTO: 20, xwLDG: 25 },
            '2': { text: 'Water/Slush', braking: 'MED-POOR', class: 'grf-poor', xwTO: 15, xwLDG: 17 },
            '1': { text: 'Ice', braking: 'POOR', class: 'grf-bad', xwTO: 13, xwLDG: 15 },
            '0': { text: 'Wet ice/Water on ice', braking: '<POOR', class: 'grf-bad', xwTO: null, xwLDG: null },
            '9': { text: 'Unreliable', braking: 'UNRELIABLE', class: 'grf-bad', xwTO: null, xwLDG: null },
            '/': { text: 'Not Reported', braking: 'N/R', class: '', xwTO: null, xwLDG: null }
        };

        // RWYCC/Crosswind integration state
        var currentPhase = 'TO'; // 'TO' or 'LDG'
        var currentRWYCC = null;
        var limitations = { asymrev: false, rwywidth: false, lda: false };

        function setPhase(phase) {
            currentPhase = phase;
            document.getElementById('phase-to-btn').style.background = phase === 'TO' ? 'rgba(255,130,0,0.3)' : '';
            document.getElementById('phase-to-btn').style.borderColor = phase === 'TO' ? '#FF8200' : '#444';
            document.getElementById('phase-ldg-btn').style.background = phase === 'LDG' ? 'rgba(0,212,255,0.3)' : '';
            document.getElementById('phase-ldg-btn').style.borderColor = phase === 'LDG' ? '#00d4ff' : '#444';
            document.getElementById('limit-label').textContent = phase === 'TO' ? 'MAX X-WIND T/O' : 'MAX X-WIND LDG';
            document.getElementById('current-limit').style.color = phase === 'TO' ? '#FF8200' : '#00d4ff';
            updateRWYCCDisplay();
            checkCrosswindLimit();
        }

        function setRWYCC(code) {
            currentRWYCC = code;
            updateRWYCCDisplay();
            checkCrosswindLimit();
        }

        function updateRWYCCDisplay() {
            try {
            var codeStr = currentRWYCC !== null ? currentRWYCC.toString() : '/';
            var desc = grfDescriptions[codeStr] || grfDescriptions['/'];
            var rwyccEl = document.getElementById('current-rwycc');
            var descEl = document.getElementById('current-rwycc-desc');
            var brakingEl = document.getElementById('current-braking');
            var limitEl = document.getElementById('current-limit');

            if (currentRWYCC === null) {
                rwyccEl.textContent = '-';
                rwyccEl.className = '';
                descEl.textContent = '---';
                brakingEl.textContent = '---';
                brakingEl.className = '';
                limitEl.textContent = '-- kt';
                return;
            }

            rwyccEl.textContent = currentRWYCC;
            rwyccEl.className = desc.class;
            descEl.textContent = desc.text;
            brakingEl.textContent = desc.braking;
            brakingEl.className = desc.class;

            // Get limit based on phase and apply asymrev reduction
            var limit = currentPhase === 'TO' ? desc.xwTO : desc.xwLDG;
            if (limit !== null && limitations.asymrev && currentRWYCC < 6) {
                limit = limit - 5;
            }

            if (limit !== null) {
                limitEl.textContent = limit + ' kt';
            } else {
                limitEl.textContent = 'N/A';
                limitEl.style.color = '#ff5252';
            }

            // Update limitation warnings
            updateLimitationWarnings();
            } catch(e) { console.error('updateRWYCCDisplay error:', e); }
        }

        function toggleLimitation(type) {
            limitations[type] = !limitations[type];
            var btn = document.getElementById('limit-' + type + '-btn');
            if (limitations[type]) {
                btn.style.background = 'rgba(255,82,82,0.3)';
                btn.style.borderColor = '#ff5252';
            } else {
                btn.style.background = '';
                btn.style.borderColor = '#444';
            }
            updateRWYCCDisplay();
            checkCrosswindLimit();
        }

        function clearLimitations() {
            limitations = { asymrev: false, rwywidth: false, lda: false };
            ['asymrev', 'rwywidth', 'lda'].forEach(function(type) {
                var btn = document.getElementById('limit-' + type + '-btn');
                btn.style.background = '';
                btn.style.borderColor = '#444';
            });
            updateRWYCCDisplay();
            checkCrosswindLimit();
        }

        function updateLimitationWarnings() {
            var warnings = [];
            var desc = currentRWYCC !== null ? (grfDescriptions[currentRWYCC.toString()] || {}) : {};

            if (limitations.asymrev && currentRWYCC !== null && currentRWYCC < 6) {
                warnings.push('<div class="fdp-warning" style="font-size:0.65rem;padding:6px;margin-bottom:4px;">âš ï¸ Asymmetric reverse: X-wind reduced by 5kt</div>');
            }

            if (limitations.rwywidth && currentRWYCC !== null && currentRWYCC <= 1) {
                warnings.push('<div class="fdp-danger" style="font-size:0.65rem;padding:6px;margin-bottom:4px;">ðŸš« Poor braking + RWY <45m = OPS PROHIBITED</div>');
            }

            if (limitations.lda && currentRWYCC !== null && currentRWYCC <= 1 && currentPhase === 'LDG') {
                warnings.push('<div class="fdp-danger" style="font-size:0.65rem;padding:6px;margin-bottom:4px;">ðŸš« Poor braking + LDA <2600m = LANDING PROHIBITED</div>');
            }

            if (currentRWYCC === 0) {
                warnings.push('<div class="fdp-danger" style="font-size:0.65rem;padding:6px;margin-bottom:4px;">ðŸš« RWYCC 0: ALL OPERATIONS PROHIBITED</div>');
            }

            document.getElementById('limitation-warnings').innerHTML = warnings.join('');
        }

        function checkCrosswindLimit() {
            var statusEl = document.getElementById('xwind-status');
            var xwindVal = document.getElementById('crosswind-val').textContent;

            // Parse crosswind value
            var match = xwindVal.match(/(\d+)/);
            if (!match || currentRWYCC === null) {
                statusEl.style.display = 'none';
                return;
            }

            var xwind = parseInt(match[0], 10);
            var desc = grfDescriptions[currentRWYCC.toString()] || {};
            var limit = currentPhase === 'TO' ? desc.xwTO : desc.xwLDG;

            // Apply asymrev reduction
            if (limit !== null && limitations.asymrev && currentRWYCC < 6) {
                limit = limit - 5;
            }

            if (limit === null) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(255,82,82,0.2)';
                statusEl.style.border = '1px solid #ff5252';
                statusEl.innerHTML = '<div style="color:#ff5252;font-weight:bold;">ðŸš« OPS PROHIBITED</div><div style="font-size:0.7rem;color:#ff5252;">RWYCC ' + currentRWYCC + ' does not permit operations</div>';
                return;
            }

            statusEl.style.display = 'block';

            if (xwind > limit) {
                // Exceeded
                statusEl.style.background = 'rgba(255,82,82,0.2)';
                statusEl.style.border = '1px solid #ff5252';
                statusEl.innerHTML = '<div style="color:#ff5252;font-weight:bold;">â›” LIMIT EXCEEDED</div><div style="font-size:0.75rem;color:#ff5252;">' + xwind + 'kt > ' + limit + 'kt limit</div>';
            } else if (xwind >= limit - 3) {
                // Approaching (within 3kt)
                statusEl.style.background = 'rgba(255,215,0,0.2)';
                statusEl.style.border = '1px solid #ffd700';
                statusEl.innerHTML = '<div style="color:#ffd700;font-weight:bold;">âš ï¸ NEAR LIMIT</div><div style="font-size:0.75rem;color:#ffd700;">' + xwind + 'kt / ' + limit + 'kt limit (' + (limit - xwind) + 'kt margin)</div>';
            } else {
                // Within limits
                statusEl.style.background = 'rgba(0,255,136,0.15)';
                statusEl.style.border = '1px solid #00ff88';
                statusEl.innerHTML = '<div style="color:#00ff88;font-weight:bold;">âœ“ WITHIN LIMITS</div><div style="font-size:0.75rem;color:#00ff88;">' + xwind + 'kt / ' + limit + 'kt limit (' + (limit - xwind) + 'kt margin)</div>';
            }
        }

        function decodeSnowtam() {
            const input = document.getElementById('snowtam-input').value.toUpperCase();
            const container = document.getElementById('snowtam-decoded');

            if (!input.trim()) {
                container.innerHTML = '';
                return;
            }

            // Try to parse runway conditions
            // Format: A) ICAO B) RWY C) COND/COND/COND
            const runways = [];

            // Match patterns like "B) 06L C) 5/5/5" or "RWY 06L 5/5/5"
            const rwyPattern = /(?:B\)\s*)?(\d{2}[LRC]?)\s*(?:C\)\s*)?(\d|\/)\/?(\d|\/)\/?(\d|\/)?/g;
            let match;

            while ((match = rwyPattern.exec(input)) !== null) {
                const rwy = match[1];
                const thirds = [match[2] || '/', match[3] || '/', match[4] || '/'];
                runways.push({ rwy, thirds });
            }

            // Also try to match GRF format with friction values
            // Format: RWY 06L GRF 5/5/5 or F) 5/5/5
            const frictionPattern = /(?:F\)\s*)?(\d|\/)\/?(\d|\/)\/?(\d|\/)?/g;
            const depthPattern = /(?:D\)\s*)?(\d+)\/?(\d+)?\/?(\d+)?/g;

            if (runways.length === 0) {
                // Try simpler format
                const simpleMatch = input.match(/(\d{2}[LRC]?)[:\s]+(\d)\/(\d)\/(\d)/);
                if (simpleMatch) {
                    runways.push({
                        rwy: simpleMatch[1],
                        thirds: [simpleMatch[2], simpleMatch[3], simpleMatch[4]]
                    });
                }
            }

            if (runways.length === 0) {
                container.innerHTML = '<div style="color:#ff5252;padding:10px">Could not parse SNOWTAM data. Check format.</div>';
                return;
            }

            // Find overall worst RWYCC and auto-set it
            var overallWorst = 6;
            runways.forEach(function(rwy) {
                rwy.thirds.forEach(function(c) {
                    if (c !== '/' && !isNaN(parseInt(c))) {
                        var code = parseInt(c);
                        if (code < overallWorst) overallWorst = code;
                    }
                });
            });
            setRWYCC(overallWorst);

            // Find worst RWYCC for crosswind limits
            container.innerHTML = runways.map(rwy => {
                var worstCode = Math.min(...rwy.thirds.map(c => c === '/' ? 9 : parseInt(c) || 9));
                var worstDesc = grfDescriptions[worstCode.toString()] || grfDescriptions['/'];
                return `
                    <div class="snowtam-runway">
                        <div class="snowtam-runway-header">RWY ${rwy.rwy}</div>
                        <div class="snowtam-grid">
                            ${rwy.thirds.map((code, i) => {
                                const desc = grfDescriptions[code.toString()] || grfDescriptions['/'];
                                const section = ['A (TDZ)', 'B (MID)', 'C (END)'][i];
                                return `
                                    <div class="snowtam-item">
                                        <div class="snowtam-label">${section}</div>
                                        <div class="snowtam-value ${desc.class}">${code}</div>
                                        <div style="font-size:0.65rem;color:#888;margin-top:2px">${desc.text}</div>
                                        <div style="font-size:0.6rem;color:#666">${desc.braking}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top:10px;padding-top:8px;border-top:1px solid #333;display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center;">
                            <div>
                                <div style="font-size:0.6rem;color:#888;">MAX X-WIND T/O</div>
                                <div style="font-size:1.1rem;color:#FF8200;font-weight:bold;">${worstDesc.xwTO ? worstDesc.xwTO + ' kt' : 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size:0.6rem;color:#888;">MAX X-WIND LDG</div>
                                <div style="font-size:1.1rem;color:#00d4ff;font-weight:bold;">${worstDesc.xwLDG ? worstDesc.xwLDG + ' kt' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Deposit type descriptions for legacy R##/XXXXXX format
        var depositTypes = {
            '0': 'Clear/Dry',
            '1': 'Damp',
            '2': 'Wet',
            '3': 'Frost',
            '4': 'Dry Snow',
            '5': 'Wet Snow',
            '6': 'Slush',
            '7': 'Ice',
            '8': 'Compact Snow',
            '9': 'Frozen Ruts',
            '/': 'Not Reported'
        };

        // Extent/Coverage codes
        var extentCodes = {
            '1': 'â‰¤10%',
            '2': '11-25%',
            '5': '26-50%',
            '9': '51-100%',
            '/': 'N/R'
        };

        function decodeRwyCode() {
            try {
            var input = document.getElementById('rwy-code-input').value.toUpperCase().trim();
            var container = document.getElementById('rwy-code-decoded');

            if (!input) {
                container.innerHTML = '';
                return;
            }

            // Parse R##/XXXXXX format (e.g., R15/450140)
            // Format: R[RWY]/[Deposit][Extent][Depth][Friction]
            var match = input.match(/R?(\d{2}[LRC]?)\/(\d)(\d)(\d{2})(\d{2})/);

            if (!match) {
                container.innerHTML = '<div style="color:#ff5252;padding:8px;font-size:0.8rem;">Invalid format. Use R15/450140</div>';
                return;
            }

            var rwy = match[1];
            var deposit = match[2];
            var extent = match[3];
            var depth = match[4];
            var friction = match[5];

            // Lookup tables (defined locally to avoid scope issues)
            var depTypes = {
                '0': 'Clear/Dry', '1': 'Damp', '2': 'Wet', '3': 'Frost',
                '4': 'Dry Snow', '5': 'Wet Snow', '6': 'Slush', '7': 'Ice',
                '8': 'Compact Snow', '9': 'Frozen Ruts', '/': 'Not Reported'
            };
            var extCodes = {
                '1': 'â‰¤10%', '2': '11-25%', '5': '26-50%', '9': '51-100%', '/': 'N/R'
            };

            // Convert friction to braking action
            var frictionVal = parseInt(friction, 10);
            var braking = { text: 'UNKNOWN', class: '' };
            if (frictionVal >= 40) braking = { text: 'GOOD', class: 'grf-good' };
            else if (frictionVal >= 36) braking = { text: 'GOOD-MEDIUM', class: 'grf-good' };
            else if (frictionVal >= 30) braking = { text: 'MEDIUM', class: 'grf-medium' };
            else if (frictionVal >= 26) braking = { text: 'MEDIUM-POOR', class: 'grf-medium' };
            else if (frictionVal >= 20) braking = { text: 'POOR', class: 'grf-poor' };
            else braking = { text: 'UNRELIABLE', class: 'grf-bad' };

            // Decode descriptions
            var depositDesc = depTypes[deposit] || 'Unknown';
            var extentDesc = extCodes[extent] || (extent + '0%');
            var depthMm = parseInt(depth, 10);

            container.innerHTML = '<div class="snowtam-runway" style="padding:10px;">' +
                '<div class="snowtam-runway-header">RWY ' + rwy + '</div>' +
                '<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px; text-align:center;">' +
                    '<div>' +
                        '<div style="font-size:0.65rem;color:#888;">Deposit</div>' +
                        '<div style="font-size:1rem;color:#FF8200;">' + deposit + '</div>' +
                        '<div style="font-size:0.6rem;color:#aaa;">' + depositDesc + '</div>' +
                    '</div>' +
                    '<div>' +
                        '<div style="font-size:0.65rem;color:#888;">Extent</div>' +
                        '<div style="font-size:1rem;color:#00d4ff;">' + extent + '</div>' +
                        '<div style="font-size:0.6rem;color:#aaa;">' + extentDesc + '</div>' +
                    '</div>' +
                    '<div>' +
                        '<div style="font-size:0.65rem;color:#888;">Depth</div>' +
                        '<div style="font-size:1rem;color:#ffd700;">' + depth + '</div>' +
                        '<div style="font-size:0.6rem;color:#aaa;">' + depthMm + 'mm</div>' +
                    '</div>' +
                    '<div>' +
                        '<div style="font-size:0.65rem;color:#888;">Î¼ Friction</div>' +
                        '<div style="font-size:1rem;" class="' + braking.class + '">0.' + friction + '</div>' +
                        '<div style="font-size:0.6rem;color:#aaa;">' + braking.text + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';

            // Convert friction to RWYCC and auto-set
            var rwycc = 6;
            if (frictionVal >= 40) rwycc = 5; // Good
            else if (frictionVal >= 36) rwycc = 5; // Good-Medium
            else if (frictionVal >= 30) rwycc = 4; // Medium
            else if (frictionVal >= 26) rwycc = 3; // Medium-Poor
            else if (frictionVal >= 20) rwycc = 2; // Poor
            else rwycc = 1; // Less than Poor

            // Also consider deposit type for RWYCC
            // 7=Ice -> RWYCC 1, 4/5=Snow -> RWYCC 3-4
            if (deposit === '7') rwycc = Math.min(rwycc, 1); // Ice
            else if (deposit === '6') rwycc = Math.min(rwycc, 2); // Slush
            else if (deposit === '4' || deposit === '5' || deposit === '8') rwycc = Math.min(rwycc, 4); // Snow types

            setRWYCC(rwycc);

            } catch(e) { alert('decodeRwyCode error: ' + e.message); }
        }

        function decodeManualEntry() {
            const rwy = document.getElementById('manual-rwy').value.toUpperCase() || '---';
            const rwycc = [
                document.getElementById('manual-rwycc-1').value || '-',
                document.getElementById('manual-rwycc-2').value || '-',
                document.getElementById('manual-rwycc-3').value || '-'
            ];
            const cover = [
                document.getElementById('manual-cover-1').value || '-',
                document.getElementById('manual-cover-2').value || '-',
                document.getElementById('manual-cover-3').value || '-'
            ];
            const depth = [
                document.getElementById('manual-depth-1').value || '-',
                document.getElementById('manual-depth-2').value || '-',
                document.getElementById('manual-depth-3').value || '-'
            ];

            const container = document.getElementById('manual-decoded');

            // Check if any values entered
            const hasValues = rwycc.some(v => v !== '-') || cover.some(v => v !== '-') || depth.some(v => v !== '-');
            if (!hasValues) {
                container.innerHTML = '';
                return;
            }

            var sections = ['TDZ', 'MID', 'END'];
            // Find worst RWYCC for crosswind limits
            var worstCode = 6;
            rwycc.forEach(function(c) {
                if (c !== '-' && !isNaN(parseInt(c))) {
                    var code = parseInt(c);
                    if (code < worstCode) worstCode = code;
                }
            });
            var worstDesc = grfDescriptions[worstCode.toString()] || grfDescriptions['/'];

            // Auto-set RWYCC for crosswind checking
            if (rwycc.some(v => v !== '-' && !isNaN(parseInt(v)))) {
                setRWYCC(worstCode);
            }

            container.innerHTML = `
                <div class="snowtam-runway" style="padding:8px;">
                    <div class="snowtam-runway-header" style="font-size:0.85rem;">RWY ${rwy}</div>
                    <div class="snowtam-grid" style="margin-top:8px;">
                        ${sections.map((sec, i) => {
                            const code = rwycc[i];
                            const desc = grfDescriptions[code.toString()] || { text: 'N/A', braking: '-', class: '' };
                            return `
                                <div class="snowtam-item" style="padding:6px;">
                                    <div class="snowtam-label" style="font-size:0.6rem;">${sec}</div>
                                    <div class="snowtam-value ${desc.class}" style="font-size:1.1rem;">${code}</div>
                                    <div style="font-size:0.55rem;color:#888;">${desc.text}</div>
                                    <div style="font-size:0.5rem;color:#666;">${cover[i]}% / ${depth[i]}mm</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top:8px;padding-top:6px;border-top:1px solid #333;display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center;">
                        <div>
                            <div style="font-size:0.55rem;color:#888;">MAX X-WIND T/O</div>
                            <div style="font-size:0.95rem;color:#FF8200;font-weight:bold;">${worstDesc.xwTO ? worstDesc.xwTO + ' kt' : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size:0.55rem;color:#888;">MAX X-WIND LDG</div>
                            <div style="font-size:0.95rem;color:#00d4ff;font-weight:bold;">${worstDesc.xwLDG ? worstDesc.xwLDG + ' kt' : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============ LMC CALCULATOR ============
        // fleetData, lmcCorrectionTable, LMC_PAX_WEIGHTS, normalizeConfig defined at top of script

        var lmcChanges = [];
        var lmcChangeCounter = 0;
        var lmcSelectedTail = '';
        var lmcAircraftType = '';
        var lmcAircraftConfig = '';

        function openLmcTailPicker() {
            // Use the existing tail picker modal with LMC context
            openTailPicker('lmc');
        }

        function setLmcTail(tail) {
            lmcSelectedTail = tail;
            document.getElementById('lmc-tail').value = tail;
            document.getElementById('lmc-tail-btn').textContent = tail || '---';

            // Look up aircraft info from fleet
            var configSelector = document.getElementById('lmc-config-selector');
            if (fleetData && fleetData.aircraft && fleetData.aircraft['A6-' + tail]) {
                var ac = fleetData.aircraft['A6-' + tail];
                lmcAircraftType = ac.type;

                // Parse the config to see if it's dual (e.g., "10J156Y/166Y")
                var configs = parseFleetConfig(ac.config);

                if (configs.length > 1) {
                    // Show config selector buttons
                    lmcAircraftConfig = configs[0]; // Default to first
                    document.getElementById('lmc-aircraft-info').innerHTML = ac.type;
                    configSelector.innerHTML = configs.map(function(cfg) {
                        var isActive = cfg === lmcAircraftConfig;
                        return '<button class="lmc-toggle-btn' + (isActive ? ' active' : '') + '" onclick="selectLmcConfig(\'' + cfg + '\')" style="padding:6px 10px;font-size:0.8rem;">' + cfg + '</button>';
                    }).join('');
                    configSelector.style.display = 'flex';
                } else {
                    // Single config
                    lmcAircraftConfig = configs[0] || '';
                    document.getElementById('lmc-aircraft-info').innerHTML = ac.type + '<br><span style="font-size:0.75rem;color:#888;">' + lmcAircraftConfig + '</span>';
                    configSelector.style.display = 'none';
                    configSelector.innerHTML = '';
                }
            } else if (tail) {
                document.getElementById('lmc-aircraft-info').innerHTML = '<span style="color:#ff5252;">Tail not in fleet</span>';
                lmcAircraftType = '';
                lmcAircraftConfig = '';
                configSelector.style.display = 'none';
                configSelector.innerHTML = '';
            } else {
                document.getElementById('lmc-aircraft-info').textContent = '---';
                lmcAircraftType = '';
                lmcAircraftConfig = '';
                configSelector.style.display = 'none';
                configSelector.innerHTML = '';
            }

            renderLmcChanges();
            lmcCalculate();
        }

        function selectLmcConfig(config) {
            lmcAircraftConfig = config;
            // Update button states
            var selector = document.getElementById('lmc-config-selector');
            selector.querySelectorAll('.lmc-toggle-btn').forEach(function(btn) {
                if (btn.textContent === config) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderLmcChanges();
            lmcCalculate();
        }

        function autofillLmcFromSchedule() {
            // Get tail from schedule tab
            var tailEl = document.getElementById('sched-tail');
            if (tailEl && tailEl.value) {
                // Strip A6- prefix if present
                var tail = tailEl.value.replace(/^A6-/i, '');
                setLmcTail(tail);

                // Override config with the one selected in schedule tab
                if (selectedConfig) {
                    lmcAircraftConfig = selectedConfig;
                    // Update the display to show the selected config
                    var infoEl = document.getElementById('lmc-aircraft-info');
                    if (infoEl && selectedAircraftType) {
                        infoEl.innerHTML = selectedAircraftType + '<br><span style="font-size:0.75rem;color:#00ff88;">' + selectedConfig + '</span>';
                    }
                    lmcCalculate();
                }
            } else {
                alert('No tail number set in Schedule tab');
            }
        }

        function addLmcChange(type) {
            var table = getLmcTable();
            if (!table) {
                alert('Please select a tail number first');
                return;
            }

            var id = 'lmc-change-' + (++lmcChangeCounter);
            var zones = [];

            if (type === 'PAX') {
                zones = ['OA', 'OB', 'OC', 'OD'];
            } else if (type === 'CARGO' || type === 'BAGS') {
                zones = ['CPT1', 'CPT2', 'CPT3', 'CPT4'];
            } else if (type === 'FUEL') {
                zones = ['WING', 'WING+CTR'];
            }

            var change = {
                id: id,
                type: type,
                zone: zones[0],
                action: 'onload',
                male: 0,
                female: 0,
                child: 0,
                quantity: 0,
                weight: 0,
                iu: 0
            };

            lmcChanges.push(change);
            renderLmcChanges();
        }

        function getLmcTable() {
            if (!lmcAircraftType || !lmcAircraftConfig) return null;
            var typeTable = lmcCorrectionTable[lmcAircraftType];
            if (!typeTable) return null;
            // For 737-9, use 'ALL' config
            if (lmcAircraftType === 'B39M') {
                return typeTable['ALL'];
            }
            // Config is now already in correct format (e.g., "10J156Y")
            return typeTable[lmcAircraftConfig] || null;
        }

        function removeLmcChange(id) {
            lmcChanges = lmcChanges.filter(function(c) { return c.id !== id; });
            renderLmcChanges();
            lmcCalculate();
        }

        // Get max weight from zone description (e.g., "Fwd Hold (742kg)" -> 742)
        function getZoneMaxWeight(zoneInfo) {
            if (!zoneInfo || !zoneInfo.desc) return null;
            var match = zoneInfo.desc.match(/\((\d+)kg\)/);
            return match ? parseInt(match[1]) : null;
        }

        function renderLmcChanges() {
            var container = document.getElementById('lmc-changes-container');
            var table = getLmcTable();

            container.innerHTML = lmcChanges.map(function(change) {
                var zones = [];
                if (change.type === 'PAX') {
                    zones = ['OA', 'OB', 'OC', 'OD'];
                } else if (change.type === 'CARGO' || change.type === 'BAGS') {
                    zones = ['CPT1', 'CPT2', 'CPT3', 'CPT4'];
                } else if (change.type === 'FUEL') {
                    zones = ['WING', 'WING+CTR'];
                }

                // Action buttons (ON/OFF load)
                var actionBtns = '<div class="lmc-field-group">' +
                    '<span class="lmc-field-label">Action</span>' +
                    '<div style="display:flex;gap:4px;">' +
                        '<button class="lmc-toggle-btn' + (change.action === 'onload' ? ' active' : '') + '" onclick="updateLmcChange(\'' + change.id + '\', \'action\', \'onload\'); renderLmcChanges();" style="flex:1;padding:6px 4px;font-size:0.8rem;">ON</button>' +
                        '<button class="lmc-toggle-btn' + (change.action === 'offload' ? ' active' : '') + '" onclick="updateLmcChange(\'' + change.id + '\', \'action\', \'offload\'); renderLmcChanges();" style="flex:1;padding:6px 4px;font-size:0.8rem;">OFF</button>' +
                    '</div>' +
                '</div>';

                // Zone buttons - for PAX show seat rows, for cargo/fuel show zone name
                var zoneBtns = '<div class="lmc-field-group">' +
                    '<span class="lmc-field-label">Zone</span>' +
                    '<div style="display:flex;gap:4px;flex-wrap:wrap;">' +
                        zones.map(function(z) {
                            var isActive = change.zone === z;
                            var zoneInfo = (table && table[z]) || { desc: z };
                            var btnLabel = z;
                            // For PAX zones, extract row numbers from desc (e.g., "Rows 1-5" -> "1-5")
                            if (change.type === 'PAX' && zoneInfo.desc) {
                                var rowMatch = zoneInfo.desc.match(/Rows?\s*(\d+[-â€“]\d+|\d+)/i);
                                if (rowMatch) {
                                    btnLabel = '<div style="font-size:0.7rem;opacity:0.7;">' + z + '</div><div style="font-size:0.85rem;font-weight:bold;">' + rowMatch[1] + '</div>';
                                }
                            }
                            return '<button class="lmc-toggle-btn' + (isActive ? ' active' : '') + '" onclick="updateLmcChange(\'' + change.id + '\', \'zone\', \'' + z + '\'); renderLmcChanges();" style="flex:1;min-width:50px;padding:4px 4px;font-size:0.75rem;line-height:1.1;" title="' + zoneInfo.desc + '">' + btnLabel + '</button>';
                        }).join('') +
                    '</div>' +
                '</div>';

                // Different input fields for PAX vs CARGO/FUEL
                var inputFields = '';
                var weightWarning = '';
                if (change.type === 'PAX') {
                    inputFields = '<div class="lmc-field-group" style="grid-column: span 2;">' +
                        '<span class="lmc-field-label">PAX Count (M / F / C)</span>' +
                        '<div style="display: flex; gap: 5px;">' +
                            '<button class="input-btn lmc-pax-btn" onclick="openLmcPaxPicker(\'' + change.id + '\', \'male\')" style="flex:1;padding:8px 4px;font-size:0.85rem;">' + (change.male || '0') + '</button>' +
                            '<button class="input-btn lmc-pax-btn" onclick="openLmcPaxPicker(\'' + change.id + '\', \'female\')" style="flex:1;padding:8px 4px;font-size:0.85rem;">' + (change.female || '0') + '</button>' +
                            '<button class="input-btn lmc-pax-btn" onclick="openLmcPaxPicker(\'' + change.id + '\', \'child\')" style="flex:1;padding:8px 4px;font-size:0.85rem;">' + (change.child || '0') + '</button>' +
                        '</div>' +
                    '</div>';
                } else {
                    // Check cargo compartment weight limits
                    var zoneInfo = (table && table[change.zone]) || null;
                    var maxWeight = getZoneMaxWeight(zoneInfo);
                    var enteredWeight = change.quantity || 0;
                    if (maxWeight && enteredWeight > maxWeight && change.action === 'onload') {
                        weightWarning = '<div class="lmc-weight-warning" style="grid-column:span 2;background:rgba(255,50,50,0.2);border:1px solid rgba(255,50,50,0.5);padding:6px;border-radius:4px;color:#ff5555;font-size:0.75rem;text-align:center;">Exceeds ' + change.zone + ' max: ' + maxWeight + 'kg</div>';
                    }
                    inputFields = '<div class="lmc-field-group">' +
                        '<span class="lmc-field-label">Weight (kg)</span>' +
                        '<button class="input-btn" onclick="openLmcWeightPicker(\'' + change.id + '\')" style="padding:8px 4px;font-size:0.85rem;">' + (change.quantity || '0') + '</button>' +
                    '</div>';
                }

                return '<div class="lmc-change-entry" id="' + change.id + '">' +
                    '<div class="lmc-change-header">' +
                        '<span class="lmc-change-type">' + change.type + '</span>' +
                        '<button class="lmc-change-remove" onclick="removeLmcChange(\'' + change.id + '\')">Remove</button>' +
                    '</div>' +
                    '<div class="lmc-change-fields">' +
                        actionBtns +
                        zoneBtns +
                        inputFields +
                        weightWarning +
                        '<div class="lmc-field-group">' +
                            '<span class="lmc-field-label">Result</span>' +
                            '<div class="lmc-result-row">' +
                                '<span class="lmc-result-label">Î” Weight:</span>' +
                                '<span class="lmc-result-value" id="' + change.id + '-weight">0 kg</span>' +
                            '</div>' +
                            '<div class="lmc-result-row">' +
                                '<span class="lmc-result-label">Î” IU:</span>' +
                                '<span class="lmc-result-value" id="' + change.id + '-iu">0.0</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateLmcPax(id, paxType, value) {
            var change = lmcChanges.find(function(c) { return c.id === id; });
            if (change) {
                change[paxType] = parseInt(value) || 0;
                lmcCalculate();
            }
        }

        function updateLmcChange(id, field, value) {
            var change = lmcChanges.find(function(c) { return c.id === id; });
            if (change) {
                change[field] = field === 'quantity' ? parseFloat(value) || 0 : value;
                lmcCalculate();
            }
        }

        // Open number picker for LMC PAX count
        function openLmcPaxPicker(changeId, paxType) {
            var change = lmcChanges.find(function(c) { return c.id === changeId; });
            if (!change) return;
            var labels = { male: 'Male PAX', female: 'Female PAX', child: 'Child PAX' };
            var currentVal = change[paxType] || 0;
            openPicker(labels[paxType], '', currentVal.toString(), 3, false, function(val) {
                var num = parseInt(val) || 0;
                change[paxType] = num;
                renderLmcChanges();
                lmcCalculate();
            });
        }

        // Open number picker for LMC cargo/fuel weight
        function openLmcWeightPicker(changeId) {
            var change = lmcChanges.find(function(c) { return c.id === changeId; });
            if (!change) return;
            var currentVal = change.quantity || 0;
            openPicker('Weight', 'kg', currentVal.toString(), 5, true, function(val) {
                var num = parseInt(val) || 0;
                change.quantity = num;
                renderLmcChanges();
                lmcCalculate();
            });
        }

        function lmcCalculate() {
            var method = document.getElementById('lmc-method').value;
            var table = getLmcTable();

            // Get baseline weights
            var zfw = parseInt(document.getElementById('lmc-zfw').value) || 0;
            var mzfw = parseInt(document.getElementById('lmc-mzfw').value) || 0;
            var tow = parseInt(document.getElementById('lmc-tow').value) || 0;
            var rtow = parseInt(document.getElementById('lmc-rtow').value) || 0;
            var lw = parseInt(document.getElementById('lmc-lw').value) || 0;
            var rlw = parseInt(document.getElementById('lmc-rlw').value) || 0;
            var underload = parseInt(document.getElementById('lmc-underload').value) || 0;

            // Calculate totals
            var totalWeight = 0;
            var totalIU = 0;
            var auditItems = [];

            lmcChanges.forEach(function(change) {
                var zoneData = table ? table[change.zone] : null;

                var weight = 0;
                var units = 0;
                var paxCount = 0;

                if (change.type === 'PAX') {
                    // Calculate weight using M/F/C with standard weights
                    var maleWeight = (change.male || 0) * LMC_PAX_WEIGHTS.male;
                    var femaleWeight = (change.female || 0) * LMC_PAX_WEIGHTS.female;
                    var childWeight = (change.child || 0) * LMC_PAX_WEIGHTS.child;
                    weight = maleWeight + femaleWeight + childWeight;
                    paxCount = (change.male || 0) + (change.female || 0) + (change.child || 0);
                    units = paxCount;
                } else if (change.type === 'FUEL') {
                    weight = change.quantity;
                    // Fuel zones have specific unit divisors: WING=300kg, WING+CTR=350kg
                    if (change.zone === 'WING') {
                        units = change.quantity / 300;
                    } else if (change.zone === 'WING+CTR') {
                        units = change.quantity / 350;
                    } else {
                        units = change.quantity / 100;
                    }
                } else {
                    // CARGO/BAGS: per 100kg
                    weight = change.quantity;
                    units = change.quantity / 100;
                }

                var iuRate = zoneData ? (change.action === 'onload' ? zoneData.onload : zoneData.offload) : 0;
                var iu = units * iuRate;

                // Apply sign based on action
                if (change.action === 'offload') {
                    weight = -weight;
                }

                change.weight = weight;
                change.iu = iu;
                totalWeight += weight;
                totalIU += iu;

                // Update display
                var weightEl = document.getElementById(change.id + '-weight');
                var iuEl = document.getElementById(change.id + '-iu');
                if (weightEl) weightEl.textContent = (weight >= 0 ? '+' : '') + weight.toLocaleString() + ' kg';
                if (iuEl) {
                    iuEl.textContent = (iu >= 0 ? '+' : '') + iu.toFixed(1) + ' IU';
                    iuEl.style.color = Math.abs(iu) <= 5 ? '#00ff88' : '#ff5252';
                }

                // Build audit description
                var qtyDesc = change.type === 'PAX' ?
                    (change.male || 0) + 'M/' + (change.female || 0) + 'F/' + (change.child || 0) + 'C' :
                    change.quantity + ' kg';

                auditItems.push({
                    type: change.type,
                    zone: change.zone,
                    action: change.action,
                    qtyDesc: qtyDesc,
                    weight: weight,
                    iu: iu
                });
            });

            // Update summary
            document.getElementById('lmc-total-weight').textContent = (totalWeight >= 0 ? '+' : '') + totalWeight.toLocaleString() + ' kg';
            document.getElementById('lmc-total-iu').textContent = (totalIU >= 0 ? '+' : '') + totalIU.toFixed(1) + ' IU';
            document.getElementById('lmc-num-changes').textContent = lmcChanges.length;

            // Corrected weights
            var corrZfw = zfw > 0 ? zfw + totalWeight : 0;
            var corrTow = tow > 0 ? tow + totalWeight : 0;
            var corrLw = lw > 0 ? lw + totalWeight : 0;

            document.getElementById('lmc-zfw-corr').textContent = corrZfw > 0 ? corrZfw.toLocaleString() + ' kg' : '--- kg';
            document.getElementById('lmc-tow-corr').textContent = corrTow > 0 ? corrTow.toLocaleString() + ' kg' : '--- kg';
            document.getElementById('lmc-lw-corr').textContent = corrLw > 0 ? corrLw.toLocaleString() + ' kg' : '--- kg';

            // Validation checks
            var maxChanges = method === 'manual' ? 3 : 10;
            var checks = {
                weight: { pass: Math.abs(totalWeight) <= 500, value: totalWeight },
                iu: { pass: Math.abs(totalIU) <= 5.0, value: totalIU },
                zfwMin: { pass: corrZfw === 0 || corrZfw >= 45000, value: corrZfw },
                changes: { pass: lmcChanges.length <= maxChanges, value: lmcChanges.length },
                underload: { pass: totalWeight <= 0 || (underload > 0 && totalWeight <= underload), value: totalWeight },
                mzfw: { pass: corrZfw === 0 || mzfw === 0 || corrZfw <= mzfw, value: corrZfw },
                rtow: { pass: corrTow === 0 || rtow === 0 || corrTow <= rtow, value: corrTow },
                rlw: { pass: corrLw === 0 || rlw === 0 || corrLw <= rlw, value: corrLw }
            };

            // Update check displays
            updateLmcCheck('lmc-check-weight', checks.weight.pass, 'Weight change â‰¤ 500 kg', totalWeight.toLocaleString() + ' kg');
            updateLmcCheck('lmc-check-iu', checks.iu.pass, 'Index change â‰¤ 5.0 IU', totalIU.toFixed(1) + ' IU');
            updateLmcCheck('lmc-check-zfw-min', checks.zfwMin.pass, 'ZFW â‰¥ 45,000 kg', corrZfw > 0 ? corrZfw.toLocaleString() + ' kg' : 'N/A');
            updateLmcCheck('lmc-check-changes', checks.changes.pass, 'Changes â‰¤ ' + maxChanges + ' (' + method + ')', lmcChanges.length + ' changes');
            updateLmcCheck('lmc-check-underload', checks.underload.pass || totalWeight <= 0, 'Within underload', totalWeight <= 0 ? 'Offloading' : (underload > 0 ? totalWeight + ' â‰¤ ' + underload : 'No underload set'));
            updateLmcCheck('lmc-check-mzfw', checks.mzfw.pass, 'ZFW â‰¤ MZFW', corrZfw > 0 && mzfw > 0 ? corrZfw.toLocaleString() + ' â‰¤ ' + mzfw.toLocaleString() : 'N/A');
            updateLmcCheck('lmc-check-rtow', checks.rtow.pass, 'TOW â‰¤ RTOW', corrTow > 0 && rtow > 0 ? corrTow.toLocaleString() + ' â‰¤ ' + rtow.toLocaleString() : 'N/A');
            updateLmcCheck('lmc-check-rlw', checks.rlw.pass, 'LW â‰¤ RLW', corrLw > 0 && rlw > 0 ? corrLw.toLocaleString() + ' â‰¤ ' + rlw.toLocaleString() : 'N/A');

            // Overall decision
            var allPass = checks.weight.pass && checks.iu.pass && checks.zfwMin.pass &&
                         checks.changes.pass && (checks.underload.pass || totalWeight <= 0) &&
                         checks.mzfw.pass && checks.rtow.pass && checks.rlw.pass;

            var banner = document.getElementById('lmc-decision-banner');
            var detailsDiv = document.getElementById('lmc-decision-details');

            if (lmcChanges.length === 0) {
                banner.className = 'lmc-decision pending';
                banner.innerHTML = '<div class="lmc-decision-main"><span class="lmc-decision-icon">?</span><span class="lmc-decision-text">Enter LMC changes to calculate</span></div>';
                detailsDiv.style.display = 'none';
            } else if (allPass) {
                banner.className = 'lmc-decision pass';
                banner.innerHTML = '<div class="lmc-decision-main"><span class="lmc-decision-icon">âœ“</span><span class="lmc-decision-text">LMC ACCEPTED</span></div>';
                detailsDiv.style.display = 'block';
            } else {
                banner.className = 'lmc-decision fail';
                banner.innerHTML = '<div class="lmc-decision-main"><span class="lmc-decision-icon">âœ—</span><span class="lmc-decision-text">LMC REJECTED - New Loadsheet Required</span></div>';
                detailsDiv.style.display = 'block';
            }

            // Determine if new loadsheet / performance recalc needed
            var needsLoadsheet = !allPass;
            var needsPerf = !checks.rtow.pass || !checks.rlw.pass || Math.abs(totalWeight) > 200;
            var perfReason = '';
            if (!checks.rtow.pass) perfReason = 'TOW exceeds RTOW';
            else if (!checks.rlw.pass) perfReason = 'LW exceeds RLW';
            else if (Math.abs(totalWeight) > 200) perfReason = 'Weight change > 200 kg';

            document.getElementById('lmc-new-loadsheet').textContent = needsLoadsheet ? 'YES' : 'NO';
            document.getElementById('lmc-new-loadsheet').style.color = needsLoadsheet ? '#ff5252' : '#00ff88';
            document.getElementById('lmc-recalc-perf').textContent = needsPerf ? 'YES' : 'NO';
            document.getElementById('lmc-recalc-perf').style.color = needsPerf ? '#ffd700' : '#00ff88';
            document.getElementById('lmc-perf-reason').textContent = perfReason;

            // Update audit trail
            var auditDiv = document.getElementById('lmc-audit');
            if (auditItems.length > 0) {
                auditDiv.innerHTML = '<div class="lmc-audit-title">Change Log</div>' +
                    auditItems.map(function(item) {
                        return '<div class="lmc-audit-item">' +
                            '<span>' + item.action.toUpperCase() + ' ' + item.type + ' (' + item.zone + '): ' + item.qtyDesc + '</span>' +
                            '<span style="color:#00d4ff">' + (item.weight >= 0 ? '+' : '') + item.weight + ' kg / ' + (item.iu >= 0 ? '+' : '') + item.iu.toFixed(1) + ' IU</span>' +
                        '</div>';
                    }).join('');
            } else {
                auditDiv.innerHTML = '<div class="lmc-audit-title">Change Log</div><div style="color:#666;text-align:center;padding:10px;">No changes entered</div>';
            }
        }

        function updateLmcCheck(id, pass, label, value) {
            var el = document.getElementById(id);
            el.className = 'lmc-check ' + (pass ? 'pass' : 'fail');
            el.innerHTML = '<span class="lmc-check-icon">' + (pass ? 'âœ“' : 'âœ—') + '</span>' +
                          '<span>' + label + '</span>' +
                          '<span style="margin-left:auto;color:' + (pass ? '#00ff88' : '#ff5252') + '">' + value + '</span>';
        }

        function clearLmc() {
            lmcChanges = [];
            lmcChangeCounter = 0;
            // Clear tail selection
            lmcSelectedTail = '';
            lmcAircraftType = '';
            lmcAircraftConfig = '';
            document.getElementById('lmc-tail').value = '';
            document.getElementById('lmc-tail-btn').textContent = '---';
            document.getElementById('lmc-aircraft-info').textContent = '---';
            // Clear weights
            document.getElementById('lmc-zfw').value = '';
            document.getElementById('lmc-zfw-btn').textContent = '0';
            document.getElementById('lmc-mzfw').value = '';
            document.getElementById('lmc-mzfw-btn').textContent = '0';
            document.getElementById('lmc-tow').value = '';
            document.getElementById('lmc-tow-btn').textContent = '0';
            document.getElementById('lmc-rtow').value = '';
            document.getElementById('lmc-rtow-btn').textContent = '0';
            document.getElementById('lmc-lw').value = '';
            document.getElementById('lmc-lw-btn').textContent = '0';
            document.getElementById('lmc-rlw').value = '';
            document.getElementById('lmc-rlw-btn').textContent = '0';
            document.getElementById('lmc-underload').value = '';
            document.getElementById('lmc-underload-btn').textContent = '0';
            renderLmcChanges();
            lmcCalculate();
        }

        // ============ EVENT LISTENERS FOR NEW CALCULATORS ============
        ['xwind-rwy', 'xwind-dir', 'xwind-spd', 'xwind-gust'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('change', calculateCrosswind);
        });

        ['hold-inbound', 'hold-hdg'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('change', calculateHoldEntry);
        });

        ['isa-alt'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('change', calculateISA);
        });

        // Auto-sync airfield elevation when 4 chars entered
        try {
            var airfieldEl = document.getElementById('isa-airfield');
            if (airfieldEl) {
                airfieldEl.addEventListener('input', function(e) {
                    if (e.target.value.length === 4) syncAirfieldElev();
                });
            }
        } catch(e) { console.error('isa-airfield listener error:', e); }

        var tzInput = document.getElementById('tz-input');
        if (tzInput) tzInput.addEventListener('change', calculateTimezones);

        // Load notes scratchpad on startup
        loadNotesScratchpad();

        // Auto-save notes as user types
        var notesPad = document.getElementById('notes-scratchpad');
        if (notesPad) {
            notesPad.addEventListener('input', function(e) {
                localStorage.setItem('notesScratchpadCurrent', e.target.value);
            });
        }

        // ============ QIBLA DIRECTION ============
        // Mecca coordinates (Kaaba)
        var MECCA_LAT = 21.4225;
        var MECCA_LON = 39.8262;

        // Qibla state
        var qiblaSource = 'gps'; // 'gps' or 'manual' - default to GPS
        var qiblaGpsConnected = false;
        var qiblaCurrentLat = null;
        var qiblaCurrentLon = null;
        var qiblaCurrentHeading = null;
        var qiblaGpsInterval = null;
        var currentGpsSpeed = null; // Ground speed in knots for autofill

        function openQiblaModal() {
            document.getElementById('qibla-modal').classList.add('active');
            if (qiblaSource === 'gps') {
                startGpsPolling();
            }
        }

        function closeQiblaModal() {
            document.getElementById('qibla-modal').classList.remove('active');
        }

        function setQiblaSource(source) {
            qiblaSource = source;
            document.getElementById('qibla-gps-btn').classList.toggle('active', source === 'gps');
            document.getElementById('qibla-manual-btn').classList.toggle('active', source === 'manual');
            document.getElementById('qibla-gps-section').style.display = source === 'gps' ? 'block' : 'none';
            document.getElementById('qibla-manual-section').style.display = source === 'manual' ? 'block' : 'none';

            if (source === 'gps') {
                startGpsPolling();
            } else {
                stopGpsPolling();
            }
        }

        function startGpsPolling() {
            if (qiblaGpsInterval) return;

            fetchGpsData();
            qiblaGpsInterval = setInterval(fetchGpsData, 2000); // Poll every 2 seconds
        }

        function stopGpsPolling() {
            if (qiblaGpsInterval) {
                clearInterval(qiblaGpsInterval);
                qiblaGpsInterval = null;
            }
        }

        function fetchGpsData() {
            // Try to fetch from gpsd via a local endpoint
            // gpsd typically runs on port 2947, but we need a proxy for browser access
            // Try the Pi's gpsd-http endpoint if available
            fetch('/gps')
                .then(function(response) {
                    if (!response.ok) throw new Error('GPS not available');
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.class === 'TPV') {
                        qiblaGpsConnected = true;
                        qiblaCurrentLat = data.lat;
                        qiblaCurrentLon = data.lon;
                        qiblaCurrentHeading = data.track || 0;
                        var speed = data.speed ? Math.round(data.speed * 1.94384) : null; // m/s to knots
                        currentGpsSpeed = speed; // Store globally for autofill

                        updateGpsStatus(true, data.lat, data.lon, data.track, speed);
                        calculateAndDisplayQibla(data.lat, data.lon, data.track || 0);
                    } else if (data && data.lat !== undefined) {
                        // Alternative format
                        qiblaGpsConnected = true;
                        qiblaCurrentLat = data.lat;
                        qiblaCurrentLon = data.lon;
                        qiblaCurrentHeading = data.heading || data.track || 0;
                        var speed = data.speed ? Math.round(data.speed * 1.94384) : null;
                        currentGpsSpeed = speed; // Store globally for autofill

                        updateGpsStatus(true, data.lat, data.lon, qiblaCurrentHeading, speed);
                        calculateAndDisplayQibla(data.lat, data.lon, qiblaCurrentHeading);
                    } else {
                        throw new Error('Invalid GPS data');
                    }
                })
                .catch(function(err) {
                    qiblaGpsConnected = false;
                    currentGpsSpeed = null;
                    updateGpsStatus(false);
                });
        }

        function updateGpsStatus(connected, lat, lon, heading, speed) {
            var statusEl = document.getElementById('qibla-gps-status');
            var statusTextEl = document.getElementById('qibla-gps-status-text');
            var positionEl = document.getElementById('qibla-gps-position');

            // Update info strip GPS display
            var stripPosEl = document.getElementById('strip-gps-pos');
            var stripTrkEl = document.getElementById('strip-gps-trk');
            var stripGsEl = document.getElementById('strip-gps-gs');
            var stripGpsEl = document.getElementById('strip-gps');

            // Update coordinate converter GPS display
            var coordLatEl = document.getElementById('coord-gps-lat');
            var coordLonEl = document.getElementById('coord-gps-lon');
            var coordTrkEl = document.getElementById('coord-gps-trk');
            var coordSpdEl = document.getElementById('coord-gps-spd');
            var coordFillBtn = document.getElementById('coord-gps-fill-btn');
            var coordBoxEl = document.getElementById('coord-gps-box');

            if (connected) {
                statusEl.classList.remove('disconnected');
                statusEl.classList.add('connected');
                statusTextEl.textContent = 'GPS Connected';
                positionEl.innerHTML =
                    'LAT: ' + lat.toFixed(4) + 'Â°<br>' +
                    'LON: ' + lon.toFixed(4) + 'Â°<br>' +
                    'HDG: ' + (heading !== null && heading !== undefined ? Math.round(heading) + 'Â°' : 'N/A');

                // Update info strip
                if (stripGpsEl) stripGpsEl.style.display = 'flex';
                if (stripPosEl) {
                    var latDir = lat >= 0 ? 'N' : 'S';
                    var lonDir = lon >= 0 ? 'E' : 'W';
                    stripPosEl.textContent = latDir + Math.abs(lat).toFixed(2) + ' ' + lonDir + Math.abs(lon).toFixed(2);
                }
                if (stripTrkEl) stripTrkEl.textContent = (heading !== null && heading !== undefined ? Math.round(heading) : '---') + 'Â°';
                if (stripGsEl) stripGsEl.textContent = (speed !== null && speed !== undefined ? speed : '---') + 'kt';

                // Update coordinate converter GPS box
                coordGpsData.lat = lat;
                coordGpsData.lon = lon;
                coordGpsData.track = heading;
                coordGpsData.speed = speed;
                coordGpsData.available = true;
                if (coordLatEl) coordLatEl.textContent = lat.toFixed(4) + 'Â°';
                if (coordLonEl) coordLonEl.textContent = lon.toFixed(4) + 'Â°';
                if (coordTrkEl) coordTrkEl.textContent = (heading !== null && heading !== undefined ? Math.round(heading) + 'Â°' : '---');
                if (coordSpdEl) coordSpdEl.textContent = (speed !== null && speed !== undefined ? speed + ' kt' : '---');
                if (coordFillBtn) {
                    coordFillBtn.disabled = false;
                    coordFillBtn.textContent = 'Fill from GPS';
                }
                if (coordBoxEl) coordBoxEl.style.borderColor = 'rgba(0,212,255,0.5)';
            } else {
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
                statusTextEl.textContent = 'GPS Disconnected';
                positionEl.innerHTML = 'No GPS data available.<br>Switch to Manual mode.';

                // Update info strip to show no GPS
                if (stripPosEl) stripPosEl.textContent = '---';
                if (stripTrkEl) stripTrkEl.textContent = '---Â°';
                if (stripGsEl) stripGsEl.textContent = '---kt';

                // Update coordinate converter GPS box
                coordGpsData.available = false;
                if (coordLatEl) coordLatEl.textContent = '---';
                if (coordLonEl) coordLonEl.textContent = '---';
                if (coordTrkEl) coordTrkEl.textContent = '---';
                if (coordSpdEl) coordSpdEl.textContent = '---';
                if (coordFillBtn) {
                    coordFillBtn.disabled = true;
                    coordFillBtn.textContent = 'GPS Not Available';
                }
                if (coordBoxEl) coordBoxEl.style.borderColor = 'rgba(255,82,82,0.5)';
            }
        }

        function calculateQiblaBearing(lat, lon) {
            // Calculate bearing from current position to Mecca using spherical trigonometry
            var lat1 = lat * Math.PI / 180;
            var lat2 = MECCA_LAT * Math.PI / 180;
            var dLon = (MECCA_LON - lon) * Math.PI / 180;

            var y = Math.sin(dLon) * Math.cos(lat2);
            var x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            var bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360; // Normalize to 0-360

            return bearing;
        }

        function calculateQiblaFromManual() {
            var latStr = document.getElementById('qibla-lat').value.trim();
            var lonStr = document.getElementById('qibla-lon').value.trim();
            var headingStr = document.getElementById('qibla-heading').value.trim();

            var lat = parseFloat(latStr);
            var lon = parseFloat(lonStr);
            var heading = parseFloat(headingStr) || 0;

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid coordinates');
                return;
            }

            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Coordinates out of range.\nLatitude: -90 to 90\nLongitude: -180 to 180');
                return;
            }

            qiblaCurrentLat = lat;
            qiblaCurrentLon = lon;
            qiblaCurrentHeading = heading;

            calculateAndDisplayQibla(lat, lon, heading);
        }

        function calculateAndDisplayQibla(lat, lon, heading) {
            var qiblaBearing = calculateQiblaBearing(lat, lon);
            var relativeBearing = (qiblaBearing - heading + 360) % 360;

            // Display in modal
            document.getElementById('qibla-bearing-result').textContent = Math.round(qiblaBearing) + 'Â°';
            document.getElementById('qibla-relative-result').textContent = Math.round(relativeBearing) + 'Â°';

            // Direction text
            var dirText = '';
            if (relativeBearing > 337.5 || relativeBearing <= 22.5) {
                dirText = 'Ahead';
            } else if (relativeBearing > 22.5 && relativeBearing <= 67.5) {
                dirText = 'Ahead Right';
            } else if (relativeBearing > 67.5 && relativeBearing <= 112.5) {
                dirText = 'Right';
            } else if (relativeBearing > 112.5 && relativeBearing <= 157.5) {
                dirText = 'Behind Right';
            } else if (relativeBearing > 157.5 && relativeBearing <= 202.5) {
                dirText = 'Behind';
            } else if (relativeBearing > 202.5 && relativeBearing <= 247.5) {
                dirText = 'Behind Left';
            } else if (relativeBearing > 247.5 && relativeBearing <= 292.5) {
                dirText = 'Left';
            } else {
                dirText = 'Ahead Left';
            }
            document.getElementById('qibla-direction-text').textContent = dirText;

            // Update info strip
            updateQiblaStrip(relativeBearing, dirText);
        }

        function updateQiblaStrip(relativeBearing, dirText) {
            var stripEl = document.getElementById('strip-qibla');
            var arrowEl = document.getElementById('strip-qibla-arrow');
            var valueEl = document.getElementById('strip-qibla-value');

            stripEl.classList.remove('no-gps');
            valueEl.textContent = Math.round(relativeBearing) + 'Â°';

            // Rotate arrow to point in qibla direction
            arrowEl.style.transform = 'rotate(' + relativeBearing + 'deg)';
            arrowEl.style.display = 'inline-block';
        }

        function resetQiblaStrip() {
            var stripEl = document.getElementById('strip-qibla');
            var arrowEl = document.getElementById('strip-qibla-arrow');
            var valueEl = document.getElementById('strip-qibla-value');

            stripEl.classList.add('no-gps');
            valueEl.textContent = '---Â°';
            arrowEl.style.transform = 'rotate(0deg)';
        }

        // ============ GPS FOR COORDINATE CONVERTER ============
        // coordGpsData is now defined earlier (before startGpsPolling)
        var coordGpsInterval = null;

        function startCoordGpsPolling() {
            if (coordGpsInterval) return;
            fetchCoordGpsData();
            coordGpsInterval = setInterval(fetchCoordGpsData, 3000); // Poll every 3 seconds
        }

        function fetchCoordGpsData() {
            fetch('/gps')
                .then(function(response) {
                    if (!response.ok) throw new Error('GPS not available');
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.lat !== undefined && data.lon !== undefined) {
                        coordGpsData.lat = data.lat;
                        coordGpsData.lon = data.lon;
                        coordGpsData.track = data.track;
                        // Convert m/s to knots (1 m/s = 1.94384 knots)
                        coordGpsData.speed = data.speed !== undefined ? data.speed * 1.94384 : null;
                        coordGpsData.available = true;
                        updateCoordGpsDisplay();
                    } else {
                        throw new Error('Invalid GPS data');
                    }
                })
                .catch(function(err) {
                    coordGpsData.available = false;
                    updateCoordGpsDisplay();
                });
        }

        function updateCoordGpsDisplay() {
            var latEl = document.getElementById('coord-gps-lat');
            var lonEl = document.getElementById('coord-gps-lon');
            var trkEl = document.getElementById('coord-gps-trk');
            var spdEl = document.getElementById('coord-gps-spd');
            var fillBtn = document.getElementById('coord-gps-fill-btn');
            var boxEl = document.getElementById('coord-gps-box');

            if (coordGpsData.available) {
                latEl.textContent = coordGpsData.lat.toFixed(4) + 'Â°';
                lonEl.textContent = coordGpsData.lon.toFixed(4) + 'Â°';
                trkEl.textContent = coordGpsData.track !== null ? Math.round(coordGpsData.track) + 'Â°' : '---';
                spdEl.textContent = coordGpsData.speed !== null ? Math.round(coordGpsData.speed) + ' kt' : '---';
                fillBtn.disabled = false;
                fillBtn.textContent = 'Fill from GPS';
                boxEl.style.borderColor = 'rgba(0,212,255,0.5)';
            } else {
                latEl.textContent = '---';
                lonEl.textContent = '---';
                trkEl.textContent = '---';
                spdEl.textContent = '---';
                fillBtn.disabled = true;
                fillBtn.textContent = 'GPS Not Available';
                boxEl.style.borderColor = 'rgba(255,82,82,0.5)';
            }
        }

        function fillCoordsFromGps() {
            try {
                if (!coordGpsData.available) {
                    alert('GPS data not available');
                    return;
                }

                // Fill the manual input fields
                var latVal = Math.abs(coordGpsData.lat).toFixed(4);
                var lonVal = Math.abs(coordGpsData.lon).toFixed(4);

                var latInput = document.getElementById('coord-lat-input');
                var lonInput = document.getElementById('coord-lon-input');

                if (!latInput || !lonInput) {
                    alert('Could not find lat/lon input fields');
                    return;
                }

                latInput.value = latVal;
                lonInput.value = lonVal;

                // Set the N/S and E/W buttons
                var nsBtn = document.getElementById('coord-ns-btn');
                var ewBtn = document.getElementById('coord-ew-btn');

                if (coordGpsData.lat >= 0) {
                    nsBtn.textContent = 'N';
                    nsBtn.style.background = 'rgba(0,212,255,0.3)';
                    nsBtn.style.borderColor = '#00d4ff';
                } else {
                    nsBtn.textContent = 'S';
                    nsBtn.style.background = 'rgba(255,80,80,0.3)';
                    nsBtn.style.borderColor = '#ff5050';
                }

                if (coordGpsData.lon >= 0) {
                    ewBtn.textContent = 'E';
                    ewBtn.style.background = 'rgba(255,130,0,0.3)';
                    ewBtn.style.borderColor = '#FF8200';
                } else {
                    ewBtn.textContent = 'W';
                    ewBtn.style.background = 'rgba(80,180,255,0.3)';
                    ewBtn.style.borderColor = '#50b4ff';
                }

                // Clear the paste input and trigger conversion
                document.getElementById('coord-input').value = '';
                convertFromManual();
            } catch (e) {
                alert('fillCoordsFromGps error: ' + e.message);
            }
        }

        // GPS polling for coord converter is now handled by main updateGpsStatus()

        // ============================================
        // MAP TAB - Leaflet Moving Map
        // ============================================
        var flightMap = null;
        var mapMarker = null;
        var mapTrackLine = null;
        var mapRouteLine = null;
        var mapGeoJSONLayer = null;
        var mapAirspaceLayer = null;
        var mapNavaidsLayer = null;
        var airspaceVisible = true;
        var navaidsVisible = true;
        var mapFollowMode = true;
        var trackLogRecording = false;
        var trackLogPoints = [];
        var trackLogStartTime = null;
        var mapInitialized = false;

        // Airspace type colors
        var airspaceColors = {
            1: { color: '#ff0000', name: 'Prohibited' },      // P - Prohibited
            2: { color: '#ff4444', name: 'Restricted' },      // R - Restricted
            3: { color: '#ff8800', name: 'Danger' },          // D - Danger
            4: { color: '#0088ff', name: 'CTR' },             // CTR
            5: { color: '#00aaff', name: 'TMA' },             // TMA
            6: { color: '#8800ff', name: 'ATZ' },             // ATZ
            10: { color: '#444488', name: 'FIR' },            // FIR
            14: { color: '#ff00ff', name: 'Military' }        // Military
        };

        function loadAirspaceOverlay() {
            console.log('Loading airspace overlay...');
            fetch('/dashboard/world-airspace.geojson')
                .then(function(response) {
                    console.log('Airspace fetch response:', response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('Airspace data loaded, features:', data.features ? data.features.length : 0);
                    mapAirspaceLayer = L.geoJSON(data, {
                        style: function(feature) {
                            var type = feature.properties.type || 0;
                            var colorInfo = airspaceColors[type] || { color: '#888888', name: 'Unknown' };
                            return {
                                color: colorInfo.color,
                                weight: 1.5,
                                opacity: 0.7,
                                fillColor: colorInfo.color,
                                fillOpacity: 0.15
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            var props = feature.properties;
                            var type = props.type || 0;
                            var typeName = airspaceColors[type] ? airspaceColors[type].name : 'Airspace';
                            var upper = props.upperLimit ? formatAltLimit(props.upperLimit) : '---';
                            var lower = props.lowerLimit ? formatAltLimit(props.lowerLimit) : '---';
                            layer.bindPopup(
                                '<b>' + (props.name || 'Unknown') + '</b><br>' +
                                '<span style="color: ' + (airspaceColors[type] || {color:'#888'}).color + ';">' + typeName + '</span><br>' +
                                'Upper: ' + upper + '<br>' +
                                'Lower: ' + lower
                            );
                        }
                    }).addTo(flightMap);
                    console.log('Airspace layer added to map');
                })
                .catch(function(err) {
                    console.error('Could not load airspace overlay:', err);
                });
        }

        function formatAltLimit(limit) {
            if (!limit) return '---';
            var val = limit.value;
            var unit = limit.unit;
            var ref = limit.referenceDatum;
            // unit: 1=ft, 6=FL
            // ref: 1=MSL, 2=STD
            if (unit === 6) return 'FL' + val;
            if (ref === 2) return 'FL' + Math.round(val / 100);
            return val + ' ft';
        }

        // Navaid type mapping
        var navaidTypes = {
            2: { symbol: 'â—ˆ', color: '#00ff00', name: 'NDB' },
            4: { symbol: 'â¬¡', color: '#00c8ff', name: 'VOR' },
            5: { symbol: 'â¬¢', color: '#00ffff', name: 'VOR-DME' },
            6: { symbol: 'â—‡', color: '#ffaa00', name: 'VOR' },
            7: { symbol: 'â¬¢', color: '#00ffff', name: 'VORTAC' },
            8: { symbol: 'â—ˆ', color: '#ff00ff', name: 'TACAN' }
        };

        function loadNavaidsOverlay() {
            console.log('Loading navaids overlay...');
            fetch('/dashboard/world-navaids.geojson')
                .then(function(response) {
                    console.log('Navaids fetch response:', response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('Navaids data loaded, features:', data.features ? data.features.length : 0);
                    mapNavaidsLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            var props = feature.properties;
                            var type = props.type || 0;
                            var info = navaidTypes[type] || { symbol: 'â—', color: '#888888', name: 'Unknown' };

                            var icon = L.divIcon({
                                className: 'navaid-marker',
                                html: '<div style="font-size: 16px; color: ' + info.color + '; text-shadow: 0 0 6px ' + info.color + ';">' + info.symbol + '</div>' +
                                      '<div style="font-size: 9px; color: #fff; text-align: center; margin-top: -2px; text-shadow: 1px 1px 2px #000;">' + (props.identifier || '') + '</div>',
                                iconSize: [40, 30],
                                iconAnchor: [20, 15]
                            });
                            return L.marker(latlng, { icon: icon });
                        },
                        onEachFeature: function(feature, layer) {
                            var props = feature.properties;
                            var type = props.type || 0;
                            var info = navaidTypes[type] || { name: 'Navaid' };
                            var freq = props.frequency ? props.frequency.value + ' MHz' : '';
                            if (props.frequency && props.frequency.unit === 1) freq = props.frequency.value + ' kHz';

                            layer.bindPopup(
                                '<b>' + (props.name || 'Unknown') + '</b><br>' +
                                '<span style="color: ' + (navaidTypes[type] || {color:'#888'}).color + ';">' + info.name + '</span> ' + (props.identifier || '') + '<br>' +
                                (freq ? 'Freq: ' + freq + '<br>' : '') +
                                (props.channel ? 'Ch: ' + props.channel : '')
                            );
                        }
                    }).addTo(flightMap);
                })
                .catch(function(err) {
                    console.log('Could not load navaids overlay:', err);
                });
        }

        function toggleAirspaceLayer() {
            var btn = document.getElementById('toggle-airspace-btn');
            if (airspaceVisible) {
                if (mapAirspaceLayer) flightMap.removeLayer(mapAirspaceLayer);
                airspaceVisible = false;
                btn.innerHTML = 'Airspace';
                btn.style.background = 'rgba(68, 68, 136, 0.15)';
            } else {
                if (mapAirspaceLayer) mapAirspaceLayer.addTo(flightMap);
                airspaceVisible = true;
                btn.innerHTML = 'âœ“ Airspace';
                btn.style.background = 'rgba(68, 68, 136, 0.4)';
            }
        }

        function toggleNavaidsLayer() {
            var btn = document.getElementById('toggle-navaids-btn');
            if (navaidsVisible) {
                if (mapNavaidsLayer) flightMap.removeLayer(mapNavaidsLayer);
                navaidsVisible = false;
                btn.innerHTML = 'Navaids';
                btn.style.background = 'rgba(0, 200, 255, 0.1)';
            } else {
                if (mapNavaidsLayer) mapNavaidsLayer.addTo(flightMap);
                navaidsVisible = true;
                btn.innerHTML = 'âœ“ Navaids';
                btn.style.background = 'rgba(0, 200, 255, 0.3)';
            }
        }

        // Aircraft icon for marker
        var aircraftIcon = L.divIcon({
            className: 'aircraft-marker',
            html: '<div style="transform: rotate(0deg); font-size: 24px; color: #FF8200; text-shadow: 0 0 10px rgba(255,130,0,0.8);">âœˆ</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        function initMap() {
            if (mapInitialized) return;

            // Default to DXB if no GPS
            var defaultLat = 25.2532;
            var defaultLon = 55.3657;

            flightMap = L.map('map-container', {
                zoomControl: true,
                attributionControl: true
            }).setView([defaultLat, defaultLon], 8);

            // Offline map tiles from tar1090
            L.tileLayer('/tar1090/osm_tiles_offline/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 10,
                errorTileUrl: ''
            }).addTo(flightMap);

            // Load UAE airspace overlay
            loadAirspaceOverlay();

            // Load UAE navaids overlay
            loadNavaidsOverlay();

            // Add aircraft marker
            mapMarker = L.marker([defaultLat, defaultLon], { icon: aircraftIcon }).addTo(flightMap);
            mapMarker.bindPopup('Current Position');

            // Track line (for recording)
            mapTrackLine = L.polyline([], {
                color: '#00ff88',
                weight: 3,
                opacity: 0.8
            }).addTo(flightMap);

            mapInitialized = true;

            // Force map to recalculate size
            setTimeout(function() {
                flightMap.invalidateSize();
            }, 100);
        }

        function updateMapPosition(lat, lon, heading, speed, alt) {
            if (!flightMap || !mapMarker) return;

            var latLng = L.latLng(lat, lon);
            mapMarker.setLatLng(latLng);

            // Rotate aircraft icon based on heading
            if (heading !== null && heading !== undefined) {
                var iconHtml = '<div style="transform: rotate(' + heading + 'deg); font-size: 24px; color: #FF8200; text-shadow: 0 0 10px rgba(255,130,0,0.8);">âœˆ</div>';
                mapMarker.setIcon(L.divIcon({
                    className: 'aircraft-marker',
                    html: iconHtml,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                }));
            }

            // Follow mode - pan map to keep aircraft centered
            if (mapFollowMode) {
                flightMap.panTo(latLng);
            }

            // Update info display
            var latDir = lat >= 0 ? 'N' : 'S';
            var lonDir = lon >= 0 ? 'E' : 'W';
            var posStr = Math.abs(lat).toFixed(4) + 'Â°' + latDir + ' ' + Math.abs(lon).toFixed(4) + 'Â°' + lonDir;
            document.getElementById('map-position').textContent = posStr;
            document.getElementById('map-track').textContent = heading !== null ? Math.round(heading) + 'Â°' : '---Â°';
            document.getElementById('map-gs').textContent = speed !== null ? Math.round(speed) + ' kt' : '--- kt';
            document.getElementById('map-alt').textContent = alt !== null ? Math.round(alt) + ' ft' : '--- ft';

            // Add to track log if recording
            if (trackLogRecording) {
                trackLogPoints.push({
                    lat: lat,
                    lon: lon,
                    alt: alt || 0,
                    time: new Date().toISOString()
                });
                mapTrackLine.addLatLng(latLng);
                updateTrackLogStats();
            }
        }

        function centerMapOnPosition() {
            if (flightMap && mapMarker) {
                flightMap.setView(mapMarker.getLatLng(), flightMap.getZoom());
            }
        }

        function toggleMapFollow() {
            mapFollowMode = !mapFollowMode;
            var btn = document.getElementById('map-follow-btn');
            if (mapFollowMode) {
                btn.textContent = 'Follow';
                btn.style.background = 'rgba(0, 255, 136, 0.3)';
                btn.style.borderColor = '#00ff88';
            } else {
                btn.textContent = 'Free';
                btn.style.background = 'rgba(255, 130, 0, 0.2)';
                btn.style.borderColor = 'rgba(255, 130, 0, 0.5)';
            }
        }

        // Great circle route calculation
        function drawRoute() {
            var fromCode = document.getElementById('route-from').value.toUpperCase().trim();
            var toCode = document.getElementById('route-to').value.toUpperCase().trim();

            if (!fromCode || !toCode) {
                alert('Enter both departure and arrival airport codes');
                return;
            }

            // Use global airport database
            if (!airportDB) {
                alert('Airport database not loaded yet. Please wait and try again.');
                return;
            }

            // Try ICAO first, then IATA
            var fromApt = getAirport(fromCode) || getAirportByIATA(fromCode);
            var toApt = getAirport(toCode) || getAirportByIATA(toCode);
            var fromICAO = fromApt ? (fromApt.icao || fromCode) : fromCode;
            var toICAO = toApt ? (toApt.icao || toCode) : toCode;

            if (!fromApt) {
                alert('Unknown airport: ' + fromCode + '\nNot found in database (8,800+ airports)');
                return;
            }
            if (!toApt) {
                alert('Unknown airport: ' + toCode + '\nNot found in database (8,800+ airports)');
                return;
            }

            var from = fromApt.c;  // [lat, lon]
            var to = toApt.c;

            // Generate great circle points
            var points = generateGreatCircle(from[0], from[1], to[0], to[1], 100);

            // Remove old route if exists
            if (mapRouteLine) {
                flightMap.removeLayer(mapRouteLine);
            }

            // Draw new route
            mapRouteLine = L.polyline(points, {
                color: '#00d4ff',
                weight: 2,
                opacity: 0.8,
                dashArray: '10, 5'
            }).addTo(flightMap);

            // Add departure and arrival markers with airport info
            var fromLabel = fromICAO + (fromApt.i ? '/' + fromApt.i : '') + '<br>' + (fromApt.m || fromApt.n);
            var toLabel = toICAO + (toApt.i ? '/' + toApt.i : '') + '<br>' + (toApt.m || toApt.n);

            L.circleMarker(from, { radius: 8, color: '#00ff88', fillColor: '#00ff88', fillOpacity: 0.8 })
                .bindPopup('<b>' + fromLabel + '</b>')
                .addTo(flightMap);
            L.circleMarker(to, { radius: 8, color: '#ff5252', fillColor: '#ff5252', fillOpacity: 0.8 })
                .bindPopup('<b>' + toLabel + '</b>')
                .addTo(flightMap);

            // Fit map to route
            flightMap.fitBounds(mapRouteLine.getBounds(), { padding: [50, 50] });
        }

        function generateGreatCircle(lat1, lon1, lat2, lon2, numPoints) {
            var points = [];
            var toRad = Math.PI / 180;
            var toDeg = 180 / Math.PI;

            lat1 = lat1 * toRad;
            lon1 = lon1 * toRad;
            lat2 = lat2 * toRad;
            lon2 = lon2 * toRad;

            var d = 2 * Math.asin(Math.sqrt(
                Math.pow(Math.sin((lat1 - lat2) / 2), 2) +
                Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin((lon1 - lon2) / 2), 2)
            ));

            for (var i = 0; i <= numPoints; i++) {
                var f = i / numPoints;
                var A = Math.sin((1 - f) * d) / Math.sin(d);
                var B = Math.sin(f * d) / Math.sin(d);
                var x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2);
                var y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2);
                var z = A * Math.sin(lat1) + B * Math.sin(lat2);
                var lat = Math.atan2(z, Math.sqrt(x * x + y * y)) * toDeg;
                var lon = Math.atan2(y, x) * toDeg;
                points.push([lat, lon]);
            }
            return points;
        }

        function loadGeoJSON() {
            var input = document.getElementById('geojson-input').value.trim();
            if (!input) {
                alert('Paste GeoJSON data first');
                return;
            }

            try {
                var geojson = JSON.parse(input);

                // Remove old layer if exists
                if (mapGeoJSONLayer) {
                    flightMap.removeLayer(mapGeoJSONLayer);
                }

                mapGeoJSONLayer = L.geoJSON(geojson, {
                    style: function(feature) {
                        return {
                            color: '#ffd700',
                            weight: 3,
                            opacity: 0.8
                        };
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: '#ffd700',
                            color: '#ffd700',
                            fillOpacity: 0.8
                        });
                    }
                }).addTo(flightMap);

                // Fit to GeoJSON bounds
                flightMap.fitBounds(mapGeoJSONLayer.getBounds(), { padding: [50, 50] });

            } catch (e) {
                alert('Invalid GeoJSON: ' + e.message);
            }
        }

        // Track log functions
        function toggleTrackLog() {
            trackLogRecording = !trackLogRecording;
            var btn = document.getElementById('track-toggle-btn');

            if (trackLogRecording) {
                btn.textContent = 'Stop Recording';
                btn.style.background = 'rgba(255, 82, 82, 0.3)';
                btn.style.borderColor = '#ff5252';
                trackLogStartTime = new Date();
            } else {
                btn.textContent = 'Start Recording';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }

        function clearTrackLog() {
            trackLogPoints = [];
            trackLogStartTime = null;
            if (mapTrackLine) {
                mapTrackLine.setLatLngs([]);
            }
            updateTrackLogStats();
        }

        function updateTrackLogStats() {
            document.getElementById('track-points').textContent = trackLogPoints.length;

            // Calculate distance
            var totalDist = 0;
            for (var i = 1; i < trackLogPoints.length; i++) {
                totalDist += calculateDistance(
                    trackLogPoints[i-1].lat, trackLogPoints[i-1].lon,
                    trackLogPoints[i].lat, trackLogPoints[i].lon
                );
            }
            document.getElementById('track-distance').textContent = totalDist.toFixed(1) + ' nm';

            // Duration
            if (trackLogStartTime) {
                var dur = Math.floor((new Date() - trackLogStartTime) / 1000);
                var hrs = Math.floor(dur / 3600);
                var mins = Math.floor((dur % 3600) / 60);
                document.getElementById('track-duration').textContent =
                    (hrs > 0 ? hrs + ':' : '') + String(mins).padStart(2, '0') + ':' + String(dur % 60).padStart(2, '0');
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula - returns nautical miles
            var R = 3440.065; // Earth radius in nm
            var toRad = Math.PI / 180;
            var dLat = (lat2 - lat1) * toRad;
            var dLon = (lon2 - lon1) * toRad;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function exportTrackLog() {
            if (trackLogPoints.length === 0) {
                alert('No track points recorded');
                return;
            }

            // Generate GPX
            var gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
            gpx += '<gpx version="1.1" creator="Flight Ops Dashboard">\n';
            gpx += '  <trk>\n';
            gpx += '    <name>Flight Track ' + new Date().toISOString().split('T')[0] + '</name>\n';
            gpx += '    <trkseg>\n';

            for (var i = 0; i < trackLogPoints.length; i++) {
                var pt = trackLogPoints[i];
                gpx += '      <trkpt lat="' + pt.lat + '" lon="' + pt.lon + '">\n';
                gpx += '        <ele>' + (pt.alt * 0.3048) + '</ele>\n'; // Convert ft to meters
                gpx += '        <time>' + pt.time + '</time>\n';
                gpx += '      </trkpt>\n';
            }

            gpx += '    </trkseg>\n';
            gpx += '  </trk>\n';
            gpx += '</gpx>';

            // Download
            var blob = new Blob([gpx], { type: 'application/gpx+xml' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'flight-track-' + new Date().toISOString().split('T')[0] + '.gpx';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Hook into existing GPS polling to update map
        var originalUpdateGpsStrip = typeof updateGpsStrip === 'function' ? updateGpsStrip : null;

        function mapGpsHook() {
            // Check if we have GPS data available from coordGpsData
            if (typeof coordGpsData !== 'undefined' && coordGpsData && coordGpsData.available && coordGpsData.lat !== null) {
                updateMapPosition(
                    coordGpsData.lat,
                    coordGpsData.lon,
                    coordGpsData.track || null,
                    coordGpsData.speed || null,
                    null // altitude not available in coordGpsData
                );
            }
        }

        // Initialize map when tab is shown, autofill NAV fields
        var originalSwitchTab = switchTab;
        switchTab = function(tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'map') {
                initMap();
                // Force resize after tab animation
                setTimeout(function() {
                    if (flightMap) flightMap.invalidateSize();
                }, 300);
            }
            if (tabId === 'nav') {
                // Autofill glide path airport from schedule arrival (last sector)
                var gpAirport = document.getElementById('gp-airport');
                if (gpAirport && !gpAirport.value) {
                    // Find the last visible sector's arrival airport
                    for (var i = 4; i >= 1; i--) {
                        var arrEl = document.getElementById('s' + i + '-arr');
                        if (arrEl && arrEl.value) {
                            gpAirport.value = arrEl.value;
                            autofillGpElevation();
                            break;
                        }
                    }
                }
            }
        };

        // Poll GPS for map updates (every 2 seconds)
        setInterval(function() {
            if (mapInitialized && typeof coordGpsData !== 'undefined' && coordGpsData && coordGpsData.available && coordGpsData.lat !== null) {
                updateMapPosition(
                    coordGpsData.lat,
                    coordGpsData.lon,
                    coordGpsData.track || null,
                    coordGpsData.speed || null,
                    null
                );
            }
        }, 2000);

    </script>
</body>
</html>
